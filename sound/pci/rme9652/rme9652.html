<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › rme9652 › rme9652.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rme9652.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for RME Digi9652 audio interfaces </span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 1999 IEM - Winfried Ritsch</span>
<span class="cm"> *      Copyright (c) 1999-2001  Paul Davis</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;asm/current.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">precise_ptr</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>			<span class="cm">/* Enable precise pointer */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for RME Digi9652 (Hammerfall) soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for RME Digi9652 (Hammerfall) soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable/disable specific RME96{52,36} soundcards.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">precise_ptr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">precise_ptr</span><span class="p">,</span> <span class="s">&quot;Enable precise pointer (doesn&#39;t work reliably).&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul Davis &lt;pbd@op.net&gt;, Winfried Ritsch&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RME Digi9652/Digi9636&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{RME,Hammerfall},&quot;</span>
		<span class="s">&quot;{RME,Hammerfall-Light}}&quot;</span><span class="p">);</span>

<span class="cm">/* The Hammerfall has two sets of 24 ADAT + 2 S/PDIF channels, one for</span>
<span class="cm">   capture, one for playback. Both the ADAT and S/PDIF channels appear</span>
<span class="cm">   to the host CPU in the same block of memory. There is no functional</span>
<span class="cm">   difference between them in terms of access.</span>
<span class="cm">   </span>
<span class="cm">   The Hammerfall Light is identical to the Hammerfall, except that it</span>
<span class="cm">   has 2 sets 18 channels (16 ADAT + 2 S/PDIF) for capture and playback.</span>
<span class="cm">*/</span>

<span class="cp">#define RME9652_NCHANNELS       26</span>
<span class="cp">#define RME9636_NCHANNELS       18</span>

<span class="cm">/* Preferred sync source choices - used by &quot;sync_pref&quot; control switch */</span>

<span class="cp">#define RME9652_SYNC_FROM_SPDIF 0</span>
<span class="cp">#define RME9652_SYNC_FROM_ADAT1 1</span>
<span class="cp">#define RME9652_SYNC_FROM_ADAT2 2</span>
<span class="cp">#define RME9652_SYNC_FROM_ADAT3 3</span>

<span class="cm">/* Possible sources of S/PDIF input */</span>

<span class="cp">#define RME9652_SPDIFIN_OPTICAL 0	</span><span class="cm">/* optical (ADAT1) */</span><span class="cp"></span>
<span class="cp">#define RME9652_SPDIFIN_COAXIAL 1	</span><span class="cm">/* coaxial (RCA) */</span><span class="cp"></span>
<span class="cp">#define RME9652_SPDIFIN_INTERN  2	</span><span class="cm">/* internal (CDROM) */</span><span class="cp"></span>

<span class="cm">/* ------------- Status-Register bits --------------------- */</span>

<span class="cp">#define RME9652_IRQ	   (1&lt;&lt;0)	</span><span class="cm">/* IRQ is High if not reset by irq_clear */</span><span class="cp"></span>
<span class="cp">#define RME9652_lock_2	   (1&lt;&lt;1)	</span><span class="cm">/* ADAT 3-PLL: 1=locked, 0=unlocked */</span><span class="cp"></span>
<span class="cp">#define RME9652_lock_1	   (1&lt;&lt;2)	</span><span class="cm">/* ADAT 2-PLL: 1=locked, 0=unlocked */</span><span class="cp"></span>
<span class="cp">#define RME9652_lock_0	   (1&lt;&lt;3)	</span><span class="cm">/* ADAT 1-PLL: 1=locked, 0=unlocked */</span><span class="cp"></span>
<span class="cp">#define RME9652_fs48	   (1&lt;&lt;4)	</span><span class="cm">/* sample rate is 0=44.1/88.2,1=48/96 Khz */</span><span class="cp"></span>
<span class="cp">#define RME9652_wsel_rd	   (1&lt;&lt;5)	</span><span class="cm">/* if Word-Clock is used and valid then 1 */</span><span class="cp"></span>
                                        <span class="cm">/* bits 6-15 encode h/w buffer pointer position */</span>
<span class="cp">#define RME9652_sync_2	   (1&lt;&lt;16)	</span><span class="cm">/* if ADAT-IN 3 in sync to system clock */</span><span class="cp"></span>
<span class="cp">#define RME9652_sync_1	   (1&lt;&lt;17)	</span><span class="cm">/* if ADAT-IN 2 in sync to system clock */</span><span class="cp"></span>
<span class="cp">#define RME9652_sync_0	   (1&lt;&lt;18)	</span><span class="cm">/* if ADAT-IN 1 in sync to system clock */</span><span class="cp"></span>
<span class="cp">#define RME9652_DS_rd	   (1&lt;&lt;19)	</span><span class="cm">/* 1=Double Speed Mode, 0=Normal Speed */</span><span class="cp"></span>
<span class="cp">#define RME9652_tc_busy	   (1&lt;&lt;20)	</span><span class="cm">/* 1=time-code copy in progress (960ms) */</span><span class="cp"></span>
<span class="cp">#define RME9652_tc_out	   (1&lt;&lt;21)	</span><span class="cm">/* time-code out bit */</span><span class="cp"></span>
<span class="cp">#define RME9652_F_0	   (1&lt;&lt;22)	</span><span class="cm">/* 000=64kHz, 100=88.2kHz, 011=96kHz  */</span><span class="cp"></span>
<span class="cp">#define RME9652_F_1	   (1&lt;&lt;23)	</span><span class="cm">/* 111=32kHz, 110=44.1kHz, 101=48kHz, */</span><span class="cp"></span>
<span class="cp">#define RME9652_F_2	   (1&lt;&lt;24)	</span><span class="cm">/* external Crystal Chip if ERF=1 */</span><span class="cp"></span>
<span class="cp">#define RME9652_ERF	   (1&lt;&lt;25)	</span><span class="cm">/* Error-Flag of SDPIF Receiver (1=No Lock) */</span><span class="cp"></span>
<span class="cp">#define RME9652_buffer_id  (1&lt;&lt;26)	</span><span class="cm">/* toggles by each interrupt on rec/play */</span><span class="cp"></span>
<span class="cp">#define RME9652_tc_valid   (1&lt;&lt;27)	</span><span class="cm">/* 1 = a signal is detected on time-code input */</span><span class="cp"></span>
<span class="cp">#define RME9652_SPDIF_READ (1&lt;&lt;28)      </span><span class="cm">/* byte available from Rev 1.5+ S/PDIF interface */</span><span class="cp"></span>

<span class="cp">#define RME9652_sync	  (RME9652_sync_0|RME9652_sync_1|RME9652_sync_2)</span>
<span class="cp">#define RME9652_lock	  (RME9652_lock_0|RME9652_lock_1|RME9652_lock_2)</span>
<span class="cp">#define RME9652_F	  (RME9652_F_0|RME9652_F_1|RME9652_F_2)</span>
<span class="cp">#define rme9652_decode_spdif_rate(x) ((x)&gt;&gt;22)</span>

<span class="cm">/* Bit 6..15 : h/w buffer pointer */</span>

<span class="cp">#define RME9652_buf_pos	  0x000FFC0</span>

<span class="cm">/* Bits 31,30,29 are bits 5,4,3 of h/w pointer position on later</span>
<span class="cm">   Rev G EEPROMS and Rev 1.5 cards or later.</span>
<span class="cm">*/</span> 

<span class="cp">#define RME9652_REV15_buf_pos(x) ((((x)&amp;0xE0000000)&gt;&gt;26)|((x)&amp;RME9652_buf_pos))</span>

<span class="cm">/* amount of io space we remap for register access. i&#39;m not sure we</span>
<span class="cm">   even need this much, but 1K is nice round number :)</span>
<span class="cm">*/</span>

<span class="cp">#define RME9652_IO_EXTENT     1024</span>

<span class="cp">#define RME9652_init_buffer       0</span>
<span class="cp">#define RME9652_play_buffer       32	</span><span class="cm">/* holds ptr to 26x64kBit host RAM */</span><span class="cp"></span>
<span class="cp">#define RME9652_rec_buffer        36	</span><span class="cm">/* holds ptr to 26x64kBit host RAM */</span><span class="cp"></span>
<span class="cp">#define RME9652_control_register  64</span>
<span class="cp">#define RME9652_irq_clear         96</span>
<span class="cp">#define RME9652_time_code         100	</span><span class="cm">/* useful if used with alesis adat */</span><span class="cp"></span>
<span class="cp">#define RME9652_thru_base         128	</span><span class="cm">/* 132...228 Thru for 26 channels */</span><span class="cp"></span>

<span class="cm">/* Read-only registers */</span>

<span class="cm">/* Writing to any of the register locations writes to the status</span>
<span class="cm">   register. We&#39;ll use the first location as our point of access.</span>
<span class="cm">*/</span>

<span class="cp">#define RME9652_status_register    0</span>

<span class="cm">/* --------- Control-Register Bits ---------------- */</span>


<span class="cp">#define RME9652_start_bit	   (1&lt;&lt;0)	</span><span class="cm">/* start record/play */</span><span class="cp"></span>
                                                <span class="cm">/* bits 1-3 encode buffersize/latency */</span>
<span class="cp">#define RME9652_Master		   (1&lt;&lt;4)	</span><span class="cm">/* Clock Mode Master=1,Slave/Auto=0 */</span><span class="cp"></span>
<span class="cp">#define RME9652_IE		   (1&lt;&lt;5)	</span><span class="cm">/* Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define RME9652_freq		   (1&lt;&lt;6)       </span><span class="cm">/* samplerate 0=44.1/88.2, 1=48/96 kHz */</span><span class="cp"></span>
<span class="cp">#define RME9652_freq1		   (1&lt;&lt;7)       </span><span class="cm">/* if 0, 32kHz, else always 1 */</span><span class="cp"></span>
<span class="cp">#define RME9652_DS                 (1&lt;&lt;8)	</span><span class="cm">/* Doule Speed 0=44.1/48, 1=88.2/96 Khz */</span><span class="cp"></span>
<span class="cp">#define RME9652_PRO		   (1&lt;&lt;9)	</span><span class="cm">/* S/PDIF out: 0=consumer, 1=professional */</span><span class="cp"></span>
<span class="cp">#define RME9652_EMP		   (1&lt;&lt;10)	</span><span class="cm">/*  Emphasis 0=None, 1=ON */</span><span class="cp"></span>
<span class="cp">#define RME9652_Dolby		   (1&lt;&lt;11)	</span><span class="cm">/*  Non-audio bit 1=set, 0=unset */</span><span class="cp"></span>
<span class="cp">#define RME9652_opt_out	           (1&lt;&lt;12)	</span><span class="cm">/* Use 1st optical OUT as SPDIF: 1=yes,0=no */</span><span class="cp"></span>
<span class="cp">#define RME9652_wsel		   (1&lt;&lt;13)	</span><span class="cm">/* use Wordclock as sync (overwrites master) */</span><span class="cp"></span>
<span class="cp">#define RME9652_inp_0		   (1&lt;&lt;14)	</span><span class="cm">/* SPDIF-IN: 00=optical (ADAT1),     */</span><span class="cp"></span>
<span class="cp">#define RME9652_inp_1		   (1&lt;&lt;15)	</span><span class="cm">/* 01=koaxial (Cinch), 10=Internal CDROM */</span><span class="cp"></span>
<span class="cp">#define RME9652_SyncPref_ADAT2	   (1&lt;&lt;16)</span>
<span class="cp">#define RME9652_SyncPref_ADAT3	   (1&lt;&lt;17)</span>
<span class="cp">#define RME9652_SPDIF_RESET        (1&lt;&lt;18)      </span><span class="cm">/* Rev 1.5+: h/w S/PDIF receiver */</span><span class="cp"></span>
<span class="cp">#define RME9652_SPDIF_SELECT       (1&lt;&lt;19)</span>
<span class="cp">#define RME9652_SPDIF_CLOCK        (1&lt;&lt;20)</span>
<span class="cp">#define RME9652_SPDIF_WRITE        (1&lt;&lt;21)</span>
<span class="cp">#define RME9652_ADAT1_INTERNAL     (1&lt;&lt;22)      </span><span class="cm">/* Rev 1.5+: if set, internal CD connector carries ADAT */</span><span class="cp"></span>

<span class="cm">/* buffersize = 512Bytes * 2^n, where n is made from Bit2 ... Bit0 */</span>

<span class="cp">#define RME9652_latency            0x0e</span>
<span class="cp">#define rme9652_encode_latency(x)  (((x)&amp;0x7)&lt;&lt;1)</span>
<span class="cp">#define rme9652_decode_latency(x)  (((x)&gt;&gt;1)&amp;0x7)</span>
<span class="cp">#define rme9652_running_double_speed(s) ((s)-&gt;control_register &amp; RME9652_DS)</span>
<span class="cp">#define RME9652_inp                (RME9652_inp_0|RME9652_inp_1)</span>
<span class="cp">#define rme9652_encode_spdif_in(x) (((x)&amp;0x3)&lt;&lt;14)</span>
<span class="cp">#define rme9652_decode_spdif_in(x) (((x)&gt;&gt;14)&amp;0x3)</span>

<span class="cp">#define RME9652_SyncPref_Mask      (RME9652_SyncPref_ADAT2|RME9652_SyncPref_ADAT3)</span>
<span class="cp">#define RME9652_SyncPref_ADAT1	   0</span>
<span class="cp">#define RME9652_SyncPref_SPDIF	   (RME9652_SyncPref_ADAT2|RME9652_SyncPref_ADAT3)</span>

<span class="cm">/* the size of a substream (1 mono data stream) */</span>

<span class="cp">#define RME9652_CHANNEL_BUFFER_SAMPLES  (16*1024)</span>
<span class="cp">#define RME9652_CHANNEL_BUFFER_BYTES    (4*RME9652_CHANNEL_BUFFER_SAMPLES)</span>

<span class="cm">/* the size of the area we need to allocate for DMA transfers. the</span>
<span class="cm">   size is the same regardless of the number of channels - the </span>
<span class="cm">   9636 still uses the same memory area.</span>

<span class="cm">   Note that we allocate 1 more channel than is apparently needed</span>
<span class="cm">   because the h/w seems to write 1 byte beyond the end of the last</span>
<span class="cm">   page. Sigh.</span>
<span class="cm">*/</span>

<span class="cp">#define RME9652_DMA_AREA_BYTES ((RME9652_NCHANNELS+1) * RME9652_CHANNEL_BUFFER_BYTES)</span>
<span class="cp">#define RME9652_DMA_AREA_KILOBYTES (RME9652_DMA_AREA_BYTES/1024)</span>

<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">precise_ptr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">control_register</span><span class="p">;</span>	<span class="cm">/* cached value */</span>
	<span class="n">u32</span> <span class="n">thru_bits</span><span class="p">;</span>		<span class="cm">/* thru 1=on, 0=off channel 1=Bit1... channel 26= Bit26 */</span>

	<span class="n">u32</span> <span class="n">creg_spdif</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">creg_spdif_stream</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span><span class="p">;</span>		<span class="cm">/* hammerfall or hammerfall light names */</span>

        <span class="kt">size_t</span> <span class="n">hw_offsetmask</span><span class="p">;</span>     	<span class="cm">/* &amp;-with status register to get real hw_offset */</span>
	<span class="kt">size_t</span> <span class="n">prev_hw_offset</span><span class="p">;</span>		<span class="cm">/* previous hw offset */</span>
	<span class="kt">size_t</span> <span class="n">max_jitter</span><span class="p">;</span>		<span class="cm">/* maximum jitter in frames for </span>
<span class="cm">					   hw pointer */</span>
	<span class="kt">size_t</span> <span class="n">period_bytes</span><span class="p">;</span>		<span class="cm">/* guess what this is */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ds_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ss_channels</span><span class="p">;</span>	<span class="cm">/* different for hammerfall/hammerfall-light */</span>

	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">playback_dma_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">capture_dma_buf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">capture_buffer</span><span class="p">;</span>	<span class="cm">/* suitably aligned address */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">playback_buffer</span><span class="p">;</span>	<span class="cm">/* suitably aligned address */</span>

	<span class="n">pid_t</span> <span class="n">capture_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">playback_pid</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">passthru</span><span class="p">;</span>                   <span class="cm">/* non-zero if doing pass-thru */</span>
        <span class="kt">int</span> <span class="n">hw_rev</span><span class="p">;</span>                     <span class="cm">/* h/w rev * 10 (i.e. 1.5 has hw_rev = 15) */</span>

	<span class="kt">int</span> <span class="n">last_spdif_sample_rate</span><span class="p">;</span>	<span class="cm">/* so that we can catch externally ... */</span>
	<span class="kt">int</span> <span class="n">last_adat_sample_rate</span><span class="p">;</span>	<span class="cm">/* ... induced rate changes            */</span>

        <span class="kt">char</span> <span class="o">*</span><span class="n">channel_map</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">spdif_ctl</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/* These tables map the ALSA channels 1..N to the channels that we</span>
<span class="cm">   need to use in order to find the relevant channel buffer. RME</span>
<span class="cm">   refer to this kind of mapping as between &quot;the ADAT channel and</span>
<span class="cm">   the DMA channel.&quot; We index it using the logical audio channel,</span>
<span class="cm">   and the value is the DMA channel (i.e. channel buffer number)</span>
<span class="cm">   where the data for that channel can be read/written from/to.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_9652_ss</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
	<span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_9636_ss</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> 
	<span class="cm">/* channels 16 and 17 are S/PDIF */</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
	<span class="cm">/* channels 18-25 don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_9652_ds</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT channels are remapped */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
	<span class="cm">/* channels 12 and 13 are S/PDIF */</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_9636_ds</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT channels are remapped */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="cm">/* channels 8 and 9 are S/PDIF */</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">dmab</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">;</span>
	<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_get_reserved_buf</span><span class="p">(</span><span class="n">dmab</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">pci</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmab</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">dmab</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">dmab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmab</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* make it anonymous */</span>
		<span class="n">snd_dma_reserve_buf</span><span class="p">(</span><span class="n">dmab</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_rme9652_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>	   <span class="o">=</span> <span class="mh">0x10ee</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>	   <span class="o">=</span> <span class="mh">0x3fc4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>	<span class="cm">/* RME Digi9652 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_rme9652_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rme9652_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rme9652_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">!=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rme9652_adat_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652_running_double_speed</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">RME9652_fs48</span><span class="p">)</span> <span class="o">?</span> <span class="mi">96000</span> <span class="o">:</span> <span class="mi">88200</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">RME9652_fs48</span><span class="p">)</span> <span class="o">?</span> <span class="mi">48000</span> <span class="o">:</span> <span class="mi">44100</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rme9652_compute_period_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_latency</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">rme9652_decode_latency</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_offsetmask</span> <span class="o">=</span> 
		<span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_buf_pos</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">rme9652_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">period_size</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">precise_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_buffer_id</span><span class="p">)</span> <span class="o">?</span> <span class="n">period_size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_buf_pos</span><span class="p">;</span>

	<span class="cm">/* The hardware may give a backward movement for up to 80 frames</span>
<span class="cm">           Martin Kirst &lt;martin.kirst@freenet.de&gt; knows the details.</span>
<span class="cm">	*/</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">prev_hw_offset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">snd_pcm_sframes_t</span><span class="p">)</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">prev_hw_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">prev_hw_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_offsetmask</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_buffer_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frag</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unexpected hw_pointer position (bufid == 0): status: %x offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">period_size</span> <span class="o">+</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unexpected hw_pointer position (bufid == 1): status: %x offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">period_size</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">max_jitter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rme9652_reset_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* reset the FIFO pointer to zero. We do this by writing to 8</span>
<span class="cm">	   registers, each of which is a 32bit wide register, and set</span>
<span class="cm">	   them all to zero. Note that s-&gt;iobase is a pointer to</span>
<span class="cm">	   int32, not pointer to char.  </span>
<span class="cm">	*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">prev_hw_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rme9652_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RME9652_IE</span> <span class="o">|</span> <span class="n">RME9652_start_bit</span><span class="p">);</span>
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rme9652_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RME9652_start_bit</span> <span class="o">|</span> <span class="n">RME9652_IE</span><span class="p">);</span>
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_interrupt_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RME9652_latency</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rme9652_encode_latency</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="n">rme9652_compute_period_size</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Changing from a &quot;single speed&quot; to a &quot;double speed&quot; rate is</span>
<span class="cm">	   not allowed if any substreams are open. This is because</span>
<span class="cm">	   such a change causes a shift in the location of </span>
<span class="cm">	   the DMA buffers and a reduction in the number of available</span>
<span class="cm">	   buffers. </span>

<span class="cm">	   Note that a similar but essentially insoluble problem</span>
<span class="cm">	   exists for externally-driven rate changes. All we can do</span>
<span class="cm">	   is to flag rate changes in the read/write routines.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">xrate</span> <span class="o">=</span> <span class="n">rme9652_adat_sample_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">xrate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">xrate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">RME9652_freq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">xrate</span> <span class="o">&lt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">RME9652_DS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">xrate</span> <span class="o">&lt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">RME9652_DS</span> <span class="o">|</span> <span class="n">RME9652_freq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reject_if_open</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RME9652_freq</span> <span class="o">|</span> <span class="n">RME9652_DS</span><span class="p">);</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">RME9652_DS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">==</span> <span class="n">RME9652_NCHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_9652_ds</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_9636_ds</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">==</span> <span class="n">RME9652_NCHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_9652_ss</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_9636_ss</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_set_thru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* set thru for all channels */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RME9652_NCHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_thru_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RME9652_NCHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_thru_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mapped_channel</span><span class="p">;</span>

		<span class="n">mapped_channel</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mapped_channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mapped_channel</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span>
			       <span class="n">RME9652_thru_base</span> <span class="o">+</span> <span class="n">mapped_channel</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			       <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>			       
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_set_thru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* we don&#39;t want interrupts, so do a</span>
<span class="cm">		   custom version of rme9652_start().</span>
<span class="cm">		*/</span>

		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
			<span class="n">RME9652_inp_0</span> <span class="o">|</span> 
			<span class="n">rme9652_encode_latency</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">RME9652_start_bit</span><span class="p">;</span>

		<span class="n">rme9652_reset_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

		<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span>
			      <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rme9652_set_thru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>		
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> 
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> 
			<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_CLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_spdif_read_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652_read</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_SPDIF_READ</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_CLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_write_spdif_codec</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_spdif_read_codec</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rme9652_spdif_write_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rme9652_spdif_read_byte</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652_spdif_set_bit</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_SPDIF_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_initialize_spdif_receiver</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX what unsets this ? */</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_SPDIF_RESET</span><span class="p">;</span>

	<span class="n">rme9652_write_spdif_codec</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">rme9652_write_spdif_codec</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
	<span class="n">rme9652_write_spdif_codec</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rme9652_spdif_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_ERF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* error condition */</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
		
		<span class="n">x</span> <span class="o">=</span> <span class="n">rme9652_spdif_read_codec</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
			<span class="n">y</span> <span class="o">=</span> <span class="mi">48000</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">/</span> <span class="n">x</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span>      <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">30400</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">33600</span><span class="p">)</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> 
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">41900</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">46000</span><span class="p">)</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">46000</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">50400</span><span class="p">)</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">60800</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">67200</span><span class="p">)</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">83700</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">92000</span><span class="p">)</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">92000</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
		<span class="k">else</span>                              <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_F</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rme9652_decode_spdif_rate</span><span class="p">(</span><span class="n">rate_bits</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="k">return</span> <span class="mi">32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x6</span>:
		<span class="k">return</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="k">return</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="k">return</span> <span class="mi">88200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">return</span> <span class="mi">96000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="k">return</span> <span class="mi">64000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown S/PDIF input rate (bits = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">s</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">rate_bits</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm">  Control Interface</span>
<span class="cm">  ----------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_rme9652_convert_from_aes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">aes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span><span class="p">)</span> <span class="o">?</span> <span class="n">RME9652_PRO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_NONAUDIO</span><span class="p">)</span> <span class="o">?</span> <span class="n">RME9652_Dolby</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_PRO</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">)</span> <span class="o">?</span> <span class="n">RME9652_EMP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="p">)</span> <span class="o">?</span> <span class="n">RME9652_EMP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_rme9652_convert_to_aes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">aes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_PRO</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_Dolby</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_PRO</span><span class="p">)</span>
		<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_EMP</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RME9652_EMP</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">snd_rme9652_convert_to_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_rme9652_convert_from_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_stream_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">snd_rme9652_convert_to_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_rme9652_convert_from_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RME9652_PRO</span> <span class="o">|</span> <span class="n">RME9652_Dolby</span> <span class="o">|</span> <span class="n">RME9652_EMP</span><span class="p">);</span>
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_mask_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_control_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_ADAT1_IN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_adat1_in, \</span>
<span class="cp">  .get = snd_rme9652_get_adat1_in, \</span>
<span class="cp">  .put = snd_rme9652_put_adat1_in }</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rme9652_adat1_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_ADAT1_INTERNAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> 
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_adat1_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_ADAT1_INTERNAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RME9652_ADAT1_INTERNAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX do we actually need to stop the card when we do this ? */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_adat1_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ADAT1&quot;</span><span class="p">,</span> <span class="s">&quot;Internal&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_adat1_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_adat1_in</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_adat1_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652_adat1_in</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">rme9652_set_adat1_input</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_SPDIF_IN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_spdif_in, \</span>
<span class="cp">  .get = snd_rme9652_get_spdif_in, .put = snd_rme9652_put_spdif_in }</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rme9652_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rme9652_decode_spdif_in</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span>
				       <span class="n">RME9652_inp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_spdif_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RME9652_inp</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rme9652_encode_spdif_in</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ADAT1&quot;</span><span class="p">,</span> <span class="s">&quot;Coaxial&quot;</span><span class="p">,</span> <span class="s">&quot;Internal&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_spdif_in</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652_spdif_in</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">rme9652_set_spdif_input</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_SPDIF_OUT(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_spdif_out, \</span>
<span class="cp">  .get = snd_rme9652_get_spdif_out, .put = snd_rme9652_put_spdif_out }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_opt_out</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_spdif_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_opt_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RME9652_opt_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_rme9652_info_spdif_out	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_spdif_out</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652_spdif_out</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652_set_spdif_output</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_SYNC_MODE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_sync_mode, \</span>
<span class="cp">  .get = snd_rme9652_get_sync_mode, .put = snd_rme9652_put_sync_mode }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_wsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_Master</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">RME9652_Master</span> <span class="o">|</span> <span class="n">RME9652_wsel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RME9652_wsel</span><span class="p">)</span> <span class="o">|</span> <span class="n">RME9652_Master</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">RME9652_Master</span> <span class="o">|</span> <span class="n">RME9652_wsel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;AutoSync&quot;</span><span class="p">,</span> <span class="s">&quot;Master&quot;</span><span class="p">,</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_sync_mode</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652_sync_mode</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652_set_sync_mode</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_SYNC_PREF(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_sync_pref, \</span>
<span class="cp">  .get = snd_rme9652_get_sync_pref, .put = snd_rme9652_put_sync_pref }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_sync_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_SyncPref_Mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT1</span>:
		<span class="k">return</span> <span class="n">RME9652_SYNC_FROM_ADAT1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT2</span>:
		<span class="k">return</span> <span class="n">RME9652_SYNC_FROM_ADAT2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT3</span>:
		<span class="k">return</span> <span class="n">RME9652_SYNC_FROM_ADAT3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SyncPref_SPDIF</span>:
		<span class="k">return</span> <span class="n">RME9652_SYNC_FROM_SPDIF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Not reachable */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rme9652_set_sync_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span><span class="p">;</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RME9652_SyncPref_Mask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RME9652_SYNC_FROM_ADAT1</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_SyncPref_ADAT1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SYNC_FROM_ADAT2</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_SyncPref_ADAT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SYNC_FROM_ADAT3</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_SyncPref_ADAT3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SYNC_FROM_SPDIF</span>:
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">RME9652_SyncPref_SPDIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">restart</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_sync_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;IEC958 In&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1 In&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2 In&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3 In&quot;</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">==</span> <span class="n">RME9652_NCHANNELS</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_sync_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_sync_pref</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_sync_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">==</span> <span class="n">RME9652_NCHANNELS</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">rme9652_sync_pref</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652_set_sync_pref</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_thru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_thru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thru_bits</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">thru_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_thru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thru_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">chn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">chn</span><span class="p">])</span>
			<span class="n">thru_bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">thru_bits</span> <span class="o">^</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">chn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rme9652_set_thru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span><span class="n">chn</span><span class="p">,</span><span class="n">thru_bits</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">chn</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!!</span><span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_PASSTHRU(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_rme9652_info_passthru, \</span>
<span class="cp">  .put = snd_rme9652_put_passthru, \</span>
<span class="cp">  .get = snd_rme9652_get_passthru }</span>

<span class="cp">#define snd_rme9652_info_passthru	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_put_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rme9652_use_is_exclusive</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rme9652_set_passthru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read-only switches */</span>

<span class="cp">#define RME9652_SPDIF_RATE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_rme9652_info_spdif_rate, \</span>
<span class="cp">  .get = snd_rme9652_get_spdif_rate }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_spdif_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_spdif_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rme9652_spdif_sample_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_ADAT_SYNC(xname, xindex, xidx) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_rme9652_info_adat_sync, \</span>
<span class="cp">  .get = snd_rme9652_get_adat_sync, .private_value = xidx }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_info_adat_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;No Lock&quot;</span><span class="p">,</span> <span class="s">&quot;Lock&quot;</span><span class="p">,</span> <span class="s">&quot;No Lock Sync&quot;</span><span class="p">,</span> <span class="s">&quot;Lock Sync&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_adat_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">mask1</span> <span class="o">=</span> <span class="n">RME9652_lock_0</span><span class="p">;</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">RME9652_sync_0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">mask1</span> <span class="o">=</span> <span class="n">RME9652_lock_1</span><span class="p">;</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">RME9652_sync_1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">mask1</span> <span class="o">=</span> <span class="n">RME9652_lock_2</span><span class="p">;</span> <span class="n">mask2</span> <span class="o">=</span> <span class="n">RME9652_sync_2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>	
	<span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RME9652_TC_VALID(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_rme9652_info_tc_valid, \</span>
<span class="cp">  .get = snd_rme9652_get_tc_valid }</span>

<span class="cp">#define snd_rme9652_info_tc_valid	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_tc_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> 
		<span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_tc_valid</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef ALSA_HAS_STANDARD_WAY_OF_RETURNING_TIMECODE</span>

<span class="cm">/* FIXME: this routine needs a port to the new control API --jk */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_get_tc_value</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span>
				    <span class="n">snd_kswitch_t</span> <span class="o">*</span><span class="n">kswitch</span><span class="p">,</span>
				    <span class="n">snd_switch_t</span> <span class="o">*</span><span class="n">uswitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="p">)</span> <span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">uswitch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_SW_TYPE_DWORD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">RME9652_tc_valid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uswitch</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">data32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* timecode request */</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RME9652_time_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* XXX bug alert: loop-based timing !!!! */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_tc_busy</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_tc_busy</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_tc_out</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uswitch</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">data32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* ALSA_HAS_STANDARD_WAY_OF_RETURNING_TIMECODE */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_rme9652_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_stream_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_stream_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_stream_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
			<span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
			<span class="n">IEC958_AES0_CON_EMPHASIS</span><span class="p">,</span>	                                                                                      
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PRO_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_rme9652_control_spdif_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
			<span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
			<span class="n">IEC958_AES0_PRO_EMPHASIS</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">RME9652_SPDIF_IN</span><span class="p">(</span><span class="s">&quot;IEC958 Input Connector&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_SPDIF_OUT</span><span class="p">(</span><span class="s">&quot;IEC958 Output also on ADAT1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_SYNC_MODE</span><span class="p">(</span><span class="s">&quot;Sync Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_SYNC_PREF</span><span class="p">(</span><span class="s">&quot;Preferred Sync Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Channels Thru&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_rme9652_info_thru</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_rme9652_get_thru</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_rme9652_put_thru</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">RME9652_SPDIF_RATE</span><span class="p">(</span><span class="s">&quot;IEC958 Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_ADAT_SYNC</span><span class="p">(</span><span class="s">&quot;ADAT1 Sync Check&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_ADAT_SYNC</span><span class="p">(</span><span class="s">&quot;ADAT2 Sync Check&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">RME9652_TC_VALID</span><span class="p">(</span><span class="s">&quot;Timecode Valid&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">RME9652_PASSTHRU</span><span class="p">(</span><span class="s">&quot;Passthru&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_rme9652_adat3_check</span> <span class="o">=</span>
<span class="n">RME9652_ADAT_SYNC</span><span class="p">(</span><span class="s">&quot;ADAT3 Sync Check&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_rme9652_adat1_input</span> <span class="o">=</span>
<span class="n">RME9652_ADAT1_IN</span><span class="p">(</span><span class="s">&quot;ADAT1 Input Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_create_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_rme9652_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_rme9652_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">rme9652</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* IEC958 (S/PDIF) Stream */</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">==</span> <span class="n">RME9652_NCHANNELS</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_rme9652_adat3_check</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_rme9652_adat1_input</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   /proc interface </span>
<span class="cm"> ------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_rme9652_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thru_bits</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">show_auto_sync_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s (Card #%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Buffers: capture %p playback %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_buffer</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IRQ: %d Registers bus: 0x%lx VM: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Control register: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">rme9652_decode_latency</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> 
					     <span class="n">RME9652_latency</span><span class="p">));</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Latency: %d samples (2 periods of %lu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Hardware pointer (frames): %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rme9652_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Passthru: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RME9652_Master</span> <span class="o">|</span> <span class="n">RME9652_wsel</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Clock mode: autosync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">show_auto_sync_source</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_wsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_wsel_rd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Clock mode: word clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Clock mode: word clock (no signal)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Clock mode: master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">show_auto_sync_source</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_SyncPref_Mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT1</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Pref. sync source: ADAT1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT2</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Pref. sync source: ADAT2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RME9652_SyncPref_ADAT3</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Pref. sync source: ADAT3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RME9652_SyncPref_SPDIF</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Pref. sync source: IEC958</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Pref. sync source: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">ADAT1 Input source: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_ADAT1_INTERNAL</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot;Internal&quot;</span> <span class="o">:</span> <span class="s">&quot;ADAT1 optical&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rme9652_decode_spdif_in</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> 
					<span class="n">RME9652_inp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RME9652_SPDIFIN_OPTICAL</span>:
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: ADAT1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SPDIFIN_COAXIAL</span>:
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: Coaxial</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RME9652_SPDIFIN_INTERN</span>:
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: Internal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_opt_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 output: Coaxial &amp; ADAT1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 output: Coaxial only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_PRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 quality: Professional</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 quality: Consumer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_EMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 emphasis: on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 emphasis: off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">RME9652_Dolby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 Dolby: on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 Dolby: off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rme9652_spdif_sample_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="s">&quot;IEC958 sample rate: error flag set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 sample rate: undetermined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 sample rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT Sample rate: %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rme9652_adat_sample_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">));</span>

	<span class="cm">/* Sync Check */</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_sync_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_lock_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT1: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT1: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_sync_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_lock_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT2: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT2: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_sync_2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_lock_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT3: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT3: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Timecode signal: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RME9652_tc_valid</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="cm">/* thru modes */</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Punch Status:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thru_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%2d:  on &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%2d: off &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_rme9652_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;rme9652&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span> <span class="n">snd_rme9652_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_rme9652_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">snd_rme9652_free_buffers</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_rme9652_initialize_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pb_bus</span><span class="p">,</span> <span class="n">cb_bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">,</span> <span class="n">RME9652_DMA_AREA_BYTES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">,</span> <span class="n">RME9652_DMA_AREA_BYTES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
			<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Align to bus-space 64K boundary */</span>

	<span class="n">cb_bus</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x10000ul</span><span class="p">);</span>
	<span class="n">pb_bus</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x10000ul</span><span class="p">);</span>

	<span class="cm">/* Tell the card where it is */</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_rec_buffer</span><span class="p">,</span> <span class="n">cb_bus</span><span class="p">);</span>
	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_play_buffer</span><span class="p">,</span> <span class="n">pb_bus</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="p">(</span><span class="n">cb_bus</span> <span class="o">-</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="p">(</span><span class="n">pb_bus</span> <span class="o">-</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_rme9652_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="cm">/* ASSUMPTION: rme9652-&gt;lock is either held, or</span>
<span class="cm">	   there is no need to hold it (e.g. during module</span>
<span class="cm">	   initialization).</span>
<span class="cm">	 */</span>

	<span class="cm">/* set defaults:</span>

<span class="cm">	   SPDIF Input via Coax </span>
<span class="cm">	   autosync clock mode</span>
<span class="cm">	   maximum latency (7 = 8192 samples, 64Kbyte buffer,</span>
<span class="cm">	   which implies 2 4096 sample, 32Kbyte periods).</span>
<span class="cm">	   </span>
<span class="cm">	   if rev 1.5, initialize the S/PDIF receiver.</span>

<span class="cm">	 */</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
	    <span class="n">RME9652_inp_0</span> <span class="o">|</span> <span class="n">rme9652_encode_latency</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="n">rme9652_reset_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652_compute_period_size</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="cm">/* default: thru off for all channels */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">RME9652_NCHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
		<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_thru_base</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">thru_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">passthru</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set a default rate so that the channel map is set up */</span>

	<span class="n">rme9652_set_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_rme9652_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RME9652_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_irq_clear</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_rme9652_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rme9652_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rme9652_channel_buffer_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mapped_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">RME9652_NCHANNELS</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        
	<span class="k">if</span> <span class="p">((</span><span class="n">mapped_channel</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">mapped_channel</span> <span class="o">*</span> <span class="n">RME9652_CHANNEL_BUFFER_BYTES</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">mapped_channel</span> <span class="o">*</span> <span class="n">RME9652_CHANNEL_BUFFER_BYTES</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_playback_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				     <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">RME9652_CHANNEL_BUFFER_BYTES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">rme9652_channel_buffer_location</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span>
						       <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
						       <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_capture_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				    <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">RME9652_CHANNEL_BUFFER_BYTES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">rme9652_channel_buffer_location</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span>
						       <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
						       <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_hw_silence</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				  <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">rme9652_channel_buffer_location</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">,</span>
						       <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
						       <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="n">rme9652_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">oruntime</span> <span class="o">=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">oruntime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">this_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">other_pid</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RME9652_PRO</span> <span class="o">|</span> <span class="n">RME9652_Dolby</span> <span class="o">|</span> <span class="n">RME9652_EMP</span><span class="p">);</span>
		<span class="n">rme9652_write</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_control_register</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">);</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">other_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_pid</span> <span class="o">!=</span> <span class="n">other_pid</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* The other stream is open, and not by the same</span>
<span class="cm">		   task as this one. Make sure that the parameters</span>
<span class="cm">		   that matter are the same.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">rme9652_adat_sample_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* We&#39;re fine. */</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
 		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* how to make sure that the rate matches an externally-set one ?</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">rme9652_set_rate</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">rme9652_set_interrupt_interval</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_channel_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">RME9652_NCHANNELS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chn</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">chn</span> <span class="o">*</span> <span class="n">RME9652_CHANNEL_BUFFER_BYTES</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_RESET</span>:
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">snd_rme9652_reset</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_CHANNEL_INFO</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_rme9652_channel_info</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rme9652_silence_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RME9652_DMA_AREA_BYTES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">running</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span>
					<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">_ok</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">running</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
				<span class="n">rme9652_silence_playback</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">running</span> <span class="o">&amp;&amp;</span>
			    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
				<span class="n">rme9652_silence_playback</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span> 
			<span class="n">rme9652_silence_playback</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">_ok:</span>
	<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="n">running</span><span class="p">)</span>
		<span class="n">rme9652_start</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">running</span><span class="p">)</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="n">running</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">rme9652_reset_hw_pointer</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_rme9652_playback_subinfo</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_DOUBLE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">96000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="n">RME9652_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_rme9652_capture_subinfo</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">96000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="n">RME9652_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span><span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">8192</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_period_sizes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">period_sizes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">period_sizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_hw_rule_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ds_channels</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_hw_rule_channels_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ds_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ds_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">88200</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_hw_rule_rate_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ds_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

        <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_rme9652_playback_subinfo</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">RME9652_DMA_AREA_BYTES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
		<span class="n">rme9652_set_thru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_constraints_period_sizes</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_channels</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_channels_rate</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_rate_channels</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_playback_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_rme9652_capture_subinfo</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_buffer</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">RME9652_DMA_AREA_BYTES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_stop</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
		<span class="n">rme9652_set_thru</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_constraints_period_sizes</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_channels</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_channels_rate</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
			     <span class="n">snd_rme9652_hw_rule_rate_channels</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_rme9652_capture_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_rme9652_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_rme9652_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_rme9652_playback_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_rme9652_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_rme9652_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_rme9652_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_rme9652_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_rme9652_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_rme9652_playback_copy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">silence</span> <span class="o">=</span>	<span class="n">snd_rme9652_hw_silence</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_rme9652_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_rme9652_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_rme9652_capture_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_rme9652_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_rme9652_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_rme9652_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_rme9652_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_rme9652_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_rme9652_capture_copy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_rme9652_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			       <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rme9652</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_rme9652_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_rme9652_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_rme9652_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">precise_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* who knows? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;rme9652&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RME9652_IO_EXTENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to remap region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">RME9652_IO_EXTENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_rme9652_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to request IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">precise_ptr</span> <span class="o">=</span> <span class="n">precise_ptr</span><span class="p">;</span>

	<span class="cm">/* Determine the h/w rev level of the card. This seems like</span>
<span class="cm">	   a particularly kludgy way to encode it, but its what RME</span>
<span class="cm">	   chose to do, so we follow them ...</span>
<span class="cm">	*/</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rme9652_read</span><span class="p">(</span><span class="n">rme9652</span><span class="p">,</span> <span class="n">RME9652_status_register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652_decode_spdif_rate</span><span class="p">(</span><span class="n">status</span><span class="o">&amp;</span><span class="n">RME9652_F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Differentiate between the standard Hammerfall, and the</span>
<span class="cm">	   &quot;Light&quot;, which does not have the expansion board. This</span>
<span class="cm">	   method comes from information received from Mathhias</span>
<span class="cm">	   Clausen at RME. Display the EEPROM and h/w revID where</span>
<span class="cm">	   relevant.  </span>
<span class="cm">	*/</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* original eprom */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;RME9636&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9636 (Rev 1.5)&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9636&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">=</span> <span class="n">RME9636_NCHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* W36_G EPROM */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;RME9636&quot;</span><span class="p">);</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9636 (Rev G)&quot;</span><span class="p">;</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">=</span> <span class="n">RME9636_NCHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* W52_G EPROM */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;RME9652&quot;</span><span class="p">);</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9652 (Rev G)&quot;</span><span class="p">;</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">=</span> <span class="n">RME9652_NCHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* original eprom */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;RME9652&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9652 (Rev 1.5)&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Digi9652&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">=</span> <span class="n">RME9652_NCHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ds_channels</span> <span class="o">=</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">ss_channels</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rme9652_initialize_memory</span><span class="p">(</span><span class="n">rme9652</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rme9652_create_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rme9652_create_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_rme9652_proc_init</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">last_spdif_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">last_adat_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_rme9652_set_defaults</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rme9652_initialize_spdif_receiver</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_rme9652_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rme9652</span><span class="p">)</span>
		<span class="n">snd_rme9652_free</span><span class="p">(</span><span class="n">rme9652</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_rme9652_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="n">rme9652</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rme9652</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_rme9652</span> <span class="o">*</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_rme9652_card_free</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rme9652_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rme9652</span><span class="p">,</span> <span class="n">precise_ptr</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">rme9652</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_rme9652_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rme9652_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_rme9652_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>	  <span class="o">=</span> <span class="n">snd_rme9652_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_rme9652_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">rme9652_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
