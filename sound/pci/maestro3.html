<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › maestro3.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>maestro3.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for ESS Maestro3/Allegro (ES1988) soundcards.</span>
<span class="cm"> * Copyright (c) 2000 by Zach Brown &lt;zab@zabbo.net&gt;</span>
<span class="cm"> *                       Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Most of the hardware init stuffs are based on maestro3 driver for</span>
<span class="cm"> * OSS/Free by Zach Brown.  Many thanks to Zach!</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * ChangeLog:</span>
<span class="cm"> * Aug. 27, 2001</span>
<span class="cm"> *     - Fixed deadlock on capture</span>
<span class="cm"> *     - Added Canyon3D-2 support by Rob Riggs &lt;rob@pangalactic.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#define CARD_NAME &quot;ESS Maestro3/Allegro/Canyon3D-2&quot;</span>
<span class="cp">#define DRIVER_NAME &quot;Maestro3&quot;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Zach Brown &lt;zab@zabbo.net&gt;, Takashi Iwai &lt;tiwai@suse.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ESS Maestro3 PCI&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{ESS,Maestro3 PCI},&quot;</span>
		<span class="s">&quot;{ESS,ES1988},&quot;</span>
		<span class="s">&quot;{ESS,Allegro PCI},&quot;</span>
		<span class="s">&quot;{ESS,Allegro-1 PCI},&quot;</span>
	        <span class="s">&quot;{ESS,Canyon3D-2/LE PCI}}&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ess/maestro3_assp_kernel.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ess/maestro3_assp_minisrc.fw&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span> <span class="cm">/* all enabled */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">external_amp</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">amp_gpio</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable this soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">external_amp</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">external_amp</span><span class="p">,</span> <span class="s">&quot;Enable external amp for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">amp_gpio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">amp_gpio</span><span class="p">,</span> <span class="s">&quot;GPIO pin number for external amp. (default = -1)&quot;</span><span class="p">);</span>

<span class="cp">#define MAX_PLAYBACKS	2</span>
<span class="cp">#define MAX_CAPTURES	1</span>
<span class="cp">#define NR_DSPS		(MAX_PLAYBACKS + MAX_CAPTURES)</span>


<span class="cm">/*</span>
<span class="cm"> * maestro3 registers</span>
<span class="cm"> */</span>

<span class="cm">/* Allegro PCI configuration registers */</span>
<span class="cp">#define PCI_LEGACY_AUDIO_CTRL   0x40</span>
<span class="cp">#define SOUND_BLASTER_ENABLE    0x00000001</span>
<span class="cp">#define FM_SYNTHESIS_ENABLE     0x00000002</span>
<span class="cp">#define GAME_PORT_ENABLE        0x00000004</span>
<span class="cp">#define MPU401_IO_ENABLE        0x00000008</span>
<span class="cp">#define MPU401_IRQ_ENABLE       0x00000010</span>
<span class="cp">#define ALIAS_10BIT_IO          0x00000020</span>
<span class="cp">#define SB_DMA_MASK             0x000000C0</span>
<span class="cp">#define SB_DMA_0                0x00000040</span>
<span class="cp">#define SB_DMA_1                0x00000040</span>
<span class="cp">#define SB_DMA_R                0x00000080</span>
<span class="cp">#define SB_DMA_3                0x000000C0</span>
<span class="cp">#define SB_IRQ_MASK             0x00000700</span>
<span class="cp">#define SB_IRQ_5                0x00000000</span>
<span class="cp">#define SB_IRQ_7                0x00000100</span>
<span class="cp">#define SB_IRQ_9                0x00000200</span>
<span class="cp">#define SB_IRQ_10               0x00000300</span>
<span class="cp">#define MIDI_IRQ_MASK           0x00003800</span>
<span class="cp">#define SERIAL_IRQ_ENABLE       0x00004000</span>
<span class="cp">#define DISABLE_LEGACY          0x00008000</span>

<span class="cp">#define PCI_ALLEGRO_CONFIG      0x50</span>
<span class="cp">#define SB_ADDR_240             0x00000004</span>
<span class="cp">#define MPU_ADDR_MASK           0x00000018</span>
<span class="cp">#define MPU_ADDR_330            0x00000000</span>
<span class="cp">#define MPU_ADDR_300            0x00000008</span>
<span class="cp">#define MPU_ADDR_320            0x00000010</span>
<span class="cp">#define MPU_ADDR_340            0x00000018</span>
<span class="cp">#define USE_PCI_TIMING          0x00000040</span>
<span class="cp">#define POSTED_WRITE_ENABLE     0x00000080</span>
<span class="cp">#define DMA_POLICY_MASK         0x00000700</span>
<span class="cp">#define DMA_DDMA                0x00000000</span>
<span class="cp">#define DMA_TDMA                0x00000100</span>
<span class="cp">#define DMA_PCPCI               0x00000200</span>
<span class="cp">#define DMA_WBDMA16             0x00000400</span>
<span class="cp">#define DMA_WBDMA4              0x00000500</span>
<span class="cp">#define DMA_WBDMA2              0x00000600</span>
<span class="cp">#define DMA_WBDMA1              0x00000700</span>
<span class="cp">#define DMA_SAFE_GUARD          0x00000800</span>
<span class="cp">#define HI_PERF_GP_ENABLE       0x00001000</span>
<span class="cp">#define PIC_SNOOP_MODE_0        0x00002000</span>
<span class="cp">#define PIC_SNOOP_MODE_1        0x00004000</span>
<span class="cp">#define SOUNDBLASTER_IRQ_MASK   0x00008000</span>
<span class="cp">#define RING_IN_ENABLE          0x00010000</span>
<span class="cp">#define SPDIF_TEST_MODE         0x00020000</span>
<span class="cp">#define CLK_MULT_MODE_SELECT_2  0x00040000</span>
<span class="cp">#define EEPROM_WRITE_ENABLE     0x00080000</span>
<span class="cp">#define CODEC_DIR_IN            0x00100000</span>
<span class="cp">#define HV_BUTTON_FROM_GD       0x00200000</span>
<span class="cp">#define REDUCED_DEBOUNCE        0x00400000</span>
<span class="cp">#define HV_CTRL_ENABLE          0x00800000</span>
<span class="cp">#define SPDIF_ENABLE            0x01000000</span>
<span class="cp">#define CLK_DIV_SELECT          0x06000000</span>
<span class="cp">#define CLK_DIV_BY_48           0x00000000</span>
<span class="cp">#define CLK_DIV_BY_49           0x02000000</span>
<span class="cp">#define CLK_DIV_BY_50           0x04000000</span>
<span class="cp">#define CLK_DIV_RESERVED        0x06000000</span>
<span class="cp">#define PM_CTRL_ENABLE          0x08000000</span>
<span class="cp">#define CLK_MULT_MODE_SELECT    0x30000000</span>
<span class="cp">#define CLK_MULT_MODE_SHIFT     28</span>
<span class="cp">#define CLK_MULT_MODE_0         0x00000000</span>
<span class="cp">#define CLK_MULT_MODE_1         0x10000000</span>
<span class="cp">#define CLK_MULT_MODE_2         0x20000000</span>
<span class="cp">#define CLK_MULT_MODE_3         0x30000000</span>
<span class="cp">#define INT_CLK_SELECT          0x40000000</span>
<span class="cp">#define INT_CLK_MULT_RESET      0x80000000</span>

<span class="cm">/* M3 */</span>
<span class="cp">#define INT_CLK_SRC_NOT_PCI     0x00100000</span>
<span class="cp">#define INT_CLK_MULT_ENABLE     0x80000000</span>

<span class="cp">#define PCI_ACPI_CONTROL        0x54</span>
<span class="cp">#define PCI_ACPI_D0             0x00000000</span>
<span class="cp">#define PCI_ACPI_D1             0xB4F70000</span>
<span class="cp">#define PCI_ACPI_D2             0xB4F7B4F7</span>

<span class="cp">#define PCI_USER_CONFIG         0x58</span>
<span class="cp">#define EXT_PCI_MASTER_ENABLE   0x00000001</span>
<span class="cp">#define SPDIF_OUT_SELECT        0x00000002</span>
<span class="cp">#define TEST_PIN_DIR_CTRL       0x00000004</span>
<span class="cp">#define AC97_CODEC_TEST         0x00000020</span>
<span class="cp">#define TRI_STATE_BUFFER        0x00000080</span>
<span class="cp">#define IN_CLK_12MHZ_SELECT     0x00000100</span>
<span class="cp">#define MULTI_FUNC_DISABLE      0x00000200</span>
<span class="cp">#define EXT_MASTER_PAIR_SEL     0x00000400</span>
<span class="cp">#define PCI_MASTER_SUPPORT      0x00000800</span>
<span class="cp">#define STOP_CLOCK_ENABLE       0x00001000</span>
<span class="cp">#define EAPD_DRIVE_ENABLE       0x00002000</span>
<span class="cp">#define REQ_TRI_STATE_ENABLE    0x00004000</span>
<span class="cp">#define REQ_LOW_ENABLE          0x00008000</span>
<span class="cp">#define MIDI_1_ENABLE           0x00010000</span>
<span class="cp">#define MIDI_2_ENABLE           0x00020000</span>
<span class="cp">#define SB_AUDIO_SYNC           0x00040000</span>
<span class="cp">#define HV_CTRL_TEST            0x00100000</span>
<span class="cp">#define SOUNDBLASTER_TEST       0x00400000</span>

<span class="cp">#define PCI_USER_CONFIG_C       0x5C</span>

<span class="cp">#define PCI_DDMA_CTRL           0x60</span>
<span class="cp">#define DDMA_ENABLE             0x00000001</span>


<span class="cm">/* Allegro registers */</span>
<span class="cp">#define HOST_INT_CTRL           0x18</span>
<span class="cp">#define SB_INT_ENABLE           0x0001</span>
<span class="cp">#define MPU401_INT_ENABLE       0x0002</span>
<span class="cp">#define ASSP_INT_ENABLE         0x0010</span>
<span class="cp">#define RING_INT_ENABLE         0x0020</span>
<span class="cp">#define HV_INT_ENABLE           0x0040</span>
<span class="cp">#define CLKRUN_GEN_ENABLE       0x0100</span>
<span class="cp">#define HV_CTRL_TO_PME          0x0400</span>
<span class="cp">#define SOFTWARE_RESET_ENABLE   0x8000</span>

<span class="cm">/*</span>
<span class="cm"> * should be using the above defines, probably.</span>
<span class="cm"> */</span>
<span class="cp">#define REGB_ENABLE_RESET               0x01</span>
<span class="cp">#define REGB_STOP_CLOCK                 0x10</span>

<span class="cp">#define HOST_INT_STATUS         0x1A</span>
<span class="cp">#define SB_INT_PENDING          0x01</span>
<span class="cp">#define MPU401_INT_PENDING      0x02</span>
<span class="cp">#define ASSP_INT_PENDING        0x10</span>
<span class="cp">#define RING_INT_PENDING        0x20</span>
<span class="cp">#define HV_INT_PENDING          0x40</span>

<span class="cp">#define HARDWARE_VOL_CTRL       0x1B</span>
<span class="cp">#define SHADOW_MIX_REG_VOICE    0x1C</span>
<span class="cp">#define HW_VOL_COUNTER_VOICE    0x1D</span>
<span class="cp">#define SHADOW_MIX_REG_MASTER   0x1E</span>
<span class="cp">#define HW_VOL_COUNTER_MASTER   0x1F</span>

<span class="cp">#define CODEC_COMMAND           0x30</span>
<span class="cp">#define CODEC_READ_B            0x80</span>

<span class="cp">#define CODEC_STATUS            0x30</span>
<span class="cp">#define CODEC_BUSY_B            0x01</span>

<span class="cp">#define CODEC_DATA              0x32</span>

<span class="cp">#define RING_BUS_CTRL_A         0x36</span>
<span class="cp">#define RAC_PME_ENABLE          0x0100</span>
<span class="cp">#define RAC_SDFS_ENABLE         0x0200</span>
<span class="cp">#define LAC_PME_ENABLE          0x0400</span>
<span class="cp">#define LAC_SDFS_ENABLE         0x0800</span>
<span class="cp">#define SERIAL_AC_LINK_ENABLE   0x1000</span>
<span class="cp">#define IO_SRAM_ENABLE          0x2000</span>
<span class="cp">#define IIS_INPUT_ENABLE        0x8000</span>

<span class="cp">#define RING_BUS_CTRL_B         0x38</span>
<span class="cp">#define SECOND_CODEC_ID_MASK    0x0003</span>
<span class="cp">#define SPDIF_FUNC_ENABLE       0x0010</span>
<span class="cp">#define SECOND_AC_ENABLE        0x0020</span>
<span class="cp">#define SB_MODULE_INTF_ENABLE   0x0040</span>
<span class="cp">#define SSPE_ENABLE             0x0040</span>
<span class="cp">#define M3I_DOCK_ENABLE         0x0080</span>

<span class="cp">#define SDO_OUT_DEST_CTRL       0x3A</span>
<span class="cp">#define COMMAND_ADDR_OUT        0x0003</span>
<span class="cp">#define PCM_LR_OUT_LOCAL        0x0000</span>
<span class="cp">#define PCM_LR_OUT_REMOTE       0x0004</span>
<span class="cp">#define PCM_LR_OUT_MUTE         0x0008</span>
<span class="cp">#define PCM_LR_OUT_BOTH         0x000C</span>
<span class="cp">#define LINE1_DAC_OUT_LOCAL     0x0000</span>
<span class="cp">#define LINE1_DAC_OUT_REMOTE    0x0010</span>
<span class="cp">#define LINE1_DAC_OUT_MUTE      0x0020</span>
<span class="cp">#define LINE1_DAC_OUT_BOTH      0x0030</span>
<span class="cp">#define PCM_CLS_OUT_LOCAL       0x0000</span>
<span class="cp">#define PCM_CLS_OUT_REMOTE      0x0040</span>
<span class="cp">#define PCM_CLS_OUT_MUTE        0x0080</span>
<span class="cp">#define PCM_CLS_OUT_BOTH        0x00C0</span>
<span class="cp">#define PCM_RLF_OUT_LOCAL       0x0000</span>
<span class="cp">#define PCM_RLF_OUT_REMOTE      0x0100</span>
<span class="cp">#define PCM_RLF_OUT_MUTE        0x0200</span>
<span class="cp">#define PCM_RLF_OUT_BOTH        0x0300</span>
<span class="cp">#define LINE2_DAC_OUT_LOCAL     0x0000</span>
<span class="cp">#define LINE2_DAC_OUT_REMOTE    0x0400</span>
<span class="cp">#define LINE2_DAC_OUT_MUTE      0x0800</span>
<span class="cp">#define LINE2_DAC_OUT_BOTH      0x0C00</span>
<span class="cp">#define HANDSET_OUT_LOCAL       0x0000</span>
<span class="cp">#define HANDSET_OUT_REMOTE      0x1000</span>
<span class="cp">#define HANDSET_OUT_MUTE        0x2000</span>
<span class="cp">#define HANDSET_OUT_BOTH        0x3000</span>
<span class="cp">#define IO_CTRL_OUT_LOCAL       0x0000</span>
<span class="cp">#define IO_CTRL_OUT_REMOTE      0x4000</span>
<span class="cp">#define IO_CTRL_OUT_MUTE        0x8000</span>
<span class="cp">#define IO_CTRL_OUT_BOTH        0xC000</span>

<span class="cp">#define SDO_IN_DEST_CTRL        0x3C</span>
<span class="cp">#define STATUS_ADDR_IN          0x0003</span>
<span class="cp">#define PCM_LR_IN_LOCAL         0x0000</span>
<span class="cp">#define PCM_LR_IN_REMOTE        0x0004</span>
<span class="cp">#define PCM_LR_RESERVED         0x0008</span>
<span class="cp">#define PCM_LR_IN_BOTH          0x000C</span>
<span class="cp">#define LINE1_ADC_IN_LOCAL      0x0000</span>
<span class="cp">#define LINE1_ADC_IN_REMOTE     0x0010</span>
<span class="cp">#define LINE1_ADC_IN_MUTE       0x0020</span>
<span class="cp">#define MIC_ADC_IN_LOCAL        0x0000</span>
<span class="cp">#define MIC_ADC_IN_REMOTE       0x0040</span>
<span class="cp">#define MIC_ADC_IN_MUTE         0x0080</span>
<span class="cp">#define LINE2_DAC_IN_LOCAL      0x0000</span>
<span class="cp">#define LINE2_DAC_IN_REMOTE     0x0400</span>
<span class="cp">#define LINE2_DAC_IN_MUTE       0x0800</span>
<span class="cp">#define HANDSET_IN_LOCAL        0x0000</span>
<span class="cp">#define HANDSET_IN_REMOTE       0x1000</span>
<span class="cp">#define HANDSET_IN_MUTE         0x2000</span>
<span class="cp">#define IO_STATUS_IN_LOCAL      0x0000</span>
<span class="cp">#define IO_STATUS_IN_REMOTE     0x4000</span>

<span class="cp">#define SPDIF_IN_CTRL           0x3E</span>
<span class="cp">#define SPDIF_IN_ENABLE         0x0001</span>

<span class="cp">#define GPIO_DATA               0x60</span>
<span class="cp">#define GPIO_DATA_MASK          0x0FFF</span>
<span class="cp">#define GPIO_HV_STATUS          0x3000</span>
<span class="cp">#define GPIO_PME_STATUS         0x4000</span>

<span class="cp">#define GPIO_MASK               0x64</span>
<span class="cp">#define GPIO_DIRECTION          0x68</span>
<span class="cp">#define GPO_PRIMARY_AC97        0x0001</span>
<span class="cp">#define GPI_LINEOUT_SENSE       0x0004</span>
<span class="cp">#define GPO_SECONDARY_AC97      0x0008</span>
<span class="cp">#define GPI_VOL_DOWN            0x0010</span>
<span class="cp">#define GPI_VOL_UP              0x0020</span>
<span class="cp">#define GPI_IIS_CLK             0x0040</span>
<span class="cp">#define GPI_IIS_LRCLK           0x0080</span>
<span class="cp">#define GPI_IIS_DATA            0x0100</span>
<span class="cp">#define GPI_DOCKING_STATUS      0x0100</span>
<span class="cp">#define GPI_HEADPHONE_SENSE     0x0200</span>
<span class="cp">#define GPO_EXT_AMP_SHUTDOWN    0x1000</span>

<span class="cp">#define GPO_EXT_AMP_M3		1	</span><span class="cm">/* default m3 amp */</span><span class="cp"></span>
<span class="cp">#define GPO_EXT_AMP_ALLEGRO	8	</span><span class="cm">/* default allegro amp */</span><span class="cp"></span>

<span class="cm">/* M3 */</span>
<span class="cp">#define GPO_M3_EXT_AMP_SHUTDN   0x0002</span>

<span class="cp">#define ASSP_INDEX_PORT         0x80</span>
<span class="cp">#define ASSP_MEMORY_PORT        0x82</span>
<span class="cp">#define ASSP_DATA_PORT          0x84</span>

<span class="cp">#define MPU401_DATA_PORT        0x98</span>
<span class="cp">#define MPU401_STATUS_PORT      0x99</span>

<span class="cp">#define CLK_MULT_DATA_PORT      0x9C</span>

<span class="cp">#define ASSP_CONTROL_A          0xA2</span>
<span class="cp">#define ASSP_0_WS_ENABLE        0x01</span>
<span class="cp">#define ASSP_CTRL_A_RESERVED1   0x02</span>
<span class="cp">#define ASSP_CTRL_A_RESERVED2   0x04</span>
<span class="cp">#define ASSP_CLK_49MHZ_SELECT   0x08</span>
<span class="cp">#define FAST_PLU_ENABLE         0x10</span>
<span class="cp">#define ASSP_CTRL_A_RESERVED3   0x20</span>
<span class="cp">#define DSP_CLK_36MHZ_SELECT    0x40</span>

<span class="cp">#define ASSP_CONTROL_B          0xA4</span>
<span class="cp">#define RESET_ASSP              0x00</span>
<span class="cp">#define RUN_ASSP                0x01</span>
<span class="cp">#define ENABLE_ASSP_CLOCK       0x00</span>
<span class="cp">#define STOP_ASSP_CLOCK         0x10</span>
<span class="cp">#define RESET_TOGGLE            0x40</span>

<span class="cp">#define ASSP_CONTROL_C          0xA6</span>
<span class="cp">#define ASSP_HOST_INT_ENABLE    0x01</span>
<span class="cp">#define FM_ADDR_REMAP_DISABLE   0x02</span>
<span class="cp">#define HOST_WRITE_PORT_ENABLE  0x08</span>

<span class="cp">#define ASSP_HOST_INT_STATUS    0xAC</span>
<span class="cp">#define DSP2HOST_REQ_PIORECORD  0x01</span>
<span class="cp">#define DSP2HOST_REQ_I2SRATE    0x02</span>
<span class="cp">#define DSP2HOST_REQ_TIMER      0x04</span>

<span class="cm">/* AC97 registers */</span>
<span class="cm">/* XXX fix this crap up */</span>
<span class="cm">/*#define AC97_RESET              0x00*/</span>

<span class="cp">#define AC97_VOL_MUTE_B         0x8000</span>
<span class="cp">#define AC97_VOL_M              0x1F</span>
<span class="cp">#define AC97_LEFT_VOL_S         8</span>

<span class="cp">#define AC97_MASTER_VOL         0x02</span>
<span class="cp">#define AC97_LINE_LEVEL_VOL     0x04</span>
<span class="cp">#define AC97_MASTER_MONO_VOL    0x06</span>
<span class="cp">#define AC97_PC_BEEP_VOL        0x0A</span>
<span class="cp">#define AC97_PC_BEEP_VOL_M      0x0F</span>
<span class="cp">#define AC97_SROUND_MASTER_VOL  0x38</span>
<span class="cp">#define AC97_PC_BEEP_VOL_S      1</span>

<span class="cm">/*#define AC97_PHONE_VOL          0x0C</span>
<span class="cm">#define AC97_MIC_VOL            0x0E*/</span>
<span class="cp">#define AC97_MIC_20DB_ENABLE    0x40</span>

<span class="cm">/*#define AC97_LINEIN_VOL         0x10</span>
<span class="cm">#define AC97_CD_VOL             0x12</span>
<span class="cm">#define AC97_VIDEO_VOL          0x14</span>
<span class="cm">#define AC97_AUX_VOL            0x16*/</span>
<span class="cp">#define AC97_PCM_OUT_VOL        0x18</span>
<span class="cm">/*#define AC97_RECORD_SELECT      0x1A*/</span>
<span class="cp">#define AC97_RECORD_MIC         0x00</span>
<span class="cp">#define AC97_RECORD_CD          0x01</span>
<span class="cp">#define AC97_RECORD_VIDEO       0x02</span>
<span class="cp">#define AC97_RECORD_AUX         0x03</span>
<span class="cp">#define AC97_RECORD_MONO_MUX    0x02</span>
<span class="cp">#define AC97_RECORD_DIGITAL     0x03</span>
<span class="cp">#define AC97_RECORD_LINE        0x04</span>
<span class="cp">#define AC97_RECORD_STEREO      0x05</span>
<span class="cp">#define AC97_RECORD_MONO        0x06</span>
<span class="cp">#define AC97_RECORD_PHONE       0x07</span>

<span class="cm">/*#define AC97_RECORD_GAIN        0x1C*/</span>
<span class="cp">#define AC97_RECORD_VOL_M       0x0F</span>

<span class="cm">/*#define AC97_GENERAL_PURPOSE    0x20*/</span>
<span class="cp">#define AC97_POWER_DOWN_CTRL    0x26</span>
<span class="cp">#define AC97_ADC_READY          0x0001</span>
<span class="cp">#define AC97_DAC_READY          0x0002</span>
<span class="cp">#define AC97_ANALOG_READY       0x0004</span>
<span class="cp">#define AC97_VREF_ON            0x0008</span>
<span class="cp">#define AC97_PR0                0x0100</span>
<span class="cp">#define AC97_PR1                0x0200</span>
<span class="cp">#define AC97_PR2                0x0400</span>
<span class="cp">#define AC97_PR3                0x0800</span>
<span class="cp">#define AC97_PR4                0x1000</span>

<span class="cp">#define AC97_RESERVED1          0x28</span>

<span class="cp">#define AC97_VENDOR_TEST        0x5A</span>

<span class="cp">#define AC97_CLOCK_DELAY        0x5C</span>
<span class="cp">#define AC97_LINEOUT_MUX_SEL    0x0001</span>
<span class="cp">#define AC97_MONO_MUX_SEL       0x0002</span>
<span class="cp">#define AC97_CLOCK_DELAY_SEL    0x1F</span>
<span class="cp">#define AC97_DAC_CDS_SHIFT      6</span>
<span class="cp">#define AC97_ADC_CDS_SHIFT      11</span>

<span class="cp">#define AC97_MULTI_CHANNEL_SEL  0x74</span>

<span class="cm">/*#define AC97_VENDOR_ID1         0x7C</span>
<span class="cm">#define AC97_VENDOR_ID2         0x7E*/</span>

<span class="cm">/*</span>
<span class="cm"> * ASSP control regs</span>
<span class="cm"> */</span>
<span class="cp">#define DSP_PORT_TIMER_COUNT    0x06</span>

<span class="cp">#define DSP_PORT_MEMORY_INDEX   0x80</span>

<span class="cp">#define DSP_PORT_MEMORY_TYPE    0x82</span>
<span class="cp">#define MEMTYPE_INTERNAL_CODE   0x0002</span>
<span class="cp">#define MEMTYPE_INTERNAL_DATA   0x0003</span>
<span class="cp">#define MEMTYPE_MASK            0x0003</span>

<span class="cp">#define DSP_PORT_MEMORY_DATA    0x84</span>

<span class="cp">#define DSP_PORT_CONTROL_REG_A  0xA2</span>
<span class="cp">#define DSP_PORT_CONTROL_REG_B  0xA4</span>
<span class="cp">#define DSP_PORT_CONTROL_REG_C  0xA6</span>

<span class="cp">#define REV_A_CODE_MEMORY_BEGIN         0x0000</span>
<span class="cp">#define REV_A_CODE_MEMORY_END           0x0FFF</span>
<span class="cp">#define REV_A_CODE_MEMORY_UNIT_LENGTH   0x0040</span>
<span class="cp">#define REV_A_CODE_MEMORY_LENGTH        (REV_A_CODE_MEMORY_END - REV_A_CODE_MEMORY_BEGIN + 1)</span>

<span class="cp">#define REV_B_CODE_MEMORY_BEGIN         0x0000</span>
<span class="cp">#define REV_B_CODE_MEMORY_END           0x0BFF</span>
<span class="cp">#define REV_B_CODE_MEMORY_UNIT_LENGTH   0x0040</span>
<span class="cp">#define REV_B_CODE_MEMORY_LENGTH        (REV_B_CODE_MEMORY_END - REV_B_CODE_MEMORY_BEGIN + 1)</span>

<span class="cp">#define REV_A_DATA_MEMORY_BEGIN         0x1000</span>
<span class="cp">#define REV_A_DATA_MEMORY_END           0x2FFF</span>
<span class="cp">#define REV_A_DATA_MEMORY_UNIT_LENGTH   0x0080</span>
<span class="cp">#define REV_A_DATA_MEMORY_LENGTH        (REV_A_DATA_MEMORY_END - REV_A_DATA_MEMORY_BEGIN + 1)</span>

<span class="cp">#define REV_B_DATA_MEMORY_BEGIN         0x1000</span>
<span class="cp">#define REV_B_DATA_MEMORY_END           0x2BFF</span>
<span class="cp">#define REV_B_DATA_MEMORY_UNIT_LENGTH   0x0080</span>
<span class="cp">#define REV_B_DATA_MEMORY_LENGTH        (REV_B_DATA_MEMORY_END - REV_B_DATA_MEMORY_BEGIN + 1)</span>


<span class="cp">#define NUM_UNITS_KERNEL_CODE          16</span>
<span class="cp">#define NUM_UNITS_KERNEL_DATA           2</span>

<span class="cp">#define NUM_UNITS_KERNEL_CODE_WITH_HSP 16</span>
<span class="cp">#define NUM_UNITS_KERNEL_DATA_WITH_HSP  5</span>

<span class="cm">/*</span>
<span class="cm"> * Kernel data layout</span>
<span class="cm"> */</span>

<span class="cp">#define DP_SHIFT_COUNT                  7</span>

<span class="cp">#define KDATA_BASE_ADDR                 0x1000</span>
<span class="cp">#define KDATA_BASE_ADDR2                0x1080</span>

<span class="cp">#define KDATA_TASK0                     (KDATA_BASE_ADDR + 0x0000)</span>
<span class="cp">#define KDATA_TASK1                     (KDATA_BASE_ADDR + 0x0001)</span>
<span class="cp">#define KDATA_TASK2                     (KDATA_BASE_ADDR + 0x0002)</span>
<span class="cp">#define KDATA_TASK3                     (KDATA_BASE_ADDR + 0x0003)</span>
<span class="cp">#define KDATA_TASK4                     (KDATA_BASE_ADDR + 0x0004)</span>
<span class="cp">#define KDATA_TASK5                     (KDATA_BASE_ADDR + 0x0005)</span>
<span class="cp">#define KDATA_TASK6                     (KDATA_BASE_ADDR + 0x0006)</span>
<span class="cp">#define KDATA_TASK7                     (KDATA_BASE_ADDR + 0x0007)</span>
<span class="cp">#define KDATA_TASK_ENDMARK              (KDATA_BASE_ADDR + 0x0008)</span>

<span class="cp">#define KDATA_CURRENT_TASK              (KDATA_BASE_ADDR + 0x0009)</span>
<span class="cp">#define KDATA_TASK_SWITCH               (KDATA_BASE_ADDR + 0x000A)</span>

<span class="cp">#define KDATA_INSTANCE0_POS3D           (KDATA_BASE_ADDR + 0x000B)</span>
<span class="cp">#define KDATA_INSTANCE1_POS3D           (KDATA_BASE_ADDR + 0x000C)</span>
<span class="cp">#define KDATA_INSTANCE2_POS3D           (KDATA_BASE_ADDR + 0x000D)</span>
<span class="cp">#define KDATA_INSTANCE3_POS3D           (KDATA_BASE_ADDR + 0x000E)</span>
<span class="cp">#define KDATA_INSTANCE4_POS3D           (KDATA_BASE_ADDR + 0x000F)</span>
<span class="cp">#define KDATA_INSTANCE5_POS3D           (KDATA_BASE_ADDR + 0x0010)</span>
<span class="cp">#define KDATA_INSTANCE6_POS3D           (KDATA_BASE_ADDR + 0x0011)</span>
<span class="cp">#define KDATA_INSTANCE7_POS3D           (KDATA_BASE_ADDR + 0x0012)</span>
<span class="cp">#define KDATA_INSTANCE8_POS3D           (KDATA_BASE_ADDR + 0x0013)</span>
<span class="cp">#define KDATA_INSTANCE_POS3D_ENDMARK    (KDATA_BASE_ADDR + 0x0014)</span>

<span class="cp">#define KDATA_INSTANCE0_SPKVIRT         (KDATA_BASE_ADDR + 0x0015)</span>
<span class="cp">#define KDATA_INSTANCE_SPKVIRT_ENDMARK  (KDATA_BASE_ADDR + 0x0016)</span>

<span class="cp">#define KDATA_INSTANCE0_SPDIF           (KDATA_BASE_ADDR + 0x0017)</span>
<span class="cp">#define KDATA_INSTANCE_SPDIF_ENDMARK    (KDATA_BASE_ADDR + 0x0018)</span>

<span class="cp">#define KDATA_INSTANCE0_MODEM           (KDATA_BASE_ADDR + 0x0019)</span>
<span class="cp">#define KDATA_INSTANCE_MODEM_ENDMARK    (KDATA_BASE_ADDR + 0x001A)</span>

<span class="cp">#define KDATA_INSTANCE0_SRC             (KDATA_BASE_ADDR + 0x001B)</span>
<span class="cp">#define KDATA_INSTANCE1_SRC             (KDATA_BASE_ADDR + 0x001C)</span>
<span class="cp">#define KDATA_INSTANCE_SRC_ENDMARK      (KDATA_BASE_ADDR + 0x001D)</span>

<span class="cp">#define KDATA_INSTANCE0_MINISRC         (KDATA_BASE_ADDR + 0x001E)</span>
<span class="cp">#define KDATA_INSTANCE1_MINISRC         (KDATA_BASE_ADDR + 0x001F)</span>
<span class="cp">#define KDATA_INSTANCE2_MINISRC         (KDATA_BASE_ADDR + 0x0020)</span>
<span class="cp">#define KDATA_INSTANCE3_MINISRC         (KDATA_BASE_ADDR + 0x0021)</span>
<span class="cp">#define KDATA_INSTANCE_MINISRC_ENDMARK  (KDATA_BASE_ADDR + 0x0022)</span>

<span class="cp">#define KDATA_INSTANCE0_CPYTHRU         (KDATA_BASE_ADDR + 0x0023)</span>
<span class="cp">#define KDATA_INSTANCE1_CPYTHRU         (KDATA_BASE_ADDR + 0x0024)</span>
<span class="cp">#define KDATA_INSTANCE_CPYTHRU_ENDMARK  (KDATA_BASE_ADDR + 0x0025)</span>

<span class="cp">#define KDATA_CURRENT_DMA               (KDATA_BASE_ADDR + 0x0026)</span>
<span class="cp">#define KDATA_DMA_SWITCH                (KDATA_BASE_ADDR + 0x0027)</span>
<span class="cp">#define KDATA_DMA_ACTIVE                (KDATA_BASE_ADDR + 0x0028)</span>

<span class="cp">#define KDATA_DMA_XFER0                 (KDATA_BASE_ADDR + 0x0029)</span>
<span class="cp">#define KDATA_DMA_XFER1                 (KDATA_BASE_ADDR + 0x002A)</span>
<span class="cp">#define KDATA_DMA_XFER2                 (KDATA_BASE_ADDR + 0x002B)</span>
<span class="cp">#define KDATA_DMA_XFER3                 (KDATA_BASE_ADDR + 0x002C)</span>
<span class="cp">#define KDATA_DMA_XFER4                 (KDATA_BASE_ADDR + 0x002D)</span>
<span class="cp">#define KDATA_DMA_XFER5                 (KDATA_BASE_ADDR + 0x002E)</span>
<span class="cp">#define KDATA_DMA_XFER6                 (KDATA_BASE_ADDR + 0x002F)</span>
<span class="cp">#define KDATA_DMA_XFER7                 (KDATA_BASE_ADDR + 0x0030)</span>
<span class="cp">#define KDATA_DMA_XFER8                 (KDATA_BASE_ADDR + 0x0031)</span>
<span class="cp">#define KDATA_DMA_XFER_ENDMARK          (KDATA_BASE_ADDR + 0x0032)</span>

<span class="cp">#define KDATA_I2S_SAMPLE_COUNT          (KDATA_BASE_ADDR + 0x0033)</span>
<span class="cp">#define KDATA_I2S_INT_METER             (KDATA_BASE_ADDR + 0x0034)</span>
<span class="cp">#define KDATA_I2S_ACTIVE                (KDATA_BASE_ADDR + 0x0035)</span>

<span class="cp">#define KDATA_TIMER_COUNT_RELOAD        (KDATA_BASE_ADDR + 0x0036)</span>
<span class="cp">#define KDATA_TIMER_COUNT_CURRENT       (KDATA_BASE_ADDR + 0x0037)</span>

<span class="cp">#define KDATA_HALT_SYNCH_CLIENT         (KDATA_BASE_ADDR + 0x0038)</span>
<span class="cp">#define KDATA_HALT_SYNCH_DMA            (KDATA_BASE_ADDR + 0x0039)</span>
<span class="cp">#define KDATA_HALT_ACKNOWLEDGE          (KDATA_BASE_ADDR + 0x003A)</span>

<span class="cp">#define KDATA_ADC1_XFER0                (KDATA_BASE_ADDR + 0x003B)</span>
<span class="cp">#define KDATA_ADC1_XFER_ENDMARK         (KDATA_BASE_ADDR + 0x003C)</span>
<span class="cp">#define KDATA_ADC1_LEFT_VOLUME			(KDATA_BASE_ADDR + 0x003D)</span>
<span class="cp">#define KDATA_ADC1_RIGHT_VOLUME  		(KDATA_BASE_ADDR + 0x003E)</span>
<span class="cp">#define KDATA_ADC1_LEFT_SUR_VOL			(KDATA_BASE_ADDR + 0x003F)</span>
<span class="cp">#define KDATA_ADC1_RIGHT_SUR_VOL		(KDATA_BASE_ADDR + 0x0040)</span>

<span class="cp">#define KDATA_ADC2_XFER0                (KDATA_BASE_ADDR + 0x0041)</span>
<span class="cp">#define KDATA_ADC2_XFER_ENDMARK         (KDATA_BASE_ADDR + 0x0042)</span>
<span class="cp">#define KDATA_ADC2_LEFT_VOLUME			(KDATA_BASE_ADDR + 0x0043)</span>
<span class="cp">#define KDATA_ADC2_RIGHT_VOLUME			(KDATA_BASE_ADDR + 0x0044)</span>
<span class="cp">#define KDATA_ADC2_LEFT_SUR_VOL			(KDATA_BASE_ADDR + 0x0045)</span>
<span class="cp">#define KDATA_ADC2_RIGHT_SUR_VOL		(KDATA_BASE_ADDR + 0x0046)</span>

<span class="cp">#define KDATA_CD_XFER0					(KDATA_BASE_ADDR + 0x0047)					</span>
<span class="cp">#define KDATA_CD_XFER_ENDMARK			(KDATA_BASE_ADDR + 0x0048)</span>
<span class="cp">#define KDATA_CD_LEFT_VOLUME			(KDATA_BASE_ADDR + 0x0049)</span>
<span class="cp">#define KDATA_CD_RIGHT_VOLUME			(KDATA_BASE_ADDR + 0x004A)</span>
<span class="cp">#define KDATA_CD_LEFT_SUR_VOL			(KDATA_BASE_ADDR + 0x004B)</span>
<span class="cp">#define KDATA_CD_RIGHT_SUR_VOL			(KDATA_BASE_ADDR + 0x004C)</span>

<span class="cp">#define KDATA_MIC_XFER0					(KDATA_BASE_ADDR + 0x004D)</span>
<span class="cp">#define KDATA_MIC_XFER_ENDMARK			(KDATA_BASE_ADDR + 0x004E)</span>
<span class="cp">#define KDATA_MIC_VOLUME				(KDATA_BASE_ADDR + 0x004F)</span>
<span class="cp">#define KDATA_MIC_SUR_VOL				(KDATA_BASE_ADDR + 0x0050)</span>

<span class="cp">#define KDATA_I2S_XFER0                 (KDATA_BASE_ADDR + 0x0051)</span>
<span class="cp">#define KDATA_I2S_XFER_ENDMARK          (KDATA_BASE_ADDR + 0x0052)</span>

<span class="cp">#define KDATA_CHI_XFER0                 (KDATA_BASE_ADDR + 0x0053)</span>
<span class="cp">#define KDATA_CHI_XFER_ENDMARK          (KDATA_BASE_ADDR + 0x0054)</span>

<span class="cp">#define KDATA_SPDIF_XFER                (KDATA_BASE_ADDR + 0x0055)</span>
<span class="cp">#define KDATA_SPDIF_CURRENT_FRAME       (KDATA_BASE_ADDR + 0x0056)</span>
<span class="cp">#define KDATA_SPDIF_FRAME0              (KDATA_BASE_ADDR + 0x0057)</span>
<span class="cp">#define KDATA_SPDIF_FRAME1              (KDATA_BASE_ADDR + 0x0058)</span>
<span class="cp">#define KDATA_SPDIF_FRAME2              (KDATA_BASE_ADDR + 0x0059)</span>

<span class="cp">#define KDATA_SPDIF_REQUEST             (KDATA_BASE_ADDR + 0x005A)</span>
<span class="cp">#define KDATA_SPDIF_TEMP                (KDATA_BASE_ADDR + 0x005B)</span>

<span class="cp">#define KDATA_SPDIFIN_XFER0             (KDATA_BASE_ADDR + 0x005C)</span>
<span class="cp">#define KDATA_SPDIFIN_XFER_ENDMARK      (KDATA_BASE_ADDR + 0x005D)</span>
<span class="cp">#define KDATA_SPDIFIN_INT_METER         (KDATA_BASE_ADDR + 0x005E)</span>

<span class="cp">#define KDATA_DSP_RESET_COUNT           (KDATA_BASE_ADDR + 0x005F)</span>
<span class="cp">#define KDATA_DEBUG_OUTPUT              (KDATA_BASE_ADDR + 0x0060)</span>

<span class="cp">#define KDATA_KERNEL_ISR_LIST           (KDATA_BASE_ADDR + 0x0061)</span>

<span class="cp">#define KDATA_KERNEL_ISR_CBSR1          (KDATA_BASE_ADDR + 0x0062)</span>
<span class="cp">#define KDATA_KERNEL_ISR_CBER1          (KDATA_BASE_ADDR + 0x0063)</span>
<span class="cp">#define KDATA_KERNEL_ISR_CBCR           (KDATA_BASE_ADDR + 0x0064)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR0            (KDATA_BASE_ADDR + 0x0065)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR1            (KDATA_BASE_ADDR + 0x0066)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR2            (KDATA_BASE_ADDR + 0x0067)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR3            (KDATA_BASE_ADDR + 0x0068)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR4            (KDATA_BASE_ADDR + 0x0069)</span>
<span class="cp">#define KDATA_KERNEL_ISR_AR5            (KDATA_BASE_ADDR + 0x006A)</span>
<span class="cp">#define KDATA_KERNEL_ISR_BRCR           (KDATA_BASE_ADDR + 0x006B)</span>
<span class="cp">#define KDATA_KERNEL_ISR_PASR           (KDATA_BASE_ADDR + 0x006C)</span>
<span class="cp">#define KDATA_KERNEL_ISR_PAER           (KDATA_BASE_ADDR + 0x006D)</span>

<span class="cp">#define KDATA_CLIENT_SCRATCH0           (KDATA_BASE_ADDR + 0x006E)</span>
<span class="cp">#define KDATA_CLIENT_SCRATCH1           (KDATA_BASE_ADDR + 0x006F)</span>
<span class="cp">#define KDATA_KERNEL_SCRATCH            (KDATA_BASE_ADDR + 0x0070)</span>
<span class="cp">#define KDATA_KERNEL_ISR_SCRATCH        (KDATA_BASE_ADDR + 0x0071)</span>

<span class="cp">#define KDATA_OUEUE_LEFT                (KDATA_BASE_ADDR + 0x0072)</span>
<span class="cp">#define KDATA_QUEUE_RIGHT               (KDATA_BASE_ADDR + 0x0073)</span>

<span class="cp">#define KDATA_ADC1_REQUEST              (KDATA_BASE_ADDR + 0x0074)</span>
<span class="cp">#define KDATA_ADC2_REQUEST              (KDATA_BASE_ADDR + 0x0075)</span>
<span class="cp">#define KDATA_CD_REQUEST				(KDATA_BASE_ADDR + 0x0076)</span>
<span class="cp">#define KDATA_MIC_REQUEST				(KDATA_BASE_ADDR + 0x0077)</span>

<span class="cp">#define KDATA_ADC1_MIXER_REQUEST        (KDATA_BASE_ADDR + 0x0078)</span>
<span class="cp">#define KDATA_ADC2_MIXER_REQUEST        (KDATA_BASE_ADDR + 0x0079)</span>
<span class="cp">#define KDATA_CD_MIXER_REQUEST			(KDATA_BASE_ADDR + 0x007A)</span>
<span class="cp">#define KDATA_MIC_MIXER_REQUEST			(KDATA_BASE_ADDR + 0x007B)</span>
<span class="cp">#define KDATA_MIC_SYNC_COUNTER			(KDATA_BASE_ADDR + 0x007C)</span>

<span class="cm">/*</span>
<span class="cm"> * second &#39;segment&#39; (?) reserved for mixer</span>
<span class="cm"> * buffers..</span>
<span class="cm"> */</span>

<span class="cp">#define KDATA_MIXER_WORD0               (KDATA_BASE_ADDR2 + 0x0000)</span>
<span class="cp">#define KDATA_MIXER_WORD1               (KDATA_BASE_ADDR2 + 0x0001)</span>
<span class="cp">#define KDATA_MIXER_WORD2               (KDATA_BASE_ADDR2 + 0x0002)</span>
<span class="cp">#define KDATA_MIXER_WORD3               (KDATA_BASE_ADDR2 + 0x0003)</span>
<span class="cp">#define KDATA_MIXER_WORD4               (KDATA_BASE_ADDR2 + 0x0004)</span>
<span class="cp">#define KDATA_MIXER_WORD5               (KDATA_BASE_ADDR2 + 0x0005)</span>
<span class="cp">#define KDATA_MIXER_WORD6               (KDATA_BASE_ADDR2 + 0x0006)</span>
<span class="cp">#define KDATA_MIXER_WORD7               (KDATA_BASE_ADDR2 + 0x0007)</span>
<span class="cp">#define KDATA_MIXER_WORD8               (KDATA_BASE_ADDR2 + 0x0008)</span>
<span class="cp">#define KDATA_MIXER_WORD9               (KDATA_BASE_ADDR2 + 0x0009)</span>
<span class="cp">#define KDATA_MIXER_WORDA               (KDATA_BASE_ADDR2 + 0x000A)</span>
<span class="cp">#define KDATA_MIXER_WORDB               (KDATA_BASE_ADDR2 + 0x000B)</span>
<span class="cp">#define KDATA_MIXER_WORDC               (KDATA_BASE_ADDR2 + 0x000C)</span>
<span class="cp">#define KDATA_MIXER_WORDD               (KDATA_BASE_ADDR2 + 0x000D)</span>
<span class="cp">#define KDATA_MIXER_WORDE               (KDATA_BASE_ADDR2 + 0x000E)</span>
<span class="cp">#define KDATA_MIXER_WORDF               (KDATA_BASE_ADDR2 + 0x000F)</span>

<span class="cp">#define KDATA_MIXER_XFER0               (KDATA_BASE_ADDR2 + 0x0010)</span>
<span class="cp">#define KDATA_MIXER_XFER1               (KDATA_BASE_ADDR2 + 0x0011)</span>
<span class="cp">#define KDATA_MIXER_XFER2               (KDATA_BASE_ADDR2 + 0x0012)</span>
<span class="cp">#define KDATA_MIXER_XFER3               (KDATA_BASE_ADDR2 + 0x0013)</span>
<span class="cp">#define KDATA_MIXER_XFER4               (KDATA_BASE_ADDR2 + 0x0014)</span>
<span class="cp">#define KDATA_MIXER_XFER5               (KDATA_BASE_ADDR2 + 0x0015)</span>
<span class="cp">#define KDATA_MIXER_XFER6               (KDATA_BASE_ADDR2 + 0x0016)</span>
<span class="cp">#define KDATA_MIXER_XFER7               (KDATA_BASE_ADDR2 + 0x0017)</span>
<span class="cp">#define KDATA_MIXER_XFER8               (KDATA_BASE_ADDR2 + 0x0018)</span>
<span class="cp">#define KDATA_MIXER_XFER9               (KDATA_BASE_ADDR2 + 0x0019)</span>
<span class="cp">#define KDATA_MIXER_XFER_ENDMARK        (KDATA_BASE_ADDR2 + 0x001A)</span>

<span class="cp">#define KDATA_MIXER_TASK_NUMBER         (KDATA_BASE_ADDR2 + 0x001B)</span>
<span class="cp">#define KDATA_CURRENT_MIXER             (KDATA_BASE_ADDR2 + 0x001C)</span>
<span class="cp">#define KDATA_MIXER_ACTIVE              (KDATA_BASE_ADDR2 + 0x001D)</span>
<span class="cp">#define KDATA_MIXER_BANK_STATUS         (KDATA_BASE_ADDR2 + 0x001E)</span>
<span class="cp">#define KDATA_DAC_LEFT_VOLUME	        (KDATA_BASE_ADDR2 + 0x001F)</span>
<span class="cp">#define KDATA_DAC_RIGHT_VOLUME          (KDATA_BASE_ADDR2 + 0x0020)</span>

<span class="cp">#define MAX_INSTANCE_MINISRC            (KDATA_INSTANCE_MINISRC_ENDMARK - KDATA_INSTANCE0_MINISRC)</span>
<span class="cp">#define MAX_VIRTUAL_DMA_CHANNELS        (KDATA_DMA_XFER_ENDMARK - KDATA_DMA_XFER0)</span>
<span class="cp">#define MAX_VIRTUAL_MIXER_CHANNELS      (KDATA_MIXER_XFER_ENDMARK - KDATA_MIXER_XFER0)</span>
<span class="cp">#define MAX_VIRTUAL_ADC1_CHANNELS       (KDATA_ADC1_XFER_ENDMARK - KDATA_ADC1_XFER0)</span>

<span class="cm">/*</span>
<span class="cm"> * client data area offsets</span>
<span class="cm"> */</span>
<span class="cp">#define CDATA_INSTANCE_READY            0x00</span>

<span class="cp">#define CDATA_HOST_SRC_ADDRL            0x01</span>
<span class="cp">#define CDATA_HOST_SRC_ADDRH            0x02</span>
<span class="cp">#define CDATA_HOST_SRC_END_PLUS_1L      0x03</span>
<span class="cp">#define CDATA_HOST_SRC_END_PLUS_1H      0x04</span>
<span class="cp">#define CDATA_HOST_SRC_CURRENTL         0x05</span>
<span class="cp">#define CDATA_HOST_SRC_CURRENTH         0x06</span>

<span class="cp">#define CDATA_IN_BUF_CONNECT            0x07</span>
<span class="cp">#define CDATA_OUT_BUF_CONNECT           0x08</span>

<span class="cp">#define CDATA_IN_BUF_BEGIN              0x09</span>
<span class="cp">#define CDATA_IN_BUF_END_PLUS_1         0x0A</span>
<span class="cp">#define CDATA_IN_BUF_HEAD               0x0B</span>
<span class="cp">#define CDATA_IN_BUF_TAIL               0x0C</span>
<span class="cp">#define CDATA_OUT_BUF_BEGIN             0x0D</span>
<span class="cp">#define CDATA_OUT_BUF_END_PLUS_1        0x0E</span>
<span class="cp">#define CDATA_OUT_BUF_HEAD              0x0F</span>
<span class="cp">#define CDATA_OUT_BUF_TAIL              0x10</span>

<span class="cp">#define CDATA_DMA_CONTROL               0x11</span>
<span class="cp">#define CDATA_RESERVED                  0x12</span>

<span class="cp">#define CDATA_FREQUENCY                 0x13</span>
<span class="cp">#define CDATA_LEFT_VOLUME               0x14</span>
<span class="cp">#define CDATA_RIGHT_VOLUME              0x15</span>
<span class="cp">#define CDATA_LEFT_SUR_VOL              0x16</span>
<span class="cp">#define CDATA_RIGHT_SUR_VOL             0x17</span>

<span class="cp">#define CDATA_HEADER_LEN                0x18</span>

<span class="cp">#define SRC3_DIRECTION_OFFSET           CDATA_HEADER_LEN</span>
<span class="cp">#define SRC3_MODE_OFFSET                (CDATA_HEADER_LEN + 1)</span>
<span class="cp">#define SRC3_WORD_LENGTH_OFFSET         (CDATA_HEADER_LEN + 2)</span>
<span class="cp">#define SRC3_PARAMETER_OFFSET           (CDATA_HEADER_LEN + 3)</span>
<span class="cp">#define SRC3_COEFF_ADDR_OFFSET          (CDATA_HEADER_LEN + 8)</span>
<span class="cp">#define SRC3_FILTAP_ADDR_OFFSET         (CDATA_HEADER_LEN + 10)</span>
<span class="cp">#define SRC3_TEMP_INBUF_ADDR_OFFSET     (CDATA_HEADER_LEN + 16)</span>
<span class="cp">#define SRC3_TEMP_OUTBUF_ADDR_OFFSET    (CDATA_HEADER_LEN + 17)</span>

<span class="cp">#define MINISRC_IN_BUFFER_SIZE   ( 0x50 * 2 )</span>
<span class="cp">#define MINISRC_OUT_BUFFER_SIZE  ( 0x50 * 2 * 2)</span>
<span class="cp">#define MINISRC_TMP_BUFFER_SIZE  ( 112 + ( MINISRC_BIQUAD_STAGE * 3 + 4 ) * 2 * 2 )</span>
<span class="cp">#define MINISRC_BIQUAD_STAGE    2</span>
<span class="cp">#define MINISRC_COEF_LOC          0x175</span>

<span class="cp">#define DMACONTROL_BLOCK_MASK           0x000F</span>
<span class="cp">#define  DMAC_BLOCK0_SELECTOR           0x0000</span>
<span class="cp">#define  DMAC_BLOCK1_SELECTOR           0x0001</span>
<span class="cp">#define  DMAC_BLOCK2_SELECTOR           0x0002</span>
<span class="cp">#define  DMAC_BLOCK3_SELECTOR           0x0003</span>
<span class="cp">#define  DMAC_BLOCK4_SELECTOR           0x0004</span>
<span class="cp">#define  DMAC_BLOCK5_SELECTOR           0x0005</span>
<span class="cp">#define  DMAC_BLOCK6_SELECTOR           0x0006</span>
<span class="cp">#define  DMAC_BLOCK7_SELECTOR           0x0007</span>
<span class="cp">#define  DMAC_BLOCK8_SELECTOR           0x0008</span>
<span class="cp">#define  DMAC_BLOCK9_SELECTOR           0x0009</span>
<span class="cp">#define  DMAC_BLOCKA_SELECTOR           0x000A</span>
<span class="cp">#define  DMAC_BLOCKB_SELECTOR           0x000B</span>
<span class="cp">#define  DMAC_BLOCKC_SELECTOR           0x000C</span>
<span class="cp">#define  DMAC_BLOCKD_SELECTOR           0x000D</span>
<span class="cp">#define  DMAC_BLOCKE_SELECTOR           0x000E</span>
<span class="cp">#define  DMAC_BLOCKF_SELECTOR           0x000F</span>
<span class="cp">#define DMACONTROL_PAGE_MASK            0x00F0</span>
<span class="cp">#define  DMAC_PAGE0_SELECTOR            0x0030</span>
<span class="cp">#define  DMAC_PAGE1_SELECTOR            0x0020</span>
<span class="cp">#define  DMAC_PAGE2_SELECTOR            0x0010</span>
<span class="cp">#define  DMAC_PAGE3_SELECTOR            0x0000</span>
<span class="cp">#define DMACONTROL_AUTOREPEAT           0x1000</span>
<span class="cp">#define DMACONTROL_STOPPED              0x2000</span>
<span class="cp">#define DMACONTROL_DIRECTION            0x0100</span>

<span class="cm">/*</span>
<span class="cm"> * an arbitrary volume we set the internal</span>
<span class="cm"> * volume settings to so that the ac97 volume</span>
<span class="cm"> * range is a little less insane.  0x7fff is </span>
<span class="cm"> * max.</span>
<span class="cm"> */</span>
<span class="cp">#define ARB_VOLUME ( 0x6800 )</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">m3_list</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">curlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">m3_dma</span> <span class="p">{</span>

	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">assp_instance</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">inst</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opened</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buffer_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">period_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">m3_list</span> <span class="o">*</span><span class="n">index_list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

        <span class="kt">int</span> <span class="n">in_lists</span><span class="p">;</span>
	
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

<span class="p">};</span>
    
<span class="k">struct</span> <span class="n">snd_m3</span> <span class="p">{</span>
	
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">allegro_flag</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dacs_active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timer_users</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">m3_list</span>  <span class="n">msrc_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_list</span>  <span class="n">mixer_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_list</span>  <span class="n">adc1_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_list</span>  <span class="n">dma_list</span><span class="p">;</span>

	<span class="cm">/* for storing reset state..*/</span>
	<span class="n">u8</span> <span class="n">reset_state</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">external_amp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">amp_gpio</span><span class="p">;</span>	<span class="cm">/* gpio pin #  for external amp, -1 = default */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hv_config</span><span class="p">;</span>		<span class="cm">/* hardware-volume config bits */</span>
	<span class="kt">unsigned</span> <span class="n">irda_workaround</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* avoid to touch 0x10 on GPIO_DIRECTION</span>
<span class="cm">					   (e.g. for IrDA on Dell Inspirons) */</span>
	<span class="kt">unsigned</span> <span class="n">is_omnibook</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Do HP OmniBook GPIO magic? */</span>

	<span class="cm">/* midi */</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>

	<span class="cm">/* pcm streams */</span>
	<span class="kt">int</span> <span class="n">num_substreams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">substreams</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>			<span class="cm">/* physical device path */</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_switch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_volume</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">hwvol_work</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_suspend</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">suspend_mem</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">assp_kernel_image</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">assp_minisrc_image</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * pci ids</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_m3_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO_1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2LE</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_MAESTRO3</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_MAESTRO3_1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_MAESTRO3_HW</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ESS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESS_MAESTRO3_2</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_m3_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">m3_amp_quirk_list</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x0094</span><span class="p">,</span> <span class="s">&quot;Compaq Evo N600c&quot;</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10f7</span><span class="p">,</span> <span class="mh">0x833e</span><span class="p">,</span> <span class="s">&quot;Panasonic CF-28&quot;</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10f7</span><span class="p">,</span> <span class="mh">0x833d</span><span class="p">,</span> <span class="s">&quot;Panasonic CF-72&quot;</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1033</span><span class="p">,</span> <span class="mh">0x80f1</span><span class="p">,</span> <span class="s">&quot;NEC LM800J/7&quot;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1509</span><span class="p">,</span> <span class="mh">0x1740</span><span class="p">,</span> <span class="s">&quot;LEGEND ZhaoYang 3100CF&quot;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* END */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">m3_irda_quirk_list</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00b0</span><span class="p">,</span> <span class="s">&quot;Dell Inspiron 4000&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00a4</span><span class="p">,</span> <span class="s">&quot;Dell Inspiron 8000&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00e6</span><span class="p">,</span> <span class="s">&quot;Dell Inspiron 8100&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* END */</span>
<span class="p">};</span>

<span class="cm">/* hardware volume quirks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">m3_hv_quirk_list</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Allegro chips */</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x0094</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0xB112</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0xB114</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x001C</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x001D</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x001E</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x107B</span><span class="p">,</span> <span class="mh">0x3350</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10F7</span><span class="p">,</span> <span class="mh">0x8338</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10F7</span><span class="p">,</span> <span class="mh">0x833C</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10F7</span><span class="p">,</span> <span class="mh">0x833D</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10F7</span><span class="p">,</span> <span class="mh">0x833E</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10F7</span><span class="p">,</span> <span class="mh">0x833F</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x1019</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x101A</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14FF</span><span class="p">,</span> <span class="mh">0x0F03</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14FF</span><span class="p">,</span> <span class="mh">0x0F04</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14FF</span><span class="p">,</span> <span class="mh">0x0F05</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x156D</span><span class="p">,</span> <span class="mh">0xB400</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x156D</span><span class="p">,</span> <span class="mh">0xB795</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x156D</span><span class="p">,</span> <span class="mh">0xB797</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x156D</span><span class="p">,</span> <span class="mh">0xC700</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1033</span><span class="p">,</span> <span class="mh">0x80F1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x001A</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* HP OmniBook 6100 */</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x107B</span><span class="p">,</span> <span class="mh">0x340A</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x107B</span><span class="p">,</span> <span class="mh">0x3450</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x109F</span><span class="p">,</span> <span class="mh">0x3134</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x109F</span><span class="p">,</span> <span class="mh">0x3161</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0x3280</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0x3281</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0xC002</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0xC003</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1509</span><span class="p">,</span> <span class="mh">0x1740</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1610</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1042</span><span class="p">,</span> <span class="mh">0x1042</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x107B</span><span class="p">,</span> <span class="mh">0x9500</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14FF</span><span class="p">,</span> <span class="mh">0x0F06</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1558</span><span class="p">,</span> <span class="mh">0x8586</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x161F</span><span class="p">,</span> <span class="mh">0x2011</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="cm">/* Maestro3 chips */</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x001B</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x104D</span><span class="p">,</span> <span class="mh">0x80A6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x104D</span><span class="p">,</span> <span class="mh">0x80AA</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x107B</span><span class="p">,</span> <span class="mh">0x5300</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x110A</span><span class="p">,</span> <span class="mh">0x1998</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x1015</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x101C</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x13BD</span><span class="p">,</span> <span class="mh">0x1802</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1599</span><span class="p">,</span> <span class="mh">0x0715</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x5643</span><span class="p">,</span> <span class="mh">0x5643</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0x3260</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0x3261</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x144D</span><span class="p">,</span> <span class="mh">0xC001</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* END */</span>
<span class="p">};</span>

<span class="cm">/* HP Omnibook quirks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">m3_omnibook_quirk_list</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x103c</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">),</span> <span class="cm">/* HP OmniBook 6000 */</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x103c</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">),</span> <span class="cm">/* HP OmniBook 500 */</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* END */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * lowlevel functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_m3_outw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">snd_m3_inw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_m3_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">snd_m3_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * access 16bit words to the code or data regions of the dsp&#39;s memory.</span>
<span class="cm"> * index addresses 16bit words.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">snd_m3_assp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">region</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">region</span> <span class="o">&amp;</span> <span class="n">MEMTYPE_MASK</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_TYPE</span><span class="p">);</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_INDEX</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_m3_inw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_assp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">region</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">region</span> <span class="o">&amp;</span> <span class="n">MEMTYPE_MASK</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_TYPE</span><span class="p">);</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_INDEX</span><span class="p">);</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">DSP_PORT_MEMORY_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_assp_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reset_state</span> <span class="o">=</span> <span class="n">snd_m3_inb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_PORT_CONTROL_REG_B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">REGB_STOP_CLOCK</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">snd_m3_outb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reset_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">REGB_ENABLE_RESET</span><span class="p">,</span> <span class="n">DSP_PORT_CONTROL_REG_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_assp_continue</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_m3_outb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reset_state</span> <span class="o">|</span> <span class="n">REGB_ENABLE_RESET</span><span class="p">,</span> <span class="n">DSP_PORT_CONTROL_REG_B</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This makes me sad. the maestro3 has lists</span>
<span class="cm"> * internally that must be packed.. 0 terminates,</span>
<span class="cm"> * apparently, or maybe all unused entries have</span>
<span class="cm"> * to be 0, the lists have static lengths set</span>
<span class="cm"> * by the binary code images.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_add_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">list</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">+</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">,</span>
			  <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_remove_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>  <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lastindex</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">lastindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				       <span class="n">list</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">+</span> <span class="n">lastindex</span><span class="p">);</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">list</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
				  <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">list</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">+</span> <span class="n">lastindex</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">);</span>

	<span class="n">list</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_inc_timer_users</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_users</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_users</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> 
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_TIMER_COUNT_RELOAD</span><span class="p">,</span>
			  <span class="mi">240</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_TIMER_COUNT_CURRENT</span><span class="p">,</span>
			  <span class="mi">240</span><span class="p">);</span>

	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
		    <span class="n">snd_m3_inw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_INT_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">CLKRUN_GEN_ENABLE</span><span class="p">,</span>
		    <span class="n">HOST_INT_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_dec_timer_users</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_users</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_TIMER_COUNT_RELOAD</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_TIMER_COUNT_CURRENT</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
		    <span class="n">snd_m3_inw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_INT_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CLKRUN_GEN_ENABLE</span><span class="p">,</span>
		    <span class="n">HOST_INT_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start/stop</span>
<span class="cm"> */</span>

<span class="cm">/* spinlock held! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_pcm_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span> <span class="o">||</span> <span class="o">!</span> <span class="n">subs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">snd_m3_inc_timer_users</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dacs_active</span><span class="o">++</span><span class="p">;</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_INSTANCE_READY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">KDATA_MIXER_TASK_NUMBER</span><span class="p">,</span>
				  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dacs_active</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span>:
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">KDATA_ADC1_REQUEST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_INSTANCE_READY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spinlock held! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_pcm_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span> <span class="o">||</span> <span class="o">!</span> <span class="n">subs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_INSTANCE_READY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_m3_dec_timer_users</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dacs_active</span><span class="o">--</span><span class="p">;</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">KDATA_MIXER_TASK_NUMBER</span><span class="p">,</span> 
				  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dacs_active</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span>:
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">KDATA_ADC1_REQUEST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_pcm_start</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* should return error? */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_pcm_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * setup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">snd_m3_pcm_setup1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dsp_in_size</span><span class="p">,</span> <span class="n">dsp_out_size</span><span class="p">,</span> <span class="n">dsp_in_buffer</span><span class="p">,</span> <span class="n">dsp_out_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp_in_size</span> <span class="o">=</span> <span class="n">MINISRC_IN_BUFFER_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dsp_out_size</span> <span class="o">=</span> <span class="n">MINISRC_OUT_BUFFER_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dsp_in_size</span> <span class="o">=</span> <span class="n">MINISRC_IN_BUFFER_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dsp_out_size</span> <span class="o">=</span> <span class="n">MINISRC_OUT_BUFFER_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dsp_in_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">MINISRC_TMP_BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dsp_out_buffer</span> <span class="o">=</span> <span class="n">dsp_in_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsp_in_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define LO(x) ((x) &amp; 0xffff)</span>
<span class="cp">#define HI(x) LO((x) &gt;&gt; 16)</span>

	<span class="cm">/* host dma buffer pointers */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_ADDRL</span><span class="p">,</span>
			  <span class="n">LO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_ADDRH</span><span class="p">,</span>
			  <span class="n">HI</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_END_PLUS_1L</span><span class="p">,</span>
			  <span class="n">LO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_END_PLUS_1H</span><span class="p">,</span>
			  <span class="n">HI</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_CURRENTL</span><span class="p">,</span>
			  <span class="n">LO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_CURRENTH</span><span class="p">,</span>
			  <span class="n">HI</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span><span class="p">));</span>
<span class="cp">#undef LO</span>
<span class="cp">#undef HI</span>

	<span class="cm">/* dsp buffers */</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_IN_BUF_BEGIN</span><span class="p">,</span>
			  <span class="n">dsp_in_buffer</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_IN_BUF_END_PLUS_1</span><span class="p">,</span>
			  <span class="n">dsp_in_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsp_in_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_IN_BUF_HEAD</span><span class="p">,</span>
			  <span class="n">dsp_in_buffer</span><span class="p">);</span>
    
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_IN_BUF_TAIL</span><span class="p">,</span>
			  <span class="n">dsp_in_buffer</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_OUT_BUF_BEGIN</span><span class="p">,</span>
			  <span class="n">dsp_out_buffer</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_OUT_BUF_END_PLUS_1</span><span class="p">,</span>
			  <span class="n">dsp_out_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsp_out_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_OUT_BUF_HEAD</span><span class="p">,</span>
			  <span class="n">dsp_out_buffer</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_OUT_BUF_TAIL</span><span class="p">,</span>
			  <span class="n">dsp_out_buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_pcm_setup2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * put us in the lists if we&#39;re not already there</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">in_lists</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_m3_add_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">DP_SHIFT_COUNT</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_m3_add_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">DP_SHIFT_COUNT</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_m3_add_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					      <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">DP_SHIFT_COUNT</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">in_lists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write to &#39;mono&#39; word */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
			  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* write to &#39;8bit&#39; word */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> 
			  <span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set up dac/adc rate */</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24000</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span> 
		<span class="n">freq</span><span class="o">--</span><span class="p">;</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_FREQUENCY</span><span class="p">,</span>
			  <span class="n">freq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">play_vals</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CDATA_LEFT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CDATA_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">,</span>
	<span class="cm">/* +1, +2 are stereo/16 bit */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* fraction? */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* first l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* first r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* second l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* second r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* delta l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* delta r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">},</span> <span class="cm">/* round */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">},</span> <span class="cm">/* higher bute mark */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* temp0 */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* c fraction */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* counter */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="cm">/* numin */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">50</span><span class="o">*</span><span class="mi">2</span><span class="p">},</span> <span class="cm">/* numout */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="n">MINISRC_BIQUAD_STAGE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="cm">/* numstage */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* filtertap */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="cm">/* booster */</span>
<span class="p">};</span>


<span class="cm">/* the mode passed should be already shifted and masked */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_playback_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * some per client initializers</span>
<span class="cm">	 */</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">19</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">code</span> <span class="o">+</span> <span class="n">MINISRC_COEF_LOC</span><span class="p">);</span>

	<span class="cm">/* enable or disable low pass filter? */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">22</span><span class="p">,</span>
			  <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">45000</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    
	<span class="cm">/* tell it which way dma is going? */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_DMA_CONTROL</span><span class="p">,</span>
			  <span class="n">DMACONTROL_AUTOREPEAT</span> <span class="o">+</span> <span class="n">DMAC_PAGE3_SELECTOR</span> <span class="o">+</span> <span class="n">DMAC_BLOCKF_SELECTOR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set an armload of static initializers</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">pv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">pv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    Native record driver </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rec_vals</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CDATA_LEFT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CDATA_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="p">,</span>
	<span class="cm">/* +1, +2 are stereo/16 bit */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* fraction? */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* first l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* first r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* second l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* second r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* delta l */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* delta r */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">},</span> <span class="cm">/* round */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">},</span> <span class="cm">/* higher bute mark */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* temp0 */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* c fraction */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* counter */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">50</span><span class="p">},</span><span class="cm">/* numin */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="cm">/* numout */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* numstage */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* coef */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* filtertap */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* booster */</span>
	<span class="p">{</span><span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">}</span> <span class="cm">/* skip lpf */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_capture_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * some per client initializers</span>
<span class="cm">	 */</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">SRC3_DIRECTION_OFFSET</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* tell it which way dma is going? */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_DMA_CONTROL</span><span class="p">,</span>
			  <span class="n">DMACONTROL_DIRECTION</span> <span class="o">+</span> <span class="n">DMACONTROL_AUTOREPEAT</span> <span class="o">+</span> 
			  <span class="n">DMAC_PAGE3_SELECTOR</span> <span class="o">+</span> <span class="n">DMAC_BLOCKF_SELECTOR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set an armload of static initializers</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">rv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* set buffer address */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;oh my, not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_FORMAT_U8</span> <span class="o">&amp;&amp;</span>
	    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">||</span>
	    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">snd_m3_pcm_setup1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">snd_m3_playback_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_m3_capture_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>

	<span class="n">snd_m3_pcm_setup2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get current pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">snd_m3_get_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * try and get a valid answer</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hi</span> <span class="o">=</span>  <span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				       <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_CURRENTH</span><span class="p">);</span>

		<span class="n">lo</span> <span class="o">=</span> <span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				      <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_CURRENTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">==</span> <span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
					   <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">CDATA_HOST_SRC_CURRENTH</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hi</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span>
<span class="nf">snd_m3_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_m3_get_pointer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* update pointer */</span>
<span class="cm">/* spinlock held! */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_update_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hwptr</span> <span class="o">=</span> <span class="n">snd_m3_get_pointer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>

	<span class="cm">/* try to avoid expensive modulo divisions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwptr</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">)</span>
		<span class="n">hwptr</span> <span class="o">%=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">;</span>

	<span class="n">diff</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">+</span> <span class="n">hwptr</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">)</span>
		<span class="n">diff</span> <span class="o">%=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The m3&#39;s hardware volume works by incrementing / decrementing 2 counters</span>
<span class="cm">   (without wrap around) in response to volume button presses and then</span>
<span class="cm">   generating an interrupt. The pair of counters is stored in bits 1-3 and 5-7</span>
<span class="cm">   of a byte wide register. The meaning of bits 0 and 4 is unknown. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_update_hw_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_m3</span><span class="p">,</span> <span class="n">hwvol_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Figure out which volume control button was pushed,</span>
<span class="cm">	   based on differences from the default register</span>
<span class="cm">	   values. */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">SHADOW_MIX_REG_VOICE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xee</span><span class="p">;</span>

	<span class="cm">/* Reset the volume counters to 4. Tests on the allegro integrated</span>
<span class="cm">	   into a Compaq N600C laptop, have revealed that:</span>
<span class="cm">	   1) Writing any value will result in the 2 counters being reset to</span>
<span class="cm">	      4 so writing 0x88 is not strictly necessary</span>
<span class="cm">	   2) Writing to any of the 4 involved registers will reset all 4</span>
<span class="cm">	      of them (and reading them always returns the same value for all</span>
<span class="cm">	      of them)</span>
<span class="cm">	   It could be that a maestro deviates from this, so leave the code</span>
<span class="cm">	   as is. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">SHADOW_MIX_REG_VOICE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HW_VOL_COUNTER_VOICE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">SHADOW_MIX_REG_MASTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HW_VOL_COUNTER_MASTER</span><span class="p">);</span>

	<span class="cm">/* Ignore spurious HV interrupts during suspend / resume, this avoids</span>
<span class="cm">	   mistaking them for a mute button press. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x88</span>:
		<span class="cm">/* The counters have not changed, yet we&#39;ve received a HV</span>
<span class="cm">		   interrupt. According to tests run by various people this</span>
<span class="cm">		   happens when pressing the mute button. */</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xaa</span>:
		<span class="cm">/* counters increased by 1 -&gt; volume up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x66</span>:
		<span class="cm">/* counters decreased by 1 -&gt; volume down */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1f</span><span class="p">)</span>
			<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1f00</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">+=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_update</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x88</span>:
		<span class="cm">/* The counters have not changed, yet we&#39;ve received a HV</span>
<span class="cm">		   interrupt. According to tests run by various people this</span>
<span class="cm">		   happens when pressing the mute button. */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_MUTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xaa</span>:
		<span class="cm">/* counters increased by 1 -&gt; volume up */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_VOLUMEUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x66</span>:
		<span class="cm">/* counters decreased by 1 -&gt; volume down */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_VOLUMEDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_m3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HOST_INT_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HV_INT_PENDING</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ack an assp int if its running</span>
<span class="cm">	 * and has an int pending</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ASSP_INT_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">ctl</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_B</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">STOP_ASSP_CLOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctl</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_HOST_INT_STATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">DSP2HOST_REQ_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">DSP2HOST_REQ_TIMER</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_HOST_INT_STATUS</span><span class="p">);</span>
				<span class="cm">/* update adc/dac info if it was a timer int */</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
						<span class="n">snd_m3_update_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* TODO: not supported yet */</span>
<span class="c">	if ((status &amp; MPU401_INT_PENDING) &amp;&amp; chip-&gt;rmidi)</span>
<span class="c">		snd_mpu401_uart_interrupt(irq, chip-&gt;rmidi-&gt;private_data, regs);</span>
<span class="cp">#endif</span>

	<span class="cm">/* ack ints */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HOST_INT_STATUS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_m3_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="cm">/*SNDRV_PCM_INFO_PAUSE |*/</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_m3_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="cm">/*SNDRV_PCM_INFO_PAUSE |*/</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_substream_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">__found:</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">subs</span><span class="p">;</span>

	<span class="cm">/* set list owners */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_list</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">adc1_list</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msrc_list</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_list</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_substream_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* not opened properly */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">snd_m3_pcm_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span> <span class="cm">/* does this happen? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">in_lists</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_remove_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">snd_m3_remove_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">snd_m3_remove_list</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">in_lists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_substream_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">subs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_m3_playback</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">snd_m3_substream_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_substream_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">subs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_m3_capture</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">snd_m3_substream_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create pcm instance</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_m3_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_m3_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_m3_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_m3_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_m3_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_m3_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_m3_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_m3_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			  <span class="n">MAX_PLAYBACKS</span><span class="p">,</span> <span class="n">MAX_CAPTURES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_m3_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_m3_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ac97 interface</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the ac97 serial bus to be free.</span>
<span class="cm"> * return nonzero if the bus is still busy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_ac97_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">snd_m3_inb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ac97 serial bus busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">snd_m3_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_m3_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">snd_m3_outb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">),</span> <span class="n">CODEC_COMMAND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_m3_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">snd_m3_inw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CODEC_DATA</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_m3_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">CODEC_DATA</span><span class="p">);</span>
	<span class="n">snd_m3_outb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">CODEC_COMMAND</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_remote_codec_config</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isremote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isremote</span> <span class="o">=</span> <span class="n">isremote</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">RING_BUS_CTRL_B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SECOND_CODEC_ID_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">isremote</span><span class="p">,</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">RING_BUS_CTRL_B</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">SDO_OUT_DEST_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">COMMAND_ADDR_OUT</span><span class="p">)</span> <span class="o">|</span> <span class="n">isremote</span><span class="p">,</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">SDO_OUT_DEST_CTRL</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">SDO_IN_DEST_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">STATUS_ADDR_IN</span><span class="p">)</span> <span class="o">|</span> <span class="n">isremote</span><span class="p">,</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">SDO_IN_DEST_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * hack, returns non zero on err </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_try_read_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_m3_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">snd_m3_outb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">AC97_VENDOR_ID1</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">),</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_m3_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_m3_inw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_ac97_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delay2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allegro_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * the onboard codec on the allegro seems </span>
<span class="cm">		 * to want to wait a very long time before</span>
<span class="cm">		 * coming back to life </span>
<span class="cm">		 */</span>
		<span class="n">delay1</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="n">delay2</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* maestro3 */</span>
		<span class="n">delay1</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">delay2</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irda_workaround</span><span class="p">)</span>
			<span class="n">dir</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* assuming pci bus master? */</span>

		<span class="n">snd_m3_remote_codec_config</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">IO_SRAM_ENABLE</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">RING_BUS_CTRL_A</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPO_PRIMARY_AC97</span> <span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="n">GPO_PRIMARY_AC97</span> <span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">dir</span> <span class="o">|</span> <span class="n">GPO_PRIMARY_AC97</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">);</span>

		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay1</span><span class="p">));</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">GPO_PRIMARY_AC97</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="cm">/* ok, bring back the ac-link */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">IO_SRAM_ENABLE</span> <span class="o">|</span> <span class="n">SERIAL_AC_LINK_ENABLE</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">RING_BUS_CTRL_A</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>

		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay2</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_m3_try_read_vendor</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">delay1</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">delay2</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;maestro3: retrying codec reset with delays of %d and %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">delay1</span><span class="p">,</span> <span class="n">delay2</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* more gung-ho reset that doesn&#39;t</span>
<span class="c">	 * seem to work anywhere :)</span>
<span class="c">	 */</span>
<span class="c">	tmp = inw(io + RING_BUS_CTRL_A);</span>
<span class="c">	outw(RAC_SDFS_ENABLE|LAC_SDFS_ENABLE, io + RING_BUS_CTRL_A);</span>
<span class="c">	msleep(20);</span>
<span class="c">	outw(tmp, io + RING_BUS_CTRL_A);</span>
<span class="c">	msleep(50);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_m3_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">elem_id</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_m3_ac97_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_m3_ac97_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* seems ac97 PCM needs initialization.. hack hack.. */</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elem_id</span><span class="p">));</span>
	<span class="n">elem_id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">elem_id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem_id</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elem_id</span><span class="p">));</span>
	<span class="n">elem_id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">elem_id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem_id</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * initialize ASSP</span>
<span class="cm"> */</span>

<span class="cp">#define MINISRC_LPF_LEN 10</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">minisrc_lpf</span><span class="p">[</span><span class="n">MINISRC_LPF_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="n">X0743</span><span class="p">,</span> <span class="mi">0</span><span class="n">X1104</span><span class="p">,</span> <span class="mi">0</span><span class="n">X0A4C</span><span class="p">,</span> <span class="mi">0</span><span class="n">XF88D</span><span class="p">,</span> <span class="mi">0</span><span class="n">X242C</span><span class="p">,</span>
	<span class="mi">0</span><span class="n">X1023</span><span class="p">,</span> <span class="mi">0</span><span class="n">X1AA9</span><span class="p">,</span> <span class="mi">0</span><span class="n">X0B60</span><span class="p">,</span> <span class="mi">0</span><span class="n">XEFDD</span><span class="p">,</span> <span class="mi">0</span><span class="n">X186F</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_m3_assp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* zero kernel data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">REV_B_DATA_MEMORY_UNIT_LENGTH</span> <span class="o">*</span> <span class="n">NUM_UNITS_KERNEL_DATA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span> 
				  <span class="n">KDATA_BASE_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* zero mixer data? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">REV_B_DATA_MEMORY_UNIT_LENGTH</span> <span class="o">*</span> <span class="n">NUM_UNITS_KERNEL_DATA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">KDATA_BASE_ADDR2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* init dma pointer */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_CURRENT_DMA</span><span class="p">,</span>
			  <span class="n">KDATA_DMA_XFER0</span><span class="p">);</span>

	<span class="cm">/* write kernel into code memory.. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_kernel_image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_kernel_image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span> 
				  <span class="n">REV_B_CODE_MEMORY_BEGIN</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only have this one client and we know that 0x400</span>
<span class="cm">	 * is free in our kernel&#39;s mem map, so lets just</span>
<span class="cm">	 * drop it there.  It seems that the minisrc doesn&#39;t</span>
<span class="cm">	 * need vectors, so we won&#39;t bother with them..</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_minisrc_image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_minisrc_image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span> 
				  <span class="mh">0x400</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * write the coefficients for the low pass filter?</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MINISRC_LPF_LEN</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span>
				  <span class="mh">0x400</span> <span class="o">+</span> <span class="n">MINISRC_COEF_LOC</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				  <span class="n">minisrc_lpf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span>
			  <span class="mh">0x400</span> <span class="o">+</span> <span class="n">MINISRC_COEF_LOC</span> <span class="o">+</span> <span class="n">MINISRC_LPF_LEN</span><span class="p">,</span>
			  <span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * the minisrc is the only thing on</span>
<span class="cm">	 * our task list..</span>
<span class="cm">	 */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span> 
			  <span class="n">KDATA_TASK0</span><span class="p">,</span>
			  <span class="mh">0x400</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * init the mixer number..</span>
<span class="cm">	 */</span>

	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_MIXER_TASK_NUMBER</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * EXTREME KERNEL MASTER VOLUME</span>
<span class="cm">	 */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_DAC_LEFT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">);</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
			  <span class="n">KDATA_DAC_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">ARB_VOLUME</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_list</span><span class="p">.</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_list</span><span class="p">.</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">KDATA_MIXER_XFER0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_list</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_VIRTUAL_MIXER_CHANNELS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">adc1_list</span><span class="p">.</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">adc1_list</span><span class="p">.</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">KDATA_ADC1_XFER0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">adc1_list</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_VIRTUAL_ADC1_CHANNELS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_list</span><span class="p">.</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_list</span><span class="p">.</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">KDATA_DMA_XFER0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_list</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_VIRTUAL_DMA_CHANNELS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">msrc_list</span><span class="p">.</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">msrc_list</span><span class="p">.</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">KDATA_INSTANCE0_MINISRC</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">msrc_list</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_INSTANCE_MINISRC</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_m3_assp_client_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data_bytes</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="n">MINISRC_TMP_BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> 
			       <span class="n">MINISRC_IN_BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
			       <span class="mi">1</span> <span class="o">+</span> <span class="n">MINISRC_OUT_BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the revb memory map has 0x1100 through 0x1c00</span>
<span class="cm">	 * free.  </span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * align instance address to 256 bytes so that its</span>
<span class="cm">	 * shifted list address is aligned.</span>
<span class="cm">	 * list address = (mem address &gt;&gt; 1) &gt;&gt; 7;</span>
<span class="cm">	 */</span>
	<span class="n">data_bytes</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">address</span> <span class="o">=</span> <span class="mh">0x1100</span> <span class="o">+</span> <span class="p">((</span><span class="n">data_bytes</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">data_bytes</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mh">0x1c00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;no memory for %d bytes at ind %d (addr 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">data_bytes</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">data_bytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span>
				  <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * this works for the reference board, have to find</span>
<span class="cm"> * out about others</span>
<span class="cm"> *</span>
<span class="cm"> * this needs more magic for 4 speaker, but..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_amp_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpo</span><span class="p">,</span> <span class="n">polarity</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">external_amp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">polarity</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">polarity</span> <span class="o">=</span> <span class="n">polarity</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span><span class="p">;</span>
	<span class="n">gpo</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="n">gpo</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">)</span> <span class="o">|</span> <span class="n">gpo</span><span class="p">,</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">((</span><span class="n">GPO_SECONDARY_AC97</span> <span class="o">|</span> <span class="n">GPO_PRIMARY_AC97</span> <span class="o">|</span> <span class="n">polarity</span><span class="p">),</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_hv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">GPI_VOL_DOWN</span> <span class="o">|</span> <span class="n">GPI_VOL_UP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_omnibook</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Volume buttons on some HP OmniBook laptops</span>
<span class="cm">	 * require some GPIO magic to work correctly.</span>
<span class="cm">	 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="n">val</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_DIRECTION</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">GPIO_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_m3_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">t</span><span class="p">;</span> <span class="cm">/* makes as much sense as &#39;n&#39;, no? */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_LEGACY_AUDIO_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SOUND_BLASTER_ENABLE</span><span class="o">|</span><span class="n">FM_SYNTHESIS_ENABLE</span><span class="o">|</span>
	       <span class="n">MPU401_IO_ENABLE</span><span class="o">|</span><span class="n">MPU401_IRQ_ENABLE</span><span class="o">|</span><span class="n">ALIAS_10BIT_IO</span><span class="o">|</span>
	       <span class="n">DISABLE_LEGACY</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_LEGACY_AUDIO_CTRL</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_ALLEGRO_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HV_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">REDUCED_DEBOUNCE</span> <span class="o">|</span> <span class="n">HV_BUTTON_FROM_GD</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">hv_config</span><span class="p">;</span>
	<span class="cm">/* For some reason we must always use reduced debounce. */</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="n">REDUCED_DEBOUNCE</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="n">PM_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">CLK_DIV_BY_49</span> <span class="o">|</span> <span class="n">USE_PCI_TIMING</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_ALLEGRO_CONFIG</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">RESET_ASSP</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_B</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_ALLEGRO_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_CLK_SELECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allegro_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_CLK_MULT_ENABLE</span><span class="p">;</span> 
		<span class="n">n</span> <span class="o">|=</span> <span class="n">INT_CLK_SRC_NOT_PCI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span> <span class="n">CLK_MULT_MODE_SELECT</span> <span class="o">|</span> <span class="n">CLK_MULT_MODE_SELECT_2</span> <span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_ALLEGRO_CONFIG</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allegro_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_USER_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">|=</span> <span class="n">IN_CLK_12MHZ_SELECT</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_USER_CONFIG</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_A</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span> <span class="n">DSP_CLK_36MHZ_SELECT</span>  <span class="o">|</span> <span class="n">ASSP_CLK_49MHZ_SELECT</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">|=</span> <span class="n">ASSP_CLK_49MHZ_SELECT</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">|=</span> <span class="n">ASSP_0_WS_ENABLE</span><span class="p">;</span> 
	<span class="n">outb</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_A</span><span class="p">);</span>

	<span class="n">snd_m3_assp_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span> <span class="cm">/* download DSP code before starting ASSP below */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RUN_ASSP</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_B</span><span class="p">);</span> 

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">HARDWARE_VOL_CTRL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">SHADOW_MIX_REG_VOICE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">HW_VOL_COUNTER_VOICE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">SHADOW_MIX_REG_MASTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">HW_VOL_COUNTER_MASTER</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_m3_enable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* TODO: MPU401 not supported yet */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ASSP_INT_ENABLE</span> <span class="cm">/*| MPU401_INT_ENABLE*/</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hv_config</span> <span class="o">&amp;</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HV_INT_ENABLE</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HOST_INT_STATUS</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">HOST_INT_CTRL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_C</span><span class="p">)</span> <span class="o">|</span> <span class="n">ASSP_HOST_INT_ENABLE</span><span class="p">,</span>
	     <span class="n">io</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_C</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* check surviving pcms; this should not happen though.. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
				<span class="n">snd_m3_pcm_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HOST_INT_CTRL</span><span class="p">);</span> <span class="cm">/* disable ints */</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_kernel_image</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_minisrc_image</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * APM support</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m3_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* give the assp a chance to idle.. */</span>

	<span class="n">snd_m3_assp_halt</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* save dsp image */</span>
	<span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">REV_B_CODE_MEMORY_BEGIN</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">REV_B_CODE_MEMORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span><span class="p">[</span><span class="n">dsp_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">REV_B_DATA_MEMORY_BEGIN</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">REV_B_DATA_MEMORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span><span class="p">[</span><span class="n">dsp_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">snd_m3_assp_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m3_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maestor3: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* first lets just bring everything back. .*/</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
	<span class="n">snd_m3_outw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">);</span>

	<span class="n">snd_m3_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_assp_halt</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_ac97_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* restore dsp image */</span>
	<span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">REV_B_CODE_MEMORY_BEGIN</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">REV_B_CODE_MEMORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_CODE</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> 
				  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span><span class="p">[</span><span class="n">dsp_index</span><span class="o">++</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">REV_B_DATA_MEMORY_BEGIN</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">REV_B_DATA_MEMORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> 
				  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span><span class="p">[</span><span class="n">dsp_index</span><span class="o">++</span><span class="p">]);</span>

	<span class="cm">/* tell the dma engine to restart itself */</span>
	<span class="n">snd_m3_assp_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MEMTYPE_INTERNAL_DATA</span><span class="p">,</span> 
			  <span class="n">KDATA_DMA_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="cm">/* restore ac97 registers */</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">snd_m3_assp_continue</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_enable_ints</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_amp_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_m3_hv_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SND_MAESTRO3_INPUT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_m3_input_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;pci-%s/input0&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_INPUT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_m3_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_m3_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">enable_amp</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">amp_gpio</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">**</span><span class="n">chip_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">quirk</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_m3_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">chip_ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* check, if we can restrict PCI DMA transfers to 28 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support 28bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2LE</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">allegro_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">,</span> <span class="n">snd_m3_update_hw_volume</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">external_amp</span> <span class="o">=</span> <span class="n">enable_amp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amp_gpio</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">amp_gpio</span> <span class="o">&lt;=</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span> <span class="o">=</span> <span class="n">amp_gpio</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">quirk</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">m3_amp_quirk_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quirk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;maestro3: set amp-gpio &quot;</span>
				    <span class="s">&quot;for &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span> <span class="o">=</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allegro_flag</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span> <span class="o">=</span> <span class="n">GPO_EXT_AMP_ALLEGRO</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* presumably this is for all &#39;maestro3&#39;s.. */</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amp_gpio</span> <span class="o">=</span> <span class="n">GPO_EXT_AMP_M3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">quirk</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">m3_irda_quirk_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;maestro3: enabled irda workaround &quot;</span>
			    <span class="s">&quot;for &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irda_workaround</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">quirk</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">m3_hv_quirk_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirk</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hv_config</span> <span class="o">=</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">m3_omnibook_quirk_list</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_omnibook</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span> <span class="o">=</span> <span class="n">NR_DSPS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m3_dma</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_kernel_image</span><span class="p">,</span>
			       <span class="s">&quot;ess/maestro3_assp_kernel.fw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">assp_minisrc_image</span><span class="p">,</span>
			       <span class="s">&quot;ess/maestro3_assp_minisrc.fw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="cm">/* just to be sure */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_m3_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_assp_halt</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_m3_ac97_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_m3_amp_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_m3_hv_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_m3_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">REV_B_CODE_MEMORY_LENGTH</span> <span class="o">+</span> <span class="n">REV_B_DATA_MEMORY_LENGTH</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;can&#39;t allocate apm buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_m3_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_substreams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">m3_dma</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substreams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_assp_client_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_MAESTRO3_INPUT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hv_config</span> <span class="o">&amp;</span> <span class="n">HV_CTRL_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_input_register</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Input device registration &quot;</span>
				<span class="s">&quot;failed with error %i&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">snd_m3_enable_ints</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_m3_assp_continue</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">chip_ret</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_m3_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_m3</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* don&#39;t pick up modems */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_ALLEGRO_1</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Allegro&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2LE</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ESS_CANYON3D_2</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Canyon3D-2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Maestro3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_m3_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span>
				 <span class="n">external_amp</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				 <span class="n">amp_gpio</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				 <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ESS %s PCI&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* TODO: not supported yet */</span>
<span class="c">	/* TODO enable MIDI IRQ and I/O */</span>
<span class="c">	err = snd_mpu401_uart_new(chip-&gt;card, 0, MPU401_HW_MPU401,</span>
<span class="c">				  chip-&gt;iobase + MPU401_DATA_PORT,</span>
<span class="c">				  MPU401_INFO_INTEGRATED | MPU401_INFO_IRQ_HOOK,</span>
<span class="c">				  -1, &amp;chip-&gt;rmidi);</span>
<span class="c">	if (err &lt; 0)</span>
<span class="c">		printk(KERN_WARNING &quot;maestro3: no MIDI support.\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_m3_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">m3_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_m3_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_m3_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_m3_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">m3_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">m3_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
	
<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">m3_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
