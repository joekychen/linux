<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › asihpi › hpicmn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hpicmn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">    AudioScience HPI driver</span>
<span class="cm">    Copyright (C) 1997-2011  AudioScience Inc. &lt;support@audioscience.com&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">    published by the Free Software Foundation;</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">\file hpicmn.c</span>

<span class="cm"> Common functions used by hpixxxx.c modules</span>

<span class="cm">(C) Copyright AudioScience Inc. 1998-2003</span>
<span class="cm">*******************************************************************************/</span>
<span class="cp">#define SOURCEFILE_NAME &quot;hpicmn.c&quot;</span>

<span class="cp">#include &quot;hpi_internal.h&quot;</span>
<span class="cp">#include &quot;hpidebug.h&quot;</span>
<span class="cp">#include &quot;hpimsginit.h&quot;</span>

<span class="cp">#include &quot;hpicmn.h&quot;</span>

<span class="k">struct</span> <span class="n">hpi_adapters_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpios_spinlock</span> <span class="n">list_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="n">adapter</span><span class="p">[</span><span class="n">HPI_MAX_ADAPTERS</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">gw_num_adapters</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hpi_adapters_list</span> <span class="n">adapters</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">* Given an HPI Message that was sent out and a response that was received,</span>
<span class="cm">* validate that the response has the correct fields filled in,</span>
<span class="cm">* i.e ObjectType, Function etc</span>
<span class="cm">**/</span>
<span class="n">u16</span> <span class="nf">hpi_validate_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">HPI_TYPE_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;header type %d invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_INVALID_RESPONSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">!=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;header object %d invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_INVALID_RESPONSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;header function %d invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_INVALID_RESPONSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">hpi_add_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*HPI_ASSERT(pao-&gt;type); */</span>

	<span class="n">hpios_alistlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">HPI_MAX_ADAPTERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">HPI_ERROR_BAD_ADAPTER_NUMBER</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">HPI_MAX_ADAPTERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">,</span>
					<span class="s">&quot;ASI%X duplicate index %d moved to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
				<span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">HPI_ERROR_DUPLICATE_ADAPTER_NUMBER</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pao</span><span class="p">;</span>
	<span class="n">hpios_dsplock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">adapters</span><span class="p">.</span><span class="n">gw_num_adapters</span><span class="o">++</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hpios_alistlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hpi_delete_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;removing null adapter?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpios_alistlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
		<span class="n">adapters</span><span class="p">.</span><span class="n">gw_num_adapters</span><span class="o">--</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">hpios_alistlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* FindAdapter returns a pointer to the struct hpi_adapter_obj with</span>
<span class="cm">* index wAdapterIndex in an HPI_ADAPTERS_LIST structure.</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="nf">hpi_find_adapter</span><span class="p">(</span><span class="n">u16</span> <span class="n">adapter_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_index</span> <span class="o">&gt;=</span> <span class="n">HPI_MAX_ADAPTERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;find_adapter invalid index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pao</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter_index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   HPI_DEBUG_LOG(VERBOSE, &quot;Found adapter index %d\n&quot;,</span>
<span class="cm">		   wAdapterIndex);</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">pao</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   HPI_DEBUG_LOG(VERBOSE, &quot;No adapter index %d\n&quot;,</span>
<span class="cm">		   wAdapterIndex);</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">*</span>
<span class="cm">* wipe an HPI_ADAPTERS_LIST structure.</span>
<span class="cm">*</span>
<span class="cm">**/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wipe_adapter_list</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapters</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_get_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* find the nCount&#39;th nonzero adapter in array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">HPI_MAX_ADAPTERS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">HPI_MAX_ADAPTERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_index</span> <span class="o">=</span> <span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">adapters</span><span class="p">.</span><span class="n">adapter</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OBJ_INDEX</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">control_cache_alloc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">pC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">control_count</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">cache_size_in_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p_master_cache</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p_master_cache</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">;</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;check %d controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">control_count</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hpi_control_cache_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache_info</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">p_master_cache</span><span class="p">[</span><span class="n">byte_count</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size_in32bit_words</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span>
						<span class="s">&quot;adap %d cache not ready?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">pC</span><span class="o">-&gt;</span><span class="n">adap_idx</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* The cache is invalid.</span>
<span class="cm">				 * Minimum valid entry size is</span>
<span class="cm">				 * sizeof(struct hpi_control_cache_info)</span>
<span class="cm">				 */</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
					<span class="s">&quot;adap %d zero size cache entry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pC</span><span class="o">-&gt;</span><span class="n">adap_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
				<span class="n">cached</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* dummy cache entry */</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size_in32bit_words</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
				<span class="s">&quot;cached %d, pinfo %p index %d type %d size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cached</span><span class="p">,</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control_index</span><span class="p">],</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">control_index</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">size_in32bit_words</span><span class="p">);</span>

			<span class="cm">/* quit loop early if whole cache has been scanned.</span>
<span class="cm">			 * dwControlCount is the maximum possible entries</span>
<span class="cm">			 * but some may be absent from the cache</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">cache_size_in_bytes</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* have seen last control index */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control_index</span> <span class="o">==</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">control_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">!=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">cache_size_in_bytes</span><span class="p">)</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">,</span>
				<span class="s">&quot;adap %d bytecount %d != cache size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">adap_idx</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">cache_size_in_bytes</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span>
				<span class="s">&quot;adap %d cache good, bytecount == cache size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">adap_idx</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cached</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Find a control.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">short</span> <span class="nf">find_control</span><span class="p">(</span><span class="n">u16</span> <span class="n">control_index</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_control_cache_info</span> <span class="o">**</span><span class="n">pI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">control_cache_alloc_check</span><span class="p">(</span><span class="n">p_cache</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;control_cache_alloc_check() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">control_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pI</span> <span class="o">=</span> <span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">[</span><span class="n">control_index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">pI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Uncached Control %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">control_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;find_control() type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pI</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allow unified treatment of several string fields within struct */</span>
<span class="cp">#define HPICMN_PAD_OFS_AND_SIZE(m)  {\</span>
<span class="cp">	offsetof(struct hpi_control_cache_pad, m), \</span>
<span class="cp">	sizeof(((struct hpi_control_cache_pad *)(NULL))-&gt;m) }</span>

<span class="k">struct</span> <span class="n">pad_ofs_size</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pad_ofs_size</span> <span class="n">pad_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HPICMN_PAD_OFS_AND_SIZE</span><span class="p">(</span><span class="n">c_channel</span><span class="p">),</span>	<span class="cm">/* HPI_PAD_CHANNEL_NAME */</span>
	<span class="n">HPICMN_PAD_OFS_AND_SIZE</span><span class="p">(</span><span class="n">c_artist</span><span class="p">),</span>	<span class="cm">/* HPI_PAD_ARTIST */</span>
	<span class="n">HPICMN_PAD_OFS_AND_SIZE</span><span class="p">(</span><span class="n">c_title</span><span class="p">),</span>	<span class="cm">/* HPI_PAD_TITLE */</span>
	<span class="n">HPICMN_PAD_OFS_AND_SIZE</span><span class="p">(</span><span class="n">c_comment</span><span class="p">),</span>	<span class="cm">/* HPI_PAD_COMMENT */</span>
<span class="p">};</span>

<span class="cm">/** CheckControlCache checks the cache and fills the struct hpi_response</span>
<span class="cm"> * accordingly. It returns one if a cache hit occurred, zero otherwise.</span>
<span class="cm"> */</span>
<span class="kt">short</span> <span class="nf">hpi_check_control_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache_info</span> <span class="o">*</span><span class="n">pI</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache_single</span> <span class="o">*</span><span class="n">pC</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">response_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find_control</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">,</span> <span class="n">p_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;HPICMN find_control() failed for adap %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set the default response size */</span>
	<span class="n">response_size</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_res</span><span class="p">);</span>

	<span class="cm">/* pC is the default cached control strucure. May be cast to</span>
<span class="cm">	   something else in the following switch statement.</span>
<span class="cm">	 */</span>
	<span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache_single</span> <span class="o">*</span><span class="p">)</span><span class="n">pI</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pI</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">HPI_CONTROL_METER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_METER_PEAK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">meter</span><span class="p">.</span><span class="n">an_log_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">meter</span><span class="p">.</span><span class="n">an_log_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_METER_RMS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">meter</span><span class="p">.</span><span class="n">an_logRMS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
				<span class="n">HPI_CACHE_INVALID_SHORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_METER_MINIMUM</span><span class="p">;</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_METER_MINIMUM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">meter</span><span class="p">.</span><span class="n">an_logRMS</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">meter</span><span class="p">.</span><span class="n">an_logRMS</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_VOLUME_GAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_VOLUME_MUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPI_VOLUME_FLAG_HAS_MUTE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPI_VOLUME_FLAG_MUTED</span><span class="p">)</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span>
						<span class="n">HPI_BITMASK_ALL_CHANNELS</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_MULTIPLEXER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_MULTIPLEXER_SOURCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mux</span><span class="p">.</span><span class="n">source_node_type</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mux</span><span class="p">.</span><span class="n">source_node_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_CHANNEL_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_CHANNEL_MODE_MODE</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_LEVEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_LEVEL_GAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_TUNER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_TUNER_FREQ</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">freq_ink_hz</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_TUNER_BAND</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">band</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_TUNER_LEVEL_AVG</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">s_level_avg</span> <span class="o">==</span>
				<span class="n">HPI_CACHE_INVALID_SHORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">s_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">s_level</span> <span class="o">=</span>
					<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tuner</span><span class="p">.</span><span class="n">s_level_avg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_AESEBU_RECEIVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_AESEBURX_ERRORSTATUS</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes3rx</span><span class="p">.</span><span class="n">error_status</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_AESEBURX_FORMAT</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes3rx</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_AESEBU_TRANSMITTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_AESEBUTX_FORMAT</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes3tx</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_TONEDETECTOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_TONEDETECTOR_STATE</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tone</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_SILENCEDETECTOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SILENCEDETECTOR_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">silence</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_MICROPHONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_MICROPHONE_PHANTOM_POWER</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">microphone</span><span class="p">.</span><span class="n">phantom_state</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_SAMPLECLOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SOURCE</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">source</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SOURCE_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">source_index</span> <span class="o">==</span>
				<span class="n">HPI_CACHE_INVALID_UINT16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">source_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SAMPLERATE</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_PAD</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">hpi_control_cache_pad</span> <span class="o">*</span><span class="n">p_pad</span><span class="p">;</span>
			<span class="n">p_pad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache_pad</span> <span class="o">*</span><span class="p">)</span><span class="n">pI</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_pad</span><span class="o">-&gt;</span><span class="n">field_valid_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
						<span class="n">HPI_CTL_ATTR_INDEX</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span>
							<span class="n">attribute</span><span class="p">))))</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_PAD_PROGRAM_ID</span><span class="p">)</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">p_pad</span><span class="o">-&gt;</span><span class="n">pI</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_PAD_PROGRAM_TYPE</span><span class="p">)</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">p_pad</span><span class="o">-&gt;</span><span class="n">pTY</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span>
					<span class="n">HPI_CTL_ATTR_INDEX</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span>
					<span class="n">attribute</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad_string_len</span><span class="p">,</span> <span class="n">field_size</span><span class="p">;</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">pad_string</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tocopy</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pad_desc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
						<span class="n">HPI_ERROR_INVALID_CONTROL_ATTRIBUTE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">pad_string</span> <span class="o">=</span>
					<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p_pad</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">pad_desc</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
				<span class="n">field_size</span> <span class="o">=</span> <span class="n">pad_desc</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">field_size</span><span class="p">;</span>
				<span class="cm">/* Ensure null terminator */</span>
				<span class="n">pad_string</span><span class="p">[</span><span class="n">field_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">pad_string_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pad_string</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">pad_string_len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
						<span class="n">HPI_ERROR_INVALID_CONTROL_VALUE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">tocopy</span> <span class="o">=</span> <span class="n">pad_string_len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tocopy</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">chars8</span><span class="p">.</span><span class="n">sz_data</span><span class="p">))</span>
					<span class="n">tocopy</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">chars8</span><span class="p">.</span>
						<span class="n">sz_data</span><span class="p">);</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">chars8</span><span class="p">.</span><span class="n">sz_data</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pad_string</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">tocopy</span><span class="p">);</span>

				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cu</span><span class="p">.</span><span class="n">chars8</span><span class="p">.</span><span class="n">remaining_chars</span> <span class="o">=</span>
					<span class="n">pad_string_len</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">tocopy</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;%s Adap %d, Ctl %d, Type %d, Attr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">found</span> <span class="o">?</span> <span class="s">&quot;Cached&quot;</span> <span class="o">:</span> <span class="s">&quot;Uncached&quot;</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">,</span>
		<span class="n">pI</span><span class="o">-&gt;</span><span class="n">control_index</span><span class="p">,</span> <span class="n">pI</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">response_size</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">HPI_TYPE_RESPONSE</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Updates the cache with Set values.</span>

<span class="cm">Only update if no error.</span>
<span class="cm">Volume and Level return the limited values in the response, so use these</span>
<span class="cm">Multiplexer does so use sent values</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">hpi_cmn_control_cache_sync_to_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache_single</span> <span class="o">*</span><span class="n">pC</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache_info</span> <span class="o">*</span><span class="n">pI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find_control</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">,</span> <span class="n">p_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;HPICMN find_control() failed for adap %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pC is the default cached control strucure.</span>
<span class="cm">	   May be cast to something else in the following switch statement.</span>
<span class="cm">	 */</span>
	<span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache_single</span> <span class="o">*</span><span class="p">)</span><span class="n">pI</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pI</span><span class="o">-&gt;</span><span class="n">control_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_VOLUME_GAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_VOLUME_MUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">)</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HPI_VOLUME_FLAG_MUTED</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPI_VOLUME_FLAG_MUTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_MULTIPLEXER</span>:
		<span class="cm">/* mux does not return its setting on Set command. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_MULTIPLEXER_SOURCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mux</span><span class="p">.</span><span class="n">source_node_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mux</span><span class="p">.</span><span class="n">source_node_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_CHANNEL_MODE</span>:
		<span class="cm">/* mode does not return its setting on Set command. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_CHANNEL_MODE_MODE</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_LEVEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_LEVEL_GAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">an_log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">an_log_value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_MICROPHONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_MICROPHONE_PHANTOM_POWER</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">microphone</span><span class="p">.</span><span class="n">phantom_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_AESEBU_TRANSMITTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_AESEBUTX_FORMAT</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes3tx</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_AESEBU_RECEIVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_AESEBURX_FORMAT</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aes3rx</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_SAMPLECLOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SOURCE</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SOURCE_INDEX</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">source_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_SAMPLECLOCK_SAMPLERATE</span><span class="p">)</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">clk</span><span class="p">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/** Allocate control cache.</span>

<span class="cm">\return Cache pointer, or NULL if allocation fails.</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="nf">hpi_alloc_control_cache</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">control_count</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p_dsp_control_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_cache</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">control_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_cache</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">cache_size_in_bytes</span> <span class="o">=</span> <span class="n">size_in_bytes</span><span class="p">;</span>
	<span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">control_count</span> <span class="o">=</span> <span class="n">control_count</span><span class="p">;</span>
	<span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_cache</span> <span class="o">=</span> <span class="n">p_dsp_control_buffer</span><span class="p">;</span>
	<span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p_cache</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hpi_free_control_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">p_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_cache</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_SUBSYSTEM</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_OPEN</span>:
	<span class="k">case</span> <span class="n">HPI_SUBSYS_CLOSE</span>:
	<span class="k">case</span> <span class="n">HPI_SUBSYS_DRIVER_UNLOAD</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_DRIVER_LOAD</span>:
		<span class="n">wipe_adapter_list</span><span class="p">();</span>
		<span class="n">hpios_alistlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_GET_ADAPTER</span>:
		<span class="n">subsys_get_adapter</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_GET_NUM_ADAPTERS</span>:
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="n">adapters</span><span class="p">.</span><span class="n">gw_num_adapters</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_CREATE_ADAPTER</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HPI_COMMON</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_TYPE_REQUEST</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPI_OBJ_SUBSYSTEM</span>:
			<span class="n">subsys_message</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_TYPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
