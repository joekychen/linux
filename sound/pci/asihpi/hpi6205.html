<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › asihpi › hpi6205.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hpi6205.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">    AudioScience HPI driver</span>
<span class="cm">    Copyright (C) 1997-2011  AudioScience Inc. &lt;support@audioscience.com&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">    published by the Free Software Foundation;</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm"> Hardware Programming Interface (HPI) for AudioScience</span>
<span class="cm"> ASI50xx, AS51xx, ASI6xxx, ASI87xx ASI89xx series adapters.</span>
<span class="cm"> These PCI and PCIe bus adapters are based on a</span>
<span class="cm"> TMS320C6205 PCI bus mastering DSP,</span>
<span class="cm"> and (except ASI50xx) TI TMS320C6xxx floating point DSP</span>

<span class="cm"> Exported function:</span>
<span class="cm"> void HPI_6205(struct hpi_message *phm, struct hpi_response *phr)</span>

<span class="cm">(C) Copyright AudioScience Inc. 1998-2010</span>
<span class="cm">*******************************************************************************/</span>
<span class="cp">#define SOURCEFILE_NAME &quot;hpi6205.c&quot;</span>

<span class="cp">#include &quot;hpi_internal.h&quot;</span>
<span class="cp">#include &quot;hpimsginit.h&quot;</span>
<span class="cp">#include &quot;hpidebug.h&quot;</span>
<span class="cp">#include &quot;hpi6205.h&quot;</span>
<span class="cp">#include &quot;hpidspcd.h&quot;</span>
<span class="cp">#include &quot;hpicmn.h&quot;</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* HPI6205 specific error codes */</span>
<span class="cp">#define HPI6205_ERROR_BASE 1000	</span><span class="cm">/* not actually used anywhere */</span><span class="cp"></span>

<span class="cm">/* operational/messaging errors */</span>
<span class="cp">#define HPI6205_ERROR_MSG_RESP_IDLE_TIMEOUT     1015</span>
<span class="cp">#define HPI6205_ERROR_MSG_RESP_TIMEOUT          1016</span>

<span class="cm">/* initialization/bootload errors */</span>
<span class="cp">#define HPI6205_ERROR_6205_NO_IRQ       1002</span>
<span class="cp">#define HPI6205_ERROR_6205_INIT_FAILED  1003</span>
<span class="cp">#define HPI6205_ERROR_6205_REG          1006</span>
<span class="cp">#define HPI6205_ERROR_6205_DSPPAGE      1007</span>
<span class="cp">#define HPI6205_ERROR_C6713_HPIC        1009</span>
<span class="cp">#define HPI6205_ERROR_C6713_HPIA        1010</span>
<span class="cp">#define HPI6205_ERROR_C6713_PLL         1011</span>
<span class="cp">#define HPI6205_ERROR_DSP_INTMEM        1012</span>
<span class="cp">#define HPI6205_ERROR_DSP_EXTMEM        1013</span>
<span class="cp">#define HPI6205_ERROR_DSP_PLD           1014</span>
<span class="cp">#define HPI6205_ERROR_6205_EEPROM       1017</span>
<span class="cp">#define HPI6205_ERROR_DSP_EMIF1         1018</span>
<span class="cp">#define HPI6205_ERROR_DSP_EMIF2         1019</span>
<span class="cp">#define HPI6205_ERROR_DSP_EMIF3         1020</span>
<span class="cp">#define HPI6205_ERROR_DSP_EMIF4         1021</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* for C6205 PCI i/f */</span>
<span class="cm">/* Host Status Register (HSR) bitfields */</span>
<span class="cp">#define C6205_HSR_INTSRC        0x01</span>
<span class="cp">#define C6205_HSR_INTAVAL       0x02</span>
<span class="cp">#define C6205_HSR_INTAM         0x04</span>
<span class="cp">#define C6205_HSR_CFGERR        0x08</span>
<span class="cp">#define C6205_HSR_EEREAD        0x10</span>
<span class="cm">/* Host-to-DSP Control Register (HDCR) bitfields */</span>
<span class="cp">#define C6205_HDCR_WARMRESET    0x01</span>
<span class="cp">#define C6205_HDCR_DSPINT       0x02</span>
<span class="cp">#define C6205_HDCR_PCIBOOT      0x04</span>
<span class="cm">/* DSP Page Register (DSPP) bitfields, */</span>
<span class="cm">/* defines 4 Mbyte page that BAR0 points to */</span>
<span class="cp">#define C6205_DSPP_MAP1         0x400</span>

<span class="cm">/* BAR0 maps to prefetchable 4 Mbyte memory block set by DSPP.</span>
<span class="cm"> * BAR1 maps to non-prefetchable 8 Mbyte memory block</span>
<span class="cm"> * of DSP memory mapped registers (starting at 0x01800000).</span>
<span class="cm"> * 0x01800000 is hardcoded in the PCI i/f, so that only the offset from this</span>
<span class="cm"> * needs to be added to the BAR1 base address set in the PCI config reg</span>
<span class="cm"> */</span>
<span class="cp">#define C6205_BAR1_PCI_IO_OFFSET (0x027FFF0L)</span>
<span class="cp">#define C6205_BAR1_HSR  (C6205_BAR1_PCI_IO_OFFSET)</span>
<span class="cp">#define C6205_BAR1_HDCR (C6205_BAR1_PCI_IO_OFFSET+4)</span>
<span class="cp">#define C6205_BAR1_DSPP (C6205_BAR1_PCI_IO_OFFSET+8)</span>

<span class="cm">/* used to control LED (revA) and reset C6713 (revB) */</span>
<span class="cp">#define C6205_BAR0_TIMER1_CTL (0x01980000L)</span>

<span class="cm">/* For first 6713 in CE1 space, using DA17,16,2 */</span>
<span class="cp">#define HPICL_ADDR      0x01400000L</span>
<span class="cp">#define HPICH_ADDR      0x01400004L</span>
<span class="cp">#define HPIAL_ADDR      0x01410000L</span>
<span class="cp">#define HPIAH_ADDR      0x01410004L</span>
<span class="cp">#define HPIDIL_ADDR     0x01420000L</span>
<span class="cp">#define HPIDIH_ADDR     0x01420004L</span>
<span class="cp">#define HPIDL_ADDR      0x01430000L</span>
<span class="cp">#define HPIDH_ADDR      0x01430004L</span>

<span class="cp">#define C6713_EMIF_GCTL         0x01800000</span>
<span class="cp">#define C6713_EMIF_CE1          0x01800004</span>
<span class="cp">#define C6713_EMIF_CE0          0x01800008</span>
<span class="cp">#define C6713_EMIF_CE2          0x01800010</span>
<span class="cp">#define C6713_EMIF_CE3          0x01800014</span>
<span class="cp">#define C6713_EMIF_SDRAMCTL     0x01800018</span>
<span class="cp">#define C6713_EMIF_SDRAMTIMING  0x0180001C</span>
<span class="cp">#define C6713_EMIF_SDRAMEXT     0x01800020</span>

<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="p">{</span>
	<span class="cm">/* PCI registers */</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHSR</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHDCR</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prDSPP</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dsp_page</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">consistent_dma_area</span> <span class="n">h_locked_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">p_interface_buffer</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">flag_outstream_just_reset</span><span class="p">[</span><span class="n">HPI_MAX_STREAMS</span><span class="p">];</span>
	<span class="cm">/* a non-NULL handle means there is an HPI allocated buffer */</span>
	<span class="k">struct</span> <span class="n">consistent_dma_area</span> <span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">HPI_MAX_STREAMS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">consistent_dma_area</span> <span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">HPI_MAX_STREAMS</span><span class="p">];</span>
	<span class="cm">/* non-zero size means a buffer exists, may be external */</span>
	<span class="n">u32</span> <span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">HPI_MAX_STREAMS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">HPI_MAX_STREAMS</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">consistent_dma_area</span> <span class="n">h_control_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* local prototypes */</span>

<span class="cp">#define check_before_bbm_copy(status, p_bbm_data, l_first_write, l_second_write)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wait_dsp_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_us</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">send_dsp_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">adapter_boot_load_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">message_response_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="cp">#define HPI6205_TIMEOUT 1000000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">subsys_create_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adapter_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">create_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">delete_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_host_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_host_buffer_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_host_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">outstream_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_host_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_host_buffer_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_host_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">instream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">boot_loader_config_emif</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">boot_loader_test_internal_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">boot_loader_test_external_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">boot_loader_test_pld</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">);</span>

<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_CREATE_ADAPTER</span>:
		<span class="n">subsys_create_adapter</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">control_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pending_cache_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_GET_STATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rmb</span><span class="p">();</span>	<span class="cm">/* make sure we see updates DMAed from DSP */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpi_check_control_cache</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">HPI_METER_PEAK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pending_cache_error</span> <span class="o">=</span>
					<span class="n">HPI_ERROR_CONTROL_CACHING</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending_cache_error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">pending_cache_error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_GET_INFO</span>:
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_SET_STATE</span>:
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span><span class="p">)</span>
			<span class="n">hpi_cmn_control_cache_sync_to_msg</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span>
				<span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_DELETE</span>:
		<span class="n">adapter_delete</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span> <span class="o">&gt;=</span> <span class="n">HPI_MAX_STREAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OBJ_INDEX</span><span class="p">;</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">,</span>
			<span class="s">&quot;Message referencing invalid stream %d &quot;</span>
			<span class="s">&quot;on adapter index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_WRITE</span>:
		<span class="n">outstream_write</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_GET_INFO</span>:
		<span class="n">outstream_get_info</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_HOSTBUFFER_ALLOC</span>:
		<span class="n">outstream_host_buffer_allocate</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_HOSTBUFFER_GET_INFO</span>:
		<span class="n">outstream_host_buffer_get_info</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_HOSTBUFFER_FREE</span>:
		<span class="n">outstream_host_buffer_free</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_START</span>:
		<span class="n">outstream_start</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_OPEN</span>:
		<span class="n">outstream_open</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_RESET</span>:
		<span class="n">outstream_reset</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span> <span class="o">&gt;=</span> <span class="n">HPI_MAX_STREAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OBJ_INDEX</span><span class="p">;</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">,</span>
			<span class="s">&quot;Message referencing invalid stream %d &quot;</span>
			<span class="s">&quot;on adapter index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_READ</span>:
		<span class="n">instream_read</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_GET_INFO</span>:
		<span class="n">instream_get_info</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_HOSTBUFFER_ALLOC</span>:
		<span class="n">instream_host_buffer_allocate</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_HOSTBUFFER_GET_INFO</span>:
		<span class="n">instream_host_buffer_get_info</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_HOSTBUFFER_FREE</span>:
		<span class="n">instream_host_buffer_free</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_START</span>:
		<span class="n">instream_start</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/** Entry point to this HPI backend</span>
<span class="cm"> * All calls to the HPI start here</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">_HPI_6205</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pao</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">HPI_ADAPTER_DEBUG_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* allow last resort debug read even after crash */</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
			<span class="n">HPI_ERROR_DSP_HARDWARE</span><span class="p">);</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">,</span> <span class="s">&quot; %d,%d dsp crashed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init default response  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">HPI_SUBSYS_CREATE_ADAPTER</span><span class="p">)</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_PROCESSING_MESSAGE</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;start of switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_TYPE_REQUEST</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPI_OBJ_SUBSYSTEM</span>:
			<span class="n">subsys_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_ADAPTER</span>:
			<span class="n">adapter_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_CONTROL</span>:
			<span class="n">control_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_OSTREAM</span>:
			<span class="n">outstream_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_ISTREAM</span>:
			<span class="n">instream_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_TYPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HPI_6205</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">!=</span> <span class="n">HPI_OBJ_SUBSYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* normal messages must have valid adapter index */</span>
		<span class="n">pao</span> <span class="o">=</span> <span class="n">hpi_find_adapter</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* subsys messages don&#39;t address an adapter */</span>
		<span class="n">_HPI_6205</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="p">)</span>
		<span class="n">_HPI_6205</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
			<span class="n">HPI_ERROR_BAD_ADAPTER_NUMBER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* SUBSYSTEM */</span>

<span class="cm">/** Create an adapter object and initialise it based on resource information</span>
<span class="cm"> * passed in in the message</span>
<span class="cm"> * *** NOTE - you cannot use this function AND the FindAdapters function at the</span>
<span class="cm"> * same time, the application must use only one of them to get the adapters ***</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_create_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* create temp adapter obj, because we don&#39;t know what index yet */</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="n">ao</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">os_error_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot; subsys_create_adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ao</span><span class="p">));</span>

	<span class="n">ao</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ao</span><span class="p">.</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;can&#39;t get mem for adapter object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ao</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="o">*</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_adapter_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os_error_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delete_adapter_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">HPI_ERROR_BACKEND_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_DSP_BOOTLOAD</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">os_error_code</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ao</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_index</span> <span class="o">=</span> <span class="n">ao</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** delete an adapter - required by WDM driver */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pao</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OBJ_INDEX</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="cm">/* reset adapter h/w */</span>
	<span class="cm">/* Reset C6713 #1 */</span>
	<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">C6205_BAR0_TIMER1_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* reset C6205 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">C6205_HDCR_WARMRESET</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>

	<span class="n">delete_adapter_obj</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="n">hpi_delete_adapter</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Create adapter object</span>
<span class="cm">  allocate buffers, bootload DSPs, initialise control cache</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">create_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* init error reporting */</span>
	<span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HPI_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">flag_outstream_just_reset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* The C6205 memory area 1 is 8Mbyte window into DSP registers */</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHSR</span> <span class="o">=</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">C6205_BAR1_HSR</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span> <span class="o">=</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">C6205_BAR1_HDCR</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span> <span class="o">=</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">C6205_BAR1_DSPP</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_locked_mem</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_master_interface</span><span class="p">),</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">))</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_locked_mem</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">))</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;interface buffer address %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_master_interface</span><span class="p">));</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="o">-&gt;</span><span class="n">dsp_ack</span> <span class="o">=</span> <span class="n">H620_HIF_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adapter_boot_load_dsp</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">pos_error_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;DSP code load failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* no need to clean up as SubSysCreateAdapter */</span>
		<span class="cm">/* calls DeleteAdapter on error. */</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;load DSP code OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* allow boot load even if mem alloc wont work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>

	<span class="cm">/* make sure the DSP has started ok */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_RESET</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;timed out waiting reset state </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_INIT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Note that *pao, *phw are zeroed after allocation,</span>
<span class="cm">	 * so pointers and flags are NULL by default.</span>
<span class="cm">	 * Allocate bus mastering control cache buffer and tell the DSP about it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">.</span><span class="n">number_of_controls</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">p_control_cache_virtual</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_control_cache</span><span class="p">,</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">.</span><span class="n">size_in_bytes</span><span class="p">,</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">h_control_cache</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_control_cache_virtual</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">p_control_cache_virtual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">.</span><span class="n">size_in_bytes</span><span class="p">);</span>

			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span> <span class="o">=</span>
				<span class="n">hpi_alloc_control_cache</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span>
				<span class="n">control_cache</span><span class="p">.</span><span class="n">number_of_controls</span><span class="p">,</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">.</span><span class="n">size_in_bytes</span><span class="p">,</span>
				<span class="n">p_control_cache_virtual</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_get_phys_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">h_control_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_addr</span><span class="p">);</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">.</span><span class="n">physical_address32</span> <span class="o">=</span>
				<span class="n">phys_addr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_control_cache</span><span class="p">))</span>
				<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_control_cache</span><span class="p">);</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">send_dsp_command</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpi_message</span> <span class="n">hm</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hpi_response</span> <span class="n">hr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">max_streams</span><span class="p">;</span>

		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;init ADAPTER_GET_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hm</span><span class="p">));</span>
		<span class="cm">/* wAdapterIndex == version == 0 */</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">HPI_TYPE_REQUEST</span><span class="p">;</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hm</span><span class="p">);</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">HPI_OBJ_ADAPTER</span><span class="p">;</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_GET_INFO</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr</span><span class="p">));</span>
		<span class="n">hr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;message transport error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hr</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">hr</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_type</span><span class="p">;</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_index</span><span class="p">;</span>

		<span class="n">max_streams</span> <span class="o">=</span>
			<span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">num_outstreams</span> <span class="o">+</span>
			<span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">num_instreams</span><span class="p">;</span>

		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;got adapter info type %x index %d serial %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_type</span><span class="p">,</span> <span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_index</span><span class="p">,</span>
			<span class="n">hr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">serial_number</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">)</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">adap_idx</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;bootload DSP OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hpi_add_adapter</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Free memory areas allocated by adapter</span>
<span class="cm"> * this routine is called from AdapterDelete,</span>
<span class="cm">  * and SubSysCreateAdapter if duplicate index</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_control_cache</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_control_cache</span><span class="p">);</span>
		<span class="n">hpi_free_control_cache</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_locked_mem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_locked_mem</span><span class="p">);</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HPI_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="cm">/*?phw-&gt;InStreamHostBuffers[i] = NULL; */</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HPI_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
				<span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* Adapter functions */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* OutStream Host buffer functions */</span>

<span class="cm">/** Allocate or attach buffer for busmastering</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_host_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>

	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
		<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ALLOC phase, allocate a buffer with power of 2 size,</span>
<span class="cm">		   get its bus address for PCI bus mastering</span>
<span class="cm">		 */</span>
		<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span>
			<span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="cm">/* return old size and allocated size,</span>
<span class="cm">		   so caller can detect change */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">data_available</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">==</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Same size, no action required */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
					<span class="n">obj_index</span><span class="p">]))</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
			<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">,</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_get_phys_addr</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pci_address</span><span class="p">);</span>
		<span class="cm">/* get the phys addr into msg for single call alloc caller</span>
<span class="cm">		 * needs to do this for split alloc (or use the same message)</span>
<span class="cm">		 * return the phy address for split alloc in the respose too</span>
<span class="cm">		 */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">auxiliary_data_available</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pci_address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
		<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_GRANTADAPTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* GRANT phase.  Set up the BBM status, tell the DSP about</span>
<span class="cm">		   the buffer so it can start using BBM.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span>
				<span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
				<span class="s">&quot;Buffer size must be 2^N not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
			<span class="n">obj_index</span><span class="p">];</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">samples_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">=</span> <span class="n">HPI_STATE_STOPPED</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">auxiliary_data_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span>
			<span class="o">&amp;&amp;</span> <span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_host_buffer_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p_bbm_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
				<span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_bbm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
			<span class="n">obj_index</span><span class="p">];</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_OSTREAM</span><span class="p">,</span>
			<span class="n">HPI_OSTREAM_HOSTBUFFER_GET_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hostbuffer_info</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="n">p_bbm_data</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hostbuffer_info</span><span class="p">.</span><span class="n">p_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_OSTREAM</span><span class="p">,</span>
			<span class="n">HPI_OSTREAM_HOSTBUFFER_GET_INFO</span><span class="p">,</span>
			<span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_host_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
			<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_REVOKEADAPTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="cm">/* Tell adapter to stop using the host buffer. */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
			<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_FREE</span><span class="p">)</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="cm">/* Should HPI_ERROR_INVALID_OPERATION be returned</span>
<span class="cm">	   if no host buffer is allocated? */</span>
	<span class="k">else</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_OSTREAM</span><span class="p">,</span>
			<span class="n">HPI_OSTREAM_HOSTBUFFER_FREE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">outstream_get_space_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">-</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">space_available</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* there  is no BBM buffer, write via message */</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>

	<span class="n">space_available</span> <span class="o">=</span> <span class="n">outstream_get_space_available</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">space_available</span> <span class="o">&lt;</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* HostBuffers is used to indicate host buffer is internally allocated.</span>
<span class="cm">	   otherwise, assumed external, data written externally */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span>
		<span class="o">&amp;&amp;</span> <span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
				<span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">p_bbm_data</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">l_first_write</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">p_app_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">outstream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_bbm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* either all data,</span>
<span class="cm">		   or enough to fit from current to end of BBM buffer */</span>
		<span class="n">l_first_write</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_bbm_data</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="n">p_app_data</span><span class="p">,</span> <span class="n">l_first_write</span><span class="p">);</span>
		<span class="cm">/* remaining data if any */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_bbm_data</span><span class="p">,</span> <span class="n">p_app_data</span> <span class="o">+</span> <span class="n">l_first_write</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">l_first_write</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This version relies on the DSP code triggering an OStream buffer</span>
<span class="cm">	 * update immediately following a SET_FORMAT call. The host has</span>
<span class="cm">	 * already written data into the BBM buffer, but the DSP won&#39;t know</span>
<span class="cm">	 * about it until dwHostIndex is adjusted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">flag_outstream_just_reset</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Format can only change after reset. Must tell DSP. */</span>
		<span class="n">u16</span> <span class="n">function</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">flag_outstream_just_reset</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">HPI_OSTREAM_SET_FORMAT</span><span class="p">;</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>	<span class="cm">/* send the format to the DSP */</span>
		<span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">+=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">outstream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>

	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">stream_state</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">samples_transferred</span> <span class="o">=</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">samples_processed</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">data_available</span> <span class="o">=</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="n">outstream_get_space_available</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">auxiliary_data_available</span> <span class="o">=</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">auxiliary_data_available</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">flag_outstream_just_reset</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outstream_reset</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* InStream Host buffer functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_host_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>

	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
		<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_ALLOC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span>
			<span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">data_available</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">==</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Same size, no action required */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
					<span class="n">obj_index</span><span class="p">]))</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
				<span class="n">obj_index</span><span class="p">],</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">,</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_get_phys_addr</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pci_address</span><span class="p">);</span>
		<span class="cm">/* get the phys addr into msg for single call alloc. Caller</span>
<span class="cm">		   needs to do this for split alloc so return the phy address */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">auxiliary_data_available</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pci_address</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
		<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_GRANTADAPTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span>
				<span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
				<span class="s">&quot;Buffer size must be 2^N not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
			<span class="n">obj_index</span><span class="p">];</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">samples_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">=</span> <span class="n">HPI_STATE_STOPPED</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">auxiliary_data_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span>
			<span class="o">&amp;&amp;</span> <span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_host_buffer_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p_bbm_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
				<span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_bbm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
			<span class="n">obj_index</span><span class="p">];</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_ISTREAM</span><span class="p">,</span>
			<span class="n">HPI_ISTREAM_HOSTBUFFER_GET_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hostbuffer_info</span><span class="p">.</span><span class="n">p_buffer</span> <span class="o">=</span> <span class="n">p_bbm_data</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hostbuffer_info</span><span class="p">.</span><span class="n">p_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_ISTREAM</span><span class="p">,</span>
			<span class="n">HPI_ISTREAM_HOSTBUFFER_GET_INFO</span><span class="p">,</span>
			<span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_host_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
			<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_REVOKEADAPTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_EXTERNAL</span>
			<span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">HPI_BUFFER_CMD_INTERNAL_FREE</span><span class="p">)</span>
			<span class="n">hpios_locked_mem_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span>
				<span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">]);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Should HPI_ERROR_INVALID_OPERATION be returned</span>
<span class="cm">		   if no host buffer is allocated? */</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">HPI_OBJ_ISTREAM</span><span class="p">,</span>
			<span class="n">HPI_ISTREAM_HOSTBUFFER_FREE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">instream_get_bytes_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">dsp_index</span> <span class="o">-</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_available</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p_bbm_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l_first_read</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p_app_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>
	<span class="n">data_available</span> <span class="o">=</span> <span class="n">instream_get_bytes_available</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_available</span> <span class="o">&lt;</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_DATASIZE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span>
				<span class="n">obj_index</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpios_locked_mem_get_virt_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span>
				<span class="n">instream_host_buffers</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_bbm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_OPERATION</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* either all data,</span>
<span class="cm">		   or enough to fit from current to end of BBM buffer */</span>
		<span class="n">l_first_read</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_app_data</span><span class="p">,</span>
			<span class="n">p_bbm_data</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="n">l_first_read</span><span class="p">);</span>
		<span class="cm">/* remaining data if any */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_app_data</span> <span class="o">+</span> <span class="n">l_first_read</span><span class="p">,</span> <span class="n">p_bbm_data</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">l_first_read</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">host_index</span> <span class="o">+=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hostbuffer_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_size</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">instream_host_buffer_status</span><span class="p">[</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">];</span>

	<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">stream_state</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">samples_transferred</span> <span class="o">=</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">samples_processed</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">data_available</span> <span class="o">=</span>
		<span class="n">instream_get_bytes_available</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">auxiliary_data_available</span> <span class="o">=</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">auxiliary_data_available</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* LOW-LEVEL */</span>
<span class="cp">#define HPI6205_MAX_FILES_TO_LOAD 2</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">adapter_boot_load_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_code</span> <span class="n">dsp_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">boot_code_id</span><span class="p">[</span><span class="n">HPI6205_MAX_FILES_TO_LOAD</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_ASI</span><span class="p">(</span><span class="mh">0x6205</span><span class="p">);</span>

	<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* fix up cases where bootcode id[1] != subsys id */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5000</span><span class="p">)</span>:
		<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5300</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5400</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6300</span><span class="p">)</span>:
		<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6400</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5500</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5600</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6500</span><span class="p">)</span>:
		<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6600</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x8800</span><span class="p">)</span>:
		<span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x8900</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset DSP by writing a 1 to the WARMRESET bit */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">C6205_HDCR_WARMRESET</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
	<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* check that PCI i/f was configured by EEPROM */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">C6205_HSR_CFGERR</span> <span class="o">|</span> <span class="n">C6205_HSR_EEREAD</span><span class="p">))</span> <span class="o">!=</span>
		<span class="n">C6205_HSR_EEREAD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_EEPROM</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="cm">/* disable PINTA interrupt */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHSR</span><span class="p">);</span>

	<span class="cm">/* check control register reports PCI boot mode */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">C6205_HDCR_PCIBOOT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_REG</span><span class="p">;</span>

	<span class="cm">/* try writing a few numbers to the DSP page register */</span>
	<span class="cm">/* and reading them back. */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">|</span> <span class="n">C6205_DSPP_MAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_DSPPAGE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">|</span> <span class="n">C6205_DSPP_MAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_DSPPAGE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">|</span> <span class="n">C6205_DSPP_MAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_DSPPAGE</span><span class="p">;</span>
	<span class="cm">/* reset DSP page to the correct number */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">|</span> <span class="n">C6205_DSPP_MAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_6205_DSPPAGE</span><span class="p">;</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* release 6713 from reset before 6205 is bootloaded.</span>
<span class="cm">	   This ensures that the EMIF is inactive,</span>
<span class="cm">	   and the 6713 HPI gets the correct bootmode etc</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_code_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="cm">/* CLKX0 &lt;- &#39;1&#39; release the C6205 bootmode pulldowns */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x018C0024L</span><span class="p">),</span> <span class="mh">0x00002202</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* Reset the 6713 #1 - revB */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">C6205_BAR0_TIMER1_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* dummy read every 4 words for 6205 advisory 1.4.4 */</span>
		<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* Release C6713 from reset - revB */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">C6205_BAR0_TIMER1_CTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dsp</span> <span class="o">&lt;</span> <span class="n">HPI6205_MAX_FILES_TO_LOAD</span><span class="p">;</span> <span class="n">dsp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* is there a DSP to load? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_code_id</span><span class="p">[</span><span class="n">dsp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_config_emif</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_internal_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_external_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_pld</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* write the DSP code down into the DSPs memory */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_dsp_code_open</span><span class="p">(</span><span class="n">boot_code_id</span><span class="p">[</span><span class="n">dsp</span><span class="p">],</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="n">pos_error_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pcode</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of code */</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_block</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pcode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
					<span class="o">*</span><span class="n">pcode</span><span class="p">);</span>
				<span class="cm">/* dummy read every 4 words */</span>
				<span class="cm">/* for 6205 advisory 1.4.4 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span>
						<span class="n">address</span><span class="p">);</span>
				<span class="n">pcode</span><span class="o">++</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpi_dsp_code_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* verify code */</span>
		<span class="n">hpi_dsp_code_rewind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pcode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of code */</span>

			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">hpi_dsp_code_read_block</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcode</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span>
					<span class="n">address</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pcode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pcode</span><span class="o">++</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hpi_dsp_code_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* After bootloading all DSPs, start DSP0 running</span>
<span class="cm">	 * The DSP0 code will handle starting and synchronizing with its slaves</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we need to tell the card the physical PCI address */</span>
		<span class="n">u32</span> <span class="n">physicalPC_iaddress</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">host_mailbox_address_on_dsp</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">physicalPC_iaddress_verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">time_out</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="cm">/* set ack so we know when DSP is ready to go */</span>
		<span class="cm">/* (dwDspAck will be changed to HIF_RESET) */</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span> <span class="o">=</span> <span class="n">H620_HIF_UNKNOWN</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>	<span class="cm">/* ensure ack is written before dsp writes back */</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hpios_locked_mem_get_phys_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">h_locked_mem</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">physicalPC_iaddress</span><span class="p">);</span>

		<span class="cm">/* locate the host mailbox on the DSP. */</span>
		<span class="n">host_mailbox_address_on_dsp</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">physicalPC_iaddress</span> <span class="o">!=</span> <span class="n">physicalPC_iaddress_verify</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">time_out</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">host_mailbox_address_on_dsp</span><span class="p">,</span>
				<span class="n">physicalPC_iaddress</span><span class="p">);</span>
			<span class="n">physicalPC_iaddress_verify</span> <span class="o">=</span>
				<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">host_mailbox_address_on_dsp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;starting DS_ps running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* enable interrupts */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHSR</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">C6205_HSR_INTAM</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHSR</span><span class="p">);</span>

	<span class="cm">/* start code running... */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">C6205_HDCR_DSPINT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>

	<span class="cm">/* give the DSP 10ms to start up */</span>
	<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* Bootloader utility functions */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">boot_loader_read_mem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 0 is always C6205 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mh">0x01800000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mh">0x02000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* BAR1 register access */</span>
			<span class="n">p_data</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0x007fffff</span><span class="p">)</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="cm">/* HPI_DEBUG_LOG(WARNING,</span>
<span class="cm">			   &quot;BAR1 access %08x\n&quot;, dwAddress); */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">dw4M_page</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">22L</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dw4M_page</span> <span class="o">!=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span> <span class="o">=</span> <span class="n">dw4M_page</span><span class="p">;</span>
				<span class="cm">/* *INDENT OFF* */</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
				<span class="cm">/* *INDENT-ON* */</span>
			<span class="p">}</span>
			<span class="n">address</span> <span class="o">&amp;=</span> <span class="mh">0x3fffff</span><span class="p">;</span>	<span class="cm">/* address within 4M page */</span>
			<span class="cm">/* BAR0 memory access */</span>
			<span class="n">p_data</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
				<span class="n">address</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="n">u32</span> <span class="n">lsb</span><span class="p">;</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAL_ADDR</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAH_ADDR</span><span class="p">,</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIDL_ADDR</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIDH_ADDR</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lsb</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">boot_loader_write_mem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p_data</span><span class="p">;</span>
	<span class="cm">/*      u32 dwVerifyData=0; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 0 is always C6205 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mh">0x01800000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mh">0x02000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* BAR1 - DSP  register access using */</span>
			<span class="cm">/* Non-prefetchable PCI access */</span>
			<span class="n">p_data</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0x007fffff</span><span class="p">)</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* BAR0 access - all of DSP memory using */</span>
			<span class="cm">/* pre-fetchable PCI access */</span>
			<span class="n">u32</span> <span class="n">dw4M_page</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">22L</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dw4M_page</span> <span class="o">!=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span> <span class="o">=</span> <span class="n">dw4M_page</span><span class="p">;</span>
				<span class="cm">/* *INDENT-OFF* */</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">dsp_page</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prDSPP</span><span class="p">);</span>
				<span class="cm">/* *INDENT-ON* */</span>
			<span class="p">}</span>
			<span class="n">address</span> <span class="o">&amp;=</span> <span class="mh">0x3fffff</span><span class="p">;</span>	<span class="cm">/* address within 4M page */</span>
			<span class="n">p_data</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
				<span class="n">address</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAL_ADDR</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAH_ADDR</span><span class="p">,</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* dummy read every 4 words for 6205 advisory 1.4.4 */</span>
		<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIDL_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIDH_ADDR</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* dummy read every 4 words for 6205 advisory 1.4.4 */</span>
		<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">boot_loader_config_emif</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">setting</span><span class="p">;</span>

		<span class="cm">/* DSP 0 is always C6205 */</span>

		<span class="cm">/* Set the EMIF */</span>
		<span class="cm">/* memory map of C6205 */</span>
		<span class="cm">/* 00000000-0000FFFF    16Kx32 internal program */</span>
		<span class="cm">/* 00400000-00BFFFFF    CE0     2Mx32 SDRAM running @ 100MHz */</span>

		<span class="cm">/* EMIF config */</span>
		<span class="cm">/*------------ */</span>
		<span class="cm">/* Global EMIF control */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800000</span><span class="p">,</span> <span class="mh">0x3779</span><span class="p">);</span>
<span class="cp">#define WS_OFS 28</span>
<span class="cp">#define WST_OFS 22</span>
<span class="cp">#define WH_OFS 20</span>
<span class="cp">#define RS_OFS 16</span>
<span class="cp">#define RST_OFS 8</span>
<span class="cp">#define MTYPE_OFS 4</span>
<span class="cp">#define RH_OFS 0</span>

		<span class="cm">/* EMIF CE0 setup - 2Mx32 Sync DRAM on ASI5000 cards only */</span>
		<span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00000030</span><span class="p">;</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800008</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setting</span> <span class="o">!=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x01800008</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_EMIF1</span><span class="p">;</span>

		<span class="cm">/* EMIF CE1 setup - 32 bit async. This is 6713 #1 HPI, */</span>
		<span class="cm">/* which occupies D15..0. 6713 starts at 27MHz, so need */</span>
		<span class="cm">/* plenty of wait states. See dsn8701.rtf, and 6713 errata. */</span>
		<span class="cm">/* WST should be 71, but 63  is max possible */</span>
		<span class="n">setting</span> <span class="o">=</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">63L</span> <span class="o">&lt;&lt;</span> <span class="n">WST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">63L</span> <span class="o">&lt;&lt;</span> <span class="n">RST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="n">MTYPE_OFS</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800004</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setting</span> <span class="o">!=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x01800004</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_EMIF2</span><span class="p">;</span>

		<span class="cm">/* EMIF CE2 setup - 32 bit async. This is 6713 #2 HPI, */</span>
		<span class="cm">/* which occupies D15..0. 6713 starts at 27MHz, so need */</span>
		<span class="cm">/* plenty of wait states */</span>
		<span class="n">setting</span> <span class="o">=</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">28L</span> <span class="o">&lt;&lt;</span> <span class="n">WST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">63L</span> <span class="o">&lt;&lt;</span> <span class="n">RST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="n">MTYPE_OFS</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800010</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setting</span> <span class="o">!=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x01800010</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_EMIF3</span><span class="p">;</span>

		<span class="cm">/* EMIF CE3 setup - 32 bit async. */</span>
		<span class="cm">/* This is the PLD on the ASI5000 cards only */</span>
		<span class="n">setting</span> <span class="o">=</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">10L</span> <span class="o">&lt;&lt;</span> <span class="n">WST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">10L</span> <span class="o">&lt;&lt;</span> <span class="n">RST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="n">MTYPE_OFS</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800014</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setting</span> <span class="o">!=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x01800014</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_EMIF4</span><span class="p">;</span>

		<span class="cm">/* set EMIF SDRAM control for 2Mx32 SDRAM (512x32x4 bank) */</span>
		<span class="cm">/*  need to use this else DSP code crashes? */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01800018</span><span class="p">,</span>
			<span class="mh">0x07117000</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM Refresh Timing */</span>
		<span class="cm">/* EMIF SDRAM timing  (orig = 0x410, emulator = 0x61a) */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x0180001C</span><span class="p">,</span>
			<span class="mh">0x00000410</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* test access to the C6713s HPI registers */</span>
		<span class="n">u32</span> <span class="n">write_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Set up HPIC for little endian, by setiing HPIC:HWOB=1 */</span>
		<span class="n">write_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPICL_ADDR</span><span class="p">,</span> <span class="n">write_data</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPICH_ADDR</span><span class="p">,</span> <span class="n">write_data</span><span class="p">);</span>
		<span class="cm">/* C67 HPI is on lower 16bits of 32bit EMIF */</span>
		<span class="n">read_data</span> <span class="o">=</span>
			<span class="mh">0xFFF7</span> <span class="o">&amp;</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPICL_ADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_data</span> <span class="o">!=</span> <span class="n">read_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HPICL %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">write_data</span><span class="p">,</span>
				<span class="n">read_data</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_C6713_HPIC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* HPIA - walking ones test */</span>
		<span class="n">write_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAL_ADDR</span><span class="p">,</span>
				<span class="n">write_data</span><span class="p">);</span>
			<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HPIAH_ADDR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">write_data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">read_data</span> <span class="o">=</span>
				<span class="mh">0xFFFF</span> <span class="o">&amp;</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">HPIAL_ADDR</span><span class="p">);</span>
			<span class="n">read_data</span> <span class="o">=</span>
				<span class="n">read_data</span> <span class="o">|</span> <span class="p">((</span><span class="mh">0xFFFF</span> <span class="o">&amp;</span>
					<span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">HPIAH_ADDR</span><span class="p">))</span>
				<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_data</span> <span class="o">!=</span> <span class="n">write_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HPIA %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">write_data</span><span class="p">,</span> <span class="n">read_data</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">HPI6205_ERROR_C6713_HPIA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">write_data</span> <span class="o">=</span> <span class="n">write_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* setup C67x PLL</span>
<span class="cm">		 *  ** C6713 datasheet says we cannot program PLL from HPI,</span>
<span class="cm">		 * and indeed if we try to set the PLL multiply from the HPI,</span>
<span class="cm">		 * the PLL does not seem to lock, so we enable the PLL and</span>
<span class="cm">		 * use the default multiply of x 7, which for a 27MHz clock</span>
<span class="cm">		 * gives a DSP speed of 189MHz</span>
<span class="cm">		 */</span>
		<span class="cm">/* bypass PLL */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C100</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/* EMIF = 189/3=63MHz */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C120</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">);</span>
		<span class="cm">/* peri = 189/2 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C11C</span><span class="p">,</span> <span class="mh">0x8001</span><span class="p">);</span>
		<span class="cm">/* cpu  = 189/1 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C118</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/* ** SGT test to take GPO3 high when we start the PLL */</span>
		<span class="cm">/* and low when the delay is completed */</span>
		<span class="cm">/* FSX0 &lt;- &#39;1&#39; (GPO3) */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x018C0024L</span><span class="p">),</span> <span class="mh">0x00002A0A</span><span class="p">);</span>
		<span class="cm">/* PLL not bypassed */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C100</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/* FSX0 &lt;- &#39;0&#39; (GPO3) */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x018C0024L</span><span class="p">),</span> <span class="mh">0x00002A02</span><span class="p">);</span>

		<span class="cm">/* 6205 EMIF CE1 resetup - 32 bit async. */</span>
		<span class="cm">/* Now 6713 #1 is running at 189MHz can reduce waitstates */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01800004</span><span class="p">,</span>	<span class="cm">/* CE1 */</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8L</span> <span class="o">&lt;&lt;</span> <span class="n">WST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">WH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RS_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">12L</span> <span class="o">&lt;&lt;</span> <span class="n">RST_OFS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">RH_OFS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="n">MTYPE_OFS</span><span class="p">));</span>

		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="cm">/* check that we can read one of the PLL registers */</span>
		<span class="cm">/* PLL should not be bypassed! */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x01B7C100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span>
			<span class="o">!=</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_C6713_PLL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* setup C67x EMIF  (note this is the only use of</span>
<span class="cm">		   BAR1 via BootLoader_WriteMem32) */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">C6713_EMIF_GCTL</span><span class="p">,</span>
			<span class="mh">0x000034A8</span><span class="p">);</span>

		<span class="cm">/* EMIF CE0 setup - 2Mx32 Sync DRAM</span>
<span class="cm">		   31..28       Wr setup</span>
<span class="cm">		   27..22       Wr strobe</span>
<span class="cm">		   21..20       Wr hold</span>
<span class="cm">		   19..16       Rd setup</span>
<span class="cm">		   15..14       -</span>
<span class="cm">		   13..8        Rd strobe</span>
<span class="cm">		   7..4         MTYPE   0011            Sync DRAM 32bits</span>
<span class="cm">		   3            Wr hold MSB</span>
<span class="cm">		   2..0         Rd hold</span>
<span class="cm">		 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">C6713_EMIF_CE0</span><span class="p">,</span>
			<span class="mh">0x00000030</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM Extension</span>
<span class="cm">		   0x00</span>
<span class="cm">		   31-21        0000b 0000b 000b</span>
<span class="cm">		   20           WR2RD = 2cycles-1  = 1b</span>

<span class="cm">		   19-18        WR2DEAC = 3cycle-1 = 10b</span>
<span class="cm">		   17           WR2WR = 2cycle-1   = 1b</span>
<span class="cm">		   16-15        R2WDQM = 4cycle-1  = 11b</span>
<span class="cm">		   14-12        RD2WR = 6cycles-1  = 101b</span>

<span class="cm">		   11-10        RD2DEAC = 4cycle-1 = 11b</span>
<span class="cm">		   9            RD2RD = 2cycle-1   = 1b</span>
<span class="cm">		   8-7          THZP = 3cycle-1    = 10b</span>
<span class="cm">		   6-5          TWR  = 2cycle-1    = 01b (tWR = 17ns)</span>
<span class="cm">		   4            TRRD = 2cycle      = 0b  (tRRD = 14ns)</span>
<span class="cm">		   3-1          TRAS = 5cycle-1    = 100b (Tras=42ns)</span>
<span class="cm">		   1            CAS latency = 3cyc = 1b</span>
<span class="cm">		   (for Micron 2M32-7 operating at 100MHz)</span>
<span class="cm">		 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">C6713_EMIF_SDRAMEXT</span><span class="p">,</span>
			<span class="mh">0x001BDF29</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM control - set up for a 2Mx32 SDRAM (512x32x4 bank)</span>
<span class="cm">		   31           -       0b       -</span>
<span class="cm">		   30           SDBSZ   1b              4 bank</span>
<span class="cm">		   29..28       SDRSZ   00b             11 row address pins</span>

<span class="cm">		   27..26       SDCSZ   01b             8 column address pins</span>
<span class="cm">		   25           RFEN    1b              refersh enabled</span>
<span class="cm">		   24           INIT    1b              init SDRAM!</span>

<span class="cm">		   23..20       TRCD    0001b                   (Trcd/Tcyc)-1 = (20/10)-1 = 1</span>

<span class="cm">		   19..16       TRP     0001b                   (Trp/Tcyc)-1 = (20/10)-1 = 1</span>

<span class="cm">		   15..12       TRC     0110b                   (Trc/Tcyc)-1 = (70/10)-1 = 6</span>

<span class="cm">		   11..0        -       0000b 0000b 0000b</span>
<span class="cm">		 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">C6713_EMIF_SDRAMCTL</span><span class="p">,</span>
			<span class="mh">0x47116000</span><span class="p">);</span>

		<span class="cm">/* SDRAM refresh timing</span>
<span class="cm">		   Need 4,096 refresh cycles every 64ms = 15.625us = 1562cycles of 100MHz = 0x61A</span>
<span class="cm">		 */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
			<span class="n">C6713_EMIF_SDRAMTIMING</span><span class="p">,</span> <span class="mh">0x00000410</span><span class="p">);</span>

		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 2 is a C6713 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">boot_loader_test_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">test_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* for 1st word, test each bit in the 32bit word, */</span>
	<span class="cm">/* dwLength specifies number of 32bit words to test */</span>
	<span class="cm">/*for(i=0; i&lt;dwLength; i++) */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="n">test_addr</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span>
				<span class="n">test_data</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="n">test_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
					<span class="s">&quot;Memtest error details  &quot;</span>
					<span class="s">&quot;%08x %08x %08x %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span>
					<span class="n">test_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* error */</span>
			<span class="p">}</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>	<span class="cm">/* for(j) */</span>
	<span class="p">}</span>	<span class="cm">/* for(i) */</span>

	<span class="cm">/* for the next 100 locations test each location, leaving it as zero */</span>
	<span class="cm">/* write a zero to the next word in memory before we read */</span>
	<span class="cm">/* the previous write to make sure every memory location is unique */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_addr</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0xA5A55A5A</span><span class="p">;</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
				<span class="s">&quot;Memtest error details  &quot;</span>
				<span class="s">&quot;%08x %08x %08x %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
				<span class="n">data</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* error */</span>
		<span class="p">}</span>
		<span class="cm">/* leave location as zero */</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* zero out entire memory block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_addr</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">boot_loader_test_internal_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 0 is a C6205 */</span>
		<span class="cm">/* 64K prog mem */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			<span class="mh">0x10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="cm">/* 64K data mem */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x80000000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="cm">/* 192K internal mem */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			<span class="mh">0x30000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="cm">/* 64K internal mem / L2 cache */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x00030000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_INTMEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">boot_loader_test_external_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">dsp_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dRAM_start_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dRAM_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only test for SDRAM if an ASI5000 card */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x5000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DSP 0 is always C6205 */</span>
			<span class="n">dRAM_start_address</span> <span class="o">=</span> <span class="mh">0x00400000</span><span class="p">;</span>
			<span class="n">dRAM_size</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
			<span class="cm">/*dwDRAMinc=1024; */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="n">dRAM_start_address</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">dRAM_size</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
		<span class="cm">/*dwDRAMinc=1024; */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_loader_test_memory</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">dRAM_start_address</span><span class="p">,</span>
			<span class="n">dRAM_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_EXTMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">boot_loader_test_pld</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsp_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only test for DSP0 PLD on ASI5000 card */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x5000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PLD is located at CE3=0x03000000 */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x03000008</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x5</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_PLD</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x0300000C</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xA</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_PLD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSP 1 is a C6713 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x8700</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PLD is located at CE1=0x90000000 */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">boot_loader_read_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="mh">0x90000010</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">HPI6205_ERROR_DSP_PLD</span><span class="p">;</span>
			<span class="cm">/* 8713 - LED on */</span>
			<span class="n">boot_loader_write_mem32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="mh">0x90000000</span><span class="p">,</span>
				<span class="mh">0x02</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Transfer data to or from DSP</span>
<span class="cm"> nOperation = H620_H620_HIF_SEND_DATA or H620_HIF_GET_DATA</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6205_transfer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p_data</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">data_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_transferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_INVALID_DATA_POINTER</span><span class="p">;</span>

	<span class="n">data_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>	<span class="cm">/* round data_size down to nearest 4 bytes */</span>

	<span class="cm">/* make sure state is IDLE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI_ERROR_DSP_HARDWARE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data_transferred</span> <span class="o">&lt;</span> <span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">this_copy</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">-</span> <span class="n">data_transferred</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this_copy</span> <span class="o">&gt;</span> <span class="n">HPI6205_SIZEOF_DATA</span><span class="p">)</span>
			<span class="n">this_copy</span> <span class="o">=</span> <span class="n">HPI6205_SIZEOF_DATA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">H620_HIF_SEND_DATA</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">p_data</span><span class="p">[</span><span class="n">data_transferred</span><span class="p">],</span> <span class="n">this_copy</span><span class="p">);</span>

		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">transfer_size_in_bytes</span> <span class="o">=</span> <span class="n">this_copy</span><span class="p">;</span>

		<span class="cm">/* DSP must change this back to nOperation */</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span> <span class="o">=</span> <span class="n">H620_HIF_IDLE</span><span class="p">;</span>
		<span class="n">send_dsp_command</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>

		<span class="n">temp2</span> <span class="o">=</span> <span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">);</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;spun %d times for data xfer of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">HPI6205_TIMEOUT</span> <span class="o">-</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">this_copy</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* timed out */</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
				<span class="s">&quot;Timed out waiting for &quot;</span> <span class="s">&quot;state %d got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">operation</span><span class="p">,</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">H620_HIF_GET_DATA</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_data</span><span class="p">[</span><span class="n">data_transferred</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">this_copy</span><span class="p">);</span>

		<span class="n">data_transferred</span> <span class="o">+=</span> <span class="n">this_copy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span> <span class="o">!=</span> <span class="n">operation</span><span class="p">)</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;interface-&gt;dsp_ack=%d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>
	<span class="cm">/*                      err=HPI_ERROR_DSP_HARDWARE; */</span>

	<span class="n">send_dsp_command</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* wait for up to timeout_us microseconds for the DSP</span>
<span class="cm">   to signal state by DMA into dwDspAck</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_dsp_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">timeout_us</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rmb</span><span class="p">();</span>	<span class="cm">/* ensure interface-&gt;dsp_ack is up to date */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>	<span class="cm">/* DSP changes dsp_ack by DMA */</span>
	<span class="p">}</span>

	<span class="cm">/*HPI_DEBUG_LOG(VERBOSE, &quot;Spun %d for %d\n&quot;, timeout_us/4-t, state); */</span>
	<span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the busmaster interface to cmd, then interrupt the DSP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_dsp_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">host_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>	<span class="cm">/* DSP gets state by DMA, make sure it is written to memory */</span>
	<span class="cm">/* before we interrupt the DSP */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">C6205_HDCR_DSPINT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">C6205_HDCR_DSPINT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">prHDCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">message_count</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">message_response_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">time_out</span><span class="p">,</span> <span class="n">time_out2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_master_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_interface_buffer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">message_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">message_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_MESSAGE_BUFFER_TOO_SMALL</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">message_buffer</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">);</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
			<span class="s">&quot;message len %d too big for buffer %zd </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">message_buffer</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assume buffer of type struct bus_master_interface</span>
<span class="cm">	   is allocated &quot;noncacheable&quot; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;timeout waiting for idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_MSG_RESP_IDLE_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">message_buffer</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="cm">/* signal we want a response */</span>
	<span class="n">send_dsp_command</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_GET_RESP</span><span class="p">);</span>

	<span class="n">time_out2</span> <span class="o">=</span> <span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_GET_RESP</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
			<span class="s">&quot;(%u) Timed out waiting for &quot;</span> <span class="s">&quot;GET_RESP state [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">message_count</span><span class="p">,</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">dsp_ack</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;(%u) transition to GET_RESP after %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">message_count</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span> <span class="o">-</span> <span class="n">time_out2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* spin waiting on HIF interrupt flag (end of msg process) */</span>
	<span class="n">time_out</span> <span class="o">=</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* read the result */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">,</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
				<span class="s">&quot;response len %d too big for buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">));</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_RESPONSE_BUFFER_TOO_SMALL</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">response_buffer</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* set interface back to idle */</span>
	<span class="n">send_dsp_command</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out</span> <span class="o">||</span> <span class="o">!</span><span class="n">time_out2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;something timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI6205_ERROR_MSG_RESP_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* special case for adapter close - */</span>
	<span class="cm">/* wait for the DSP to indicate it is idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">HPI_ADAPTER_CLOSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_dsp_ack</span><span class="p">(</span><span class="n">phw</span><span class="p">,</span> <span class="n">H620_HIF_IDLE</span><span class="p">,</span> <span class="n">HPI6205_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span>
				<span class="s">&quot;Timeout waiting for idle &quot;</span>
				<span class="s">&quot;(on adapter_close)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">HPI6205_ERROR_MSG_RESP_IDLE_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hpi_validate_response</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpios_dsplock_lock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>

	<span class="cm">/* maybe an error response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something failed in the HPI/DSP interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">HPI_ERROR_BACKEND_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_DSP_COMMUNICATION</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* just the header of the response is valid */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* something failed in the DSP */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_WRITE</span>:
	<span class="k">case</span> <span class="n">HPI_ISTREAM_ANC_WRITE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hpi6205_transfer_data</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span> <span class="n">H620_HIF_SEND_DATA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HPI_ISTREAM_READ</span>:
	<span class="k">case</span> <span class="n">HPI_OSTREAM_ANC_READ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hpi6205_transfer_data</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">,</span>
			<span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span> <span class="n">H620_HIF_GET_DATA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">hpios_dsplock_unlock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
