<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › asihpi › hpi6000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hpi6000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">    AudioScience HPI driver</span>
<span class="cm">    Copyright (C) 1997-2011  AudioScience Inc. &lt;support@audioscience.com&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">    published by the Free Software Foundation;</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm"> Hardware Programming Interface (HPI) for AudioScience ASI6200 series adapters.</span>
<span class="cm"> These PCI bus adapters are based on the TI C6711 DSP.</span>

<span class="cm"> Exported functions:</span>
<span class="cm"> void HPI_6000(struct hpi_message *phm, struct hpi_response *phr)</span>

<span class="cm"> #defines</span>
<span class="cm"> HIDE_PCI_ASSERTS to show the PCI asserts</span>
<span class="cm"> PROFILE_DSP2 get profile data from DSP2 if present (instead of DSP 1)</span>

<span class="cm">(C) Copyright AudioScience Inc. 1998-2003</span>
<span class="cm">*******************************************************************************/</span>
<span class="cp">#define SOURCEFILE_NAME &quot;hpi6000.c&quot;</span>

<span class="cp">#include &quot;hpi_internal.h&quot;</span>
<span class="cp">#include &quot;hpimsginit.h&quot;</span>
<span class="cp">#include &quot;hpidebug.h&quot;</span>
<span class="cp">#include &quot;hpi6000.h&quot;</span>
<span class="cp">#include &quot;hpidspcd.h&quot;</span>
<span class="cp">#include &quot;hpicmn.h&quot;</span>

<span class="cp">#define HPI_HIF_BASE (0x00000200)	</span><span class="cm">/* start of C67xx internal RAM */</span><span class="cp"></span>
<span class="cp">#define HPI_HIF_ADDR(member) \</span>
<span class="cp">	(HPI_HIF_BASE + offsetof(struct hpi_hif_6000, member))</span>
<span class="cp">#define HPI_HIF_ERROR_MASK      0x4000</span>

<span class="cm">/* HPI6000 specific error codes */</span>
<span class="cp">#define HPI6000_ERROR_BASE 900	</span><span class="cm">/* not actually used anywhere */</span><span class="cp"></span>

<span class="cm">/* operational/messaging errors */</span>
<span class="cp">#define HPI6000_ERROR_MSG_RESP_IDLE_TIMEOUT             901</span>

<span class="cp">#define HPI6000_ERROR_MSG_RESP_GET_RESP_ACK             903</span>
<span class="cp">#define HPI6000_ERROR_MSG_GET_ADR                       904</span>
<span class="cp">#define HPI6000_ERROR_RESP_GET_ADR                      905</span>
<span class="cp">#define HPI6000_ERROR_MSG_RESP_BLOCKWRITE32             906</span>
<span class="cp">#define HPI6000_ERROR_MSG_RESP_BLOCKREAD32              907</span>

<span class="cp">#define HPI6000_ERROR_CONTROL_CACHE_PARAMS              909</span>

<span class="cp">#define HPI6000_ERROR_SEND_DATA_IDLE_TIMEOUT            911</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_ACK                     912</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_ADR                     913</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_TIMEOUT                 914</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_CMD                     915</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_WRITE                   916</span>
<span class="cp">#define HPI6000_ERROR_SEND_DATA_IDLECMD                 917</span>

<span class="cp">#define HPI6000_ERROR_GET_DATA_IDLE_TIMEOUT             921</span>
<span class="cp">#define HPI6000_ERROR_GET_DATA_ACK                      922</span>
<span class="cp">#define HPI6000_ERROR_GET_DATA_CMD                      923</span>
<span class="cp">#define HPI6000_ERROR_GET_DATA_READ                     924</span>
<span class="cp">#define HPI6000_ERROR_GET_DATA_IDLECMD                  925</span>

<span class="cp">#define HPI6000_ERROR_CONTROL_CACHE_ADDRLEN             951</span>
<span class="cp">#define HPI6000_ERROR_CONTROL_CACHE_READ                952</span>
<span class="cp">#define HPI6000_ERROR_CONTROL_CACHE_FLUSH               953</span>

<span class="cp">#define HPI6000_ERROR_MSG_RESP_GETRESPCMD               961</span>
<span class="cp">#define HPI6000_ERROR_MSG_RESP_IDLECMD                  962</span>

<span class="cm">/* Initialisation/bootload errors */</span>
<span class="cp">#define HPI6000_ERROR_UNHANDLED_SUBSYS_ID               930</span>

<span class="cm">/* can&#39;t access PCI2040 */</span>
<span class="cp">#define HPI6000_ERROR_INIT_PCI2040                      931</span>
<span class="cm">/* can&#39;t access DSP HPI i/f */</span>
<span class="cp">#define HPI6000_ERROR_INIT_DSPHPI                       932</span>
<span class="cm">/* can&#39;t access internal DSP memory */</span>
<span class="cp">#define HPI6000_ERROR_INIT_DSPINTMEM                    933</span>
<span class="cm">/* can&#39;t access SDRAM - test#1 */</span>
<span class="cp">#define HPI6000_ERROR_INIT_SDRAM1                       934</span>
<span class="cm">/* can&#39;t access SDRAM - test#2 */</span>
<span class="cp">#define HPI6000_ERROR_INIT_SDRAM2                       935</span>

<span class="cp">#define HPI6000_ERROR_INIT_VERIFY                       938</span>

<span class="cp">#define HPI6000_ERROR_INIT_NOACK                        939</span>

<span class="cp">#define HPI6000_ERROR_INIT_PLDTEST1                     941</span>
<span class="cp">#define HPI6000_ERROR_INIT_PLDTEST2                     942</span>

<span class="cm">/* local defines */</span>

<span class="cp">#define HIDE_PCI_ASSERTS</span>
<span class="cp">#define PROFILE_DSP2</span>

<span class="cm">/* for PCI2040 i/f chip */</span>
<span class="cm">/* HPI CSR registers */</span>
<span class="cm">/* word offsets from CSR base */</span>
<span class="cm">/* use when io addresses defined as u32 * */</span>

<span class="cp">#define INTERRUPT_EVENT_SET     0</span>
<span class="cp">#define INTERRUPT_EVENT_CLEAR   1</span>
<span class="cp">#define INTERRUPT_MASK_SET      2</span>
<span class="cp">#define INTERRUPT_MASK_CLEAR    3</span>
<span class="cp">#define HPI_ERROR_REPORT        4</span>
<span class="cp">#define HPI_RESET               5</span>
<span class="cp">#define HPI_DATA_WIDTH          6</span>

<span class="cp">#define MAX_DSPS 2</span>
<span class="cm">/* HPI registers, spaced 8K bytes = 2K words apart */</span>
<span class="cp">#define DSP_SPACING             0x800</span>

<span class="cp">#define CONTROL                 0x0000</span>
<span class="cp">#define ADDRESS                 0x0200</span>
<span class="cp">#define DATA_AUTOINC            0x0400</span>
<span class="cp">#define DATA                    0x0600</span>

<span class="cp">#define TIMEOUT 500000</span>

<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="p">{</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHPI_control</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHPI_address</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHPI_data</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prHPI_data_auto_inc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c_dsp_rev</span><span class="p">;</span>		<span class="cm">/*A, B */</span>
	<span class="n">u32</span> <span class="n">control_cache_address_on_dsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control_cache_length_on_dsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pa_parent_adapter</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="p">{</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dw2040_HPICSR</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dw2040_HPIDSP</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">num_dsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="n">ado</span><span class="p">[</span><span class="n">MAX_DSPS</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">message_buffer_address_on_dsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">response_buffer_address_on_dsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pCI2040HPI_error_count</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hpi_control_cache_single</span> <span class="n">control_cache</span><span class="p">[</span><span class="n">HPI_NMIXER_CONTROLS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hpi_control_cache</span> <span class="o">*</span><span class="n">p_cache</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">hpi6000_dsp_block_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hpi_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">hpi6000_dsp_block_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hpi_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_adapter_boot_load_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">read_or_write</span><span class="p">);</span>
<span class="cp">#define H6READ 1</span>
<span class="cp">#define H6WRITE 0</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_update_control_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_message_response_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">ack_value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">host_cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">hpi6000_get_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpi_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpi_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpi_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">subsys_create_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">adapter_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">adapter_get_asserts</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">create_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">delete_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">);</span>

<span class="cm">/* local globals */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">gw_pci_read_asserts</span><span class="p">;</span>	<span class="cm">/* used to count PCI2040 errors */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">gw_pci_write_asserts</span><span class="p">;</span>	<span class="cm">/* used to count PCI2040 errors */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_SUBSYS_CREATE_ADAPTER</span>:
		<span class="n">subsys_create_adapter</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">control_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_GET_STATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hpi6000_update_control_cache</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">HPI_ERROR_BACKEND_BASE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span>
						<span class="n">HPI_ERROR_CONTROL_CACHING</span><span class="p">;</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hpi_check_control_cache</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_CONTROL_SET_STATE</span>:
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="n">hpi_cmn_control_cache_sync_to_msg</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HPI_CONTROL_GET_INFO</span>:
	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_GET_ASSERT</span>:
		<span class="n">adapter_get_asserts</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HPI_ADAPTER_DELETE</span>:
		<span class="n">adapter_delete</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outstream_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_HOSTBUFFER_ALLOC</span>:
	<span class="k">case</span> <span class="n">HPI_OSTREAM_HOSTBUFFER_FREE</span>:
		<span class="cm">/* Don&#39;t let these messages go to the HW function because</span>
<span class="cm">		 * they&#39;re called without locking the spinlock.</span>
<span class="cm">		 * For the HPI6000 adapters the HW would return</span>
<span class="cm">		 * HPI_ERROR_INVALID_FUNC anyway.</span>
<span class="cm">		 */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instream_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_HOSTBUFFER_ALLOC</span>:
	<span class="k">case</span> <span class="n">HPI_ISTREAM_HOSTBUFFER_FREE</span>:
		<span class="cm">/* Don&#39;t let these messages go to the HW function because</span>
<span class="cm">		 * they&#39;re called without locking the spinlock.</span>
<span class="cm">		 * For the HPI6000 adapters the HW would return</span>
<span class="cm">		 * HPI_ERROR_INVALID_FUNC anyway.</span>
<span class="cm">		 */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_FUNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/** HPI_6000()</span>
<span class="cm"> * Entry point from HPIMAN</span>
<span class="cm"> * All calls to the HPI start here</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">HPI_6000</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">!=</span> <span class="n">HPI_OBJ_SUBSYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pao</span> <span class="o">=</span> <span class="n">hpi_find_adapter</span><span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pao</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
				<span class="n">HPI_ERROR_BAD_ADAPTER_NUMBER</span><span class="p">);</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;invalid adapter index: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Don&#39;t even try to communicate with crashed DSP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
				<span class="n">HPI_ERROR_DSP_HARDWARE</span><span class="p">);</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;adapter %d dsp crashed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phm</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Init default response including the size field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">HPI_SUBSYS_CREATE_ADAPTER</span><span class="p">)</span>
		<span class="n">hpi_init_response</span><span class="p">(</span><span class="n">phr</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
			<span class="n">HPI_ERROR_PROCESSING_MESSAGE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_TYPE_REQUEST</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPI_OBJ_SUBSYSTEM</span>:
			<span class="n">subsys_message</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_ADAPTER</span>:
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_res</span><span class="p">);</span>
			<span class="n">adapter_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_CONTROL</span>:
			<span class="n">control_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_OSTREAM</span>:
			<span class="n">outstream_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HPI_OBJ_ISTREAM</span>:
			<span class="n">instream_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_INVALID_TYPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/* SUBSYSTEM */</span>

<span class="cm">/* create an adapter object and initialise it based on resource information</span>
<span class="cm"> * passed in in the message</span>
<span class="cm"> * NOTE - you cannot use this function AND the FindAdapters function at the</span>
<span class="cm"> * same time, the application must use only one of them to get the adapters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">subsys_create_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* create temp adapter obj, because we don&#39;t know what index yet */</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="n">ao</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">os_error_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;subsys_create_adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ao</span><span class="p">));</span>

	<span class="n">ao</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_hw_obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ao</span><span class="p">.</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;can&#39;t get mem for adapter object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_MEMORY_ALLOC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create the adapter object based on the resource information */</span>
	<span class="n">ao</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="o">*</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_adapter_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os_error_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delete_adapter_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">HPI_ERROR_BACKEND_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_DSP_BOOTLOAD</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">os_error_code</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* need to update paParentAdapter */</span>
	<span class="n">pao</span> <span class="o">=</span> <span class="n">hpi_find_adapter</span><span class="p">(</span><span class="n">ao</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pao</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We just added this adapter, why can&#39;t we find it!? */</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;lost adapter after boot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_BAD_ADAPTER</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dsp_index</span> <span class="o">&lt;</span> <span class="n">MAX_DSPS</span><span class="p">;</span> <span class="n">dsp_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">pa_parent_adapter</span> <span class="o">=</span> <span class="n">pao</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ao</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adapter_index</span> <span class="o">=</span> <span class="n">ao</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">delete_adapter_obj</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="n">hpi_delete_adapter</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this routine is called from SubSysFindAdapter and SubSysCreateAdapter */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="nf">create_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">boot_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control_cache_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control_cache_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* The PCI2040 has the following address map */</span>
	<span class="cm">/* BAR0 - 4K = HPI control and status registers on PCI2040 (HPI CSR) */</span>
	<span class="cm">/* BAR1 - 32K = HPI registers on DSP */</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">ap_mem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;csr %p, dsp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span><span class="p">,</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span><span class="p">);</span>

	<span class="cm">/* set addresses for the possible DSP HPI interfaces */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dsp_index</span> <span class="o">&lt;</span> <span class="n">MAX_DSPS</span><span class="p">;</span> <span class="n">dsp_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_control</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span> <span class="o">+</span> <span class="p">(</span><span class="n">CONTROL</span> <span class="o">+</span>
			<span class="n">DSP_SPACING</span> <span class="o">*</span> <span class="n">dsp_index</span><span class="p">);</span>

		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_address</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span> <span class="o">+</span> <span class="p">(</span><span class="n">ADDRESS</span> <span class="o">+</span>
			<span class="n">DSP_SPACING</span> <span class="o">*</span> <span class="n">dsp_index</span><span class="p">);</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_data</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span> <span class="o">+</span> <span class="p">(</span><span class="n">DATA</span> <span class="o">+</span> <span class="n">DSP_SPACING</span> <span class="o">*</span> <span class="n">dsp_index</span><span class="p">);</span>

		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_data_auto_inc</span> <span class="o">=</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPIDSP</span> <span class="o">+</span> <span class="p">(</span><span class="n">DATA_AUTOINC</span> <span class="o">+</span>
			<span class="n">DSP_SPACING</span> <span class="o">*</span> <span class="n">dsp_index</span><span class="p">);</span>

		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;ctl %p, adr %p, dat %p, dat++ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_control</span><span class="p">,</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_address</span><span class="p">,</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_data</span><span class="p">,</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">prHPI_data_auto_inc</span><span class="p">);</span>

		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">].</span><span class="n">pa_parent_adapter</span> <span class="o">=</span> <span class="n">pao</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">pCI2040HPI_error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the default number of DSPs on this card */</span>
	<span class="cm">/* This is (conditionally) adjusted after bootloading */</span>
	<span class="cm">/* of the first DSP in the bootload section. */</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">num_dsp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">boot_error</span> <span class="o">=</span> <span class="n">hpi6000_adapter_boot_load_dsp</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">pos_error_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">boot_error</span><span class="p">;</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;bootload DSP OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">message_buffer_address_on_dsp</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">response_buffer_address_on_dsp</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

	<span class="cm">/* get info about the adapter by asking the adapter */</span>
	<span class="cm">/* send a HPI_ADAPTER_GET_INFO message */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpi_message</span> <span class="n">hm</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hpi_response</span> <span class="n">hr0</span><span class="p">;</span>	<span class="cm">/* response from DSP 0 */</span>
		<span class="k">struct</span> <span class="n">hpi_response</span> <span class="n">hr1</span><span class="p">;</span>	<span class="cm">/* response from DSP 1 */</span>
		<span class="n">u16</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;send ADAPTER_GET_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hm</span><span class="p">));</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">HPI_TYPE_REQUEST</span><span class="p">;</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_message</span><span class="p">);</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">HPI_OBJ_ADAPTER</span><span class="p">;</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_GET_INFO</span><span class="p">;</span>
		<span class="n">hm</span><span class="p">.</span><span class="n">adapter_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr0</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr1</span><span class="p">));</span>
		<span class="n">hr0</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr0</span><span class="p">);</span>
		<span class="n">hr1</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hr1</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hr0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hr0</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;message error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hr0</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">hr0</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">num_dsp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hm</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hr1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">hr0</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_type</span><span class="p">;</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hr0</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">adapter_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_control_cache_single</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">HPI_NMIXER_CONTROLS</span><span class="p">);</span>
	<span class="cm">/* Read the control cache length to figure out if it is turned on */</span>
	<span class="n">control_cache_size</span> <span class="o">=</span>
		<span class="n">hpi_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">control_cache_size_in_bytes</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control_cache_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control_cache_count</span> <span class="o">=</span>
			<span class="n">hpi_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">control_cache_count</span><span class="p">));</span>

		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span> <span class="o">=</span>
			<span class="n">hpi_alloc_control_cache</span><span class="p">(</span><span class="n">control_cache_count</span><span class="p">,</span>
			<span class="n">control_cache_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">)</span>
			<span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">&quot;get adapter info ASI%04X index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">)</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="o">-&gt;</span><span class="n">adap_idx</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hpi_add_adapter</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_adapter_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">has_control_cache</span><span class="p">)</span>
		<span class="n">hpi_free_control_cache</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">p_cache</span><span class="p">);</span>

	<span class="cm">/* reset DSPs on adapter */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0003000F</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">phw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/* ADAPTER */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_get_asserts</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef HIDE_PCI_ASSERTS</span>
	<span class="cm">/* if we have PCI2040 asserts then collect them */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gw_pci_read_asserts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">gw_pci_write_asserts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span>
			<span class="n">gw_pci_read_asserts</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">gw_pci_write_asserts</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* assert count */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* &quot;dsp index&quot; */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">sz_message</span><span class="p">,</span> <span class="s">&quot;PCI2040 error&quot;</span><span class="p">);</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">dsp_msg_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gw_pci_read_asserts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gw_pci_write_asserts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">hw_message</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>	<span class="cm">/*get DSP asserts */</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/* LOW-LEVEL */</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_adapter_boot_load_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pos_error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw2040_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">endian</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adapter_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_code</span> <span class="n">dsp_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">boot_load_family</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NOTE don&#39;t use wAdapterType in this routine. It is not setup yet */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x5100</span>:
	<span class="k">case</span> <span class="mh">0x5110</span>:	<span class="cm">/* ASI5100 revB or higher with C6711D */</span>
	<span class="k">case</span> <span class="mh">0x5200</span>:	<span class="cm">/* ASI5200 PCIe version of ASI5100 */</span>
	<span class="k">case</span> <span class="mh">0x6100</span>:
	<span class="k">case</span> <span class="mh">0x6200</span>:
		<span class="n">boot_load_family</span> <span class="o">=</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6200</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_UNHANDLED_SUBSYS_ID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset all DSPs, indicate two DSPs are present</span>
<span class="cm">	 * set RST3-=1 to disconnect HAD8 to set DSP in little endian mode</span>
<span class="cm">	 */</span>
	<span class="n">endian</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dw2040_reset</span> <span class="o">=</span> <span class="mh">0x0003000F</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dw2040_reset</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>

	<span class="cm">/* read back register to make sure PCI2040 chip is functioning</span>
<span class="cm">	 * note that bits 4..15 are read-only and so should always return zero,</span>
<span class="cm">	 * even though we wrote 1 to them</span>
<span class="cm">	 */</span>
	<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">!=</span> <span class="n">dw2040_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;INIT_PCI2040 %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw2040_reset</span><span class="p">,</span>
			<span class="n">delay</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_PCI2040</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Indicate that DSP#0,1 is a C6X */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000003</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_DATA_WIDTH</span><span class="p">);</span>
	<span class="cm">/* set Bit30 and 29 - which will prevent Target aborts from being</span>
<span class="cm">	 * issued upon HPI or GP error</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x60000000</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">INTERRUPT_MASK_SET</span><span class="p">);</span>

	<span class="cm">/* isolate DSP HAD8 line from PCI2040 so that</span>
<span class="cm">	 * Little endian can be set by pullup</span>
<span class="cm">	 */</span>
	<span class="n">dw2040_reset</span> <span class="o">=</span> <span class="n">dw2040_reset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">endian</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dw2040_reset</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>

	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c_dsp_rev</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>	<span class="cm">/* revB */</span>
	<span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c_dsp_rev</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>	<span class="cm">/* revB */</span>

	<span class="cm">/*Take both DSPs out of reset, setting HAD8 to the correct Endian */</span>
	<span class="n">dw2040_reset</span> <span class="o">=</span> <span class="n">dw2040_reset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x00000001</span><span class="p">);</span>	<span class="cm">/* start DSP 0 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dw2040_reset</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>
	<span class="n">dw2040_reset</span> <span class="o">=</span> <span class="n">dw2040_reset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x00000002</span><span class="p">);</span>	<span class="cm">/* start DSP 1 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dw2040_reset</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>

	<span class="cm">/* set HAD8 back to PCI2040, now that DSP set to little endian mode */</span>
	<span class="n">dw2040_reset</span> <span class="o">=</span> <span class="n">dw2040_reset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x00000008</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dw2040_reset</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_RESET</span><span class="p">);</span>
	<span class="cm">/*delay to allow DSP to get going */</span>
	<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* loop through all DSPs, downloading DSP code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dsp_index</span> <span class="o">&lt;</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">num_dsp</span><span class="p">;</span> <span class="n">dsp_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>

		<span class="cm">/* configure DSP so that we download code into the SRAM */</span>
		<span class="cm">/* set control reg for little endian, HWOB=1 */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00010001</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_control</span><span class="p">);</span>

		<span class="cm">/* test access to the HPI address register (HPIA) */</span>
		<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_address</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;INIT_DSPHPI %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">test_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_DSPHPI</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cm">/* if C6713 the setup PLL to generate 225MHz from 25MHz.</span>
<span class="cm">* Since the PLLDIV1 read is sometimes wrong, even on a C6713,</span>
<span class="cm">* we&#39;re going to do this unconditionally</span>
<span class="cm">*/</span>
<span class="cm">/* PLLDIV1 should have a value of 8000 after reset */</span>
<span class="cm">/*</span>
<span class="cm">	if (HpiReadWord(pdo,0x01B7C118) == 0x8000)</span>
<span class="cm">*/</span>
		<span class="p">{</span>
			<span class="cm">/* C6713 datasheet says we cannot program PLL from HPI,</span>
<span class="cm">			 * and indeed if we try to set the PLL multiply from the</span>
<span class="cm">			 * HPI, the PLL does not seem to lock,</span>
<span class="cm">			 * so we enable the PLL and use the default of x 7</span>
<span class="cm">			 */</span>
			<span class="cm">/* bypass PLL */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01B7C100</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="cm">/*  ** use default of PLL  x7 ** */</span>
			<span class="cm">/* EMIF = 225/3=75MHz */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01B7C120</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">);</span>
			<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="cm">/* peri = 225/2 */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01B7C11C</span><span class="p">,</span> <span class="mh">0x8001</span><span class="p">);</span>
			<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="cm">/* cpu  = 225/1 */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01B7C118</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

			<span class="cm">/* ~2ms delay */</span>
			<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

			<span class="cm">/* PLL not bypassed */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01B7C100</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
			<span class="cm">/* ~2ms delay */</span>
			<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* test r/w to internal DSP memory</span>
<span class="cm">		 * C6711 has L2 cache mapped to 0x0 when reset</span>
<span class="cm">		 *</span>
<span class="cm">		 *  revB - because of bug 3.0.1 last HPI read</span>
<span class="cm">		 * (before HPI address issued) must be non-autoinc</span>
<span class="cm">		 */</span>
		<span class="cm">/* test each bit in the 32bit word */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
						<span class="s">&quot;DSP mem %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
						<span class="n">data</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">);</span>

					<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_DSPINTMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* memory map of ASI6200</span>
<span class="cm">		   00000000-0000FFFF    16Kx32 internal program</span>
<span class="cm">		   01800000-019FFFFF    Internal peripheral</span>
<span class="cm">		   80000000-807FFFFF    CE0 2Mx32 SDRAM running @ 100MHz</span>
<span class="cm">		   90000000-9000FFFF    CE1 Async peripherals:</span>

<span class="cm">		   EMIF config</span>
<span class="cm">		   ------------</span>
<span class="cm">		   Global EMIF control</span>
<span class="cm">		   0 -</span>
<span class="cm">		   1 -</span>
<span class="cm">		   2 -</span>
<span class="cm">		   3 CLK2EN = 1   CLKOUT2 enabled</span>
<span class="cm">		   4 CLK1EN = 0   CLKOUT1 disabled</span>
<span class="cm">		   5 EKEN = 1 &lt;--!! C6713 specific, enables ECLKOUT</span>
<span class="cm">		   6 -</span>
<span class="cm">		   7 NOHOLD = 1   external HOLD disabled</span>
<span class="cm">		   8 HOLDA = 0    HOLDA output is low</span>
<span class="cm">		   9 HOLD = 0             HOLD input is low</span>
<span class="cm">		   10 ARDY = 1    ARDY input is high</span>
<span class="cm">		   11 BUSREQ = 0   BUSREQ output is low</span>
<span class="cm">		   12,13 Reserved = 1</span>
<span class="cm">		 */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01800000</span><span class="p">,</span> <span class="mh">0x34A8</span><span class="p">);</span>

		<span class="cm">/* EMIF CE0 setup - 2Mx32 Sync DRAM</span>
<span class="cm">		   31..28       Wr setup</span>
<span class="cm">		   27..22       Wr strobe</span>
<span class="cm">		   21..20       Wr hold</span>
<span class="cm">		   19..16       Rd setup</span>
<span class="cm">		   15..14       -</span>
<span class="cm">		   13..8        Rd strobe</span>
<span class="cm">		   7..4         MTYPE   0011            Sync DRAM 32bits</span>
<span class="cm">		   3            Wr hold MSB</span>
<span class="cm">		   2..0         Rd hold</span>
<span class="cm">		 */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01800008</span><span class="p">,</span> <span class="mh">0x00000030</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM Extension</span>
<span class="cm">		   31-21        0</span>
<span class="cm">		   20           WR2RD = 0</span>
<span class="cm">		   19-18        WR2DEAC = 1</span>
<span class="cm">		   17           WR2WR = 0</span>
<span class="cm">		   16-15        R2WDQM = 2</span>
<span class="cm">		   14-12        RD2WR = 4</span>
<span class="cm">		   11-10        RD2DEAC = 1</span>
<span class="cm">		   9            RD2RD = 1</span>
<span class="cm">		   8-7          THZP = 10b</span>
<span class="cm">		   6-5          TWR  = 2-1 = 01b (tWR = 10ns)</span>
<span class="cm">		   4            TRRD = 0b = 2 ECLK (tRRD = 14ns)</span>
<span class="cm">		   3-1          TRAS = 5-1 = 100b (Tras=42ns = 5 ECLK)</span>
<span class="cm">		   1            CAS latency = 3 ECLK</span>
<span class="cm">		   (for Micron 2M32-7 operating at 100Mhz)</span>
<span class="cm">		 */</span>

		<span class="cm">/* need to use this else DSP code crashes */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01800020</span><span class="p">,</span> <span class="mh">0x001BDF29</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM control - set up for a 2Mx32 SDRAM (512x32x4 bank)</span>
<span class="cm">		   31           -               -</span>
<span class="cm">		   30           SDBSZ   1               4 bank</span>
<span class="cm">		   29..28       SDRSZ   00              11 row address pins</span>
<span class="cm">		   27..26       SDCSZ   01              8 column address pins</span>
<span class="cm">		   25           RFEN    1               refersh enabled</span>
<span class="cm">		   24           INIT    1               init SDRAM</span>
<span class="cm">		   23..20       TRCD    0001</span>
<span class="cm">		   19..16       TRP             0001</span>
<span class="cm">		   15..12       TRC             0110</span>
<span class="cm">		   11..0        -               -</span>
<span class="cm">		 */</span>
		<span class="cm">/*      need to use this else DSP code crashes */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01800018</span><span class="p">,</span> <span class="mh">0x47117000</span><span class="p">);</span>

		<span class="cm">/* EMIF SDRAM Refresh Timing */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x0180001C</span><span class="p">,</span> <span class="mh">0x00000410</span><span class="p">);</span>

		<span class="cm">/*MIF CE1 setup - Async peripherals</span>
<span class="cm">		   @100MHz bus speed, each cycle is 10ns,</span>
<span class="cm">		   31..28       Wr setup  = 1</span>
<span class="cm">		   27..22       Wr strobe = 3                   30ns</span>
<span class="cm">		   21..20       Wr hold = 1</span>
<span class="cm">		   19..16       Rd setup =1</span>
<span class="cm">		   15..14       Ta = 2</span>
<span class="cm">		   13..8        Rd strobe = 3                   30ns</span>
<span class="cm">		   7..4         MTYPE   0010            Async 32bits</span>
<span class="cm">		   3            Wr hold MSB =0</span>
<span class="cm">		   2..0         Rd hold = 1</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">cE1</span> <span class="o">=</span>
				<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3L</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span>
				<span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3L</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2L</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1L</span><span class="p">;</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="mh">0x01800004</span><span class="p">,</span> <span class="n">cE1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* delay a little to allow SDRAM and DSP to &quot;get going&quot; */</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="cm">/* test access to SDRAM */</span>
		<span class="p">{</span>
			<span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
			<span class="cm">/* test each bit in the 32bit word */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
						<span class="s">&quot;DSP dram %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">test_addr</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						<span class="n">dsp_index</span><span class="p">);</span>

					<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_SDRAM1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* test every Nth address in the DRAM */</span>
<span class="cp">#define DRAM_SIZE_WORDS 0x200000	</span><span class="cm">/*2_mx32 */</span><span class="cp"></span>
<span class="cp">#define DRAM_INC 1024</span>
			<span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRAM_SIZE_WORDS</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">DRAM_INC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
				<span class="n">test_data</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRAM_SIZE_WORDS</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">DRAM_INC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
						<span class="s">&quot;DSP dram %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">test_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
						<span class="n">data</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_SDRAM2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">test_data</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="cm">/* write the DSP code down into the DSPs memory */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_dsp_code_open</span><span class="p">(</span><span class="n">boot_load_family</span><span class="p">,</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="n">pos_error_code</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pcode</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of code */</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_dsp_code_read_block</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pcode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_dsp_block_write32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">dsp_index</span><span class="p">,</span>
				<span class="n">address</span><span class="p">,</span> <span class="n">pcode</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpi_dsp_code_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* verify that code was written correctly */</span>
		<span class="cm">/* this time through, assume no errors in DSP code file/array */</span>
		<span class="n">hpi_dsp_code_rewind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pcode</span><span class="p">;</span>

			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of code */</span>

			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">hpi_dsp_code_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">hpi_dsp_code_read_block</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcode</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pcode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">HPI6000_ERROR_INIT_VERIFY</span><span class="p">;</span>
					<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span>
						<span class="s">&quot;DSP verify %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">pcode</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						<span class="n">dsp_index</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pcode</span><span class="o">++</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hpi_dsp_code_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* zero out the hostmailbox */</span>
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">address</span> <span class="o">=</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* write the DSP number into the hostmailbox */</span>
		<span class="cm">/* structure before starting the DSP */</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">dsp_number</span><span class="p">),</span> <span class="n">dsp_index</span><span class="p">);</span>

		<span class="cm">/* write the DSP adapter Info into the */</span>
		<span class="cm">/* hostmailbox before starting the DSP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">adapter_info</span><span class="p">),</span>
				<span class="n">adapter_info</span><span class="p">);</span>

		<span class="cm">/* step 3. Start code by sending interrupt */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00030003</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_control</span><span class="p">);</span>
		<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>

		<span class="cm">/* wait for a non-zero value in hostcmd -</span>
<span class="cm">		 * indicating initialization is complete</span>
<span class="cm">		 *</span>
<span class="cm">		 * Init could take a while if DSP checks SDRAM memory</span>
<span class="cm">		 * Was 200000. Increased to 2000000 for ASI8801 so we</span>
<span class="cm">		 * don&#39;t get 938 errors.</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">read</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
					<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span>
				<span class="o">&amp;&amp;</span> <span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span>
					<span class="n">H6READ</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* The following is a workaround for bug #94:</span>
<span class="cm">			 * Bluescreen on install and subsequent boots on a</span>
<span class="cm">			 * DELL PowerEdge 600SC PC with 1.8GHz P4 and</span>
<span class="cm">			 * ServerWorks chipset. Without this delay the system</span>
<span class="cm">			 * locks up with a bluescreen (NOT GPF or pagefault).</span>
<span class="cm">			 */</span>
			<span class="k">else</span>
				<span class="n">hpios_delay_micro_seconds</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_NOACK</span><span class="p">;</span>

		<span class="cm">/* read the DSP adapter Info from the */</span>
		<span class="cm">/* hostmailbox structure after starting the DSP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*u32 dwTestData=0; */</span>
			<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">adapter_info</span> <span class="o">=</span>
				<span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">adapter_info</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HPI_ADAPTER_FAMILY_ASI</span>
				<span class="p">(</span><span class="n">HPI_HIF_ADAPTER_INFO_EXTRACT_ADAPTER</span>
					<span class="p">(</span><span class="n">adapter_info</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6200</span><span class="p">))</span>
				<span class="cm">/* all 6200 cards have this many DSPs */</span>
				<span class="n">phw</span><span class="o">-&gt;</span><span class="n">num_dsp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="cm">/* test that the PLD is programmed */</span>
			<span class="cm">/* and we can read/write 24bits */</span>
<span class="cp">#define PLD_BASE_ADDRESS 0x90000000L	</span><span class="cm">/*for ASI6100/6200/8800 */</span><span class="cp"></span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">boot_load_family</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x6200</span><span class="p">)</span>:
				<span class="cm">/* ASI6100/6200 has 24bit path to FPGA */</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFFFFFF00L</span><span class="p">;</span>
				<span class="cm">/* ASI5100 uses AX6 code, */</span>
				<span class="cm">/* but has no PLD r/w register to test */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span>
						<span class="n">subsystem_device</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5100</span><span class="p">))</span>
					<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00000000L</span><span class="p">;</span>
				<span class="cm">/* ASI5200 uses AX6 code, */</span>
				<span class="cm">/* but has no PLD r/w register to test */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">pci_dev</span><span class="o">-&gt;</span>
						<span class="n">subsystem_device</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x5200</span><span class="p">))</span>
					<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00000000L</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HPI_ADAPTER_FAMILY_ASI</span><span class="p">(</span><span class="mh">0x8800</span><span class="p">)</span>:
				<span class="cm">/* ASI8800 has 16bit path to FPGA */</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFFFF0000L</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0xAAAAAA00L</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="cm">/* write to 24 bit Debug register (D31-D8) */</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">PLD_BASE_ADDRESS</span> <span class="o">+</span> <span class="mi">4L</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
			<span class="n">read</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">PLD_BASE_ADDRESS</span> <span class="o">+</span> <span class="mi">4L</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;PLD %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
					<span class="n">read</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_PLDTEST1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_data</span> <span class="o">=</span> <span class="mh">0x55555500L</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">PLD_BASE_ADDRESS</span> <span class="o">+</span> <span class="mi">4L</span><span class="p">,</span> <span class="n">test_data</span><span class="p">);</span>
			<span class="n">read</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">PLD_BASE_ADDRESS</span> <span class="o">+</span> <span class="mi">4L</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">!=</span> <span class="n">test_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HPI_DEBUG_LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;PLD %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
					<span class="n">read</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">HPI6000_ERROR_INIT_PLDTEST2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>	<span class="cm">/* for numDSP */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PCI_TIMEOUT 100</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpi_set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PCI_TIMEOUT</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">pa_parent_adapter</span><span class="p">,</span>
			<span class="n">H6WRITE</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write one word to the HPI port */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpi_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read one word from the HPI port */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">hpi_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*? No way to return error */</span>

	<span class="cm">/* take care of errata in revB DSP (2.0.1) */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write a block of 32bit words to the DSP HPI port using auto-inc mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpi_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">length16</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iowrite32_rep</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data_auto_inc</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">length16</span><span class="p">);</span>

	<span class="cm">/* take care of errata in revB DSP (2.0.1) */</span>
	<span class="cm">/* must end with non auto-inc */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pdata</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** read a block of 32bit words from the DSP HPI port using auto-inc mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpi_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">length16</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ioread32_rep</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data_auto_inc</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">length16</span><span class="p">);</span>

	<span class="cm">/* take care of errata in revB DSP (2.0.1) */</span>
	<span class="cm">/* must end with non auto-inc */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">pdata</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">hpi6000_dsp_block_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hpi_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">time_out</span> <span class="o">=</span> <span class="n">PCI_TIMEOUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c6711_burst_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_hpi_address</span> <span class="o">=</span> <span class="n">hpi_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xfer_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">local_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local_count</span> <span class="o">&gt;</span> <span class="n">c6711_burst_size</span><span class="p">)</span>
			<span class="n">xfer_size</span> <span class="o">=</span> <span class="n">c6711_burst_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">xfer_size</span> <span class="o">=</span> <span class="n">local_count</span><span class="p">;</span>

		<span class="n">time_out</span> <span class="o">=</span> <span class="n">PCI_TIMEOUT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">hpi_write_block</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">local_hpi_address</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span>
				<span class="n">xfer_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6WRITE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">time_out</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pdata</span> <span class="o">+=</span> <span class="n">xfer_size</span><span class="p">;</span>
		<span class="n">local_hpi_address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">xfer_size</span><span class="p">;</span>
		<span class="n">local_count</span> <span class="o">-=</span> <span class="n">xfer_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">hpi6000_dsp_block_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hpi_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">time_out</span> <span class="o">=</span> <span class="n">PCI_TIMEOUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c6711_burst_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_hpi_address</span> <span class="o">=</span> <span class="n">hpi_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xfer_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loop_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">local_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local_count</span> <span class="o">&gt;</span> <span class="n">c6711_burst_size</span><span class="p">)</span>
			<span class="n">xfer_size</span> <span class="o">=</span> <span class="n">c6711_burst_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">xfer_size</span> <span class="o">=</span> <span class="n">local_count</span><span class="p">;</span>

		<span class="n">time_out</span> <span class="o">=</span> <span class="n">PCI_TIMEOUT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">hpi_read_block</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">local_hpi_address</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span>
				<span class="n">xfer_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">time_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pdata</span> <span class="o">+=</span> <span class="n">xfer_size</span><span class="p">;</span>
		<span class="n">local_hpi_address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">xfer_size</span><span class="p">;</span>
		<span class="n">local_count</span> <span class="o">-=</span> <span class="n">xfer_size</span><span class="p">;</span>
		<span class="n">loop_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_message_response_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ack</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_IDLE_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pao</span><span class="o">-&gt;</span><span class="n">dsp_crashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the message address and size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">message_buffer_address_on_dsp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span>
				<span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">message_buffer_address</span><span class="p">));</span>
			<span class="n">phw</span><span class="o">-&gt;</span><span class="n">message_buffer_address_on_dsp</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_GET_ADR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">message_buffer_address_on_dsp</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="cm">/* send the message */</span>
	<span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">phm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_dsp_block_write32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_BLOCKWRITE32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_GET_RESP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_GETRESPCMD</span><span class="p">;</span>
	<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

	<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_GET_RESP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_GET_RESP_ACK</span><span class="p">;</span>

	<span class="cm">/* get the response address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">response_buffer_address_on_dsp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span>
				<span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">response_buffer_address</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">response_buffer_address_on_dsp</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_RESP_GET_ADR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">response_buffer_address_on_dsp</span><span class="p">;</span>

	<span class="cm">/* read the length of the response back from the DSP */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">length</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response</span><span class="p">);</span>

	<span class="cm">/* get the response */</span>
	<span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">phr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_dsp_block_read32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_BLOCKREAD32</span><span class="p">;</span>

	<span class="cm">/* set i/f back to idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_MSG_RESP_IDLECMD</span><span class="p">;</span>
	<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">hpi_validate_response</span><span class="p">(</span><span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* have to set up the below defines to match stuff in the MAP file */</span>

<span class="cp">#define MSG_ADDRESS (HPI_HIF_BASE+0x18)</span>
<span class="cp">#define MSG_LENGTH 11</span>
<span class="cp">#define RESP_ADDRESS (HPI_HIF_BASE+0x44)</span>
<span class="cp">#define RESP_LENGTH 16</span>
<span class="cp">#define QUEUE_START  (HPI_HIF_BASE+0x88)</span>
<span class="cp">#define QUEUE_SIZE 0x8000</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_send_data_check_adr</span><span class="p">(</span><span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length_in_dwords</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*#define CHECKING       // comment this line in to enable checking */</span>
<span class="cp">#ifdef CHECKING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">MSG_ADDRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">QUEUE_START</span> <span class="o">+</span> <span class="n">QUEUE_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">length_in_dwords</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">QUEUE_START</span> <span class="o">+</span> <span class="n">QUEUE_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">length_in_dwords</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">data_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ack</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">time_out</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">phr</span><span class="p">;</span>

	<span class="cm">/* round dwDataSize down to nearest 4 bytes */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">data_sent</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3L</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">time_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_IDLE_TIMEOUT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="n">HPI_HIF_SEND_DATA</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_CMD</span><span class="p">;</span>

		<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

		<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_SEND_DATA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_ACK</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* get the address and size */</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="cm">/* DSP returns number of DWORDS */</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">length</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpi6000_send_data_check_adr</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_ADR</span><span class="p">;</span>

		<span class="cm">/* send the data. break data into 512 DWORD blocks (2K bytes)</span>
<span class="cm">		 * and send using block write. 2Kbytes is the max as this is the</span>
<span class="cm">		 * memory window given to the HPI data register by the PCI2040</span>
<span class="cm">		 */</span>

		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">blk_len</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">blk_len</span><span class="p">)</span>
					<span class="n">blk_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_dsp_block_write32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
						<span class="n">address</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">blk_len</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_WRITE</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="n">blk_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">p_data</span> <span class="o">+=</span> <span class="n">blk_len</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">blk_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_IDLECMD</span><span class="p">;</span>

		<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

		<span class="n">data_sent</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI6000_ERROR_SEND_DATA_TIMEOUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_get_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">data_got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ack</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pb_data</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">phr</span><span class="p">;</span>	<span class="cm">/* this parameter not used! */</span>

	<span class="cm">/* round dwDataSize down to nearest 4 bytes */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">data_got</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3L</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_GET_DATA_IDLE_TIMEOUT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
				<span class="n">HPI_HIF_GET_DATA</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_GET_DATA_CMD</span><span class="p">;</span>
		<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

		<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_GET_DATA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_GET_DATA_ACK</span><span class="p">;</span>

		<span class="cm">/* get the address and size */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">length</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">));</span>

		<span class="cm">/* read the data */</span>
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">blk_len</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">blk_len</span><span class="p">)</span>
					<span class="n">blk_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_dsp_block_read32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span>
						<span class="n">address</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">blk_len</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">HPI6000_ERROR_GET_DATA_READ</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="n">blk_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">p_data</span> <span class="o">+=</span> <span class="n">blk_len</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">blk_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_send_host_command</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">HPI_HIF_IDLE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HPI6000_ERROR_GET_DATA_IDLECMD</span><span class="p">;</span>
		<span class="n">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="n">pdo</span><span class="p">);</span>

		<span class="n">data_got</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpi6000_send_dsp_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00030003</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_control</span><span class="p">);</span>	<span class="cm">/* DSPINT */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_send_host_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">host_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* set command */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">hpi_write_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">),</span> <span class="n">host_cmd</span><span class="p">);</span>
		<span class="cm">/* flush the FIFO */</span>
		<span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>

	<span class="cm">/* reset the interrupt bit */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00040004</span><span class="p">,</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* if the PCI2040 has recorded an HPI timeout, reset the error and return 1 */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">read_or_write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hPI_error</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* read the error bits from the PCI2040 */</span>
	<span class="n">hPI_error</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_ERROR_REPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hPI_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset the error flag */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0L</span><span class="p">,</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">dw2040_HPICSR</span> <span class="o">+</span> <span class="n">HPI_ERROR_REPORT</span><span class="p">);</span>
		<span class="n">phw</span><span class="o">-&gt;</span><span class="n">pCI2040HPI_error_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_or_write</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">gw_pci_read_asserts</span><span class="o">++</span><span class="p">;</span>	   <span class="cm">/************* inc global */</span>
		<span class="k">else</span>
			<span class="n">gw_pci_write_asserts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_wait_dsp_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsp_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">ack_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hPIC</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

	<span class="cm">/* wait for host interrupt to signal ack is ready */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hPIC</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prHPI_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hPIC</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>	<span class="cm">/* 0x04 = HINT from DSP */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">;</span>

	<span class="cm">/* wait for dwAckValue */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read the ack mailbox */</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">dsp_ack</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="n">ack_value</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*for (i=0;i&lt;1000;i++) */</span>
		<span class="cm">/*      dwPause=i+1; */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">)</span>
		<span class="cm">/* indicates bad read from DSP -</span>
<span class="cm">		   typically 0xffffff is read for some reason */</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">HPI_HIF_ERROR_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">ack</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">hpi6000_update_control_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="n">pdo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">ado</span><span class="p">[</span><span class="n">dsp_index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cache_dirty_flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hpios_dsplock_lock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cache_dirty_flag</span> <span class="o">=</span>
			<span class="n">hpi_read_word</span><span class="p">((</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">pdo</span><span class="p">,</span>
			<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">control_cache_is_dirty</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">HPI6000_ERROR_CONTROL_CACHE_PARAMS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_dirty_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read the cached controls */</span>
		<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">control_cache_address_on_dsp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">address</span> <span class="o">=</span>
					<span class="n">hpi_read_word</span><span class="p">((</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">pdo</span><span class="p">,</span>
					<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">control_cache_address</span><span class="p">));</span>

				<span class="n">length</span> <span class="o">=</span> <span class="n">hpi_read_word</span><span class="p">((</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">pdo</span><span class="p">,</span>
					<span class="n">HPI_HIF_ADDR</span>
					<span class="p">(</span><span class="n">control_cache_size_in_bytes</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6READ</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">HPI6000_ERROR_CONTROL_CACHE_ADDRLEN</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pdo</span><span class="o">-&gt;</span><span class="n">control_cache_address_on_dsp</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
			<span class="n">pdo</span><span class="o">-&gt;</span><span class="n">control_cache_length_on_dsp</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">control_cache_address_on_dsp</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">pdo</span><span class="o">-&gt;</span><span class="n">control_cache_length_on_dsp</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpi6000_dsp_block_read32</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phw</span><span class="o">-&gt;</span><span class="n">control_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">HPI6000_ERROR_CONTROL_CACHE_READ</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">hpi_write_word</span><span class="p">((</span><span class="k">struct</span> <span class="n">dsp_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">pdo</span><span class="p">,</span>
				<span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">control_cache_is_dirty</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* flush the FIFO */</span>
			<span class="n">hpi_set_address</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span> <span class="n">HPI_HIF_ADDR</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hpi6000_check_PCI2040_error_flag</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">H6WRITE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">HPI6000_ERROR_CONTROL_CACHE_FLUSH</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hpios_dsplock_unlock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Get dsp index for multi DSP adapters only */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_dsp_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_OBJ_ISTREAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_OBJ_PROFILE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">obj_index</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Complete transaction with DSP</span>

<span class="cm">Send message, get response, send or get stream data if any.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_adapter_obj</span> <span class="o">*</span><span class="n">pao</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpi_message</span> <span class="o">*</span><span class="n">phm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">hpi_response</span> <span class="o">*</span><span class="n">phr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpi_hw_obj</span> <span class="o">*</span><span class="n">phw</span> <span class="o">=</span> <span class="n">pao</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">num_dsp</span> <span class="o">=</span> <span class="n">phw</span><span class="o">-&gt;</span><span class="n">num_dsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_dsp</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dsp_index</span> <span class="o">=</span> <span class="n">get_dsp_index</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">phm</span><span class="p">);</span>

		<span class="cm">/* is this  checked on the DSP anyway? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">HPI_ISTREAM_GROUP_ADD</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">HPI_OSTREAM_GROUP_ADD</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hpi_message</span> <span class="n">hm</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">add_index</span><span class="p">;</span>
			<span class="n">hm</span><span class="p">.</span><span class="n">obj_index</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">stream_index</span><span class="p">;</span>
			<span class="n">hm</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">phm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">object_type</span><span class="p">;</span>
			<span class="n">add_index</span> <span class="o">=</span> <span class="n">get_dsp_index</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">add_index</span> <span class="o">!=</span> <span class="n">dsp_index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_NO_INTERDSP_GROUPS</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hpios_dsplock_lock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>	<span class="cm">/* something failed in the HPI/DSP interface */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>	<span class="cm">/* something failed in the DSP */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPI_OSTREAM_WRITE</span>:
	<span class="k">case</span> <span class="n">HPI_ISTREAM_ANC_WRITE</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_send_data</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ISTREAM_READ</span>:
	<span class="k">case</span> <span class="n">HPI_OSTREAM_ANC_READ</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_get_data</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span> <span class="n">dsp_index</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPI_ADAPTER_GET_ASSERT</span>:
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* dsp 0 default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_dsp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no assert from dsp 0, check dsp 1 */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">hpi6000_message_response_sequence</span><span class="p">(</span><span class="n">pao</span><span class="p">,</span>
					<span class="mi">1</span><span class="p">,</span> <span class="n">phm</span><span class="p">,</span> <span class="n">phr</span><span class="p">);</span>
				<span class="n">phr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">dsp_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="n">HPI_ERROR_BACKEND_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">HPI_ERROR_DSP_COMMUNICATION</span><span class="p">;</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">specific_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phr</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* just the header of the response is valid */</span>
		<span class="n">phr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpi_response_header</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">hpios_dsplock_unlock</span><span class="p">(</span><span class="n">pao</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
