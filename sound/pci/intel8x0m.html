<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › intel8x0m.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>intel8x0m.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA modem driver for Intel ICH (i8x0) chipsets</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This is modified (by Sasha Khapyorsky &lt;sashak@alsa-project.org&gt;) version</span>
<span class="cm"> *   of ALSA ICH sound driver intel8x0.c .</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>      

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel 82801AA,82901AB,i810,i820,i830,i840,i845,MX440; &quot;</span>
		   <span class="s">&quot;SiS 7013; NVidia MCP/2/2S/3 modems&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Intel,82801AA-ICH},&quot;</span>
		<span class="s">&quot;{Intel,82901AB-ICH0},&quot;</span>
		<span class="s">&quot;{Intel,82801BA-ICH2},&quot;</span>
		<span class="s">&quot;{Intel,82801CA-ICH3},&quot;</span>
		<span class="s">&quot;{Intel,82801DB-ICH4},&quot;</span>
		<span class="s">&quot;{Intel,ICH5},&quot;</span>
		<span class="s">&quot;{Intel,ICH6},&quot;</span>
		<span class="s">&quot;{Intel,ICH7},&quot;</span>
	        <span class="s">&quot;{Intel,MX440},&quot;</span>
		<span class="s">&quot;{SiS,7013},&quot;</span>
		<span class="s">&quot;{NVidia,NForce Modem},&quot;</span>
		<span class="s">&quot;{NVidia,NForce2 Modem},&quot;</span>
		<span class="s">&quot;{NVidia,NForce2s Modem},&quot;</span>
		<span class="s">&quot;{NVidia,NForce3 Modem},&quot;</span>
		<span class="s">&quot;{AMD,AMD768}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* Exclude the first card */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Intel i8x0 modemcard.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Intel i8x0 modemcard.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codec clock (0 = auto-detect).&quot;</span><span class="p">);</span>

<span class="cm">/* just for backward compatibility */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Direct registers</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">DEVICE_INTEL</span><span class="p">,</span> <span class="n">DEVICE_SIS</span><span class="p">,</span> <span class="n">DEVICE_ALI</span><span class="p">,</span> <span class="n">DEVICE_NFORCE</span> <span class="p">};</span>

<span class="cp">#define ICHREG(x) ICH_REG_##x</span>

<span class="cp">#define DEFINE_REGSET(name,base) \</span>
<span class="cp">enum { \</span>
<span class="cp">	ICH_REG_##name##_BDBAR	= base + 0x0,	</span><span class="cm">/* dword - buffer descriptor list base address */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_CIV	= base + 0x04,	</span><span class="cm">/* byte - current index value */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_LVI	= base + 0x05,	</span><span class="cm">/* byte - last valid index */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_SR	= base + 0x06,	</span><span class="cm">/* byte - status register */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_PICB	= base + 0x08,	</span><span class="cm">/* word - position in current buffer */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_PIV	= base + 0x0a,	</span><span class="cm">/* byte - prefetched index value */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_CR	= base + 0x0b,	</span><span class="cm">/* byte - control register */</span><span class="cp"> \</span>
<span class="cp">};</span>

<span class="cm">/* busmaster blocks */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* offset */</span>

<span class="cm">/* values for each busmaster block */</span>

<span class="cm">/* LVI */</span>
<span class="cp">#define ICH_REG_LVI_MASK		0x1f</span>

<span class="cm">/* SR */</span>
<span class="cp">#define ICH_FIFOE			0x10	</span><span class="cm">/* FIFO error */</span><span class="cp"></span>
<span class="cp">#define ICH_BCIS			0x08	</span><span class="cm">/* buffer completion interrupt status */</span><span class="cp"></span>
<span class="cp">#define ICH_LVBCI			0x04	</span><span class="cm">/* last valid buffer completion interrupt */</span><span class="cp"></span>
<span class="cp">#define ICH_CELV			0x02	</span><span class="cm">/* current equals last valid */</span><span class="cp"></span>
<span class="cp">#define ICH_DCH				0x01	</span><span class="cm">/* DMA controller halted */</span><span class="cp"></span>

<span class="cm">/* PIV */</span>
<span class="cp">#define ICH_REG_PIV_MASK		0x1f	</span><span class="cm">/* mask */</span><span class="cp"></span>

<span class="cm">/* CR */</span>
<span class="cp">#define ICH_IOCE			0x10	</span><span class="cm">/* interrupt on completion enable */</span><span class="cp"></span>
<span class="cp">#define ICH_FEIE			0x08	</span><span class="cm">/* fifo error interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_LVBIE			0x04	</span><span class="cm">/* last valid buffer interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_RESETREGS			0x02	</span><span class="cm">/* reset busmaster registers */</span><span class="cp"></span>
<span class="cp">#define ICH_STARTBM			0x01	</span><span class="cm">/* start busmaster operation */</span><span class="cp"></span>


<span class="cm">/* global block */</span>
<span class="cp">#define ICH_REG_GLOB_CNT		0x3c	</span><span class="cm">/* dword - global control */</span><span class="cp"></span>
<span class="cp">#define   ICH_TRIE		0x00000040	</span><span class="cm">/* tertiary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_SRIE		0x00000020	</span><span class="cm">/* secondary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_PRIE		0x00000010	</span><span class="cm">/* primary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_ACLINK		0x00000008	</span><span class="cm">/* AClink shut off */</span><span class="cp"></span>
<span class="cp">#define   ICH_AC97WARM		0x00000004	</span><span class="cm">/* AC&#39;97 warm reset */</span><span class="cp"></span>
<span class="cp">#define   ICH_AC97COLD		0x00000002	</span><span class="cm">/* AC&#39;97 cold reset */</span><span class="cp"></span>
<span class="cp">#define   ICH_GIE		0x00000001	</span><span class="cm">/* GPI interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_REG_GLOB_STA		0x40	</span><span class="cm">/* dword - global status */</span><span class="cp"></span>
<span class="cp">#define   ICH_TRI		0x20000000	</span><span class="cm">/* ICH4: tertiary (AC_SDIN2) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_TCR		0x10000000	</span><span class="cm">/* ICH4: tertiary (AC_SDIN2) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_BCS		0x08000000	</span><span class="cm">/* ICH4: bit clock stopped */</span><span class="cp"></span>
<span class="cp">#define   ICH_SPINT		0x04000000	</span><span class="cm">/* ICH4: S/PDIF interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_P2INT		0x02000000	</span><span class="cm">/* ICH4: PCM2-In interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_M2INT		0x01000000	</span><span class="cm">/* ICH4: Mic2-In interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_SAMPLE_CAP	0x00c00000	</span><span class="cm">/* ICH4: sample capability bits (RO) */</span><span class="cp"></span>
<span class="cp">#define   ICH_MULTICHAN_CAP	0x00300000	</span><span class="cm">/* ICH4: multi-channel capability bits (RO) */</span><span class="cp"></span>
<span class="cp">#define   ICH_MD3		0x00020000	</span><span class="cm">/* modem power down semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_AD3		0x00010000	</span><span class="cm">/* audio power down semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_RCS		0x00008000	</span><span class="cm">/* read completion status */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT3		0x00004000	</span><span class="cm">/* bit 3 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT2		0x00002000	</span><span class="cm">/* bit 2 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT1		0x00001000	</span><span class="cm">/* bit 1 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_SRI		0x00000800	</span><span class="cm">/* secondary (AC_SDIN1) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_PRI		0x00000400	</span><span class="cm">/* primary (AC_SDIN0) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_SCR		0x00000200	</span><span class="cm">/* secondary (AC_SDIN1) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCR		0x00000100	</span><span class="cm">/* primary (AC_SDIN0) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_MCINT		0x00000080	</span><span class="cm">/* MIC capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_POINT		0x00000040	</span><span class="cm">/* playback interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_PIINT		0x00000020	</span><span class="cm">/* capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_NVSPINT		0x00000010	</span><span class="cm">/* nforce spdif interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_MOINT		0x00000004	</span><span class="cm">/* modem playback interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_MIINT		0x00000002	</span><span class="cm">/* modem capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_GSCI		0x00000001	</span><span class="cm">/* GPI status change interrupt */</span><span class="cp"></span>
<span class="cp">#define ICH_REG_ACC_SEMA		0x44	</span><span class="cm">/* byte - codec write semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_CAS		0x01		</span><span class="cm">/* codec access semaphore */</span><span class="cp"></span>

<span class="cp">#define ICH_MAX_FRAGS		32		</span><span class="cm">/* max hw frags */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> *  </span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">ICHD_MDMIN</span><span class="p">,</span> <span class="n">ICHD_MDMOUT</span><span class="p">,</span> <span class="n">ICHD_MDMLAST</span> <span class="o">=</span> <span class="n">ICHD_MDMOUT</span> <span class="p">};</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">ALID_MDMIN</span><span class="p">,</span> <span class="n">ALID_MDMOUT</span><span class="p">,</span> <span class="n">ALID_MDMLAST</span> <span class="o">=</span> <span class="n">ALID_MDMOUT</span> <span class="p">};</span>

<span class="cp">#define get_ichdev(substream) (substream-&gt;runtime-&gt;private_data)</span>

<span class="k">struct</span> <span class="n">ichdev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ichd</span><span class="p">;</span>			<span class="cm">/* ich device number */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_offset</span><span class="p">;</span>		<span class="cm">/* offset to bmaddr */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">bdbar</span><span class="p">;</span>				<span class="cm">/* CPU address (32bit) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bdbar_addr</span><span class="p">;</span>		<span class="cm">/* PCI bus address (32bit) */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">physbuf</span><span class="p">;</span>			<span class="cm">/* physical address (32bit) */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize1</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">position</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">frags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">lvi</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">lvi_frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">civ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack_reload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ack_bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">roff_sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">roff_picb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_mask</span><span class="p">;</span>		<span class="cm">/* interrupt status mask */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ali_slot</span><span class="p">;</span>			<span class="cm">/* ALI DMA slot */</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bmaddr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">pcm_devs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="n">ichd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_ac97_init</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">bdbars</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdbars_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_sta_reg</span><span class="p">;</span>		<span class="cm">/* interrupt status register */</span>
	<span class="n">u32</span> <span class="n">int_sta_mask</span><span class="p">;</span>		<span class="cm">/* interrupt status mask */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcm_pos_shift</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_intel8x0m_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2416</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82801AA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2426</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82901AB */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2446</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82801BA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2486</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* ICH3 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x24c6</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span> <span class="cm">/* ICH4 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x24d6</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span> <span class="cm">/* ICH5 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x266d</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* ICH6 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27dd</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* ICH7 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x7196</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 440MX */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span> <span class="mh">0x7446</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* AMD768 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="mh">0x7013</span><span class="p">),</span> <span class="n">DEVICE_SIS</span> <span class="p">},</span>	<span class="cm">/* SI7013 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x01c1</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span> <span class="cm">/* NFORCE */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span> <span class="cm">/* NFORCE2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0089</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span> <span class="cm">/* NFORCE2s */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x00d9</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span> <span class="cm">/* NFORCE3 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span> <span class="mh">0x746e</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* AMD8111 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{ PCI_VDEVICE(AL, 0x5455), DEVICE_ALI },   /* Ali5455 */</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_intel8x0m_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Lowlevel I/O - busmaster</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">igetbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">igetword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">igetdword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputdword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Lowlevel I/O - AC&#39;97 registers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">iagetword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iaputword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * access to AC97 codec via normal i/o (for ICH and SIS7013)</span>
<span class="cm"> */</span>

<span class="cm">/* return the GLOB_STA bit for the corresponding codec */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_ich_codec_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec_bit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">ICH_PCR</span><span class="p">,</span> <span class="n">ICH_SCR</span><span class="p">,</span> <span class="n">ICH_TCR</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">codec</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ICH_PCR</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">codec_bit</span><span class="p">[</span><span class="n">codec</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_codec_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">codec</span> <span class="o">=</span> <span class="n">get_ich_codec_bit</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* codec ready ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">codec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Anyone holding a semaphore for 1 msec should be shot... */</span>
	<span class="n">time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
      	<span class="k">do</span> <span class="p">{</span>
      		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ACC_SEMA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_CAS</span><span class="p">))</span>
      			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">--</span><span class="p">);</span>

	<span class="cm">/* access to some forbidden (non existent) ac97 registers will not</span>
<span class="cm">	 * reset the semaphore. So even if you don&#39;t get the semaphore, still</span>
<span class="cm">	 * continue the access. We don&#39;t need the semaphore anyway. */</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_semaphore: semaphore is not ready [0x%x][0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ACC_SEMA</span><span class="p">)),</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)));</span>
	<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear semaphore flag */</span>
	<span class="cm">/* I don&#39;t care about the semaphore */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0m_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_write %d: semaphore is not ready for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iaputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_intel8x0m_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0m_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read %d: semaphore is not ready for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">ICH_RCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset RCS and preserve other R/WC bits */</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">),</span>
				  <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_SRI</span><span class="o">|</span><span class="n">ICH_PRI</span><span class="o">|</span><span class="n">ICH_TRI</span><span class="o">|</span><span class="n">ICH_GSCI</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read %d: read timeout for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">)</span>
		<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* clear semaphore */</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * DMA I/O</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_setup_periods</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">bdbar</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>

	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_BDBAR</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span><span class="p">);</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_pos_shift</span><span class="p">);</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_pos_shift</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span> <span class="p">(((</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span> <span class="o">%</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_pos_shift</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG &quot;bdbar[%i] = 0x%x [0x%x]\n&quot;,</span>
<span class="cm">			       idx + 0, bdbar[idx + 0], bdbar[idx + 1]);</span>
<span class="cm">			*/</span>
		<span class="p">}</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_LVI</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">=</span> <span class="n">ICH_REG_LVI_MASK</span> <span class="o">%</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;lvi_frag = %i, frags = %i, period_size = 0x%x, &quot;</span>
<span class="c">	       &quot;period_size1 = 0x%x\n&quot;,</span>
<span class="c">	       ichdev-&gt;lvi_frag, ichdev-&gt;frags, ichdev-&gt;fragsize,</span>
<span class="c">	       ichdev-&gt;fragsize1);</span>
<span class="cp">#endif</span>
	<span class="cm">/* clear interrupts */</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">,</span> <span class="n">ICH_FIFOE</span> <span class="o">|</span> <span class="n">ICH_BCIS</span> <span class="o">|</span> <span class="n">ICH_LVBCI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">civ</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">civ</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">civ</span> <span class="o">==</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd_printd("civ same %d\n", civ);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">&amp;=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">civ</span> <span class="o">-</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">step</span> <span class="o">+=</span> <span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>if (step != 1)
snd_printd("step = %d, %d -> %d\n", step, ichdev->civ, civ);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">=</span> <span class="n">civ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">%=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">&amp;=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">;</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_LVI</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">step</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">%=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span><span class="p">[</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span>
							     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">*</span>
							     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(KERN_DEBUG &quot;new: bdbar[%i] = 0x%x [0x%x], &quot;</span>
<span class="c">		       &quot;prefetch = %i, all = 0x%x, 0x%x\n&quot;,</span>
<span class="c">		       ichdev-&gt;lvi * 2, ichdev-&gt;bdbar[ichdev-&gt;lvi * 2],</span>
<span class="c">		       ichdev-&gt;bdbar[ichdev-&gt;lvi * 2 + 1], inb(ICH_REG_OFF_PIV + port),</span>
<span class="c">		       inl(port + 4), inb(port + ICH_REG_OFF_CR));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span><span class="p">;</span>
			<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">,</span> <span class="n">ICH_FIFOE</span> <span class="o">|</span> <span class="n">ICH_BCIS</span> <span class="o">|</span> <span class="n">ICH_LVBCI</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_intel8x0m_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* we are not yet resumed */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">)</span>
			<span class="n">snd_intel8x0m_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ack them */</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ICH_IOCE</span> <span class="o">|</span> <span class="n">ICH_STARTBM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ICH_IOCE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ICH_IOCE</span> <span class="o">|</span> <span class="n">ICH_STARTBM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait until DMA stopped */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICH_DCH</span><span class="p">))</span> <span class="p">;</span>
		<span class="cm">/* reset whole DMA things */</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_intel8x0m_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr1</span> <span class="o">=</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_pos_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">-</span> <span class="n">ptr1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_intel8x0m_setup_periods</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_intel8x0m_stream</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_8000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_16000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">16000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8000</span><span class="p">,</span>  <span class="mi">9600</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">16000</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
		<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_intel8x0m_stream</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">hw_constraints_rates</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ichdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0m_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMOUT</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMOUT</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0m_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMIN</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMIN</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0m_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0m_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0m_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0m_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">playback_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">capture_ops</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">prealloc_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">prealloc_max_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac97_idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_pcm1</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Intel ICH - %s&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Intel ICH&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			  <span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">SNDRV_PCM_CLASS_MODEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s - %s&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="n">rec</span><span class="o">-&gt;</span><span class="n">prealloc_size</span><span class="p">,</span>
					      <span class="n">rec</span><span class="o">-&gt;</span><span class="n">prealloc_max_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="n">intel_pcms</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;Modem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0m_playback_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0m_capture_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tblsize</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>

<span class="cp">#if 1</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_pcms</span><span class="p">;</span>
	<span class="n">tblsize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_NFORCE</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">nforce_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nforce_pcms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_ALI</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">ali_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ali_pcms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tblsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rec</span> <span class="o">=</span> <span class="n">tbl</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ac97_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* activate PCM only when associated AC&#39;97 codec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ac97_idx</span><span class="p">].</span><span class="n">ac97</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_pcm1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">device</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_devs</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
	

<span class="cm">/*</span>
<span class="cm"> *  Mixer part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">x97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">glob_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_intel8x0m_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_intel8x0m_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_intel8x0m_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span> <span class="o">|</span> <span class="n">AC97_SCAP_POWER_SAVE</span><span class="p">;</span>

	<span class="n">glob_sta</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_intel8x0m_mixer_free_ac97_bus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">&amp;&amp;</span> <span class="n">ac97_clock</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="n">pbus</span><span class="p">;</span>

	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">glob_sta</span> <span class="o">&amp;</span> <span class="n">ICH_SCR</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to initialize codec #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">x97</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ac97_is_modem</span><span class="p">(</span><span class="n">x97</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMIN</span><span class="p">].</span><span class="n">ac97</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMIN</span><span class="p">].</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">x97</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MDMOUT</span><span class="p">].</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">x97</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__err:</span>
	<span class="cm">/* clear the cold-reset bit for the next chance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span>
			  <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_AC97COLD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_ich_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">nstatus</span><span class="p">;</span>
	
	<span class="cm">/* put logic to right state */</span>
	<span class="cm">/* first clear status bits */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ICH_RCS</span> <span class="o">|</span> <span class="n">ICH_MIINT</span> <span class="o">|</span> <span class="n">ICH_MOINT</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">),</span> <span class="n">cnt</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* ACLink on, 2 channels */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
	<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_ACLINK</span><span class="p">);</span>
	<span class="cm">/* finish cold or do warm reset */</span>
	<span class="n">cnt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="n">ICH_AC97COLD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ICH_AC97COLD</span> <span class="o">:</span> <span class="n">ICH_AC97WARM</span><span class="p">;</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span> <span class="cm">/* give warm reset some time */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_AC97WARM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__ok</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 warm reset still in progress? [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">)));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

      <span class="nl">__ok:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for any codec ready status.</span>
<span class="cm">		 * Once it becomes ready it should remain ready</span>
<span class="cm">		 * as long as we do not disable the ac97 link.</span>
<span class="cm">		 */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">ICH_PCR</span> <span class="o">|</span> <span class="n">ICH_SCR</span> <span class="o">|</span> <span class="n">ICH_TCR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no codec is found */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_ready: codec is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* up to two codecs (modem cannot be tertiary with ICH4) */</span>
		<span class="n">nstatus</span> <span class="o">=</span> <span class="n">ICH_PCR</span> <span class="o">|</span> <span class="n">ICH_SCR</span><span class="p">;</span>

		<span class="cm">/* wait for other codecs ready status. */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">nstatus</span> <span class="o">&amp;&amp;</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">nstatus</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* resume phase */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">get_ich_codec_bit</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="cm">/* wait until all the probed codecs are ready */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">nstatus</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">ICH_PCR</span> <span class="o">|</span> <span class="n">ICH_SCR</span> <span class="o">|</span> <span class="n">ICH_TCR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nstatus</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmute the output on SIS7012 */</span>
		<span class="n">iputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

      	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_ich_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">probing</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear semaphore flag */</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* reset channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="cm">/* initialize Buffer Descriptor Lists */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_BDBAR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdbar_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__hw_end</span><span class="p">;</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* reset channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
 <span class="nl">__hw_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * power management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel8x0m_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel8x0m_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0m: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_intel8x0m_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0m: unable to grab IRQ %d, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">snd_intel8x0m_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0m_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Intel8x0m</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Global control        : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">)));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Global status         : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codecs ready    :%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">ICH_PCR</span> <span class="o">?</span> <span class="s">&quot; primary&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">ICH_SCR</span> <span class="o">?</span> <span class="s">&quot; secondary&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">ICH_TCR</span> <span class="o">?</span> <span class="s">&quot; tertiary&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ICH_PCR</span> <span class="o">|</span> <span class="n">ICH_SCR</span> <span class="o">|</span> <span class="n">ICH_TCR</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot; none&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;intel8x0m&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_intel8x0m_proc_read</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="cp">#define snd_intel8x0m_proc_init(chip)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0m_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">device_type</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">**</span><span class="n">r_intel8x0m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_masks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0m_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="n">intel_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ICH_MIINT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_MOINT</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_intel8x0m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">device_type</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ALI5455 has no ac97 region */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">port_inited</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="cm">/* ICH4 and Nforce */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 space ioremap problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="cm">/* ICH4 */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Controller space ioremap problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">port_inited:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_intel8x0m_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* initialize offsets */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_regs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ichd</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">int_sta_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SiS 7013 swaps the registers */</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_PICB</span><span class="p">;</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">;</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_PICB</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* SIS7013 handles the pcm data in bytes, others are in words */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_pos_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* allocate buffer descriptor lists */</span>
	<span class="cm">/* the start of each lists must be aligned to 8 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* tables must be aligned to 8 bytes here, but the kernel pages</span>
<span class="cm">	   are much bigger, so we don&#39;t care (on i386) */</span>
	<span class="n">int_sta_masks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">int_sta_masks</span> <span class="o">|=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span> <span class="o">=</span> <span class="n">ICH_REG_GLOB_STA</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span> <span class="o">=</span> <span class="n">int_sta_masks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0m_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_intel8x0m</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shortname_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span> <span class="n">shortnames</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AA_6</span><span class="p">,</span> <span class="s">&quot;Intel 82801AA-ICH&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AB_6</span><span class="p">,</span> <span class="s">&quot;Intel 82901AB-ICH0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_6</span><span class="p">,</span> <span class="s">&quot;Intel 82801BA-ICH2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_440MX_6</span><span class="p">,</span> <span class="s">&quot;Intel 440MX&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_6</span><span class="p">,</span> <span class="s">&quot;Intel 82801CA-ICH3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_6</span><span class="p">,</span> <span class="s">&quot;Intel 82801DB-ICH4&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801EB_6</span><span class="p">,</span> <span class="s">&quot;Intel ICH5&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH6_17</span><span class="p">,</span> <span class="s">&quot;Intel ICH6&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_19</span><span class="p">,</span> <span class="s">&quot;Intel ICH7&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x7446</span><span class="p">,</span> <span class="s">&quot;AMD AMD768&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_SI_7013</span><span class="p">,</span> <span class="s">&quot;SiS SI7013&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP1_MODEM</span><span class="p">,</span> <span class="s">&quot;NVidia nForce&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP2_MODEM</span><span class="p">,</span> <span class="s">&quot;NVidia nForce2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP2S_MODEM</span><span class="p">,</span> <span class="s">&quot;NVidia nForce2s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP3_MODEM</span><span class="p">,</span> <span class="s">&quot;NVidia nForce3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x746e</span><span class="p">,</span> <span class="s">&quot;AMD AMD8111&quot;</span> <span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{ 0x5455, &quot;ALi M5455&quot; },</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0m_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel8x0m</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">shortname_table</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ICH-MODEM&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Intel ICH&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">shortnames</span><span class="p">;</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="n">name</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span><span class="s">&quot; Modem&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_clock</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0m_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">snd_intel8x0m_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_intel8x0m_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">intel8x0m_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_intel8x0m_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_intel8x0m_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_intel8x0m_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">intel8x0m_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">intel8x0m_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">intel8x0m_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
