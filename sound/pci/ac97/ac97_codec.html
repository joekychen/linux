<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ac97 › ac97_codec.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ac97_codec.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *  Universal interface for Audio Codec &#39;97</span>
<span class="cm"> *</span>
<span class="cm"> *  For more details look to AC &#39;97 component specification revision 2.2</span>
<span class="cm"> *  by Intel Corporation (http://developer.intel.com).</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &quot;ac97_id.h&quot;</span>

<span class="cp">#include &quot;ac97_patch.c&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Universal interface for Audio Codec &#39;97&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">enable_loopback</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">enable_loopback</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_loopback</span><span class="p">,</span> <span class="s">&quot;Enable AC97 ADC/DAC Loopback Control&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">power_save</span> <span class="o">=</span> <span class="n">CONFIG_SND_AC97_POWER_SAVE_DEFAULT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span> <span class="s">&quot;Automatic power-saving timeout &quot;</span>
		 <span class="s">&quot;(in second, 0 = disable).&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>

<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">patch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mpatch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="n">snd_ac97_codec_id_vendors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="mh">0x41445300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Analog Devices&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d00</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Asahi Kasei&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Realtek&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4700</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Realtek&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> * This is an _inofficial_ Aztech Labs entry</span>
<span class="cm"> * (value might differ from unknown official Aztech ID),</span>
<span class="cm"> * currently used by the AC97 emulation of the almost-AC97 PCI168 card.</span>
<span class="cm"> */</span>
<span class="p">{</span> <span class="mh">0x415a5400</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Aztech Labs (emulated)&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4900</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;C-Media Electronics&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525900</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Cirrus Logic&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43585400</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Conexant&quot;</span><span class="p">,</span>           <span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x44543000</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Diamond Technology&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x454d4300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;eMicro&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x45838300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;ESS Technology&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x48525300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Intersil&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49434500</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;ICEnsemble&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49544500</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;ITE Tech.Inc&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x4e534300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;National Semiconductor&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x50534300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Philips&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x53494c00</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Silicon Laboratory&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x53544d00</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;STMicroelectronics&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54524100</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;TriTech&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54584e00</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Texas Instruments&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x56494100</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;VIA Technologies&quot;</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x57454300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Winbond&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4c00</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Wolfson&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x594d4800</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;Yamaha&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847600</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;SigmaTel&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	      <span class="mi">0</span><span class="p">,</span> 	  <span class="nb">NULL</span><span class="p">,</span>			<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="n">snd_ac97_codec_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="mh">0x41445303</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1819&quot;</span><span class="p">,</span>		<span class="n">patch_ad1819</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445340</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1881&quot;</span><span class="p">,</span>		<span class="n">patch_ad1881</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445348</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1881A&quot;</span><span class="p">,</span>		<span class="n">patch_ad1881</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445360</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1885&quot;</span><span class="p">,</span>		<span class="n">patch_ad1885</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445361</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1886&quot;</span><span class="p">,</span>		<span class="n">patch_ad1886</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445362</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1887&quot;</span><span class="p">,</span>		<span class="n">patch_ad1881</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445363</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1886A&quot;</span><span class="p">,</span>		<span class="n">patch_ad1881</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445368</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1888&quot;</span><span class="p">,</span>		<span class="n">patch_ad1888</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445370</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1980&quot;</span><span class="p">,</span>		<span class="n">patch_ad1980</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445372</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1981A&quot;</span><span class="p">,</span>		<span class="n">patch_ad1981a</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445374</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1981B&quot;</span><span class="p">,</span>		<span class="n">patch_ad1981b</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445375</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1985&quot;</span><span class="p">,</span>		<span class="n">patch_ad1985</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x41445378</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AD1986&quot;</span><span class="p">,</span>		<span class="n">patch_ad1986</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d00</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AK4540&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d01</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AK4542&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d02</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AK4543&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d06</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AK4544A&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414b4d07</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AK4545&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;ALC100,100P&quot;</span><span class="p">,</span> 	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4710</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC200,200P&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4721</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ALC650D&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* already patched */</span>
<span class="p">{</span> <span class="mh">0x414c4722</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ALC650E&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* already patched */</span>
<span class="p">{</span> <span class="mh">0x414c4723</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ALC650F&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* already patched */</span>
<span class="p">{</span> <span class="mh">0x414c4720</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC650&quot;</span><span class="p">,</span>		<span class="n">patch_alc650</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4730</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ALC101&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4740</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC202&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4750</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC250&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4760</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC655&quot;</span><span class="p">,</span>		<span class="n">patch_alc655</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4770</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC203&quot;</span><span class="p">,</span>		<span class="n">patch_alc203</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4781</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ALC658D&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* already patched */</span>
<span class="p">{</span> <span class="mh">0x414c4780</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC658&quot;</span><span class="p">,</span>		<span class="n">patch_alc655</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x414c4790</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;ALC850&quot;</span><span class="p">,</span>		<span class="n">patch_alc850</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x415a5401</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;AZF3328&quot;</span><span class="p">,</span>		<span class="n">patch_aztech_azf3328</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4941</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9738&quot;</span><span class="p">,</span>		<span class="n">patch_cm9738</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4961</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9739&quot;</span><span class="p">,</span>		<span class="n">patch_cm9739</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4969</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9780&quot;</span><span class="p">,</span>		<span class="n">patch_cm9780</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4978</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9761A&quot;</span><span class="p">,</span>		<span class="n">patch_cm9761</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4982</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9761B&quot;</span><span class="p">,</span>		<span class="n">patch_cm9761</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x434d4983</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;CMI9761A+&quot;</span><span class="p">,</span>		<span class="n">patch_cm9761</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525900</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4297&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525910</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4297A&quot;</span><span class="p">,</span>		<span class="n">patch_cirrus_spdif</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525920</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4298&quot;</span><span class="p">,</span>		<span class="n">patch_cirrus_spdif</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525928</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4294&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525930</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4299&quot;</span><span class="p">,</span>		<span class="n">patch_cirrus_cs4299</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525948</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4201&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525958</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4205&quot;</span><span class="p">,</span>		<span class="n">patch_cirrus_spdif</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525960</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4291&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43525970</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;CS4202&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43585421</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;HSD11246&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>	<span class="c1">// SmartMC II</span>
<span class="p">{</span> <span class="mh">0x43585428</span><span class="p">,</span> <span class="mh">0xfffffff8</span><span class="p">,</span> <span class="s">&quot;Cx20468&quot;</span><span class="p">,</span>		<span class="n">patch_conexant</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// SmartAMC fixme: the mask might be different</span>
<span class="p">{</span> <span class="mh">0x43585430</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;Cx20468-31&quot;</span><span class="p">,</span>		<span class="n">patch_conexant</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x43585431</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;Cx20551&quot;</span><span class="p">,</span>           <span class="n">patch_cx20551</span><span class="p">,</span>  <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x44543031</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">,</span> <span class="s">&quot;DT0398&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x454d4328</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;EM28028&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>  <span class="c1">// same as TR28028?</span>
<span class="p">{</span> <span class="mh">0x45838308</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ESS1988&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x48525300</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="s">&quot;HMP9701&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49434501</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ICE1230&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49434511</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ICE1232&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// alias VIA VT1611A?</span>
<span class="p">{</span> <span class="mh">0x49434514</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ICE1232A&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49434551</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;VT1616&quot;</span><span class="p">,</span> 		<span class="n">patch_vt1616</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> 
<span class="p">{</span> <span class="mh">0x49434552</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;VT1616i&quot;</span><span class="p">,</span>		<span class="n">patch_vt1616</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// VT1616 compatible (chipset integrated)</span>
<span class="p">{</span> <span class="mh">0x49544520</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;IT2226E&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x49544561</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;IT2646E&quot;</span><span class="p">,</span>		<span class="n">patch_it2646</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x4e534300</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;LM4540,43,45,46,48&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// only guess --jk</span>
<span class="p">{</span> <span class="mh">0x4e534331</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;LM4549&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x4e534350</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;LM4550&quot;</span><span class="p">,</span>		<span class="n">patch_lm4550</span><span class="p">,</span>  	<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// volume wrap fix </span>
<span class="p">{</span> <span class="mh">0x50534304</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;UCB1400&quot;</span><span class="p">,</span>		<span class="n">patch_ucb1400</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x53494c20</span><span class="p">,</span> <span class="mh">0xffffffe0</span><span class="p">,</span> <span class="s">&quot;Si3036,8&quot;</span><span class="p">,</span>		<span class="n">mpatch_si3036</span><span class="p">,</span>	<span class="n">mpatch_si3036</span><span class="p">,</span> <span class="n">AC97_MODEM_PATCH</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x53544d02</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;ST7597&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54524102</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TR28022&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54524103</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TR28023&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54524106</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TR28026&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x54524108</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TR28028&quot;</span><span class="p">,</span>		<span class="n">patch_tritech_tr28028</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// added by xin jin [07/09/99]</span>
<span class="p">{</span> <span class="mh">0x54524123</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TR28602&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// only guess --jk [TR28023 = eMicro EM28023 (new CT1297)]</span>
<span class="p">{</span> <span class="mh">0x54584e20</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;TLC320AD9xC&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x56494161</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;VIA1612A&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// modified ICE1232 with S/PDIF</span>
<span class="p">{</span> <span class="mh">0x56494170</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;VIA1617A&quot;</span><span class="p">,</span>		<span class="n">patch_vt1617a</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// modified VT1616 with S/PDIF</span>
<span class="p">{</span> <span class="mh">0x56494182</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;VIA1618&quot;</span><span class="p">,</span>		<span class="n">patch_vt1618</span><span class="p">,</span>   <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x57454301</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;W83971D&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4c00</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9701,WM9701A&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4C03</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9703,WM9707,WM9708,WM9717&quot;</span><span class="p">,</span> <span class="n">patch_wolfson03</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4C04</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9704M,WM9704Q&quot;</span><span class="p">,</span>	<span class="n">patch_wolfson04</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4C05</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9705,WM9710&quot;</span><span class="p">,</span>	<span class="n">patch_wolfson05</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4C09</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9709&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4C12</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9711,WM9712,WM9715&quot;</span><span class="p">,</span>	<span class="n">patch_wolfson11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x574d4c13</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;WM9713,WM9714&quot;</span><span class="p">,</span>	<span class="n">patch_wolfson13</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">AC97_DEFAULT_POWER_OFF</span><span class="p">},</span>
<span class="p">{</span> <span class="mh">0x594d4800</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;YMF743&quot;</span><span class="p">,</span>		<span class="n">patch_yamaha_ymf743</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x594d4802</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;YMF752&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x594d4803</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;YMF753&quot;</span><span class="p">,</span>		<span class="n">patch_yamaha_ymf753</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847600</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9700,83,84&quot;</span><span class="p">,</span>	<span class="n">patch_sigmatel_stac9700</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847604</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9701,3,4,5&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847605</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9704&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847608</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9708,11&quot;</span><span class="p">,</span>	<span class="n">patch_sigmatel_stac9708</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847609</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9721,23&quot;</span><span class="p">,</span>	<span class="n">patch_sigmatel_stac9721</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847644</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9744&quot;</span><span class="p">,</span>		<span class="n">patch_sigmatel_stac9744</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847650</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9750,51&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span>	<span class="c1">// patch?</span>
<span class="p">{</span> <span class="mh">0x83847652</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9752,53&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// patch?</span>
<span class="p">{</span> <span class="mh">0x83847656</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9756,57&quot;</span><span class="p">,</span>	<span class="n">patch_sigmatel_stac9756</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847658</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9758,59&quot;</span><span class="p">,</span>	<span class="n">patch_sigmatel_stac9758</span><span class="p">,</span>	<span class="nb">NULL</span> <span class="p">},</span>
<span class="p">{</span> <span class="mh">0x83847666</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="s">&quot;STAC9766,67&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">},</span> <span class="c1">// patch?</span>
<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> 	      <span class="mi">0</span><span class="p">,</span>	  <span class="nb">NULL</span><span class="p">,</span>			<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">update_power_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
<span class="cp">#define ac97_is_power_save_mode(ac97) \</span>
<span class="cp">	((ac97-&gt;scaps &amp; AC97_SCAP_POWER_SAVE) &amp;&amp; power_save)</span>
<span class="cp">#else</span>
<span class="cp">#define ac97_is_power_save_mode(ac97) 0</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *  I/O routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_valid_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* filter some registers for buggy codecs */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC97_ID_ST_AC97_ID4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">AC97_ID_ST7597</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x22</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x7a</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AK4540</span>:
	<span class="k">case</span> <span class="n">AC97_ID_AK4542</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x1c</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x26</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x7c</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1819</span>:	<span class="cm">/* AD1819 */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1881</span>:	<span class="cm">/* AD1881 */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1881A</span>:	<span class="cm">/* AD1881A */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x3a</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x6e</span><span class="p">)</span>	<span class="cm">/* 0x59 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1885</span>:	<span class="cm">/* AD1885 */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1886</span>:	<span class="cm">/* AD1886 */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1886A</span>:	<span class="cm">/* AD1886A - !!verify!! --jk */</span>
	<span class="k">case</span> <span class="n">AC97_ID_AD1887</span>:	<span class="cm">/* AD1887 - !!verify!! --jk */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x5a</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x3c</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x6e</span><span class="p">)</span>	<span class="cm">/* 0x59 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_ID_STAC9700</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9704</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9705</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9708</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9721</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9744</span>:
	<span class="k">case</span> <span class="n">AC97_ID_STAC9756</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x3a</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x5a</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_write - write a value on the given register</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @reg: the register to change</span>
<span class="cm"> * @value: the value to set</span>
<span class="cm"> *</span>
<span class="cm"> * Writes a value on the given register.  This will invoke the write</span>
<span class="cm"> * callback directly after the register check.</span>
<span class="cm"> * This function doesn&#39;t change the register cache unlike</span>
<span class="cm"> * #snd_ca97_write_cache(), so use this only when you don&#39;t want to</span>
<span class="cm"> * reflect the change to the suspend/resume state.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC97_ID_ALC100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fix H/W bug of ALC100/100P */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_MASTER</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_HEADPHONE</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* reset audio codec */</span>
	<span class="p">}</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_write</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_read - read a value from the given register</span>
<span class="cm"> * </span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @reg: the register to read</span>
<span class="cm"> *</span>
<span class="cm"> * Reads a value from the given register.  This will invoke the read</span>
<span class="cm"> * callback directly after the register check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the read value.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read a register - return the cached value if already read */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_ac97_read_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>set<em>bit(reg, ac97->reg</em>accessed);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_write_cache - write a value on the given register and update the cache</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @reg: the register to change</span>
<span class="cm"> * @value: the value to set</span>
<span class="cm"> *</span>
<span class="cm"> * Writes a value on the given register and updates the register</span>
<span class="cm"> * cache.  The cached values are used for the cached-read and the</span>
<span class="cm"> * suspend/resume.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_ac97_write_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_write_cache</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_update - update the value on the given register</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @reg: the register to change</span>
<span class="cm"> * @value: the value to set</span>
<span class="cm"> *</span>
<span class="cm"> * Compares the value with the register cache and updates the value</span>
<span class="cm"> * only when the value is changed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the value is changed, 0 if no change, or a negative</span>
<span class="cm"> * code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_update</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_update_bits - update the bits on the given register</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @reg: the register to change</span>
<span class="cm"> * @mask: the bit-mask to change</span>
<span class="cm"> * @value: the value to set</span>
<span class="cm"> *</span>
<span class="cm"> * Updates the masked-bits on the given register only when the value</span>
<span class="cm"> * is changed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the bits are changed, 0 if no change, or a negative</span>
<span class="cm"> * code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_update_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_update_bits</span><span class="p">);</span>

<span class="cm">/* no lock version - see snd_ac97_update_bits() */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_update_pcm_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">];</span>
	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="cm">/* select single codec */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7000</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
		<span class="cm">/* update PCM bits */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="cm">/* select all codecs */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span>
				 <span class="n">cfg</span> <span class="o">|</span> <span class="mh">0x7000</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_info_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_get_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_put_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ac97_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* save/restore ac97 v2.3 paging */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_page_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_save</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_REV_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AC97_EI_REV_23</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x60</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x70</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span> <span class="cm">/* lock paging */</span>
		<span class="n">page_save</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_PAGE_MASK</span><span class="p">;</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">page_save</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_page_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_save</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">page_save</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span> <span class="cm">/* unlock paging */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* volume and switch controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_info_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">==</span> <span class="n">rshift</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_get_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_save</span><span class="p">;</span>

	<span class="n">page_save</span> <span class="o">=</span> <span class="n">snd_ac97_page_save</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_page_restore</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">page_save</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_put_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">page_save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">;</span>
	
	<span class="n">page_save</span> <span class="o">=</span> <span class="n">snd_ac97_page_save</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>
		<span class="n">val_mask</span> <span class="o">|=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">snd_ac97_page_restore</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">page_save</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
	<span class="cm">/* check analog mixer power-down */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val_mask</span> <span class="o">&amp;</span> <span class="n">AC97_PD_EAPD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_PD_EAPD</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_up</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_up</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">update_power_regs</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_master_mono</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Master Mono Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Master Mono Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_tone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_pc_beep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_mic_boost</span> <span class="o">=</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Boost (+20dB)&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">std_rec_sel</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">,</span> <span class="s">&quot;Video&quot;</span><span class="p">,</span> <span class="s">&quot;Aux&quot;</span><span class="p">,</span> <span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Mix Mono&quot;</span><span class="p">,</span> <span class="s">&quot;Phone&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">std_3d_path</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;pre 3D&quot;</span><span class="p">,</span> <span class="s">&quot;post 3D&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">std_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Mic&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">std_mic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic1&quot;</span><span class="p">,</span> <span class="s">&quot;Mic2&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_enum</span> <span class="n">std_enum</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">std_rec_sel</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">std_3d_path</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">std_mix</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">std_mic</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_control_capture_src</span> <span class="o">=</span> 
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Source&quot;</span><span class="p">,</span> <span class="n">std_enum</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_control_capture_vol</span> <span class="o">=</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_mic_capture</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Capture Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">AC97_GENERAL_PCM_OUT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_STEREO_ENHANCEMENT</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_3D</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_LOUDNESS</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_MONO</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_MIC</span><span class="p">,</span>
	<span class="n">AC97_GENERAL_LOOPBACK</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;PCM Out Path &amp; Mute&quot;</span><span class="p">,</span> <span class="n">std_enum</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Simulated Stereo Enhancement&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Control - Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Loudness (bass boost)&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Mono Output Select&quot;</span><span class="p">,</span> <span class="n">std_enum</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Mic Select&quot;</span><span class="p">,</span> <span class="n">std_enum</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC/DAC Loopback&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Control - Center&quot;</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Control - Depth&quot;</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Center Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Center Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_lfe</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;LFE Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;LFE Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_control_eapd</span> <span class="o">=</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;External Amplifier&quot;</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_modem_switches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Off-hook Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Caller ID Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/* change the existing EAPD control as inverted */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_inv_eapd</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">));</span> <span class="cm">/* EAPD up */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_INV_EAPD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_spdif_mask_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
                        
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_spdif_cmask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_CON_NOT_COPYRIGHT</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES1_CON_CATEGORY</span> <span class="o">|</span>
					   <span class="n">IEC958_AES1_CON_ORIGINAL</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
                        
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_spdif_pmask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: AC&#39;97 spec doesn&#39;t say which bits are used for what */</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_PRO_FS</span> <span class="o">|</span>
					   <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
                        
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEC958_AES0_PROFESSIONAL</span><span class="o">|</span><span class="n">IEC958_AES0_NONAUDIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEC958_AES0_PRO_FS</span><span class="o">|</span><span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_FS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEC958_AES0_PRO_FS_44100</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEC958_AES0_PRO_FS_48000</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEC958_AES0_PRO_FS_32000</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>		       <span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_EMPHASIS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="o">|</span><span class="n">IEC958_AES0_CON_NOT_COPYRIGHT</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEC958_AES1_CON_CATEGORY</span><span class="o">|</span><span class="n">IEC958_AES1_CON_ORIGINAL</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_CON_EMPHASIS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_CON_NOT_COPYRIGHT</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">new</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>	<span class="c1">// category + original</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">new</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_44100</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_48000</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_32000</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>		       <span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// 44.1</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// 48.0</span>
		<span class="nl">default:</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// illegal.</span>
		<span class="p">}</span>
		<span class="n">change</span> <span class="o">|=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_SPDIF</span><span class="p">,</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xcfff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CX_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">new</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="o">|</span><span class="n">IEC958_AES0_CON_NOT_COPYRIGHT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">AC97_CXR_COPYRGT</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">new</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">?</span> <span class="n">AC97_CXR_SPDIF_AC3</span> <span class="o">:</span> <span class="n">AC97_CXR_SPDIF_PCM</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">|=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CXR_AUDIO_MISC</span><span class="p">,</span> 
						      <span class="n">AC97_CXR_SPDIF_MASK</span> <span class="o">|</span> <span class="n">AC97_CXR_COPYRGT</span><span class="p">,</span>
						      <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_YMF743</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">|=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
						      <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span>
						      <span class="mh">0xff38</span><span class="p">,</span>
						      <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span>
						      <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0038</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">extst</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* turn off */</span>

		<span class="n">change</span> <span class="o">|=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extst</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPDIF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">);</span> <span class="cm">/* turn on again */</span>
                <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_put_spsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>int invert = (kcontrol->private_value >> 24) &amp; 0xff;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">extst</span> <span class="o">=</span> <span class="n">snd_ac97_read_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* turn off */</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extst</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPDIF</span><span class="p">)</span>
			<span class="n">snd_ac97_update_bits_nolock</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">);</span> <span class="cm">/* turn on again */</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_spdif</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_mask_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_cmask_get</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PRO_MASK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_mask_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_pmask_get</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_mask_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_default_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_spdif_default_put</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span><span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;AC97-SPSA&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_info_volsw</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_get_volsw</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_put_spsa</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define AD18XX_PCM_BITS(xname, codec, lshift, rshift, mask) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .info = snd_ac97_ad18xx_pcm_info_bits, \</span>
<span class="cp">  .get = snd_ac97_ad18xx_pcm_get_bits, .put = snd_ac97_ad18xx_pcm_put_bits, \</span>
<span class="cp">  .private_value = (codec) | ((lshift) &lt;&lt; 8) | ((rshift) &lt;&lt; 12) | ((mask) &lt;&lt; 16) }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_info_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lshift</span> <span class="o">!=</span> <span class="n">rshift</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">))</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_get_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">lshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lshift</span> <span class="o">!=</span> <span class="n">rshift</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">))</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_put_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">valmask</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">lshift</span><span class="p">;</span>
	<span class="n">valmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">lshift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lshift</span> <span class="o">!=</span> <span class="n">rshift</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
		<span class="n">valmask</span> <span class="o">|=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_ac97_ad18xx_update_pcm_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">valmask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AD18XX_PCM_VOLUME(xname, codec) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .info = snd_ac97_ad18xx_pcm_info_volume, \</span>
<span class="cp">  .get = snd_ac97_ad18xx_pcm_get_volume, .put = snd_ac97_ad18xx_pcm_put_volume, \</span>
<span class="cp">  .private_value = codec }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad18xx_pcm_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	
	<span class="n">val1</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ac97_ad18xx_update_pcm_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="mh">0x1f1f</span><span class="p">,</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">val2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ad18xx_pcm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AD18XX_PCM_VOLUME</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ad18xx_surround</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;Surround Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AD18XX_PCM_VOLUME</span><span class="p">(</span><span class="s">&quot;Surround Playback Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ad18xx_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;Center Playback Switch&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;Center Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ad18xx_lfe</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;LFE Playback Switch&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AD18XX_PCM_BITS</span><span class="p">(</span><span class="s">&quot;LFE Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_ac97_powerdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_bus_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_bus_proc_done</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_bus_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_bus_free</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_work</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">snd_ac97_proc_done</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="n">snd_ac97_powerdown</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span> <span class="cm">/* for avoiding click noises during shut down */</span>
	<span class="k">return</span> <span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC97_MASTER_TONE</span>:
		<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_BASS_TREBLE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_HEADPHONE</span>:
		<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_HEADPHONE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_REC_GAIN_MIC</span>:
		<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_DEDICATED_MIC</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_3D_CONTROL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_3D_TECH_ID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="cm">/* if nonzero - fixed and we can&#39;t set it */</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_CENTER_LFE_MASTER</span>:	<span class="cm">/* center */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_CDAC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="o">+</span><span class="mi">1</span>:	<span class="cm">/* lfe */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_LDAC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC97_SURROUND_MASTER</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing seems to be here - mute flag is not set */</span>
		<span class="cm">/* try another test */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* nothing here */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* success, useable */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_volume_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lo_max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hi_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cbit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* first look up the static resolution table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">res_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_res_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">res_table</span><span class="p">;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span> <span class="n">tbl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">lo_max</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="o">*</span><span class="n">hi_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">lo_max</span> <span class="o">=</span> <span class="o">*</span><span class="n">hi_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cbit</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span>
			<span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">AC97_MUTE_MASK_STEREO</span> <span class="o">|</span> <span class="n">cbit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">cbit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="p">);</span>
		<span class="cm">/* Do the read twice due to buffers on some ac97 codecs.</span>
<span class="cm">		 * e.g. The STAC9704 returns exactly what you wrote to the register</span>
<span class="cm">		 * if you read it immediately. This causes the detect routine to fail.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">*</span><span class="n">lo_max</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="n">cbit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="o">*</span><span class="n">lo_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">*</span><span class="n">hi_max</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="n">cbit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="o">*</span><span class="n">hi_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">lo_max</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">hi_max</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_try_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">orig</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">orig</span> <span class="o">^</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span> <span class="o">==</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check the volume resolution of center/lfe */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_change_volume_params2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_STEREO</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">val1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* reset volume to zero */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">printable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">x</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mh">0x71</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0x89</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="mh">0x71</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="nf">snd_ac97_cnew</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">_template</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">template</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="n">_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
	<span class="n">template</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create mute switch(es) for normal stereo controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cmute_new_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">check_stereo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">check_amix</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">mute_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mute_mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_stereo</span> <span class="o">||</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* check whether both mute bits work */</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">;</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">==</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
			<span class="n">mute_mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mute_mask</span> <span class="o">==</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_amix</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">private_value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_amix</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">private_value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* mute as default */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">mute_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set dB information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_4bit</span><span class="p">,</span> <span class="o">-</span><span class="mi">4500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_5bit</span><span class="p">,</span> <span class="o">-</span><span class="mi">4650</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_6bit</span><span class="p">,</span> <span class="o">-</span><span class="mi">9450</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_5bit_12db_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">3450</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_rec_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">find_db_scale</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">maxval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0f</span>: <span class="k">return</span> <span class="n">db_scale_4bit</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1f</span>: <span class="k">return</span> <span class="n">db_scale_5bit</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3f</span>: <span class="k">return</span> <span class="n">db_scale_6bit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_tlv_db_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">tlv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv</span><span class="p">)</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a volume for normal stereo/mono controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cvol_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lo_max</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hi_max</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hi_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invert */</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* invert */</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AC97_PHONE</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">AC97_PCM</span><span class="p">)</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_5bit_12db_max</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">find_db_scale</span><span class="p">(</span><span class="n">lo_max</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span>
		<span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
		<span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">lo_max</span> <span class="o">|</span> <span class="p">(</span><span class="n">hi_max</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	<span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a mute-switch and a volume for normal stereo/mono controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cmix_new_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">check_stereo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">check_amix</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lo_max</span><span class="p">,</span> <span class="n">hi_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_ac97_valid_reg</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Switch&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmute_new_stereo</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
						     <span class="n">check_stereo</span><span class="p">,</span> <span class="n">check_amix</span><span class="p">,</span>
						     <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">check_volume_resolution</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo_max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi_max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lo_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Volume&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cvol_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">lo_max</span><span class="p">,</span> <span class="n">hi_max</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_ac97_cmix_new(card, pfx, reg, acheck, ac97) \</span>
<span class="cp">	snd_ac97_cmix_new_stereo(card, pfx, reg, 0, acheck, ac97)</span>
<span class="cp">#define snd_ac97_cmute_new(card, name, reg, acheck, ac97) \</span>
<span class="cp">	snd_ac97_cmute_new_stereo(card, name, reg, 0, acheck, ac97)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_ac97_determine_spdif_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_mixer_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max</span><span class="p">;</span>

	<span class="cm">/* build master controls */</span>
	<span class="cm">/* AD claims to remove this control from AD1887, although spec v2.2 does not allow this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_MASTER_VOL</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmute_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
						 <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span>
						<span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">]</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">;</span>

	<span class="cm">/* build center controls */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">))</span> 
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_AD_MULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">snd_ac97_change_volume_params2</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">max</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">find_db_scale</span><span class="p">(</span><span class="n">max</span><span class="p">));</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">]</span> <span class="o">|</span> <span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* build LFE controls */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_AD_MULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_lfe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_lfe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">snd_ac97_change_volume_params2</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">max</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">find_db_scale</span><span class="p">(</span><span class="n">max</span><span class="p">));</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CENTER_LFE_MASTER</span><span class="p">]</span> <span class="o">|</span> <span class="n">max</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* build surround controls */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SURROUND_MASTER</span><span class="p">))</span> 
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_AD_MULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Surround Master (0x38) is with stereo mutes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new_stereo</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Surround Playback&quot;</span><span class="p">,</span>
						    <span class="n">AC97_SURROUND_MASTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build headphone controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span>
					     <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* build master mono controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Master Mono Playback&quot;</span><span class="p">,</span>
					     <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* build master tone controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_TONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_tone</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_YMF743</span> <span class="o">||</span>
				    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_YMF753</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mh">0x0f0f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="cm">/* build Beep controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_PC_BEEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
		<span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_PC_BEEP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_pc_beep</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_4bit</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span>
			<span class="n">ac97</span><span class="p">,</span>
			<span class="n">AC97_PC_BEEP</span><span class="p">,</span>
			<span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">AC97_MUTE_MASK_MONO</span> <span class="o">|</span> <span class="mh">0x001e</span><span class="p">)</span>
		<span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* build Phone controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_PHONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Phone Playback&quot;</span><span class="p">,</span>
						     <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="cm">/* build MIC controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_MIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Mic Playback&quot;</span><span class="p">,</span>
						     <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_mic_boost</span><span class="p">,</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* build Line controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Line Playback&quot;</span><span class="p">,</span>
					     <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* build CD controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CD Playback&quot;</span><span class="p">,</span>
						     <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="cm">/* build Video controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_VIDEO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Video Playback&quot;</span><span class="p">,</span>
						     <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* build Aux controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_AUX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Aux Playback&quot;</span><span class="p">,</span>
						     <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* build PCM controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_AD_MULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init_val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">)</span>
			<span class="n">init_val</span> <span class="o">=</span> <span class="mh">0x9f9f</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">init_val</span> <span class="o">=</span> <span class="mh">0x9f1f</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_ad18xx_pcm</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_5bit</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SURROUND_DAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_ad18xx_surround</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_5bit</span><span class="p">);</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_CENTER_LFE_DAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_ad18xx_center</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_5bit</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_ad18xx_lfe</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_5bit</span><span class="p">);</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="n">init_val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_STD_PCM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_PCM_VOL</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmute_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
							 <span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">,</span>
							 <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmix_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;PCM Playback&quot;</span><span class="p">,</span>
							<span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* build Capture controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_NO_REC_GAIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_control_capture_src</span><span class="p">,</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_cmute_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span>
						 <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_control_capture_vol</span><span class="p">,</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_rec_gain</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* build MIC Capture controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_mic_capture</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">set_tlv_db_scale</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">db_scale_rec_gain</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* build PCM out path &amp; mute control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_PCM_OUT</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build Simulated Stereo Enhancement control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_SIM_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_STEREO_ENHANCEMENT</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build 3D Stereo Enhancement control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_3D</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build Loudness control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_LOUDNESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_LOUDNESS</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build Mono output select control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_MONO</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build Mic select control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_MIC</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build ADC/DAC loopback control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_loopback</span> <span class="o">&amp;&amp;</span> <span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_general</span><span class="p">[</span><span class="n">AC97_GENERAL_LOOPBACK</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="o">~</span><span class="n">AC97_GP_DRSS_MASK</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* build 3D controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_3d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_3d</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_volume_mix</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x0707</span><span class="p">;</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0x0606</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_3D_CONTROL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_3D_CONTROL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* build S/PDIF controls */</span>

	<span class="cm">/* Hack for ASUS P5P800-VM, which does not indicate S/PDIF capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x810f</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_NO_SPDIF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_spdif</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_spdif</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_spdif</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_post_spdif</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_post_spdif</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* set default PCM S/PDIF params */</span>
			<span class="cm">/* consumer,PCM audio,no copyright,no preemphasis,PCM coder,original,48000Hz */</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="mh">0x2a20</span><span class="p">);</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_ac97_determine_spdif_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spdif_status</span> <span class="o">=</span> <span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* build chip specific controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_specific</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_specific</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_control_eapd</span><span class="p">,</span> <span class="n">ac97</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">kctl</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_INV_EAPD</span><span class="p">)</span>
			<span class="n">set_inv_eapd</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_modem_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;AC97_GPIO_CFG = %x\n&quot;,</span>
<span class="cm">	       snd_ac97_read(ac97,AC97_GPIO_CFG));</span>
<span class="cm">	*/</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">,</span> <span class="mh">0xffff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AC97_GPIO_LINE1_OH</span><span class="p">));</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="mh">0xffff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AC97_GPIO_LINE1_OH</span><span class="p">));</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GPIO_STICKY</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GPIO_WAKEUP</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* build modem switches */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_modem_switches</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_modem_switches</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* build chip specific controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_specific</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">build_specific</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_test_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">rate</span> <span class="o">*</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shadow_reg</span><span class="p">)</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_determine_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">r_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">saved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">no_vra</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">r_result</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DOUBLE_RATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">)</span>
			<span class="o">*</span><span class="n">r_result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">saved</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_DRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">)</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
				     <span class="n">AC97_EA_DRA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* test a non-standard rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">11000</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">;</span>
	<span class="cm">/* let&#39;s try to obtain standard rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">8000</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_8000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">11025</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_11025</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">16000</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_16000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">22050</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_22050</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">32000</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_32000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">44100</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_44100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">48000</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DOUBLE_RATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* test standard double rates */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
				     <span class="n">AC97_EA_DRA</span><span class="p">,</span> <span class="n">AC97_EA_DRA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">64000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_64000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">88200</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_88200</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">96000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">;</span>
		<span class="cm">/* some codecs don&#39;t support variable double rates */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_ac97_test_rate</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="mi">76100</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">;</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
				     <span class="n">AC97_EA_DRA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* restore the default value */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shadow_reg</span><span class="p">)</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">shadow_reg</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>
	<span class="o">*</span><span class="n">r_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check AC97_SPDIF register to accept which sample rates */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_ac97_determine_spdif_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ctl_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AC97_SC_SPSR_44K</span><span class="p">,</span> <span class="n">AC97_SC_SPSR_32K</span><span class="p">,</span> <span class="n">AC97_SC_SPSR_48K</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SNDRV_PCM_RATE_44100</span><span class="p">,</span> <span class="n">SNDRV_PCM_RATE_32000</span><span class="p">,</span> <span class="n">SNDRV_PCM_RATE_48000</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctl_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="n">AC97_SC_SPSR_MASK</span><span class="p">,</span> <span class="n">ctl_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_SC_SPSR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctl_bits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">rate_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* look for the codec id table matching with the given id */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="nf">look_for_codec_id</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
						     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="n">pid</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_ac97_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">modem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;0x%x %c%c%c&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
		<span class="n">printable</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">),</span>
		<span class="n">printable</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
		<span class="n">printable</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">look_for_codec_id</span><span class="p">(</span><span class="n">snd_ac97_codec_id_vendors</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">modem</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_MODEM_PATCH</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span> <span class="n">modem</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_MODEM_PATCH</span><span class="p">)))</span>
			<span class="n">pid</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span> 

	<span class="n">pid</span> <span class="o">=</span> <span class="n">look_for_codec_id</span><span class="p">(</span><span class="n">snd_ac97_codec_ids</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot; rev %d&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">modem</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_MODEM_PATCH</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span> <span class="n">modem</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_MODEM_PATCH</span><span class="p">)))</span>
				<span class="n">pid</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot; id %x&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_get_short_name - retrieve codec name</span>
<span class="cm"> * @ac97: the codec instance</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the short identifying name of the codec.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">snd_ac97_get_short_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">snd_ac97_codec_ids</span><span class="p">;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="n">pid</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;unknown codec&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_get_short_name</span><span class="p">);</span>

<span class="cm">/* wait for a while until registers are accessible after RESET</span>
<span class="cm"> * return 0 if ok, negative not ready</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_reset_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">with_modem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		
		<span class="cm">/* use preliminary reads to settle the communication */</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
		<span class="cm">/* modem? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">with_modem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_DETECT_BY_VENDOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* probably only Xbox issue - all registers are read as zero */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* because the PCM or MASTER volume registers can be modified,</span>
<span class="cm">			 * the REC_GAIN register is used for tests</span>
<span class="cm">			 */</span>
			<span class="cm">/* test if we can write to the record gain volume register */</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x8a05</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0a05</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_bus - create an AC97 bus component</span>
<span class="cm"> * @card: the card instance</span>
<span class="cm"> * @num: the bus number</span>
<span class="cm"> * @ops: the bus callbacks table</span>
<span class="cm"> * @private_data: private data pointer for the new instance</span>
<span class="cm"> * @rbus: the pointer to store the new AC97 bus instance.</span>
<span class="cm"> *</span>
<span class="cm"> * Creates an AC97 bus component.  An struct snd_ac97_bus instance is newly</span>
<span class="cm"> * allocated and initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * The ops table must include valid callbacks (at least read and</span>
<span class="cm"> * write).  The other callbacks, wait and reset, are not mandatory.</span>
<span class="cm"> * </span>
<span class="cm"> * The clock is set to 48000.  If another clock is needed, set</span>
<span class="cm"> * (*rbus)-&gt;clock manually.</span>
<span class="cm"> *</span>
<span class="cm"> * The AC97 bus instance is registered as a low-level device, so you don&#39;t</span>
<span class="cm"> * have to release it manually.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if successful, or a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">**</span><span class="n">rbus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">dev_ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_ac97_bus_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">private_data</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_lock</span><span class="p">);</span>
	<span class="n">snd_ac97_bus_proc_init</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_BUS</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_bus_free</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbus</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rbus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_bus</span><span class="p">);</span>

<span class="cm">/* stop no dev release warning */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ac97_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* register ac97 codec to bus */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_dev_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac97_bus_type</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ac97_device_release</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d-%d:%s&quot;</span><span class="p">,</span>
		     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
		     <span class="n">snd_ac97_get_short_name</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t register ac97 bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disconnect ac97 codec */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_dev_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* build_ops to do nothing */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">null_build_ops</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">update_power_regs</span><span class="p">(</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97</span><span class="p">,</span> <span class="n">power_work</span><span class="p">.</span><span class="n">work</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_mixer - create an Codec97 component</span>
<span class="cm"> * @bus: the AC97 bus which codec is attached to</span>
<span class="cm"> * @template: the template of ac97, including index, callbacks and</span>
<span class="cm"> *         the private data.</span>
<span class="cm"> * @rac97: the pointer to store the new ac97 instance.</span>
<span class="cm"> *</span>
<span class="cm"> * Creates an Codec97 component.  An struct snd_ac97 instance is newly</span>
<span class="cm"> * allocated and initialized from the template.  The codec</span>
<span class="cm"> * is then initialized by the standard procedure.</span>
<span class="cm"> *</span>
<span class="cm"> * The template must include the codec number (num) and address (addr),</span>
<span class="cm"> * and the private data (private_data).</span>
<span class="cm"> * </span>
<span class="cm"> * The ac97 instance is registered as a low-level device, so you don&#39;t</span>
<span class="cm"> * have to release it manually.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if successful, or a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="o">*</span><span class="n">template</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">**</span><span class="n">rac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_codec_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_ac97_dev_free</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev_register</span> <span class="o">=</span>	<span class="n">snd_ac97_dev_register</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev_disconnect</span> <span class="o">=</span>	<span class="n">snd_ac97_dev_disconnect</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rac97</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bus</span> <span class="o">||</span> <span class="o">!</span><span class="n">template</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">template</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">[</span><span class="n">template</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">ac97</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ac97</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">scaps</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">res_table</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">res_table</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_work</span><span class="p">,</span> <span class="n">do_update_power</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__access_ok</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">look_for_codec_id</span><span class="p">(</span><span class="n">snd_ac97_codec_ids</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DEFAULT_POWER_OFF</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">__access_ok</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset to defaults */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span><span class="p">))</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_MODEM</span><span class="p">))</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ac97_reset_wait</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ac97_reset_wait</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ac97_reset_wait</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
						      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;AC&#39;97 %d does not respond - RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="cm">/* proceed anyway - it&#39;s often non-critical */</span>
		<span class="p">}</span>
	<span class="p">}</span>
      <span class="nl">__access_ok:</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_DETECT_BY_VENDOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x00000000</span> <span class="o">||</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 %d access is not valid [0x%x], removing mixer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">look_for_codec_id</span><span class="p">(</span><span class="n">snd_ac97_codec_ids</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	
	<span class="cm">/* test for AC&#39;97 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_AUDIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* test if we can write to the record gain volume register */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x8a06</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0a06</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_AUDIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_AUDIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>	<span class="cm">/* invalid combination */</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* test for MC&#39;97 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_MODEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_MODEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>	<span class="cm">/* invalid combination */</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_MODEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ac97_is_modem</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AC97_SCAP_SKIP_AUDIO</span><span class="o">|</span><span class="n">AC97_SCAP_SKIP_MODEM</span><span class="p">)))</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 %d access error (not audio or modem codec)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="c1">// FIXME: always skipping?</span>
		<span class="k">goto</span> <span class="n">__ready_ok</span><span class="p">;</span>

	<span class="cm">/* FIXME: add powerdown control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing should be in powerdown mode */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DEFAULT_POWER_OFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* reset to defaults */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* nothing should be in powerdown mode */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__ready_ok</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;AC&#39;97 %d analog subsections not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: add powerdown control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_modem</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* nothing should be in powerdown mode */</span>
		<span class="cm">/* note: it&#39;s important to set the rate at first */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AC97_MEA_GPIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_RATE</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AC97_MEA_ADC1</span> <span class="o">|</span> <span class="n">AC97_MEA_DAC1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE2_RATE</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AC97_MEA_ADC2</span> <span class="o">|</span> <span class="n">AC97_MEA_DAC2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_HANDSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_HANDSET_RATE</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AC97_MEA_HADC</span> <span class="o">|</span> <span class="n">AC97_MEA_HDAC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* nothing should be in powerdown mode */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__ready_ok</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MC&#39;97 %d converters and GPIO not ready (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">));</span>
	<span class="p">}</span>
	
      <span class="nl">__ready_ok:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_EI_ADDR_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_MEI_ADDR_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="mh">0x01c9</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* L/R, MIC, SDAC, LDAC VRA support */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="mh">0x01c0</span><span class="p">;</span> <span class="cm">/* LDAC/SDAC/CDAC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">no_vra</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="mh">0x0009</span><span class="p">;</span> <span class="cm">/* VRA/VRM */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_DRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dra</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Intel controllers require double rate data to be put in</span>
<span class="cm">		 * slots 7+8, so let&#39;s hope the codec supports it. */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="n">AC97_GP_DRSS_MASK</span><span class="p">,</span> <span class="n">AC97_GP_DRSS_78</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_GP_DRSS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC97_GP_DRSS_78</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_DOUBLE_RATE</span><span class="p">;</span>
		<span class="cm">/* restore to slots 10/11 to avoid the confliction with surrounds */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="n">AC97_GP_DRSS_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRA</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* VRA support */</span>
		<span class="n">snd_ac97_determine_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_FRONT_DAC</span><span class="p">]);</span>
		<span class="n">snd_ac97_determine_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_ADC</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_FRONT_DAC</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DOUBLE_RATE</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_FRONT_DAC</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_ADC</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* codec specific code (patch) should override these values */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_32000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRM</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* MIC VRA support */</span>
		<span class="n">snd_ac97_determine_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_MIC_ADC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_MIC_ADC</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_MIC_ADC</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SDAC support */</span>
		<span class="n">snd_ac97_determine_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_SURR_DAC_RATE</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SURR_DAC</span><span class="p">]);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_SURROUND_DAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_LDAC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* LDAC support */</span>
		<span class="n">snd_ac97_determine_rates</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LFE_DAC_RATE</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_LFE_DAC</span><span class="p">]);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_CENTER_LFE_DAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* additional initializations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_get_name</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">!</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">snd_ac97_get_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">!</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>  <span class="c1">// ac97-&gt;id might be changed in the special setup code</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">null_build_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">comp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s">&quot;AC97a:%08x&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_component_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_mixer_build</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_modem</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">comp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s">&quot;AC97m:%08x&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_component_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_modem_build</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ac97</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">update_power_regs</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_proc_init</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CODEC</span><span class="p">,</span> <span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_free</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">rac97</span> <span class="o">=</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_mixer</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Power down the chip.</span>
<span class="cm"> *</span>
<span class="cm"> * MASTER and HEADPHONE registers are muted but the register cache values</span>
<span class="cm"> * are not changed, so that the values can be restored in snd_ac97_resume().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_powerdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">power</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* some codecs have stereo mute bits */</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x9f9f</span><span class="p">);</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mh">0x9f9f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* surround, CLFE, mic powerdown */</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_EXTENDED_STATUS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SURROUND_DAC</span><span class="p">)</span>
		<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_EA_PRJ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_CENTER_LFE_DAC</span><span class="p">)</span>
		<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_EA_PRI</span> <span class="o">|</span> <span class="n">AC97_EA_PRK</span><span class="p">;</span>
	<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_EA_PRL</span><span class="p">;</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="cm">/* powerdown external amplifier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_INV_EAPD</span><span class="p">)</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_POWERDOWN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC97_PD_EAPD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_EAPD_LED</span><span class="p">))</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_POWERDOWN</span><span class="p">]</span> <span class="o">|</span> <span class="n">AC97_PD_EAPD</span><span class="p">;</span>
	<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_PD_PR6</span><span class="p">;</span>	<span class="cm">/* Headphone amplifier powerdown */</span>
	<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_PD_PR0</span> <span class="o">|</span> <span class="n">AC97_PD_PR1</span><span class="p">;</span>	<span class="cm">/* ADC &amp; DAC powerdown */</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_PD_PR2</span><span class="p">;</span>	<span class="cm">/* Analog Mixer powerdown (Vref on) */</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_power_save_mode</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_PD_PR3</span><span class="p">;</span>	<span class="cm">/* Analog Mixer powerdown */</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* AC-link powerdown, internal Clk disable */</span>
		<span class="cm">/* FIXME: this may cause click noises on some boards */</span>
		<span class="n">power</span> <span class="o">|=</span> <span class="n">AC97_PD_PR4</span> <span class="o">|</span> <span class="n">AC97_PD_PR5</span><span class="p">;</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">ac97_power_reg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">power_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">PWIDX_ADC</span><span class="p">,</span> <span class="n">PWIDX_FRONT</span><span class="p">,</span> <span class="n">PWIDX_CLFE</span><span class="p">,</span> <span class="n">PWIDX_SURR</span><span class="p">,</span> <span class="n">PWIDX_MIC</span><span class="p">,</span> <span class="n">PWIDX_SIZE</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97_power_reg</span> <span class="n">power_regs</span><span class="p">[</span><span class="n">PWIDX_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PWIDX_ADC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">AC97_PD_PR0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">PWIDX_FRONT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">AC97_PD_PR1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">PWIDX_CLFE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AC97_PCM_LFE_DAC_RATE</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
			 <span class="n">AC97_EA_PRI</span> <span class="o">|</span> <span class="n">AC97_EA_PRK</span><span class="p">},</span>
	<span class="p">[</span><span class="n">PWIDX_SURR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AC97_PCM_SURR_DAC_RATE</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
			 <span class="n">AC97_EA_PRJ</span><span class="p">},</span>
	<span class="p">[</span><span class="n">PWIDX_MIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AC97_PCM_MIC_ADC_RATE</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
			<span class="n">AC97_EA_PRL</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
<span class="cm">/**</span>
<span class="cm"> * snd_ac97_update_power - update the powerdown register</span>
<span class="cm"> * @ac97: the codec instance</span>
<span class="cm"> * @reg: the rate register, e.g. AC97_PCM_FRONT_DAC_RATE</span>
<span class="cm"> * @powerup: non-zero when power up the part</span>
<span class="cm"> *</span>
<span class="cm"> * Update the AC97 powerdown register bits of the given part.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_ac97_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">powerup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SPDIF requires DAC power, too */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_SPDIF</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PWIDX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">power_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">powerup</span><span class="p">)</span>
					<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_up</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_up</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_power_save_mode</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">powerup</span><span class="p">)</span>
		<span class="cm">/* adjust power-down bits after two seconds delay</span>
<span class="cm">		 * (for avoiding loud click noises for many (OSS) apps</span>
<span class="cm">		 *  that open/close frequently)</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">power_save</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_work</span><span class="p">);</span>
		<span class="n">update_power_regs</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_update_power</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_AC97_POWER_SAVE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_power_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power_up</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">power_up</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWIDX_FRONT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWIDX_ADC</span><span class="p">);</span>
	<span class="n">power_up</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWIDX_MIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SURROUND_DAC</span><span class="p">)</span>
		<span class="n">power_up</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWIDX_SURR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_CENTER_LFE_DAC</span><span class="p">)</span>
		<span class="n">power_up</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWIDX_CLFE</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_power_save_mode</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">power_up</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_up</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_POWERDOWN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_PD_PR2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* needs power-up analog mix and vref */</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
					     <span class="n">AC97_PD_PR3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
					     <span class="n">AC97_PD_PR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PWIDX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_up</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="n">power_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">power_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">power_reg</span><span class="p">,</span>
				     <span class="n">power_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">power_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_POWERDOWN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_PD_PR2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* power down analog mix and vref */</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
					     <span class="n">AC97_PD_PR2</span><span class="p">,</span> <span class="n">AC97_PD_PR2</span><span class="p">);</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
					     <span class="n">AC97_PD_PR3</span><span class="p">,</span> <span class="n">AC97_PD_PR3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> * snd_ac97_suspend - General suspend function for AC97 codec</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> *</span>
<span class="cm"> * Suspends the codec, power down the chip.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_ac97_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">power_work</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_ac97_powerdown</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_suspend</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * restore ac97 status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_restore_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x7c</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">AC97_POWERDOWN</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* restore only accessible registers</span>
<span class="cm">		 * some chip (e.g. nm256) may hang up when unsupported registers</span>
<span class="cm">		 * are accessed..!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * restore IEC958 status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_restore_iec958</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_EXTENDED_STATUS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPDIF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset spdif status */</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_EXTENDED_STATUS</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span>
				<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_SPDIF</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CSR_SPDIF</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_SPDIF</span><span class="p">]);</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">,</span> <span class="n">AC97_EA_SPDIF</span><span class="p">);</span> <span class="cm">/* turn on again */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_resume - General resume function for AC97 codec</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> *</span>
<span class="cm"> * Do the standard resume procedure, power up and restoring the</span>
<span class="cm"> * old register values.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_ac97_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">goto</span>  <span class="n">__reset_ready</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_DEFAULT_POWER_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span><span class="p">))</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_SKIP_MODEM</span><span class="p">))</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_POWERDOWN</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x8101</span><span class="p">);</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8101</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="cm">/* FIXME: extra delay */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">__reset_ready:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_ac97_restore_status</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="n">snd_ac97_restore_iec958</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_resume</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Hardware tuning</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ctl_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>	

<span class="cm">/* remove the control with the given name and optional suffix */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_remove_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="n">set_ctl_name</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_remove_id</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="nf">ctl_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid</span><span class="p">));</span>
	<span class="n">set_ctl_name</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="n">sid</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* rename the control with the given name and optional suffix */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_rename_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_ctl_name</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rename both Volume and Switch controls - don&#39;t check the return value */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_rename_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_rename_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* swap controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_swap_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s2</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl1</span><span class="p">,</span> <span class="o">*</span><span class="n">kctl2</span><span class="p">;</span>
	<span class="n">kctl1</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="n">kctl2</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl1</span> <span class="o">&amp;&amp;</span> <span class="n">kctl2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_ctl_name</span><span class="p">(</span><span class="n">kctl1</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
		<span class="n">set_ctl_name</span><span class="p">(</span><span class="n">kctl2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 1</span>
<span class="cm">/* bind hp and master controls instead of using only hp control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bind_hp_volsw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv_saved</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
		<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">AC97_HEADPHONE</span><span class="p">;</span>
		<span class="n">snd_ac97_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
		<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">priv_saved</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ac97 tune: bind Master and Headphone controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_hp_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">msw</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">mvol</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">msw</span> <span class="o">||</span> <span class="o">!</span> <span class="n">mvol</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">msw</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="n">bind_hp_volsw_put</span><span class="p">;</span>
	<span class="n">mvol</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="n">bind_hp_volsw_put</span><span class="p">;</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cm">/* ac97 tune: use Headphone control as master */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_hp_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* ac97 tune: swap Headphone and Master controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_swap_hp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Line-Out Playback&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ac97 tune: swap Surround and Master controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_swap_surround</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_swap_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Surround Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">snd_ac97_swap_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Surround Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ac97 tune: set up mic sharing for AD codecs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_ad_sharing</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">scfg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x41445300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ac97_quirk AD_SHARING is only for AD codecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Turn on OMS bit to route microphone to back panel */</span>
	<span class="n">scfg</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="n">scfg</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_alc_jack_detect</span> <span class="o">=</span> 
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Jack Detect&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* ac97 tune: set up ALC jack-select */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_alc_jack</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x414c4700</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ac97_quirk ALC_JACK is only for Realtek codecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="cm">/* select jack detect function */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Line-out auto mute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_ALC658D</span><span class="p">)</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_alc_jack_detect</span><span class="p">,</span> <span class="n">ac97</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* ac97 tune: inversed EAPD bit */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_inv_eapd</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;External Amplifier&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">kctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">set_inv_eapd</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">master_mute_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">;</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">AC97_PD_EAPD</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_MASTER</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span> <span class="o">?</span>
				     <span class="n">AC97_PD_EAPD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ac97 tune: EAPD controls mute LED bound with the master mute */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_mute_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">msw</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">msw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">msw</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="n">master_mute_sw_put</span><span class="p">;</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;External Amplifier&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span>
		<span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
		<span class="n">AC97_PD_EAPD</span><span class="p">,</span> <span class="n">AC97_PD_EAPD</span> <span class="cm">/* mute LED on */</span>
	<span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_EAPD_LED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_master_mute_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">bind_hp_volsw_put</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_STEREO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">AC97_MUTE_MASK_MONO</span><span class="p">;</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">AC97_PD_EAPD</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_MASTER</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span> <span class="o">?</span>
				     <span class="n">AC97_PD_EAPD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tune_hp_mute_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">msw</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">mvol</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">msw</span> <span class="o">||</span> <span class="o">!</span> <span class="n">mvol</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">msw</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="n">hp_master_mute_sw_put</span><span class="p">;</span>
	<span class="n">mvol</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="n">bind_hp_volsw_put</span><span class="p">;</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;External Amplifier&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span>
		<span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
		<span class="n">AC97_PD_EAPD</span><span class="p">,</span> <span class="n">AC97_PD_EAPD</span> <span class="cm">/* mute LED on */</span>
	<span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">quirk_table</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_table</span> <span class="n">applicable_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;hp_only&quot;</span><span class="p">,</span> <span class="n">tune_hp_only</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;swap_hp&quot;</span><span class="p">,</span> <span class="n">tune_swap_hp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;swap_surround&quot;</span><span class="p">,</span> <span class="n">tune_swap_surround</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad_sharing&quot;</span><span class="p">,</span> <span class="n">tune_ad_sharing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;alc_jack&quot;</span><span class="p">,</span> <span class="n">tune_alc_jack</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;inv_eapd&quot;</span><span class="p">,</span> <span class="n">tune_inv_eapd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mute_led&quot;</span><span class="p">,</span> <span class="n">tune_mute_led</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;hp_mute_led&quot;</span><span class="p">,</span> <span class="n">tune_hp_mute_led</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* apply the quirk with the given type */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">applicable_quirks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">applicable_quirks</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">applicable_quirks</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">func</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* apply the quirk with the given name */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_quirk_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typestr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">quirk_table</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">applicable_quirks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">applicable_quirks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">typestr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">apply_quirk</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* for compatibility, accept the numbers, too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">typestr</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">typestr</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">apply_quirk</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">typestr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_ac97_tune_hardware - tune up the hardware</span>
<span class="cm"> * @ac97: the ac97 instance</span>
<span class="cm"> * @quirk: quirk list</span>
<span class="cm"> * @override: explicit quirk value (overrides the list if non-NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * Do some workaround for each pci device, such as renaming of the</span>
<span class="cm"> * headphone (true line-out) control as &quot;Master&quot;.</span>
<span class="cm"> * The quirk-list must be terminated with a zero-filled entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if successful, or a negative error code on failure.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">snd_ac97_tune_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ac97_quirk</span> <span class="o">*</span><span class="n">quirk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* quirk overriden? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">override</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="s">&quot;-1&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">apply_quirk_str</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;applying quirk type %s failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">override</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">quirk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">subvendor</span><span class="p">;</span> <span class="n">quirk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">!=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;&amp;</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">==</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">==</span> <span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">codec_id</span> <span class="o">&amp;&amp;</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">codec_id</span> <span class="o">!=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;ac97 quirk for %s (%04x:%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">apply_quirk</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;applying quirk type %d for %s failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_ac97_tune_hardware</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  INIT part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_ac97_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_ac97_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_ac97_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_ac97_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
