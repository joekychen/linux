<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ac97 › ac97_proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ac97_proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *  Universal interface for Audio Codec &#39;97</span>
<span class="cm"> *</span>
<span class="cm"> *  For more details look to AC &#39;97 component specification revision 2.2</span>
<span class="cm"> *  by Intel Corporation (http://developer.intel.com).</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &quot;ac97_local.h&quot;</span>
<span class="cp">#include &quot;ac97_id.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_read_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">info</span><span class="p">,</span> <span class="n">sense_info</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function_names</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Master Out&quot;</span><span class="p">,</span> <span class="s">&quot;AUX Out&quot;</span><span class="p">,</span> <span class="s">&quot;Center/LFE Out&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF Out&quot;</span><span class="p">,</span>
		<span class="s">&quot;Phone In&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 1&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 2&quot;</span><span class="p">,</span> <span class="s">&quot;Line In&quot;</span><span class="p">,</span> <span class="s">&quot;CD In&quot;</span><span class="p">,</span> <span class="s">&quot;Video In&quot;</span><span class="p">,</span>
		<span class="s">&quot;Aux In&quot;</span><span class="p">,</span> <span class="s">&quot;Mono Out&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">locations</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Rear I/O Panel&quot;</span><span class="p">,</span> <span class="s">&quot;Front Panel&quot;</span><span class="p">,</span> <span class="s">&quot;Motherboard&quot;</span><span class="p">,</span> <span class="s">&quot;Dock/External&quot;</span><span class="p">,</span>
		<span class="s">&quot;reserved&quot;</span><span class="p">,</span> <span class="s">&quot;reserved&quot;</span><span class="p">,</span> <span class="s">&quot;reserved&quot;</span><span class="p">,</span> <span class="s">&quot;NC/unused&quot;</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">function</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="o">++</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_FUNC_SELECT</span><span class="p">,</span> <span class="n">function</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_FUNC_INFO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">                    Gain     Inverted  Buffer delay  Location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sense_info</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SENSE_INFO</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%-17s: %3d.%d dBV    %c      %2d/fs         %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">function_names</span><span class="p">[</span><span class="n">function</span><span class="p">],</span>
			    <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
			    <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
			    <span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x0400</span> <span class="o">?</span> <span class="sc">&#39;X&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0x03e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
			    <span class="n">locations</span><span class="p">[</span><span class="n">sense_info</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">snd_ac97_stereo_enhancements</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="cm">/*   0 */</span> <span class="s">&quot;No 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   1 */</span> <span class="s">&quot;Analog Devices Phat Stereo&quot;</span><span class="p">,</span>
  <span class="cm">/*   2 */</span> <span class="s">&quot;Creative Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   3 */</span> <span class="s">&quot;National Semi 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   4 */</span> <span class="s">&quot;YAMAHA Ymersion&quot;</span><span class="p">,</span>
  <span class="cm">/*   5 */</span> <span class="s">&quot;BBE 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   6 */</span> <span class="s">&quot;Crystal Semi 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   7 */</span> <span class="s">&quot;Qsound QXpander&quot;</span><span class="p">,</span>
  <span class="cm">/*   8 */</span> <span class="s">&quot;Spatializer 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*   9 */</span> <span class="s">&quot;SRS 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  10 */</span> <span class="s">&quot;Platform Tech 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  11 */</span> <span class="s">&quot;AKM 3D Audio&quot;</span><span class="p">,</span>
  <span class="cm">/*  12 */</span> <span class="s">&quot;Aureal Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  13 */</span> <span class="s">&quot;Aztech 3D Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  14 */</span> <span class="s">&quot;Binaura 3D Audio Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  15 */</span> <span class="s">&quot;ESS Technology Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  16 */</span> <span class="s">&quot;Harman International VMAx&quot;</span><span class="p">,</span>
  <span class="cm">/*  17 */</span> <span class="s">&quot;Nvidea/IC Ensemble/KS Waves 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  18 */</span> <span class="s">&quot;Philips Incredible Sound&quot;</span><span class="p">,</span>
  <span class="cm">/*  19 */</span> <span class="s">&quot;Texas Instruments 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  20 */</span> <span class="s">&quot;VLSI Technology 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  21 */</span> <span class="s">&quot;TriTech 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  22 */</span> <span class="s">&quot;Realtek 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  23 */</span> <span class="s">&quot;Samsung 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  24 */</span> <span class="s">&quot;Wolfson Microelectronics 3D Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  25 */</span> <span class="s">&quot;Delta Integration 3D Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  26 */</span> <span class="s">&quot;SigmaTel 3D Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  27 */</span> <span class="s">&quot;IC Ensemble/KS Waves&quot;</span><span class="p">,</span>
  <span class="cm">/*  28 */</span> <span class="s">&quot;Rockwell 3D Stereo Enhancement&quot;</span><span class="p">,</span>
  <span class="cm">/*  29 */</span> <span class="s">&quot;Reserved 29&quot;</span><span class="p">,</span>
  <span class="cm">/*  30 */</span> <span class="s">&quot;Reserved 30&quot;</span><span class="p">,</span>
  <span class="cm">/*  31 */</span> <span class="s">&quot;Reserved 31&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_read_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">mext</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spdif_slots</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot; SPDIF=3/4&quot;</span><span class="p">,</span> <span class="s">&quot; SPDIF=7/8&quot;</span><span class="p">,</span> <span class="s">&quot; SPDIF=6/9&quot;</span><span class="p">,</span> <span class="s">&quot; SPDIF=10/11&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spdif_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot; Rate=44.1kHz&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=res&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=48kHz&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=32kHz&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spdif_rates_cs4205</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot; Rate=48kHz&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=44.1kHz&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=res&quot;</span><span class="p">,</span> <span class="s">&quot; Rate=res&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">double_rate_slots</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;10/11&quot;</span><span class="p">,</span> <span class="s">&quot;7/8&quot;</span><span class="p">,</span> <span class="s">&quot;reserved&quot;</span><span class="p">,</span> <span class="s">&quot;reserved&quot;</span> <span class="p">};</span>

	<span class="n">snd_ac97_get_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%d-%d/%d: %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">subidx</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;</span> <span class="n">AC97_SCAP_AUDIO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__modem</span><span class="p">;</span>

        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCI Subsys Vendor: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	            <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCI Subsys Device: 0x%04x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Flags: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_REV_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AC97_EI_REV_23</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span>
				     <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">AC97_PAGE_1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Revision         : 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Compat. Class    : 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Subsys. Vendor ID: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">));</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Subsys. ID       : 0x%04x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCI_SID</span><span class="p">));</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span>
				     <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_PAGE_MASK</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>val = snd<em>ac97</em>read(ac97, AC97_RESET);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Capabilities     :%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    	    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_DEDICATED_MIC</span> <span class="o">?</span> <span class="s">&quot; -dedicated MIC PCM IN channel-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_RESERVED1</span> <span class="o">?</span> <span class="s">&quot; -reserved1-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_BASS_TREBLE</span> <span class="o">?</span> <span class="s">&quot; -bass &amp; treble-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_SIM_STEREO</span> <span class="o">?</span> <span class="s">&quot; -simulated stereo-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_HEADPHONE</span> <span class="o">?</span> <span class="s">&quot; -headphone out-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_BC_LOUDNESS</span> <span class="o">?</span> <span class="s">&quot; -loudness-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_DAC_MASK</span><span class="p">;</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;DAC resolution   : %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_16BIT_DAC</span> <span class="o">?</span> <span class="s">&quot;16-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_18BIT_DAC</span> <span class="o">?</span> <span class="s">&quot;18-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_20BIT_DAC</span> <span class="o">?</span> <span class="s">&quot;20-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_DAC_MASK</span> <span class="o">?</span> <span class="s">&quot;???&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC97_BC_ADC_MASK</span><span class="p">;</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADC resolution   : %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_16BIT_ADC</span> <span class="o">?</span> <span class="s">&quot;16-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_18BIT_ADC</span> <span class="o">?</span> <span class="s">&quot;18-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_20BIT_ADC</span> <span class="o">?</span> <span class="s">&quot;20-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">tmp</span> <span class="o">==</span> <span class="n">AC97_BC_ADC_MASK</span> <span class="o">?</span> <span class="s">&quot;???&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;3D enhancement   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">snd_ac97_stereo_enhancements</span><span class="p">[(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Current setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Mic gain         : %s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0040</span> <span class="o">?</span> <span class="s">&quot;+20dB&quot;</span> <span class="o">:</span> <span class="s">&quot;+0dB&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_MIC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0040</span> <span class="o">?</span> <span class="s">&quot;+20dB&quot;</span> <span class="o">:</span> <span class="s">&quot;+0dB&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;POP path         : %s 3D</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Sim. stereo      : %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;3D enhancement   : %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Loudness         : %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Mono output      : %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Mic select       : %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;ADC/DAC loopback : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="o">?</span> <span class="s">&quot;post&quot;</span> <span class="o">:</span> <span class="s">&quot;pre&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x4000</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x2000</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1000</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0200</span> <span class="o">?</span> <span class="s">&quot;Mic&quot;</span> <span class="o">:</span> <span class="s">&quot;MIX&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0100</span> <span class="o">?</span> <span class="s">&quot;Mic2&quot;</span> <span class="o">:</span> <span class="s">&quot;Mic1&quot;</span><span class="p">,</span>
		    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0080</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_DRA</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Double rate slots: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">double_rate_slots</span><span class="p">[(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">]);</span>

	<span class="n">ext</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__modem</span><span class="p">;</span>
		
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Extended ID      : codec=%i rev=%i%s%s%s%s DSA=%i%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_EI_ADDR_SHIFT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_REV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_EI_REV_SHIFT</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_AMAP</span> <span class="o">?</span> <span class="s">&quot; AMAP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_LDAC</span> <span class="o">?</span> <span class="s">&quot; LDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span> <span class="o">?</span> <span class="s">&quot; SDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_CDAC</span> <span class="o">?</span> <span class="s">&quot; CDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_DACS_SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_EI_DACS_SLOT_SHIFT</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRM</span> <span class="o">?</span> <span class="s">&quot; VRM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span> <span class="o">?</span> <span class="s">&quot; SPDIF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_DRA</span> <span class="o">?</span> <span class="s">&quot; DRA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRA</span> <span class="o">?</span> <span class="s">&quot; VRA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Extended status  :%s%s%s%s%s%s%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_PRL</span> <span class="o">?</span> <span class="s">&quot; PRL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_PRK</span> <span class="o">?</span> <span class="s">&quot; PRK&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_PRJ</span> <span class="o">?</span> <span class="s">&quot; PRJ&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_PRI</span> <span class="o">?</span> <span class="s">&quot; PRI&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPCV</span> <span class="o">?</span> <span class="s">&quot; SPCV&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_MDAC</span> <span class="o">?</span> <span class="s">&quot; MADC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_LDAC</span> <span class="o">?</span> <span class="s">&quot; LDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SDAC</span> <span class="o">?</span> <span class="s">&quot; SDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_CDAC</span> <span class="o">?</span> <span class="s">&quot; CDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span> <span class="o">?</span> <span class="n">spdif_slots</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPSA_SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_EA_SPSA_SLOT_SHIFT</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_VRM</span> <span class="o">?</span> <span class="s">&quot; VRM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPDIF</span> <span class="o">?</span> <span class="s">&quot; SPDIF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_DRA</span> <span class="o">?</span> <span class="s">&quot; DRA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_VRA</span> <span class="o">?</span> <span class="s">&quot; VRA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRA</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* VRA */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCM front DAC    : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_SURR_DAC_RATE</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCM Surr DAC     : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_LDAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LFE_DAC_RATE</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCM LFE DAC      : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCM ADC          : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_VRM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_MIC_ADC_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PCM MIC ADC      : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_YMF743</span><span class="p">))</span> <span class="p">{</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_SPDIF</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_YMF743</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x2000</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">);</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SPDIF Control    :%s%s%s%s Category=0x%x Generation=%i%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_PRO</span> <span class="o">?</span> <span class="s">&quot; PRO&quot;</span> <span class="o">:</span> <span class="s">&quot; Consumer&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_NAUDIO</span> <span class="o">?</span> <span class="s">&quot; Non-audio&quot;</span> <span class="o">:</span> <span class="s">&quot; PCM&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_COPY</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; Copyright&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_PRE</span> <span class="o">?</span> <span class="s">&quot; Preemph50/15&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_CC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_SC_CC_SHIFT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">spdif_rates_cs4205</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_SPSR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_SC_SPSR_SHIFT</span><span class="p">]</span> <span class="o">:</span>
			    <span class="n">spdif_rates</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_SPSR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_SC_SPSR_SHIFT</span><span class="p">],</span>
			<span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_DRS</span> <span class="o">?</span> <span class="s">&quot; Validity&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_DRS</span> <span class="o">?</span> <span class="s">&quot; DRS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_CS_SPDIF</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_V</span> <span class="o">?</span> <span class="s">&quot; Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_SC_V</span> <span class="o">?</span> <span class="s">&quot; Validity&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
		<span class="cm">/* ALC650 specific*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x414c4720</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SPDIF_INPUT_STATUS2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_CLOCK_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SPDIF_INPUT_STATUS1</span><span class="p">);</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SPDIF In Status  :%s%s%s%s Category=0x%x Generation=%i&quot;</span><span class="p">,</span>
					    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_PRO</span> <span class="o">?</span> <span class="s">&quot; PRO&quot;</span> <span class="o">:</span> <span class="s">&quot; Consumer&quot;</span><span class="p">,</span>
					    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_NAUDIO</span> <span class="o">?</span> <span class="s">&quot; Non-audio&quot;</span> <span class="o">:</span> <span class="s">&quot; PCM&quot;</span><span class="p">,</span>
					    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_COPY</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; Copyright&quot;</span><span class="p">,</span>
					    <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_PRE</span> <span class="o">?</span> <span class="s">&quot; Preemph50/15&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_CC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_ALC650_CC_SHIFT</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SPDIF_INPUT_STATUS2</span><span class="p">);</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s Accuracy=%i%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">spdif_rates</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_SPSR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_ALC650_SPSR_SHIFT</span><span class="p">],</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_CLOCK_ACCURACY</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_ALC650_CLOCK_SHIFT</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_CLOCK_LOCK</span> <span class="o">?</span> <span class="s">&quot; Locked&quot;</span> <span class="o">:</span> <span class="s">&quot; Unlocked&quot;</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_ALC650_V</span> <span class="o">?</span> <span class="s">&quot; Validity?&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SPDIF In Status  : Not Locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_REV_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AC97_EI_REV_23</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span>
				     <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">AC97_PAGE_1</span><span class="p">);</span>
		<span class="n">snd_ac97_proc_read_functions</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span>
				     <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_PAGE_MASK</span><span class="p">);</span>
	<span class="p">}</span>


      <span class="nl">__modem:</span>
	<span class="n">mext</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Extended modem ID: codec=%i%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC97_MEI_ADDR_SHIFT</span><span class="p">,</span>
			<span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_CID2</span> <span class="o">?</span> <span class="s">&quot; CID2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_CID1</span> <span class="o">?</span> <span class="s">&quot; CID1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_HANDSET</span> <span class="o">?</span> <span class="s">&quot; HSET&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE2</span> <span class="o">?</span> <span class="s">&quot; LIN2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE1</span> <span class="o">?</span> <span class="s">&quot; LIN1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Modem status     :%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_GPIO</span> <span class="o">?</span> <span class="s">&quot; GPIO&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_MREF</span> <span class="o">?</span> <span class="s">&quot; MREF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_ADC1</span> <span class="o">?</span> <span class="s">&quot; ADC1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_DAC1</span> <span class="o">?</span> <span class="s">&quot; DAC1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_ADC2</span> <span class="o">?</span> <span class="s">&quot; ADC2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_DAC2</span> <span class="o">?</span> <span class="s">&quot; DAC2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_HADC</span> <span class="o">?</span> <span class="s">&quot; HADC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_HDAC</span> <span class="o">?</span> <span class="s">&quot; HDAC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRA</span> <span class="o">?</span> <span class="s">&quot; PRA(GPIO)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRB</span> <span class="o">?</span> <span class="s">&quot; PRB(res)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRC</span> <span class="o">?</span> <span class="s">&quot; PRC(ADC1)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRD</span> <span class="o">?</span> <span class="s">&quot; PRD(DAC1)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRE</span> <span class="o">?</span> <span class="s">&quot; PRE(ADC2)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRF</span> <span class="o">?</span> <span class="s">&quot; PRF(DAC2)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRG</span> <span class="o">?</span> <span class="s">&quot; PRG(HADC)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_MEA_PRH</span> <span class="o">?</span> <span class="s">&quot; PRH(HDAC)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line1 rate       : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_LINE2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE2_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line2 rate       : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mext</span> <span class="o">&amp;</span> <span class="n">AC97_MEI_HANDSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_HANDSET_RATE</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Headset rate     : %iHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffffff40</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC97_ID_AD1881</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Analog Devices AD1881/85/86</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* select single codec */</span>
				<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span>
						     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="n">snd_ac97_proc_read_main</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="cm">/* select all codecs */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">);</span>
		
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">AD18XX configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Unchained        : 0x%04x,0x%04x,0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Chained          : 0x%04x,0x%04x,0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_ac97_proc_read_main</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
<span class="cm">/* direct register write for debugging */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_regs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_info_get_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;%x %x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* register must be even */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_regs_read_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%i:%02x = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subidx</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ac97_proc_regs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
				    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffffff40</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC97_ID_AD1881</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Analog Devices AD1881/85/86</span>

		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* select single codec */</span>
				<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span>
						     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="n">snd_ac97_proc_regs_read_main</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="cm">/* select all codecs */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_ac97_proc_regs_read_main</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>	
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_ac97_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">prefix</span> <span class="o">=</span> <span class="n">ac97_is_audio</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ac97&quot;</span> <span class="o">:</span> <span class="s">&quot;mc97&quot;</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s#%d-%d&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_proc_read</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s#%d-%d+regs&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_proc_regs_read</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_ac97_proc_regs_write</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc_regs</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_ac97_proc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc_regs</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_ac97_bus_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;codec97#%d&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_ac97_bus_proc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
