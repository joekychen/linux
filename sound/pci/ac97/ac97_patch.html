<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ac97 › ac97_patch.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ac97_patch.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *  Universal interface for Audio Codec &#39;97</span>
<span class="cm"> *</span>
<span class="cm"> *  For more details look to AC &#39;97 component specification revision 2.2</span>
<span class="cm"> *  by Intel Corporation (http://developer.intel.com) and to datasheets</span>
<span class="cm"> *  for specific codecs.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ac97_local.h&quot;</span>
<span class="cp">#include &quot;ac97_patch.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> *  Forward declarations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
						    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_ac97_add_vmaster</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">slaves</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Chip specific initialization</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* replace with a new TLV */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">sid</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">&amp;&amp;</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">tlv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set to the page, update bits and restore the page */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_update_bits_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">page_save</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="n">page_save</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_PAGE_MASK</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">page_save</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span> <span class="cm">/* unlock paging */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * shared line-in/mic controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_enum_text_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">texts</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nums</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">nums</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="n">nums</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">nums</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_surround_jack_mode_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Shared&quot;</span><span class="p">,</span> <span class="s">&quot;Independent&quot;</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">ac97_enum_text_info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_surround_jack_mode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_surround_jack_mode_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">indep</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indep</span> <span class="o">!=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span> <span class="o">=</span> <span class="n">indep</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_channel_mode_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;2ch&quot;</span><span class="p">,</span> <span class="s">&quot;4ch&quot;</span><span class="p">,</span> <span class="s">&quot;6ch&quot;</span><span class="p">,</span> <span class="s">&quot;8ch&quot;</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">ac97_enum_text_info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span>
		<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_channel_mode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">channel_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_channel_mode_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">channel_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">channel_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AC97_SURROUND_JACK_MODE_CTL \</span>
<span class="cp">	{ \</span>
<span class="cp">		.iface	= SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">		.name	= &quot;Surround Jack Mode&quot;, \</span>
<span class="cp">		.info = ac97_surround_jack_mode_info, \</span>
<span class="cp">		.get = ac97_surround_jack_mode_get, \</span>
<span class="cp">		.put = ac97_surround_jack_mode_put, \</span>
<span class="cp">	}</span>
<span class="cm">/* 6ch */</span>
<span class="cp">#define AC97_CHANNEL_MODE_CTL \</span>
<span class="cp">	{ \</span>
<span class="cp">		.iface	= SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">		.name	= &quot;Channel Mode&quot;, \</span>
<span class="cp">		.info = ac97_channel_mode_info, \</span>
<span class="cp">		.get = ac97_channel_mode_get, \</span>
<span class="cp">		.put = ac97_channel_mode_put, \</span>
<span class="cp">		.private_value = 3, \</span>
<span class="cp">	}</span>
<span class="cm">/* 4ch */</span>
<span class="cp">#define AC97_CHANNEL_MODE_4CH_CTL \</span>
<span class="cp">	{ \</span>
<span class="cp">		.iface	= SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">		.name	= &quot;Channel Mode&quot;, \</span>
<span class="cp">		.info = ac97_channel_mode_info, \</span>
<span class="cp">		.get = ac97_channel_mode_get, \</span>
<span class="cp">		.put = ac97_channel_mode_put, \</span>
<span class="cp">		.private_value = 2, \</span>
<span class="cp">	}</span>
<span class="cm">/* 8ch */</span>
<span class="cp">#define AC97_CHANNEL_MODE_8CH_CTL \</span>
<span class="cp">	{ \</span>
<span class="cp">		.iface  = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">		.name   = &quot;Channel Mode&quot;, \</span>
<span class="cp">		.info = ac97_channel_mode_info, \</span>
<span class="cp">		.get = ac97_channel_mode_get, \</span>
<span class="cp">		.put = ac97_channel_mode_put, \</span>
<span class="cp">		.private_value = 4, \</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_surround_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">channel_mode</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_clfe_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">channel_mode</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* system has shared jacks with surround out enabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_shared_surrout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span> <span class="o">&amp;&amp;</span> <span class="n">is_surround_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* system has shared jacks with center/lfe out enabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_shared_clfeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span> <span class="o">&amp;&amp;</span> <span class="n">is_clfe_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* system has shared jacks with line in enabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_shared_linein</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_surround_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* system has shared jacks with mic in enabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_shared_micin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">indep_surround</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_clfe_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">alc850_is_aux_back_surround</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_surround_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The following snd_ac97_ymf753_... items added by David Shust (dshust@shustring.com) */</span>
<span class="cm">/* Modified for YMF743 by Keita Maehara &lt;maehara@debian.org&gt; */</span>

<span class="cm">/* It is possible to indicate to the Yamaha YMF7x3 the type of</span>
<span class="cm">   speakers being used. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_info_speaker</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Standard&quot;</span><span class="p">,</span> <span class="s">&quot;Small&quot;</span><span class="p">,</span> <span class="s">&quot;Smaller&quot;</span>
	<span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_get_speaker</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_YMF7X3_3D_MODE_SEL</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>    <span class="cm">/* 0 = invalid */</span>
		<span class="n">val</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_put_speaker</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_3D_MODE_SEL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ymf7x3_controls_speaker</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span>  <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;3D Control - Speaker&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>   <span class="o">=</span> <span class="n">snd_ac97_ymf7x3_info_speaker</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>    <span class="o">=</span> <span class="n">snd_ac97_ymf7x3_get_speaker</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>    <span class="o">=</span> <span class="n">snd_ac97_ymf7x3_put_speaker</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* It is possible to indicate to the Yamaha YMF7x3 the source to</span>
<span class="cm">   direct to the S/PDIF output. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_spdif_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AC-Link&quot;</span><span class="p">,</span> <span class="s">&quot;A/D Converter&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_spdif_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf7x3_spdif_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_yamaha_ymf7x3_3d</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;3D Control - Wide&quot;</span><span class="p">);</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
			  <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_ymf7x3_controls_speaker</span><span class="p">,</span>
					<span class="n">ac97</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_3D_MODE_SEL</span><span class="p">,</span> <span class="mh">0x0c00</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_yamaha_ymf743_controls_spdif</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">),</span>
		    <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		    <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_yamaha_ymf743_build_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_spdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
				   <span class="n">snd_ac97_yamaha_ymf743_controls_spdif</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* set default PCM S/PDIF params */</span>
	<span class="cm">/* PCM audio,no copyright,no preemphasis,PCM coder,original */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mh">0xa201</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_yamaha_ymf743_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_spdif</span>	<span class="o">=</span> <span class="n">patch_yamaha_ymf743_build_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_3d</span>	<span class="o">=</span> <span class="n">patch_yamaha_ymf7x3_3d</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_yamaha_ymf743</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_yamaha_ymf743_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">AC97_BC_BASS_TREBLE</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="mh">0x04</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* Yamaha 3D enhancement */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span> <span class="cm">/* 48k only */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span> <span class="cm">/* force the detection of spdif */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The AC&#39;97 spec states that the S/PDIF signal is to be output at pin 48.</span>
<span class="cm">   The YMF753 will output the S/PDIF signal to pin 43, 47 (EAPD), or 48.</span>
<span class="cm">   By default, no output pin is selected, and the S/PDIF signal is not output.</span>
<span class="cm">   There is also a bit to mute S/PDIF output in a vendor-specific register. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf753_spdif_output_pin_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Disabled&quot;</span><span class="p">,</span> <span class="s">&quot;Pin 43&quot;</span><span class="p">,</span> <span class="s">&quot;Pin 48&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf753_spdif_output_pin_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ymf753_spdif_output_pin_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0008</span> <span class="o">:</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0020</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* The following can be used to direct S/PDIF output to pin 47 (EAPD).</span>
<span class="cm">	   snd_ac97_write_cache(ac97, 0x62, snd_ac97_read(ac97, 0x62) | 0x0008); */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ymf753_controls_spdif</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf7x3_spdif_source_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Output Pin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf753_spdif_output_pin_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf753_spdif_output_pin_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_ac97_ymf753_spdif_output_pin_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		    <span class="n">AC97_YMF7X3_DIT_CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_yamaha_ymf753_post_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ymf753_controls_spdif</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ymf753_controls_spdif</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_yamaha_ymf753_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_3d</span>	<span class="o">=</span> <span class="n">patch_yamaha_ymf7x3_3d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_yamaha_ymf753_post_spdif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_yamaha_ymf753</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Patch for Yamaha YMF753, Copyright (c) by David Shust, dshust@shustring.com.</span>
<span class="cm">	   This chip has nonstandard and extended behaviour with regard to its S/PDIF output.</span>
<span class="cm">	   The AC&#39;97 spec states that the S/PDIF signal is to be output at pin 48.</span>
<span class="cm">	   The YMF753 will ouput the S/PDIF signal to pin 43, 47 (EAPD), or 48.</span>
<span class="cm">	   By default, no output pin is selected, and the S/PDIF signal is not output.</span>
<span class="cm">	   There is also a bit to mute S/PDIF output in a vendor-specific register.</span>
<span class="cm">	*/</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_yamaha_ymf753_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">AC97_BC_BASS_TREBLE</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="mh">0x04</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* Yamaha 3D enhancement */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * May 2, 2003 Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> *  removed broken wolfson00 patch.</span>
<span class="cm"> *  added support for WM9705,WM9708,WM9709,WM9710,WM9711,WM9712 and WM9717.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm97xx_snd_ac97_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Front Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_WM97XX_FMIXER_VOL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Front Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_WM97XX_FMIXER_VOL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson_wm9703_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is known to work for the ViewSonic ViewPad 1000</span>
<span class="cm">	 * Randolph Bentson &lt;bentson@holmsjoen.com&gt;</span>
<span class="cm">	 * WM9703/9707/9708/9717 </span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm97xx_snd_ac97_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm97xx_snd_ac97_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_WM97XX_FMIXER_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_wolfson_wm9703_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9703_specific</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson03</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_wolfson_wm9703_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm9704_snd_ac97_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Front Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_WM97XX_FMIXER_VOL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Front Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_WM97XX_FMIXER_VOL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Rear Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_WM9704_RMIXER_VOL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Rear Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_WM9704_RMIXER_VOL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Rear DAC Volume&quot;</span><span class="p">,</span> <span class="n">AC97_WM9704_RPCM_VOL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Surround Volume&quot;</span><span class="p">,</span> <span class="n">AC97_SURROUND_MASTER</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson_wm9704_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm9704_snd_ac97_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm9704_snd_ac97_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* patch for DVD noise */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_WM9704_TEST</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_wolfson_wm9704_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9704_specific</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson04</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* WM9704M/9704Q */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_wolfson_wm9704_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson05</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* WM9705, WM9710 */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_wolfson_wm9703_ops</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_WM9705</span>
	<span class="cm">/* WM9705 touchscreen uses AUX and VIDEO for touch */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_NO_VIDEO</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_AUX</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_alc_select</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span><span class="p">,</span> <span class="s">&quot;Stereo&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_alc_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Stereo&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span><span class="p">,</span> <span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_out3_src</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;VREF&quot;</span><span class="p">,</span> <span class="s">&quot;Left + Right&quot;</span><span class="p">,</span> <span class="s">&quot;Mono&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_out3_lrsrc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Master Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_rec_adc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Stereo&quot;</span><span class="p">,</span> <span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Linear Control&quot;</span><span class="p">,</span> <span class="s">&quot;Adaptive Boost&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_rec_gain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;+1.5dB Steps&quot;</span><span class="p">,</span> <span class="s">&quot;+0.75dB Steps&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_mic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic 1&quot;</span><span class="p">,</span> <span class="s">&quot;Differential&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 2&quot;</span><span class="p">,</span> <span class="s">&quot;Stereo&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_rec_sel</span><span class="p">[]</span> <span class="o">=</span> 
	<span class="p">{</span><span class="s">&quot;Mic 1&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">,</span> <span class="s">&quot;Master Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Phone Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Phone&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9711_ng_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Constant Gain&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_enum</span> <span class="n">wm9711_enum</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9711_alc_select</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9711_alc_mix</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9711_out3_src</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9711_out3_lrsrc</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9711_rec_adc</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9711_base</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9711_rec_gain</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9711_mic</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">wm9711_rec_sel</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9711_ng_type</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm9711_snd_ac97_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Target Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Hold Time&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Decay Time&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Attack Time&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;ALC Function&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Max Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC ZC Timeout&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC NG Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;ALC NG Type&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">9</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC NG Threshold&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Side Tone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Side Tone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;ALC Headphone Mux&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Out3 Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Out3 ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Out3 Mux&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Out3 LR Mux&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Out3 Volume&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Side Tone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Side Tone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Phone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Side Tone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Side Tone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Phone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Phone to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Phone to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture 20dB Boost Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture to Phone Mux&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture to Phone 20dB Boost Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Select&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Upper Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Lower Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Bass Control&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Bass Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Tone Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Playback Attenuate (-6dB) Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Volume Steps&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 1 to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 2 to Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Mic Select Source&quot;</span><span class="p">,</span> <span class="n">wm9711_enum</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 1 Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 2 Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 20dB Boost Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Master Left Inv Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Master ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson_wm9711_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm9711_snd_ac97_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm9711_snd_ac97_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>  <span class="n">AC97_CD</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_wolfson_wm9711_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9711_specific</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson11</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* WM9711, WM9712 */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_wolfson_wm9711_ops</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_NO_REC_GAIN</span> <span class="o">|</span> <span class="n">AC97_STEREO_MUTES</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_MIC</span> <span class="o">|</span>
		<span class="n">AC97_HAS_NO_PC_BEEP</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_VIDEO</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_CD</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_mic_mixer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Stereo&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 1&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 2&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_rec_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Stereo&quot;</span><span class="p">,</span> <span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_rec_src</span><span class="p">[]</span> <span class="o">=</span> 
	<span class="p">{</span><span class="s">&quot;Mic 1&quot;</span><span class="p">,</span> <span class="s">&quot;Mic 2&quot;</span><span class="p">,</span> <span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Mono In&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Master Mix&quot;</span><span class="p">,</span> 
	<span class="s">&quot;Mono Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_rec_gain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;+1.5dB Steps&quot;</span><span class="p">,</span> <span class="s">&quot;+0.75dB Steps&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_alc_select</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span><span class="p">,</span> <span class="s">&quot;Stereo&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_mono_pga</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Vmid&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">,</span> <span class="s">&quot;Mono Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Inv 1&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_spk_pga</span><span class="p">[]</span> <span class="o">=</span> 
	<span class="p">{</span><span class="s">&quot;Vmid&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Master Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Inv&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_hp_pga</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Vmid&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_out3_pga</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Vmid&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">,</span> <span class="s">&quot;Inv 1&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_out4_pga</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Vmid&quot;</span><span class="p">,</span> <span class="s">&quot;Zh&quot;</span><span class="p">,</span> <span class="s">&quot;Inv 2&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_dac_inv</span><span class="p">[]</span> <span class="o">=</span> 
	<span class="p">{</span><span class="s">&quot;Off&quot;</span><span class="p">,</span> <span class="s">&quot;Mono Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Master Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix L&quot;</span><span class="p">,</span> <span class="s">&quot;Headphone Mix R&quot;</span><span class="p">,</span> 
	<span class="s">&quot;Headphone Mix Mono&quot;</span><span class="p">,</span> <span class="s">&quot;NC&quot;</span><span class="p">,</span> <span class="s">&quot;Vmid&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Linear Control&quot;</span><span class="p">,</span> <span class="s">&quot;Adaptive Boost&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wm9713_ng_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Constant Gain&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_enum</span> <span class="n">wm9713_enum</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_mic_mixer</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_rec_mux</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_rec_mux</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">wm9713_rec_src</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9713_rec_gain</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_alc_select</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_mono_pga</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">wm9713_spk_pga</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_hp_pga</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_out3_pga</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm9713_out4_pga</span><span class="p">),</span>
<span class="n">AC97_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">wm9713_dac_inv</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9713_base</span><span class="p">),</span>
<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wm9713_ng_type</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm13_snd_ac97_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line In Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line In to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line In to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line In to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Playback to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 1 Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 2 Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 1 to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic 2 to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Boost (+20dB) Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Mic to Headphone Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Headphone Mixer Volume&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Volume Steps&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture to Headphone Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture to Mono Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture to Mono Boost (+20dB) Switch&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture ADC Boost (+20dB) Switch&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Select&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Target Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Hold Time&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Decay Time &quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Attack Time&quot;</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;ALC Function&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Max Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC ZC Timeout&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC NG Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;ALC NG Type&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">13</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC NG Threshold&quot;</span><span class="p">,</span> <span class="n">AC97_PCI_SVID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Master ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Headphone ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Out3/4 ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Master Right Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Right Switch&quot;</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Out3/4 Right Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono In to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono In to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono In Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono ZC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_TONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Master Volume&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep to Mono Volume&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Master Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice to Mono Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Master Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Master Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Mono Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux to Mono Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Mono Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Master Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Headphone Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Out 3 Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">9</span><span class="p">]),</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Out 4 Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span>

<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Bass Control&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">12</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Bass Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Tone Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Playback Attenuate (-6dB) Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Bass Volume&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Tone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm13_snd_ac97_controls_3d</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Inv Input Mux&quot;</span><span class="p">,</span> <span class="n">wm9713_enum</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Upper Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Lower Cut-off Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Depth&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson_wm9713_3d</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm13_snd_ac97_controls_3d</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm13_snd_ac97_controls_3d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson_wm9713_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm13_snd_ac97_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm13_snd_ac97_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mh">0x00da</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mh">0xd612</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x1ba0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">patch_wolfson_wm9713_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="mh">0xfeff</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">patch_wolfson_wm9713_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="mh">0xda00</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="mh">0x3810</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_wolfson_wm9713_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9713_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_3d</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9713_3d</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM	</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9713_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">patch_wolfson_wm9713_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_wolfson13</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* WM9713, WM9714 */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_wolfson_wm9713_ops</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_NO_REC_GAIN</span> <span class="o">|</span> <span class="n">AC97_STEREO_MUTES</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_PHONE</span> <span class="o">|</span>
		<span class="n">AC97_HAS_NO_PC_BEEP</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_VIDEO</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_CD</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_TONE</span> <span class="o">|</span>
		<span class="n">AC97_HAS_NO_STD_PCM</span><span class="p">;</span>
    	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC97_SCAP_MODEM</span><span class="p">;</span>

	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="mh">0xda00</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="mh">0x3810</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tritech codec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_tritech_tr28028</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SURROUND_MASTER</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sigmatel STAC97xx codecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9700_3d</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;3D Control Sigmatel - Depth&quot;</span><span class="p">);</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9708_3d</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;3D Control Sigmatel - Depth&quot;</span><span class="p">);</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;3D Control Sigmatel - Rear Depth&quot;</span><span class="p">);</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_sigmatel_4speaker</span> <span class="o">=</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Sigmatel 4-Speaker Stereo Playback Switch&quot;</span><span class="p">,</span>
		<span class="n">AC97_SIGMATEL_DAC2INVERT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* &quot;Sigmatel &quot; removed due to excessive name length: */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_sigmatel_phaseinvert</span> <span class="o">=</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Surround Phase Inversion Playback Switch&quot;</span><span class="p">,</span>
		<span class="n">AC97_SIGMATEL_DAC2INVERT</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_sigmatel_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Sigmatel DAC 6dB Attenuate&quot;</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Sigmatel ADC 6dB Attenuate&quot;</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac97xx_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">,</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0003</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_sigmatel_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_sigmatel_controls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_DAC2INVERT</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_sigmatel_4speaker</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_DAC2INVERT</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_sigmatel_phaseinvert</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_sigmatel_stac9700_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_3d</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac9700_3d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac97xx_specific</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9700</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9700_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9708_put_bias</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_stac9708_bias_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sigmatel Output Bias Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_info_volsw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_get_volsw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_stac9708_put_bias</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9708_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* the register bit is writable, but the function is not implemented: */</span>
	<span class="n">snd_ac97_remove_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;PCM Out Path &amp; Mute&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Sigmatel Surround Playback&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_stac9708_bias_control</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">patch_sigmatel_stac97xx_specific</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_sigmatel_stac9708_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_3d</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac9708_3d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac9708_specific</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9708</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec72</span><span class="p">,</span> <span class="n">codec6c</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9708_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* HP (sigmatel surround) support */</span>

	<span class="n">codec72</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">codec6c</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">codec72</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">codec6c</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC2</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">codec72</span><span class="o">==</span><span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">codec6c</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC2</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_DAC2INVERT</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">codec72</span><span class="o">==</span><span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">codec6c</span><span class="o">==</span><span class="mh">0x0080</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing */</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_MULTICHN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9721</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9700_ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_ANALOG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>patch for SigmaTel</p></td><td class="code"><div class="highlight"><pre>		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC2</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_MULTICHN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9744</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>patch for SigmaTel</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9700_ops</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* is this correct? --jk */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_MULTICHN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9756</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>patch for SigmaTel</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9700_ops</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_CIC2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* is this correct? --jk */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS1</span><span class="p">,</span> <span class="mh">0xabba</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_BIAS2</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_MULTICHN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_output_jack_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Input/Disabled&quot;</span><span class="p">,</span> <span class="s">&quot;Front Output&quot;</span><span class="p">,</span>
		<span class="s">&quot;Rear Output&quot;</span><span class="p">,</span> <span class="s">&quot;Center/LFE Output&quot;</span><span class="p">,</span> <span class="s">&quot;Mixer Output&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_output_jack_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_SIGMATEL_OUTSEL</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_output_jack_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_OUTSEL</span><span class="p">,</span>
				     <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_input_jack_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Mic2 Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Mic1 Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Line In Jack&quot;</span><span class="p">,</span>
		<span class="s">&quot;Front Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Rear Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Center/LFE Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Mute&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_input_jack_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_SIGMATEL_INSEL</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_input_jack_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_INSEL</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span>
				     <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_phonesel_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;Front Jack&quot;</span><span class="p">,</span> <span class="s">&quot;Rear Jack&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_phonesel_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_SIGMATEL_IOMISC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_stac9758_phonesel_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_IOMISC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				     <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define STAC9758_OUTPUT_JACK(xname, shift) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span>
<span class="cp">	.info = snd_ac97_stac9758_output_jack_info, \</span>
<span class="cp">	.get = snd_ac97_stac9758_output_jack_get, \</span>
<span class="cp">	.put = snd_ac97_stac9758_output_jack_put, \</span>
<span class="cp">	.private_value = shift }</span>
<span class="cp">#define STAC9758_INPUT_JACK(xname, shift) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span>
<span class="cp">	.info = snd_ac97_stac9758_input_jack_info, \</span>
<span class="cp">	.get = snd_ac97_stac9758_input_jack_get, \</span>
<span class="cp">	.put = snd_ac97_stac9758_input_jack_put, \</span>
<span class="cp">	.private_value = shift }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_sigmatel_stac9758_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">STAC9758_OUTPUT_JACK</span><span class="p">(</span><span class="s">&quot;Mic1 Jack&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">STAC9758_OUTPUT_JACK</span><span class="p">(</span><span class="s">&quot;LineIn Jack&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">STAC9758_OUTPUT_JACK</span><span class="p">(</span><span class="s">&quot;Front Jack&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">STAC9758_OUTPUT_JACK</span><span class="p">(</span><span class="s">&quot;Rear Jack&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">STAC9758_OUTPUT_JACK</span><span class="p">(</span><span class="s">&quot;Center/LFE Jack&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
	<span class="n">STAC9758_INPUT_JACK</span><span class="p">(</span><span class="s">&quot;Mic Input Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">STAC9758_INPUT_JACK</span><span class="p">(</span><span class="s">&quot;Line Input Source&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone Amp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_stac9758_phonesel_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_stac9758_phonesel_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_stac9758_phonesel_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Exchange Center/LFE&quot;</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_IOMISC</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone +3dB Boost&quot;</span><span class="p">,</span> <span class="n">AC97_SIGMATEL_IOMISC</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9758_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">patch_sigmatel_stac97xx_specific</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_sigmatel_stac9758_controls</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_sigmatel_stac9758_controls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* DAC-A direct */</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Front Playback&quot;</span><span class="p">);</span>
	<span class="cm">/* DAC-A to Mix = PCM */</span>
	<span class="cm">/* DAC-B direct = Surround */</span>
	<span class="cm">/* DAC-B to Mix */</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Video Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Surround Mix Playback&quot;</span><span class="p">);</span>
	<span class="cm">/* DAC-C direct = Center/LFE */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_sigmatel_stac9758_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_3d</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac9700_3d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_sigmatel_stac9758_specific</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_sigmatel_stac9758</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AC97_SIGMATEL_OUTSEL</span><span class="p">,</span>
		<span class="n">AC97_SIGMATEL_IOMISC</span><span class="p">,</span>
		<span class="n">AC97_SIGMATEL_INSEL</span><span class="p">,</span>
		<span class="n">AC97_SIGMATEL_VARIOUS</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">def_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OUTSEL */</span> <span class="mh">0xd794</span><span class="p">,</span> <span class="cm">/* CL:CL, SR:SR, LO:MX, LI:DS, MI:DS */</span>
		<span class="cm">/* IOMISC */</span> <span class="mh">0x2001</span><span class="p">,</span>
		<span class="cm">/* INSEL */</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="cm">/* LI:LI, MI:M1 */</span>
		<span class="cm">/* VARIOUS */</span> <span class="mh">0x0040</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">m675_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OUTSEL */</span> <span class="mh">0xfc70</span><span class="p">,</span> <span class="cm">/* CL:MX, SR:MX, LO:DS, LI:MX, MI:DS */</span>
		<span class="cm">/* IOMISC */</span> <span class="mh">0x2102</span><span class="p">,</span> <span class="cm">/* HP amp on */</span>
		<span class="cm">/* INSEL */</span> <span class="mh">0x0203</span><span class="p">,</span> <span class="cm">/* LI:LI, MI:FR */</span>
		<span class="cm">/* VARIOUS */</span> <span class="mh">0x0041</span> <span class="cm">/* stereo mic */</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pregs</span> <span class="o">=</span> <span class="n">def_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Gateway M675 notebook */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">&amp;&amp;</span> 
	    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x107b</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0601</span><span class="p">)</span>
	    	<span class="n">pregs</span> <span class="o">=</span> <span class="n">m675_regs</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>patch for SigmaTel</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_sigmatel_stac9758_ops</span><span class="p">;</span>
	<span class="cm">/* FIXME: assume only page 0 for writing cache */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">AC97_PAGE_VENDOR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pregs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cirrus Logic CS42xx codecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cirrus_controls_spdif</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_CSR_SPDIF</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;AC97-SPSA&quot;</span><span class="p">,</span> <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cirrus_build_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* con mask, pro mask, default */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_spdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* switch, spsa */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_cirrus_controls_spdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">AC97_ID_CS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC97_ID_CS4205</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_cirrus_controls_spdif</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set default PCM S/PDIF params */</span>
	<span class="cm">/* consumer,PCM audio,no copyright,no preemphasis,PCM coder,original,48000Hz */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_SPDIF</span><span class="p">,</span> <span class="mh">0x0a20</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_cirrus_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_spdif</span> <span class="o">=</span> <span class="n">patch_cirrus_build_spdif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cirrus_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Basically, the cs4201/cs4205/cs4297a has non-standard sp/dif registers.</span>
<span class="cm">	   WHY CAN&#39;T ANYONE FOLLOW THE BLOODY SPEC?  *sigh*</span>
<span class="cm">	   - sp/dif EA ID is not set, but sp/dif is always present.</span>
<span class="cm">	   - enable/disable is spdif register bit 15.</span>
<span class="cm">	   - sp/dif control register is 0x68.  differs from AC97:</span>
<span class="cm">	   - valid is bit 14 (vs 15)</span>
<span class="cm">	   - no DRS</span>
<span class="cm">	   - only 44.1/48k [00 = 48, 01=44,1] (AC97 is 00=44.1, 10=48)</span>
<span class="cm">	   - sp/dif ssource select is in 0x5e bits 0,1.</span>
<span class="cm">	*/</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_cirrus_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_CS_SPDIF</span><span class="p">;</span> 
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_PCM_RATE_32000</span><span class="p">;</span>
        <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>	<span class="cm">/* force the detection of spdif */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cirrus_cs4299</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* force the detection of PC Beep */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_PC_BEEP</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="n">patch_cirrus_spdif</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Conexant codecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_conexant_controls_spdif</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_CXR_AUDIO_MISC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_conexant_build_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* con mask, pro mask, default */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_spdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* switch */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_conexant_controls_spdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* set default PCM S/PDIF params */</span>
	<span class="cm">/* consumer,PCM audio,no copyright,no preemphasis,PCM coder,original,48000Hz */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CXR_AUDIO_MISC</span><span class="p">,</span>
			     <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CXR_AUDIO_MISC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AC97_CXR_SPDIFEN</span><span class="o">|</span><span class="n">AC97_CXR_COPYRGT</span><span class="o">|</span><span class="n">AC97_CXR_SPDIF_MASK</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_conexant_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_spdif</span> <span class="o">=</span> <span class="n">patch_conexant_build_spdif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_conexant</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_conexant_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_CX_SPDIF</span><span class="p">;</span>
        <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>	<span class="cm">/* force the detection of spdif */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span> <span class="cm">/* 48k only */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cx20551</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analog Device AD18xx, AD19xx codecs</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad18xx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">setup_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">codec</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">setup_regs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>
			<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_AD_MULTI</span><span class="p">))</span>
		<span class="cm">/* normal restore */</span>
		<span class="n">snd_ac97_restore_status</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* restore the AD18xx codec configurations */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">codec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">codec</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">codec</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">codec</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* select single codec */</span>
			<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span>
					     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="cm">/* select all codecs */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">);</span>

		<span class="cm">/* restore status */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x7c</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">AC97_POWERDOWN</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">reg_accessed</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* handle multi codecs for AD18xx */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">AC97_PCM</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">codec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">codec</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">codec</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">codec</span><span class="p">])</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="cm">/* select single codec */</span>
						<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span>
								     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
						<span class="cm">/* update PCM bits */</span>
						<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">pcmreg</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
					<span class="p">}</span>
					<span class="cm">/* select all codecs */</span>
					<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">AC97_AD_TEST</span> <span class="o">||</span>
					   <span class="n">i</span> <span class="o">==</span> <span class="n">AC97_AD_CODEC_CFG</span> <span class="o">||</span>
					   <span class="n">i</span> <span class="o">==</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span> <span class="cm">/* ignore */</span>
			<span class="p">}</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_ac97_restore_iec958</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1888_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad18xx_resume</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CODEC_CLASS_REV</span><span class="p">,</span> <span class="mh">0x8080</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_res_table</span> <span class="n">ad1819_restbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x9f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1819</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">scfg</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>patch for Analog Devices</p></td><td class="code"><div class="highlight"><pre>	<span class="n">scfg</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="n">scfg</span> <span class="o">|</span> <span class="mh">0x7000</span><span class="p">);</span> <span class="cm">/* select all codecs */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">res_table</span> <span class="o">=</span> <span class="n">ad1819_restbl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">patch_ad1881_unchained</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>test for unchained codec</p></td><td class="code"><div class="highlight"><pre>	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* ID0C, ID1C, SDIE = off */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff40</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x5340</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1881_chained1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">codec_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cfg_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="n">cfg_bits</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>	<span class="c1">// SDIE</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff40</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x5340</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_bits</span><span class="p">)</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="n">codec_bits</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg_bits</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">codec_bits</span> <span class="o">?</span> <span class="n">codec_bits</span> <span class="o">:</span> <span class="mh">0x0004</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">patch_ad1881_chained</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unchained_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cidx1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cidx2</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>already detected?</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">cidx1</span><span class="p">]</span> <span class="o">||</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">cidx1</span><span class="p">])</span>
		<span class="n">cidx1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">cidx2</span><span class="p">]</span> <span class="o">||</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">chained</span><span class="p">[</span><span class="n">cidx2</span><span class="p">])</span>
		<span class="n">cidx2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cidx1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cidx2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>test for chained codecs</p></td><td class="code"><div class="highlight"><pre>	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span>
			     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">unchained_idx</span><span class="p">]);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>		<span class="c1">// ID1C</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="n">unchained_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cidx1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cidx2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx1</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">))</span>	<span class="c1">// SDIE | ID1C</span>
			<span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx2</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">))</span>	<span class="c1">// SDIE | ID1C</span>
			<span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cidx2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">patch_ad1881_chained1</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cidx2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1881_build_ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1881</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cfg_idxs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">};</span>
	</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>patch for Analog Devices</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">codecs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">codecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_ad1881_unchained</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">));</span>
	<span class="n">codecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_ad1881_unchained</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">));</span>
	<span class="n">codecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_ad1881_unchained</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">codecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">codecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">codecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">unchained</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
			<span class="n">patch_ad1881_chained</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cfg_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfg_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_AD_MULTI</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_SURROUND_DAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_AD_MULTI</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_CENTER_LFE_DAC</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">__end:</span>
	<span class="cm">/* select all codecs */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">);</span>
	<span class="cm">/* check if only one codec is present */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
			<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ok, deselect all ID bits */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_CODEC_CFG</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> 
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> 
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">codec_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* required for AD1886/AD1885 combination */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1881_build_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ad1885</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Digital Mono Direct&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* AC97_SINGLE(&quot;Digital Audio Mode&quot;, AC97_AD_MISC, 12, 1, 0), */</span> <span class="cm">/* seems problematic */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Low Power Mixer&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Zero Fill DAC&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* inverted */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* inverted */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_6bit_6db_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">8850</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1885_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_ad1885</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_ad1885</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">reset_tlv</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span>
		  <span class="n">db_scale_6bit_6db_max</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1885_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1885_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1885</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* This is required to deal with the Intel D815EEAL2 */</span>
	<span class="cm">/* i.e. Line out is actually headphone out from codec */</span>

	<span class="cm">/* set default */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mh">0x0404</span><span class="p">);</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1885_build_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1886_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reset_tlv</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span>
		  <span class="n">db_scale_6bit_6db_max</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1886_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1886_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1886</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* Presario700 workaround */</span>
	<span class="cm">/* for Jack Sense/SPDIF Register misetting causing */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1886_build_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MISC bits (AD1888/AD1980/AD1985 register 0x76) */</span>
<span class="cp">#define AC97_AD198X_MBC		0x0003	</span><span class="cm">/* mic boost */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_MBC_20	0x0000	</span><span class="cm">/* +20dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_MBC_10	0x0001	</span><span class="cm">/* +10dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_MBC_30	0x0002	</span><span class="cm">/* +30dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_VREFD	0x0004	</span><span class="cm">/* VREF high-Z */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_VREFH	0x0008	</span><span class="cm">/* 0=2.25V, 1=3.7V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_VREF_0	0x000c	</span><span class="cm">/* 0V (AD1985 only) */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_VREF_MASK	(AC97_AD198X_VREFH | AC97_AD198X_VREFD)</span>
<span class="cp">#define AC97_AD198X_VREF_SHIFT	2</span>
<span class="cp">#define AC97_AD198X_SRU		0x0010	</span><span class="cm">/* sample rate unlock */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_LOSEL	0x0020	</span><span class="cm">/* LINE_OUT amplifiers input select */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_2MIC	0x0040	</span><span class="cm">/* 2-channel mic select */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_SPRD	0x0080	</span><span class="cm">/* SPREAD enable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_DMIX0	0x0100	</span><span class="cm">/* downmix mode: */</span><span class="cp"></span>
					<span class="cm">/*  0 = 6-to-4, 1 = 6-to-2 downmix */</span>
<span class="cp">#define AC97_AD198X_DMIX1	0x0200	</span><span class="cm">/* downmix mode: 1 = enabled */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_HPSEL	0x0400	</span><span class="cm">/* headphone amplifier input select */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_CLDIS	0x0800	</span><span class="cm">/* center/lfe disable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_LODIS	0x1000	</span><span class="cm">/* LINE_OUT disable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_MSPLT	0x2000	</span><span class="cm">/* mute split */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_AC97NC	0x4000	</span><span class="cm">/* AC97 no compatible mode */</span><span class="cp"></span>
<span class="cp">#define AC97_AD198X_DACZ	0x8000	</span><span class="cm">/* DAC zero-fill mode */</span><span class="cp"></span>

<span class="cm">/* MISC 1 bits (AD1986 register 0x76) */</span>
<span class="cp">#define AC97_AD1986_MBC		0x0003	</span><span class="cm">/* mic boost */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MBC_20	0x0000	</span><span class="cm">/* +20dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MBC_10	0x0001	</span><span class="cm">/* +10dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MBC_30	0x0002	</span><span class="cm">/* +30dB */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LISEL0	0x0004	</span><span class="cm">/* LINE_IN select bit 0 */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LISEL1	0x0008	</span><span class="cm">/* LINE_IN select bit 1 */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LISEL_MASK	(AC97_AD1986_LISEL1 | AC97_AD1986_LISEL0)</span>
<span class="cp">#define AC97_AD1986_LISEL_LI	0x0000  </span><span class="cm">/* LINE_IN pins as LINE_IN source */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LISEL_SURR	0x0004  </span><span class="cm">/* SURROUND pins as LINE_IN source */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LISEL_MIC	0x0008  </span><span class="cm">/* MIC_1/2 pins as LINE_IN source */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_SRU		0x0010	</span><span class="cm">/* sample rate unlock */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_SOSEL	0x0020	</span><span class="cm">/* SURROUND_OUT amplifiers input sel */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_2MIC	0x0040	</span><span class="cm">/* 2-channel mic select */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_SPRD	0x0080	</span><span class="cm">/* SPREAD enable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_DMIX0	0x0100	</span><span class="cm">/* downmix mode: */</span><span class="cp"></span>
					<span class="cm">/*  0 = 6-to-4, 1 = 6-to-2 downmix */</span>
<span class="cp">#define AC97_AD1986_DMIX1	0x0200	</span><span class="cm">/* downmix mode: 1 = enabled */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_CLDIS	0x0800	</span><span class="cm">/* center/lfe disable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_SODIS	0x1000	</span><span class="cm">/* SURROUND_OUT disable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MSPLT	0x2000	</span><span class="cm">/* mute split (read only 1) */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_AC97NC	0x4000	</span><span class="cm">/* AC97 no compatible mode (r/o 1) */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_DACZ	0x8000	</span><span class="cm">/* DAC zero-fill mode */</span><span class="cp"></span>

<span class="cm">/* MISC 2 bits (AD1986 register 0x70) */</span>
<span class="cp">#define AC97_AD_MISC2		0x70	</span><span class="cm">/* Misc Control Bits 2 (AD1986) */</span><span class="cp"></span>

<span class="cp">#define AC97_AD1986_CVREF0	0x0004	</span><span class="cm">/* C/LFE VREF_OUT 2.25V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_CVREF1	0x0008	</span><span class="cm">/* C/LFE VREF_OUT 0V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_CVREF2	0x0010	</span><span class="cm">/* C/LFE VREF_OUT 3.7V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_CVREF_MASK \</span>
<span class="cp">	(AC97_AD1986_CVREF2 | AC97_AD1986_CVREF1 | AC97_AD1986_CVREF0)</span>
<span class="cp">#define AC97_AD1986_JSMAP	0x0020	</span><span class="cm">/* Jack Sense Mapping 1 = alternate */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MMDIS	0x0080	</span><span class="cm">/* Mono Mute Disable */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MVREF0	0x0400	</span><span class="cm">/* MIC VREF_OUT 2.25V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MVREF1	0x0800	</span><span class="cm">/* MIC VREF_OUT 0V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MVREF2	0x1000	</span><span class="cm">/* MIC VREF_OUT 3.7V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_MVREF_MASK \</span>
<span class="cp">	(AC97_AD1986_MVREF2 | AC97_AD1986_MVREF1 | AC97_AD1986_MVREF0)</span>

<span class="cm">/* MISC 3 bits (AD1986 register 0x7a) */</span>
<span class="cp">#define AC97_AD_MISC3		0x7a	</span><span class="cm">/* Misc Control Bits 3 (AD1986) */</span><span class="cp"></span>

<span class="cp">#define AC97_AD1986_MMIX	0x0004	</span><span class="cm">/* Mic Mix, left/right */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_GPO		0x0008	</span><span class="cm">/* General Purpose Out */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LOHPEN	0x0010	</span><span class="cm">/* LINE_OUT headphone drive */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LVREF0	0x0100	</span><span class="cm">/* LINE_OUT VREF_OUT 2.25V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LVREF1	0x0200	</span><span class="cm">/* LINE_OUT VREF_OUT 0V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LVREF2	0x0400	</span><span class="cm">/* LINE_OUT VREF_OUT 3.7V */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LVREF_MASK \</span>
<span class="cp">	(AC97_AD1986_LVREF2 | AC97_AD1986_LVREF1 | AC97_AD1986_LVREF0)</span>
<span class="cp">#define AC97_AD1986_JSINVA	0x0800	</span><span class="cm">/* Jack Sense Invert SENSE_A */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_LOSEL	0x1000	</span><span class="cm">/* LINE_OUT amplifiers input select */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_HPSEL0	0x2000	</span><span class="cm">/* Headphone amplifiers */</span><span class="cp"></span>
					<span class="cm">/*   input select Surround DACs */</span>
<span class="cp">#define AC97_AD1986_HPSEL1	0x4000	</span><span class="cm">/* Headphone amplifiers input */</span><span class="cp"></span>
					<span class="cm">/*   select C/LFE DACs */</span>
<span class="cp">#define AC97_AD1986_JSINVB	0x8000	</span><span class="cm">/* Jack Sense Invert SENSE_B */</span><span class="cp"></span>

<span class="cm">/* Serial Config bits (AD1986 register 0x74) (incomplete) */</span>
<span class="cp">#define AC97_AD1986_OMS0	0x0100	</span><span class="cm">/* Optional Mic Selector bit 0 */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS1	0x0200	</span><span class="cm">/* Optional Mic Selector bit 1 */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS2	0x0400	</span><span class="cm">/* Optional Mic Selector bit 2 */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS_MASK \</span>
<span class="cp">	(AC97_AD1986_OMS2 | AC97_AD1986_OMS1 | AC97_AD1986_OMS0)</span>
<span class="cp">#define AC97_AD1986_OMS_M	0x0000  </span><span class="cm">/* MIC_1/2 pins are MIC sources */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS_L	0x0100  </span><span class="cm">/* LINE_IN pins are MIC sources */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS_C	0x0200  </span><span class="cm">/* Center/LFE pins are MCI sources */</span><span class="cp"></span>
<span class="cp">#define AC97_AD1986_OMS_MC	0x0400  </span><span class="cm">/* Mix of MIC and C/LFE pins */</span><span class="cp"></span>
					<span class="cm">/*   are MIC sources */</span>
<span class="cp">#define AC97_AD1986_OMS_ML	0x0500  </span><span class="cm">/* MIX of MIC and LINE_IN pins */</span><span class="cp"></span>
					<span class="cm">/*   are MIC sources */</span>
<span class="cp">#define AC97_AD1986_OMS_LC	0x0600  </span><span class="cm">/* MIX of LINE_IN and C/LFE pins */</span><span class="cp"></span>
					<span class="cm">/*   are MIC sources */</span>
<span class="cp">#define AC97_AD1986_OMS_MLC	0x0700  </span><span class="cm">/* MIX of MIC, LINE_IN, C/LFE pins */</span><span class="cp"></span>
					<span class="cm">/*   are MIC sources */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad198x_spdif_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AC-Link&quot;</span><span class="p">,</span> <span class="s">&quot;A/D Converter&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad198x_spdif_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_SERIAL_CFG</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad198x_spdif_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad198x_spdif_source</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_ac97_ad198x_spdif_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_ac97_ad198x_spdif_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_ac97_ad198x_spdif_source_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad198x_post_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_ad198x_spdif_source</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad1981x_jack_sense</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* black list to avoid HP/Line jack-sense controls</span>
<span class="cm"> * (SS vendor &lt;&lt; 16 | device)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ad1981_jacks_blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x10140523</span><span class="p">,</span> <span class="cm">/* Thinkpad R40 */</span>
	<span class="mh">0x10140534</span><span class="p">,</span> <span class="cm">/* Thinkpad X31 */</span>
	<span class="mh">0x10140537</span><span class="p">,</span> <span class="cm">/* Thinkpad T41p */</span>
	<span class="mh">0x1014053e</span><span class="p">,</span> <span class="cm">/* Thinkpad R40e */</span>
	<span class="mh">0x10140554</span><span class="p">,</span> <span class="cm">/* Thinkpad T42p/R50p */</span>
	<span class="mh">0x10140567</span><span class="p">,</span> <span class="cm">/* Thinkpad T43p 2668-G7U */</span>
	<span class="mh">0x10140581</span><span class="p">,</span> <span class="cm">/* Thinkpad X41-2527 */</span>
	<span class="mh">0x10280160</span><span class="p">,</span> <span class="cm">/* Dell Dimension 2400 */</span>
	<span class="mh">0x104380b0</span><span class="p">,</span> <span class="cm">/* Asus A7V8X-MX */</span>
	<span class="mh">0x11790241</span><span class="p">,</span> <span class="cm">/* Toshiba Satellite A-15 S127 */</span>
	<span class="mh">0x1179ff10</span><span class="p">,</span> <span class="cm">/* Toshiba P500 */</span>
	<span class="mh">0x144dc01a</span><span class="p">,</span> <span class="cm">/* Samsung NP-X20C004/SEG */</span>
	<span class="mi">0</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">subid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span> <span class="n">list</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">list</span> <span class="o">==</span> <span class="n">subid</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1981a_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_list</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">ad1981_jacks_blacklist</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ad1981x_jack_sense</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ad1981x_jack_sense</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1981a_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1981a_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* white list to enable HP jack-sense bits</span>
<span class="cm"> * (SS vendor &lt;&lt; 16 | device)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ad1981_jacks_whitelist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0e11005a</span><span class="p">,</span> <span class="cm">/* HP nc4000/4010 */</span>
	<span class="mh">0x103c0890</span><span class="p">,</span> <span class="cm">/* HP nc6000 */</span>
	<span class="mh">0x103c0938</span><span class="p">,</span> <span class="cm">/* HP nc4220 */</span>
	<span class="mh">0x103c099c</span><span class="p">,</span> <span class="cm">/* HP nx6110 */</span>
	<span class="mh">0x103c0944</span><span class="p">,</span> <span class="cm">/* HP nc6220 */</span>
	<span class="mh">0x103c0934</span><span class="p">,</span> <span class="cm">/* HP nc8220 */</span>
	<span class="mh">0x103c006d</span><span class="p">,</span> <span class="cm">/* HP nx9105 */</span>
	<span class="mh">0x103c300d</span><span class="p">,</span> <span class="cm">/* HP Compaq dc5100 SFF(PT003AW) */</span>
	<span class="mh">0x17340088</span><span class="p">,</span> <span class="cm">/* FSC Scenic-W */</span>
	<span class="mi">0</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_ad1981_hp_jack_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_list</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">ad1981_jacks_whitelist</span><span class="p">))</span>
		<span class="cm">/* enable headphone jack sense */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1981a</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1981a_build_ops</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD198X_MSPLT</span><span class="p">,</span> <span class="n">AC97_AD198X_MSPLT</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>
	<span class="n">check_ad1981_hp_jack_sense</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad198x_2cmic</span> <span class="o">=</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Stereo Mic&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1981b_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_ad198x_2cmic</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_list</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">ad1981_jacks_blacklist</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ad1981x_jack_sense</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ad1981x_jack_sense</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1981b_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1981b_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1981b</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1981b_build_ops</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD198X_MSPLT</span><span class="p">,</span> <span class="n">AC97_AD198X_MSPLT</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>
	<span class="n">check_ad1981_hp_jack_sense</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_ac97_ad1888_lohpsel_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1888_lohpsel_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_AD198X_LOSEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1888_lohpsel_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="p">(</span><span class="n">AC97_AD198X_LOSEL</span> <span class="o">|</span> <span class="n">AC97_AD198X_HPSEL</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span>
				    <span class="n">AC97_AD198X_LOSEL</span> <span class="o">|</span> <span class="n">AC97_AD198X_HPSEL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1888_downmix_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Off&quot;</span><span class="p">,</span> <span class="s">&quot;6 -&gt; 4&quot;</span><span class="p">,</span> <span class="s">&quot;6 -&gt; 2&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1888_downmix_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_AD198X_DMIX1</span><span class="p">))</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1888_downmix_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">AC97_AD198X_DMIX1</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span>
				    <span class="n">AC97_AD198X_DMIX0</span> <span class="o">|</span> <span class="n">AC97_AD198X_DMIX1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1888_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* clear LODIS if shared jack is to be used for Surround out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span> <span class="o">&amp;&amp;</span> <span class="n">is_shared_linein</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* clear CLDIS if shared jack is to be used for C/LFE out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_shared_micin</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="cm">/* shared Line-In */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad1888_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Exchange Front/Surround&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;V_REFOUT Enable&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD_VREFD_SHIFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;High Pass Filter Enable&quot;</span><span class="p">,</span> <span class="n">AC97_AD_TEST2</span><span class="p">,</span>
			<span class="n">AC97_AD_HPFD_SHIFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Spread Front to Surround and Center/LFE&quot;</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Downmix&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>

	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1888_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rename 0x04 as &quot;Master&quot; and 0x02 as &quot;Master Surround&quot; */</span>
		<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span>
					<span class="s">&quot;Master Surround Playback&quot;</span><span class="p">);</span>
		<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span>
					<span class="s">&quot;Master Playback&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ad1888_controls</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ad1888_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1888_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1888_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad1888_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">ad1888_update_jacks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1888</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">misc</span><span class="p">;</span>
	
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1888_build_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * LO can be used as a real line-out on some devices,</span>
<span class="cm">	 * and we need to revert the front/surround mixer switches</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x1193</span><span class="p">)</span> <span class="cm">/* ASUS A9T laptop */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">misc</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">);</span>
	<span class="cm">/* AD-compatible mode */</span>
	<span class="cm">/* Stereo mutes enabled */</span>
	<span class="n">misc</span> <span class="o">|=</span> <span class="n">AC97_AD198X_MSPLT</span> <span class="o">|</span> <span class="n">AC97_AD198X_AC97NC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">lo_as_master</span><span class="p">)</span>
		<span class="cm">/* Switch FRONT/SURROUND LINE-OUT/HP-OUT default connection */</span>
		<span class="cm">/* it seems that most vendors connect line-out connector to</span>
<span class="cm">		 * headphone out of AC&#39;97</span>
<span class="cm">		 */</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="n">AC97_AD198X_LOSEL</span> <span class="o">|</span> <span class="n">AC97_AD198X_HPSEL</span><span class="p">;</span>

	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1980_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_ad1888_specific</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_ad198x_2cmic</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1980_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1980_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">ad1888_update_jacks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1980</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1888</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1980_build_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1985_vrefout_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;High-Z&quot;</span><span class="p">,</span> <span class="s">&quot;3.7 V&quot;</span><span class="p">,</span> <span class="s">&quot;2.25 V&quot;</span><span class="p">,</span> <span class="s">&quot;0 V&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1985_vrefout_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">reg2ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_AD198X_VREF_MASK</span><span class="p">)</span>
	      <span class="o">&gt;&gt;</span> <span class="n">AC97_AD198X_VREF_SHIFT</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg2ctrl</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1985_vrefout_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ctrl2reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl2reg</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
	      <span class="o">&lt;&lt;</span> <span class="n">AC97_AD198X_VREF_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span>
				    <span class="n">AC97_AD198X_VREF_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad1985_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Exchange Center/LFE&quot;</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Exchange Front/Surround&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_lohpsel_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;High Pass Filter Enable&quot;</span><span class="p">,</span> <span class="n">AC97_AD_TEST2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Spread Front to Surround and Center/LFE&quot;</span><span class="p">,</span>
		    <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Downmix&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_put</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;V_REFOUT&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1985_vrefout_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1985_vrefout_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1985_vrefout_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>

	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1985_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1888_update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* clear OMS if shared jack is to be used for C/LFE out */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
			     <span class="n">is_shared_micin</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1985_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* rename 0x04 as &quot;Master&quot; and 0x02 as &quot;Master Surround&quot; */</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span>
				<span class="s">&quot;Master Surround Playback&quot;</span><span class="p">);</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_ad198x_2cmic</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ad1985_controls</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ad1985_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1985_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1985_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">ad1985_update_jacks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1985</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">misc</span><span class="p">;</span>
	
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1985_build_ops</span><span class="p">;</span>
	<span class="n">misc</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">);</span>
	<span class="cm">/* switch front/surround line-out/hp-out */</span>
	<span class="cm">/* AD-compatible mode */</span>
	<span class="cm">/* Stereo mutes enabled */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">misc</span> <span class="o">|</span>
			     <span class="n">AC97_AD198X_LOSEL</span> <span class="o">|</span>
			     <span class="n">AC97_AD198X_HPSEL</span> <span class="o">|</span>
			     <span class="n">AC97_AD198X_MSPLT</span> <span class="o">|</span>
			     <span class="n">AC97_AD198X_AC97NC</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>

	<span class="cm">/* update current jack configuration */</span>
	<span class="n">ad1985_update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>

	<span class="cm">/* on AD1985 rev. 3, AC&#39;97 revision bits are zero */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC97_EI_REV_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">AC97_EI_REV_23</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_ac97_ad1986_bool_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_lososel_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC3</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_LOSEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_lososel_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sprd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_SPRD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret0</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC3</span><span class="p">,</span> <span class="n">AC97_AD1986_LOSEL</span><span class="p">,</span>
					<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
				    <span class="o">?</span> <span class="n">AC97_AD1986_LOSEL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret0</span><span class="p">;</span>

	<span class="cm">/* SOSEL is set to values of &quot;Spread&quot; or &quot;Exchange F/S&quot; controls */</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD1986_SOSEL</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
				     <span class="o">||</span> <span class="n">sprd</span><span class="p">)</span>
				    <span class="o">?</span> <span class="n">AC97_AD1986_SOSEL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_spread_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_SPRD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_spread_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sprd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_LOSEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret0</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD1986_SPRD</span><span class="p">,</span>
					<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
				    <span class="o">?</span> <span class="n">AC97_AD1986_SPRD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret0</span><span class="p">;</span>

	<span class="cm">/* SOSEL is set to values of &quot;Spread&quot; or &quot;Exchange F/S&quot; controls */</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span> <span class="n">AC97_AD1986_SOSEL</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
				     <span class="o">||</span> <span class="n">sprd</span><span class="p">)</span>
				    <span class="o">?</span> <span class="n">AC97_AD1986_SOSEL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_miclisel_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">swap_mic_linein</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_miclisel_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">swap</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swap</span> <span class="o">!=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">swap_mic_linein</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">swap_mic_linein</span> <span class="o">=</span> <span class="n">swap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">)</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span><span class="o">-&gt;</span><span class="n">update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_vrefout_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Use MIC_1/2 V_REFOUT as the &quot;get&quot; value */</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_AD_MISC2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_MVREF0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_MVREF1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">AC97_AD1986_MVREF2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_ad1986_vrefout_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* High-Z */</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 3.7 V */</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="n">AC97_AD1986_CVREF2</span><span class="p">;</span>
		<span class="n">lval</span> <span class="o">=</span> <span class="n">AC97_AD1986_LVREF2</span><span class="p">;</span>
		<span class="n">mval</span> <span class="o">=</span> <span class="n">AC97_AD1986_MVREF2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 2.25 V */</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="n">AC97_AD1986_CVREF0</span><span class="p">;</span>
		<span class="n">lval</span> <span class="o">=</span> <span class="n">AC97_AD1986_LVREF0</span><span class="p">;</span>
		<span class="n">mval</span> <span class="o">=</span> <span class="n">AC97_AD1986_MVREF0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* 0 V */</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="n">AC97_AD1986_CVREF1</span><span class="p">;</span>
		<span class="n">lval</span> <span class="o">=</span> <span class="n">AC97_AD1986_LVREF1</span><span class="p">;</span>
		<span class="n">mval</span> <span class="o">=</span> <span class="n">AC97_AD1986_MVREF1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cret</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC2</span><span class="p">,</span>
				    <span class="n">AC97_AD1986_CVREF_MASK</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cret</span><span class="p">;</span>
	<span class="n">lret</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC3</span><span class="p">,</span>
				    <span class="n">AC97_AD1986_LVREF_MASK</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">lret</span><span class="p">;</span>
	<span class="n">mret</span> <span class="o">=</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC2</span><span class="p">,</span>
				    <span class="n">AC97_AD1986_MVREF_MASK</span><span class="p">,</span> <span class="n">mval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_ad1986_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Exchange Center/LFE&quot;</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Exchange Front/Surround&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_bool_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_lososel_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_lososel_put</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Exchange Mic/Line In&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_bool_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_miclisel_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_miclisel_put</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Spread Front to Surround and Center/LFE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_bool_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_spread_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_spread_put</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Downmix&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1888_downmix_put</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;V_REFOUT&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ac97_ad1985_vrefout_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_vrefout_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ac97_ad1986_vrefout_put</span>
	<span class="p">},</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>

	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Jack Sense&quot;</span><span class="p">,</span> <span class="n">AC97_AD_JACK_SPDIF</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1986_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">misc_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ser_val</span><span class="p">;</span>

	<span class="cm">/* disable SURROUND and CENTER/LFE if not surround mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_surround_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">misc_val</span> <span class="o">|=</span> <span class="n">AC97_AD1986_SODIS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_clfe_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">misc_val</span> <span class="o">|=</span> <span class="n">AC97_AD1986_CLDIS</span><span class="p">;</span>

	<span class="cm">/* select line input (default=LINE_IN, SURROUND or MIC_1/2) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_shared_linein</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">misc_val</span> <span class="o">|=</span> <span class="n">AC97_AD1986_LISEL_SURR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">swap_mic_linein</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">misc_val</span> <span class="o">|=</span> <span class="n">AC97_AD1986_LISEL_MIC</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_MISC</span><span class="p">,</span>
			     <span class="n">AC97_AD1986_SODIS</span> <span class="o">|</span> <span class="n">AC97_AD1986_CLDIS</span> <span class="o">|</span>
			     <span class="n">AC97_AD1986_LISEL_MASK</span><span class="p">,</span>
			     <span class="n">misc_val</span><span class="p">);</span>

	<span class="cm">/* select microphone input (MIC_1/2, Center/LFE or LINE_IN) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_shared_micin</span><span class="p">(</span><span class="n">ac97</span><span class="p">))</span>
		<span class="n">ser_val</span> <span class="o">=</span> <span class="n">AC97_AD1986_OMS_C</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">ad18xx</span><span class="p">.</span><span class="n">swap_mic_linein</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ser_val</span> <span class="o">=</span> <span class="n">AC97_AD1986_OMS_L</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ser_val</span> <span class="o">=</span> <span class="n">AC97_AD1986_OMS_M</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_AD_SERIAL_CFG</span><span class="p">,</span>
			     <span class="n">AC97_AD1986_OMS_MASK</span><span class="p">,</span>
			     <span class="n">ser_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1986_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_ad198x_2cmic</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_ad1986_controls</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_ad1985_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ad1986_build_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_ad198x_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_specific</span> <span class="o">=</span> <span class="n">patch_ad1986_specific</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad18xx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">ad1986_update_jacks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ad1986</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">patch_ad1881</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ad1986_build_ops</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_STEREO_MUTES</span><span class="p">;</span>

	<span class="cm">/* update current jack configuration */</span>
	<span class="n">ad1986_update_jacks</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * realtek ALC203: use mono-out for pin 37</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc203</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * realtek ALC65x/850 codecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">alc650_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared</span><span class="p">;</span>
	
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* update shared Mic In / Center/LFE Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* disable/enable vref */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* turn on/off center-on-mic */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* GPIO0 high for mic */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_STATUS</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_alc650</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Duplicate Front&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Surround Down Mix&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Center/LFE Down Mix&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Exchange Center/LFE&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* 4: Analog Input To Surround */</span>
	<span class="cm">/* 5: Analog Input To Center/LFE */</span>
	<span class="cm">/* 6: Independent Master Volume Right */</span>
	<span class="cm">/* 7: Independent Master Volume Left */</span>
	<span class="cm">/* 8: reserved */</span>
	<span class="cm">/* 9: Line-In/Surround share */</span>
	<span class="cm">/* 10: Mic/CLFE share */</span>
	<span class="cm">/* 11-13: in IEC958 controls */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Swap Surround Slot&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cp">#if 0</span><span class="c"> /* always set in patch_alc650 */</span>
<span class="c">	AC97_SINGLE(&quot;IEC958 Input Clock Enable&quot;, AC97_ALC650_CLOCK, 0, 1, 0),</span>
<span class="c">	AC97_SINGLE(&quot;IEC958 Input Pin Enable&quot;, AC97_ALC650_CLOCK, 1, 1, 0),</span>
<span class="c">	AC97_SINGLE(&quot;Surround DAC Switch&quot;, AC97_ALC650_SURR_DAC_VOL, 15, 1, 1),</span>
<span class="c">	AC97_DOUBLE(&quot;Surround DAC Volume&quot;, AC97_ALC650_SURR_DAC_VOL, 8, 0, 31, 1),</span>
<span class="c">	AC97_SINGLE(&quot;Center/LFE DAC Switch&quot;, AC97_ALC650_LFE_DAC_VOL, 15, 1, 1),</span>
<span class="c">	AC97_DOUBLE(&quot;Center/LFE DAC Volume&quot;, AC97_ALC650_LFE_DAC_VOL, 8, 0, 31, 1),</span>
<span class="cp">#endif</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_spdif_controls_alc650</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Analog to IEC958 Output&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* disable this controls since it doesn&#39;t work as expected */</span>
	<span class="cm">/* AC97_SINGLE(&quot;IEC958 Input Monitor&quot;, AC97_ALC650_MULTICH, 13, 1, 0), */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_5bit_3db_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">4350</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc650_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_alc650</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_alc650</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_spdif_controls_alc650</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_spdif_controls_alc650</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">AC97_ID_ALC650F</span><span class="p">)</span>
		<span class="n">reset_tlv</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
			  <span class="n">db_scale_5bit_3db_max</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_alc650_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_alc650_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">alc650_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc650</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_alc650_ops</span><span class="p">;</span>

	<span class="cm">/* determine the revision */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_REVISION</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x414c4720</span><span class="p">;</span>          <span class="cm">/* Old version */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x414c4721</span><span class="p">;</span>          <span class="cm">/* D version */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x414c4722</span><span class="p">;</span>          <span class="cm">/* E version */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x414c4723</span><span class="p">;</span>          <span class="cm">/* F version */</span>

	<span class="cm">/* revision E or F */</span>
	<span class="cm">/* FIXME: what about revision D ? */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x414c4722</span> <span class="o">||</span>
				<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x414c4723</span><span class="p">);</span>

	<span class="cm">/* enable AC97_ALC650_GPIO_SETUP, AC97_ALC650_CLOCK for R/W */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_STATUS</span><span class="p">,</span> 
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_STATUS</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/* Enable SPDIF-IN only on Rev.E and above */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">);</span>
	<span class="cm">/* SPDIF IN with pin 47 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">&amp;&amp;</span>
	    <span class="cm">/* ASUS A6KM requires EAPD */</span>
	    <span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span> <span class="o">&amp;&amp;</span>
	       <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x1103</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* enable */</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* disable */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* set default: slot 3,4,7,8,6,9</span>
<span class="cm">	   spdif-in monitor off, analog-spdif off, spdif-in off</span>
<span class="cm">	   center on mic off, surround on line-in off</span>
<span class="cm">	   downmix off, duplicate front off</span>
<span class="cm">	*/</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set GPIO0 for mic bias */</span>
	<span class="cm">/* GPIO0 pin output, no interrupt, high */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_SETUP</span><span class="p">,</span>
			     <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_SETUP</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_STATUS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_GPIO_STATUS</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* full DAC volume */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SURR_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_LFE_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alc655_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared</span><span class="p">;</span>
	
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
			      <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* update shared Mic In / Center/LFE Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* misc control; vrefout disable */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_CLOCK</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
			      <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_alc655</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_PAGE_SINGLE</span><span class="p">(</span><span class="s">&quot;Duplicate Front&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alc655_iec958_route_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_655</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;PCM&quot;</span><span class="p">,</span> <span class="s">&quot;Analog In&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958 In&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_658</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;PCM&quot;</span><span class="p">,</span> <span class="s">&quot;Analog1 In&quot;</span><span class="p">,</span> <span class="s">&quot;Analog2 In&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958 In&quot;</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">?</span>
	       <span class="n">texts_658</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]</span> <span class="o">:</span>
	       <span class="n">texts_655</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alc655_iec958_route_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_ALC650_MULTICH</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alc655_iec958_route_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_spdif_controls_alc655</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">AC97_PAGE_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* disable this controls since it doesn&#39;t work as expected */</span>
        <span class="cm">/* AC97_PAGE_SINGLE(&quot;IEC958 Input Monitor&quot;, AC97_ALC650_MULTICH, 14, 1, 0, 0), */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>  <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>   <span class="o">=</span> <span class="n">alc655_iec958_route_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>    <span class="o">=</span> <span class="n">alc655_iec958_route_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>    <span class="o">=</span> <span class="n">alc655_iec958_route_put</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc655_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_alc655</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_alc655</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_spdif_controls_alc655</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_spdif_controls_alc655</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_alc655_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_alc655_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">alc655_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc655</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_ALC658</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ALC658 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_REVISION</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">AC97_ID_ALC658D</span><span class="p">;</span>
			<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_alc655_ops</span><span class="p">;</span>

	<span class="cm">/* assume only page 0 for writing cache */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">AC97_PAGE_VENDOR</span><span class="p">);</span>

	<span class="cm">/* adjust default values */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">);</span> <span class="cm">/* misc control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">)</span> <span class="cm">/* ALC658 */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Pin 47 is spdif input pin */</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* ALC655 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1462</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0131</span> <span class="o">||</span> <span class="cm">/* MSI S270 laptop */</span>
		     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0161</span> <span class="o">||</span> <span class="cm">/* LG K1 Express */</span>
		     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0351</span> <span class="o">||</span> <span class="cm">/* MSI L725 laptop */</span>
		     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0471</span> <span class="o">||</span> <span class="cm">/* MSI L720 laptop */</span>
		     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0061</span><span class="p">))</span>  <span class="cm">/* MSI S250 laptop */</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Pin 47 is EAPD (for internal speaker) */</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Pin 47 is spdif input pin */</span>
		<span class="cm">/* this seems missing on some hardwares */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* vref enable */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* set default: spdif-in enabled,</span>
<span class="cm">	   spdif-in monitor off, spdif-in PCM off</span>
<span class="cm">	   center on mic off, surround on line-in off</span>
<span class="cm">	   duplicate front off</span>
<span class="cm">	*/</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>

	<span class="cm">/* full DAC volume */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SURR_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_LFE_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>

	<span class="cm">/* update undocumented bit... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_ALC658D</span><span class="p">)</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define AC97_ALC850_JACK_SELECT	0x76</span>
<span class="cp">#define AC97_ALC850_MISC1	0x7a</span>
<span class="cp">#define AC97_ALC850_MULTICH    0x6a</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alc850_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aux_is_back_surround</span><span class="p">;</span>
	
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* SURR 1kOhm (bit4), Amp (bit5) */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC850_MISC1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">),</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* LINE-IN = 0, SURROUND = 2 */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC850_JACK_SELECT</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">));</span>
	<span class="cm">/* update shared Mic In / Center/LFE Out */</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* Vref disable (bit12), 1kOhm (bit13) */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC850_MISC1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">),</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>
	<span class="cm">/* MIC-IN = 1, CENTER-LFE = 5 */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC850_JACK_SELECT</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
			     <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>

	<span class="n">aux_is_back_surround</span> <span class="o">=</span> <span class="n">alc850_is_aux_back_surround</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
	<span class="cm">/* Aux is Back Surround */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC850_MULTICH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
				 <span class="n">aux_is_back_surround</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_alc850</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_PAGE_SINGLE</span><span class="p">(</span><span class="s">&quot;Duplicate Front&quot;</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Front Input Switch&quot;</span><span class="p">,</span> <span class="n">AC97_ALC850_JACK_SELECT</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_8CH_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc850_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_alc850</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_alc850</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_spdif_controls_alc655</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_spdif_controls_alc655</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_alc850_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_alc850_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">alc850_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_alc850</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_alc850_ops</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* for IEC958 playback route - ALC655 compatible */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_8CH</span><span class="p">;</span>

	<span class="cm">/* assume only page 0 for writing cache */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">AC97_PAGE_VENDOR</span><span class="p">);</span>

	<span class="cm">/* adjust default values */</span>
	<span class="cm">/* set default: spdif-in enabled,</span>
<span class="cm">	   spdif-in monitor off, spdif-in PCM off</span>
<span class="cm">	   center on mic off, surround on line-in off</span>
<span class="cm">	   duplicate front off</span>
<span class="cm">	   NB default bit 10=0 = Aux is Capture, not Back Surround</span>
<span class="cm">	*/</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_MULTICH</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="cm">/* SURR_OUT: on, Surr 1kOhm: on, Surr Amp: off, Front 1kOhm: off</span>
<span class="cm">	 * Front Amp: on, Vref: enable, Center 1kOhm: on, Mix: on</span>
<span class="cm">	 */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">));</span>
	<span class="cm">/* detection UIO2,3: all path floating, UIO3: MIC, Vref2: disable,</span>
<span class="cm">	 * UIO1: FRONT, Vref3: disable, UIO3: LINE, Front-Mic: mute</span>
<span class="cm">	 */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">));</span>

	<span class="cm">/* full DAC volume */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_SURR_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_ALC650_LFE_DAC_VOL</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_aztech_azf3328_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl_3d_center</span> <span class="o">=</span>
		<span class="n">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;3D Control - Center&quot;</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl_3d_depth</span> <span class="o">=</span>
		<span class="n">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;3D Control - Depth&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 3D register is different from AC97 standard layout</span>
<span class="cm">	 * (also do some renaming, to resemble Windows driver naming)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl_3d_center</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kctl_3d_center</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span>
			<span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
			<span class="s">&quot;3D Control - Center&quot;</span><span class="p">,</span> <span class="s">&quot;3D Control - Width&quot;</span>
		<span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl_3d_depth</span><span class="p">)</span>
		<span class="n">kctl_3d_depth</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span>
			<span class="n">AC97_SINGLE_VALUE</span><span class="p">(</span><span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Aztech Windows driver calls the</span>
<span class="cm">	   equivalent control &quot;Modem Playback&quot;, thus rename it: */</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
		<span class="s">&quot;Master Mono Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Modem Playback&quot;</span>
	<span class="p">);</span>
	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span>
		<span class="s">&quot;Headphone Playback&quot;</span><span class="p">,</span> <span class="s">&quot;FM Synth Playback&quot;</span>
	<span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_aztech_azf3328_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_aztech_azf3328_specific</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_aztech_azf3328</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_aztech_azf3328_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * C-Media CM97xx codecs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm9738_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9738_VENDOR_CTRL</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
			     <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cm9738_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Duplicate Front&quot;</span><span class="p">,</span> <span class="n">AC97_CM9738_VENDOR_CTRL</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_4CH_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9738_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_cm9738_controls</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_cm9738_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_cm9738_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_cm9738_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">cm9738_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9738</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_cm9738_ops</span><span class="p">;</span>
	<span class="cm">/* FIXME: can anyone confirm below? */</span>
	<span class="cm">/* CM9738 has no PCM volume although the register reacts */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_NO_PCM_VOL</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cmedia_spdif_playback_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;Digital&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cmedia_spdif_playback_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_cmedia_spdif_playback_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span>
				    <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> 
				    <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cm9739_controls_spdif</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* BIT 0: SPDI_EN - always true */</span>
	<span class="p">{</span> <span class="cm">/* BIT 1: SPDIFS */</span>
		<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_ac97_cmedia_spdif_playback_source_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_ac97_cmedia_spdif_playback_source_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_ac97_cmedia_spdif_playback_source_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* BIT 2: IG_SPIV */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Valid Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* BIT 3: SPI2F */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Monitor&quot;</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
	<span class="cm">/* BIT 4: SPI2SDI */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* BIT 8: SPD32 - 32bit SPDIF - not supported yet */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm9739_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
			     <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* shared Mic In / Center/LFE Out **/</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span>
			     <span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1000</span> <span class="o">:</span> <span class="mh">0x2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cm9739_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9739_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_cm9739_controls</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_cm9739_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9739_post_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_cm9739_controls_spdif</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_cm9739_controls_spdif</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_cm9739_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_cm9739_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_cm9739_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">cm9739_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9739</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_cm9739_ops</span><span class="p">;</span>

	<span class="cm">/* CM9739/A has no Master and PCM volume although the register reacts */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AC97_HAS_NO_MASTER_VOL</span> <span class="o">|</span> <span class="n">AC97_HAS_NO_PCM_VOL</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/* check spdif */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AC97_EA_SPCV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable spdif in */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span>
				     <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span> <span class="cm">/* 48k only */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC97_EI_SPDIF</span><span class="p">;</span> <span class="cm">/* disable extended-id */</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set-up multi channel */</span>
	<span class="cm">/* bit 14: 0 = SPDIF, 1 = EAPD */</span>
	<span class="cm">/* bit 13: enable internal vref output for mic */</span>
	<span class="cm">/* bit 12: disable center/lfe (swithable) */</span>
	<span class="cm">/* bit 10: disable surround/line (switchable) */</span>
	<span class="cm">/* bit 9: mix 2 surround off */</span>
	<span class="cm">/* bit 4: undocumented; 0 mutes the CM9739A, which defaults to 1 */</span>
	<span class="cm">/* bit 3: undocumented; surround? */</span>
	<span class="cm">/* bit 0: dB */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* FIXME: set up GPIO */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="cm">/* Special exception for ASUS W1000/CMI9739. It does not have an SPDIF in. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x1843</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">,</span>
			<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_SPDIF_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">,</span>
			<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9739_MULTI_CHAN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AC97_CM9761_MULTI_CHAN	0x64</span>
<span class="cp">#define AC97_CM9761_FUNC	0x66</span>
<span class="cp">#define AC97_CM9761_SPDIF_CTRL	0x6c</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm9761_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: check the bits for each model</span>
<span class="cm">	 *        model 83 is confirmed to work</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">surr_on</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="cm">/* 9761-78 &amp; 82 */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span> <span class="cm">/* 9761-82 rev.B */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span> <span class="cm">/* 9761-83 */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clfe_on</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="p">},</span> <span class="cm">/* 9761-78 &amp; 82 */</span>
		<span class="p">{</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="cm">/* 9761-82 rev.B */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="p">},</span> <span class="cm">/* 9761-83 */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">surr_shared</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0400</span> <span class="p">},</span> <span class="cm">/* 9761-78 &amp; 82 */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0400</span> <span class="p">},</span> <span class="cm">/* 9761-82 rev.B */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0400</span> <span class="p">},</span> <span class="cm">/* 9761-83 */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clfe_shared</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x0880</span> <span class="p">},</span> <span class="cm">/* 9761-78 &amp; 82 */</span>
		<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2880</span> <span class="p">},</span> <span class="cm">/* 9761-82 rev.B */</span>
		<span class="p">{</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x0800</span> <span class="p">},</span> <span class="cm">/* 9761-83 */</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">surr_on</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">][</span><span class="n">is_surround_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">)];</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">clfe_on</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">][</span><span class="n">is_clfe_on</span><span class="p">(</span><span class="n">ac97</span><span class="p">)];</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">surr_shared</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">][</span><span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)];</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">clfe_shared</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">][</span><span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)];</span>

	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_MULTI_CHAN</span><span class="p">,</span> <span class="mh">0x3c88</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cm9761_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm9761_spdif_out_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AC-Link&quot;</span><span class="p">,</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF-In&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm9761_spdif_out_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CM9761_FUNC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* SPDIF-loopback */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ADC loopback */</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* AC-link */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm9761_spdif_out_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_FUNC</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_FUNC</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span>
				    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mh">0x2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cm9761_dac_clock</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AC-Link&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF-In&quot;</span><span class="p">,</span> <span class="s">&quot;Both&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_enum</span> <span class="n">cm9761_dac_clock_enum</span> <span class="o">=</span>
	<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cm9761_dac_clock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_cm9761_controls_spdif</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* BIT 1: SPDIFS */</span>
		<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">cm9761_spdif_out_source_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">cm9761_spdif_out_source_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">cm9761_spdif_out_source_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* BIT 2: IG_SPIV */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Valid Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* BIT 3: SPI2F */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Monitor&quot;</span><span class="p">,</span> <span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
	<span class="cm">/* BIT 4: SPI2SDI */</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* BIT 9-10: DAC_CTL */</span>
	<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;DAC Clock Source&quot;</span><span class="p">,</span> <span class="n">cm9761_dac_clock_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9761_post_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_cm9761_controls_spdif</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_cm9761_controls_spdif</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9761_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_cm9761_controls</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_cm9761_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_cm9761_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_cm9761_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_cm9761_post_spdif</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">cm9761_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9761</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* CM9761 has no PCM volume although the register reacts */</span>
	<span class="cm">/* Master volume seems to have _some_ influence on the analog</span>
<span class="cm">	 * input sounds</span>
<span class="cm">	 */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="cm">/*AC97_HAS_NO_MASTER_VOL |*/</span> <span class="n">AC97_HAS_NO_PCM_VOL</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">);</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 1 = model 82 revision B, 2 = model 83 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_CM9761_82</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="cm">/* check page 1, reg 0x60 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">);</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* revision B? */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AC97_ID_CM9761_83</span><span class="p">)</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_cm9761_ops</span><span class="p">;</span>

	<span class="cm">/* enable spdif */</span>
	<span class="cm">/* force the SPDIF bit in ext_id - codec doesn&#39;t set this bit! */</span>
        <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>
	<span class="cm">/* to be sure: we overwrite the ext status bits */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="mh">0x05c0</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t set 0x0200 here.  This results in the silent analog output */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_SPDIF_CTRL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span> <span class="cm">/* enable spdif-in */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span> <span class="cm">/* 48k only */</span>

	<span class="cm">/* set-up multi channel */</span>
	<span class="cm">/* bit 15: pc master beep off</span>
<span class="cm">	 * bit 14: pin47 = EAPD/SPDIF</span>
<span class="cm">	 * bit 13: vref ctl [= cm9739]</span>
<span class="cm">	 * bit 12: CLFE control (reverted on rev B)</span>
<span class="cm">	 * bit 11: Mic/center share (reverted on rev B)</span>
<span class="cm">	 * bit 10: suddound/line share</span>
<span class="cm">	 * bit  9: Analog-in mix -&gt; surround</span>
<span class="cm">	 * bit  8: Analog-in mix -&gt; CLFE</span>
<span class="cm">	 * bit  7: Mic/LFE share (mic/center/lfe)</span>
<span class="cm">	 * bit  5: vref select (9761A)</span>
<span class="cm">	 * bit  4: front control</span>
<span class="cm">	 * bit  3: surround control (revereted with rev B)</span>
<span class="cm">	 * bit  2: front mic</span>
<span class="cm">	 * bit  1: stereo mic</span>
<span class="cm">	 * bit  0: mic boost level (0=20dB, 1=30dB)</span>
<span class="cm">	 */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (ac97-&gt;spec.dev_flags)</span>
<span class="c">		val = 0x0214;</span>
<span class="c">	else</span>
<span class="c">		val = 0x321c;</span>
<span class="cp">#endif</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_MULTI_CHAN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* front on */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9761_MULTI_CHAN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* FIXME: set up GPIO */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
       
<span class="cp">#define AC97_CM9780_SIDE	0x60</span>
<span class="cp">#define AC97_CM9780_JACK	0x62</span>
<span class="cp">#define AC97_CM9780_MIXER	0x64</span>
<span class="cp">#define AC97_CM9780_MULTI_CHAN	0x66</span>
<span class="cp">#define AC97_CM9780_SPDIF	0x6c</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cm9780_ch_select</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Front&quot;</span><span class="p">,</span> <span class="s">&quot;Side&quot;</span><span class="p">,</span> <span class="s">&quot;Center/LFE&quot;</span><span class="p">,</span> <span class="s">&quot;Rear&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ac97_enum</span> <span class="n">cm9780_ch_select_enum</span> <span class="o">=</span>
	<span class="n">AC97_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_CM9780_MULTI_CHAN</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cm9780_ch_select</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">cm9780_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Side Playback Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CM9780_SIDE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Side Playback Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CM9780_SIDE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_ENUM</span><span class="p">(</span><span class="s">&quot;Side Playback Route&quot;</span><span class="p">,</span> <span class="n">cm9780_ch_select_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9780_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">cm9780_controls</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cm9780_controls</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_cm9780_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_cm9780_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_post_spdif</span> <span class="o">=</span> <span class="n">patch_cm9761_post_spdif</span>	<span class="cm">/* identical with CM9761 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cm9780</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_cm9780_ops</span><span class="p">;</span>

	<span class="cm">/* enable spdif */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span> <span class="cm">/* 48k only */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9780_SPDIF</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* SPDI_EN */</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CM9780_SPDIF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VIA VT1616 codec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_vt1616</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;DC Offset removal&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Alternate Level to Surround Out&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Downmix LFE and Center to Front&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Downmix Surround to Front&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_vols_vt1616</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Front Playback Volume&quot;</span><span class="p">,</span>
	<span class="s">&quot;Surround Playback Volume&quot;</span><span class="p">,</span>
	<span class="s">&quot;Center Playback Volume&quot;</span><span class="p">,</span>
	<span class="s">&quot;LFE Playback Volume&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_sws_vt1616</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Front Playback Switch&quot;</span><span class="p">,</span>
	<span class="s">&quot;Surround Playback Switch&quot;</span><span class="p">,</span>
	<span class="s">&quot;Center Playback Switch&quot;</span><span class="p">,</span>
	<span class="s">&quot;LFE Playback Switch&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* find a mixer control element with the given name */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="nf">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
						    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* create a virtual master control and add slaves */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_add_vmaster</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">slaves</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tlv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">slaves</span><span class="p">;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">sctl</span><span class="p">;</span>

		<span class="n">sctl</span> <span class="o">=</span> <span class="n">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Cannot find slave %s, skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">sctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1616_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_try_bit</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_vt1616</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_vt1616</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_vt1616</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* There is already a misnamed master switch.  Rename it.  */</span>
	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ac97_find_mixer_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">snd_ac97_rename_vol_ctl</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Front Playback&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_add_vmaster</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
				   <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">slave_vols_vt1616</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_add_vmaster</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="n">slave_sws_vt1616</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_vt1616_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_vt1616_specific</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1616</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_vt1616_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VT1617A codec</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * unfortunately, the vt1617a stashes the twiddlers required for</span>
<span class="cm"> * noodling the i/o jacks on 2 different regs. that means that we can&#39;t</span>
<span class="cm"> * use the easy way provided by AC97_ENUM_DOUBLE() we have to write</span>
<span class="cm"> * are own funcs.</span>
<span class="cm"> *</span>
<span class="cm"> * NB: this is absolutely and utterly different from the vt1618. dunno</span>
<span class="cm"> * about the 1616.</span>
<span class="cm"> */</span>

<span class="cm">/* copied from ac97_surround_jack_mode_info() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1617a_smart51_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ordering in this list reflects vt1617a docs for Reg 20 and</span>
<span class="cm">	 * 7a and Table 6 that lays out the matrix NB WRT Table6: SM51</span>
<span class="cm">	 * is SM51EN *AND* it&#39;s Bit14, not Bit15 so the table is very</span>
<span class="cm">	 * counter-intuitive */</span> 

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;LineIn Mic1&quot;</span><span class="p">,</span> <span class="s">&quot;LineIn Mic1 Mic3&quot;</span><span class="p">,</span>
				       <span class="s">&quot;Surr LFE/C Mic3&quot;</span><span class="p">,</span> <span class="s">&quot;LineIn LFE/C Mic3&quot;</span><span class="p">,</span>
				       <span class="s">&quot;LineIn Mic2&quot;</span><span class="p">,</span> <span class="s">&quot;LineIn Mic2 Mic1&quot;</span><span class="p">,</span>
				       <span class="s">&quot;Surr LFE Mic1&quot;</span><span class="p">,</span> <span class="s">&quot;Surr LFE Mic1 Mic2&quot;</span><span class="p">};</span>
	<span class="k">return</span> <span class="n">ac97_enum_text_info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1617a_smart51_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ushort</span> <span class="n">usSM51</span><span class="p">,</span> <span class="n">usMS</span><span class="p">;</span>  

	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">pac97</span><span class="p">;</span>
	
	<span class="n">pac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span> <span class="cm">/* grab codec handle */</span>

	<span class="cm">/* grab our desired bits, then mash them together in a manner</span>
<span class="cm">	 * consistent with Table 6 on page 17 in the 1617a docs */</span>
 
	<span class="n">usSM51</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">usMS</span>   <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSM51</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">usMS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1617a_smart51_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ushort</span> <span class="n">usSM51</span><span class="p">,</span> <span class="n">usMS</span><span class="p">,</span> <span class="n">usReg</span><span class="p">;</span>  

	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">pac97</span><span class="p">;</span>

	<span class="n">pac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span> <span class="cm">/* grab codec handle */</span>

	<span class="n">usSM51</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usMS</span>   <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>  <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* push our values into the register - consider that things will be left</span>
<span class="cm">	 * in a funky state if the write fails */</span>

	<span class="n">usReg</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="p">(</span><span class="n">usReg</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">usSM51</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="n">usReg</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">usReg</span> <span class="o">&amp;</span> <span class="mh">0xFEFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">usMS</span>   <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_vt1617a</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Center/LFE Exchange&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * These are used to enable/disable surround sound on motherboards</span>
<span class="cm">	 * that have 3 bidirectional analog jacks</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>         <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Smart 5.1 Select&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>          <span class="o">=</span> <span class="n">snd_ac97_vt1617a_smart51_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1617a_smart51_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1617a_smart51_put</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1617a</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* we choose to not fail out at this point, but we tell the</span>
<span class="cm">	   caller when we return */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ac97_controls_vt1617a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_vt1617a</span><span class="p">));</span>

	<span class="cm">/* bring analog power consumption to normal by turning off the</span>
<span class="cm">	 * headphone amplifier, like WinXP driver for EPIA SP</span>
<span class="cm">	 */</span>
	<span class="cm">/* We need to check the bit before writing it.</span>
<span class="cm">	 * On some (many?) hardwares, setting bit actually clears it!</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">|=</span> <span class="n">AC97_EI_SPDIF</span><span class="p">;</span>	<span class="cm">/* force the detection of spdif */</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_vt1616_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VIA VT1618 8 CHANNEL AC97 CODEC</span>
<span class="cm"> *</span>
<span class="cm"> * VIA implements &#39;Smart 5.1&#39; completely differently on the 1618 than</span>
<span class="cm"> * it does on the 1617a. awesome! They seem to have sourced this</span>
<span class="cm"> * particular revision of the technology from somebody else, it&#39;s</span>
<span class="cm"> * called Universal Audio Jack and it shows up on some other folk&#39;s chips</span>
<span class="cm"> * as well.</span>
<span class="cm"> *</span>
<span class="cm"> * ordering in this list reflects vt1618 docs for Reg 60h and</span>
<span class="cm"> * the block diagram, DACs are as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *        OUT_O -&gt; Front,</span>
<span class="cm"> *	  OUT_1 -&gt; Surround,</span>
<span class="cm"> *	  OUT_2 -&gt; C/LFE</span>
<span class="cm"> *</span>
<span class="cm"> * Unlike the 1617a, each OUT has a consistent set of mappings</span>
<span class="cm"> * for all bitpatterns other than 00:</span>
<span class="cm"> *</span>
<span class="cm"> *        01       Unmixed Output</span>
<span class="cm"> *        10       Line In</span>
<span class="cm"> *        11       Mic  In</span>
<span class="cm"> *</span>
<span class="cm"> * Special Case of 00:</span>
<span class="cm"> *</span>
<span class="cm"> *        OUT_0    Mixed Output</span>
<span class="cm"> *        OUT_1    Reserved</span>
<span class="cm"> *        OUT_2    Reserved</span>
<span class="cm"> *</span>
<span class="cm"> * I have no idea what the hell Reserved does, but on an MSI</span>
<span class="cm"> * CN700T, i have to set it to get 5.1 output - YMMV, bad</span>
<span class="cm"> * shit may happen.</span>
<span class="cm"> *</span>
<span class="cm"> * If other chips use Universal Audio Jack, then this code might be applicable</span>
<span class="cm"> * to them.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">vt1618_uaj_item</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* This list reflects the vt1618 docs for Vendor Defined Register 0x60. */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vt1618_uaj_item</span> <span class="n">vt1618_uaj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* speaker jack */</span>
		<span class="p">.</span><span class="n">mask</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Speaker Out&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Unmixed Out&quot;</span><span class="p">,</span> <span class="s">&quot;Line In&quot;</span><span class="p">,</span> <span class="s">&quot;Mic In&quot;</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* line jack */</span>
		<span class="p">.</span><span class="n">mask</span>  <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Surround Out&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Unmixed Out&quot;</span><span class="p">,</span> <span class="s">&quot;Line In&quot;</span><span class="p">,</span> <span class="s">&quot;Mic In&quot;</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* mic jack */</span>
		<span class="p">.</span><span class="n">mask</span>  <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Center LFE Out&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Unmixed Out&quot;</span><span class="p">,</span> <span class="s">&quot;Line In&quot;</span><span class="p">,</span> <span class="s">&quot;Mic In&quot;</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_UAJ_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ac97_enum_text_info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">,</span>
				   <span class="n">vt1618_uaj</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">].</span><span class="n">items</span><span class="p">,</span>
				   <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* All of the vt1618 Universal Audio Jack twiddlers are on</span>
<span class="cm"> * Vendor Defined Register 0x60, page 0. The bits, and thus</span>
<span class="cm"> * the mask, are the only thing that changes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_UAJ_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">datpag</span><span class="p">,</span> <span class="n">uaj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">pac97</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>

	<span class="n">datpag</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC97_PAGE_MASK</span><span class="p">;</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">uaj</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">vt1618_uaj</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">pac97</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="n">AC97_PAGE_MASK</span><span class="p">,</span> <span class="n">datpag</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pac97</span><span class="o">-&gt;</span><span class="n">page_mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uaj</span> <span class="o">&gt;&gt;</span>
		<span class="n">vt1618_uaj</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">].</span><span class="n">shift</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_UAJ_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ac97_update_bits_page</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">),</span> <span class="mh">0x60</span><span class="p">,</span>
				     <span class="n">vt1618_uaj</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
				     <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span>
				     <span class="n">vt1618_uaj</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">].</span><span class="n">shift</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* config aux in jack - not found on 3 jack motherboards or soundcards */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_aux_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">txt_aux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Aux In&quot;</span><span class="p">,</span> <span class="s">&quot;Back Surr Out&quot;</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">ac97_enum_text_info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">,</span> <span class="n">txt_aux</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_aux_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">),</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ac97_vt1618_aux_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* toggle surround rear dac power */</span>

	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">),</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span>
			     <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* toggle aux in surround rear out jack */</span>

	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">),</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span>
				    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_vt1618</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Exchange Center/LFE&quot;</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;DC Offset&quot;</span><span class="p">,</span>           <span class="mh">0x5a</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Soft Mute&quot;</span><span class="p">,</span>           <span class="mh">0x5c</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Amp&quot;</span><span class="p">,</span>       <span class="mh">0x5c</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Back Surr Volume&quot;</span><span class="p">,</span>    <span class="mh">0x5e</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Back Surr Switch&quot;</span><span class="p">,</span>    <span class="mh">0x5e</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>         <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Speaker Jack Mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>          <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>         <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Line Jack Mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>          <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>         <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Mic Jack Mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>          <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_UAJ_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">2</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>         <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Aux Jack Mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>          <span class="o">=</span> <span class="n">snd_ac97_vt1618_aux_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_aux_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>           <span class="o">=</span> <span class="n">snd_ac97_vt1618_aux_put</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1618</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_vt1618</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_vt1618</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">it2646_update_jacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* shared Line-In / Surround Out */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
			     <span class="n">is_shared_surrout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* shared Mic / Center/LFE Out */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
			     <span class="n">is_shared_clfeout</span><span class="p">(</span><span class="n">ac97</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_it2646</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SURROUND_JACK_MODE_CTL</span><span class="p">,</span>
	<span class="n">AC97_CHANNEL_MODE_CTL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_spdif_controls_it2646</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Analog to IEC958 Output&quot;</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;IEC958 Input Monitor&quot;</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_it2646_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_controls_it2646</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_it2646</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">patch_build_controls</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">snd_ac97_spdif_controls_it2646</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_spdif_controls_it2646</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_it2646_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_it2646_specific</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_jacks</span> <span class="o">=</span> <span class="n">it2646_update_jacks</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_it2646</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_it2646_ops</span><span class="p">;</span>
	<span class="cm">/* full DAC volume */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Si3036 codec</span>
<span class="cm"> */</span>

<span class="cp">#define AC97_SI3036_CHIP_ID     0x5a</span>
<span class="cp">#define AC97_SI3036_LINE_CFG    0x5c</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_si3036</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">AC97_DOUBLE</span><span class="p">(</span><span class="s">&quot;Modem Speaker Volume&quot;</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_si3036_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_si3036</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_si3036</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_si3036_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_si3036_specific</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpatch_si3036</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_si3036_ops</span><span class="p">;</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xf210</span> <span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LM 4550 Codec</span>
<span class="cm"> *</span>
<span class="cm"> * We use a static resolution table since LM4550 codec cannot be</span>
<span class="cm"> * properly autoprobed to determine the resolution via</span>
<span class="cm"> * check_volume_resolution().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_res_table</span> <span class="n">lm4550_restbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mh">0x001f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mh">0x001f</span> <span class="p">},</span>	<span class="cm">/* LSB is ignored */</span>
	<span class="p">{</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mh">0x001f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mh">0x001f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mh">0x1f1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x0f0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_lm4550</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">res_table</span> <span class="o">=</span> <span class="n">lm4550_restbl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> *  UCB1400 codec (http://www.semiconductors.philips.com/acrobat_download/datasheets/UCB1400-02.pdf)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ac97_controls_ucb1400</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* enable/disable headphone driver which allows direct connection to</span>
<span class="cm">   stereo headphone without the use of external DC blocking</span>
<span class="cm">   capacitors */</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Driver&quot;</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cm">/* Filter used to compensate the DC offset is added in the ADC to remove idle</span>
<span class="cm">   tones from the audio band. */</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;DC Filter&quot;</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cm">/* Control smart-low-power mode feature. Allows automatic power down</span>
<span class="cm">   of unused blocks in the ADC analog front end and the PLL. */</span>
<span class="n">AC97_SINGLE</span><span class="p">(</span><span class="s">&quot;Smart Low Power Mode&quot;</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ucb1400_specific</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ac97_controls_ucb1400</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ac97_controls_ucb1400</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ac97</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_ac97_build_ops</span> <span class="n">patch_ucb1400_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_specific</span>	<span class="o">=</span> <span class="n">patch_ucb1400_specific</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ucb1400</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ac97</span><span class="o">-&gt;</span><span class="n">build_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch_ucb1400_ops</span><span class="p">;</span>
	<span class="cm">/* enable headphone driver and smart low power mode by default */</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">);</span>
	<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
