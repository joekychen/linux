<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › hda › patch_ca0132.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>patch_ca0132.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HD audio interface patch for Creative CA0132 chip</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011, Creative Technology Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on patch_ca0110.c</span>
<span class="cm"> * Copyright (c) 2008 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &quot;hda_codec.h&quot;</span>
<span class="cp">#include &quot;hda_local.h&quot;</span>
<span class="cp">#include &quot;hda_auto_parser.h&quot;</span>

<span class="cp">#define WIDGET_CHIP_CTRL      0x15</span>
<span class="cp">#define WIDGET_DSP_CTRL       0x16</span>

<span class="cp">#define WUH_MEM_CONNID        10</span>
<span class="cp">#define DSP_MEM_CONNID        16</span>

<span class="k">enum</span> <span class="n">hda_cmd_vendor_io</span> <span class="p">{</span>
	<span class="cm">/* for DspIO node */</span>
	<span class="n">VENDOR_DSPIO_SCP_WRITE_DATA_LOW</span>      <span class="o">=</span> <span class="mh">0x000</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_SCP_WRITE_DATA_HIGH</span>     <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>

	<span class="n">VENDOR_DSPIO_STATUS</span>                  <span class="o">=</span> <span class="mh">0xF01</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_SCP_POST_READ_DATA</span>      <span class="o">=</span> <span class="mh">0x702</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_SCP_READ_DATA</span>           <span class="o">=</span> <span class="mh">0xF02</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_DSP_INIT</span>                <span class="o">=</span> <span class="mh">0x703</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_SCP_POST_COUNT_QUERY</span>    <span class="o">=</span> <span class="mh">0x704</span><span class="p">,</span>
	<span class="n">VENDOR_DSPIO_SCP_READ_COUNT</span>          <span class="o">=</span> <span class="mh">0xF04</span><span class="p">,</span>

	<span class="cm">/* for ChipIO node */</span>
	<span class="n">VENDOR_CHIPIO_ADDRESS_LOW</span>            <span class="o">=</span> <span class="mh">0x000</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_ADDRESS_HIGH</span>           <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_STREAM_FORMAT</span>          <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_DATA_LOW</span>               <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_DATA_HIGH</span>              <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>

	<span class="n">VENDOR_CHIPIO_GET_PARAMETER</span>          <span class="o">=</span> <span class="mh">0xF00</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_STATUS</span>                 <span class="o">=</span> <span class="mh">0xF01</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_HIC_POST_READ</span>          <span class="o">=</span> <span class="mh">0x702</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_HIC_READ_DATA</span>          <span class="o">=</span> <span class="mh">0xF03</span><span class="p">,</span>

	<span class="n">VENDOR_CHIPIO_CT_EXTENSIONS_ENABLE</span>   <span class="o">=</span> <span class="mh">0x70A</span><span class="p">,</span>

	<span class="n">VENDOR_CHIPIO_PLL_PMU_WRITE</span>          <span class="o">=</span> <span class="mh">0x70C</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PLL_PMU_READ</span>           <span class="o">=</span> <span class="mh">0xF0C</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_8051_ADDRESS_LOW</span>       <span class="o">=</span> <span class="mh">0x70D</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_8051_ADDRESS_HIGH</span>      <span class="o">=</span> <span class="mh">0x70E</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_FLAG_SET</span>               <span class="o">=</span> <span class="mh">0x70F</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_FLAGS_GET</span>              <span class="o">=</span> <span class="mh">0xF0F</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PARAMETER_SET</span>          <span class="o">=</span> <span class="mh">0x710</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PARAMETER_GET</span>          <span class="o">=</span> <span class="mh">0xF10</span><span class="p">,</span>

	<span class="n">VENDOR_CHIPIO_PORT_ALLOC_CONFIG_SET</span>  <span class="o">=</span> <span class="mh">0x711</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PORT_ALLOC_SET</span>         <span class="o">=</span> <span class="mh">0x712</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PORT_ALLOC_GET</span>         <span class="o">=</span> <span class="mh">0xF12</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PORT_FREE_SET</span>          <span class="o">=</span> <span class="mh">0x713</span><span class="p">,</span>

	<span class="n">VENDOR_CHIPIO_PARAMETER_EX_ID_GET</span>    <span class="o">=</span> <span class="mh">0xF17</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PARAMETER_EX_ID_SET</span>    <span class="o">=</span> <span class="mh">0x717</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PARAMETER_EX_VALUE_GET</span> <span class="o">=</span> <span class="mh">0xF18</span><span class="p">,</span>
	<span class="n">VENDOR_CHIPIO_PARAMETER_EX_VALUE_SET</span> <span class="o">=</span> <span class="mh">0x718</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Control flag IDs</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">control_flag_id</span> <span class="p">{</span>
	<span class="cm">/* Connection manager stream setup is bypassed/enabled */</span>
	<span class="n">CONTROL_FLAG_C_MGR</span>                  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* DSP DMA is bypassed/enabled */</span>
	<span class="n">CONTROL_FLAG_DMA</span>                    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* 8051 &#39;idle&#39; mode is disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_IDLE_ENABLE</span>            <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* Tracker for the SPDIF-in path is bypassed/enabled */</span>
	<span class="n">CONTROL_FLAG_TRACKER</span>                <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="cm">/* DigitalOut to Spdif2Out connection is disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_SPDIF2OUT</span>              <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="cm">/* Digital Microphone is disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_DMIC</span>                   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="cm">/* ADC_B rate is 48 kHz/96 kHz */</span>
	<span class="n">CONTROL_FLAG_ADC_B_96KHZ</span>            <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="cm">/* ADC_C rate is 48 kHz/96 kHz */</span>
	<span class="n">CONTROL_FLAG_ADC_C_96KHZ</span>            <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="cm">/* DAC rate is 48 kHz/96 kHz (affects all DACs) */</span>
	<span class="n">CONTROL_FLAG_DAC_96KHZ</span>              <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="cm">/* DSP rate is 48 kHz/96 kHz */</span>
	<span class="n">CONTROL_FLAG_DSP_96KHZ</span>              <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="cm">/* SRC clock is 98 MHz/196 MHz (196 MHz forces rate to 96 KHz) */</span>
	<span class="n">CONTROL_FLAG_SRC_CLOCK_196MHZ</span>       <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="cm">/* SRC rate is 48 kHz/96 kHz (48 kHz disabled when clock is 196 MHz) */</span>
	<span class="n">CONTROL_FLAG_SRC_RATE_96KHZ</span>         <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="cm">/* Decode Loop (DSP-&gt;SRC-&gt;DSP) is disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_DECODE_LOOP</span>            <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="cm">/* De-emphasis filter on DAC-1 disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_DAC1_DEEMPHASIS</span>        <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="cm">/* De-emphasis filter on DAC-2 disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_DAC2_DEEMPHASIS</span>        <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="cm">/* De-emphasis filter on DAC-3 disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_DAC3_DEEMPHASIS</span>        <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="cm">/* High-pass filter on ADC_B disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_ADC_B_HIGH_PASS</span>        <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="cm">/* High-pass filter on ADC_C disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_ADC_C_HIGH_PASS</span>        <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
	<span class="cm">/* Common mode on Port_A disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_PORT_A_COMMON_MODE</span>     <span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
	<span class="cm">/* Common mode on Port_D disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_PORT_D_COMMON_MODE</span>     <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	<span class="cm">/* Impedance for ramp generator on Port_A 16 Ohm/10K Ohm */</span>
	<span class="n">CONTROL_FLAG_PORT_A_10KOHM_LOAD</span>     <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="cm">/* Impedance for ramp generator on Port_D, 16 Ohm/10K Ohm */</span>
	<span class="n">CONTROL_FLAG_PORT_D_10K0HM_LOAD</span>     <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
	<span class="cm">/* ASI rate is 48kHz/96kHz */</span>
	<span class="n">CONTROL_FLAG_ASI_96KHZ</span>              <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
	<span class="cm">/* DAC power settings able to control attached ports no/yes */</span>
	<span class="n">CONTROL_FLAG_DACS_CONTROL_PORTS</span>     <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
	<span class="cm">/* Clock Stop OK reporting is disabled/enabled */</span>
	<span class="n">CONTROL_FLAG_CONTROL_STOP_OK_ENABLE</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="cm">/* Number of control flags */</span>
	<span class="n">CONTROL_FLAGS_MAX</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_FLAG_CONTROL_STOP_OK_ENABLE</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Control parameter IDs</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">control_parameter_id</span> <span class="p">{</span>
	<span class="cm">/* 0: force HDA, 1: allow DSP if HDA Spdif1Out stream is idle */</span>
	<span class="n">CONTROL_PARAM_SPDIF1_SOURCE</span>            <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="cm">/* Stream Control */</span>

	<span class="cm">/* Select stream with the given ID */</span>
	<span class="n">CONTROL_PARAM_STREAM_ID</span>                <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="cm">/* Source connection point for the selected stream */</span>
	<span class="n">CONTROL_PARAM_STREAM_SOURCE_CONN_POINT</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
	<span class="cm">/* Destination connection point for the selected stream */</span>
	<span class="n">CONTROL_PARAM_STREAM_DEST_CONN_POINT</span>   <span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="cm">/* Number of audio channels in the selected stream */</span>
	<span class="n">CONTROL_PARAM_STREAMS_CHANNELS</span>         <span class="o">=</span> <span class="mi">27</span><span class="p">,</span>
	<span class="cm">/*Enable control for the selected stream */</span>
	<span class="n">CONTROL_PARAM_STREAM_CONTROL</span>           <span class="o">=</span> <span class="mi">28</span><span class="p">,</span>

	<span class="cm">/* Connection Point Control */</span>

	<span class="cm">/* Select connection point with the given ID */</span>
	<span class="n">CONTROL_PARAM_CONN_POINT_ID</span>            <span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
	<span class="cm">/* Connection point sample rate */</span>
	<span class="n">CONTROL_PARAM_CONN_POINT_SAMPLE_RATE</span>   <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>

	<span class="cm">/* Node Control */</span>

	<span class="cm">/* Select HDA node with the given ID */</span>
	<span class="n">CONTROL_PARAM_NODE_ID</span>                  <span class="o">=</span> <span class="mi">31</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Dsp Io Status codes</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">hda_vendor_status_dspio</span> <span class="p">{</span>
	<span class="cm">/* Success */</span>
	<span class="n">VENDOR_STATUS_DSPIO_OK</span>                       <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="cm">/* Busy, unable to accept new command, the host must retry */</span>
	<span class="n">VENDOR_STATUS_DSPIO_BUSY</span>                     <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="cm">/* SCP command queue is full */</span>
	<span class="n">VENDOR_STATUS_DSPIO_SCP_COMMAND_QUEUE_FULL</span>   <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="cm">/* SCP response queue is empty */</span>
	<span class="n">VENDOR_STATUS_DSPIO_SCP_RESPONSE_QUEUE_EMPTY</span> <span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Chip Io Status codes</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">hda_vendor_status_chipio</span> <span class="p">{</span>
	<span class="cm">/* Success */</span>
	<span class="n">VENDOR_STATUS_CHIPIO_OK</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="cm">/* Busy, unable to accept new command, the host must retry */</span>
	<span class="n">VENDOR_STATUS_CHIPIO_BUSY</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  CA0132 sample rate</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ca0132_sample_rate</span> <span class="p">{</span>
	<span class="n">SR_6_000</span>        <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">SR_8_000</span>        <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">SR_9_600</span>        <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">SR_11_025</span>       <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">SR_16_000</span>       <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">SR_22_050</span>       <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">SR_24_000</span>       <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">SR_32_000</span>       <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">SR_44_100</span>       <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">SR_48_000</span>       <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">SR_88_200</span>       <span class="o">=</span> <span class="mh">0x0A</span><span class="p">,</span>
	<span class="n">SR_96_000</span>       <span class="o">=</span> <span class="mh">0x0B</span><span class="p">,</span>
	<span class="n">SR_144_000</span>      <span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>
	<span class="n">SR_176_400</span>      <span class="o">=</span> <span class="mh">0x0D</span><span class="p">,</span>
	<span class="n">SR_192_000</span>      <span class="o">=</span> <span class="mh">0x0E</span><span class="p">,</span>
	<span class="n">SR_384_000</span>      <span class="o">=</span> <span class="mh">0x0F</span><span class="p">,</span>

	<span class="n">SR_COUNT</span>        <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

	<span class="n">SR_RATE_UNKNOWN</span> <span class="o">=</span> <span class="mh">0x1F</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Scp Helper function</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">get_set</span> <span class="p">{</span>
	<span class="n">IS_SET</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IS_GET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Duplicated from ca0110 codec</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_OUT_AMP</span><span class="p">)</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
					    <span class="n">AMP_OUT_UNMUTE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dac</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">AMP_OUT_ZERO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">adc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">PIN_IN</span> <span class="o">|</span>
				    <span class="n">snd_hda_get_default_vref</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_IN_AMP</span><span class="p">)</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
					    <span class="n">AMP_IN_UNMUTE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adc</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">adc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
				    <span class="n">AMP_IN_UNMUTE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirstr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Capture&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_add_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">namestr</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">HDA_INPUT</span> <span class="o">:</span> <span class="n">HDA_OUTPUT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_MUTE_MONO</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="s">&quot;%s %s Switch&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">dirstr</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_add_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">namestr</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">HDA_INPUT</span> <span class="o">:</span> <span class="n">HDA_OUTPUT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_VOLUME_MONO</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="s">&quot;%s %s Volume&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">dirstr</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define add_out_switch(codec, nid, pfx) _add_switch(codec, nid, pfx, 3, 0)</span>
<span class="cp">#define add_out_volume(codec, nid, pfx) _add_volume(codec, nid, pfx, 3, 0)</span>
<span class="cp">#define add_in_switch(codec, nid, pfx) _add_switch(codec, nid, pfx, 3, 1)</span>
<span class="cp">#define add_in_volume(codec, nid, pfx) _add_volume(codec, nid, pfx, 3, 1)</span>
<span class="cp">#define add_mono_switch(codec, nid, pfx, chan) \</span>
<span class="cp">	_add_switch(codec, nid, pfx, chan, 0)</span>
<span class="cp">#define add_mono_volume(codec, nid, pfx, chan) \</span>
<span class="cp">	_add_volume(codec, nid, pfx, chan, 0)</span>
<span class="cp">#define add_in_mono_switch(codec, nid, pfx, chan) \</span>
<span class="cp">	_add_switch(codec, nid, pfx, chan, 1)</span>
<span class="cp">#define add_in_mono_volume(codec, nid, pfx, chan) \</span>
<span class="cp">	_add_volume(codec, nid, pfx, chan, 1)</span>


<span class="cm">/*</span>
<span class="cm"> * CA0132 specific</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_multi_out</span> <span class="n">multiout</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">out_pins</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_OUTS</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">dacs</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_OUTS</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">hp_dac</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">input_pins</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">adcs</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">dig_out</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">dig_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">curr_hp_switch</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">curr_speaker_switch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">chipio_mutex</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input_labels</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="n">pcm_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* PCM information */</span>
<span class="p">};</span>

<span class="cm">/* Chip access helper function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="cm">/* send bits of data specified by reg */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WIDGET_CHIP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">VENDOR_STATUS_CHIPIO_OK</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write chip address through the vendor widget -- NOT protected by the Mutex!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_write_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_addx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* send low 16 bits of the address */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_ADDRESS_LOW</span><span class="p">,</span>
			  <span class="n">chip_addx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send high 16 bits of the address */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_ADDRESS_HIGH</span><span class="p">,</span>
				  <span class="n">chip_addx</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write data through the vendor widget -- NOT protected by the Mutex!</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* send low 16 bits of the data */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_DATA_LOW</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send high 16 bits of the data */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_DATA_HIGH</span><span class="p">,</span>
				  <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read data through the vendor widget -- NOT protected by the Mutex!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* post read */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_HIC_POST_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read status */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">chipio_send</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VENDOR_CHIPIO_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read data */</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WIDGET_CHIP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">VENDOR_CHIPIO_HIC_READ_DATA</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write given value to the given address through the chip I/O widget.</span>
<span class="cm"> * protected by the Mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_addx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">chipio_mutex</span><span class="p">);</span>

	<span class="cm">/* write the address, and if successful proceed to write data */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write_address</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">chip_addx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write_data</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">chipio_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the given address through the chip I/O widget</span>
<span class="cm"> * protected by the Mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_addx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">chipio_mutex</span><span class="p">);</span>

	<span class="cm">/* write the address, and if successful proceed to write data */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write_address</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">chip_addx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_read_data</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">chipio_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCM stuffs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_setup_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">stream_tag</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">channel_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;ca0132_setup_stream: &quot;</span>
		<span class="s">&quot;NID=0x%x, stream=0x%x, channel=%d, format=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nid</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="cm">/* update the format-id if changed */</span>
	<span class="n">oldval</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_GET_STREAM_FORMAT</span><span class="p">,</span>
				    <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldval</span> <span class="o">!=</span> <span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_STREAM_FORMAT</span><span class="p">,</span>
				    <span class="n">format</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">oldval</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_CONV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">newval</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">channel_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldval</span> <span class="o">!=</span> <span class="n">newval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span>
				    <span class="n">newval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_cleanup_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_STREAM_FORMAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCM callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Digital out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_dig_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_dig_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analog capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_capture_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">],</span>
			     <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_capture_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Digital capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_dig_capture_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_dig_capture_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">ca0132_pcm_analog_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ca0132_playback_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ca0132_playback_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">ca0132_pcm_analog_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ca0132_capture_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ca0132_capture_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">ca0132_pcm_digital_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ca0132_dig_playback_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ca0132_dig_playback_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">ca0132_pcm_digital_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ca0132_dig_capture_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ca0132_dig_capture_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CA0132 Analog&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca0132_pcm_analog_playback</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">channels_max</span> <span class="o">=</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca0132_pcm_analog_capture</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substreams</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">++</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CA0132 Digital&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">HDA_PCM_TYPE_SPDIF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ca0132_pcm_digital_playback</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ca0132_pcm_digital_capture</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define REG_CODEC_MUTE		0x18b014</span>
<span class="cp">#define REG_CODEC_HP_VOL_L	0x18b070</span>
<span class="cp">#define REG_CODEC_HP_VOL_R	0x18b074</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_hp_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_switch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_hp_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* any change? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_switch</span> <span class="o">==</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_hda_power_up</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_MUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* *valp 0 is mute, 1 is unmute */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_MUTE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_switch</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>

 <span class="nl">exit:</span>
	<span class="n">snd_hda_power_down</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_speaker_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_speaker_switch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_speaker_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* any change? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_speaker_switch</span> <span class="o">==</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_hda_power_up</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_MUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* *valp 0 is mute, 1 is unmute */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">valp</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_MUTE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_speaker_switch</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>

 <span class="nl">exit:</span>
	<span class="n">snd_hda_power_down</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_hp_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="o">*</span><span class="n">valp</span><span class="o">++</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_hp_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">left_vol</span><span class="p">,</span> <span class="n">right_vol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">left_vol</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="o">++</span><span class="p">;</span>
	<span class="n">right_vol</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>

	<span class="cm">/* any change? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">left_vol</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">right_vol</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_hda_power_up</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_HP_VOL_L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">left_vol</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_HP_VOL_L</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">right_vol</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">chipio_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">REG_CODEC_HP_VOL_R</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_vol</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">curr_hp_volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_vol</span><span class="p">;</span>

 <span class="nl">exit:</span>
	<span class="n">snd_hda_power_down</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_hp_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_MUTE_MONO</span><span class="p">(</span><span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span>
				     <span class="n">nid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">ca0132_hp_switch_get</span><span class="p">;</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">ca0132_hp_switch_put</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_hp_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_VOLUME_MONO</span><span class="p">(</span><span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span>
				       <span class="n">nid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">ca0132_hp_volume_get</span><span class="p">;</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">ca0132_hp_volume_put</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_speaker_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_MUTE_MONO</span><span class="p">(</span><span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span>
				     <span class="n">nid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">ca0132_speaker_switch_get</span><span class="p">;</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">ca0132_speaker_switch_put</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_fix_hp_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>

	<span class="cm">/* set mute-capable, 1db step, 32 steps, ofs 6 */</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="mh">0x80031f06</span><span class="p">;</span>
	<span class="n">snd_hda_override_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">caps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_speaker_switch</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca0132_fix_hp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_hp_switch</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_hp_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_labels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">add_in_switch</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_in_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">AUTO_PIN_MIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* add Mic-Boost */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">add_in_mono_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="s">&quot;Mic Boost&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">,</span>
						    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_out_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_in_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_in_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_set_ct_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set Creative extension */</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SET CREATIVE EXTENSION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WIDGET_CHIP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">VENDOR_CHIPIO_CT_EXTENSIONS_ENABLE</span><span class="p">,</span>
			    <span class="n">enable</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>

	<span class="cm">/* line-outs */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span> <span class="cm">/* front */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_type</span> <span class="o">=</span> <span class="n">AUTO_PIN_LINE_OUT</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* headphone */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* inputs */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* Mic-in and line-in */</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pin</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUTO_PIN_MIC</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pin</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUTO_PIN_LINE_IN</span><span class="p">;</span>

	<span class="cm">/* Mic-in */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Mic-In&quot;</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="cm">/* Line-In */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_pins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Line-In&quot;</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">chipio_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_exit_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* put any chip cleanup stuffs here. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ca0132_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac</span><span class="p">);</span>
	<span class="n">init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_out</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">init_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_in_pin</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">);</span>

	<span class="n">ca0132_set_ct_ext</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ca0132_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ca0132_set_ct_ext</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ca0132_exit_chip</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">ca0132_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">ca0132_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">ca0132_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ca0132_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">ca0132_free</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_ca0132</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca0132_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;patch_ca0132</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">ca0132_init_chip</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">ca0132_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">ca0132_patch_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * patch entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_preset</span> <span class="n">snd_hda_preset_ca0132</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11020011</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CA0132&quot;</span><span class="p">,</span>     <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_ca0132</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:11020011&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Creative CA0132, CA0132 HD-audio codec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_preset_list</span> <span class="n">ca0132_list</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">snd_hda_preset_ca0132</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">patch_ca0132_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_hda_add_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca0132_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">patch_ca0132_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_delete_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca0132_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">patch_ca0132_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">patch_ca0132_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
