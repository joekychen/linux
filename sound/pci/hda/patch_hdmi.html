<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › hda › patch_hdmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>patch_hdmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  patch_hdmi.c - routines for HDMI/DisplayPort codecs</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright(c) 2008-2010 Intel Corporation. All rights reserved.</span>
<span class="cm"> *  Copyright (c) 2006 ATI Technologies Inc.</span>
<span class="cm"> *  Copyright (c) 2008 NVIDIA Corp.  All rights reserved.</span>
<span class="cm"> *  Copyright (c) 2008 Wei Ni &lt;wni@nvidia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors:</span>
<span class="cm"> *			Wu Fengguang &lt;wfg@linux.intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Maintained by:</span>
<span class="cm"> *			Wu Fengguang &lt;wfg@linux.intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> *  Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> *  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> *  Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/jack.h&gt;</span>
<span class="cp">#include &quot;hda_codec.h&quot;</span>
<span class="cp">#include &quot;hda_local.h&quot;</span>
<span class="cp">#include &quot;hda_jack.h&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">static_hdmi_pcm</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">static_hdmi_pcm</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">static_hdmi_pcm</span><span class="p">,</span> <span class="s">&quot;Don&#39;t restrict PCM parameters per ELD info&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The HDMI/DisplayPort configuration can be highly dynamic. A graphics device</span>
<span class="cm"> * could support N independent pipes, each of them can be connected to one or</span>
<span class="cm"> * more ports (DVI, HDMI or DisplayPort).</span>
<span class="cm"> *</span>
<span class="cm"> * The HDA correspondence of pipes/ports are converter/pin nodes.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_HDMI_CVTS	8</span>
<span class="cp">#define MAX_HDMI_PINS	8</span>

<span class="k">struct</span> <span class="n">hdmi_spec_per_cvt</span> <span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">assigned</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels_min</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rates</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">formats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxbps</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_mux_nids</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">mux_nids</span><span class="p">[</span><span class="n">HDA_MAX_CONNECTIONS</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="n">sink_eld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">repoll_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_cvts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_cvt</span> <span class="n">cvts</span><span class="p">[</span><span class="n">MAX_HDMI_CVTS</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">num_pins</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="n">pins</span><span class="p">[</span><span class="n">MAX_HDMI_PINS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="n">pcm_rec</span><span class="p">[</span><span class="n">MAX_HDMI_PINS</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Non-generic ATI/NVIDIA specific</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">hda_multi_out</span> <span class="n">multiout</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">pcm_playback</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">hdmi_audio_infoframe</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* 0x84 */</span>
	<span class="n">u8</span> <span class="n">ver</span><span class="p">;</span>  <span class="cm">/* 0x01 */</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>  <span class="cm">/* 0x0a */</span>

	<span class="n">u8</span> <span class="n">checksum</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">CC02_CT47</span><span class="p">;</span>	<span class="cm">/* CC in bits 0:2, CT in 4:7 */</span>
	<span class="n">u8</span> <span class="n">SS01_SF24</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CXT04</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CA</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">LFEPBL01_LSV36_DM_INH7</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dp_audio_infoframe</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* 0x84 */</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>  <span class="cm">/* 0x1b */</span>
	<span class="n">u8</span> <span class="n">ver</span><span class="p">;</span>  <span class="cm">/* 0x11 &lt;&lt; 2 */</span>

	<span class="n">u8</span> <span class="n">CC02_CT47</span><span class="p">;</span>	<span class="cm">/* match with HDMI infoframe from this on */</span>
	<span class="n">u8</span> <span class="n">SS01_SF24</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CXT04</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CA</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">LFEPBL01_LSV36_DM_INH7</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">audio_infoframe</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_audio_infoframe</span> <span class="n">hdmi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dp_audio_infoframe</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * CEA speaker placement:</span>
<span class="cm"> *</span>
<span class="cm"> *        FLH       FCH        FRH</span>
<span class="cm"> *  FLW    FL  FLC   FC   FRC   FR   FRW</span>
<span class="cm"> *</span>
<span class="cm"> *                                  LFE</span>
<span class="cm"> *                     TC</span>
<span class="cm"> *</span>
<span class="cm"> *          RL  RLC   RC   RRC   RR</span>
<span class="cm"> *</span>
<span class="cm"> * The Left/Right Surround channel _notions_ LS/RS in SMPTE 320M corresponds to</span>
<span class="cm"> * CEA RL/RR; The SMPTE channel _assignment_ C/LFE is swapped to CEA LFE/FC.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">cea_speaker_placement</span> <span class="p">{</span>
	<span class="n">FL</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* Front Left           */</span>
	<span class="n">FC</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* Front Center         */</span>
	<span class="n">FR</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* Front Right          */</span>
	<span class="n">FLC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* Front Left Center    */</span>
	<span class="n">FRC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* Front Right Center   */</span>
	<span class="n">RL</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* Rear Left            */</span>
	<span class="n">RC</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* Rear Center          */</span>
	<span class="n">RR</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">7</span><span class="p">),</span>	<span class="cm">/* Rear Right           */</span>
	<span class="n">RLC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">),</span>	<span class="cm">/* Rear Left Center     */</span>
	<span class="n">RRC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">9</span><span class="p">),</span>	<span class="cm">/* Rear Right Center    */</span>
	<span class="n">LFE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span>	<span class="cm">/* Low Frequency Effect */</span>
	<span class="n">FLW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span>	<span class="cm">/* Front Left Wide      */</span>
	<span class="n">FRW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>	<span class="cm">/* Front Right Wide     */</span>
	<span class="n">FLH</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span>	<span class="cm">/* Front Left High      */</span>
	<span class="n">FCH</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>	<span class="cm">/* Front Center High    */</span>
	<span class="n">FRH</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span>	<span class="cm">/* Front Right High     */</span>
	<span class="n">TC</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>	<span class="cm">/* Top Center           */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ELD SA bits in the CEA Speaker Allocation data block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eld_speaker_allocation_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FL</span> <span class="o">|</span> <span class="n">FR</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LFE</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FC</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RL</span> <span class="o">|</span> <span class="n">RR</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">RC</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLC</span> <span class="o">|</span> <span class="n">FRC</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">RLC</span> <span class="o">|</span> <span class="n">RRC</span><span class="p">,</span>
	<span class="cm">/* the following are not defined in ELD yet */</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLW</span> <span class="o">|</span> <span class="n">FRW</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLH</span> <span class="o">|</span> <span class="n">FRH</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">FCH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cea_channel_speaker_allocation</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ca_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speakers</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* derived values, just for convenience */</span>
	<span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spk_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA sequence is:</span>
<span class="cm"> *</span>
<span class="cm"> *       surround40   surround41   surround50   surround51   surround71</span>
<span class="cm"> * ch0   front left   =            =            =            =</span>
<span class="cm"> * ch1   front right  =            =            =            =</span>
<span class="cm"> * ch2   rear left    =            =            =            =</span>
<span class="cm"> * ch3   rear right   =            =            =            =</span>
<span class="cm"> * ch4                LFE          center       center       center</span>
<span class="cm"> * ch5                                          LFE          LFE</span>
<span class="cm"> * ch6                                                       side left</span>
<span class="cm"> * ch7                                                       side right</span>
<span class="cm"> *</span>
<span class="cm"> * surround71 = {FL, FR, RLC, RRC, FC, LFE, RL, RR}</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdmi_channel_mapping</span><span class="p">[</span><span class="mh">0x32</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* stereo */</span>
	<span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* 2.1 */</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* Dolby Surround */</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* surround40 */</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* 4ch */</span>
	<span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* surround41 */</span>
	<span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* surround50 */</span>
	<span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* surround51 */</span>
	<span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="cm">/* 7.1 */</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x75</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is an ordered list!</span>
<span class="cm"> *</span>
<span class="cm"> * The preceding ones have better chances to be selected by</span>
<span class="cm"> * hdmi_channel_allocation().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cea_channel_speaker_allocation</span> <span class="n">channel_allocations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*			  channel:   7     6    5    4    3     2    1    0  */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* 2.1 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* Dolby Surround */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* surround40 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* surround41 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* surround50 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* surround51 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* 6.1 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
				 <span class="cm">/* surround71 */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RRC</span><span class="p">,</span>  <span class="n">RLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>

<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RRC</span><span class="p">,</span>  <span class="n">RLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RRC</span><span class="p">,</span>  <span class="n">RLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RRC</span><span class="p">,</span>  <span class="n">RLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">RC</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRC</span><span class="p">,</span>  <span class="n">FLC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FCH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">FCH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRH</span><span class="p">,</span>  <span class="n">FLH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRH</span><span class="p">,</span>  <span class="n">FLH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRW</span><span class="p">,</span>  <span class="n">FLW</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x27</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRW</span><span class="p">,</span>  <span class="n">FLW</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FCH</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2b</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FCH</span><span class="p">,</span>   <span class="n">RC</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>  <span class="n">FCH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2d</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">TC</span><span class="p">,</span>  <span class="n">FCH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRH</span><span class="p">,</span>  <span class="n">FLH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRH</span><span class="p">,</span>  <span class="n">FLH</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRW</span><span class="p">,</span>  <span class="n">FLW</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">ca_index</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>  <span class="p">.</span><span class="n">speakers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FRW</span><span class="p">,</span>  <span class="n">FLW</span><span class="p">,</span>  <span class="n">RR</span><span class="p">,</span>  <span class="n">RL</span><span class="p">,</span>  <span class="n">FC</span><span class="p">,</span>  <span class="n">LFE</span><span class="p">,</span>  <span class="n">FR</span><span class="p">,</span>  <span class="n">FL</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * HDMI routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pin_nid_to_pin_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">pin_nid</span> <span class="o">==</span> <span class="n">pin_nid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDMI: pin nid %d not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hinfo_to_pin_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">hinfo</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDMI: hinfo %p not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cvt_nid_to_cvt_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cvt_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cvt_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cvt_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="p">;</span> <span class="n">cvt_idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">cvt_idx</span><span class="p">].</span><span class="n">cvt_nid</span> <span class="o">==</span> <span class="n">cvt_nid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cvt_idx</span><span class="p">;</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDMI: cvt nid %d not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_eld_ctl_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BYTES</span><span class="p">;</span>

	<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">sink_eld</span><span class="p">.</span><span class="n">eld_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_eld_ctl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">sink_eld</span><span class="p">.</span><span class="n">eld_buffer</span><span class="p">,</span> <span class="n">ELD_MAX_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">eld_bytes_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_VOLATILE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ELD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">hdmi_eld_ctl_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">hdmi_eld_ctl_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_create_eld_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_idx</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eld_bytes_ctl</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">pin_idx</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">pin_nid</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef BE_PARANOID</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_get_dip_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">packet_index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">byte_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">AC_VERB_GET_HDMI_DIP_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">packet_index</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="o">*</span><span class="n">byte_index</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_set_dip_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">packet_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet_index</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte_index</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_HDMI_DIP_INDEX</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_write_dip_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_HDMI_DIP_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_init_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unmute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_OUT_AMP</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">AMP_OUT_UNMUTE</span><span class="p">);</span>
	<span class="cm">/* Disable pin out until stream is active*/</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_get_channel_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">AC_VERB_GET_CVT_CHAN_COUNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_set_channel_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chs</span> <span class="o">!=</span> <span class="n">hdmi_get_channel_count</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">))</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_CVT_CHAN_COUNT</span><span class="p">,</span> <span class="n">chs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Channel mapping routines</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Compute derived values in channel_allocations[].</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_channel_allocations</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cea_channel_speaker_allocation</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_allocations</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">channel_allocations</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">spk_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">speakers</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">speakers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">++</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">spk_mask</span> <span class="o">|=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">speakers</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The transformation takes two steps:</span>
<span class="cm"> *</span>
<span class="cm"> *	eld-&gt;spk_alloc =&gt; (eld_speaker_allocation_bits[]) =&gt; spk_mask</span>
<span class="cm"> *	      spk_mask =&gt; (channel_allocations[])         =&gt; ai-&gt;CA</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: it could select the wrong CA from multiple candidates.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_channel_allocation</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spk_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SND_PRINT_CHANNEL_ALLOCATION_ADVISED_BUFSIZE</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * CA defaults to 0 for basic stereo audio</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * expand ELD&#39;s speaker allocation mask</span>
<span class="cm">	 *</span>
<span class="cm">	 * ELD tells the speaker mask in a compact(paired) form,</span>
<span class="cm">	 * expand ELD&#39;s notions to match the ones used by Audio InfoFrame.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eld_speaker_allocation_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">spk_alloc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">spk_mask</span> <span class="o">|=</span> <span class="n">eld_speaker_allocation_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* search for the first working match in the CA table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_allocations</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="n">channel_allocations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channels</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">spk_mask</span> <span class="o">&amp;</span> <span class="n">channel_allocations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spk_mask</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">channel_allocations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spk_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ca</span> <span class="o">=</span> <span class="n">channel_allocations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ca_index</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_print_channel_allocation</span><span class="p">(</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">spk_alloc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;HDMI: select CA 0x%x for %d-channel allocation: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ca</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ca</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_debug_channel_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG_VERBOSE</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">AC_VERB_GET_HDMI_CHAN_SLOT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HDMI: ASP channel %d =&gt; slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">slot</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">slot</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_setup_channel_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_channel_mapping</span><span class="p">[</span><span class="n">ca</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">channel_allocations</span><span class="p">[</span><span class="n">ca</span><span class="p">].</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hdmi_channel_mapping</span><span class="p">[</span><span class="n">ca</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hdmi_channel_mapping</span><span class="p">[</span><span class="n">ca</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">AC_VERB_SET_HDMI_CHAN_SLOT</span><span class="p">,</span>
					  <span class="n">hdmi_channel_mapping</span><span class="p">[</span><span class="n">ca</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				    <span class="s">&quot;HDMI: channel mapping failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hdmi_debug_channel_mapping</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Audio InfoFrame routines</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Enable Audio InfoFrame Transmission</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_start_infoframe_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdmi_set_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_HDMI_DIP_XMIT</span><span class="p">,</span>
						<span class="n">AC_DIPXMIT_BEST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable Audio InfoFrame Transmission</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_stop_infoframe_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				      <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdmi_set_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_HDMI_DIP_XMIT</span><span class="p">,</span>
						<span class="n">AC_DIPXMIT_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_debug_dip_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG_VERBOSE</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">snd_hdmi_get_eld_size</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HDMI: ELD buf size is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">AC_VERB_GET_HDMI_DIP_SIZE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HDMI: DIP GP[%d] buf size is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_clear_dip_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BE_PARANOID</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">,</span> <span class="n">bi</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">AC_VERB_GET_HDMI_DIP_SIZE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hdmi_set_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdmi_write_dip_byte</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">hdmi_get_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dip index %d: %d != %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bi</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* byte index wrapped around */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;HDMI: DIP GP[%d] buf reported size=%d, written=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_checksum_audio_infoframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_audio_infoframe</span> <span class="o">*</span><span class="n">hdmi_ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">hdmi_ai</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdmi_ai</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">-</span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_fill_audio_infoframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				      <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hdmi_debug_dip_size</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="n">hdmi_clear_dip_buffers</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span> <span class="cm">/* be paranoid */</span>

	<span class="n">hdmi_set_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hdmi_write_dip_byte</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">dip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hdmi_infoframe_uptodate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_HDMI_DIP_XMIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
							    <span class="o">!=</span> <span class="n">AC_DIPXMIT_BEST</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">hdmi_set_dip_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">AC_VERB_GET_HDMI_DIP_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">dip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_setup_audio_infoframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_idx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">pin_nid</span> <span class="o">=</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ca</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">audio_infoframe</span> <span class="n">ai</span><span class="p">;</span>

	<span class="n">eld</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">sink_eld</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">monitor_present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ca</span> <span class="o">=</span> <span class="n">hdmi_channel_allocation</span><span class="p">(</span><span class="n">eld</span><span class="p">,</span> <span class="n">channels</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">conn_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* HDMI */</span>
		<span class="k">struct</span> <span class="n">hdmi_audio_infoframe</span> <span class="o">*</span><span class="n">hdmi_ai</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="p">.</span><span class="n">hdmi</span><span class="p">;</span>

		<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">ver</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">len</span>		<span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
		<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">CC02_CT47</span>	<span class="o">=</span> <span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hdmi_ai</span><span class="o">-&gt;</span><span class="n">CA</span>		<span class="o">=</span> <span class="n">ca</span><span class="p">;</span>
		<span class="n">hdmi_checksum_audio_infoframe</span><span class="p">(</span><span class="n">hdmi_ai</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">conn_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DisplayPort */</span>
		<span class="k">struct</span> <span class="n">dp_audio_infoframe</span> <span class="o">*</span><span class="n">dp_ai</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="p">.</span><span class="n">dp</span><span class="p">;</span>

		<span class="n">dp_ai</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="n">dp_ai</span><span class="o">-&gt;</span><span class="n">len</span>		<span class="o">=</span> <span class="mh">0x1b</span><span class="p">;</span>
		<span class="n">dp_ai</span><span class="o">-&gt;</span><span class="n">ver</span>		<span class="o">=</span> <span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dp_ai</span><span class="o">-&gt;</span><span class="n">CC02_CT47</span>	<span class="o">=</span> <span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dp_ai</span><span class="o">-&gt;</span><span class="n">CA</span>		<span class="o">=</span> <span class="n">ca</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;HDMI: unknown connection type at pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pin_nid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * sizeof(ai) is used instead of sizeof(*hdmi_ai) or</span>
<span class="cm">	 * sizeof(*dp_ai) to avoid partial match/update problems when</span>
<span class="cm">	 * the user switches between HDMI/DP monitors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi_infoframe_uptodate</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">ai</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hdmi_setup_audio_infoframe: &quot;</span>
			    <span class="s">&quot;pin=%d channels=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pin_nid</span><span class="p">,</span>
			    <span class="n">channels</span><span class="p">);</span>
		<span class="n">hdmi_setup_channel_mapping</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">ca</span><span class="p">);</span>
		<span class="n">hdmi_stop_infoframe_trans</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
		<span class="n">hdmi_fill_audio_infoframe</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span>
					    <span class="n">ai</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="p">));</span>
		<span class="n">hdmi_start_infoframe_trans</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Unsolicited events</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hdmi_present_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repoll</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_intrinsic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="n">AC_UNSOL_RES_TAG_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_jack_tbl</span> <span class="o">*</span><span class="n">jack</span><span class="p">;</span>

	<span class="n">jack</span> <span class="o">=</span> <span class="n">snd_hda_jack_tbl_get_from_tag</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jack</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pin_nid</span> <span class="o">=</span> <span class="n">jack</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">;</span>
	<span class="n">jack</span><span class="o">-&gt;</span><span class="n">jack_dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">_snd_printd</span><span class="p">(</span><span class="n">SND_PR_VERBOSE</span><span class="p">,</span>
		<span class="s">&quot;HDMI hot plug event: Codec=%d Pin=%d Presence_Detect=%d ELD_Valid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_PD</span><span class="p">),</span> <span class="o">!!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_ELDV</span><span class="p">));</span>

	<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">pin_nid_to_pin_index</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdmi_present_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_non_intrinsic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="n">AC_UNSOL_RES_TAG_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subtag</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_SUBTAG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_UNSOL_RES_SUBTAG_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cp_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_CP_STATE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cp_ready</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_CP_READY</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;HDMI CP event: CODEC=%d PIN=%d SUBTAG=0x%x CP_STATE=%d CP_READY=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		<span class="n">tag</span><span class="p">,</span>
		<span class="n">subtag</span><span class="p">,</span>
		<span class="n">cp_state</span><span class="p">,</span>
		<span class="n">cp_ready</span><span class="p">);</span>

	<span class="cm">/* TODO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp_state</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp_ready</span><span class="p">)</span>
		<span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="n">AC_UNSOL_RES_TAG_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subtag</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">AC_UNSOL_RES_SUBTAG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_UNSOL_RES_SUBTAG_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hda_jack_tbl_get_from_tag</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unexpected HDMI event tag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subtag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hdmi_intrinsic_event</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hdmi_non_intrinsic_event</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callbacks</span>
<span class="cm"> */</span>

<span class="cm">/* HBR should be Non-PCM, 8 channels */</span>
<span class="cp">#define is_hbr_format(format) \</span>
<span class="cp">	((format &amp; AC_FMT_TYPE_NON_PCM) &amp;&amp; (format &amp; AC_FMT_CHAN_MASK) == 7)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_setup_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">,</span>
			      <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pinctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_pinctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_query_pin_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_PINCAP_HBR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pinctl</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_GET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">new_pinctl</span> <span class="o">=</span> <span class="n">pinctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_PINCTL_EPT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_hbr_format</span><span class="p">(</span><span class="n">format</span><span class="p">))</span>
			<span class="n">new_pinctl</span> <span class="o">|=</span> <span class="n">AC_PINCTL_EPT_HBR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_pinctl</span> <span class="o">|=</span> <span class="n">AC_PINCTL_EPT_NATIVE</span><span class="p">;</span>

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hdmi_setup_stream: &quot;</span>
			    <span class="s">&quot;NID=0x%x, %spinctl=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pin_nid</span><span class="p">,</span>
			    <span class="n">pinctl</span> <span class="o">==</span> <span class="n">new_pinctl</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;new-&quot;</span><span class="p">,</span>
			    <span class="n">new_pinctl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pinctl</span> <span class="o">!=</span> <span class="n">new_pinctl</span><span class="p">)</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span>
					    <span class="n">new_pinctl</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_hbr_format</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_pinctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hdmi_setup_stream: HBR is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HDA PCM callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">,</span> <span class="n">cvt_idx</span><span class="p">,</span> <span class="n">mux_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_cvt</span> <span class="o">*</span><span class="n">per_cvt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pinctl</span><span class="p">;</span>

	<span class="cm">/* Validate hinfo */</span>
	<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">hinfo_to_pin_index</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
	<span class="n">eld</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">sink_eld</span><span class="p">;</span>

	<span class="cm">/* Dynamically assign converter to stream */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cvt_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cvt_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="p">;</span> <span class="n">cvt_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">per_cvt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">cvt_idx</span><span class="p">];</span>

		<span class="cm">/* Must not already be assigned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Must be in pin&#39;s mux&#39;s list of converters */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mux_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mux_idx</span> <span class="o">&lt;</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">num_mux_nids</span><span class="p">;</span> <span class="n">mux_idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">mux_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">cvt_nid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Not in mux list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mux_idx</span> <span class="o">==</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">num_mux_nids</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* No free converters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cvt_idx</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Claim converter */</span>
	<span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">assigned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">cvt_nid</span><span class="p">;</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span>
			    <span class="n">mux_idx</span><span class="p">);</span>
	<span class="n">pinctl</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_GET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span>
			    <span class="n">pinctl</span> <span class="o">|</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="n">snd_hda_spdif_ctls_assign</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">,</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">cvt_nid</span><span class="p">);</span>

	<span class="cm">/* Initially set the converter&#39;s capabilities */</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">channels_min</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">channels_max</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">maxbps</span> <span class="o">=</span> <span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">maxbps</span><span class="p">;</span>

	<span class="cm">/* Restrict capabilities by ELD if this isn&#39;t disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_hdmi_pcm</span> <span class="o">&amp;&amp;</span> <span class="n">eld</span><span class="o">-&gt;</span><span class="n">eld_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hdmi_eld_update_pcm_info</span><span class="p">(</span><span class="n">eld</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_min</span> <span class="o">&gt;</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">||</span> <span class="o">!</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Store the updated parameters */</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_min</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">channels_max</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HDA/HDMI auto parsing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_read_pin_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">pin_nid</span> <span class="o">=</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_CONN_LIST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			   <span class="s">&quot;HDMI: pin %d wcaps %#x &quot;</span>
			   <span class="s">&quot;does not support connection list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pin_nid</span><span class="p">,</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">num_mux_nids</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span>
							<span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">,</span>
							<span class="n">HDA_MAX_CONNECTIONS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_present_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repoll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">sink_eld</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">pin_nid</span> <span class="o">=</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Always execute a GetPinSense verb here, even when called from</span>
<span class="cm">	 * hdmi_intrinsic_event; for some NVIDIA HW, the unsolicited</span>
<span class="cm">	 * response&#39;s PD bit is not the real PD value, but indicates that</span>
<span class="cm">	 * the real PD value changed. An older version of the HD-audio</span>
<span class="cm">	 * specification worked this way. Hence, we just ignore the data in</span>
<span class="cm">	 * the unsolicited response to avoid custom WARs.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_pin_sense</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">eld_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">eld</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_eld</span><span class="p">,</span> <span class="n">eld_buffer</span><span class="p">));</span>

	<span class="n">eld</span><span class="o">-&gt;</span><span class="n">monitor_present</span>	<span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">AC_PINSENSE_PRESENCE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eld</span><span class="o">-&gt;</span><span class="n">monitor_present</span><span class="p">)</span>
		<span class="n">eld_valid</span>	<span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">AC_PINSENSE_ELDV</span><span class="p">);</span>

	<span class="n">_snd_printd</span><span class="p">(</span><span class="n">SND_PR_VERBOSE</span><span class="p">,</span>
		<span class="s">&quot;HDMI status: Codec=%d Pin=%d Presence_Detect=%d ELD_Valid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">eld</span><span class="o">-&gt;</span><span class="n">monitor_present</span><span class="p">,</span> <span class="n">eld_valid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eld_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdmi_get_eld</span><span class="p">(</span><span class="n">eld</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">))</span>
			<span class="n">snd_hdmi_show_eld</span><span class="p">(</span><span class="n">eld</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">repoll</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
					   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">300</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_repoll_eld</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span>
	<span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">),</span> <span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">repoll_count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">repoll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdmi_present_sense</span><span class="p">(</span><span class="n">per_pin</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">repoll_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_add_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">,</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">caps</span> <span class="o">=</span> <span class="n">snd_hda_param_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">AC_PAR_PIN_CAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AC_PINCAP_HDMI</span> <span class="o">|</span> <span class="n">AC_PINCAP_DP</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_GET_CONFIG_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_defcfg_connect</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC_JACK_PORT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span> <span class="o">&gt;=</span> <span class="n">MAX_HDMI_PINS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span>
	<span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>

	<span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span> <span class="o">=</span> <span class="n">pin_nid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hdmi_read_pin_conn</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_add_cvt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">cvt_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cvt_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_cvt</span> <span class="o">*</span><span class="n">per_cvt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span> <span class="o">&gt;=</span> <span class="n">MAX_HDMI_CVTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">chans</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">);</span>
	<span class="n">chans</span> <span class="o">=</span> <span class="n">get_wcaps_channels</span><span class="p">(</span><span class="n">chans</span><span class="p">);</span>

	<span class="n">cvt_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="p">;</span>
	<span class="n">per_cvt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">cvt_idx</span><span class="p">];</span>

	<span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">cvt_nid</span> <span class="o">=</span> <span class="n">cvt_nid</span><span class="p">;</span>
	<span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chans</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">chans</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_query_supported_pcm</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">maxbps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_parse_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes</span><span class="p">;</span>

	<span class="n">nodes</span> <span class="o">=</span> <span class="n">snd_hda_get_sub_nodes</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">afg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nid</span> <span class="o">||</span> <span class="n">nodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDMI: failed to get afg sub nodes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">nid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">caps</span> <span class="o">=</span> <span class="n">snd_hda_param_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">AC_PAR_AUDIO_WIDGET_CAP</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">caps</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_DIGITAL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AC_WID_AUD_OUT</span>:
			<span class="n">hdmi_add_cvt</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AC_WID_PIN</span>:
			<span class="n">hdmi_add_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * G45/IbexPeak don&#39;t support EPSS: the unsolicited pin hot plug event</span>
<span class="cm">	 * can be lost and presence sense verb will become inaccurate if the</span>
<span class="cm">	 * HDA link is powered off at hot plug or hw initialization time.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_SND_HDA_POWER_SAVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_hda_param_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">afg</span><span class="p">,</span> <span class="n">AC_PAR_POWER_STATE</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="n">AC_PWRST_EPSS</span><span class="p">))</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">power_keep_link_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_hdmi_pcm_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">names</span><span class="p">[</span><span class="n">MAX_HDMI_PINS</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;HDMI %d&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HDMI callbacks</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">cvt_nid</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span> <span class="o">=</span> <span class="n">hinfo_to_pin_index</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
	<span class="n">hda_nid_t</span> <span class="n">pin_nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">pin_nid</span><span class="p">;</span>

	<span class="n">hdmi_set_channel_count</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="n">hdmi_setup_audio_infoframe</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdmi_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cvt_nid</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cvt_idx</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_cvt</span> <span class="o">*</span><span class="n">per_cvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pinctl</span><span class="p">;</span>

	<span class="n">snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cvt_idx</span> <span class="o">=</span> <span class="n">cvt_nid_to_cvt_index</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">cvt_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">per_cvt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">cvt_idx</span><span class="p">];</span>

		<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">);</span>
		<span class="n">per_cvt</span><span class="o">-&gt;</span><span class="n">assigned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pin_idx</span> <span class="o">=</span> <span class="n">hinfo_to_pin_index</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>

		<span class="n">pinctl</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_GET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span>
				    <span class="n">pinctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIN_OUT</span><span class="p">);</span>
		<span class="n">snd_hda_spdif_ctls_unassign</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_ops</span> <span class="n">generic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">hdmi_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">generic_hdmi_playback_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">generic_hdmi_playback_pcm_cleanup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">pstr</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">get_hdmi_pcm_name</span><span class="p">(</span><span class="n">pin_idx</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">HDA_PCM_TYPE_HDMI</span><span class="p">;</span>

		<span class="n">pstr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
		<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">generic_ops</span><span class="p">;</span>
		<span class="cm">/* other pstr fields are set in open */</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm_info</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_build_jack</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">hdmi_str</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;HDMI/DP&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">pcmdev</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcmdev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">hdmi_str</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hdmi_str</span><span class="p">),</span> <span class="s">&quot;,pcm=%d&quot;</span><span class="p">,</span> <span class="n">pcmdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_hda_jack_add_kctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span> <span class="n">hdmi_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">generic_hdmi_build_jack</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						    <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">,</span>
						    <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">snd_hda_spdif_ctls_unassign</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>

		<span class="cm">/* add control for ELD Bytes */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hdmi_create_eld_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
					<span class="n">pin_idx</span><span class="p">,</span>
					<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">device</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">hdmi_present_sense</span><span class="p">(</span><span class="n">per_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_hdmi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
		<span class="n">hda_nid_t</span> <span class="n">pin_nid</span> <span class="o">=</span> <span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">pin_nid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">sink_eld</span><span class="p">;</span>

		<span class="n">hdmi_init_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>
		<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">,</span> <span class="n">pin_nid</span><span class="p">);</span>

		<span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">hdmi_repoll_eld</span><span class="p">);</span>
		<span class="n">snd_hda_eld_proc_new</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">eld</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_hdmi_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pin_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pin_idx</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span> <span class="n">pin_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdmi_spec_per_pin</span> <span class="o">*</span><span class="n">per_pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">hdmi_eld</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">sink_eld</span><span class="p">;</span>

		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_pin</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">snd_hda_eld_proc_free</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">eld</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">generic_hdmi_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">generic_hdmi_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>			<span class="o">=</span> <span class="n">generic_hdmi_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span>		<span class="o">=</span> <span class="n">generic_hdmi_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_controls</span>		<span class="o">=</span> <span class="n">generic_hdmi_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unsol_event</span>		<span class="o">=</span> <span class="n">hdmi_unsol_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_generic_hdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_parse_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">generic_hdmi_patch_ops</span><span class="p">;</span>

	<span class="n">init_channel_allocations</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shared non-generic implementations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_playback_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chans</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">pstr</span><span class="p">;</span>

		<span class="n">chans</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">);</span>
		<span class="n">chans</span> <span class="o">=</span> <span class="n">get_wcaps_channels</span><span class="p">(</span><span class="n">chans</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">get_hdmi_pcm_name</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">HDA_PCM_TYPE_HDMI</span><span class="p">;</span>
		<span class="n">pstr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
		<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_playback</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pstr</span> <span class="o">=</span> <span class="o">*</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_playback</span><span class="p">;</span>
		<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">chans</span> <span class="o">&amp;&amp;</span> <span class="n">chans</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">chans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_playback_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">,</span>
						    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">simple_playback_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Nvidia specific implementations</span>
<span class="cm"> */</span>

<span class="cp">#define Nv_VERB_SET_Channel_Allocation          0xF79</span>
<span class="cp">#define Nv_VERB_SET_Info_Frame_Checksum         0xF7A</span>
<span class="cp">#define Nv_VERB_SET_Audio_Protection_On         0xF98</span>
<span class="cp">#define Nv_VERB_SET_Audio_Protection_Off        0xF99</span>

<span class="cp">#define nvhdmi_master_con_nid_7x	0x04</span>
<span class="cp">#define nvhdmi_master_pin_nid_7x	0x05</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">hda_nid_t</span> <span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*front, rear, clfe, rear_surr */</span>
	<span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">nvhdmi_basic_init_7x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* set audio protect on */</span>
	<span class="p">{</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">Nv_VERB_SET_Audio_Protection_On</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="cm">/* enable digital output on pin widget */</span>
	<span class="p">{</span> <span class="mh">0x5</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="o">|</span> <span class="mh">0x5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="o">|</span> <span class="mh">0x5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="o">|</span> <span class="mh">0x5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xb</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="o">|</span> <span class="mh">0x5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xd</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="o">|</span> <span class="mh">0x5</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cp">#ifdef LIMITED_RATE_FMT_SUPPORT</span>
<span class="cm">/* support only the safe format and rate */</span>
<span class="cp">#define SUPPORTED_RATES		SNDRV_PCM_RATE_48000</span>
<span class="cp">#define SUPPORTED_MAXBPS	16</span>
<span class="cp">#define SUPPORTED_FORMATS	SNDRV_PCM_FMTBIT_S16_LE</span>
<span class="cp">#else</span>
<span class="cm">/* support all rates and formats */</span>
<span class="cp">#define SUPPORTED_RATES \</span>
<span class="cp">	(SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_48000 |\</span>
<span class="cp">	SNDRV_PCM_RATE_88200 | SNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_176400 |\</span>
<span class="cp">	 SNDRV_PCM_RATE_192000)</span>
<span class="cp">#define SUPPORTED_MAXBPS	24</span>
<span class="cp">#define SUPPORTED_FORMATS \</span>
<span class="cp">	(SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S32_LE)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvhdmi_7x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_basic_init_7x</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels_2_6_8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels_2_8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_2_6_8_channels</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels_2_6_8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels_2_6_8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_2_8_channels</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels_2_8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels_2_8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_playback_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="o">*</span><span class="n">hw_constraints_channels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x10de0002</span>:
	<span class="k">case</span> <span class="mh">0x10de0003</span>:
	<span class="k">case</span> <span class="mh">0x10de0005</span>:
	<span class="k">case</span> <span class="mh">0x10de0006</span>:
		<span class="n">hw_constraints_channels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_constraints_2_8_channels</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10de0007</span>:
		<span class="n">hw_constraints_channels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_constraints_2_6_8_channels</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_constraints_channels</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
				<span class="n">hw_constraints_channels</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_playback_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_close</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">simple_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_prepare</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span>
					     <span class="n">stream_tag</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvhdmi_8ch_7x_set_info_frame_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanmask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">?</span> <span class="p">(</span><span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">chanmask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">chanmask</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">chanmask</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">chanmask</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the audio infoframe channel allocation and checksum fields.  The</span>
<span class="cm">	 * channel count is computed implicitly by the hardware. */</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">Nv_VERB_SET_Channel_Allocation</span><span class="p">,</span> <span class="n">chanmask</span><span class="p">);</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">Nv_VERB_SET_Info_Frame_Checksum</span><span class="p">,</span>
			<span class="p">(</span><span class="mh">0x71</span> <span class="o">-</span> <span class="n">chan</span> <span class="o">-</span> <span class="n">chanmask</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvhdmi_8ch_7x_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set the stream id */</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* set the stream format */</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_STREAM_FORMAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The audio hardware sends a channel count of 0x7 (8ch) when all the</span>
<span class="cm">	 * streams are disabled. */</span>
	<span class="n">nvhdmi_8ch_7x_set_info_frame_parameters</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_close</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvhdmi_8ch_7x_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataDCC2</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_spdif_out</span> <span class="o">*</span><span class="n">spdif</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mutex</span><span class="p">);</span>
	<span class="n">spdif</span> <span class="o">=</span> <span class="n">snd_hda_spdif_out_of_nid</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">);</span>

	<span class="n">chs</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">dataDCC2</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="cm">/* turn off SPDIF once; otherwise the IEC958 bits won&#39;t be updated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_status_reset</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="n">AC_DIG1_ENABLE</span><span class="p">))</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_DIGI_CONVERT_1</span><span class="p">,</span>
				<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_DIG1_ENABLE</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* set the stream id */</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span> <span class="p">(</span><span class="n">stream_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* set the stream format */</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">AC_VERB_SET_STREAM_FORMAT</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="cm">/* turn on again (if needed) */</span>
	<span class="cm">/* enable and set the channel status audio/data flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_status_reset</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="n">AC_DIG1_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_DIGI_CONVERT_1</span><span class="p">,</span>
				<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_DIGI_CONVERT_2</span><span class="p">,</span> <span class="n">dataDCC2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">channel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">channel_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* turn off SPDIF once;</span>
<span class="cm">		 *otherwise the IEC958 bits won&#39;t be updated</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_status_reset</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="n">AC_DIG1_ENABLE</span><span class="p">))</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_DIGI_CONVERT_1</span><span class="p">,</span>
				<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_DIG1_ENABLE</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* set the stream id */</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_CHANNEL_STREAMID</span><span class="p">,</span>
				<span class="p">(</span><span class="n">stream_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">channel_id</span><span class="p">);</span>
		<span class="cm">/* set the stream format */</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">AC_VERB_SET_STREAM_FORMAT</span><span class="p">,</span>
				<span class="n">format</span><span class="p">);</span>
		<span class="cm">/* turn on again (if needed) */</span>
		<span class="cm">/* enable and set the channel status audio/data flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_status_reset</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="n">AC_DIG1_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
					<span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="n">AC_VERB_SET_DIGI_CONVERT_1</span><span class="p">,</span>
					<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">ctls</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
					<span class="n">nvhdmi_con_nids_7x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="n">AC_VERB_SET_DIGI_CONVERT_2</span><span class="p">,</span> <span class="n">dataDCC2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nvhdmi_8ch_7x_set_info_frame_parameters</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">chs</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">nvhdmi_pcm_playback_8ch_7x</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SUPPORTED_RATES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxbps</span> <span class="o">=</span> <span class="n">SUPPORTED_MAXBPS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">nvhdmi_8ch_7x_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">nvhdmi_8ch_7x_pcm_prepare</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">nvhdmi_pcm_playback_2ch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SUPPORTED_RATES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxbps</span> <span class="o">=</span> <span class="n">SUPPORTED_MAXBPS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">simple_playback_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">simple_playback_pcm_prepare</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">nvhdmi_patch_ops_8ch_7x</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">simple_playback_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">simple_playback_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">nvhdmi_7x_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">simple_playback_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">nvhdmi_patch_ops_2ch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">simple_playback_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">simple_playback_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">nvhdmi_7x_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">simple_playback_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_nvhdmi_2ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no analog */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">=</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cvt_nid</span> <span class="o">=</span> <span class="n">nvhdmi_master_con_nid_7x</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_playback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvhdmi_pcm_playback_2ch</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">nvhdmi_patch_ops_2ch</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_nvhdmi_8ch_7x</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">patch_nvhdmi_2ch</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_playback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvhdmi_pcm_playback_8ch_7x</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">nvhdmi_patch_ops_8ch_7x</span><span class="p">;</span>

	<span class="cm">/* Initialize the audio infoframe channel mask and checksum to something</span>
<span class="cm">	 * valid */</span>
	<span class="n">nvhdmi_8ch_7x_set_info_frame_parameters</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ATI-specific implementations</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: we may omit the whole this and use the generic code once after</span>
<span class="cm"> * it&#39;s confirmed to work.</span>
<span class="cm"> */</span>

<span class="cp">#define ATIHDMI_CVT_NID		0x02	</span><span class="cm">/* audio converter */</span><span class="cp"></span>
<span class="cp">#define ATIHDMI_PIN_NID		0x03	</span><span class="cm">/* HDMI output pin */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atihdmi_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">simple_playback_pcm_prepare</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
					  <span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_CVT_CHAN_COUNT</span><span class="p">,</span> <span class="n">chans</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* FIXME: XXX */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cvt_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_HDMI_CHAN_SLOT</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">atihdmi_pcm_digital_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">ATIHDMI_CVT_NID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">simple_playback_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">atihdmi_playback_pcm_prepare</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">atihdmi_basic_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* enable digital output on pin widget */</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">AC_VERB_SET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="n">PIN_OUT</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atihdmi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">atihdmi_basic_init</span><span class="p">);</span>
	<span class="cm">/* SI codec requires to unmute the pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pin_nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_OUT_AMP</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pin_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
				    <span class="n">AMP_OUT_UNMUTE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">atihdmi_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">simple_playback_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">simple_playback_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">atihdmi_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">simple_playback_free</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_atihdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	  <span class="cm">/* no analog */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">=</span> <span class="n">ATIHDMI_CVT_NID</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_cvts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cvts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cvt_nid</span> <span class="o">=</span> <span class="n">ATIHDMI_CVT_NID</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pin_nid</span> <span class="o">=</span> <span class="n">ATIHDMI_PIN_NID</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_playback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atihdmi_pcm_digital_playback</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">atihdmi_patch_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * patch entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_preset</span> <span class="n">snd_hda_preset_hdmi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1002793c</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RS600 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_atihdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10027919</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RS600 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_atihdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1002791a</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RS690/780 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_atihdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1002aa01</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;R6xx HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10951390</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SiI1390 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10951392</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SiI1392 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x17e80047</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Chrontel HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0002</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP77/78 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_8ch_7x</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0003</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP77/78 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_8ch_7x</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0005</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP77/78 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_8ch_7x</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0006</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP77/78 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_8ch_7x</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0007</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP79/7A HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_8ch_7x</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de000a</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 0a HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de000b</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 0b HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de000c</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP89 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de000d</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 0d HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0010</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 10 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0011</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 11 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0012</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 12 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0013</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 13 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0014</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 14 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0015</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 15 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0016</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 16 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="cm">/* 17 is known to be absent */</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0018</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 18 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0019</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 19 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de001a</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 1a HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de001b</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 1b HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de001c</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 1c HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0040</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 40 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0041</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 41 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0042</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 42 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0043</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 43 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0044</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPU 44 HDMI/DP&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de0067</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP67 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_2ch</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10de8001</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MCP73 HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_nvhdmi_2ch</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80860054</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IbexPeak HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862801</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Bearlake HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862802</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cantiga HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862803</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Eaglelake HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862804</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IbexPeak HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862805</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CougarPoint HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862806</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PantherPoint HDMI&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x80862880</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CedarTrail HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x808629fb</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Crestline HDMI&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_generic_hdmi</span> <span class="p">},</span>
<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:1002793c&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10027919&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:1002791a&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:1002aa01&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10951390&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10951392&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0002&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0003&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0005&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0006&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0007&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de000a&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de000b&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de000c&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de000d&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0010&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0011&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0012&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0013&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0014&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0015&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0016&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0018&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0019&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de001a&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de001b&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de001c&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0040&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0041&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0042&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0043&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0044&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de0067&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10de8001&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:17e80047&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80860054&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862801&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862802&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862803&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862804&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862805&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862806&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:80862880&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:808629fb&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HDMI HD-audio codec&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-intelhdmi&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-nvhdmi&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-atihdmi&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_preset_list</span> <span class="n">intel_list</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">snd_hda_preset_hdmi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">patch_hdmi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_hda_add_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">patch_hdmi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_delete_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">patch_hdmi_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">patch_hdmi_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
