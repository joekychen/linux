<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › hda › patch_cirrus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>patch_cirrus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HD audio interface patch for Cirrus Logic CS420x chip</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &quot;hda_codec.h&quot;</span>
<span class="cp">#include &quot;hda_local.h&quot;</span>
<span class="cp">#include &quot;hda_auto_parser.h&quot;</span>
<span class="cp">#include &quot;hda_jack.h&quot;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">cs_spec</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">board_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_multi_out</span> <span class="n">multiout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">vmaster_sw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">vmaster_vol</span><span class="p">;</span>

	<span class="n">hda_nid_t</span> <span class="n">dac_nid</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_OUTS</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_idx</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">capsrc_idx</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">adc_nid</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adc_idx</span><span class="p">[</span><span class="n">AUTO_PIN_LAST</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_input</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">automic_idx</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">cur_adc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_adc_stream_tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_adc_format</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">dig_in</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_dir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_eapd_hp</span><span class="p">;</span> <span class="cm">/* EAPD GPIO bit for headphones */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_eapd_speaker</span><span class="p">;</span> <span class="cm">/* EAPD GPIO bit for speakers */</span>

	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="n">pcm_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* PCM information */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hp_detect</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mic_detect</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* CS421x */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_detect</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sense_b</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">vendor_nid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_input_mux</span> <span class="n">input_mux</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_input</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* available models with CS420x */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CS420X_MBP53</span><span class="p">,</span>
	<span class="n">CS420X_MBP55</span><span class="p">,</span>
	<span class="n">CS420X_IMAC27</span><span class="p">,</span>
	<span class="n">CS420X_IMAC27_122</span><span class="p">,</span>
	<span class="n">CS420X_APPLE</span><span class="p">,</span>
	<span class="n">CS420X_AUTO</span><span class="p">,</span>
	<span class="n">CS420X_MODELS</span>
<span class="p">};</span>

<span class="cm">/* CS421x boards */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CS421X_CDB4210</span><span class="p">,</span>
	<span class="n">CS421X_MODELS</span>
<span class="p">};</span>

<span class="cm">/* Vendor-specific processing widget */</span>
<span class="cp">#define CS420X_VENDOR_NID	0x11</span>
<span class="cp">#define CS_DIG_OUT1_PIN_NID	0x10</span>
<span class="cp">#define CS_DIG_OUT2_PIN_NID	0x15</span>
<span class="cp">#define CS_DMIC1_PIN_NID	0x12</span>
<span class="cp">#define CS_DMIC2_PIN_NID	0x0e</span>

<span class="cm">/* coef indices */</span>
<span class="cp">#define IDX_SPDIF_STAT		0x0000</span>
<span class="cp">#define IDX_SPDIF_CTL		0x0001</span>
<span class="cp">#define IDX_ADC_CFG		0x0002</span>
<span class="cm">/* SZC bitmask, 4 modes below:</span>
<span class="cm"> * 0 = immediate,</span>
<span class="cm"> * 1 = digital immediate, analog zero-cross</span>
<span class="cm"> * 2 = digtail &amp; analog soft-ramp</span>
<span class="cm"> * 3 = digital soft-ramp, analog zero-cross</span>
<span class="cm"> */</span>
<span class="cp">#define   CS_COEF_ADC_SZC_MASK		(3 &lt;&lt; 0)</span>
<span class="cp">#define   CS_COEF_ADC_MIC_SZC_MODE	(3 &lt;&lt; 0) </span><span class="cm">/* SZC setup for mic */</span><span class="cp"></span>
<span class="cp">#define   CS_COEF_ADC_LI_SZC_MODE	(3 &lt;&lt; 0) </span><span class="cm">/* SZC setup for line-in */</span><span class="cp"></span>
<span class="cm">/* PGA mode: 0 = differential, 1 = signle-ended */</span>
<span class="cp">#define   CS_COEF_ADC_MIC_PGA_MODE	(1 &lt;&lt; 5) </span><span class="cm">/* PGA setup for mic */</span><span class="cp"></span>
<span class="cp">#define   CS_COEF_ADC_LI_PGA_MODE	(1 &lt;&lt; 6) </span><span class="cm">/* PGA setup for line-in */</span><span class="cp"></span>
<span class="cp">#define IDX_DAC_CFG		0x0003</span>
<span class="cm">/* SZC bitmask, 4 modes below:</span>
<span class="cm"> * 0 = Immediate</span>
<span class="cm"> * 1 = zero-cross</span>
<span class="cm"> * 2 = soft-ramp</span>
<span class="cm"> * 3 = soft-ramp on zero-cross</span>
<span class="cm"> */</span>
<span class="cp">#define   CS_COEF_DAC_HP_SZC_MODE	(3 &lt;&lt; 0) </span><span class="cm">/* nid 0x02 */</span><span class="cp"></span>
<span class="cp">#define   CS_COEF_DAC_LO_SZC_MODE	(3 &lt;&lt; 2) </span><span class="cm">/* nid 0x03 */</span><span class="cp"></span>
<span class="cp">#define   CS_COEF_DAC_SPK_SZC_MODE	(3 &lt;&lt; 4) </span><span class="cm">/* nid 0x04 */</span><span class="cp"></span>

<span class="cp">#define IDX_BEEP_CFG		0x0004</span>
<span class="cm">/* 0x0008 - test reg key */</span>
<span class="cm">/* 0x0009 - 0x0014 -&gt; 12 test regs */</span>
<span class="cm">/* 0x0015 - visibility reg */</span>

<span class="cm">/*</span>
<span class="cm"> * Cirrus Logic CS4210</span>
<span class="cm"> *</span>
<span class="cm"> * 1 DAC =&gt; HP(sense) / Speakers,</span>
<span class="cm"> * 1 ADC &lt;= LineIn(sense) / MicIn / DMicIn,</span>
<span class="cm"> * 1 SPDIF OUT =&gt; SPDIF Trasmitter(sense)</span>
<span class="cm">*/</span>
<span class="cp">#define CS4210_DAC_NID		0x02</span>
<span class="cp">#define CS4210_ADC_NID		0x03</span>
<span class="cp">#define CS4210_VENDOR_NID	0x0B</span>
<span class="cp">#define CS421X_DMIC_PIN_NID	0x09 </span><span class="cm">/* Port E */</span><span class="cp"></span>
<span class="cp">#define CS421X_SPDIF_PIN_NID	0x0A </span><span class="cm">/* Port H */</span><span class="cp"></span>

<span class="cp">#define CS421X_IDX_DEV_CFG	0x01</span>
<span class="cp">#define CS421X_IDX_ADC_CFG	0x02</span>
<span class="cp">#define CS421X_IDX_DAC_CFG	0x03</span>
<span class="cp">#define CS421X_IDX_SPK_CTL	0x04</span>

<span class="cp">#define SPDIF_EVENT		0x04</span>

<span class="cm">/* Cirrus Logic CS4213 is like CS4210 but does not have SPDIF input/output */</span>
<span class="cp">#define CS4213_VENDOR_NID	0x09</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cs_vendor_coef_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">AC_VERB_GET_PROC_COEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cs_vendor_coef_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define HP_EVENT	1</span>
<span class="cp">#define MIC_EVENT	2</span>

<span class="cm">/*</span>
<span class="cm"> * PCM callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_playback_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_analog_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span>
					     <span class="n">hinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_analog_prepare</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span>
						<span class="n">stream_tag</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_analog_cleanup</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Digital out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_dig_playback_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_dig_playback_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_close</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_dig_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_prepare</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span>
					     <span class="n">format</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_dig_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_cleanup</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_update_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analog capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_capture_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">];</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_stream_tag</span> <span class="o">=</span> <span class="n">stream_tag</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">cs_update_input_select</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_capture_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">cs_pcm_analog_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cs_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cs_playback_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">cs_playback_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">cs_pcm_analog_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cs_capture_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">cs_capture_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">cs_pcm_digital_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cs_dig_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">cs_dig_playback_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cs_dig_playback_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">cs_dig_playback_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">cs_pcm_digital_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cirrus Analog&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs_pcm_analog_playback</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dac_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">channels_max</span> <span class="o">=</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs_pcm_analog_capture</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">];</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">++</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cirrus Digital&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_out_type</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">HDA_PCM_TYPE_SPDIF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cs_pcm_digital_playback</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cs_pcm_digital_capture</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse codec topology</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">hda_nid_t</span> <span class="nf">get_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_ext_mic</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">snd_hda_get_input_pin_attr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">INPUT_PIN_ATTR_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">hda_nid_t</span> <span class="nf">get_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">start_nid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">nid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AC_WID_AUD_IN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">snd_hda_get_conn_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">idxp</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">nid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_active_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">get_defcfg_connect</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AC_JACK_PORT_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra_nids</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dac</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dac_nid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dac_nid</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* add HP and speakers */</span>
	<span class="n">extra_nids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dac</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">[</span><span class="n">extra_nids</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dac</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">[</span><span class="n">extra_nids</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_type</span> <span class="o">==</span> <span class="n">AUTO_PIN_SPEAKER_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">));</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_idx</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">capsrc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_adc</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check whether the automatic mic switch is available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">AUTO_PIN_MIC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">AUTO_PIN_MIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ext_mic</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ext_mic</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_ext_mic</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_digital_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_outs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">share_spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_outs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_digital_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_in_pin</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span> <span class="o">=</span> <span class="n">get_adc</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_in_pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create mixer controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">dir_sfx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span> <span class="s">&quot;Capture&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">**</span><span class="n">kctlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_MUTE_IDX</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">pval</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="s">&quot;%s %s Switch&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dir_sfx</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">kctlp</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">kctlp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">HDA_SUBDEV_AMP_FLAG</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">kctlp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">**</span><span class="n">kctlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span> <span class="o">=</span>
		<span class="n">HDA_CODEC_VOLUME_IDX</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">knew</span><span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">pval</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="s">&quot;%s %s Volume&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dir_sfx</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">kctlp</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">kctlp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">HDA_SUBDEV_AMP_FLAG</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">kctlp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_volume_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>

	<span class="cm">/* set the upper-limit for mixer amp to 0dB */</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7f</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">);</span>
	<span class="n">caps</span> <span class="o">|=</span> <span class="p">((</span><span class="n">caps</span> <span class="o">&gt;&gt;</span> <span class="n">AC_AMPCAP_OFFSET_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">;</span>
	<span class="n">snd_hda_override_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">caps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_vmaster</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_sw</span> <span class="o">=</span>
		<span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span><span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_sw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_hda_set_vmaster_tlv</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">tlv</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_vol</span> <span class="o">=</span>
		<span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="n">tlv</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_vol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">num_ctls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">speakers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Front Speaker&quot;</span><span class="p">,</span> <span class="s">&quot;Surround Speaker&quot;</span><span class="p">,</span> <span class="s">&quot;Bass Speaker&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">line_outs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Front Line Out&quot;</span><span class="p">,</span> <span class="s">&quot;Surround Line Out&quot;</span><span class="p">,</span> <span class="s">&quot;Bass Line Out&quot;</span>
	<span class="p">};</span>

	<span class="n">fix_volume_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_sw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_vmaster</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUTO_PIN_HP_OUT</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone&quot;</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AUTO_PIN_SPEAKER_OUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">num_ctls</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">speakers</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speaker&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_ctls</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">line_outs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Line Out&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		       <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">dac</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_sw</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
			 <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">dac</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vmaster_vol</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>		

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">,</span> <span class="n">AUTO_PIN_HP_OUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">get_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">,</span> <span class="n">AUTO_PIN_SPEAKER_OUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">cs_capture_ctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDA_BIND_SW</span><span class="p">(</span><span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDA_BIND_VOL</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_cur_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">==</span> <span class="n">idx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">!=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* stream is running, let&#39;s swap the current ADC */</span>
		<span class="n">__snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span>
					   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_format</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">cs_update_input_select</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_capture_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_idx</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">];</span>
	<span class="n">snd_hda_get_pin_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pin</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
			      <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_capture_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">capsrc_idx</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_capture_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">change_cur_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">cs_capture_source</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">cs_capture_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">cs_capture_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">cs_capture_source_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="nf">make_bind_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">hda_ctl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">bind</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bind</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bind</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AUTO_PIN_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bind</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span>
					    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HDA_INPUT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bind</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* add a (input-boost) volume control to the given input pin */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_input_volume_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">item</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">caps</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_IN_AMP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">);</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">label</span> <span class="o">=</span> <span class="n">hda_get_autocfg_input_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">add_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* make bind-capture */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_bind_capture</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_sw</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_bind_capture</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_vol</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs_capture_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">AUTO_PIN_LAST</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_nid</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">kctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs_capture_source</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_input_volume_control</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_digital_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">,</span>
					    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_share_sw</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_digital_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_hda_create_spdif_in_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * auto-mute and auto-mic switching</span>
<span class="cm"> * CS421x auto-output redirecting</span>
<span class="cm"> * HP/SPK/SPDIF</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hp_present</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_present</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spdif_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_outs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			TODO: SPDIF output redirect when SENSE_B is enabled.</span>
<span class="cm">			Shared (SENSE_A) jack (e.g HP/mini-TOSLINK)</span>
<span class="cm">			assumed.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
				<span class="cm">/* &amp;&amp; spec-&gt;sense_b */</span><span class="p">)</span>
				<span class="n">spdif_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hp_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">hp_present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_present</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mute speakers if spdif or hp jack is plugged in */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pin_ctl</span> <span class="o">=</span> <span class="n">hp_present</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">PIN_OUT</span><span class="p">;</span>
		<span class="cm">/* detect on spdif is specific to CS4210 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spdif_present</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">))</span>
			<span class="n">pin_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">pin_ctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">hp_present</span> <span class="o">?</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span> <span class="o">:</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_speaker</span><span class="p">;</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_GPIO_DATA</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* specific to CS4210 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mute HPs if spdif jack (SENSE_B) is present */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span>
				<span class="p">(</span><span class="n">spdif_present</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">sense_b</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">PIN_HP</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* SPDIF TX on/off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_outs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span>
				<span class="n">spdif_present</span> <span class="o">?</span> <span class="n">PIN_OUT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="cm">/* Update board GPIOs if neccessary ... */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Auto-input redirect for CS421x</span>
<span class="cm"> * Switch max 3 inputs of a single ADC (nid 3)</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_automic</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">present</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>

	<span class="cm">/* specific to CS421x, single ADC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS420X_VENDOR_NID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
			<span class="n">change_cur_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">change_cur_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">!=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">last_input</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">;</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">last_input</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs_update_input_select</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* mute first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">AMP_OUT_MUTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">AMP_OUT_MUTE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">AMP_OUT_MUTE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set appropriate pin controls */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="cm">/* HP */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_UNSOL_CAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">HP_EVENT</span><span class="p">);</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Speaker */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PIN_OUT</span><span class="p">);</span>

	<span class="cm">/* SPDIF is enabled on presence detect for CS421x */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_detect</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">spdif_detect</span><span class="p">)</span>
		<span class="n">cs_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coef</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">;</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* set appropriate pin control and mute first */</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">PIN_IN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">AUTO_PIN_MIC</span><span class="p">)</span>
			<span class="n">ctl</span> <span class="o">|=</span> <span class="n">snd_hda_get_default_vref</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
				    <span class="n">AMP_IN_MUTE</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">MIC_EVENT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* CS420x has multiple ADC, CS421x has single ADC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS420X_VENDOR_NID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change_cur_input</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span><span class="p">)</span>
			<span class="n">cs_automic</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="n">coef</span> <span class="o">=</span> <span class="mh">0x000a</span><span class="p">;</span> <span class="cm">/* ADC1/2 - Digital and Analog Soft Ramp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS_DMIC2_PIN_NID</span><span class="p">))</span>
			<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x0500</span><span class="p">;</span> <span class="cm">/* DMIC2 2 chan on, GPIO1 off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS_DMIC1_PIN_NID</span><span class="p">))</span>
			<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x1800</span><span class="p">;</span> <span class="cm">/* DMIC1 2 chan on, GPIO0 off</span>
<span class="cm">					 * No effect if SPDIF_OUT2 is</span>
<span class="cm">					 * selected in IDX_SPDIF_CTL.</span>
<span class="cm">					*/</span>
		<span class="n">cs_vendor_coef_set</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">IDX_ADC_CFG</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span><span class="p">)</span>
			<span class="n">cs_automic</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">else</span>  <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">];</span>
			<span class="n">cs_update_input_select</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">cs_coef_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">IDX_DAC_CFG</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span>
	 <span class="p">(</span><span class="mh">0x002a</span> <span class="cm">/* DAC1/2/3 SZCMode Soft Ramp */</span>
	  <span class="o">|</span> <span class="mh">0x0040</span> <span class="cm">/* Mute DACs on FIFO error */</span>
	  <span class="o">|</span> <span class="mh">0x1000</span> <span class="cm">/* Enable DACs High Pass Filter */</span>
	  <span class="o">|</span> <span class="mh">0x0400</span> <span class="cm">/* Disable Coefficient Auto increment */</span>
	  <span class="p">)},</span>
	<span class="cm">/* Beep */</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">IDX_DAC_CFG</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">},</span> <span class="cm">/* Enable Beep thru DAC1/2/3 */</span>

	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* Errata: CS4207 rev C0/C1/C2 Silicon</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.cirrus.com/en/pubs/errata/ER880C3.pdf</span>
<span class="cm"> *</span>
<span class="cm"> * 6. At high temperature (TA &gt; +85°C), the digital supply current (IVD)</span>
<span class="cm"> * may be excessive (up to an additional 200 μA), which is most easily</span>
<span class="cm"> * observed while the part is being held in reset (RESET# active low).</span>
<span class="cm"> *</span>
<span class="cm"> * Root Cause: At initial powerup of the device, the logic that drives</span>
<span class="cm"> * the clock and write enable to the S/PDIF SRC RAMs is not properly</span>
<span class="cm"> * initialized.</span>
<span class="cm"> * Certain random patterns will cause a steady leakage current in those</span>
<span class="cm"> * RAM cells. The issue will resolve once the SRCs are used (turned on).</span>
<span class="cm"> *</span>
<span class="cm"> * Workaround: The following verb sequence briefly turns on the S/PDIF SRC</span>
<span class="cm"> * blocks, which will alleviate the issue.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">cs_errata_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="cm">/* AFG: D0 */</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_STATE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>  <span class="cm">/* VPW: processing on */</span>

	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x9999</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0xa412</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">},</span>

	<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="cm">/* S/PDIF Rx: D0 */</span>
	<span class="p">{</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="cm">/* S/PDIF Tx: D0 */</span>

	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x2412</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_STATE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>

<span class="cp">#if 0</span><span class="c"> /* Don&#39;t to set to D3 as we are in power-up sequence */</span>
<span class="c">	{0x07, AC_VERB_SET_POWER_STATE, 0x03}, /* S/PDIF Rx: D3 */</span>
<span class="c">	{0x08, AC_VERB_SET_POWER_STATE, 0x03}, /* S/PDIF Tx: D3 */</span>
<span class="c">	/*{0x01, AC_VERB_SET_POWER_STATE, 0x03},*/ /* AFG: D3 This is already handled */</span>
<span class="cp">#endif</span>

	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* SPDIF setup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coef</span><span class="p">;</span>

	<span class="n">coef</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span> <span class="cm">/* SRC_MUTE soft-mute on SPDIF (if no lock) */</span>
	<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x0008</span><span class="p">;</span> <span class="cm">/* Replace with mute on error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_active_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS_DIG_OUT2_PIN_NID</span><span class="p">))</span>
		<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="cm">/* RX to TX1 or TX2 Loopthru / SPDIF2</span>
<span class="cm">				 * SPDIF_OUT2 is shared with GPIO1 and</span>
<span class="cm">				 * DMIC_SDA2.</span>
<span class="cm">				 */</span>
	<span class="n">cs_vendor_coef_set</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">IDX_SPDIF_CTL</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="cm">/* init_verb sequence for C0/C1/C2 errata*/</span>
	<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cs_errata_init_verbs</span><span class="p">);</span>

	<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cs_coef_init_verbs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_MASK</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_DIRECTION</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_DATA</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">init_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">init_digital</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">build_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_digital_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_digital_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cs_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_jack_add_kctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">snd_hda_jack_get_action</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HP_EVENT</span>:
		<span class="n">cs_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIC_EVENT</span>:
		<span class="n">cs_automic</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">cs_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">cs_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">cs_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">cs_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">cs_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unsol_event</span> <span class="o">=</span> <span class="n">cs_unsol_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs_parse_auto_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_parse_pin_def_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_digital_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_digital_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">cs420x_models</span><span class="p">[</span><span class="n">CS420X_MODELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CS420X_MBP53</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;mbp53&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_MBP55</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;mbp55&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_IMAC27</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;imac27&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_IMAC27_122</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;imac27_122&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_APPLE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;apple&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_AUTO</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">cs420x_cfg_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10de</span><span class="p">,</span> <span class="mh">0x0ac0</span><span class="p">,</span> <span class="s">&quot;MacBookPro 5,3&quot;</span><span class="p">,</span> <span class="n">CS420X_MBP53</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10de</span><span class="p">,</span> <span class="mh">0x0d94</span><span class="p">,</span> <span class="s">&quot;MacBookAir 3,1(2)&quot;</span><span class="p">,</span> <span class="n">CS420X_MBP55</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10de</span><span class="p">,</span> <span class="mh">0xcb79</span><span class="p">,</span> <span class="s">&quot;MacBookPro 5,5&quot;</span><span class="p">,</span> <span class="n">CS420X_MBP55</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10de</span><span class="p">,</span> <span class="mh">0xcb89</span><span class="p">,</span> <span class="s">&quot;MacBookPro 7,1&quot;</span><span class="p">,</span> <span class="n">CS420X_MBP55</span><span class="p">),</span>
	<span class="cm">/* this conflicts with too many other models */</span>
	<span class="cm">/*SND_PCI_QUIRK(0x8086, 0x7270, &quot;IMac 27 Inch&quot;, CS420X_IMAC27),*/</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">cs420x_codec_cfg_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x106b</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="s">&quot;iMac 12,2&quot;</span><span class="p">,</span> <span class="n">CS420X_IMAC27_122</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x106b</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">,</span> <span class="n">CS420X_APPLE</span><span class="p">),</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="n">mbp53_pincfgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x012b4050</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x90100141</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x90100140</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x018b3020</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x90a00110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x01cbe030</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x014be060</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="n">mbp55_pincfgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x012b4030</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x90100121</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x90100120</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x90a00110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x014be040</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="n">imac27_pincfgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x012b4050</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x90100140</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x90100142</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x018b3020</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x90a00110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x01cbe030</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x014be060</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x01ab9070</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x400000f0</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="o">*</span><span class="n">cs_pincfgs</span><span class="p">[</span><span class="n">CS420X_MODELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CS420X_MBP53</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbp53_pincfgs</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_MBP55</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbp55_pincfgs</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CS420X_IMAC27</span><span class="p">]</span> <span class="o">=</span> <span class="n">imac27_pincfgs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_pincfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">model</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="o">**</span><span class="n">pin_configs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">pin_configs</span><span class="p">[</span><span class="n">model</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">;</span> <span class="n">cfg</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hda_codec_set_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cs420x</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">=</span> <span class="n">CS420X_VENDOR_NID</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">=</span>
		<span class="n">snd_hda_check_board_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS420X_MODELS</span><span class="p">,</span>
					   <span class="n">cs420x_models</span><span class="p">,</span> <span class="n">cs420x_cfg_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">=</span>
			<span class="n">snd_hda_check_board_codec_sid_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				<span class="n">CS420X_MODELS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cs420x_codec_cfg_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fix_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span><span class="p">,</span> <span class="n">cs_pincfgs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS420X_IMAC27</span>:
	<span class="k">case</span> <span class="n">CS420X_MBP53</span>:
	<span class="k">case</span> <span class="n">CS420X_MBP55</span>:
	<span class="k">case</span> <span class="n">CS420X_APPLE</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* GPIO1 = headphones */</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_speaker</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* GPIO3 = speakers */</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span> <span class="o">|</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_speaker</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS420X_IMAC27_122</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* GPIO2 = headphones */</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_speaker</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* GPIO3 = speakers */</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_hp</span> <span class="o">|</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_eapd_speaker</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">cs_patch_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cirrus Logic CS4210</span>
<span class="cm"> *</span>
<span class="cm"> * 1 DAC =&gt; HP(sense) / Speakers,</span>
<span class="cm"> * 1 ADC &lt;= LineIn(sense) / MicIn / DMicIn,</span>
<span class="cm"> * 1 SPDIF OUT =&gt; SPDIF Trasmitter(sense)</span>
<span class="cm">*/</span>

<span class="cm">/* CS4210 board names */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cs421x_models</span><span class="p">[</span><span class="n">CS421X_MODELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CS421X_CDB4210</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;cdb4210&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">cs421x_cfg_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Test Intel board + CDB2410  */</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x5001</span><span class="p">,</span> <span class="s">&quot;DP45SG/CDB4210&quot;</span><span class="p">,</span> <span class="n">CS421X_CDB4210</span><span class="p">),</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* CS4210 board pinconfigs */</span>
<span class="cm">/* Default CS4210 (CDB4210)*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="n">cdb4210_pincfgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0321401f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x90170010</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03813031</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb7a70037</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xb7a6003e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x034510f0</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cs_pincfg</span> <span class="o">*</span><span class="n">cs421x_pincfgs</span><span class="p">[</span><span class="n">CS421X_MODELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CS421X_CDB4210</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdb4210_pincfgs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">cs421x_coef_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">CS421X_IDX_DEV_CFG</span><span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	    Disable Coefficient Index Auto-Increment(DAI)=1,</span>
<span class="cm">	    PDREF=0</span>
<span class="cm">	*/</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">CS421X_IDX_ADC_CFG</span><span class="p">},</span>
	<span class="cm">/* ADC SZCMode = Digital Soft Ramp */</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="n">CS421X_IDX_DAC_CFG</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span>
	 <span class="p">(</span><span class="mh">0x0002</span> <span class="cm">/* DAC SZCMode = Digital Soft Ramp */</span>
	  <span class="o">|</span> <span class="mh">0x0004</span> <span class="cm">/* Mute DAC on FIFO error */</span>
	  <span class="o">|</span> <span class="mh">0x0008</span> <span class="cm">/* Enable DAC High Pass Filter */</span>
	  <span class="p">)},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* Errata: CS4210 rev A1 Silicon</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.cirrus.com/en/pubs/errata/</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 1. Performance degredation is present in the ADC.</span>
<span class="cm"> * 2. Speaker output is not completely muted upon HP detect.</span>
<span class="cm"> * 3. Noise is present when clipping occurs on the amplified</span>
<span class="cm"> *    speaker outputs.</span>
<span class="cm"> *</span>
<span class="cm"> * Workaround:</span>
<span class="cm"> * The following verb sequence written to the registers during</span>
<span class="cm"> * initialization will correct the issues listed above.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">cs421x_coef_init_verbs_A1_silicon_fixes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_STATE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>  <span class="cm">/* VPW: processing on */</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x9999</span><span class="p">},</span> <span class="cm">/* Test mode: on */</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x14CB</span><span class="p">},</span> <span class="cm">/* Chop double */</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0xA2D0</span><span class="p">},</span> <span class="cm">/* Increase ADC current */</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x001A</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mh">0x02A9</span><span class="p">},</span> <span class="cm">/* Mute speaker */</span>

	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_COEF_INDEX</span><span class="p">,</span> <span class="mh">0x001B</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">AC_VERB_SET_PROC_COEF</span><span class="p">,</span> <span class="mi">0</span><span class="n">X1006</span><span class="p">},</span> <span class="cm">/* Remove noise */</span>

	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* Speaker Amp Gain is controlled by the vendor widget&#39;s coef 4 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">cs421x_speaker_boost_db_scale</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_boost_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_boost_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cs_vendor_coef_get</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_SPK_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_boost_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coef</span> <span class="o">=</span>
		<span class="n">cs_vendor_coef_get</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_SPK_CTL</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">original_coef</span> <span class="o">=</span> <span class="n">coef</span><span class="p">;</span>

	<span class="n">coef</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0003</span><span class="p">;</span>
	<span class="n">coef</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">original_coef</span> <span class="o">==</span> <span class="n">coef</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cs_vendor_coef_set</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_SPK_CTL</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">cs421x_speaker_bost_ctl</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
			<span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speaker Boost Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">cs421x_boost_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">cs421x_boost_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">cs421x_boost_vol_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">cs421x_speaker_boost_db_scale</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4210_pinmux_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_conf</span><span class="p">,</span> <span class="n">coef</span><span class="p">;</span>

	<span class="cm">/* GPIO, DMIC_SCL, DMIC_SDA and SENSE_B are multiplexed */</span>
	<span class="n">coef</span> <span class="o">=</span> <span class="n">cs_vendor_coef_get</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_DEV_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">)</span>
		<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x0008</span><span class="p">;</span> <span class="cm">/* B1,B2 are GPIOs */</span>
	<span class="k">else</span>
		<span class="n">coef</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0008</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">sense_b</span><span class="p">)</span>
		<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span> <span class="cm">/* B2 is SENSE_B, not inverted  */</span>
	<span class="k">else</span>
		<span class="n">coef</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0010</span><span class="p">;</span>

	<span class="n">cs_vendor_coef_set</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_DEV_CFG</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">sense_b</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">is_active_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_DMIC_PIN_NID</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		    GPIO or SENSE_B forced - disconnect the DMIC pin.</span>
<span class="cm">		*/</span>
		<span class="n">def_conf</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_DMIC_PIN_NID</span><span class="p">);</span>
		<span class="n">def_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_DEFCFG_PORT_CONN</span><span class="p">;</span>
		<span class="n">def_conf</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AC_JACK_PORT_NONE</span> <span class="o">&lt;&lt;</span> <span class="n">AC_DEFCFG_PORT_CONN_SHIFT</span><span class="p">);</span>
		<span class="n">snd_hda_codec_set_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_DMIC_PIN_NID</span><span class="p">,</span> <span class="n">def_conf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_cs421x_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_UNSOL_CAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">SPDIF_EVENT</span><span class="p">);</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">spdif_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cs421x_coef_init_verbs</span><span class="p">);</span>
		<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cs421x_coef_init_verbs_A1_silicon_fixes</span><span class="p">);</span>
		<span class="n">cs4210_pinmux_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_MASK</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_DIRECTION</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_GPIO_DATA</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">init_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">init_cs421x_digital</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CS4210 Input MUX (1 ADC)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_mux_enum_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_hda_input_mux_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_mux</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_mux_enum_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_mux_enum_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_hda_input_mux_put</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_mux</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">,</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">cs421x_capture_source</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">cs421x_mux_enum_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">cs421x_mux_enum_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">cs421x_mux_enum_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_add_input_volume_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_input_mux</span> <span class="o">*</span><span class="n">imux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_mux</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">item</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">caps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_IN_AMP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">caps</span> <span class="o">=</span> <span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">);</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>  <span class="n">imux</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">[</span><span class="n">item</span><span class="p">].</span><span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* add a (input-boost) volume control to the given input pin */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_cs421x_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_input_mux</span> <span class="o">*</span><span class="n">imux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">input_mux</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">type_idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* make bind-capture */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_bind_capture</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_sw</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_bind_capture</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_vol</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs_capture_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">capture_bind</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">AUTO_PIN_LAST</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_nid</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">kctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Add Input MUX Items + Capture Volume/Switch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">label</span> <span class="o">=</span> <span class="n">hda_get_autocfg_input_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">snd_hda_add_imux_item</span><span class="p">(</span><span class="n">imux</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">type_idx</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">cs421x_add_input_volume_control</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	    Add &#39;Capture Source&#39; Switch if</span>
<span class="cm">		* 2 inputs and no mic detec</span>
<span class="cm">		* 3 inputs</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			      <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs421x_capture_source</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Single DAC (Mute/Gain) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_cs421x_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">dac</span> <span class="o">=</span> <span class="n">CS4210_DAC_NID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master&quot;</span><span class="p">;</span>

	<span class="n">fix_volume_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">dac</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_volume</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">dac</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_outs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs421x_speaker_bost_ctl</span><span class="p">,</span> <span class="n">codec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">build_cs421x_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_cs421x_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_digital_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span>  <span class="n">cs421x_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_jack_add_kctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs421x_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">snd_hda_jack_get_action</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HP_EVENT</span>:
	<span class="k">case</span> <span class="n">SPDIF_EVENT</span>:
		<span class="n">cs_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIC_EVENT</span>:
		<span class="n">cs_automic</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_cs421x_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_adc</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">last_input</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* check whether the automatic mic switch is available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ext_mic</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mic_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">automic_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_parse_auto_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_parse_pin_def_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_cs421x_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_digital_output</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm">	Manage PDREF, when transitioning to D3hot</span>
<span class="cm">	(DAC,ADC) -&gt; D3, PDREF=1, AFG-&gt;D3</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs421x_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coef</span><span class="p">;</span>

	<span class="n">snd_hda_shutup_pins</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS4210_DAC_NID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span>  <span class="n">AC_PWRST_D3</span><span class="p">);</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS4210_ADC_NID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span>  <span class="n">AC_PWRST_D3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">==</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">coef</span> <span class="o">=</span> <span class="n">cs_vendor_coef_get</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_DEV_CFG</span><span class="p">);</span>
		<span class="n">coef</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span> <span class="cm">/* PDREF */</span>
		<span class="n">cs_vendor_coef_set</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_IDX_DEV_CFG</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">cs421x_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">cs421x_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">cs_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">cs421x_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">cs_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unsol_event</span> <span class="o">=</span> <span class="n">cs421x_unsol_event</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">cs421x_suspend</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cs4210</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">=</span> <span class="n">CS4210_VENDOR_NID</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">=</span>
		<span class="n">snd_hda_check_board_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">CS421X_MODELS</span><span class="p">,</span>
					   <span class="n">cs421x_models</span><span class="p">,</span> <span class="n">cs421x_cfg_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fix_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span><span class="p">,</span> <span class="n">cs421x_pincfgs</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	    Setup GPIO/SENSE for each board (if used)</span>
<span class="cm">	*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS421X_CDB4210</span>:
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;CS4210 board: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cs421x_models</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">board_config</span><span class="p">]);</span>
<span class="cm">/*		spec-&gt;gpio_mask = 3;</span>
<span class="cm">		spec-&gt;gpio_dir = 3;</span>
<span class="cm">		spec-&gt;gpio_data = 3;</span>
<span class="cm">*/</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">sense_b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	    Update the GPIO/DMIC/SENSE_B pinmux before the configuration</span>
<span class="cm">	    is auto-parsed. If GPIO or SENSE_B is forced, DMIC input</span>
<span class="cm">	    is disabled.</span>
<span class="cm">	*/</span>
	<span class="n">cs4210_pinmux_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs421x_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">cs421x_patch_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_cs4213</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vendor_nid</span> <span class="o">=</span> <span class="n">CS4213_VENDOR_NID</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs421x_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">cs421x_patch_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * patch entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_preset</span> <span class="n">snd_hda_preset_cirrus</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10134206</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CS4206&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_cs420x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10134207</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CS4207&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_cs420x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10134210</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CS4210&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_cs4210</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x10134213</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CS4213&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_cs4213</span> <span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10134206&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10134207&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10134210&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:10134213&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Cirrus Logic HD-audio codec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_preset_list</span> <span class="n">cirrus_list</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">snd_hda_preset_cirrus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">patch_cirrus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_hda_add_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrus_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">patch_cirrus_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_delete_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrus_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">patch_cirrus_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">patch_cirrus_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
