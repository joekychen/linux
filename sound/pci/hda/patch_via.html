<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › hda › patch_via.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>patch_via.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Universal Interface for Intel High Definition Audio Codec</span>
<span class="cm"> *</span>
<span class="cm"> * HD audio interface patch for VIA VT17xx/VT18xx/VT20xx codec</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) 2006-2009 VIA Technology, Inc.</span>
<span class="cm"> *  (C) 2006-2008 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cm">/* * * * * * * * * * * * * * Release History * * * * * * * * * * * * * * * * */</span>
<span class="cm">/*									     */</span>
<span class="cm">/* 2006-03-03  Lydia Wang  Create the basic patch to support VT1708 codec    */</span>
<span class="cm">/* 2006-03-14  Lydia Wang  Modify hard code for some pin widget nid	     */</span>
<span class="cm">/* 2006-08-02  Lydia Wang  Add support to VT1709 codec			     */</span>
<span class="cm">/* 2006-09-08  Lydia Wang  Fix internal loopback recording source select bug */</span>
<span class="cm">/* 2007-09-12  Lydia Wang  Add EAPD enable during driver initialization	     */</span>
<span class="cm">/* 2007-09-17  Lydia Wang  Add VT1708B codec support			    */</span>
<span class="cm">/* 2007-11-14  Lydia Wang  Add VT1708A codec HP and CD pin connect config    */</span>
<span class="cm">/* 2008-02-03  Lydia Wang  Fix Rear channels and Back channels inverse issue */</span>
<span class="cm">/* 2008-03-06  Lydia Wang  Add VT1702 codec and VT1708S codec support	     */</span>
<span class="cm">/* 2008-04-09  Lydia Wang  Add mute front speaker when HP plugin	     */</span>
<span class="cm">/* 2008-04-09  Lydia Wang  Add Independent HP feature			     */</span>
<span class="cm">/* 2008-05-28  Lydia Wang  Add second S/PDIF Out support for VT1702	     */</span>
<span class="cm">/* 2008-09-15  Logan Li	   Add VT1708S Mic Boost workaround/backdoor	     */</span>
<span class="cm">/* 2009-02-16  Logan Li	   Add support for VT1718S			     */</span>
<span class="cm">/* 2009-03-13  Logan Li	   Add support for VT1716S			     */</span>
<span class="cm">/* 2009-04-14  Lydai Wang  Add support for VT1828S and VT2020		     */</span>
<span class="cm">/* 2009-07-08  Lydia Wang  Add support for VT2002P			     */</span>
<span class="cm">/* 2009-07-21  Lydia Wang  Add support for VT1812			     */</span>
<span class="cm">/* 2009-09-19  Lydia Wang  Add support for VT1818S			     */</span>
<span class="cm">/*									     */</span>
<span class="cm">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>


<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &quot;hda_codec.h&quot;</span>
<span class="cp">#include &quot;hda_local.h&quot;</span>
<span class="cp">#include &quot;hda_auto_parser.h&quot;</span>
<span class="cp">#include &quot;hda_jack.h&quot;</span>

<span class="cm">/* Pin Widget NID */</span>
<span class="cp">#define VT1708_HP_PIN_NID	0x20</span>
<span class="cp">#define VT1708_CD_PIN_NID	0x24</span>

<span class="k">enum</span> <span class="n">VIA_HDA_CODEC</span> <span class="p">{</span>
	<span class="n">UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">VT1708</span><span class="p">,</span>
	<span class="n">VT1709_10CH</span><span class="p">,</span>
	<span class="n">VT1709_6CH</span><span class="p">,</span>
	<span class="n">VT1708B_8CH</span><span class="p">,</span>
	<span class="n">VT1708B_4CH</span><span class="p">,</span>
	<span class="n">VT1708S</span><span class="p">,</span>
	<span class="n">VT1708BCE</span><span class="p">,</span>
	<span class="n">VT1702</span><span class="p">,</span>
	<span class="n">VT1718S</span><span class="p">,</span>
	<span class="n">VT1716S</span><span class="p">,</span>
	<span class="n">VT2002P</span><span class="p">,</span>
	<span class="n">VT1812</span><span class="p">,</span>
	<span class="n">VT1802</span><span class="p">,</span>
	<span class="n">CODEC_TYPES</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define VT2002P_COMPATIBLE(spec) \</span>
<span class="cp">	((spec)-&gt;codec_type == VT2002P ||\</span>
<span class="cp">	 (spec)-&gt;codec_type == VT1812 ||\</span>
<span class="cp">	 (spec)-&gt;codec_type == VT1802)</span>

<span class="cp">#define MAX_NID_PATH_DEPTH	5</span>

<span class="cm">/* output-path: DAC -&gt; ... -&gt; pin</span>
<span class="cm"> * idx[] contains the source index number of the next widget;</span>
<span class="cm"> * e.g. idx[0] is the index of the DAC selected by path[1] widget</span>
<span class="cm"> * multi[] indicates whether it&#39;s a selector widget with multi-connectors</span>
<span class="cm"> * (i.e. the connection selection is mandatory)</span>
<span class="cm"> * vol_ctl and mute_ctl contains the NIDs for the assigned mixers</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nid_path</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_NID_PATH_DEPTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">idx</span><span class="p">[</span><span class="n">MAX_NID_PATH_DEPTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">multi</span><span class="p">[</span><span class="n">MAX_NID_PATH_DEPTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol_ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mute_ctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* input-path */</span>
<span class="k">struct</span> <span class="n">via_input</span> <span class="p">{</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">;</span>	<span class="cm">/* input-pin or aa-mix */</span>
	<span class="kt">int</span> <span class="n">adc_idx</span><span class="p">;</span>	<span class="cm">/* ADC index to be used */</span>
	<span class="kt">int</span> <span class="n">mux_idx</span><span class="p">;</span>	<span class="cm">/* MUX index (if any) */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>	<span class="cm">/* input-source label */</span>
<span class="p">};</span>

<span class="cp">#define VIA_MAX_ADCS	3</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">STREAM_MULTI_OUT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">STREAM_INDEP_HP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">via_spec</span> <span class="p">{</span>
	<span class="cm">/* codec parameterization */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">mixers</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mixers</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="o">*</span><span class="n">init_verbs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_iverbs</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">stream_name_analog</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">stream_name_hp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">stream_analog_playback</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">stream_analog_capture</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">stream_name_digital</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">stream_digital_playback</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">stream_digital_capture</span><span class="p">;</span>

	<span class="cm">/* playback */</span>
	<span class="k">struct</span> <span class="n">hda_multi_out</span> <span class="n">multiout</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">hp_dac_nid</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">speaker_dac_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hp_indep_shared</span><span class="p">;</span>	<span class="cm">/* indep HP-DAC is shared with side ch */</span>
	<span class="kt">int</span> <span class="n">opened_streams</span><span class="p">;</span>	<span class="cm">/* STREAM_* bits */</span>
	<span class="kt">int</span> <span class="n">active_streams</span><span class="p">;</span>	<span class="cm">/* STREAM_* bits */</span>
	<span class="kt">int</span> <span class="n">aamix_mode</span><span class="p">;</span>		<span class="cm">/* loopback is enabled for output-path? */</span>

	<span class="cm">/* Output-paths:</span>
<span class="cm">	 * There are different output-paths depending on the setup.</span>
<span class="cm">	 * out_path, hp_path and speaker_path are primary paths.  If both</span>
<span class="cm">	 * direct DAC and aa-loopback routes are available, these contain</span>
<span class="cm">	 * the former paths.  Meanwhile *_mix_path contain the paths with</span>
<span class="cm">	 * loopback mixer.  (Since the loopback is only for front channel,</span>
<span class="cm">	 * no out_mix_path for surround channels.)</span>
<span class="cm">	 * The HP output has another path, hp_indep_path, which is used in</span>
<span class="cm">	 * the independent-HP mode.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">out_path</span><span class="p">[</span><span class="n">HDA_SIDE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">out_mix_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">hp_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">hp_mix_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">hp_indep_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">speaker_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="n">speaker_mix_path</span><span class="p">;</span>

	<span class="cm">/* capture */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_adc_nids</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">adc_nids</span><span class="p">[</span><span class="n">VIA_MAX_ADCS</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">mux_nids</span><span class="p">[</span><span class="n">VIA_MAX_ADCS</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">aa_mix_nid</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">dig_in_nid</span><span class="p">;</span>

	<span class="cm">/* capture source */</span>
	<span class="n">bool</span> <span class="n">dyn_adc_switch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_input</span> <span class="n">inputs</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_INS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_mux</span><span class="p">[</span><span class="n">VIA_MAX_ADCS</span><span class="p">];</span>

	<span class="cm">/* dynamic DAC switching */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_dac_stream_tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_dac_format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_hp_stream_tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_hp_format</span><span class="p">;</span>

	<span class="cm">/* dynamic ADC switching */</span>
	<span class="n">hda_nid_t</span> <span class="n">cur_adc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_adc_stream_tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_adc_format</span><span class="p">;</span>

	<span class="cm">/* PCM information */</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="n">pcm_rec</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* dynamic controls, init_verbs and input_mux */</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_array</span> <span class="n">kctls</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">private_dac_nids</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_OUTS</span><span class="p">];</span>

	<span class="cm">/* HP mode source */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hp_independent_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmic_enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no_pin_power_ctl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">VIA_HDA_CODEC</span> <span class="n">codec_type</span><span class="p">;</span>

	<span class="cm">/* analog low-power control */</span>
	<span class="n">bool</span> <span class="n">alc_mode</span><span class="p">;</span>

	<span class="cm">/* smart51 setup */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">smart51_nums</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">smart51_pins</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">smart51_idxs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">smart51_labels</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">smart51_enabled</span><span class="p">;</span>

	<span class="cm">/* work to check hp jack state */</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">vt1708_hp_work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hp_work_active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vt1708_jack_detect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vt1708_hp_present</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set_widgets_power_state</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">hda_loopback_check</span> <span class="n">loopback</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_loopbacks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_amp_list</span> <span class="n">loopback_list</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* bind capture-volume */</span>
	<span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="n">bind_cap_vol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="n">bind_cap_sw</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">config_mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">VIA_HDA_CODEC</span> <span class="n">get_codec_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span> <span class="nf">via_new_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">=</span> <span class="n">get_codec_type</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="cm">/* VT1708BCE &amp; VT1708S are almost same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1708BCE</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708S</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">spec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">VIA_HDA_CODEC</span> <span class="nf">get_codec_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vendor_id</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ven_id</span> <span class="o">=</span> <span class="n">vendor_id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dev_id</span> <span class="o">=</span> <span class="n">vendor_id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">VIA_HDA_CODEC</span> <span class="n">codec_type</span><span class="p">;</span>

	<span class="cm">/* get codec type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ven_id</span> <span class="o">!=</span> <span class="mh">0x1106</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;=</span> <span class="mh">0x1708</span> <span class="o">&amp;&amp;</span> <span class="n">dev_id</span> <span class="o">&lt;=</span> <span class="mh">0x170b</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;=</span> <span class="mh">0xe710</span> <span class="o">&amp;&amp;</span> <span class="n">dev_id</span> <span class="o">&lt;=</span> <span class="mh">0xe713</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1709_10CH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;=</span> <span class="mh">0xe714</span> <span class="o">&amp;&amp;</span> <span class="n">dev_id</span> <span class="o">&lt;=</span> <span class="mh">0xe717</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1709_6CH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;=</span> <span class="mh">0xe720</span> <span class="o">&amp;&amp;</span> <span class="n">dev_id</span> <span class="o">&lt;=</span> <span class="mh">0xe723</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708B_8CH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_param_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">AC_PAR_CONNLIST_LEN</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span>
			<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708BCE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;=</span> <span class="mh">0xe724</span> <span class="o">&amp;&amp;</span> <span class="n">dev_id</span> <span class="o">&lt;=</span> <span class="mh">0xe727</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708B_4CH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x397</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x398</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1702</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x428</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1718S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x0433</span> <span class="o">||</span> <span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0xa721</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1716S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x0441</span> <span class="o">||</span> <span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x4441</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1718S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x0438</span> <span class="o">||</span> <span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x4438</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT2002P</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x0448</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1812</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x0440</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1708S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x446</span><span class="p">)</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">VT1802</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">codec_type</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">codec_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define VIA_JACK_EVENT		0x20</span>
<span class="cp">#define VIA_HP_EVENT		0x01</span>
<span class="cp">#define VIA_GPIO_EVENT		0x02</span>
<span class="cp">#define VIA_LINE_EVENT		0x03</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span>
	<span class="n">VIA_CTL_WIDGET_MUTE</span><span class="p">,</span>
	<span class="n">VIA_CTL_WIDGET_ANALOG_MUTE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">analog_low_current_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">is_aa_path_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

<span class="cp">#define hp_detect_with_aa(codec) \</span>
<span class="cp">	(snd_hda_get_bool_hint(codec, &quot;analog_loopback_hp_detect&quot;) == 1 &amp;&amp; \</span>
<span class="cp">	 !is_aa_path_mute(codec))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1708_stop_hp_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_work_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf81</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_work</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_work_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1708_update_hp_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">||</span> <span class="n">hp_detect_with_aa</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_work_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf81</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_work</span><span class="p">,</span>
					      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_work_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_detect_with_aa</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">))</span>
		<span class="n">vt1708_stop_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">analog_input_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="n">snd_hda_mixer_amp_switch_put</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">analog_low_current_mode</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">));</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* modify .put = snd_hda_mixer_amp_switch_put */</span>
<span class="cp">#define ANALOG_INPUT_MUTE						\</span>
<span class="cp">	{		.iface = SNDRV_CTL_ELEM_IFACE_MIXER,		\</span>
<span class="cp">			.name = NULL,					\</span>
<span class="cp">			.index = 0,					\</span>
<span class="cp">			.info = snd_hda_mixer_amp_switch_info,		\</span>
<span class="cp">			.get = snd_hda_mixer_amp_switch_get,		\</span>
<span class="cp">			.put = analog_input_switch_put,			\</span>
<span class="cp">			.private_value = HDA_COMPOSE_AMP_VAL(0, 3, 0, 0) }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_control_templates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDA_CODEC_VOLUME</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDA_CODEC_MUTE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ANALOG_INPUT_MUTE</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* add dynamic controls */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="nf">__via_clone_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">tmpl</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">knew</span><span class="p">;</span>

	<span class="n">snd_array_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">knew</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">knew</span> <span class="o">=</span> <span class="n">snd_array_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">knew</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmpl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">knew</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">knew</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__via_add_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">knew</span><span class="p">;</span>

	<span class="n">knew</span> <span class="o">=</span> <span class="n">__via_clone_ctl</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_control_templates</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_amp_nid_</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="n">knew</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">HDA_SUBDEV_AMP_FLAG</span><span class="p">;</span>
	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define via_add_control(spec, type, name, val) \</span>
<span class="cp">	__via_add_control(spec, type, name, 0, val)</span>

<span class="cp">#define via_clone_control(spec, tmpl) __via_clone_ctl(spec, tmpl, NULL)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_free_kctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">.</span><span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">kctl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_array_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* create input playback/capture controls for the given pin */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_new_analog_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ctlname</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">type_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mix_nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Playback Volume&quot;</span><span class="p">,</span> <span class="n">ctlname</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_idx</span><span class="p">,</span>
			      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">mix_nid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Playback Switch&quot;</span><span class="p">,</span> <span class="n">ctlname</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_ANALOG_MUTE</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_idx</span><span class="p">,</span>
			      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">mix_nid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define get_connection_index(codec, mux, nid) \</span>
<span class="cp">	snd_hda_get_conn_index(codec, mux, nid, 0)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_amp_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nid</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">HDA_INPUT</span><span class="p">)</span>
		<span class="n">caps</span> <span class="o">&amp;=</span> <span class="n">AC_WCAP_IN_AMP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">caps</span> <span class="o">&amp;=</span> <span class="n">AC_WCAP_OUT_AMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">caps</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define have_mute(codec, nid, dir) \</span>
<span class="cp">	check_amp_caps(codec, nid, dir, AC_AMPCAP_MUTE)</span>

<span class="cm">/* enable/disable the output-route mixers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_output_mix</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				<span class="n">hda_nid_t</span> <span class="n">mix_nid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">snd_hda_get_num_conns</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mix_nid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">AMP_IN_UNMUTE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">AMP_IN_MUTE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mix_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* enable/disable the output-route */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_output_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>			
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">have_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">))</span>
			<span class="n">activate_output_mix</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">vol_ctl</span> <span class="o">||</span> <span class="n">src</span> <span class="o">==</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">mute_ctl</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">have_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">AMP_OUT_UNMUTE</span> <span class="o">:</span> <span class="n">AMP_OUT_MUTE</span><span class="p">;</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* set the given pin as output */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_output_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">pin_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">pin_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_query_pin_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_PINCAP_EAPD</span><span class="p">)</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_EAPD_BTLENABLE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">init_output_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">pin_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_OUT_AMP</span><span class="p">)</span>
		<span class="n">caps</span> <span class="o">=</span> <span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_MUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_AMPCAP_OFFSET_SHIFT</span><span class="p">;</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
				    <span class="n">AMP_OUT_MUTE</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="cm">/* force on */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_multi_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_outs</span> <span class="o">+</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
			<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">;</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* deactivate the inactive headphone-paths */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">deactivate_hp_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="p">)</span>
			<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">shared</span><span class="p">],</span>
					     <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span> <span class="o">||</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_hp_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deactivate_hp_paths</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span><span class="p">)</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span> <span class="n">PIN_HP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_speaker_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_outs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">,</span> <span class="n">PIN_OUT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">,</span>
				     <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">,</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">via_auto_init_output</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">,</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">is_smart51_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">via_hp_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_analog_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">conn</span><span class="p">[</span><span class="n">HDA_MAX_CONNECTIONS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_conns</span><span class="p">;</span>

	<span class="cm">/* init ADCs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_IN_AMP</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_MUTE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
				    <span class="n">AMP_IN_UNMUTE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* init pins */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">is_smart51_pins</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span>
			<span class="n">ctl</span> <span class="o">=</span> <span class="n">PIN_OUT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ctl</span> <span class="o">=</span> <span class="n">PIN_IN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">AUTO_PIN_MIC</span><span class="p">)</span>
				<span class="n">ctl</span> <span class="o">|=</span> <span class="n">snd_hda_get_default_vref</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* init input-src */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">adc_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">adc_idx</span><span class="p">;</span>
		<span class="cm">/* secondary ADCs must have the unique MUX */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">adc_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mux_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">mux_idx</span><span class="p">;</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">adc_idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span>
					    <span class="n">mux_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* only one input-src */</span>
	<span class="p">}</span>

	<span class="cm">/* init aa-mixer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">num_conns</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
					    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_conns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">caps</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC_WID_PIN</span><span class="p">)</span>
			<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">AC_VERB_SET_AMP_GAIN_MUTE</span><span class="p">,</span>
					    <span class="n">AMP_IN_MUTE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">AC_VERB_GET_POWER_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">parm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_SET_POWER_STATE</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pin_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">affected_parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">def_conf</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">no_presence</span> <span class="o">=</span> <span class="p">(</span><span class="n">def_conf</span> <span class="o">&amp;</span> <span class="n">AC_DEFCFG_MISC</span><span class="p">)</span>
		<span class="o">&gt;&gt;</span> <span class="n">AC_DEFCFG_MISC_SHIFT</span>
		<span class="o">&amp;</span> <span class="n">AC_DEFCFG_MISC_NO_PRESENCE</span><span class="p">;</span> <span class="cm">/* do not support pin sense */</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">no_presence</span> <span class="o">|=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_presence</span><span class="p">)</span>
		<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">is_smart51_pins</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">no_presence</span> <span class="o">||</span> <span class="n">present</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">get_defcfg_connect</span><span class="p">(</span><span class="n">def_conf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AC_JACK_PORT_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">affected_parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span> <span class="cm">/* if it&#39;s connected */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>

	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_pin_power_ctl_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Disabled&quot;</span><span class="p">,</span> <span class="s">&quot;Enabled&quot;</span>
	<span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_pin_power_ctl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_pin_power_ctl_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">analog_low_current_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_pin_power_ctl_enum</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dynamic Power-Control&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">via_pin_power_ctl_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">via_pin_power_ctl_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">via_pin_power_ctl_put</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_independent_hp_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;OFF&quot;</span><span class="p">,</span> <span class="s">&quot;ON&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_independent_hp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* adjust spec-&gt;multiout setup according to the current flags */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_playback_multi_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">+</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">hp_nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* update DAC setups according to indep-HP switch;</span>
<span class="cm"> * this function is called only when indep-HP is modified</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_indep_hp_dacs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">shared_dac</span><span class="p">,</span> <span class="n">hp_dac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">opened_streams</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shared_dac</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">?</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hp_dac</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to indep-HP mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">hp_dac</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">__snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">shared_dac</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;</span> <span class="n">STREAM_INDEP_HP</span><span class="p">)</span>
			<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">hp_dac</span><span class="p">,</span>
						   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_hp_stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_hp_format</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* back to HP or shared-DAC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;</span> <span class="n">STREAM_INDEP_HP</span><span class="p">)</span>
			<span class="n">__snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">hp_dac</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shared_dac</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* reset mutli-ch DAC */</span>
				<span class="n">dac</span> <span class="o">=</span> <span class="n">shared_dac</span><span class="p">;</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* reset HP DAC */</span>
				<span class="n">dac</span> <span class="o">=</span> <span class="n">hp_dac</span><span class="p">;</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span>
						   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_dac_stream_tag</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
						   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_dac_format</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">setup_playback_multi_pcm</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_independent_hp_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="n">shared</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span> <span class="o">==</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="n">shared</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">;</span>
	<span class="n">deactivate_hp_paths</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="p">)</span>
			<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">shared</span><span class="p">],</span>
					     <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span> <span class="o">||</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
			<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span>
					     <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span>
					     <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">switch_indep_hp_dacs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>

	<span class="cm">/* update jack power state */</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_hp_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_hp_mixer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Independent HP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">via_independent_hp_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">via_independent_hp_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">via_independent_hp_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_hp_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">knew</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">knew</span> <span class="o">=</span> <span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_hp_mixer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">knew</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">HDA_SUBDEV_NID_FLAG</span> <span class="o">|</span> <span class="n">nid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_aa_path_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
		<span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Playback Volume&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">snd_hda_find_mixer_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					<span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mute_aa_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">mute</span> <span class="o">?</span> <span class="n">HDA_AMP_MUTE</span> <span class="o">:</span> <span class="n">HDA_AMP_UNMUTE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check AA path&#39;s mute status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">snd_hda_codec_amp_stereo</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span>
					 <span class="n">HDA_INPUT</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="n">HDA_AMP_MUTE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_smart51_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pin</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_smart51_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_smart51_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out_in</span> <span class="o">=</span> <span class="o">*</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span>
		<span class="o">?</span> <span class="n">AC_PINCTL_OUT_EN</span> <span class="o">:</span> <span class="n">AC_PINCTL_IN_EN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>

		<span class="n">parm</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">AC_VERB_GET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">parm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AC_PINCTL_IN_EN</span> <span class="o">|</span> <span class="n">AC_PINCTL_OUT_EN</span><span class="p">);</span>
		<span class="n">parm</span> <span class="o">|=</span> <span class="n">out_in</span><span class="p">;</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out_in</span> <span class="o">==</span> <span class="n">AC_PINCTL_OUT_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mute_aa_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">notify_aa_path_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span> <span class="o">=</span> <span class="o">*</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_smart51_mixer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Smart 5.1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ctl_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">via_smart51_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">via_smart51_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_smart51_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_smart51_mixer</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check AA path&#39;s mute status */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_aa_path_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hda_amp_list</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_loopbacks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">snd_hda_codec_amp_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span>
						   <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">HDA_AMP_MUTE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enter/exit analog low-current mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__analog_low_current_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verb</span><span class="p">,</span> <span class="n">parm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span><span class="p">)</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="n">is_aa_path_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">opened_streams</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">alc_mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">alc_mode</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="cm">/* decide low current mode&#39;s verb &amp; parameter */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT1708B_8CH</span>:
	<span class="k">case</span> <span class="n">VT1708B_4CH</span>:
		<span class="n">verb</span> <span class="o">=</span> <span class="mh">0xf70</span><span class="p">;</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* 0x02: 2/3x, 0x00: 1x */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT1708S</span>:
	<span class="k">case</span> <span class="n">VT1718S</span>:
	<span class="k">case</span> <span class="n">VT1716S</span>:
		<span class="n">verb</span> <span class="o">=</span> <span class="mh">0xf73</span><span class="p">;</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x51</span> <span class="o">:</span> <span class="mh">0xe1</span><span class="p">;</span> <span class="cm">/* 0x51: 4/28x, 0xe1: 1x */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT1702</span>:
		<span class="n">verb</span> <span class="o">=</span> <span class="mh">0xf73</span><span class="p">;</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x1d</span><span class="p">;</span> <span class="cm">/* 0x01: 4/40x, 0x1d: 1x */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT2002P</span>:
	<span class="k">case</span> <span class="n">VT1812</span>:
	<span class="k">case</span> <span class="n">VT1802</span>:
		<span class="n">verb</span> <span class="o">=</span> <span class="mh">0xf93</span><span class="p">;</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0xe0</span><span class="p">;</span> <span class="cm">/* 0x00: 4/40x, 0xe0: 1x */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* other codecs are not supported */</span>
	<span class="p">}</span>
	<span class="cm">/* send verb */</span>
	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">afg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">analog_low_current_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__analog_low_current_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generic initialization of ADC, input mixers and output mixers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1708_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* power down jack detect function */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf81</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_stream_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">opened_streams</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">opened_streams</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="n">analog_low_current_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_multi_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">+</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">set_stream_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_multi_out_analog_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span>
					    <span class="n">hinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_stream_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_multi_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_stream_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_hp_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">set_stream_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">STREAM_INDEP_HP</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_hp_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_stream_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">STREAM_INDEP_HP</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_multi_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">setup_playback_multi_pcm</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">snd_hda_multi_out_analog_prepare</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span>
					 <span class="n">format</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="cm">/* remember for dynamic DAC switch with indep-HP */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">|=</span> <span class="n">STREAM_MULTI_OUT</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_dac_stream_tag</span> <span class="o">=</span> <span class="n">stream_tag</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_dac_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_hp_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">,</span>
					   <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">|=</span> <span class="n">STREAM_INDEP_HP</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_hp_stream_tag</span> <span class="o">=</span> <span class="n">stream_tag</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_hp_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_multi_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">snd_hda_multi_out_analog_cleanup</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STREAM_MULTI_OUT</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_playback_hp_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">active_streams</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STREAM_INDEP_HP</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Digital out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dig_playback_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_open</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dig_playback_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_close</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dig_playback_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_multi_out_dig_prepare</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">,</span>
					     <span class="n">stream_tag</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dig_playback_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">snd_hda_multi_out_dig_cleanup</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analog capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_capture_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">],</span>
				   <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_capture_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* analog capture with dynamic ADC switching */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dyn_adc_capture_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream_tag</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adc_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">adc_idx</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">adc_idx</span><span class="p">];</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_stream_tag</span> <span class="o">=</span> <span class="n">stream_tag</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span> <span class="n">stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_dyn_adc_capture_pcm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="n">snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* re-setup the stream if running; called from input-src put */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">via_dyn_adc_pcm_resetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adc_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">cur</span><span class="p">].</span><span class="n">adc_idx</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">adc_idx</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">!=</span> <span class="n">adc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stream is running, let&#39;s swap the current ADC */</span>
		<span class="n">__snd_hda_codec_cleanup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc</span> <span class="o">=</span> <span class="n">adc</span><span class="p">;</span>
		<span class="n">snd_hda_codec_setup_stream</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">adc</span><span class="p">,</span>
					   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_stream_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_adc_format</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">config_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_analog_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_hp_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">via_playback_hp_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">via_playback_hp_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_playback_hp_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_playback_hp_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">vt1708_pcm_analog_s16_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="cm">/* We got noisy outputs on the right channel on VT1708 when</span>
<span class="cm">	 * 24bit samples are used.  Until any workaround is found,</span>
<span class="cm">	 * disable the 24bit format, so far.</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_playback_multi_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_analog_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* will be changed in via_build_pcms() */</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_capture_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_capture_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_dyn_adc_analog_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_dyn_adc_capture_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_dyn_adc_capture_pcm_cleanup</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_digital_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* NID is set in via_build_pcms */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">via_dig_playback_pcm_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">via_dig_playback_pcm_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">via_dig_playback_pcm_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">via_dig_playback_pcm_cleanup</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_pcm_stream</span> <span class="n">via_pcm_digital_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">substreams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * slave controls for virtual master</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">via_slave_pfxs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Front&quot;</span><span class="p">,</span> <span class="s">&quot;Surround&quot;</span><span class="p">,</span> <span class="s">&quot;Center&quot;</span><span class="p">,</span> <span class="s">&quot;LFE&quot;</span><span class="p">,</span> <span class="s">&quot;Side&quot;</span><span class="p">,</span>
	<span class="s">&quot;Headphone&quot;</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">no_pin_power_ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_pin_power_ctl_enum</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_mixers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_new_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">,</span>
						    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_share_sw</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">share_spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_create_spdif_in_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we have no master control, let&#39;s create it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hda_find_mixer_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vmaster_tlv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">snd_hda_set_vmaster_tlv</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">vmaster_tlv</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_vmaster</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
					  <span class="n">vmaster_tlv</span><span class="p">,</span> <span class="n">via_slave_pfxs</span><span class="p">,</span>
					  <span class="s">&quot;Playback Volume&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hda_find_mixer_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_vmaster</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="n">via_slave_pfxs</span><span class="p">,</span>
					  <span class="s">&quot;Playback Switch&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assign Capture Source enums to NID */</span>
	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_hda_find_mixer_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Input Source&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">kctl</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_add_nid</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">kctl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">via_free_kctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span> <span class="cm">/* no longer needed */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_jack_add_kctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hda_pcm</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_analog</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_analog</span><span class="p">),</span>
			 <span class="s">&quot;%s Analog&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_analog</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_playback</span><span class="p">)</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_playback</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">via_pcm_analog_playback</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span>
				<span class="o">*</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_playback</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">channels_max</span> <span class="o">=</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_capture</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span><span class="p">)</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_capture</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">via_pcm_dyn_adc_analog_capture</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_capture</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">via_pcm_analog_capture</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span>
				<span class="o">*</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_capture</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substreams</span> <span class="o">=</span>
					<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_digital</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_digital</span><span class="p">),</span>
			 <span class="s">&quot;%s Digital&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_digital</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="n">HDA_PCM_TYPE_SPDIF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_playback</span><span class="p">)</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_playback</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">via_pcm_digital_playback</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span>
				<span class="o">*</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_playback</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_capture</span><span class="p">)</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_capture</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">via_pcm_digital_capture</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span>
				<span class="o">*</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_digital_capture</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_hp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_hp</span><span class="p">),</span>
			 <span class="s">&quot;%s HP&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_name_hp</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">via_pcm_hp_playback</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">nid</span> <span class="o">=</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span><span class="p">;</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_pcms</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">via_free_kctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">vt1708_stop_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_vol</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_sw</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mute/unmute outputs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">toggle_output_mutes</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_pins</span><span class="p">,</span>
				<span class="n">hda_nid_t</span> <span class="o">*</span><span class="n">pins</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_pins</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">AC_VERB_GET_PIN_WIDGET_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parm</span> <span class="o">&amp;</span> <span class="n">AC_PINCTL_IN_EN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
			<span class="n">parm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_PINCTL_OUT_EN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">parm</span> <span class="o">|=</span> <span class="n">AC_PINCTL_OUT_EN</span><span class="p">;</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* mute internal speaker if line-out is plugged */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_line_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">present</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_outs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present</span><span class="p">)</span>
		<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
					      <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">toggle_output_mutes</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_outs</span><span class="p">,</span>
			    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_pins</span><span class="p">,</span>
			    <span class="n">present</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mute internal speaker if HP is plugged */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_hp_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nums</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span><span class="p">))</span>
		<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">nums</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_outs</span> <span class="o">+</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nums</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_outs</span><span class="p">;</span>
	<span class="n">toggle_output_mutes</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_out_pins</span><span class="p">,</span> <span class="n">present</span><span class="p">);</span>

	<span class="n">via_line_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">present</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_gpio_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol_counter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">master_vol</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">afg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">AC_VERB_GET_GPIO_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">vol_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">afg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="mh">0xF84</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">vol</span> <span class="o">=</span> <span class="n">vol_counter</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">master_vol</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">AC_VERB_GET_AMP_GAIN_MUTE</span><span class="p">,</span>
					<span class="n">AC_AMP_GET_INPUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_data</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmute line out */</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">PIN_OUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol_counter</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* decrease volume */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;</span> <span class="n">master_vol</span><span class="p">)</span>
				<span class="n">vol</span> <span class="o">=</span> <span class="n">master_vol</span><span class="p">;</span>
			<span class="n">snd_hda_codec_amp_stereo</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_AMP_VOLMASK</span><span class="p">,</span>
						 <span class="n">master_vol</span><span class="o">-</span><span class="n">vol</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* increase volume */</span>
			<span class="n">snd_hda_codec_amp_stereo</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">HDA_AMP_VOLMASK</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">master_vol</span><span class="o">+</span><span class="n">vol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x2A</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2A</span> <span class="o">:</span>
					  <span class="p">(</span><span class="n">master_vol</span><span class="o">+</span><span class="n">vol</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpio_data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* mute line out */</span>
		<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* unsolicited event for jack sensing */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span> <span class="o">&gt;&gt;=</span> <span class="mi">26</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">snd_hda_jack_get_action</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">VIA_JACK_EVENT</span><span class="p">)</span>
		<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_JACK_EVENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">VIA_HP_EVENT</span> <span class="o">||</span> <span class="n">res</span> <span class="o">==</span> <span class="n">VIA_LINE_EVENT</span><span class="p">)</span>
		<span class="n">via_hp_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">VIA_GPIO_EVENT</span><span class="p">)</span>
		<span class="n">via_gpio_control</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">vt1708_stop_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SND_HDA_POWER_SAVE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_check_power_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_hda_check_amp_list_power</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">via_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_ops</span> <span class="n">via_patch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">via_build_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_pcms</span> <span class="o">=</span> <span class="n">via_build_pcms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">via_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">via_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unsol_event</span> <span class="o">=</span> <span class="n">via_unsol_event</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">via_suspend</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SND_HDA_POWER_SAVE</span>
	<span class="p">.</span><span class="n">check_power_status</span> <span class="o">=</span> <span class="n">via_check_power_status</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_empty_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">dac</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span> <span class="o">==</span> <span class="n">dac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__parse_output_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span>
				<span class="n">hda_nid_t</span> <span class="n">target_dac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">with_aa_mix</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">conn</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nums</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nid</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">with_aa_mix</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">with_aa_mix</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* mark aa-mix is included */</span>
	<span class="p">}</span>

	<span class="n">nums</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">AC_WID_AUD_OUT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_dac</span> <span class="o">||</span> <span class="n">is_empty_dac</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="cm">/* aa-mix is requested but not included? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">&amp;&amp;</span> <span class="n">with_aa_mix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">MAX_NID_PATH_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AC_WID_AUD_OUT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">target_dac</span><span class="p">,</span>
					<span class="n">with_aa_mix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

 <span class="nl">found:</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nums</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span> <span class="o">!=</span> <span class="n">AC_WID_AUD_MIX</span><span class="p">)</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">parse_output_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span>
			      <span class="n">hda_nid_t</span> <span class="n">target_dac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">with_aa_mix</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">target_dac</span><span class="p">,</span> <span class="n">with_aa_mix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;output-path: depth=%d, %02x/%02x/%02x/%02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_fill_dac_nids</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dac_num</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">private_dac_nids</span><span class="p">;</span>
	<span class="n">dac_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">private_dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
			<span class="n">dac_num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">depth</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="n">dac_num</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_ch_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">chs</span><span class="p">,</span> <span class="n">bool</span> <span class="n">check_dac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">dac</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dac</span> <span class="o">=</span> <span class="n">check_dac</span> <span class="o">?</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">sel</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&amp;&amp;</span> <span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">sel</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Playback Volume&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">chs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">vol_ctl</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&amp;&amp;</span> <span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_MUTE</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_MUTE</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">,</span> <span class="n">AC_AMPCAP_MUTE</span><span class="p">))</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">sel</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Playback Switch&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_MUTE</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">chs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">mute_ctl</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mangle_smart51</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg_item</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pins</span><span class="p">[</span><span class="n">AUTO_CFG_MAX_INS</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">attr</span> <span class="o">=</span> <span class="n">INPUT_PIN_ATTR_REAR</span><span class="p">;</span> <span class="n">attr</span> <span class="o">&gt;=</span> <span class="n">INPUT_PIN_ATTR_NORMAL</span><span class="p">;</span> <span class="n">attr</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nums</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">AUTO_PIN_LINE_IN</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">def</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_hda_get_input_pin_attr</span><span class="p">(</span><span class="n">def</span><span class="p">)</span> <span class="o">!=</span> <span class="n">attr</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="p">[</span><span class="n">pins</span><span class="p">[</span><span class="n">j</span><span class="p">]].</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memmove</span><span class="p">(</span><span class="n">pins</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pins</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
						<span class="p">(</span><span class="n">nums</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="n">pins</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">nums</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">+</span> <span class="n">nums</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">ins</span><span class="p">[</span><span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">pin</span><span class="p">;</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_pins</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_path_mixer_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">vol_ctl</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">vol_ctl</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">mute_ctl</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">mute_ctl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* add playback controls from the parsed DAC table */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_create_multi_out_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">chname</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Front&quot;</span><span class="p">,</span> <span class="s">&quot;Surround&quot;</span><span class="p">,</span> <span class="s">&quot;C/LFE&quot;</span><span class="p">,</span> <span class="s">&quot;Side&quot;</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_line_outs</span><span class="p">;</span>

	<span class="cm">/* check smart51 */</span>
	<span class="n">old_line_outs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mangle_smart51</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_fill_dac_nids</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">=</span> <span class="n">old_line_outs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
		<span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span> <span class="o">||</span> <span class="o">!</span><span class="n">dac</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HDA_CLFE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_ch_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Center&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_ch_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;LFE&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span> <span class="o">=</span> <span class="n">chname</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_type</span> <span class="o">==</span> <span class="n">AUTO_PIN_SPEAKER_OUT</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pfx</span> <span class="o">=</span> <span class="s">&quot;Speaker&quot;</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_ch_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">!=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
			<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">get_connection_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span>
				   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* add control to mixer */</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">?</span>
			<span class="s">&quot;PCM Loopback Playback Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
							  <span class="n">idx</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">?</span>
			<span class="s">&quot;PCM Loopback Playback Switch&quot;</span> <span class="o">:</span> <span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_MUTE</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
							  <span class="n">idx</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span> <span class="o">=</span> <span class="n">old_line_outs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_create_hp_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">check_dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">HDA_SIDE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">HDA_CLFE</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">&amp;&amp;</span>
			    <span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
					      <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_shared</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* optionally check front-path w/o AA-mix */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
		<span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
				  <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">HDA_FRONT</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">HDA_FRONT</span><span class="p">],</span>
			       <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">;</span>
		<span class="n">check_dac</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">;</span>
		<span class="n">check_dac</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_ch_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Headphone&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">check_dac</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_dac</span><span class="p">)</span>
		<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
		<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_indep_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_create_speaker_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">check_dac</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pin</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">speaker_outs</span> <span class="o">||</span> <span class="o">!</span><span class="n">pin</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">))</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dac</span><span class="p">)</span>
		<span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
				  <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">HDA_FRONT</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dac_nids</span><span class="p">[</span><span class="n">HDA_FRONT</span><span class="p">],</span>
			       <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dac</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no AA-path for front? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_dac_nid</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">extra_out_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">;</span>
		<span class="n">check_dac</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">;</span>
		<span class="n">check_dac</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_ch_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">check_dac</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_dac</span><span class="p">)</span>
		<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">copy_path_mixer_ctls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define via_aamix_ctl_info	via_pin_power_ctl_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_aamix_ctl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_aamix_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_mix</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">nomix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nid_path</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_mix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nomix</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">activate_output_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nomix</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_aamix_ctl_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aamix_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* update front path */</span>
	<span class="n">update_aamix_paths</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">);</span>
	<span class="cm">/* update HP path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_aamix_paths</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_path</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* update speaker path */</span>
	<span class="n">update_aamix_paths</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_mix_path</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_aamix_ctl_enum</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Loopback Mixing&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">via_aamix_ctl_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">via_aamix_ctl_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">via_aamix_ctl_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_create_loopback_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no loopback switching available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">out_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">||</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">.</span><span class="n">depth</span> <span class="o">||</span>
	      <span class="n">spec</span><span class="o">-&gt;</span><span class="n">speaker_path</span><span class="p">.</span><span class="n">depth</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no loopback switching available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_aamix_ctl_enum</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* look for ADCs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_fill_adcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">start_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">nid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wcaps</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">wcaps</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AC_WID_AUD_IN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wcaps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_DIGITAL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wcaps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_CONN_LIST</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* input-src control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_mux_enum_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">].</span><span class="n">label</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_mux_enum_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_mux_enum_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hda_nid_t</span> <span class="n">mux</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">&gt;=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cur_mux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">adc_idx</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">cur</span><span class="p">].</span><span class="n">adc_idx</span><span class="p">;</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">adc_idx</span><span class="p">];</span>
		<span class="n">via_dyn_adc_pcm_resetup</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mux</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mux</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mux</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to D0 beofre change index */</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
		<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span>
				    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">cur</span><span class="p">].</span><span class="n">mux_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update jack power state */</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_input_src_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="cm">/* The multiple &quot;Capture Source&quot; controls confuse alsamixer</span>
<span class="cm">	 * So call somewhat different..</span>
<span class="cm">	 */</span>
	<span class="cm">/* .name = &quot;Capture Source&quot;, */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Input Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">via_mux_enum_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">via_mux_enum_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">via_mux_enum_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_input_src_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">knew</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no need for single src */</span>

	<span class="n">knew</span> <span class="o">=</span> <span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_input_src_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* add the powersave loopback-list entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_loopback_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_amp_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_loopbacks</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback_list</span> <span class="o">+</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_loopbacks</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">nid</span> <span class="o">=</span> <span class="n">mix</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">HDA_INPUT</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_loopbacks</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">.</span><span class="n">amplist</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">loopback_list</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_reachable_nid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">src</span><span class="p">,</span>
			     <span class="n">hda_nid_t</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_hda_get_conn_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* add the input-route to the given pin */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">add_input_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">].</span><span class="n">adc_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">].</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">get_connection_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
						   <span class="n">pin</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">].</span><span class="n">mux_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_reachable_nid</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">pin</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">].</span><span class="n">adc_idx</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="cm">/* Can primary ADC satisfy all inputs? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span> <span class="o">&amp;&amp;</span>
		    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">adc_idx</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_INFO</span>
				   <span class="s">&quot;via: dynamic ADC switching enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_mux_nids</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

<span class="cm">/* parse input-routes; fill ADCs, MUXs and input-src entries */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_analog_inputs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">via_fill_adcs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">get_mux_nids</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* fill all input-routes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">add_input_route</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="o">++</span><span class="p">].</span><span class="n">label</span> <span class="o">=</span>
				<span class="n">hda_get_autocfg_input_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check for internal loopback recording */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">&amp;&amp;</span>
	    <span class="n">add_input_route</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">))</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="o">++</span><span class="p">].</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Stereo Mixer&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create analog-loopback volume/switch controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_loopback_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prev_label</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span> <span class="o">=</span> <span class="n">hda_get_autocfg_input_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_label</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prev_label</span><span class="p">))</span>
			<span class="n">type_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prev_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">get_connection_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">via_new_analog_input</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">type_idx</span><span class="p">,</span>
						   <span class="n">idx</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">add_loopback_list</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* remember the label for smart51 control */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_nums</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_pins</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create mic-boost controls (if present) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_mic_boost_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prev_label</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AUTO_PIN_MIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">caps</span> <span class="o">=</span> <span class="n">query_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_AMPCAP_NUM_STEPS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">label</span> <span class="o">=</span> <span class="n">hda_get_autocfg_input_label</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_label</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prev_label</span><span class="p">))</span>
			<span class="n">type_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prev_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s Boost Volume&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_idx</span><span class="p">,</span>
			      <span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create capture and input-src controls for multiple streams */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_multi_adc_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create capture mixer elements */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">adc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_VOL</span><span class="p">,</span>
					<span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							    <span class="n">HDA_INPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__via_add_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">VIA_CTL_WIDGET_MUTE</span><span class="p">,</span>
					<span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							    <span class="n">HDA_INPUT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* input-source control */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_input_src_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* bind capture volume/switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_bind_cap_vol_ctl</span> <span class="o">=</span>
	<span class="n">HDA_BIND_VOL</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">via_bind_cap_sw_ctl</span> <span class="o">=</span>
	<span class="n">HDA_BIND_SW</span><span class="p">(</span><span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_bind_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">**</span><span class="n">ctl_ret</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">hda_ctl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_bind_ctls</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctl</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">HDA_COMPOSE_AMP_VAL</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ctl_ret</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create capture and input-src controls for dynamic ADC-switch case */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_dyn_adc_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">knew</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set up the bind capture ctls */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_bind_ctl</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_vol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_vol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_bind_ctl</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_sw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hda_bind_sw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create capture mixer elements */</span>
	<span class="n">knew</span> <span class="o">=</span> <span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_bind_cap_vol_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_vol</span><span class="p">;</span>

	<span class="n">knew</span> <span class="o">=</span> <span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_bind_cap_sw_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">knew</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">knew</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">bind_cap_sw</span><span class="p">;</span>

	<span class="cm">/* input-source control */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_input_src_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* parse and create capture-related stuff */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_auto_create_analog_input_ctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_analog_inputs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dyn_adc_switch</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">create_dyn_adc_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">create_multi_adc_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_loopback_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_mic_boost_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1708_set_pinconfig_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seqassoc</span><span class="p">;</span>

	<span class="n">def_conf</span> <span class="o">=</span> <span class="n">snd_hda_codec_get_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="n">seqassoc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">get_defcfg_association</span><span class="p">(</span><span class="n">def_conf</span><span class="p">);</span>
	<span class="n">seqassoc</span> <span class="o">=</span> <span class="p">(</span><span class="n">seqassoc</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">get_defcfg_sequence</span><span class="p">(</span><span class="n">def_conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_defcfg_connect</span><span class="p">(</span><span class="n">def_conf</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC_JACK_PORT_NONE</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">seqassoc</span> <span class="o">==</span> <span class="mh">0xf0</span> <span class="o">||</span> <span class="n">seqassoc</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">def_conf</span> <span class="o">=</span> <span class="n">def_conf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">AC_JACK_PORT_BOTH</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">));</span>
		<span class="n">snd_hda_codec_set_pincfg</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">def_conf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1708_jack_detect_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1708_jack_detect_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span> <span class="o">&amp;&amp;</span>
	    <span class="n">snd_hda_get_bool_hint</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;analog_loopback_hp_detect&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mute_aa_path</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">notify_aa_path_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">via_hp_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">vt1708_jack_detect_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Jack Detect&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ctl_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">vt1708_jack_detect_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">vt1708_jack_detect_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fill_dig_outs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fill_dig_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_parse_auto_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hda_parse_pin_def_config</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">line_outs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_create_multi_out_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_create_hp_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_create_speaker_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_create_loopback_switch</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_auto_create_analog_input_ctls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">max_channels</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">num_dacs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">fill_dig_outs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">fill_dig_in</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">.</span><span class="n">list</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mixers</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_mixers</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">kctls</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_dac_nid</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_mix_path</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">via_hp_build</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">via_smart51_build</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* assign slave outs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_dig_outs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span>
		<span class="n">init_output_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PIN_OUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">init_output_pin</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PIN_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_dig_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_hda_set_pin_ctl</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_in_pin</span><span class="p">,</span> <span class="n">PIN_IN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* initialize the unsolicited events */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_auto_init_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auto_pin_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					   <span class="n">VIA_HP_EVENT</span> <span class="o">|</span> <span class="n">VIA_JACK_EVENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speaker_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">VIA_LINE_EVENT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">line_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						   <span class="n">ev</span> <span class="o">|</span> <span class="n">VIA_JACK_EVENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_jack_detectable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">))</span>
			<span class="n">snd_hda_jack_detect_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin</span><span class="p">,</span>
						   <span class="n">VIA_JACK_EVENT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hda_sequence_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* init power states */</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">__analog_low_current_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">via_auto_init_multi_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_auto_init_hp_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_auto_init_speaker_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_auto_init_analog_input</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_auto_init_dig_outs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">via_auto_init_dig_in</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">via_auto_init_unsol_event</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">via_hp_automute</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">vt1708_update_hp_work</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">snd_hda_jack_report_sync</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1708_update_hp_jack_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">via_spec</span><span class="p">,</span>
					     <span class="n">vt1708_hp_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_hda_jack_set_dirty_all</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
	<span class="cm">/* if jack state toggled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_present</span>
	    <span class="o">!=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">hp_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_present</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">via_hp_automute</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_jack_detect</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_mux_nids</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_adc_nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">adc_nids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AC_WID_PIN</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
						    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mux_nids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nid</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1708</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">;</span>

	<span class="cm">/* Add HP and CD pin config connect bit re-config action */</span>
	<span class="n">vt1708_set_pinconfig_connect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VT1708_HP_PIN_NID</span><span class="p">);</span>
	<span class="n">vt1708_set_pinconfig_connect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">VT1708_CD_PIN_NID</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add jack detect on/off control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">via_clone_control</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vt1708_jack_detect_ctl</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* disable 32bit format on VT1708 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x11061708</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">stream_analog_playback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vt1708_pcm_analog_s16_playback</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1708_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">vt1708_hp_work</span><span class="p">,</span> <span class="n">vt1708_update_hp_jack_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1709</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt1708B</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imux_is_smixer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_8ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">VT1708B_4CH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="mh">0x11064397</span><span class="p">))</span>
		<span class="n">is_8ch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* SW0 (17h) = stereo mixer */</span>
	<span class="n">imux_is_smixer</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
	 <span class="o">==</span> <span class="p">((</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1708S</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 1/2/5 (1ah/1bh/1eh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imux_is_smixer</span><span class="p">)</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="cm">/* SW0 (17h), AIW 0/1 (13h/14h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* PW0 (19h), SW1 (18h), AOW1 (11h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW6 (22h), SW2 (26h), AOW2 (24h) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_8ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
			<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x11064397</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PW7(23h), SW2(27h), AOW2(25h) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
			<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PW 3/4/7 (1ch/1dh/23h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="cm">/* force to D0 for internal Speaker */</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_8ch</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* MW0 (16h), Sw3 (27h), AOW 0/3 (10h/25h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">imux_is_smixer</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_8ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x11064397</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">patch_vt1708S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1708B</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_codec_type</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">==</span> <span class="n">VT1708BCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">patch_vt1708S</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt1708B</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Patch for VT1708S */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1708S_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Enable Mic Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf98</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="cm">/* don&#39;t bybass mixer */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf88</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* fill out digital output widgets; one for master and one for slave outputs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_dig_outs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_outs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">conn</span><span class="p">;</span>

		<span class="n">nid</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_out_pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">multiout</span><span class="p">.</span><span class="n">dig_out_nid</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">slave_dig_outs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* at most two dig outs */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_dig_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">dig_nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_in_pin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dig_nid</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">start_nid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dig_nid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wcaps</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dig_nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">wcaps</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AC_WID_AUD_IN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wcaps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_DIGITAL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wcaps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_CONN_LIST</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_connection_index</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">dig_nid</span><span class="p">,</span>
					   <span class="n">spec</span><span class="o">-&gt;</span><span class="n">autocfg</span><span class="p">.</span><span class="n">dig_in_pin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dig_in_nid</span> <span class="o">=</span> <span class="n">dig_nid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">override_mic_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">hda_nid_t</span> <span class="n">pin</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_steps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">step_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_override_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_OFFSET_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">num_steps</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">step_size</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_STEP_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_MUTE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1708S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1708S_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="cm">/* correct names for VT1708BCE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_codec_type</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">==</span> <span class="n">VT1708BCE</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="s">&quot;VT1708BCE&quot;</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">),</span>
			 <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* correct names for VT1705 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x11064397</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="s">&quot;VT1705&quot;</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">),</span>
			 <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt1708B</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Patch for VT1702 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1702_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* mixer enable */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF88</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">},</span>
	<span class="cm">/* GPIO 0~2 */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF82</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt1702</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">imux_is_smixer</span> <span class="o">=</span>
	<span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 1/2/5 (14h/15h/18h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imux_is_smixer</span><span class="p">)</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span> <span class="cm">/* SW0 (13h) = stereo mixer (idx 3) */</span>
	<span class="cm">/* SW0 (13h), AIW 0/1/2 (12h/1fh/20h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* PW 3/4 (16h/17h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* MW0 (1ah), AOW 0/1 (10h/1dh) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">imux_is_smixer</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1702</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">;</span>

	<span class="cm">/* limit AA path volume to 0 dB */</span>
	<span class="n">snd_hda_override_amp_caps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">,</span>
				  <span class="p">(</span><span class="mh">0x17</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_OFFSET_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mh">0x17</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_NUM_STEPS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_STEP_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC_AMPCAP_MUTE_SHIFT</span><span class="p">));</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1702_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt1702</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Patch for VT1718S */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1718S_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Enable MW0 adjust Gain 5 */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">},</span>
	<span class="cm">/* Enable Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf88</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt1718S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imux_is_smixer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="cm">/* MUX6 (1eh) = stereo mixer */</span>
	<span class="n">imux_is_smixer</span> <span class="o">=</span>
	<span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 5/6/7 (29h/2ah/2bh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imux_is_smixer</span><span class="p">)</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="cm">/* MUX6/7 (1eh/1fh), AIW 0/1 (10h/11h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* PW3 (27h), MW2 (1ah), AOW3 (bh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW2 (26h), AOW2 (ah) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW0 (24h), AOW0 (8h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="cm">/* check for redirected HP */</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* MW9 (21h), Mw2 (1ah), AOW0 (8h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">imux_is_smixer</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW1 (25h), AOW1 (9h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PW4 (28h), MW3 (1bh), MUX1(34h), AOW4 (ch) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Add a connection to the primary DAC from AA-mixer for some codecs</span>
<span class="cm"> * This isn&#39;t listed from the raw info, but the chip has a secret connection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_secret_dac_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nums</span><span class="p">;</span>
	<span class="n">hda_nid_t</span> <span class="n">conn</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">hda_nid_t</span> <span class="n">nid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nums</span> <span class="o">=</span> <span class="n">snd_hda_get_connections</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">==</span> <span class="n">AC_WID_AUD_OUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find the primary DAC and add to the connection list */</span>
	<span class="n">nid</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">start_nid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">nid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span> <span class="o">=</span> <span class="n">get_wcaps</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_wcaps_type</span><span class="p">(</span><span class="n">caps</span><span class="p">)</span> <span class="o">==</span> <span class="n">AC_WID_AUD_OUT</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">AC_WCAP_DIGITAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">conn</span><span class="p">[</span><span class="n">nums</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snd_hda_override_conn_list</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
							  <span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span><span class="p">,</span>
							  <span class="n">nums</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1718S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">add_secret_dac_path</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1718S_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt1718S</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Patch for VT1716S */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1716s_dmic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1716s_dmic_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1716s_dmic_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">*</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="n">snd_hda_codec_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">AC_VERB_SET_CONNECT_SEL</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">dmic_enabled</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">set_widgets_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">vt1716s_dmic_mixer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDA_CODEC_VOLUME</span><span class="p">(</span><span class="s">&quot;Digital Mic Capture Volume&quot;</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">HDA_INPUT</span><span class="p">),</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Digital Mic Capture Switch&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">HDA_SUBDEV_NID_FLAG</span> <span class="o">|</span> <span class="mh">0x26</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">vt1716s_dmic_info</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">vt1716s_dmic_get</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">vt1716s_dmic_put</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{}</span>			<span class="cm">/* end */</span>
<span class="p">};</span>


<span class="cm">/* mono-out mixer elements */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">vt1716S_mono_out_mixer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDA_CODEC_MUTE</span><span class="p">(</span><span class="s">&quot;Mono Playback Switch&quot;</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">HDA_OUTPUT</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1716S_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Enable Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf8a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span>
	<span class="cm">/* don&#39;t bybass mixer */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf88</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">},</span>
	<span class="cm">/* Enable mono output */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xf90</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt1716S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imux_is_smixer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mono_out</span><span class="p">,</span> <span class="n">present</span><span class="p">;</span>
	<span class="cm">/* SW0 (17h) = stereo mixer */</span>
	<span class="n">imux_is_smixer</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">==</span>  <span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 1/2/5 (1ah/1bh/1eh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imux_is_smixer</span><span class="p">)</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="cm">/* SW0 (17h), AIW0(13h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* PW11 (22h) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">dmic_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>

	<span class="cm">/* SW2(26h), AIW1(14h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* PW0 (19h), SW1 (18h), AOW1 (11h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* Smart 5.1 PW2(1bh) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW7 (23h), SW3 (27h), AOW3 (25h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* Smart 5.1 PW1(1ah) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* Smart 5.1 PW5(1eh) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">smart51_enabled</span><span class="p">)</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* Mono out */</span>
	<span class="cm">/* SW4(28h)-&gt;MW1(29h)-&gt; PW12 (2ah)*/</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
		<span class="n">mono_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span> <span class="o">&amp;&amp;</span> <span class="n">present</span><span class="p">)</span>
			<span class="n">mono_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mono_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">mono_out</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW 3/4 (1ch/1dh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="cm">/* HP Independent Mode, power on AOW3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* force to D0 for internal Speaker */</span>
	<span class="cm">/* MW0 (16h), AOW0 (10h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">imux_is_smixer</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">mono_out</span> <span class="o">?</span> <span class="n">AC_PWRST_D0</span> <span class="o">:</span> <span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1716S</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span>  <span class="o">=</span> <span class="n">vt1716S_init_verbs</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mixers</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_mixers</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1716s_dmic_mixer</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_mixers</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mixers</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_mixers</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1716S_mono_out_mixer</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span> <span class="n">set_widgets_power_state_vt1716S</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* for vt2002P */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt2002P_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Class-D speaker related verbs */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfe0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfe9</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfe2</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span>
	<span class="cm">/* Enable Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb9</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">},</span>
	<span class="cm">/* Enable AOW0 to MW9 */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb8</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1802_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Enable Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb9</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">},</span>
	<span class="cm">/* Enable AOW0 to MW9 */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb8</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt2002P</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imux_is_smixer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">present</span><span class="p">;</span>
	<span class="cm">/* MUX9 (1eh) = stereo mixer */</span>
	<span class="n">imux_is_smixer</span> <span class="o">=</span>
	<span class="n">snd_hda_codec_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_VERB_GET_CONNECT_SEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 5/6/7 (29h/2ah/2bh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="cm">/* MUX9/10 (1eh/1fh), AIW 0/1 (10h/11h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* AOW0 (8h)*/</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1802</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PW4 (28h), MW4 (18h), MUX4(38h) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PW4 (26h), MW4 (1ch), MUX4(37h) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1802</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PW1 (25h), MW1 (15h), MUX1(35h), AOW1 (9h) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PW1 (25h), MW1 (19h), MUX1(35h), AOW1 (9h) */</span>
		<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
		<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>

	<span class="cm">/* Class-D */</span>
	<span class="cm">/* PW0 (24h), MW0(18h/14h), MUX0(34h) */</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>

	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">present</span> <span class="o">?</span> <span class="n">AC_PWRST_D3</span> <span class="o">:</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1802</span><span class="p">)</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* Mono Out */</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>

	<span class="n">parm</span> <span class="o">=</span> <span class="n">present</span> <span class="o">?</span> <span class="n">AC_PWRST_D3</span> <span class="o">:</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1802</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PW15 (33h), MW8(1ch), MUX8(3ch) */</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PW15 (31h), MW8(17h), MUX8(3bh) */</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* MW9 (21h) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imux_is_smixer</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_aa_path_mute</span><span class="p">(</span><span class="n">codec</span><span class="p">))</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* patch for vt2002P */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt2002P</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">add_secret_dac_path</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">VT1802</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt1802_init_verbs</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt2002P_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt2002P</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* for vt1812 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_verb</span> <span class="n">vt1812_init_verbs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Enable Boost Volume backdoor */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb9</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">},</span>
	<span class="cm">/* Enable AOW0 to MW9 */</span>
	<span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xfb8</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_widgets_power_state_vt1812</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">present</span><span class="p">;</span>
	<span class="cm">/* inputs */</span>
	<span class="cm">/* PW 5/6/7 (29h/2ah/2bh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D0</span><span class="p">;</span>
	<span class="cm">/* MUX10/11 (1eh/1fh), AIW 0/1 (10h/11h) */</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* AOW0 (8h)*/</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>

	<span class="cm">/* PW4 (28h), MW4 (18h), MUX4(38h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

	<span class="cm">/* PW1 (25h), MW1 (15h), MUX1(35h), AOW1 (9h) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">hp_independent_mode</span><span class="p">)</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>

	<span class="cm">/* Internal Speaker */</span>
	<span class="cm">/* PW0 (24h), MW0(14h), MUX0(34h) */</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>

	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/* Mono Out */</span>
	<span class="cm">/* PW13 (31h), MW13(1ch), MUX13(3ch), MW14(3eh) */</span>
	<span class="n">present</span> <span class="o">=</span> <span class="n">snd_hda_jack_detect</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="n">AC_PWRST_D3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
		<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="n">AC_PWRST_D0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PW15 (33h), MW15 (1dh), MUX15(3dh) */</span>
	<span class="n">parm</span> <span class="o">=</span> <span class="n">AC_PWRST_D3</span><span class="p">;</span>
	<span class="n">set_pin_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	<span class="n">update_power_state</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* patch for vt1812 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">patch_vt1812</span><span class="p">(</span><span class="k">struct</span> <span class="n">hda_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* create a codec specific record */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">via_new_spec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">aa_mix_nid</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">override_mic_boost</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">add_secret_dac_path</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* automatic parse from the BIOS config */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">via_parse_auto_config</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">init_verbs</span><span class="p">[</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_iverbs</span><span class="o">++</span><span class="p">]</span>  <span class="o">=</span> <span class="n">vt1812_init_verbs</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">patch_ops</span> <span class="o">=</span> <span class="n">via_patch_ops</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">set_widgets_power_state</span> <span class="o">=</span>  <span class="n">set_widgets_power_state_vt1812</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * patch entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hda_codec_preset</span> <span class="n">snd_hda_preset_via</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11061708</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11061709</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106170a</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106170b</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e710</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 10-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e711</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 10-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e712</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 10-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e713</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 10-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e714</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 6-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e715</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 6-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e716</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 6-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e717</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1709 6-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1709</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e720</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 8-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e721</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 8-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e722</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 8-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e723</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 8-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e724</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 4-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e725</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 4-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e726</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 4-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106e727</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708B 4-Ch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708B</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11061397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11062397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11063397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11064397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1705&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11065397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11066397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11067397</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1708S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11061398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11062398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11063398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11064398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11065398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11066398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11067398</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1702&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1702</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060428</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1718S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1718S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11064428</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1718S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1718S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060441</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT2020&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1718S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11064441</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1828S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1718S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060433</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1716S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1716S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1106a721</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1716S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1716S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060438</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT2002P&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt2002P</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11064438</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT2002P&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt2002P</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060448</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1812&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1812</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060440</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1818S&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt1708S</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11060446</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1802&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt2002P</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x11068446</span><span class="p">,</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VT1802&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch_vt2002P</span><span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;snd-hda-codec-id:1106*&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hda_codec_preset_list</span> <span class="n">via_list</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">preset</span> <span class="o">=</span> <span class="n">snd_hda_preset_via</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA HD-audio codec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">patch_via_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_hda_add_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">patch_via_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hda_delete_codec_preset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">patch_via_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">patch_via_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
