<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › oxygen › xonar_pcm179x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xonar_pcm179x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * card driver for models with PCM1796 DACs (Xonar D2/D2X/HDAV1.3/ST/STX)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) Clemens Ladisch &lt;clemens@ladisch.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this driver; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Xonar D2/D2X</span>
<span class="cm"> * ------------</span>
<span class="cm"> *</span>
<span class="cm"> * CMI8788:</span>
<span class="cm"> *</span>
<span class="cm"> *   SPI 0 -&gt; 1st PCM1796 (front)</span>
<span class="cm"> *   SPI 1 -&gt; 2nd PCM1796 (surround)</span>
<span class="cm"> *   SPI 2 -&gt; 3rd PCM1796 (center/LFE)</span>
<span class="cm"> *   SPI 4 -&gt; 4th PCM1796 (back)</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 2 -&gt; M0 of CS5381</span>
<span class="cm"> *   GPIO 3 -&gt; M1 of CS5381</span>
<span class="cm"> *   GPIO 5 &lt;- external power present (D2X only)</span>
<span class="cm"> *   GPIO 7 -&gt; ALT</span>
<span class="cm"> *   GPIO 8 -&gt; enable output to speakers</span>
<span class="cm"> *</span>
<span class="cm"> * CM9780:</span>
<span class="cm"> *</span>
<span class="cm"> *   LINE_OUT -&gt; input of ADC</span>
<span class="cm"> *</span>
<span class="cm"> *   AUX_IN   &lt;- aux</span>
<span class="cm"> *   VIDEO_IN &lt;- CD</span>
<span class="cm"> *   FMIC_IN  &lt;- mic</span>
<span class="cm"> *</span>
<span class="cm"> *   GPO 0 -&gt; route line-in (0) or AC97 output (1) to CS5381 input</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Xonar HDAV1.3 (Deluxe)</span>
<span class="cm"> * ----------------------</span>
<span class="cm"> *</span>
<span class="cm"> * CMI8788:</span>
<span class="cm"> *</span>
<span class="cm"> *   I²C &lt;-&gt; PCM1796 (addr 1001100) (front)</span>
<span class="cm"> *</span>
<span class="cm"> *   GPI 0 &lt;- external power present</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 0 -&gt; enable HDMI (0) or speaker (1) output</span>
<span class="cm"> *   GPIO 2 -&gt; M0 of CS5381</span>
<span class="cm"> *   GPIO 3 -&gt; M1 of CS5381</span>
<span class="cm"> *   GPIO 4 &lt;- daughterboard detection</span>
<span class="cm"> *   GPIO 5 &lt;- daughterboard detection</span>
<span class="cm"> *   GPIO 6 -&gt; ?</span>
<span class="cm"> *   GPIO 7 -&gt; ?</span>
<span class="cm"> *   GPIO 8 -&gt; route input jack to line-in (0) or mic-in (1)</span>
<span class="cm"> *</span>
<span class="cm"> *   UART &lt;-&gt; HDMI controller</span>
<span class="cm"> *</span>
<span class="cm"> * CM9780:</span>
<span class="cm"> *</span>
<span class="cm"> *   LINE_OUT -&gt; input of ADC</span>
<span class="cm"> *</span>
<span class="cm"> *   AUX_IN &lt;- aux</span>
<span class="cm"> *   CD_IN  &lt;- CD</span>
<span class="cm"> *   MIC_IN &lt;- mic</span>
<span class="cm"> *</span>
<span class="cm"> *   GPO 0 -&gt; route line-in (0) or AC97 output (1) to CS5381 input</span>
<span class="cm"> *</span>
<span class="cm"> * no daughterboard</span>
<span class="cm"> * ----------------</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 4 &lt;- 1</span>
<span class="cm"> *</span>
<span class="cm"> * H6 daughterboard</span>
<span class="cm"> * ----------------</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 4 &lt;- 0</span>
<span class="cm"> *   GPIO 5 &lt;- 0</span>
<span class="cm"> *</span>
<span class="cm"> *   I²C &lt;-&gt; PCM1796 (addr 1001101) (surround)</span>
<span class="cm"> *       &lt;-&gt; PCM1796 (addr 1001110) (center/LFE)</span>
<span class="cm"> *       &lt;-&gt; PCM1796 (addr 1001111) (back)</span>
<span class="cm"> *</span>
<span class="cm"> * unknown daughterboard</span>
<span class="cm"> * ---------------------</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 4 &lt;- 0</span>
<span class="cm"> *   GPIO 5 &lt;- 1</span>
<span class="cm"> *</span>
<span class="cm"> *   I²C &lt;-&gt; CS4362A (addr 0011000) (surround, center/LFE, back)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Xonar Essence ST (Deluxe)/STX</span>
<span class="cm"> * -----------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * CMI8788:</span>
<span class="cm"> *</span>
<span class="cm"> *   I²C &lt;-&gt; PCM1792A (addr 1001100)</span>
<span class="cm"> *       &lt;-&gt; CS2000 (addr 1001110) (ST only)</span>
<span class="cm"> *</span>
<span class="cm"> *   ADC1 MCLK -&gt; REF_CLK of CS2000 (ST only)</span>
<span class="cm"> *</span>
<span class="cm"> *   GPI 0 &lt;- external power present (STX only)</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 0 -&gt; enable output to speakers</span>
<span class="cm"> *   GPIO 1 -&gt; route HP to front panel (0) or rear jack (1)</span>
<span class="cm"> *   GPIO 2 -&gt; M0 of CS5381</span>
<span class="cm"> *   GPIO 3 -&gt; M1 of CS5381</span>
<span class="cm"> *   GPIO 4 &lt;- daughterboard detection</span>
<span class="cm"> *   GPIO 5 &lt;- daughterboard detection</span>
<span class="cm"> *   GPIO 6 -&gt; ?</span>
<span class="cm"> *   GPIO 7 -&gt; route output to speaker jacks (0) or HP (1)</span>
<span class="cm"> *   GPIO 8 -&gt; route input jack to line-in (0) or mic-in (1)</span>
<span class="cm"> *</span>
<span class="cm"> * PCM1792A:</span>
<span class="cm"> *</span>
<span class="cm"> *   SCK &lt;- CLK_OUT of CS2000 (ST only)</span>
<span class="cm"> *</span>
<span class="cm"> * CM9780:</span>
<span class="cm"> *</span>
<span class="cm"> *   LINE_OUT -&gt; input of ADC</span>
<span class="cm"> *</span>
<span class="cm"> *   AUX_IN &lt;- aux</span>
<span class="cm"> *   MIC_IN &lt;- mic</span>
<span class="cm"> *</span>
<span class="cm"> *   GPO 0 -&gt; route line-in (0) or AC97 output (1) to CS5381 input</span>
<span class="cm"> *</span>
<span class="cm"> * H6 daughterboard</span>
<span class="cm"> * ----------------</span>
<span class="cm"> *</span>
<span class="cm"> * GPIO 4 &lt;- 0</span>
<span class="cm"> * GPIO 5 &lt;- 0</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Xonar Xense</span>
<span class="cm"> * -----------</span>
<span class="cm"> *</span>
<span class="cm"> * CMI8788:</span>
<span class="cm"> *</span>
<span class="cm"> *   I²C &lt;-&gt; PCM1796 (addr 1001100) (front)</span>
<span class="cm"> *       &lt;-&gt; CS4362A (addr 0011000) (surround, center/LFE, back)</span>
<span class="cm"> *       &lt;-&gt; CS2000 (addr 1001110)</span>
<span class="cm"> *</span>
<span class="cm"> *   ADC1 MCLK -&gt; REF_CLK of CS2000</span>
<span class="cm"> *</span>
<span class="cm"> *   GPI 0 &lt;- external power present</span>
<span class="cm"> *</span>
<span class="cm"> *   GPIO 0 -&gt; enable output</span>
<span class="cm"> *   GPIO 1 -&gt; route HP to front panel (0) or rear jack (1)</span>
<span class="cm"> *   GPIO 2 -&gt; M0 of CS5381</span>
<span class="cm"> *   GPIO 3 -&gt; M1 of CS5381</span>
<span class="cm"> *   GPIO 4 -&gt; enable output</span>
<span class="cm"> *   GPIO 5 -&gt; enable output</span>
<span class="cm"> *   GPIO 6 -&gt; ?</span>
<span class="cm"> *   GPIO 7 -&gt; route output to HP (0) or speaker (1)</span>
<span class="cm"> *   GPIO 8 -&gt; route input jack to mic-in (0) or line-in (1)</span>
<span class="cm"> *</span>
<span class="cm"> * CM9780:</span>
<span class="cm"> *</span>
<span class="cm"> *   LINE_OUT -&gt; input of ADC</span>
<span class="cm"> *</span>
<span class="cm"> *   AUX_IN   &lt;- aux</span>
<span class="cm"> *   VIDEO_IN &lt;- ?</span>
<span class="cm"> *   FMIC_IN  &lt;- mic</span>
<span class="cm"> *</span>
<span class="cm"> *   GPO 0 -&gt; route line-in (0) or AC97 output (1) to CS5381 input</span>
<span class="cm"> *   GPO 1 -&gt; route mic-in from input jack (0) or front panel header (1)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &quot;xonar.h&quot;</span>
<span class="cp">#include &quot;cm9780.h&quot;</span>
<span class="cp">#include &quot;pcm1796.h&quot;</span>
<span class="cp">#include &quot;cs2000.h&quot;</span>


<span class="cp">#define GPIO_D2X_EXT_POWER	0x0020</span>
<span class="cp">#define GPIO_D2_ALT		0x0080</span>
<span class="cp">#define GPIO_D2_OUTPUT_ENABLE	0x0100</span>

<span class="cp">#define GPI_EXT_POWER		0x01</span>
<span class="cp">#define GPIO_INPUT_ROUTE	0x0100</span>

<span class="cp">#define GPIO_HDAV_OUTPUT_ENABLE	0x0001</span>
<span class="cp">#define GPIO_HDAV_MAGIC		0x00c0</span>

<span class="cp">#define GPIO_DB_MASK		0x0030</span>
<span class="cp">#define GPIO_DB_H6		0x0000</span>

<span class="cp">#define GPIO_ST_OUTPUT_ENABLE	0x0001</span>
<span class="cp">#define GPIO_ST_HP_REAR		0x0002</span>
<span class="cp">#define GPIO_ST_MAGIC		0x0040</span>
<span class="cp">#define GPIO_ST_HP		0x0080</span>

<span class="cp">#define I2C_DEVICE_PCM1796(i)	(0x98 + ((i) &lt;&lt; 1))	</span><span class="cm">/* 10011, ii, /W=0 */</span><span class="cp"></span>
<span class="cp">#define I2C_DEVICE_CS2000	0x9c			</span><span class="cm">/* 100111, 0, /W=0 */</span><span class="cp"></span>

<span class="cp">#define PCM1796_REG_BASE	16</span>


<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_generic</span> <span class="n">generic</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dacs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_rate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">h6</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hp_active</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">hp_gain_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_cs2000</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cs2000_regs</span><span class="p">[</span><span class="mh">0x1f</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">broken_i2c</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xonar_hdav</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="n">pcm179x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_hdmi</span> <span class="n">hdmi</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcm1796_write_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* maps ALSA channel pair number to SPI output */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">codec_map</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="n">oxygen_write_spi</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_SPI_TRIGGER</span>  <span class="o">|</span>
			 <span class="n">OXYGEN_SPI_DATA_LENGTH_2</span> <span class="o">|</span>
			 <span class="n">OXYGEN_SPI_CLOCK_160</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">codec_map</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">OXYGEN_SPI_CODEC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">OXYGEN_SPI_CEN_LATCH_CLOCK_HI</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcm1796_write_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">oxygen_write_i2c</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">I2C_DEVICE_PCM1796</span><span class="p">(</span><span class="n">codec</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm1796_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">function_flags</span> <span class="o">&amp;</span> <span class="n">OXYGEN_FUNCTION_2WIRE_SPI_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">OXYGEN_FUNCTION_SPI</span><span class="p">)</span>
		<span class="n">pcm1796_write_spi</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pcm1796_write_i2c</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">)</span>
	    <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="n">codec</span><span class="p">]))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="n">codec</span><span class="p">][</span><span class="n">reg</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm1796_write_cached</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="n">codec</span><span class="p">][</span><span class="n">reg</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">])</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs2000_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">oxygen_write_i2c</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">I2C_DEVICE_CS2000</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs2000_write_cached</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">reg</span><span class="p">])</span>
		<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm1796_registers_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">gain_offset</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">gain_offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_active</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set ATLD before ATL/ATR */</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">18</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]);</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dac_volume</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
			      <span class="o">+</span> <span class="n">gain_offset</span><span class="p">);</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dac_volume</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
			      <span class="o">+</span> <span class="n">gain_offset</span><span class="p">);</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]);</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">20</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]);</span>
		<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gain_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm1796_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">18</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">PCM1796_DMF_DISABLED</span> <span class="o">|</span> <span class="n">PCM1796_FMT_24_I2S</span> <span class="o">|</span> <span class="n">PCM1796_ATLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">broken_i2c</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">18</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PCM1796_MUTE</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">PCM1796_FLT_SHARP</span> <span class="o">|</span> <span class="n">PCM1796_ATS_1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">20</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">h6</span> <span class="o">?</span> <span class="n">PCM1796_OS_64</span> <span class="o">:</span> <span class="n">PCM1796_OS_128</span><span class="p">;</span>
	<span class="n">pcm1796_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_d2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">anti_pop_delay</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">output_enable_bit</span> <span class="o">=</span> <span class="n">GPIO_D2_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">pcm1796_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">oxygen_set_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span> <span class="n">GPIO_D2_ALT</span><span class="p">);</span>
	<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">,</span> <span class="n">GPIO_D2_ALT</span><span class="p">);</span>

	<span class="n">oxygen_ac97_set_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CM9780_JACK</span><span class="p">,</span> <span class="n">CM9780_FMIC2MIC</span><span class="p">);</span>

	<span class="n">xonar_init_cs53x1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;PCM1796&quot;</span><span class="p">);</span>
	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS5381&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_d2x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_int_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPIO_INTERRUPT_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_bit</span> <span class="o">=</span> <span class="n">GPIO_D2X_EXT_POWER</span><span class="p">;</span>
	<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span> <span class="n">GPIO_D2X_EXT_POWER</span><span class="p">);</span>
	<span class="n">xonar_init_ext_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_d2_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_hdav_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_hdav</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">oxygen_write16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_2WIRE_BUS_STATUS</span><span class="p">,</span>
		       <span class="n">OXYGEN_2WIRE_LENGTH_8</span> <span class="o">|</span>
		       <span class="n">OXYGEN_2WIRE_INTERRUPT_MASK</span> <span class="o">|</span>
		       <span class="n">OXYGEN_2WIRE_SPEED_STANDARD</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">anti_pop_delay</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">output_enable_bit</span> <span class="o">=</span> <span class="n">GPIO_HDAV_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPI_DATA</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_int_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPI_INTERRUPT_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_bit</span> <span class="o">=</span> <span class="n">GPI_EXT_POWER</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">dacs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm179x</span><span class="p">.</span><span class="n">h6</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">pcm1796_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">oxygen_set_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span>
			  <span class="n">GPIO_HDAV_MAGIC</span> <span class="o">|</span> <span class="n">GPIO_INPUT_ROUTE</span><span class="p">);</span>
	<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">,</span> <span class="n">GPIO_INPUT_ROUTE</span><span class="p">);</span>

	<span class="n">xonar_init_cs53x1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_init_ext_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_hdmi_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdmi</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;PCM1796&quot;</span><span class="p">);</span>
	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS5381&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_init_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">oxygen_write16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_2WIRE_BUS_STATUS</span><span class="p">,</span>
		       <span class="n">OXYGEN_2WIRE_LENGTH_8</span> <span class="o">|</span>
		       <span class="n">OXYGEN_2WIRE_INTERRUPT_MASK</span> <span class="o">|</span>
		       <span class="n">OXYGEN_2WIRE_SPEED_STANDARD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_init_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">output_enable_bit</span> <span class="o">=</span> <span class="n">GPIO_ST_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*-</span><span class="mi">18</span><span class="p">;</span>

	<span class="n">pcm1796_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">oxygen_set_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span>
			  <span class="n">GPIO_INPUT_ROUTE</span> <span class="o">|</span> <span class="n">GPIO_ST_HP_REAR</span> <span class="o">|</span>
			  <span class="n">GPIO_ST_MAGIC</span> <span class="o">|</span> <span class="n">GPIO_ST_HP</span><span class="p">);</span>
	<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">,</span>
			    <span class="n">GPIO_INPUT_ROUTE</span> <span class="o">|</span> <span class="n">GPIO_ST_HP_REAR</span> <span class="o">|</span> <span class="n">GPIO_ST_HP</span><span class="p">);</span>

	<span class="n">xonar_init_cs53x1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;PCM1792A&quot;</span><span class="p">);</span>
	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS5381&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs2000_registers_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_GLOBAL_CFG</span><span class="p">,</span> <span class="n">CS2000_FREEZE</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_DEV_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_DEV_CFG_1</span><span class="p">,</span>
		     <span class="n">CS2000_R_MOD_SEL_1</span> <span class="o">|</span>
		     <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS2000_R_SEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">CS2000_AUX_OUT_SRC_REF_CLK</span> <span class="o">|</span>
		     <span class="n">CS2000_EN_DEV_CFG_1</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_DEV_CFG_2</span><span class="p">,</span>
		     <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS2000_LOCK_CLK_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">CS2000_FRAC_N_SRC_STATIC</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_RATIO_0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* 1.0 */</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_RATIO_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_RATIO_0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_RATIO_0</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_FUN_CFG_1</span><span class="p">,</span>
		     <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">CS2000_FUN_CFG_1</span><span class="p">]);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_FUN_CFG_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cs2000_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_GLOBAL_CFG</span><span class="p">,</span> <span class="n">CS2000_EN_DEV_CFG_2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="cm">/* PLL lock delay */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">anti_pop_delay</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">h6</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_cs2000</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">CS2000_FUN_CFG_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS2000_REF_CLK_DIV_1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">broken_i2c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">oxygen_write16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_I2S_A_FORMAT</span><span class="p">,</span>
		       <span class="n">OXYGEN_RATE_48000</span> <span class="o">|</span>
		       <span class="n">OXYGEN_I2S_FORMAT_I2S</span> <span class="o">|</span>
		       <span class="n">OXYGEN_I2S_MCLK</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">h6</span> <span class="o">?</span> <span class="n">MCLK_256</span> <span class="o">:</span> <span class="n">MCLK_512</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">OXYGEN_I2S_BITS_16</span> <span class="o">|</span>
		       <span class="n">OXYGEN_I2S_MASTER</span> <span class="o">|</span>
		       <span class="n">OXYGEN_I2S_BCLK_64</span><span class="p">);</span>

	<span class="n">xonar_st_init_i2c</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">cs2000_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_st_init_common</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_component_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS2000&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_stx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">xonar_st_init_i2c</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">anti_pop_delay</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPI_DATA</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_int_reg</span> <span class="o">=</span> <span class="n">OXYGEN_GPI_INTERRUPT_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">ext_power_bit</span> <span class="o">=</span> <span class="n">GPI_EXT_POWER</span><span class="p">;</span>
	<span class="n">xonar_init_ext_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_st_init_common</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_d2_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_disable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_hdav_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_hdmi_cleanup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_disable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_disable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_d2_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_d2_cleanup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_hdav_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_hdav_cleanup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xonar_st_cleanup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_d2_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcm1796_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_hdav_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_hdav</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">pcm1796_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_hdmi_resume</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdmi</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_stx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcm1796_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_enable_output</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_st_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs2000_registers_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">xonar_stx_resume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_pcm1796_oversampling</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">h6</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PCM1796_OS_128</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PCM1796_OS_64</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">pcm1796_write_cached</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pcm1796_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">update_pcm1796_oversampling</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_pcm1796_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">gain_offset</span><span class="p">;</span>

	<span class="n">gain_offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_active</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcm1796_write_cached</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dac_volume</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
				     <span class="o">+</span> <span class="n">gain_offset</span><span class="p">);</span>
		<span class="n">pcm1796_write_cached</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dac_volume</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
				     <span class="o">+</span> <span class="n">gain_offset</span><span class="p">);</span>
		<span class="n">gain_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_pcm1796_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">PCM1796_DMF_DISABLED</span> <span class="o">|</span> <span class="n">PCM1796_FMT_24_I2S</span> <span class="o">|</span> <span class="n">PCM1796_ATLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dac_mute</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">PCM1796_MUTE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">pcm1796_write_cached</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_cs2000_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_mclk</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
	<span class="k">case</span> <span class="mi">64000</span>:
		<span class="n">rate_mclk</span> <span class="o">=</span> <span class="n">OXYGEN_RATE_32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
	<span class="k">case</span> <span class="mi">88200</span>:
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="n">rate_mclk</span> <span class="o">=</span> <span class="n">OXYGEN_RATE_44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">48000</span>:
	<span class="k">case</span> <span class="mi">96000</span>:
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="n">rate_mclk</span> <span class="o">=</span> <span class="n">OXYGEN_RATE_48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">h6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate_mclk</span> <span class="o">|=</span> <span class="n">OXYGEN_I2S_MCLK</span><span class="p">(</span><span class="n">MCLK_256</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">CS2000_REF_CLK_DIV_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rate_mclk</span> <span class="o">|=</span> <span class="n">OXYGEN_I2S_MCLK</span><span class="p">(</span><span class="n">MCLK_512</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">CS2000_REF_CLK_DIV_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oxygen_write16_masked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_I2S_A_FORMAT</span><span class="p">,</span> <span class="n">rate_mclk</span><span class="p">,</span>
			      <span class="n">OXYGEN_I2S_RATE_MASK</span> <span class="o">|</span> <span class="n">OXYGEN_I2S_MCLK_MASK</span><span class="p">);</span>
	<span class="n">cs2000_write_cached</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS2000_FUN_CFG_1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="cm">/* PLL lock delay */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_st_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">update_cs2000_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="n">set_pcm1796_params</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_hdav_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_hdav</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">set_pcm1796_params</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">xonar_set_hdmi_params</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">alt_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Analog Loopback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ctl_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">xonar_gpio_bit_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">xonar_gpio_bit_switch_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_D2_ALT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rolloff_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Sharp Roll-off&quot;</span><span class="p">,</span> <span class="s">&quot;Slow Roll-off&quot;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">snd_ctl_enum_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">names</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rolloff_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">]</span> <span class="o">&amp;</span>
		 <span class="n">PCM1796_FLT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCM1796_FLT_SHARP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rolloff_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">];</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM1796_FLT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCM1796_FLT_SHARP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCM1796_FLT_SLOW</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">19</span> <span class="o">-</span> <span class="n">PCM1796_REG_BASE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">pcm1796_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">rolloff_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DAC Filter Playback Enum&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">rolloff_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">rolloff_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">rolloff_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">hdav_hdmi_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HDMI Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ctl_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">xonar_gpio_bit_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">xonar_gpio_bit_switch_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_HDAV_OUTPUT_ENABLE</span> <span class="o">|</span> <span class="n">XONAR_GPIO_BIT_INVERT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_output_switch_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">names</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Speakers&quot;</span><span class="p">,</span> <span class="s">&quot;Headphones&quot;</span><span class="p">,</span> <span class="s">&quot;FP Headphones&quot;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">snd_ctl_enum_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">names</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_output_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">oxygen_read16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">GPIO_ST_HP</span><span class="p">))</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">GPIO_ST_HP_REAR</span><span class="p">)</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_output_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio_old</span><span class="p">,</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">gpio_old</span> <span class="o">=</span> <span class="n">oxygen_read16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">);</span>
	<span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio_old</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">gpio</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GPIO_ST_HP</span> <span class="o">|</span> <span class="n">GPIO_ST_HP_REAR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">gpio</span> <span class="o">|=</span> <span class="n">GPIO_ST_HP</span> <span class="o">|</span> <span class="n">GPIO_ST_HP_REAR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">|</span> <span class="n">GPIO_ST_HP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIO_ST_HP_REAR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oxygen_write16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_active</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">GPIO_ST_HP</span><span class="p">;</span>
	<span class="n">update_pcm1796_volume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gpio</span> <span class="o">!=</span> <span class="n">gpio_old</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_hp_volume_offset_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">names</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;&lt; 64 ohms&quot;</span><span class="p">,</span> <span class="s">&quot;64-300 ohms&quot;</span><span class="p">,</span> <span class="s">&quot;300-600 ohms&quot;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">snd_ctl_enum_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">names</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_hp_volume_offset_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*-</span><span class="mi">6</span><span class="p">)</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_hp_volume_offset_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="o">*-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">2</span><span class="o">*-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hp_gain_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">update_pcm1796_volume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">st_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Analog Output&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">st_output_switch_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">st_output_switch_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">st_output_switch_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphones Impedance Playback Enum&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">st_hp_volume_offset_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">st_hp_volume_offset_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">st_hp_volume_offset_put</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xonar_line_mic_ac97_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_LINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">oxygen_write16_masked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">,</span>
				      <span class="n">mute</span> <span class="o">?</span> <span class="n">GPIO_INPUT_ROUTE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">GPIO_INPUT_ROUTE</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">pcm1796_db_scale</span><span class="p">,</span> <span class="o">-</span><span class="mi">6000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xonar_d2_control_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">template</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">template</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CD Capture &quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
		<span class="cm">/* CD in is actually connected to the video in pin */</span>
		<span class="n">template</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">^=</span> <span class="n">AC97_CD</span> <span class="o">^</span> <span class="n">AC97_VIDEO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xonar_st_h6_control_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">template</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">template</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Master Playback &quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
		<span class="cm">/* no volume/mute, as I²C to the third DAC does not work */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_pcm1796_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">broken_i2c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				  <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rolloff_control</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xonar_d2_mixer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alt_switch</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">add_pcm1796_controls</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xonar_hdav_mixer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdav_hdmi_control</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">add_pcm1796_controls</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xonar_st_mixer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">st_controls</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				  <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">add_pcm1796_controls</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_pcm1796_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dac</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dac</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">PCM1796 %u:&quot;</span><span class="p">,</span> <span class="n">dac</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">pcm1796_regs</span><span class="p">[</span><span class="n">dac</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_cs2000_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xonar_pcm179x</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_cs2000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">CS2000:</span><span class="se">\n</span><span class="s">00:   &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">10:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs2000_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_st_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_pcm1796_registers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">dump_cs2000_registers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">oxygen_model</span> <span class="n">model_xonar_d2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s">&quot;Asus Virtuoso 200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;AV200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">xonar_d2_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">control_filter</span> <span class="o">=</span> <span class="n">xonar_d2_control_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">xonar_d2_mixer_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">xonar_d2_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">xonar_d2_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">xonar_d2_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dac_params</span> <span class="o">=</span> <span class="n">set_pcm1796_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_adc_params</span> <span class="o">=</span> <span class="n">xonar_set_cs53x1_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_volume</span> <span class="o">=</span> <span class="n">update_pcm1796_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_mute</span> <span class="o">=</span> <span class="n">update_pcm1796_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_registers</span> <span class="o">=</span> <span class="n">dump_pcm1796_registers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_tlv</span> <span class="o">=</span> <span class="n">pcm1796_db_scale</span><span class="p">,</span>
	<span class="p">.</span><span class="n">model_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xonar_pcm179x</span><span class="p">),</span>
	<span class="p">.</span><span class="n">device_config</span> <span class="o">=</span> <span class="n">PLAYBACK_0_TO_I2S</span> <span class="o">|</span>
			 <span class="n">PLAYBACK_1_TO_SPDIF</span> <span class="o">|</span>
			 <span class="n">CAPTURE_0_FROM_I2S_2</span> <span class="o">|</span>
			 <span class="n">CAPTURE_1_FROM_SPDIF</span> <span class="o">|</span>
			 <span class="n">MIDI_OUTPUT</span> <span class="o">|</span>
			 <span class="n">MIDI_INPUT</span> <span class="o">|</span>
			 <span class="n">AC97_CD_INPUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_pcm</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_min</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
	<span class="p">.</span><span class="n">misc_flags</span> <span class="o">=</span> <span class="n">OXYGEN_MISC_MIDI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">function_flags</span> <span class="o">=</span> <span class="n">OXYGEN_FUNCTION_SPI</span> <span class="o">|</span>
			  <span class="n">OXYGEN_FUNCTION_ENABLE_SPI_4_5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">adc_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dac_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_I2S</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adc_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_LJUST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">oxygen_model</span> <span class="n">model_xonar_hdav</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s">&quot;Asus Virtuoso 200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;AV200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">xonar_hdav_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">xonar_hdav_mixer_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">xonar_hdav_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">xonar_hdav_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">xonar_hdav_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_hardware_filter</span> <span class="o">=</span> <span class="n">xonar_hdmi_pcm_hardware_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dac_params</span> <span class="o">=</span> <span class="n">set_hdav_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_adc_params</span> <span class="o">=</span> <span class="n">xonar_set_cs53x1_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_volume</span> <span class="o">=</span> <span class="n">update_pcm1796_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_mute</span> <span class="o">=</span> <span class="n">update_pcm1796_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart_input</span> <span class="o">=</span> <span class="n">xonar_hdmi_uart_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ac97_switch</span> <span class="o">=</span> <span class="n">xonar_line_mic_ac97_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_registers</span> <span class="o">=</span> <span class="n">dump_pcm1796_registers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_tlv</span> <span class="o">=</span> <span class="n">pcm1796_db_scale</span><span class="p">,</span>
	<span class="p">.</span><span class="n">model_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xonar_hdav</span><span class="p">),</span>
	<span class="p">.</span><span class="n">device_config</span> <span class="o">=</span> <span class="n">PLAYBACK_0_TO_I2S</span> <span class="o">|</span>
			 <span class="n">PLAYBACK_1_TO_SPDIF</span> <span class="o">|</span>
			 <span class="n">CAPTURE_0_FROM_I2S_2</span> <span class="o">|</span>
			 <span class="n">CAPTURE_1_FROM_SPDIF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_pcm</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_min</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
	<span class="p">.</span><span class="n">misc_flags</span> <span class="o">=</span> <span class="n">OXYGEN_MISC_MIDI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">function_flags</span> <span class="o">=</span> <span class="n">OXYGEN_FUNCTION_2WIRE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">adc_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dac_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_I2S</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adc_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_LJUST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">oxygen_model</span> <span class="n">model_xonar_st</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s">&quot;Asus Virtuoso 100&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;AV200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">xonar_st_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">xonar_st_mixer_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">xonar_st_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">xonar_st_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">xonar_st_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dac_params</span> <span class="o">=</span> <span class="n">set_st_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_adc_params</span> <span class="o">=</span> <span class="n">xonar_set_cs53x1_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_volume</span> <span class="o">=</span> <span class="n">update_pcm1796_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_dac_mute</span> <span class="o">=</span> <span class="n">update_pcm1796_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ac97_switch</span> <span class="o">=</span> <span class="n">xonar_line_mic_ac97_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_registers</span> <span class="o">=</span> <span class="n">dump_st_registers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_tlv</span> <span class="o">=</span> <span class="n">pcm1796_db_scale</span><span class="p">,</span>
	<span class="p">.</span><span class="n">model_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xonar_pcm179x</span><span class="p">),</span>
	<span class="p">.</span><span class="n">device_config</span> <span class="o">=</span> <span class="n">PLAYBACK_0_TO_I2S</span> <span class="o">|</span>
			 <span class="n">PLAYBACK_1_TO_SPDIF</span> <span class="o">|</span>
			 <span class="n">CAPTURE_0_FROM_I2S_2</span> <span class="o">|</span>
			 <span class="n">CAPTURE_1_FROM_SPDIF</span> <span class="o">|</span>
			 <span class="n">AC97_FMIC_SWITCH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_pcm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_min</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_volume_max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
	<span class="p">.</span><span class="n">function_flags</span> <span class="o">=</span> <span class="n">OXYGEN_FUNCTION_2WIRE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dac_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">adc_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dac_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_I2S</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adc_i2s_format</span> <span class="o">=</span> <span class="n">OXYGEN_I2S_FORMAT_LJUST</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_xonar_pcm179x_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">oxygen</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x8269</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_xonar_d2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar D2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x82b7</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_xonar_d2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar D2X&quot;</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">xonar_d2x_init</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8314</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_xonar_hdav</span><span class="p">;</span>
		<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span> <span class="n">GPIO_DB_MASK</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">oxygen_read16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GPIO_DB_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar HDAV1.3&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GPIO_DB_H6</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar HDAV1.3+H6&quot;</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x835d</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_xonar_st</span><span class="p">;</span>
		<span class="n">oxygen_clear_bits16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_CONTROL</span><span class="p">,</span> <span class="n">GPIO_DB_MASK</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">oxygen_read16</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OXYGEN_GPIO_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GPIO_DB_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar ST&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GPIO_DB_H6</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar ST+H6&quot;</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">control_filter</span> <span class="o">=</span> <span class="n">xonar_st_h6_control_filter</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_pcm</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_channels_mixer</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_volume_min</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">dac_mclks</span> <span class="o">=</span> <span class="n">OXYGEN_MCLKS</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x835c</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_xonar_st</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="s">&quot;Xonar STX&quot;</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">xonar_stx_init</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">xonar_stx_resume</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">.</span><span class="n">set_dac_params</span> <span class="o">=</span> <span class="n">set_pcm1796_params</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
