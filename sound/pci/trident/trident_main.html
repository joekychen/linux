<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › trident › trident_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>trident_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Maintained by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *  Originated by audio@tridentmicro.com</span>
<span class="cm"> *  Fri Feb 19 15:55:28 MST 1999</span>
<span class="cm"> *  Routines for control of Trident 4DWave (DX and NX) chip</span>
<span class="cm"> *</span>
<span class="cm"> *  BUGS:</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *    ---</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  SiS7018 S/PDIF support by Thomas Winischhofer &lt;thomas@winischhofer.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/trident.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_trident_pcm_mixer_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_trident_pcm_mixer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_trident_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_trident_sis_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_trident_clear_voices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">v_min</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">v_max</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_trident_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  common I/O routines</span>
<span class="cm"> */</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void snd_trident_print_voice_regs(struct snd_trident *trident, int voice)</span>
<span class="c">{</span>
<span class="c">	unsigned int val, tmp;</span>

<span class="c">	printk(KERN_DEBUG &quot;Trident voice %i:\n&quot;, voice);</span>
<span class="c">	outb(voice, TRID_REG(trident, T4D_LFO_GC_CIR));</span>
<span class="c">	val = inl(TRID_REG(trident, CH_LBA));</span>
<span class="c">	printk(KERN_DEBUG &quot;LBA: 0x%x\n&quot;, val);</span>
<span class="c">	val = inl(TRID_REG(trident, CH_GVSEL_PAN_VOL_CTRL_EC));</span>
<span class="c">	printk(KERN_DEBUG &quot;GVSel: %i\n&quot;, val &gt;&gt; 31);</span>
<span class="c">	printk(KERN_DEBUG &quot;Pan: 0x%x\n&quot;, (val &gt;&gt; 24) &amp; 0x7f);</span>
<span class="c">	printk(KERN_DEBUG &quot;Vol: 0x%x\n&quot;, (val &gt;&gt; 16) &amp; 0xff);</span>
<span class="c">	printk(KERN_DEBUG &quot;CTRL: 0x%x\n&quot;, (val &gt;&gt; 12) &amp; 0x0f);</span>
<span class="c">	printk(KERN_DEBUG &quot;EC: 0x%x\n&quot;, val &amp; 0x0fff);</span>
<span class="c">	if (trident-&gt;device != TRIDENT_DEVICE_ID_NX) {</span>
<span class="c">		val = inl(TRID_REG(trident, CH_DX_CSO_ALPHA_FMS));</span>
<span class="c">		printk(KERN_DEBUG &quot;CSO: 0x%x\n&quot;, val &gt;&gt; 16);</span>
<span class="c">		printk(&quot;Alpha: 0x%x\n&quot;, (val &gt;&gt; 4) &amp; 0x0fff);</span>
<span class="c">		printk(KERN_DEBUG &quot;FMS: 0x%x\n&quot;, val &amp; 0x0f);</span>
<span class="c">		val = inl(TRID_REG(trident, CH_DX_ESO_DELTA));</span>
<span class="c">		printk(KERN_DEBUG &quot;ESO: 0x%x\n&quot;, val &gt;&gt; 16);</span>
<span class="c">		printk(KERN_DEBUG &quot;Delta: 0x%x\n&quot;, val &amp; 0xffff);</span>
<span class="c">		val = inl(TRID_REG(trident, CH_DX_FMC_RVOL_CVOL));</span>
<span class="c">	} else {		// TRIDENT_DEVICE_ID_NX</span>
<span class="c">		val = inl(TRID_REG(trident, CH_NX_DELTA_CSO));</span>
<span class="c">		tmp = (val &gt;&gt; 24) &amp; 0xff;</span>
<span class="c">		printk(KERN_DEBUG &quot;CSO: 0x%x\n&quot;, val &amp; 0x00ffffff);</span>
<span class="c">		val = inl(TRID_REG(trident, CH_NX_DELTA_ESO));</span>
<span class="c">		tmp |= (val &gt;&gt; 16) &amp; 0xff00;</span>
<span class="c">		printk(KERN_DEBUG &quot;Delta: 0x%x\n&quot;, tmp);</span>
<span class="c">		printk(KERN_DEBUG &quot;ESO: 0x%x\n&quot;, val &amp; 0x00ffffff);</span>
<span class="c">		val = inl(TRID_REG(trident, CH_NX_ALPHA_FMS_FMC_RVOL_CVOL));</span>
<span class="c">		printk(KERN_DEBUG &quot;Alpha: 0x%x\n&quot;, val &gt;&gt; 20);</span>
<span class="c">		printk(KERN_DEBUG &quot;FMS: 0x%x\n&quot;, (val &gt;&gt; 16) &amp; 0x0f);</span>
<span class="c">	}</span>
<span class="c">	printk(KERN_DEBUG &quot;FMC: 0x%x\n&quot;, (val &gt;&gt; 14) &amp; 3);</span>
<span class="c">	printk(KERN_DEBUG &quot;RVol: 0x%x\n&quot;, (val &gt;&gt; 7) &amp; 0x7f);</span>
<span class="c">	printk(KERN_DEBUG &quot;CVol: 0x%x\n&quot;, val &amp; 0x7f);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   unsigned short snd_trident_codec_read(struct snd_ac97 *ac97, unsigned short reg)</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will do all of the reading from the external</span>
<span class="cm">                CODEC (AC97).</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  ac97 - ac97 codec structure</span>
<span class="cm">                reg - CODEC register index, from AC97 Hal.</span>
<span class="cm"> </span>
<span class="cm">   returns:     16 bit value read from the AC97.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_trident_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">treg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_DX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">DX_AC97_BUSY_READ</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR1_AC97_R</span><span class="p">));</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR1_AC97_R</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">DX_AC97_BUSY_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">NX_AC97_BUSY_READ</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">));</span>
		<span class="n">treg</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">NX_ACR2_AC97_R_PRIMARY</span> <span class="o">:</span> <span class="n">NX_ACR3_AC97_R_SECONDARY</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">treg</span><span class="p">));</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">treg</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00000C00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">SI_AC97_BUSY_READ</span> <span class="o">|</span> <span class="n">SI_AC97_AUDIO_BUSY</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SI_AC97_SECONDARY</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_AC97_READ</span><span class="p">));</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_AC97_READ</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SI_AC97_BUSY_READ</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_detect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ac97 codec read TIMEOUT [0x%x/0x%x]!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   void snd_trident_codec_write(struct snd_ac97 *ac97, unsigned short reg,</span>
<span class="cm">   unsigned short wdata)</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will do all of the writing to the external</span>
<span class="cm">                CODEC (AC97).</span>
<span class="cm">  </span>
<span class="cm">   Parameters:	ac97 - ac97 codec structure</span>
<span class="cm">   	        reg - CODEC register index, from AC97 Hal.</span>
<span class="cm">                data  - Lower 16 bits are the data to write to CODEC.</span>
<span class="cm">  </span>
<span class="cm">   returns:     TRUE if everything went ok, else FALSE.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wdata</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_DX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">DX_ACR0_AC97_W</span><span class="p">;</span>

		<span class="cm">/* read AC-97 write register status */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DX_AC97_BUSY_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DX_AC97_BUSY_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">NX_ACR1_AC97_W</span><span class="p">;</span>

		<span class="cm">/* read AC-97 write register status */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">NX_AC97_BUSY_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NX_AC97_BUSY_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">SI_AC97_WRITE</span><span class="p">;</span>

		<span class="cm">/* read AC-97 write register status */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SI_AC97_BUSY_WRITE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">|=</span> <span class="n">SI_AC97_BUSY_WRITE</span> <span class="o">|</span> <span class="n">SI_AC97_AUDIO_BUSY</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SI_AC97_SECONDARY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* keep GCC happy */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">address</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   void snd_trident_enable_eso(struct snd_trident *trident)</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will enable end of loop interrupts.</span>
<span class="cm">                End of loop interrupts will occur when a running</span>
<span class="cm">                channel reaches ESO.</span>
<span class="cm">                Also enables middle of loop interrupts.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_enable_eso</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ENDLP_IE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MIDLP_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BANK_B_EN</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   void snd_trident_disable_eso(struct snd_trident *trident)</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will disable end of loop interrupts.</span>
<span class="cm">                End of loop interrupts will occur when a running</span>
<span class="cm">                channel reaches ESO.</span>
<span class="cm">                Also disables middle of loop interrupts.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  </span>
<span class="cm">                trident - pointer to target device class for 4DWave.</span>
<span class="cm">  </span>
<span class="cm">   returns:     TRUE if everything went ok, else FALSE.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_disable_eso</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENDLP_IE</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDLP_IE</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   void snd_trident_start_voice(struct snd_trident * trident, unsigned int voice)</span>

<span class="cm">    Description: Start a voice, any channel 0 thru 63.</span>
<span class="cm">                 This routine automatically handles the fact that there are</span>
<span class="cm">                 more than 32 channels available.</span>

<span class="cm">    Parameters : voice - Voice number 0 thru n.</span>
<span class="cm">                 trident - pointer to target device class for 4DWave.</span>

<span class="cm">    Return Value: None.</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">void</span> <span class="nf">snd_trident_start_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">voice</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="n">T4D_START_B</span> <span class="o">:</span> <span class="n">T4D_START_A</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_trident_start_voice</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   void snd_trident_stop_voice(struct snd_trident * trident, unsigned int voice)</span>

<span class="cm">    Description: Stop a voice, any channel 0 thru 63.</span>
<span class="cm">                 This routine automatically handles the fact that there are</span>
<span class="cm">                 more than 32 channels available.</span>

<span class="cm">    Parameters : voice - Voice number 0 thru n.</span>
<span class="cm">                 trident - pointer to target device class for 4DWave.</span>

<span class="cm">    Return Value: None.</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">void</span> <span class="nf">snd_trident_stop_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">voice</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="n">T4D_STOP_B</span> <span class="o">:</span> <span class="n">T4D_STOP_A</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_trident_stop_voice</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    int snd_trident_allocate_pcm_channel(struct snd_trident *trident)</span>
<span class="cm">  </span>
<span class="cm">    Description: Allocate hardware channel in Bank B (32-63).</span>
<span class="cm">  </span>
<span class="cm">    Parameters :  trident - pointer to target device class for 4DWave.</span>
<span class="cm">  </span>
<span class="cm">    Return Value: hardware channel - 32-63 or -1 when no channel is available</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_allocate_pcm_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCMcnt</span> <span class="o">&gt;=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_B</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCMcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    void snd_trident_free_pcm_channel(int channel)</span>
<span class="cm">  </span>
<span class="cm">    Description: Free hardware channel in Bank B (32-63)</span>
<span class="cm">  </span>
<span class="cm">    Parameters :  trident - pointer to target device class for 4DWave.</span>
<span class="cm">	          channel - hardware channel number 0-63</span>
<span class="cm">  </span>
<span class="cm">    Return Value: none</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_free_pcm_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCMcnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    unsigned int snd_trident_allocate_synth_channel(void)</span>
<span class="cm">  </span>
<span class="cm">    Description: Allocate hardware channel in Bank A (0-31).</span>
<span class="cm">  </span>
<span class="cm">    Parameters :  trident - pointer to target device class for 4DWave.</span>
<span class="cm">  </span>
<span class="cm">    Return Value: hardware channel - 0-31 or -1 when no channel is available</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_allocate_synth_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_A</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_A</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">ChanSynthCount</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    void snd_trident_free_synth_channel( int channel )</span>
<span class="cm">  </span>
<span class="cm">    Description: Free hardware channel in Bank B (0-31).</span>
<span class="cm">  </span>
<span class="cm">    Parameters :  trident - pointer to target device class for 4DWave.</span>
<span class="cm">	          channel - hardware channel number 0-63</span>
<span class="cm">  </span>
<span class="cm">    Return Value: none</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_free_synth_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_A</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanMap</span><span class="p">[</span><span class="n">T4D_BANK_A</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">ChanSynthCount</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_voice_regs</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will complete and write the 5 hardware channel</span>
<span class="cm">                registers to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                Each register field.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">void</span> <span class="nf">snd_trident_write_voice_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FmcRvolCvol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">;</span>
	<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">&amp;</span> <span class="mh">0x0000007f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">FmcRvolCvol</span> <span class="o">=</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span>
	              <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	              <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span>:
		<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="o">?</span>
				<span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">&amp;</span> <span class="mh">0x000003ff</span><span class="p">)</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">&amp;</span> <span class="mh">0x00003fc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FmcRvolCvol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_DX</span>:
		<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">&amp;</span> <span class="mh">0x000003fc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FmcRvolCvol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_NX</span>:
		<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">&amp;</span> <span class="mh">0x000003fc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FmcRvolCvol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_START</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_START</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_START</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_START</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_START</span> <span class="o">+</span> <span class="mi">16</span><span class="p">));</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;written %i channel:\n&quot;, voice-&gt;number);</span>
<span class="c">	printk(KERN_DEBUG &quot;  regs[0] = 0x%x/0x%x\n&quot;,</span>
<span class="c">	       regs[0], inl(TRID_REG(trident, CH_START + 0)));</span>
<span class="c">	printk(KERN_DEBUG &quot;  regs[1] = 0x%x/0x%x\n&quot;,</span>
<span class="c">	       regs[1], inl(TRID_REG(trident, CH_START + 4)));</span>
<span class="c">	printk(KERN_DEBUG &quot;  regs[2] = 0x%x/0x%x\n&quot;,</span>
<span class="c">	       regs[2], inl(TRID_REG(trident, CH_START + 8)));</span>
<span class="c">	printk(KERN_DEBUG &quot;  regs[3] = 0x%x/0x%x\n&quot;,</span>
<span class="c">	       regs[3], inl(TRID_REG(trident, CH_START + 12)));</span>
<span class="c">	printk(KERN_DEBUG &quot;  regs[4] = 0x%x/0x%x\n&quot;,</span>
<span class="c">	       regs[4], inl(TRID_REG(trident, CH_START + 16)));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_trident_write_voice_regs</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_cso_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new CSO offset</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                CSO - new CSO value</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_cso_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CSO</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="n">CSO</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_DX_CSO_ALPHA_FMS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_NX_DELTA_CSO</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_eso_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new ESO offset</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                ESO - new ESO value</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_eso_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ESO</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">ESO</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_DX_ESO_DELTA</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">),</span>
		     <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_NX_DELTA_ESO</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_vol_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new voice volume</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                Vol - new voice volume</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_vol_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="n">Vol</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_DX</span>:
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_NX</span>:
		<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_GVSEL_PAN_VOL_CTRL_EC</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span>:
		<span class="cm">/* printk(KERN_DEBUG &quot;voice-&gt;Vol = 0x%x\n&quot;, voice-&gt;Vol); */</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span><span class="p">,</span>
		     <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_GVSEL_PAN_VOL_CTRL_EC</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_pan_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new voice pan</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                Pan - new pan value</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_pan_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Pan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="n">Pan</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">),</span>
	     <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_GVSEL_PAN_VOL_CTRL_EC</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_rvol_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new reverb volume</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                RVol - new reverb volume</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_rvol_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">RVol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">RVol</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">),</span>
	     <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span> <span class="o">?</span>
		      <span class="n">CH_NX_ALPHA_FMS_FMC_RVOL_CVOL</span> <span class="o">:</span> <span class="n">CH_DX_FMC_RVOL_CVOL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_write_cvol_reg</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will write the new chorus volume</span>
<span class="cm">                register to hardware.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                voice - synthesizer voice structure</span>
<span class="cm">                CVol - new chorus volume</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_write_cvol_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CVol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="n">CVol</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">),</span>
	     <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span> <span class="o">?</span>
		      <span class="n">CH_NX_ALPHA_FMS_FMC_RVOL_CVOL</span> <span class="o">:</span> <span class="n">CH_DX_FMC_RVOL_CVOL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_convert_rate</span>

<span class="cm">   Description: This routine converts rate in HZ to hardware delta value.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                rate - Real or Virtual channel number.</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Delta value.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_trident_convert_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>We special case 44100 and 8000 since rounding with the equation
does not give us an accurate enough value. For 11025 and 22050
the equation gives us the best answer. All other frequencies will
also use the equation. JDW</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0xeb3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x2ab</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_convert_adc_rate</span>

<span class="cm">   Description: This routine converts rate in HZ to hardware delta value.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                rate - Real or Virtual channel number.</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Delta value.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_trident_convert_adc_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>We special case 44100 and 8000 since rounding with the equation
does not give us an accurate enough value. For 11025 and 22050
the equation gives us the best answer. All other frequencies will
also use the equation. JDW</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x116a</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x6000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="mi">48000</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spurious_threshold</span>

<span class="cm">   Description: This routine converts rate in HZ to spurious threshold.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                rate - Real or Virtual channel number.</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Delta value.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_trident_spurious_threshold</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">period_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">res</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_control_mode</span>

<span class="cm">   Description: This routine returns a control mode for a PCM channel.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>
<span class="cm">                substream  - PCM substream</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Control value.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_trident_control_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="cm">/* set ctrl mode</span>
<span class="cm">	   CTRL default: 8-bit (unsigned) mono, loop mode enabled</span>
<span class="cm">	 */</span>
	<span class="n">CTRL</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000008</span><span class="p">;</span>	<span class="c1">// 16-bit data</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_signed</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000002</span><span class="p">;</span>	<span class="c1">// signed data</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000004</span><span class="p">;</span>	<span class="c1">// stereo data</span>
	<span class="k">return</span> <span class="n">CTRL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_ioctl</span>
<span class="cm">  </span>
<span class="cm">   Description: Device I/O control handler for playback/capture parameters.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:   substream  - PCM substream class</span>
<span class="cm">                cmd     - what ioctl message to process</span>
<span class="cm">                arg     - additional message infoarg     </span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: it seems that with small periods the behaviour of</span>
<span class="cm">	          trident hardware is unpredictable and interrupt generator</span>
<span class="cm">	          is broken */</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_allocate_pcm_mem</span>
<span class="cm">  </span>
<span class="cm">   Description: Allocate PCM ring buffer for given substream</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_allocate_pcm_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* change */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
				<span class="n">snd_trident_free_pages</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">);</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span> <span class="o">=</span> <span class="n">snd_trident_alloc_pages</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_allocate_evoice</span>
<span class="cm">  </span>
<span class="cm">   Description: Allocate extra voice as interrupt generator</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_allocate_evoice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>

	<span class="cm">/* voice management */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params_buffer_size</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">params_period_size</span><span class="p">(</span><span class="n">hw_params</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">evoice</span> <span class="o">=</span> <span class="n">snd_trident_alloc_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">evoice</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_trident_free_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">evoice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_hw_params</span>
<span class="cm">  </span>
<span class="cm">   Description: Set the hardware parameters for the playback device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_allocate_pcm_mem</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_allocate_evoice</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_playback_hw_free</span>
<span class="cm">  </span>
<span class="cm">   Description: Release the hardware resources for the playback device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span> <span class="o">?</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">&amp;&amp;</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_trident_free_pages</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">);</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_trident_free_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_playback_prepare</span>
<span class="cm">  </span>
<span class="cm">   Description: Prepare playback device for playback.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>	

	<span class="cm">/* set delta (rate) value */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_trident_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>

	<span class="cm">/* set Loop Begin Address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
 
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* in samples */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">rvol</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">cvol</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">pan</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	voice-&gt;Attribute = (1&lt;&lt;(30-16))|(2&lt;&lt;(26-16))|</span>
<span class="c">			   (0&lt;&lt;(24-16))|(0x1f&lt;&lt;(19-16));</span>
<span class="cp">#else</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* in samples */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>			<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>			<span class="cm">/* mute */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		evoice-&gt;Attribute = (1&lt;&lt;(30-16))|(2&lt;&lt;(26-16))|</span>
<span class="c">				    (0&lt;&lt;(24-16))|(0x1f&lt;&lt;(19-16));</span>
<span class="cp">#else</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_capture_hw_params</span>
<span class="cm">  </span>
<span class="cm">   Description: Set the hardware parameters for the capture device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_capture_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_trident_allocate_pcm_mem</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_capture_prepare</span>
<span class="cm">  </span>
<span class="cm">   Description: Prepare capture device for playback.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">ESO_bytes</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Initialize the channel and set channel Mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">LEGACY_DMAR15</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Set DMA channel operation mode register</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outb</span><span class="p">(</span><span class="mh">0x54</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">LEGACY_DMAR11</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Set channel buffer Address, DMAR0 expects contiguous PCI memory area    </p></td><td class="code"><div class="highlight"><pre>	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">LEGACY_DMAR0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>set ESO</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ESO_bytes</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">ESO_bytes</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">LEGACY_DMAR6</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">ESO_bytes</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">LEGACY_DMAR4</span><span class="p">));</span>
	<span class="n">ESO_bytes</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Set channel sample rate, 4.12 format</p></td><td class="code"><div class="highlight"><pre>	<span class="n">val</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="mi">48000L</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBDELTA_DELTA_R</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Set channel interrupt blk length</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="p">((</span><span class="n">ESO_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">ESO_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBBL_SBCL</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Right now, set format and start to run captureing, 
continuous run loop enable.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>	<span class="c1">// 0001 1001b</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_signed</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Prepare capture intr channel</p></td><td class="code"><div class="highlight"><pre>	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_trident_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Set voice parameters</p></td><td class="code"><div class="highlight"><pre>	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>		<span class="cm">/* mute */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>		<span class="cm">/* mute */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_si7018_capture_hw_params</span>
<span class="cm">  </span>
<span class="cm">   Description: Set the hardware parameters for the capture device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_si7018_capture_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_trident_allocate_evoice</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_si7018_capture_hw_free</span>
<span class="cm">  </span>
<span class="cm">   Description: Release the hardware resources for the capture device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_si7018_capture_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span> <span class="o">?</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_trident_free_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_si7018_capture_prepare</span>
<span class="cm">  </span>
<span class="cm">   Description: Prepare capture device for playback.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_si7018_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_trident_convert_adc_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Set voice parameters</p></td><td class="code"><div class="highlight"><pre>	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* in samples */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_PAN</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">30</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">26</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">23</span><span class="o">-</span><span class="mi">16</span><span class="p">));</span>

	<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_trident_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* in samples, 20 means correction */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>			<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>			<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_foldback_prepare</span>
<span class="cm">  </span>
<span class="cm">   Description: Prepare foldback capture device for playback.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_foldback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* Set channel buffer Address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/* set target ESO for channel */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* in samples */</span>

	<span class="cm">/* set sample rate */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>

	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mute */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>	<span class="cm">/* mute */</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set up capture channel */</span>
	<span class="n">outb</span><span class="p">(((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_RCI</span> <span class="o">+</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">foldback_chan</span><span class="p">));</span>

	<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* in samples */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>			<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>			<span class="cm">/* mute */</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif_hw_params</span>
<span class="cm">  </span>
<span class="cm">   Description: Set the hardware parameters for the spdif device.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">		hw_params  - hardware parameters</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_allocate_pcm_mem</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_allocate_evoice</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare SPDIF channel */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old_bits</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_bits</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span><span class="p">)</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEC958_AES0_PRO_FS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IEC958_AES3_CON_FS</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctrl</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">;</span>	<span class="c1">// 48000 Hz</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">|=</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">?</span>
				<span class="n">IEC958_AES0_PRO_FS_48000</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">IEC958_AES3_CON_FS_48000</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">44100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctrl</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span>	<span class="c1">// 44100 Hz</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">|=</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">?</span>
				<span class="n">IEC958_AES0_PRO_FS_44100</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">IEC958_AES3_CON_FS_44100</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctrl</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">;</span>	<span class="c1">// 32000 Hz</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">|=</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">?</span>
				<span class="n">IEC958_AES0_PRO_FS_32000</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">IEC958_AES3_CON_FS_32000</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">old_bits</span> <span class="o">!=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif_prepare</span>
<span class="cm">  </span>
<span class="cm">   Description: Prepare SPDIF device for playback.</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">RESO</span><span class="p">,</span> <span class="n">LBAO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* set delta (rate) value */</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_trident_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>

		<span class="cm">/* set Loop Back Address */</span>
		<span class="n">LBAO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">LBAO</span><span class="p">;</span>

		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="cm">/* set target ESO for channel */</span>
		<span class="n">RESO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* set ctrl mode */</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* prepare surrogate IRQ channel */</span>
		<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">((</span><span class="n">RESO</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPESO</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">RESO</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPESO</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">LBAO</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPLBA</span><span class="p">));</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

		<span class="cm">/* set SPDIF setting */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* SiS */</span>
	
		<span class="cm">/* set delta (rate) value */</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">snd_trident_spurious_threshold</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>

		<span class="cm">/* set Loop Begin Address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="p">)</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">memblk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* in samples */</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_trident_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">rvol</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">cvol</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">pan</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">30</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">26</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span><span class="o">|</span>
				   <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">));</span>

		<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Delta</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">Delta</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">LBA</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">LBA</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CSO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* in samples */</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">GVSel</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">FMS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Vol</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>			<span class="cm">/* mute */</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">RVol</span> <span class="o">=</span> <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">CVol</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mute */</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Pan</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>			<span class="cm">/* mute */</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">Attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">snd_trident_write_voice_regs</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">isync_mark</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">ESO</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">SPDIF_EN</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_trigger</span>
<span class="cm">  </span>
<span class="cm">   Description: Start/stop devices</span>
<span class="cm">  </span>
<span class="cm">   Parameters:  substream  - PCM substream class</span>
<span class="cm">   		cmd	- trigger command (STOP, GO)</span>
<span class="cm">  </span>
<span class="cm">   Returns:     Error status</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
				    
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span><span class="p">,</span> <span class="n">whati</span><span class="p">,</span> <span class="n">capture_flag</span><span class="p">,</span> <span class="n">spdif_flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">,</span> <span class="o">*</span><span class="n">evoice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">go</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">go</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">go</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">what</span> <span class="o">=</span> <span class="n">whati</span> <span class="o">=</span> <span class="n">capture_flag</span> <span class="o">=</span> <span class="n">spdif_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STIMER</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
	<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="p">)</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">trident</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">voice</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">evoice</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
			<span class="n">what</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">whati</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">evoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
				<span class="n">whati</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">evoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="p">)</span>
					<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">stimer</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">voice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">voice</span><span class="o">-&gt;</span><span class="n">stimer</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">voice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">)</span>
				<span class="n">capture_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">)</span>
				<span class="n">spdif_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdif_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctrl</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x28</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">))</span> <span class="o">|</span> <span class="n">SPDIF_EN</span><span class="p">;</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_B</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_B</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">whati</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">whati</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_B</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_START_B</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">capture_flag</span> <span class="o">&amp;&amp;</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBCTRL_SBE2R_SBDD</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capture_flag</span> <span class="o">&amp;&amp;</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBCTRL_SBE2R_SBDD</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_playback_pointer</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine return the playback position</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">   Returns:     position of buffer</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_trident_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cso</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cso</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_DX_CSO_ALPHA_FMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="c1">// ID_4DWAVE_NX</span>
		<span class="n">cso</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">CH_NX_DELTA_CSO</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cso</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
		<span class="n">cso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cso</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_capture_pointer</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine return the capture position</span>
<span class="cm">                </span>
<span class="cm">   Parameters:   pcm1    - PCM device class</span>

<span class="cm">   Returns:     position of buffer</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_trident_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBBL_SBCL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif_pointer</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine return the SPDIF playback position</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">   Returns:     position of buffer</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_trident_spdif_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Playback support device description</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_trident_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="cm">/* | SNDRV_PCM_INFO_RESUME */</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Capture support device description</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_trident_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="cm">/* | SNDRV_PCM_INFO_RESUME */</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Foldback capture support device description</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_trident_foldback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="cm">/* | SNDRV_PCM_INFO_RESUME */</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  SPDIF playback support device description</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_trident_spdif</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="cm">/* | SNDRV_PCM_INFO_RESUME */</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_trident_spdif_7018</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="cm">/* | SNDRV_PCM_INFO_RESUME */</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_pcm_free_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trident</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">trident</span><span class="p">;</span>
		<span class="n">snd_trident_free_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>

	<span class="n">voice</span> <span class="o">=</span> <span class="n">snd_trident_alloc_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">snd_trident_pcm_mixer_build</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_trident_pcm_free_substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_trident_playback</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_playback_close</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will close the 4DWave playback device. For now </span>
<span class="cm">                we will simply free the dma transfer buffer.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_trident_pcm_mixer_free</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif_open</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will open the 4DWave SPDIF device.</span>

<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">   Returns:     status  - success or failure flag</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	
	<span class="n">voice</span> <span class="o">=</span> <span class="n">snd_trident_alloc_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_trident_pcm_free_substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_trident_spdif</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_trident_spdif_7018</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif_close</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will close the 4DWave SPDIF device.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>restore default SPDIF setting</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">SPDIF_EN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SPDIF_EN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_capture_open</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will open the 4DWave capture device.</span>

<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">   Returns:     status  - success or failure flag</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">voice</span> <span class="o">=</span> <span class="n">snd_trident_alloc_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">capture</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_trident_pcm_free_substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_trident_capture</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_capture_close</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will close the 4DWave capture device. For now </span>
<span class="cm">                we will simply free the dma transfer buffer.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_foldback_open</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will open the 4DWave foldback capture device.</span>

<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">   Returns:     status  - success or failure flag</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_foldback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">voice</span> <span class="o">=</span> <span class="n">snd_trident_alloc_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">foldback_chan</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_trident_pcm_free_substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_trident_foldback</span><span class="p">;</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_foldback_close</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will close the 4DWave foldback capture device. </span>
<span class="cm">		For now we will simply free the dma transfer buffer.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:	substream  - PCM substream class</span>

<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_foldback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">voice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="cm">/* stop capture channel */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_RCI</span> <span class="o">+</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">foldback_chan</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   PCM operations</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_nx_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_si7018_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_si7018_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_si7018_capture_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_si7018_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_foldback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_foldback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_foldback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_foldback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_nx_foldback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_foldback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_foldback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_foldback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_spdif_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_trident_spdif_7018_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_trident_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_trident_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_trident_spdif_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_trident_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_trident_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_pcm</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine registers the 4DWave device for PCM support.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>

<span class="cm">   Returns:     None</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;trident_dx_nx&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_nx_playback_ops</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_playback_ops</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span> <span class="o">?</span>
			<span class="o">&amp;</span><span class="n">snd_trident_capture_ops</span> <span class="o">:</span>
			<span class="o">&amp;</span><span class="n">snd_trident_si7018_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev_subclass</span> <span class="o">=</span> <span class="n">SNDRV_PCM_SUBCLASS_GENERIC_MIX</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Trident 4DWave&quot;</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span> <span class="n">substream</span><span class="p">;</span> <span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">snd_pcm_lib_preallocate_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
						      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
						      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
		<span class="n">snd_pcm_lib_preallocate_pages</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">,</span>
					      <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
						      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_foldback_pcm</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine registers the 4DWave device for foldback PCM support.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>

<span class="cm">   Returns:     None</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_foldback_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">foldback</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_chan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;trident_dx_nx&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foldback</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">foldback</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">foldback</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_nx_foldback_ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">foldback</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_foldback_ops</span><span class="p">);</span>
	<span class="n">foldback</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">foldback</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Trident 4DWave&quot;</span><span class="p">);</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">foldback</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Front Mixer&quot;</span><span class="p">);</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Reverb Mixer&quot;</span><span class="p">);</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Chorus Mixer&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_chan</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Second AC&#39;97 ADC&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">foldback</span> <span class="o">=</span> <span class="n">foldback</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span>
		<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">foldback</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
						      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">foldback</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
						      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">foldback</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_spdif</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine registers the 4DWave-NX device for SPDIF support.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave-NX.</span>

<span class="cm">   Returns:     None</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_spdif_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">spdif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;trident_dx_nx IEC958&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spdif</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_spdif_ops</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_trident_spdif_7018_ops</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spdif</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">spdif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Trident 4DWave IEC958&quot;</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">=</span> <span class="n">spdif</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">spdif</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer part</span>
<span class="cm"> */</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_spdif_control</span>

<span class="cm">    Description: enable/disable S/PDIF out from ac97 mixer</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="cp">#define snd_trident_spdif_control_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">==</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="cm">/* S/PDIF C Channel bits 0-31 : 48khz, SCMS disabled */</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPDIF_EN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">SPDIF_EN</span><span class="p">;</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_spdif_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_spdif_default</span>

<span class="cm">    Description: put/get the S/PDIF default settings</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_default_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_spdif_default</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_default_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_default_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_default_put</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_spdif_mask</span>

<span class="cm">    Description: put/get the S/PDIF mask</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_mask_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_spdif_mask</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_mask_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_spdif_stream</span>

<span class="cm">    Description: put/get the S/PDIF stream settings</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_stream_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_spdif_stream</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_stream_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_stream_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_spdif_stream_put</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_ac97_control</span>

<span class="cm">    Description: enable/disable rear path for ac97</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="cp">#define snd_trident_ac97_control_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_ac97_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_ac97_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_ac97_rear_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;Rear Path&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_ac97_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_ac97_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_ac97_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_vol_control</span>

<span class="cm">    Description: wave &amp; music volume control</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_vol_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_vol_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_gvol</span><span class="p">,</span> <span class="o">-</span><span class="mi">6375</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_vol_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">|</span>
	        <span class="p">((</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MUSICVOL_WAVEVOL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_vol_music_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;Music Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_gvol</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_vol_wave_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;Wave Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_vol_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_gvol</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_pcm_vol_control</span>

<span class="cm">    Description: PCM front volume control</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_vol_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_vol_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1023</span> <span class="o">-</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_vol_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1023</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1023</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">vol</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_trident_write_vol_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_pcm_vol_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;PCM Front Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_vol_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_vol_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_vol_control_put</span><span class="p">,</span>
	<span class="cm">/* FIXME: no tlv yet */</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_pcm_pan_control</span>

<span class="cm">    Description: PCM front pan control</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_pan_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_pan_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">pan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x3f</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_pan_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x3f</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">pan</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">pan</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_trident_write_pan_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_pcm_pan_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;PCM Pan Playback Control&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_pan_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_pan_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_pan_control_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_pcm_rvol_control</span>

<span class="cm">    Description: PCM reverb volume control</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_rvol_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_rvol_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">rvol</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_rvol_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x7f</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">rvol</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">rvol</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_trident_write_rvol_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_crvol</span><span class="p">,</span> <span class="o">-</span><span class="mi">3175</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_pcm_rvol_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;PCM Reverb Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> 	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_rvol_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_rvol_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_rvol_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_crvol</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">    snd_trident_pcm_cvol_control</span>

<span class="cm">    Description: PCM chorus volume control</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_cvol_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_cvol_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">cvol</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_cvol_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">snd_ctl_get_ioffnum</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x7f</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">cvol</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">cvol</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_trident_write_cvol_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_trident_pcm_cvol_control</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">&quot;PCM Chorus Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_cvol_control_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_cvol_control_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_trident_pcm_cvol_control_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_crvol</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_notify_pcm_change1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">activate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">kctl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span>
		       <span class="n">snd_ctl_build_ioff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="n">kctl</span><span class="p">,</span> <span class="n">num</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_notify_pcm_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">tmix</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">activate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_trident_notify_pcm_change1</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_vol</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">activate</span><span class="p">);</span>
	<span class="n">snd_trident_notify_pcm_change1</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_pan</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">activate</span><span class="p">);</span>
	<span class="n">snd_trident_notify_pcm_change1</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_rvol</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">activate</span><span class="p">);</span>
	<span class="n">snd_trident_notify_pcm_change1</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_cvol</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">activate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_mixer_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">tmix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">trident</span> <span class="o">||</span> <span class="o">!</span><span class="n">voice</span> <span class="o">||</span> <span class="o">!</span><span class="n">substream</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tmix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">vol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_VOL</span><span class="p">;</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">pan</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_PAN</span><span class="p">;</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">rvol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_RVOL</span><span class="p">;</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">cvol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_CVOL</span><span class="p">;</span>
	<span class="n">snd_trident_notify_pcm_change</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">tmix</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_pcm_mixer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">tmix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">trident</span> <span class="o">||</span> <span class="o">!</span><span class="n">substream</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tmix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snd_trident_notify_pcm_change</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">tmix</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_mixer</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine registers the 4DWave device for mixer support.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>

<span class="cm">   Returns:     None</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcm_spdif_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">_ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_trident_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_trident_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_ac97</span><span class="p">));</span>
	<span class="n">_ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

      <span class="nl">__again:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_sis_reset</span><span class="p">(</span><span class="n">trident</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__again</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* secondary codec? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SI_AC97_PRIMARY_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_sec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SI7018: the secondary codec - invalid access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c">	// only for my testing purpose --jk</span>
<span class="c">		{</span>
<span class="c">			struct snd_ac97 *mc97;</span>
<span class="c">			err = snd_ac97_modem(trident-&gt;card, &amp;_ac97, &amp;mc97);</span>
<span class="c">			if (err &lt; 0)</span>
<span class="c">				snd_printk(KERN_ERR &quot;snd_ac97_modem returned error %i\n&quot;, err);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_detect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_vol_wave_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_vol_music_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MUSICVOL_WAVEVOL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MUSICVOL_WAVEVOL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">tmix</span><span class="p">;</span>
		
		<span class="n">tmix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_vol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_pcm_vol_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nomem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_vol</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">((</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_pan</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_pcm_pan_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nomem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_pan</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_rvol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_pcm_rvol_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nomem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_rvol</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_cvol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_pcm_cvol_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nomem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ctl_cvol</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_ac97_rear_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span> <span class="o">||</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_spdif_control</span><span class="p">,</span> <span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_sec</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_sec</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">))</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">);</span>

		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_spdif_default</span><span class="p">,</span> <span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">pcm_spdif_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_spdif_mask</span><span class="p">,</span> <span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">pcm_spdif_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_trident_spdif_stream</span><span class="p">,</span> <span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">pcm_spdif_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">__out</span><span class="p">;</span>

 <span class="nl">__nomem:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

 <span class="nl">__out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gameport interface</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_trident_gameport_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_LEGACY</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_gameport_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_LEGACY</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_gameport_cooked_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">axes</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buttons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buttons</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">inb</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_LEGACY</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_AXES</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_gameport_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GAMEPORT_MODE_COOKED</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">GAMEPORT_MODE_ADC</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_GCR</span><span class="p">));</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GAMEPORT_MODE_RAW</span>:
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GAMEPORT_GCR</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;trident: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;Trident 4DWave&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">gameport_set_port_data</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">fuzz</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_trident_gameport_read</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_trident_gameport_trigger</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">cooked_read</span> <span class="o">=</span> <span class="n">snd_trident_gameport_cooked_read</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_trident_gameport_open</span><span class="p">;</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_trident_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_trident_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_GAMEPORT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * delay for 1 tick</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  SiS reset routine</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_sis_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* count of retries */</span>
      <span class="nl">__si7018_retry:</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* SOFTWARE RESET */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* disable AC97 GPIO interrupt */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_AC97_GPIO</span><span class="p">));</span>
	<span class="cm">/* initialize serial interface, force cold reset */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">PCMOUT</span><span class="o">|</span><span class="n">SURROUT</span><span class="o">|</span><span class="n">CENTEROUT</span><span class="o">|</span><span class="n">LFEOUT</span><span class="o">|</span><span class="n">SECONDARY_ID</span><span class="o">|</span><span class="n">COLD_RESET</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="cm">/* remove cold reset */</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">COLD_RESET</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="cm">/* wait, until the codec is ready */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SI_AC97_PRIMARY_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__si7018_ok</span><span class="p">;</span>
		<span class="n">do_delay</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 codec ready error [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">do_delay</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">__si7018_retry</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">__si7018_ok:</span>
	<span class="cm">/* wait for the second codec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SI_AC97_SECONDARY_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">do_delay</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="cm">/* enable 64 channel mode */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">BANK_B_EN</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_LFO_GC_CIR</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  </span>
<span class="cm"> *  /proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;SiS 7018 Audio&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_DX</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Trident 4DWave PCI DX&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_NX</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Trident 4DWave PCI NX&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Spurious IRQs    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spurious_irq_count</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Spurious IRQ dlta: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spurious_irq_max_delta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span> <span class="o">||</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 Mixer Out : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span> <span class="o">==</span> <span class="mh">0x28</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Rear Speakers    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">&amp;</span> <span class="mh">0x00000010</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Virtual Memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Memory Maximum : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Memory Used    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Memory Free    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">snd_util_mem_avail</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_trident_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;trident&quot;</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;sis7018&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">trident</span><span class="p">,</span> <span class="n">snd_trident_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_trident_free</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_tlb_alloc</span>
<span class="cm">  </span>
<span class="cm">   Description: Allocate and set up the TLB page table on 4D NX.</span>
<span class="cm">		Each entry has 4 bytes (physical PCI address).</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident - pointer to target device class for 4DWave.</span>

<span class="cm">   Returns:     0 or negative error code</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_tlb_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* TLB array must be aligned to 16kB !!! so we allocate</span>
<span class="cm">	   32kB region and correct offset when necessary */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="mi">2</span> <span class="o">*</span> <span class="n">SNDRV_TRIDENT_MAX_PAGES</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;trident: unable to allocate TLB buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_MAX_PAGES</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries_dmaaddr</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_MAX_PAGES</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* allocate shadow TLB page table (virtual addresses) */</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">shadow_entries</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">SNDRV_TRIDENT_MAX_PAGES</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">shadow_entries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;trident: unable to allocate shadow TLB entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* allocate and setup silent page and initialise TLB entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">SNDRV_TRIDENT_PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;trident: unable to allocate silent page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_TRIDENT_PAGE_SIZE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SNDRV_TRIDENT_MAX_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SNDRV_TRIDENT_PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">shadow_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* use emu memory block manager code to manage tlb page allocation */</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span> <span class="o">=</span> <span class="n">snd_util_memhdr_new</span><span class="p">(</span><span class="n">SNDRV_TRIDENT_PAGE_SIZE</span> <span class="o">*</span> <span class="n">SNDRV_TRIDENT_MAX_PAGES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="o">-&gt;</span><span class="n">block_extra_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident_memblk_arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize 4D DX chip</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_stop_all_voices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_A</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_B</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_A</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_B</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_4d_dx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="cm">/* reset the legacy configuration and whole audio/wavetable block */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DDMA */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ports */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Legacy DMA */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* reset */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* release reset */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	
	<span class="cm">/* warm reset of the AC&#39;97 codec */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR2_AC97_COM_STAT</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR2_AC97_COM_STAT</span><span class="p">));</span>
	<span class="cm">/* DAC on, disable SB IRQ and try to force ADC valid signal */</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="mh">0x0000004a</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR2_AC97_COM_STAT</span><span class="p">));</span>
	<span class="cm">/* wait, until the codec is ready */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">DX_ACR2_AC97_COM_STAT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__dx_ok</span><span class="p">;</span>
		<span class="n">do_delay</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 codec ready error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

 <span class="nl">__dx_ok:</span>
	<span class="n">snd_trident_stop_all_voices</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize 4D NX chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_4d_nx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="cm">/* reset the legacy configuration and whole audio/wavetable block */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DDMA */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ports */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Legacy DMA */</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* reset */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* release reset */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* warm reset of the AC&#39;97 codec */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="cm">/* wait, until the codec is ready */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__nx_ok</span><span class="p">;</span>
		<span class="n">do_delay</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 codec ready error [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">)));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

 <span class="nl">__nx_ok:</span>
	<span class="cm">/* DAC on */</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span> <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_ACR0_AC97_COM_STAT</span><span class="p">));</span>
	<span class="cm">/* disable SB IRQ */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">NX_SB_IRQ_DISABLE</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MISCINT</span><span class="p">));</span>

	<span class="n">snd_trident_stop_all_voices</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* enable virtual addressing via TLB */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries_dmaaddr</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x00000001</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_TLBC</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_TLBC</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* initialize S/PDIF */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCSTATUS</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_ctrl</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize sis7018 chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_sis_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_sis_reset</span><span class="p">(</span><span class="n">trident</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_trident_stop_all_voices</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>

	<span class="cm">/* initialize S/PDIF */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SPDIF_CS</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_create</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will create the device specific class for</span>
<span class="cm">                the 4DWave card. It will also perform basic initialization.</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  card  - which card to create</span>
<span class="cm">                pci   - interface to PCI bus resource info</span>
<span class="cm">                dma1ptr - playback dma buffer</span>
<span class="cm">                dma2ptr - capture dma buffer</span>
<span class="cm">                irqptr  -  interrupt resource info</span>

<span class="cm">   Returns:     4DWave device class private data</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_trident_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">pcm_streams</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">pcm_spdif_device</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">max_wavetable_size</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">**</span> <span class="n">rtrident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_pcm_mixer</span> <span class="o">*</span><span class="n">tmix</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_trident_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rtrident</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* check, if we can restrict PCI DMA transfers to 30 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support 30bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">trident</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">trident</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_streams</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pcm_streams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_streams</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">pcm_streams</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">ChanPCM</span> <span class="o">=</span> <span class="n">pcm_streams</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_wavetable_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">max_wavetable_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="n">max_wavetable_size</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">midi_port</span> <span class="o">=</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MPU401_BASE</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;Trident Audio&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_trident_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">trident</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_trident_free</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* allocate 16k-aligned TLB for NX cards */</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_tlb_alloc</span><span class="p">(</span><span class="n">trident</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_trident_free</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">=</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span><span class="p">;</span>

	<span class="cm">/* initialize chip */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_DX</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_4d_dx_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_NX</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_4d_nx_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_sis_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_trident_free</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">trident</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_trident_free</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_trident_mixer</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">pcm_spdif_device</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="cm">/* initialise synth voices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">voice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">trident</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* initialize pcm mixer entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">vol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_VOL</span><span class="p">;</span>
		<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">pan</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_PAN</span><span class="p">;</span>
		<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">rvol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_RVOL</span><span class="p">;</span>
		<span class="n">tmix</span><span class="o">-&gt;</span><span class="n">cvol</span> <span class="o">=</span> <span class="n">T4D_DEFAULT_PCM_CVOL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_trident_enable_eso</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>

	<span class="n">snd_trident_proc_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rtrident</span> <span class="o">=</span> <span class="n">trident</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_free</span>
<span class="cm">  </span>
<span class="cm">   Description: This routine will free the device specific class for</span>
<span class="cm">                the 4DWave card. </span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident  - device specific private data for 4DWave card</span>

<span class="cm">   Returns:     None.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_trident_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_trident_free_gameport</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="n">snd_trident_disable_eso</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Disable S/PDIF out</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_NX</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">SI_SERIAL_INTF_CTRL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">trident</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_TLBC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="p">)</span>
			<span class="n">snd_util_memhdr_free</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">memhdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
			<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">silent_page</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">shadow_entries</span><span class="p">);</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   snd_trident_interrupt</span>
<span class="cm">  </span>
<span class="cm">   Description: ISR for Trident 4DWave device</span>
<span class="cm">                </span>
<span class="cm">   Parameters:  trident  - device specific private data for 4DWave card</span>

<span class="cm">   Problems:    It seems that Trident chips generates interrupts more than</span>
<span class="cm">                one time in special cases. The spurious interrupts are</span>
<span class="cm">                detected via sample timer (T4D_STIMER) and computing</span>
<span class="cm">                corresponding delta value. The limits are detected with</span>
<span class="cm">                the method try &amp; fail so it is possible that it won&#39;t</span>
<span class="cm">                work on all computers. [jaroslav]</span>

<span class="cm">   Returns:     None.</span>
<span class="cm">  </span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_trident_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_int</span><span class="p">,</span> <span class="n">chn_int</span><span class="p">,</span> <span class="n">stimer</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>

	<span class="n">audio_int</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MISCINT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">audio_int</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADDRESS_IRQ</span><span class="o">|</span><span class="n">MPU401_IRQ</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_int</span> <span class="o">&amp;</span> <span class="n">ADDRESS_IRQ</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>get interrupt status for all channels</p></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">stimer</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STIMER</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
		<span class="n">chn_int</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINT_A</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chn_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__skip1</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">chn_int</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINT_A</span><span class="p">));</span>	<span class="cm">/* ack */</span>
	      <span class="nl">__skip1:</span>
		<span class="n">chn_int</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINT_B</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chn_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__skip2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">channel</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chn_int</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">voice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">||</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_B</span><span class="p">));</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">stimer</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">stimer</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spurious_threshold</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* do some statistics here */</span>
				<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spurious_irq_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spurious_irq_max_delta</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">delta</span><span class="p">)</span>
					<span class="n">trident</span><span class="o">-&gt;</span><span class="n">spurious_irq_max_delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">stimer</span> <span class="o">=</span> <span class="n">stimer</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_SBBL_SBCL</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">bDMAStart</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
						<span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_max</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">NX_SPCTRL_SPCSO</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_mark</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mh">0x10</span><span class="p">)</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_ESO</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_ESO</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
					<span class="cm">/* update ESO for IRQ voice to preserve sync */</span>
					<span class="n">snd_trident_stop_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
					<span class="n">snd_trident_write_eso_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
					<span class="n">snd_trident_start_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* write original ESO and update CSO for IRQ voice to preserve sync */</span>
				<span class="n">snd_trident_stop_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="n">snd_trident_write_cso_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">isync_mark</span><span class="p">);</span>
				<span class="n">snd_trident_write_eso_reg</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">ESO</span><span class="p">);</span>
				<span class="n">snd_trident_start_voice</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if (voice-&gt;extra) {</span>
<span class="c">				/* update CSO for extra voice to preserve sync */</span>
<span class="c">				snd_trident_stop_voice(trident, voice-&gt;extra-&gt;number);</span>
<span class="c">				snd_trident_write_cso_reg(trident, voice-&gt;extra, 0);</span>
<span class="c">				snd_trident_start_voice(trident, voice-&gt;extra-&gt;number);</span>
<span class="c">			}</span>
<span class="cp">#endif</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">chn_int</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINT_B</span><span class="p">));</span>	<span class="cm">/* ack */</span>
	      <span class="nl">__skip2:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_int</span> <span class="o">&amp;</span> <span class="n">MPU401_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">trident</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MPUR0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>outl((ST<em>TARGET</em>REACHED | MIXER<em>OVERFLOW | MIXER</em>UNDERFLOW), TRID<em>REG(trident, T4D</em>MISCINT));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="nf">snd_trident_alloc_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_PCM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">snd_trident_allocate_pcm_channel</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvoice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">capture</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">memblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pvoice</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_SYNTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">snd_trident_allocate_synth_channel</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvoice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">synth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">memblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pvoice</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_TRIDENT_VOICE_TYPE_MIDI</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_trident_alloc_voice</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">snd_trident_free_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">private_free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_trident_voice</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_trident_clear_voices</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">private_free</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">;</span>
	<span class="n">private_data</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span>
		<span class="n">snd_trident_free_pcm_channel</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">)</span>
		<span class="n">snd_trident_free_synth_channel</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">synth</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">midi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">capture</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">sample_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">voice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private_free</span><span class="p">)</span>
		<span class="n">private_free</span><span class="p">(</span><span class="n">voice</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_trident_free_voice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_trident_clear_voices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span> <span class="n">trident</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">v_min</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">v_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">v_min</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="o">||</span> <span class="n">v_max</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">v_min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">v_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mask</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_A</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_A</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_A</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_STOP_B</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_B</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_AINTEN_B</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">snd_trident_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">foldback</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">);</span>

	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_sec</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_trident_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_trident</span> <span class="o">*</span><span class="n">trident</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;trident: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_DX</span>:
		<span class="n">snd_trident_4d_dx_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_NX</span>:
		<span class="n">snd_trident_4d_nx_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIDENT_DEVICE_ID_SI7018</span>:
		<span class="n">snd_trident_sis_init</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">ac97_sec</span><span class="p">);</span>

	<span class="cm">/* restore some registers */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">trident</span><span class="o">-&gt;</span><span class="n">musicvol_wavevol</span><span class="p">,</span> <span class="n">TRID_REG</span><span class="p">(</span><span class="n">trident</span><span class="p">,</span> <span class="n">T4D_MUSICVOL_WAVEVOL</span><span class="p">));</span>

	<span class="n">snd_trident_enable_eso</span><span class="p">(</span><span class="n">trident</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="n">trident</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
