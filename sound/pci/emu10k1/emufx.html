<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › emu10k1 › emufx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>emufx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *                   Creative Labs, Inc.</span>
<span class="cm"> *  Routines for effect processor FX8010</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) by James Courtier-Dutton &lt;James@superbug.co.uk&gt;</span>
<span class="cm"> *  	Added EMU 1010 support.</span>
<span class="cm"> *</span>
<span class="cm"> *  BUGS:</span>
<span class="cm"> *    --</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *    --</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/emu10k1.h&gt;</span>

<span class="cp">#if 0</span><span class="c">		/* for testing purposes - digital out -&gt; capture */</span>
<span class="c">#define EMU10K1_CAPTURE_DIGITAL_OUT</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c">		/* for testing purposes - set S/PDIF to AC3 output */</span>
<span class="c">#define EMU10K1_SET_AC3_IEC958</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c">		/* for testing purposes - feed the front signal to Center/LFE outputs */</span>
<span class="c">#define EMU10K1_CENTER_LFE_FROM_FRONT</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">high_res_gpr_volume</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">high_res_gpr_volume</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">high_res_gpr_volume</span><span class="p">,</span> <span class="s">&quot;GPR mixer controls use 31-bit range.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Tables</span>
<span class="cm"> */</span> 

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fxbuses</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="s">&quot;PCM Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x01 */</span> <span class="s">&quot;PCM Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x02 */</span> <span class="s">&quot;PCM Surround Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x03 */</span> <span class="s">&quot;PCM Surround Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x04 */</span> <span class="s">&quot;MIDI Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x05 */</span> <span class="s">&quot;MIDI Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x06 */</span> <span class="s">&quot;Center&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x07 */</span> <span class="s">&quot;LFE&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x08 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x09 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0a */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0b */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0c */</span> <span class="s">&quot;MIDI Reverb&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0d */</span> <span class="s">&quot;MIDI Chorus&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0e */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0f */</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">creative_ins</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="s">&quot;AC97 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x01 */</span> <span class="s">&quot;AC97 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x02 */</span> <span class="s">&quot;TTL IEC958 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x03 */</span> <span class="s">&quot;TTL IEC958 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x04 */</span> <span class="s">&quot;Zoom Video Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x05 */</span> <span class="s">&quot;Zoom Video Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x06 */</span> <span class="s">&quot;Optical IEC958 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x07 */</span> <span class="s">&quot;Optical IEC958 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x08 */</span> <span class="s">&quot;Line/Mic 1 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x09 */</span> <span class="s">&quot;Line/Mic 1 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0a */</span> <span class="s">&quot;Coaxial IEC958 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0b */</span> <span class="s">&quot;Coaxial IEC958 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0c */</span> <span class="s">&quot;Line/Mic 2 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0d */</span> <span class="s">&quot;Line/Mic 2 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0e */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0f */</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">audigy_ins</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="s">&quot;AC97 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x01 */</span> <span class="s">&quot;AC97 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x02 */</span> <span class="s">&quot;Audigy CD Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x03 */</span> <span class="s">&quot;Audigy CD Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x04 */</span> <span class="s">&quot;Optical IEC958 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x05 */</span> <span class="s">&quot;Optical IEC958 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x06 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x07 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x08 */</span> <span class="s">&quot;Line/Mic 2 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x09 */</span> <span class="s">&quot;Line/Mic 2 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0a */</span> <span class="s">&quot;SPDIF Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0b */</span> <span class="s">&quot;SPDIF Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0c */</span> <span class="s">&quot;Aux2 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0d */</span> <span class="s">&quot;Aux2 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0e */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0f */</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">creative_outs</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="s">&quot;AC97 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x01 */</span> <span class="s">&quot;AC97 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x02 */</span> <span class="s">&quot;Optical IEC958 Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x03 */</span> <span class="s">&quot;Optical IEC958 Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x04 */</span> <span class="s">&quot;Center&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x05 */</span> <span class="s">&quot;LFE&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x06 */</span> <span class="s">&quot;Headphone Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x07 */</span> <span class="s">&quot;Headphone Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x08 */</span> <span class="s">&quot;Surround Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x09 */</span> <span class="s">&quot;Surround Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0a */</span> <span class="s">&quot;PCM Capture Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0b */</span> <span class="s">&quot;PCM Capture Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0c */</span> <span class="s">&quot;MIC Capture&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0d */</span> <span class="s">&quot;AC97 Surround Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0e */</span> <span class="s">&quot;AC97 Surround Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0f */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x10 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x11 */</span> <span class="s">&quot;Analog Center&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x12 */</span> <span class="s">&quot;Analog LFE&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x13 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x14 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x15 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x16 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x17 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x18 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x19 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1a */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1b */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1c */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1d */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1e */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1f */</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">audigy_outs</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="s">&quot;Digital Front Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x01 */</span> <span class="s">&quot;Digital Front Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x02 */</span> <span class="s">&quot;Digital Center&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x03 */</span> <span class="s">&quot;Digital LEF&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x04 */</span> <span class="s">&quot;Headphone Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x05 */</span> <span class="s">&quot;Headphone Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x06 */</span> <span class="s">&quot;Digital Rear Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x07 */</span> <span class="s">&quot;Digital Rear Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x08 */</span> <span class="s">&quot;Front Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x09 */</span> <span class="s">&quot;Front Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0a */</span> <span class="s">&quot;Center&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0b */</span> <span class="s">&quot;LFE&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0c */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0d */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x0e */</span> <span class="s">&quot;Rear Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x0f */</span> <span class="s">&quot;Rear Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x10 */</span> <span class="s">&quot;AC97 Front Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x11 */</span> <span class="s">&quot;AC97 Front Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x12 */</span> <span class="s">&quot;ADC Caputre Left&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x13 */</span> <span class="s">&quot;ADC Capture Right&quot;</span><span class="p">,</span>
	<span class="cm">/* 0x14 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x15 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x16 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x17 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x18 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x19 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1a */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1b */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1c */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1d */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1e */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/* 0x1f */</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">bass_table</span><span class="p">[</span><span class="mi">41</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x3e4f844f</span><span class="p">,</span> <span class="mh">0x84ed4cc3</span><span class="p">,</span> <span class="mh">0x3cc69927</span><span class="p">,</span> <span class="mh">0x7b03553a</span><span class="p">,</span> <span class="mh">0xc4da8486</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3e69a17a</span><span class="p">,</span> <span class="mh">0x84c280fb</span><span class="p">,</span> <span class="mh">0x3cd77cd4</span><span class="p">,</span> <span class="mh">0x7b2f2a6f</span><span class="p">,</span> <span class="mh">0xc4b08d1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3e82ff42</span><span class="p">,</span> <span class="mh">0x849991d5</span><span class="p">,</span> <span class="mh">0x3ce7466b</span><span class="p">,</span> <span class="mh">0x7b5917c6</span><span class="p">,</span> <span class="mh">0xc48863ee</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3e9bab3c</span><span class="p">,</span> <span class="mh">0x847267f0</span><span class="p">,</span> <span class="mh">0x3cf5ffe8</span><span class="p">,</span> <span class="mh">0x7b813560</span><span class="p">,</span> <span class="mh">0xc461f22c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3eb3b275</span><span class="p">,</span> <span class="mh">0x844ced29</span><span class="p">,</span> <span class="mh">0x3d03b295</span><span class="p">,</span> <span class="mh">0x7ba79a1c</span><span class="p">,</span> <span class="mh">0xc43d223b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3ecb2174</span><span class="p">,</span> <span class="mh">0x84290c8b</span><span class="p">,</span> <span class="mh">0x3d106714</span><span class="p">,</span> <span class="mh">0x7bcc5ba3</span><span class="p">,</span> <span class="mh">0xc419dfa5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3ee2044b</span><span class="p">,</span> <span class="mh">0x8406b244</span><span class="p">,</span> <span class="mh">0x3d1c2561</span><span class="p">,</span> <span class="mh">0x7bef8e77</span><span class="p">,</span> <span class="mh">0xc3f8170f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3ef86698</span><span class="p">,</span> <span class="mh">0x83e5cb96</span><span class="p">,</span> <span class="mh">0x3d26f4d8</span><span class="p">,</span> <span class="mh">0x7c114600</span><span class="p">,</span> <span class="mh">0xc3d7b625</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f0e5390</span><span class="p">,</span> <span class="mh">0x83c646c9</span><span class="p">,</span> <span class="mh">0x3d30dc39</span><span class="p">,</span> <span class="mh">0x7c319498</span><span class="p">,</span> <span class="mh">0xc3b8ab97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f23d60b</span><span class="p">,</span> <span class="mh">0x83a81321</span><span class="p">,</span> <span class="mh">0x3d39e1af</span><span class="p">,</span> <span class="mh">0x7c508b9c</span><span class="p">,</span> <span class="mh">0xc39ae704</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f38f884</span><span class="p">,</span> <span class="mh">0x838b20d2</span><span class="p">,</span> <span class="mh">0x3d420ad2</span><span class="p">,</span> <span class="mh">0x7c6e3b75</span><span class="p">,</span> <span class="mh">0xc37e58f1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f4dc52c</span><span class="p">,</span> <span class="mh">0x836f60ef</span><span class="p">,</span> <span class="mh">0x3d495cab</span><span class="p">,</span> <span class="mh">0x7c8ab3a6</span><span class="p">,</span> <span class="mh">0xc362f2be</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f6245e8</span><span class="p">,</span> <span class="mh">0x8354c565</span><span class="p">,</span> <span class="mh">0x3d4fdbb8</span><span class="p">,</span> <span class="mh">0x7ca602d6</span><span class="p">,</span> <span class="mh">0xc348a69b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f76845f</span><span class="p">,</span> <span class="mh">0x833b40ec</span><span class="p">,</span> <span class="mh">0x3d558bf0</span><span class="p">,</span> <span class="mh">0x7cc036df</span><span class="p">,</span> <span class="mh">0xc32f677c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f8a8a03</span><span class="p">,</span> <span class="mh">0x8322c6fb</span><span class="p">,</span> <span class="mh">0x3d5a70c4</span><span class="p">,</span> <span class="mh">0x7cd95cd7</span><span class="p">,</span> <span class="mh">0xc317290b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3f9e6014</span><span class="p">,</span> <span class="mh">0x830b4bc3</span><span class="p">,</span> <span class="mh">0x3d5e8d25</span><span class="p">,</span> <span class="mh">0x7cf1811a</span><span class="p">,</span> <span class="mh">0xc2ffdfa5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3fb20fae</span><span class="p">,</span> <span class="mh">0x82f4c420</span><span class="p">,</span> <span class="mh">0x3d61e37f</span><span class="p">,</span> <span class="mh">0x7d08af56</span><span class="p">,</span> <span class="mh">0xc2e9804a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3fc5a1cc</span><span class="p">,</span> <span class="mh">0x82df2592</span><span class="p">,</span> <span class="mh">0x3d6475c3</span><span class="p">,</span> <span class="mh">0x7d1ef294</span><span class="p">,</span> <span class="mh">0xc2d40096</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3fd91f55</span><span class="p">,</span> <span class="mh">0x82ca6632</span><span class="p">,</span> <span class="mh">0x3d664564</span><span class="p">,</span> <span class="mh">0x7d345541</span><span class="p">,</span> <span class="mh">0xc2bf56b9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x3fec9120</span><span class="p">,</span> <span class="mh">0x82b67cac</span><span class="p">,</span> <span class="mh">0x3d675356</span><span class="p">,</span> <span class="mh">0x7d48e138</span><span class="p">,</span> <span class="mh">0xc2ab796e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mh">0x82a36037</span><span class="p">,</span> <span class="mh">0x3d67a012</span><span class="p">,</span> <span class="mh">0x7d5c9fc9</span><span class="p">,</span> <span class="mh">0xc2985fee</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x401374c7</span><span class="p">,</span> <span class="mh">0x8291088a</span><span class="p">,</span> <span class="mh">0x3d672b93</span><span class="p">,</span> <span class="mh">0x7d6f99c3</span><span class="p">,</span> <span class="mh">0xc28601f2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4026f857</span><span class="p">,</span> <span class="mh">0x827f6dd7</span><span class="p">,</span> <span class="mh">0x3d65f559</span><span class="p">,</span> <span class="mh">0x7d81d77c</span><span class="p">,</span> <span class="mh">0xc27457a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x403a939f</span><span class="p">,</span> <span class="mh">0x826e88c5</span><span class="p">,</span> <span class="mh">0x3d63fc63</span><span class="p">,</span> <span class="mh">0x7d9360d4</span><span class="p">,</span> <span class="mh">0xc2635996</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x404e4faf</span><span class="p">,</span> <span class="mh">0x825e5266</span><span class="p">,</span> <span class="mh">0x3d613f32</span><span class="p">,</span> <span class="mh">0x7da43d42</span><span class="p">,</span> <span class="mh">0xc25300c6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x406235ba</span><span class="p">,</span> <span class="mh">0x824ec434</span><span class="p">,</span> <span class="mh">0x3d5dbbc3</span><span class="p">,</span> <span class="mh">0x7db473d7</span><span class="p">,</span> <span class="mh">0xc243468e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40764f1f</span><span class="p">,</span> <span class="mh">0x823fd80c</span><span class="p">,</span> <span class="mh">0x3d596f8f</span><span class="p">,</span> <span class="mh">0x7dc40b44</span><span class="p">,</span> <span class="mh">0xc23424a2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x408aa576</span><span class="p">,</span> <span class="mh">0x82318824</span><span class="p">,</span> <span class="mh">0x3d545787</span><span class="p">,</span> <span class="mh">0x7dd309e2</span><span class="p">,</span> <span class="mh">0xc2259509</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x409f4296</span><span class="p">,</span> <span class="mh">0x8223cf0b</span><span class="p">,</span> <span class="mh">0x3d4e7012</span><span class="p">,</span> <span class="mh">0x7de175b5</span><span class="p">,</span> <span class="mh">0xc2179218</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40b430a0</span><span class="p">,</span> <span class="mh">0x8216a7a1</span><span class="p">,</span> <span class="mh">0x3d47b505</span><span class="p">,</span> <span class="mh">0x7def5475</span><span class="p">,</span> <span class="mh">0xc20a1670</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40c97a0a</span><span class="p">,</span> <span class="mh">0x820a0d12</span><span class="p">,</span> <span class="mh">0x3d4021a1</span><span class="p">,</span> <span class="mh">0x7dfcab8d</span><span class="p">,</span> <span class="mh">0xc1fd1cf5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40df29a6</span><span class="p">,</span> <span class="mh">0x81fdfad6</span><span class="p">,</span> <span class="mh">0x3d37b08d</span><span class="p">,</span> <span class="mh">0x7e098028</span><span class="p">,</span> <span class="mh">0xc1f0a0ca</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40f54ab1</span><span class="p">,</span> <span class="mh">0x81f26ca9</span><span class="p">,</span> <span class="mh">0x3d2e5bd1</span><span class="p">,</span> <span class="mh">0x7e15d72b</span><span class="p">,</span> <span class="mh">0xc1e49d52</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x410be8da</span><span class="p">,</span> <span class="mh">0x81e75e89</span><span class="p">,</span> <span class="mh">0x3d241cce</span><span class="p">,</span> <span class="mh">0x7e21b544</span><span class="p">,</span> <span class="mh">0xc1d90e24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41231051</span><span class="p">,</span> <span class="mh">0x81dcccb3</span><span class="p">,</span> <span class="mh">0x3d18ec37</span><span class="p">,</span> <span class="mh">0x7e2d1ee6</span><span class="p">,</span> <span class="mh">0xc1cdef10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x413acdd0</span><span class="p">,</span> <span class="mh">0x81d2b39e</span><span class="p">,</span> <span class="mh">0x3d0cc20a</span><span class="p">,</span> <span class="mh">0x7e38184e</span><span class="p">,</span> <span class="mh">0xc1c33c13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41532ea7</span><span class="p">,</span> <span class="mh">0x81c90ffb</span><span class="p">,</span> <span class="mh">0x3cff9585</span><span class="p">,</span> <span class="mh">0x7e42a58b</span><span class="p">,</span> <span class="mh">0xc1b8f15a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x416c40cd</span><span class="p">,</span> <span class="mh">0x81bfdeb2</span><span class="p">,</span> <span class="mh">0x3cf15d21</span><span class="p">,</span> <span class="mh">0x7e4cca7c</span><span class="p">,</span> <span class="mh">0xc1af0b3f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x418612ea</span><span class="p">,</span> <span class="mh">0x81b71cdc</span><span class="p">,</span> <span class="mh">0x3ce20e85</span><span class="p">,</span> <span class="mh">0x7e568ad3</span><span class="p">,</span> <span class="mh">0xc1a58640</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41a0b465</span><span class="p">,</span> <span class="mh">0x81aec7c5</span><span class="p">,</span> <span class="mh">0x3cd19e7c</span><span class="p">,</span> <span class="mh">0x7e5fea1e</span><span class="p">,</span> <span class="mh">0xc19c5f03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41bc3573</span><span class="p">,</span> <span class="mh">0x81a6dcea</span><span class="p">,</span> <span class="mh">0x3cc000e9</span><span class="p">,</span> <span class="mh">0x7e68ebc2</span><span class="p">,</span> <span class="mh">0xc1939250</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">treble_table</span><span class="p">[</span><span class="mi">41</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0125cba9</span><span class="p">,</span> <span class="mh">0xfed5debd</span><span class="p">,</span> <span class="mh">0x00599b6c</span><span class="p">,</span> <span class="mh">0x0d2506da</span><span class="p">,</span> <span class="mh">0xfa85b354</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0142f67e</span><span class="p">,</span> <span class="mh">0xfeb03163</span><span class="p">,</span> <span class="mh">0x0066cd0f</span><span class="p">,</span> <span class="mh">0x0d14c69d</span><span class="p">,</span> <span class="mh">0xfa914473</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x016328bd</span><span class="p">,</span> <span class="mh">0xfe860158</span><span class="p">,</span> <span class="mh">0x0075b7f2</span><span class="p">,</span> <span class="mh">0x0d03eb27</span><span class="p">,</span> <span class="mh">0xfa9d32d2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0186b438</span><span class="p">,</span> <span class="mh">0xfe56c982</span><span class="p">,</span> <span class="mh">0x00869234</span><span class="p">,</span> <span class="mh">0x0cf27048</span><span class="p">,</span> <span class="mh">0xfaa97fca</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01adf358</span><span class="p">,</span> <span class="mh">0xfe21f5fe</span><span class="p">,</span> <span class="mh">0x00999842</span><span class="p">,</span> <span class="mh">0x0ce051c2</span><span class="p">,</span> <span class="mh">0xfab62ca5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01d949fa</span><span class="p">,</span> <span class="mh">0xfde6e287</span><span class="p">,</span> <span class="mh">0x00af0d8d</span><span class="p">,</span> <span class="mh">0x0ccd8b4a</span><span class="p">,</span> <span class="mh">0xfac33aa7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02092669</span><span class="p">,</span> <span class="mh">0xfda4d8bf</span><span class="p">,</span> <span class="mh">0x00c73d4c</span><span class="p">,</span> <span class="mh">0x0cba1884</span><span class="p">,</span> <span class="mh">0xfad0ab07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x023e0268</span><span class="p">,</span> <span class="mh">0xfd5b0e4a</span><span class="p">,</span> <span class="mh">0x00e27b54</span><span class="p">,</span> <span class="mh">0x0ca5f509</span><span class="p">,</span> <span class="mh">0xfade7ef2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0278645c</span><span class="p">,</span> <span class="mh">0xfd08a2b0</span><span class="p">,</span> <span class="mh">0x01012509</span><span class="p">,</span> <span class="mh">0x0c911c63</span><span class="p">,</span> <span class="mh">0xfaecb788</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02b8e091</span><span class="p">,</span> <span class="mh">0xfcac9d1a</span><span class="p">,</span> <span class="mh">0x0123a262</span><span class="p">,</span> <span class="mh">0x0c7b8a14</span><span class="p">,</span> <span class="mh">0xfafb55df</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x03001a9a</span><span class="p">,</span> <span class="mh">0xfc45e9ce</span><span class="p">,</span> <span class="mh">0x014a6709</span><span class="p">,</span> <span class="mh">0x0c65398f</span><span class="p">,</span> <span class="mh">0xfb0a5aff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x034ec6d7</span><span class="p">,</span> <span class="mh">0xfbd3576b</span><span class="p">,</span> <span class="mh">0x0175f397</span><span class="p">,</span> <span class="mh">0x0c4e2643</span><span class="p">,</span> <span class="mh">0xfb19c7e4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x03a5ac15</span><span class="p">,</span> <span class="mh">0xfb5393ee</span><span class="p">,</span> <span class="mh">0x01a6d6ed</span><span class="p">,</span> <span class="mh">0x0c364b94</span><span class="p">,</span> <span class="mh">0xfb299d7c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0405a562</span><span class="p">,</span> <span class="mh">0xfac52968</span><span class="p">,</span> <span class="mh">0x01ddafae</span><span class="p">,</span> <span class="mh">0x0c1da4e2</span><span class="p">,</span> <span class="mh">0xfb39dca5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x046fa3fe</span><span class="p">,</span> <span class="mh">0xfa267a66</span><span class="p">,</span> <span class="mh">0x021b2ddd</span><span class="p">,</span> <span class="mh">0x0c042d8d</span><span class="p">,</span> <span class="mh">0xfb4a8631</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04e4b17f</span><span class="p">,</span> <span class="mh">0xf975be0f</span><span class="p">,</span> <span class="mh">0x0260149f</span><span class="p">,</span> <span class="mh">0x0be9e0f2</span><span class="p">,</span> <span class="mh">0xfb5b9ae0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0565f220</span><span class="p">,</span> <span class="mh">0xf8b0fbe5</span><span class="p">,</span> <span class="mh">0x02ad3c29</span><span class="p">,</span> <span class="mh">0x0bceba73</span><span class="p">,</span> <span class="mh">0xfb6d1b60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05f4a745</span><span class="p">,</span> <span class="mh">0xf7d60722</span><span class="p">,</span> <span class="mh">0x030393d4</span><span class="p">,</span> <span class="mh">0x0bb2b578</span><span class="p">,</span> <span class="mh">0xfb7f084d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06923236</span><span class="p">,</span> <span class="mh">0xf6e279bd</span><span class="p">,</span> <span class="mh">0x03642465</span><span class="p">,</span> <span class="mh">0x0b95cd75</span><span class="p">,</span> <span class="mh">0xfb916233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07401713</span><span class="p">,</span> <span class="mh">0xf5d3aef9</span><span class="p">,</span> <span class="mh">0x03d01283</span><span class="p">,</span> <span class="mh">0x0b77fded</span><span class="p">,</span> <span class="mh">0xfba42984</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mh">0xf4a6bd88</span><span class="p">,</span> <span class="mh">0x0448a161</span><span class="p">,</span> <span class="mh">0x0b594278</span><span class="p">,</span> <span class="mh">0xfbb75e9f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08d3c097</span><span class="p">,</span> <span class="mh">0xf3587131</span><span class="p">,</span> <span class="mh">0x04cf35a4</span><span class="p">,</span> <span class="mh">0x0b3996c9</span><span class="p">,</span> <span class="mh">0xfbcb01cb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x09bd59a2</span><span class="p">,</span> <span class="mh">0xf1e543f9</span><span class="p">,</span> <span class="mh">0x05655880</span><span class="p">,</span> <span class="mh">0x0b18f6b2</span><span class="p">,</span> <span class="mh">0xfbdf1333</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0abefd0f</span><span class="p">,</span> <span class="mh">0xf04956ca</span><span class="p">,</span> <span class="mh">0x060cbb12</span><span class="p">,</span> <span class="mh">0x0af75e2c</span><span class="p">,</span> <span class="mh">0xfbf392e8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0bdb123e</span><span class="p">,</span> <span class="mh">0xee806984</span><span class="p">,</span> <span class="mh">0x06c739fe</span><span class="p">,</span> <span class="mh">0x0ad4c962</span><span class="p">,</span> <span class="mh">0xfc0880dd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d143a94</span><span class="p">,</span> <span class="mh">0xec85d287</span><span class="p">,</span> <span class="mh">0x0796e150</span><span class="p">,</span> <span class="mh">0x0ab134b0</span><span class="p">,</span> <span class="mh">0xfc1ddce5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6d5664</span><span class="p">,</span> <span class="mh">0xea547598</span><span class="p">,</span> <span class="mh">0x087df0a0</span><span class="p">,</span> <span class="mh">0x0a8c9cb6</span><span class="p">,</span> <span class="mh">0xfc33a6ad</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0fe98a2a</span><span class="p">,</span> <span class="mh">0xe7e6ba35</span><span class="p">,</span> <span class="mh">0x097edf83</span><span class="p">,</span> <span class="mh">0x0a66fe5b</span><span class="p">,</span> <span class="mh">0xfc49ddc2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x118c4421</span><span class="p">,</span> <span class="mh">0xe536813a</span><span class="p">,</span> <span class="mh">0x0a9c6248</span><span class="p">,</span> <span class="mh">0x0a4056d7</span><span class="p">,</span> <span class="mh">0xfc608185</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1359422e</span><span class="p">,</span> <span class="mh">0xe23d19eb</span><span class="p">,</span> <span class="mh">0x0bd96efb</span><span class="p">,</span> <span class="mh">0x0a18a3bf</span><span class="p">,</span> <span class="mh">0xfc77912c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1554982b</span><span class="p">,</span> <span class="mh">0xdef33645</span><span class="p">,</span> <span class="mh">0x0d3942bd</span><span class="p">,</span> <span class="mh">0x09efe312</span><span class="p">,</span> <span class="mh">0xfc8f0bc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1782b68a</span><span class="p">,</span> <span class="mh">0xdb50deb1</span><span class="p">,</span> <span class="mh">0x0ebf676d</span><span class="p">,</span> <span class="mh">0x09c6133f</span><span class="p">,</span> <span class="mh">0xfca6f019</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19e8715d</span><span class="p">,</span> <span class="mh">0xd74d64fd</span><span class="p">,</span> <span class="mh">0x106fb999</span><span class="p">,</span> <span class="mh">0x099b3337</span><span class="p">,</span> <span class="mh">0xfcbf3cd6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1c8b07b8</span><span class="p">,</span> <span class="mh">0xd2df56ab</span><span class="p">,</span> <span class="mh">0x124e6ec8</span><span class="p">,</span> <span class="mh">0x096f4274</span><span class="p">,</span> <span class="mh">0xfcd7f060</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1f702b6d</span><span class="p">,</span> <span class="mh">0xcdfc6e92</span><span class="p">,</span> <span class="mh">0x14601c10</span><span class="p">,</span> <span class="mh">0x0942410b</span><span class="p">,</span> <span class="mh">0xfcf108e5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x229e0933</span><span class="p">,</span> <span class="mh">0xc89985cd</span><span class="p">,</span> <span class="mh">0x16a9bcfa</span><span class="p">,</span> <span class="mh">0x09142fb5</span><span class="p">,</span> <span class="mh">0xfd0a8451</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x261b5118</span><span class="p">,</span> <span class="mh">0xc2aa8409</span><span class="p">,</span> <span class="mh">0x1930bab6</span><span class="p">,</span> <span class="mh">0x08e50fdc</span><span class="p">,</span> <span class="mh">0xfd24604d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x29ef3f5d</span><span class="p">,</span> <span class="mh">0xbc224f28</span><span class="p">,</span> <span class="mh">0x1bfaf396</span><span class="p">,</span> <span class="mh">0x08b4e3aa</span><span class="p">,</span> <span class="mh">0xfd3e9a3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2e21a59b</span><span class="p">,</span> <span class="mh">0xb4f2ba46</span><span class="p">,</span> <span class="mh">0x1f0ec2d6</span><span class="p">,</span> <span class="mh">0x0883ae15</span><span class="p">,</span> <span class="mh">0xfd592f33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x32baf44b</span><span class="p">,</span> <span class="mh">0xad0c7429</span><span class="p">,</span> <span class="mh">0x227308a3</span><span class="p">,</span> <span class="mh">0x085172eb</span><span class="p">,</span> <span class="mh">0xfd741bfd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x37c4448b</span><span class="p">,</span> <span class="mh">0xa45ef51d</span><span class="p">,</span> <span class="mh">0x262f3267</span><span class="p">,</span> <span class="mh">0x081e36dc</span><span class="p">,</span> <span class="mh">0xfd8f5d14</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* dB gain = (float) 20 * log10( float(db_table_value) / 0x8000000 ) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">db_table</span><span class="p">[</span><span class="mi">101</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x01571f82</span><span class="p">,</span> <span class="mh">0x01674b41</span><span class="p">,</span> <span class="mh">0x01783a1b</span><span class="p">,</span> <span class="mh">0x0189f540</span><span class="p">,</span>
	<span class="mh">0x019c8651</span><span class="p">,</span> <span class="mh">0x01aff763</span><span class="p">,</span> <span class="mh">0x01c45306</span><span class="p">,</span> <span class="mh">0x01d9a446</span><span class="p">,</span> <span class="mh">0x01eff6b8</span><span class="p">,</span>
	<span class="mh">0x0207567a</span><span class="p">,</span> <span class="mh">0x021fd03d</span><span class="p">,</span> <span class="mh">0x0239714c</span><span class="p">,</span> <span class="mh">0x02544792</span><span class="p">,</span> <span class="mh">0x027061a1</span><span class="p">,</span>
	<span class="mh">0x028dcebb</span><span class="p">,</span> <span class="mh">0x02ac9edc</span><span class="p">,</span> <span class="mh">0x02cce2bf</span><span class="p">,</span> <span class="mh">0x02eeabe8</span><span class="p">,</span> <span class="mh">0x03120cb0</span><span class="p">,</span>
	<span class="mh">0x0337184e</span><span class="p">,</span> <span class="mh">0x035de2df</span><span class="p">,</span> <span class="mh">0x03868173</span><span class="p">,</span> <span class="mh">0x03b10a18</span><span class="p">,</span> <span class="mh">0x03dd93e9</span><span class="p">,</span>
	<span class="mh">0x040c3713</span><span class="p">,</span> <span class="mh">0x043d0cea</span><span class="p">,</span> <span class="mh">0x04702ff3</span><span class="p">,</span> <span class="mh">0x04a5bbf2</span><span class="p">,</span> <span class="mh">0x04ddcdfb</span><span class="p">,</span>
	<span class="mh">0x0518847f</span><span class="p">,</span> <span class="mh">0x0555ff62</span><span class="p">,</span> <span class="mh">0x05966005</span><span class="p">,</span> <span class="mh">0x05d9c95d</span><span class="p">,</span> <span class="mh">0x06206005</span><span class="p">,</span>
	<span class="mh">0x066a4a52</span><span class="p">,</span> <span class="mh">0x06b7b067</span><span class="p">,</span> <span class="mh">0x0708bc4c</span><span class="p">,</span> <span class="mh">0x075d9a01</span><span class="p">,</span> <span class="mh">0x07b6779d</span><span class="p">,</span>
	<span class="mh">0x08138561</span><span class="p">,</span> <span class="mh">0x0874f5d5</span><span class="p">,</span> <span class="mh">0x08dafde1</span><span class="p">,</span> <span class="mh">0x0945d4ed</span><span class="p">,</span> <span class="mh">0x09b5b4fd</span><span class="p">,</span>
	<span class="mh">0x0a2adad1</span><span class="p">,</span> <span class="mh">0x0aa58605</span><span class="p">,</span> <span class="mh">0x0b25f936</span><span class="p">,</span> <span class="mh">0x0bac7a24</span><span class="p">,</span> <span class="mh">0x0c3951d8</span><span class="p">,</span>
	<span class="mh">0x0ccccccc</span><span class="p">,</span> <span class="mh">0x0d673b17</span><span class="p">,</span> <span class="mh">0x0e08f093</span><span class="p">,</span> <span class="mh">0x0eb24510</span><span class="p">,</span> <span class="mh">0x0f639481</span><span class="p">,</span>
	<span class="mh">0x101d3f2d</span><span class="p">,</span> <span class="mh">0x10dfa9e6</span><span class="p">,</span> <span class="mh">0x11ab3e3f</span><span class="p">,</span> <span class="mh">0x12806ac3</span><span class="p">,</span> <span class="mh">0x135fa333</span><span class="p">,</span>
	<span class="mh">0x144960c5</span><span class="p">,</span> <span class="mh">0x153e2266</span><span class="p">,</span> <span class="mh">0x163e6cfe</span><span class="p">,</span> <span class="mh">0x174acbb7</span><span class="p">,</span> <span class="mh">0x1863d04d</span><span class="p">,</span>
	<span class="mh">0x198a1357</span><span class="p">,</span> <span class="mh">0x1abe349f</span><span class="p">,</span> <span class="mh">0x1c00db77</span><span class="p">,</span> <span class="mh">0x1d52b712</span><span class="p">,</span> <span class="mh">0x1eb47ee6</span><span class="p">,</span>
	<span class="mh">0x2026f30f</span><span class="p">,</span> <span class="mh">0x21aadcb6</span><span class="p">,</span> <span class="mh">0x23410e7e</span><span class="p">,</span> <span class="mh">0x24ea64f9</span><span class="p">,</span> <span class="mh">0x26a7c71d</span><span class="p">,</span>
	<span class="mh">0x287a26c4</span><span class="p">,</span> <span class="mh">0x2a62812c</span><span class="p">,</span> <span class="mh">0x2c61df84</span><span class="p">,</span> <span class="mh">0x2e795779</span><span class="p">,</span> <span class="mh">0x30aa0bcf</span><span class="p">,</span>
	<span class="mh">0x32f52cfe</span><span class="p">,</span> <span class="mh">0x355bf9d8</span><span class="p">,</span> <span class="mh">0x37dfc033</span><span class="p">,</span> <span class="mh">0x3a81dda4</span><span class="p">,</span> <span class="mh">0x3d43c038</span><span class="p">,</span>
	<span class="mh">0x4026e73c</span><span class="p">,</span> <span class="mh">0x432ce40f</span><span class="p">,</span> <span class="mh">0x46575af8</span><span class="p">,</span> <span class="mh">0x49a8040f</span><span class="p">,</span> <span class="mh">0x4d20ac2a</span><span class="p">,</span>
	<span class="mh">0x50c335d3</span><span class="p">,</span> <span class="mh">0x54919a57</span><span class="p">,</span> <span class="mh">0x588dead1</span><span class="p">,</span> <span class="mh">0x5cba514a</span><span class="p">,</span> <span class="mh">0x611911ea</span><span class="p">,</span>
	<span class="mh">0x65ac8c2f</span><span class="p">,</span> <span class="mh">0x6a773c39</span><span class="p">,</span> <span class="mh">0x6f7bbc23</span><span class="p">,</span> <span class="mh">0x74bcc56c</span><span class="p">,</span> <span class="mh">0x7a3d3272</span><span class="p">,</span>
	<span class="mh">0x7fffffff</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* EMU10k1/EMU10k2 DSP control db gain */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">snd_emu10k1_db_scale1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">snd_emu10k1_db_linear</span><span class="p">,</span> <span class="n">TLV_DB_GAIN_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* EMU10K1 bass/treble db gain */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">snd_emu10k1_bass_treble_db_scale</span><span class="p">,</span> <span class="o">-</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">onoff_table</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000001</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="n">mm_segment_t</span> <span class="nf">snd_enter_user</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_leave_user</span><span class="p">(</span><span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_gpr_ctl_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_gpr_ctl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_gpr_ctl_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nval</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nval</span> <span class="o">&lt;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">)</span>
			<span class="n">nval</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nval</span> <span class="o">&gt;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
			<span class="n">nval</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nval</span> <span class="o">!=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nval</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EMU10K1_GPR_TRANSLATION_NONE</span>:
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMU10K1_GPR_TRANSLATION_TABLE100</span>:
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">db_table</span><span class="p">[</span><span class="n">val</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMU10K1_GPR_TRANSLATION_BASS</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">change</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bass_table</span><span class="p">[</span><span class="n">val</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMU10K1_GPR_TRANSLATION_TREBLE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">change</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">treble_table</span><span class="p">[</span><span class="n">val</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMU10K1_GPR_TRANSLATION_ONOFF</span>:
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">onoff_table</span><span class="p">[</span><span class="n">val</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
      <span class="nl">__error:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_fx8010_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">,</span> <span class="o">*</span><span class="n">nirq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nirq</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>	<span class="cm">/* irq ptr can be removed from list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
				<span class="n">irq</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">nirq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_register_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
					    <span class="n">snd_fx8010_irq_handler_t</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gpr_running</span><span class="p">,</span>
					    <span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_irq</span> <span class="o">**</span><span class="n">r_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">irq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">irq</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">irq</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">irq</span><span class="o">-&gt;</span><span class="n">gpr_running</span> <span class="o">=</span> <span class="n">gpr_running</span><span class="p">;</span>
	<span class="n">irq</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">private_data</span><span class="p">;</span>
	<span class="n">irq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">dsp_interrupt</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_interrupt</span><span class="p">;</span>
		<span class="n">snd_emu10k1_intr_enable</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">INTE_FXDSPENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_irq</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_unregister_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_irq</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span><span class="p">)</span> <span class="o">==</span> <span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_handlers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_emu10k1_intr_disable</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">INTE_FXDSPENABLE</span><span class="p">);</span>
			<span class="n">emu</span><span class="o">-&gt;</span><span class="n">dsp_interrupt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">irq</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * EMU10K1 effect manager</span>
<span class="cm"> *************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_write_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">);</span>
	<span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define OP(icode, ptr, op, r, a, x, y) \</span>
<span class="cp">	snd_emu10k1_write_op(icode, ptr, op, r, a, x, y)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_audigy_write_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">);</span>
	<span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>
	<span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define A_OP(icode, ptr, op, r, a, x, y) \</span>
<span class="cp">	snd_emu10k1_audigy_write_op(icode, ptr, op, r, a, x, y)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_efx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc</span> <span class="o">+=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="n">A_MICROCODEBASE</span> <span class="o">:</span> <span class="n">MICROCODEBASE</span><span class="p">;</span>
	<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_efx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc</span> <span class="o">+=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="n">A_MICROCODEBASE</span> <span class="o">:</span> <span class="n">MICROCODEBASE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_gpr_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">gpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">gpr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_valid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_gpr_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">gpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">gpr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_valid</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_tram_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tram</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">);</span> <span class="n">tram</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">tram</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span><span class="p">[</span><span class="n">tram</span><span class="p">])</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span><span class="p">[</span><span class="n">tram</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMDATAREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_TANKMEMCTLREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_tram_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tram</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">);</span> <span class="n">tram</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">tram</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMDATAREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">|=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_TANKMEMCTLREGBASE</span> <span class="o">+</span> <span class="n">tram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span><span class="p">[</span><span class="n">tram</span><span class="p">])</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span><span class="p">[</span><span class="n">tram</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_code_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pc</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span> <span class="o">:</span> <span class="mi">2</span><span class="o">*</span><span class="mi">512</span><span class="p">);</span> <span class="n">pc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">pc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">snd_emu10k1_efx_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="n">snd_emu10k1_efx_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_code_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span> <span class="o">:</span> <span class="mi">2</span><span class="o">*</span><span class="mi">512</span><span class="p">);</span> <span class="n">pc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">pc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">code_valid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">snd_emu10k1_efx_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">snd_emu10k1_efx_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span>
<span class="nf">snd_emu10k1_look_for_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">gpr_ctl</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_TLV_SIZE	256</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">copy_tlv</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_tlv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_tlv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MAX_TLV_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tlv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tlv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tlv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_tlv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tlv</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tlv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_gctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">gctl</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_gctl</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_old_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">octl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_gctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">));</span>
	<span class="n">octl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_old_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">_gctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">octl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">octl</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_gctl_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_gctl</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">gctl</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_old_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">octl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_gctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">gctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">));</span>
	
	<span class="n">octl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_old_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">_gctl</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">octl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">gctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">octl</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_verify_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">gctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_id</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_del_controls</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_del_control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	     	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">)))</span>
	     		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_emu10k1_look_for_ctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gctl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_gctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">gctl</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_controls</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_emu10k1_look_for_ctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">!=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">!=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	     	<span class="cm">/* FIXME: we need to check the WRITE access */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_gctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">gctl</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_controls</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">__error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gctl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_ctl_private_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	
	<span class="n">ctl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="p">)</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_add_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">gctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="o">*</span><span class="n">nctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">knew</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">gctl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">nctl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span> <span class="o">||</span> <span class="o">!</span><span class="n">gctl</span> <span class="o">||</span> <span class="o">!</span><span class="n">nctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_gctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">gctl</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_controls</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">!=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">!=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">snd_emu10k1_look_for_ctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">knew</span><span class="p">));</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_emu10k1_gpr_ctl_info</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">copy_tlv</span><span class="p">(</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">knew</span><span class="p">.</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
			<span class="n">knew</span><span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_emu10k1_gpr_ctl_get</span><span class="p">;</span>
		<span class="n">knew</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_emu10k1_gpr_ctl_put</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">nctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nctl</span><span class="p">));</span>
		<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">;</span>
		<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>	<span class="cm">/* inverted, we want to write new value in gpr_ctl_put() */</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
		<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
		<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">gctl</span><span class="o">-&gt;</span><span class="n">translation</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">knew</span><span class="p">.</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">knew</span><span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctl</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="o">*</span><span class="n">nctl</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">knew</span><span class="p">,</span> <span class="n">emu</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">knew</span><span class="p">.</span><span class="n">tlv</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_emu10k1_ctl_private_free</span><span class="p">;</span>
			<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">gpr_ctl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* overwrite */</span>
			<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
			<span class="n">nctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="o">*</span><span class="n">nctl</span><span class="p">;</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
			                          <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_gpr_ctl_put</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="nl">__error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_del_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_id</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_del_controls</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_del_control_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	     	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">snd_emu10k1_look_for_ctl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span>
			<span class="n">snd_ctl_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_list_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">gctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_ctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="n">gctl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">gpr_ctl</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_controls</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_control_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gctl</span><span class="p">));</span>
			<span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">;</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
			<span class="n">gctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_gctl_to_user</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_controls</span><span class="p">,</span>
					      <span class="n">gctl</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">gctl</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_list_control_total</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gctl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_icode_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_verify_controls</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* stop FX processor - this may be dangerous, but it&#39;s better to miss</span>
<span class="cm">	   some samples than generate wrong ones - [jk] */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">A_DBG_SINGLE_STEP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span><span class="p">);</span>
	<span class="cm">/* ok, do the main job */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_del_controls</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_gpr_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_tram_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_code_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_add_controls</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="cm">/* start FX processor when the DSP code is updated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
      <span class="nl">__error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_icode_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* ok, do the main job */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_gpr_peek</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_tram_peek</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_code_peek</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_list_controls</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_ipcm_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm_rec</span> <span class="o">*</span><span class="n">ipcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&gt;=</span> <span class="n">EMU10K1_FX8010_PCM_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">pcm</span><span class="p">[</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">];</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* remove */</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FIXME: we need to add universal code to the PCM transfer routine */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">tram_start</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">tram_start</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
      <span class="nl">__error:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_ipcm_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm_rec</span> <span class="o">*</span><span class="n">ipcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&gt;=</span> <span class="n">EMU10K1_FX8010_PCM_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">pcm</span><span class="p">[</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">];</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">tram_start</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">tram_start</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">res1</span> <span class="o">=</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">res2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SND_EMU10K1_GPR_CONTROLS	44</span>
<span class="cp">#define SND_EMU10K1_INPUTS		12</span>
<span class="cp">#define SND_EMU10K1_PLAYBACK_CHANNELS	8</span>
<span class="cp">#define SND_EMU10K1_CAPTURE_CHANNELS	4</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high_res_gpr_volume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_db_linear</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_db_scale1</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_TABLE100</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high_res_gpr_volume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_db_linear</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_db_scale1</span><span class="p">;</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_TABLE100</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu10k1_init_mono_onoff_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_ONOFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">defval</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_ONOFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Used for emu1010 - conversion from 32-bit capture inputs from HANA</span>
<span class="cm"> * to 2 x 16-bit registers in audigy - their values are read via DMA.</span>
<span class="cm"> * Conversion is performed by Audigy DSP instructions of FX8010.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit_shifter16</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">reg_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reg_in</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">bit_shifter16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iTSTNEG</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_80000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">bit_shifter16</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_C_80000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">bit_shifter16</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_00010000</span><span class="p">);</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">reg_out</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_ffffffff</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">reg_out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initial DSP configuration for Audigy</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">_snd_emu10k1_audigy_init_efx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">nctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit_shifter16</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">playback</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">capture</span> <span class="o">=</span> <span class="n">playback</span> <span class="o">+</span> <span class="p">(</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* we reserve 10 voices */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">stereo_mix</span> <span class="o">=</span> <span class="n">capture</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">controls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gpr_map</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">seg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">icode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">icode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
	     <span class="n">kcalloc</span><span class="p">(</span><span class="mi">512</span> <span class="o">+</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_int32_t</span><span class="p">),</span>
		     <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">controls</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">SND_EMU10K1_GPR_CONTROLS</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">controls</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpr_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">;</span>

	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span> <span class="o">+</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>

	<span class="cm">/* clear free GPRs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_valid</span><span class="p">);</span>
		
	<span class="cm">/* clear TRAM data &amp; address lines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Audigy DSP code for ALSA&quot;</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gpr</span> <span class="o">=</span> <span class="n">stereo_mix</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00007fff</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">bit_shifter16</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>

	<span class="cm">/* stop FX processor */</span>
	<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">A_DBG_SINGLE_STEP</span><span class="p">);</span>

<span class="cp">#if 1</span>
	<span class="cm">/* PCM front Playback Volume (independent from stereo mix)</span>
<span class="cm">	 * playback = 0 + ( gpr * FXBUS_PCM_LEFT_FRONT &gt;&gt; 31)</span>
<span class="cm">	 * where gpr contains attenuation from corresponding mixer control</span>
<span class="cm">	 * (snd_emu10k1_init_stereo_control)</span>
<span class="cm">	 */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT_FRONT</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT_FRONT</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM Front Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* PCM Surround Playback (independent from stereo mix) */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT_REAR</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT_REAR</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM Surround Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="cm">/* PCM Side Playback (independent from stereo mix) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">spk71</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT_SIDE</span><span class="p">));</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">7</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT_SIDE</span><span class="p">));</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM Side Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PCM Center Playback (independent from stereo mix) */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_CENTER</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM Center Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* PCM LFE Playback (independent from stereo mix) */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LFE</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM LFE Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Stereo Mix</span>
<span class="cm">	 */</span>
	<span class="cm">/* Wave (PCM) Playback Volume (will be renamed later) */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Wave Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Synth Playback */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_LEFT</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_RIGHT</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Synth Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Wave (PCM) Capture */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;PCM Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Synth Capture */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_LEFT</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_RIGHT</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Synth Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      
	<span class="cm">/*</span>
<span class="cm">	 * inputs</span>
<span class="cm">	 */</span>
<span class="cp">#define A_ADD_VOLUME_IN(var,vol,input) \</span>
<span class="cp">A_OP(icode, &amp;ptr, iMAC0, A_GPR(var), A_GPR(var), A_GPR(vol), A_EXTIN(input))</span>

	<span class="cm">/* emu1212 DSP 0 and DSP 1 Capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">emu_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ca0108_chip</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Note:JCD:No longer bit shift lower 16bits to upper 16bits of 32bit value. */</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A3_EMU32IN</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span> <span class="n">A_C_00000001</span><span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A3_EMU32IN</span><span class="p">(</span><span class="mh">0x1</span><span class="p">),</span> <span class="n">A_C_00000001</span><span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x0</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x1</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;EMU Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* AC&#39;97 Playback Volume - used only for mic (renamed later) */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_AC97_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_AC97_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;AMic Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* AC&#39;97 Capture Volume - used only for mic */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_AC97_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_AC97_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* mic capture buffer */</span>	
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iINTERP</span><span class="p">,</span> <span class="n">A_EXTOUT</span><span class="p">(</span><span class="n">A_EXTOUT_MIC_CAP</span><span class="p">),</span> <span class="n">A_EXTIN</span><span class="p">(</span><span class="n">A_EXTIN_AC97_L</span><span class="p">),</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="n">A_EXTIN</span><span class="p">(</span><span class="n">A_EXTIN_AC97_R</span><span class="p">));</span>

	<span class="cm">/* Audigy CD Playback Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_SPDIF_CD_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_SPDIF_CD_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Audigy CD Playback Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;CD Playback Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Audigy CD Capture Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_SPDIF_CD_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_SPDIF_CD_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Audigy CD Capture Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;CD Capture Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

 	<span class="cm">/* Optical SPDIF Playback Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_OPT_SPDIF_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_OPT_SPDIF_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Optical &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Optical SPDIF Capture Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_OPT_SPDIF_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_OPT_SPDIF_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Optical &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Line2 Playback Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_LINE2_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_LINE2_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Line2 Playback Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;Line Playback Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Line2 Capture Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_LINE2_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_LINE2_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Line2 Capture Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;Line Capture Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        
	<span class="cm">/* Philips ADC Playback Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_ADC_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_ADC_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Analog Mix Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Philips ADC Capture Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_ADC_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_ADC_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Analog Mix Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Aux2 Playback Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_AUX2_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_AUX2_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Aux2 Playback Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Aux2 Capture Volume */</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">A_EXTIN_AUX2_L</span><span class="p">);</span>
	<span class="n">A_ADD_VOLUME_IN</span><span class="p">(</span><span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A_EXTIN_AUX2_R</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span>
					<span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ac97_chip</span> <span class="o">?</span> <span class="s">&quot;Aux2 Capture Volume&quot;</span> <span class="o">:</span> <span class="s">&quot;Aux Capture Volume&quot;</span><span class="p">,</span>
					<span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="cm">/* Stereo Mix Front Playback Volume */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Front Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="cm">/* Stereo Mix Surround Playback */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Surround Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Stereo Mix Center Playback */</span>
	<span class="cm">/* Center = sub = Left/2 + Right/2 */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iINTERP</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">),</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Center Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Stereo Mix LFE Playback */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;LFE Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">spk71</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stereo Mix Side Playback */</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="p">));</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">7</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">7</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">stereo_mix</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Side Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * outputs</span>
<span class="cm">	 */</span>
<span class="cp">#define A_PUT_OUTPUT(out,src) A_OP(icode, &amp;ptr, iACC3, A_EXTOUT(out), A_C_00000000, A_C_00000000, A_GPR(src))</span>
<span class="cp">#define A_PUT_STEREO_OUTPUT(out1,out2,src) \</span>
<span class="cp">	{A_PUT_OUTPUT(out1,src); A_PUT_OUTPUT(out2,src+1);}</span>

<span class="cp">#define _A_SWITCH(icode, ptr, dst, src, sw) \</span>
<span class="cp">	A_OP((icode), ptr, iMACINT0, dst, A_C_00000000, src, sw);</span>
<span class="cp">#define A_SWITCH(icode, ptr, dst, src, sw) \</span>
<span class="cp">		_A_SWITCH(icode, ptr, A_GPR(dst), A_GPR(src), A_GPR(sw))</span>
<span class="cp">#define _A_SWITCH_NEG(icode, ptr, dst, src) \</span>
<span class="cp">	A_OP((icode), ptr, iANDXOR, dst, src, A_C_00000001, A_C_00000001);</span>
<span class="cp">#define A_SWITCH_NEG(icode, ptr, dst, src) \</span>
<span class="cp">		_A_SWITCH_NEG(icode, ptr, A_GPR(dst), A_GPR(src))</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Process tone control</span>
<span class="cm">	 */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* left */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* right */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* rear left */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* rear right */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* center */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* LFE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">spk71</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* side left */</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span> <span class="cm">/* side right */</span>
	<span class="p">}</span>
	

	<span class="n">ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_BASS</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_TREBLE</span><span class="p">;</span>

<span class="cp">#define BASS_GPR	0x8c</span>
<span class="cp">#define TREBLE_GPR	0x96</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">nctl</span> <span class="o">+</span> <span class="mi">0</span><span class="p">].</span><span class="n">gpr</span><span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASS_GPR</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">nctl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">gpr</span><span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* front/rear/center-lfe/side */</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* left/right */</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mh">0xb0</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mh">0xe0</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR_ACCU</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>

			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR_ACCU</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000010</span><span class="p">);</span>

			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* center */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nctl</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cp">#undef BASS_GPR</span>
<span class="cp">#undef TREBLE_GPR</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">A_SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">A_SWITCH_NEG</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">A_SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">nctl</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Tone Control - Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Master volume (will be renamed later) */</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">0</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">0</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">6</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">6</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">7</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span><span class="o">+</span><span class="mi">7</span><span class="o">+</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">));</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">nctl</span><span class="o">++</span><span class="p">],</span> <span class="s">&quot;Wave Master Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* analog speakers */</span>
	<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_AFRONT_L</span><span class="p">,</span> <span class="n">A_EXTOUT_AFRONT_R</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_AREAR_L</span><span class="p">,</span> <span class="n">A_EXTOUT_AREAR_R</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">2</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ACENTER</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">4</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ALFE</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">5</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">spk71</span><span class="p">)</span>
		<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ASIDE_L</span><span class="p">,</span> <span class="n">A_EXTOUT_ASIDE_R</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">6</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>

	<span class="cm">/* headphone */</span>
	<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_HEADPHONE_L</span><span class="p">,</span> <span class="n">A_EXTOUT_HEADPHONE_R</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>

	<span class="cm">/* digital outputs */</span>
	<span class="cm">/* A_PUT_STEREO_OUTPUT(A_EXTOUT_FRONT_L, A_EXTOUT_FRONT_R, playback + SND_EMU10K1_PLAYBACK_CHANNELS); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">emu_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EMU1010 Outputs from PCM Front, Rear, Center, LFE, Side */</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;EMU outputs on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ca0108_chip</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A3_EMU32OUT</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_EMU32OUTL</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* IEC958 Optical Raw Playback Switch */</span> 
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1008</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_FXBUS</span><span class="p">(</span><span class="n">FXBUS_PT_LEFT</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">A_GPR_COND</span><span class="p">,</span> <span class="n">A_GPR_COND</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000001</span><span class="p">);</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00010000</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
		<span class="n">A_SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">A_SWITCH_NEG</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">A_SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">z</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">spdif_bug</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Due to a SPDIF output bug on some Audigy cards, this code delays the Right channel by 1 sample */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Installing spdif_bug patch: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_EXTOUT</span><span class="p">(</span><span class="n">A_EXTOUT_FRONT_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_EXTOUT</span><span class="p">(</span><span class="n">A_EXTOUT_FRONT_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">nctl</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Optical Raw &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_REAR_L</span><span class="p">,</span> <span class="n">A_EXTOUT_REAR_R</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">2</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_CENTER</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">4</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_LFE</span><span class="p">,</span> <span class="n">playback</span><span class="o">+</span><span class="mi">5</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>

	<span class="cm">/* ADC buffer */</span>
<span class="cp">#ifdef EMU10K1_CAPTURE_DIGITAL_OUT</span>
	<span class="n">A_PUT_STEREO_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ADC_CAP_L</span><span class="p">,</span> <span class="n">A_EXTOUT_ADC_CAP_R</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ADC_CAP_L</span><span class="p">,</span> <span class="n">capture</span><span class="p">);</span>
	<span class="n">A_PUT_OUTPUT</span><span class="p">(</span><span class="n">A_EXTOUT_ADC_CAP_R</span><span class="p">,</span> <span class="n">capture</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">emu_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">ca0108_chip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;EMU2 inputs on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> 
									<span class="n">bit_shifter16</span><span class="p">,</span>
									<span class="n">A3_EMU32IN</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
									<span class="n">A_FXBUS2</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;EMU inputs on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Capture 16 (originally 8) channels of S32_LE sound */</span>

			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG &quot;emufx.c: gpr=0x%x, tmp=0x%x\n&quot;,</span>
<span class="cm">			       gpr, tmp);</span>
<span class="cm">			*/</span>
			<span class="cm">/* For the EMU1010: How to get 32bit values from the DSP. High 16bits into L, low 16bits into R. */</span>
			<span class="cm">/* A_P16VIN(0) is delayed by one sample,</span>
<span class="cm">			 * so all other A_P16VIN channels will need to also be delayed</span>
<span class="cm">			 */</span>
			<span class="cm">/* Left ADC in. 1 of 2 */</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
			<span class="cm">/* Right ADC in 1 of 2 */</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="cm">/* Delaying by one sample: instead of copying the input</span>
<span class="cm">			 * value A_P16VIN to output A_FXBUS2 as in the first channel,</span>
<span class="cm">			 * we use an auxiliary register, delaying the value by one</span>
<span class="cm">			 * sample</span>
<span class="cm">			 */</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x1</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x2</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x3</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="cm">/* For 96kHz mode */</span>
			<span class="cm">/* Left ADC in. 2 of 2 */</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x8</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x4</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="cm">/* Right ADC in 2 of 2 */</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0xa</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x5</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x6</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span> <span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bit_shifter16</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0xe</span><span class="p">)</span> <span class="p">);</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x7</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="cm">/* Pavel Hofman - we still have voices, A_FXBUS2s, and</span>
<span class="cm">			 * A_P16VINs available -</span>
<span class="cm">			 * let&#39;s add 8 more capture channels - total of 16</span>
<span class="cm">			 */</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x10</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x8</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x12</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0x9</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x14</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xa</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x16</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xb</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x18</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xc</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x1a</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xd</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x1c</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xe</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
			<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">snd_emu10k1_audigy_dsp_convert_32_to_2x16</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
								  <span class="n">bit_shifter16</span><span class="p">,</span>
								  <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
								  <span class="n">A_FXBUS2</span><span class="p">(</span><span class="mh">0x1e</span><span class="p">));</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A_P16VIN</span><span class="p">(</span><span class="mh">0xf</span><span class="p">),</span>
			     <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		for (z = 4; z &lt; 8; z++) {</span>
<span class="c">			A_OP(icode, &amp;ptr, iACC3, A_FXBUS2(z), A_C_00000000, A_C_00000000, A_C_00000000);</span>
<span class="c">		}</span>
<span class="c">		for (z = 0xc; z &lt; 0x10; z++) {</span>
<span class="c">			A_OP(icode, &amp;ptr, iACC3, A_FXBUS2(z), A_C_00000000, A_C_00000000, A_C_00000000);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* EFX capture - capture the 16 EXTINs */</span>
		<span class="cm">/* Capture 16 channels of S16_LE sound */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">A_FXBUS2</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_C_00000000</span><span class="p">,</span> <span class="n">A_EXTIN</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
<span class="cp">#endif </span><span class="cm">/* JCD test */</span><span class="cp"></span>
	<span class="cm">/*</span>
<span class="cm">	 * ok, set up done..</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clear remaining instruction memory */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">A_OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>

	<span class="n">seg</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_control_count</span> <span class="o">=</span> <span class="n">nctl</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_controls</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">controls</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* support TLV */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_icode_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* clear again */</span>
	<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>

 <span class="nl">__err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">controls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * initial DSP configuration for Emu10k1</span>
<span class="cm"> */</span>

<span class="cm">/* when volume = max, then copy only to avoid volume modification */</span>
<span class="cm">/* with iMAC0 (negative values) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">_volume_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">C_00000002</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">_volume_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">C_00000002</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define VOLUME(icode, ptr, dst, src, vol) \</span>
<span class="cp">		_volume(icode, ptr, GPR(dst), GPR(src), GPR(vol))</span>
<span class="cp">#define VOLUME_IN(icode, ptr, dst, src, vol) \</span>
<span class="cp">		_volume(icode, ptr, GPR(dst), EXTIN(src), GPR(vol))</span>
<span class="cp">#define VOLUME_ADD(icode, ptr, dst, src, vol) \</span>
<span class="cp">		_volume_add(icode, ptr, GPR(dst), GPR(src), GPR(vol))</span>
<span class="cp">#define VOLUME_ADDIN(icode, ptr, dst, src, vol) \</span>
<span class="cp">		_volume_add(icode, ptr, GPR(dst), EXTIN(src), GPR(vol))</span>
<span class="cp">#define VOLUME_OUT(icode, ptr, dst, src, vol) \</span>
<span class="cp">		_volume_out(icode, ptr, EXTOUT(dst), GPR(src), GPR(vol))</span>
<span class="cp">#define _SWITCH(icode, ptr, dst, src, sw) \</span>
<span class="cp">	OP((icode), ptr, iMACINT0, dst, C_00000000, src, sw);</span>
<span class="cp">#define SWITCH(icode, ptr, dst, src, sw) \</span>
<span class="cp">		_SWITCH(icode, ptr, GPR(dst), GPR(src), GPR(sw))</span>
<span class="cp">#define SWITCH_IN(icode, ptr, dst, src, sw) \</span>
<span class="cp">		_SWITCH(icode, ptr, GPR(dst), EXTIN(src), GPR(sw))</span>
<span class="cp">#define _SWITCH_NEG(icode, ptr, dst, src) \</span>
<span class="cp">	OP((icode), ptr, iANDXOR, dst, src, C_00000001, C_00000001);</span>
<span class="cp">#define SWITCH_NEG(icode, ptr, dst, src) \</span>
<span class="cp">		_SWITCH_NEG(icode, ptr, GPR(dst), GPR(src))</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">_snd_emu10k1_init_efx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">playback</span><span class="p">,</span> <span class="n">capture</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm_rec</span> <span class="o">*</span><span class="n">ipcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="o">*</span><span class="n">controls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gpr_map</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">seg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">icode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">icode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
	     <span class="n">kcalloc</span><span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">160</span> <span class="o">+</span> <span class="mi">160</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_int32_t</span><span class="p">),</span>
		     <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">controls</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">SND_EMU10K1_GPR_CONTROLS</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ipcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpr_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">;</span>

	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_data_map</span> <span class="o">+</span> <span class="mi">160</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_addr_map</span> <span class="o">+</span> <span class="mi">160</span><span class="p">;</span>
	
	<span class="cm">/* clear free GPRs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_valid</span><span class="p">);</span>

	<span class="cm">/* clear TRAM data &amp; address lines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">icode</span><span class="o">-&gt;</span><span class="n">tram_valid</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SB Live! FX8010 code for ALSA v1.2 by Jaroslav Kysela&quot;</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* we have 12 inputs */</span>
	<span class="n">playback</span> <span class="o">=</span> <span class="n">SND_EMU10K1_INPUTS</span><span class="p">;</span>
	<span class="cm">/* we have 6 playback channels and tone control doubles */</span>
	<span class="n">capture</span> <span class="o">=</span> <span class="n">playback</span> <span class="o">+</span> <span class="p">(</span><span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">=</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">SND_EMU10K1_CAPTURE_CHANNELS</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>	<span class="cm">/* we need 4 temporary GPR */</span>
	<span class="cm">/* from 0x8c to 0xff is the area for tone control */</span>

	<span class="cm">/* stop FX processor */</span>
	<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Process FX Buses</span>
<span class="cm">	 */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_LEFT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_MIDI_RIGHT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT_REAR</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT_REAR</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_CENTER</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LFE</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>	<span class="cm">/* S/PDIF left */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>	<span class="cm">/* S/PDIF right */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT_FRONT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT_FRONT</span><span class="p">),</span> <span class="n">C_00000004</span><span class="p">);</span>

	<span class="cm">/* Raw S/PDIF PCM */</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">tram_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfffff000</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70000000</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000007</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x001f</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x001c</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x22</span>  <span class="o">-</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* skip at 01 to 22 */</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x22</span>  <span class="o">-</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* skip at 06 to 22 */</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">;</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x24</span> <span class="o">-</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* skip at 0a to 24 */</span>
	<span class="n">gpr_map</span><span class="p">[</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if the trigger flag is not set, skip */</span>
	<span class="cm">/* 00: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_trigger</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 01: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_ZERO</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
	<span class="cm">/* if the running flag is set, we&#39;re running */</span>
	<span class="cm">/* 02: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 03: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">C_00000004</span><span class="p">);</span>
	<span class="cm">/* wait until ((GPR_DBAC&gt;&gt;11) &amp; 0x1f) == 0x1c) */</span>
	<span class="cm">/* 04: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR_DBAC</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 05: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">));</span>
	<span class="cm">/* 06: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>
	<span class="cm">/* 07: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="n">C_00000010</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="cm">/* 08: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="cm">/* 09: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 0a: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">11</span><span class="p">));</span>
	<span class="cm">/* 0b: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="n">C_00000001</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="cm">/* 0c: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ETRAM_DATA</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 0d: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iLOG</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 0e: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* 0f: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_MINUS</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="cm">/* 10: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* 11: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ETRAM_DATA</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 12: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iLOG</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 13: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* 14: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_MINUS</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="cm">/* 15: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* 16: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span><span class="p">),</span> <span class="n">C_00000001</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 17: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_size</span><span class="p">));</span>
	<span class="cm">/* 18: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_MINUS</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="cm">/* 19: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 1a: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_ptr</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	
	<span class="cm">/* 1b: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span><span class="p">),</span> <span class="n">C_ffffffff</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 1c: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">GPR_COND</span><span class="p">,</span> <span class="n">CC_REG_NONZERO</span><span class="p">,</span> <span class="n">C_00000002</span><span class="p">);</span>
	<span class="cm">/* 1d: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_tmpcount</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_count</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 1e: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR_IRQ</span><span class="p">,</span> <span class="n">C_80000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="cm">/* 1f: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">C_00000001</span><span class="p">,</span> <span class="n">C_00010000</span><span class="p">);</span>

	<span class="cm">/* 20: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iANDXOR</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">gpr_running</span><span class="p">),</span> <span class="n">C_00010000</span><span class="p">,</span> <span class="n">C_00000001</span><span class="p">);</span>
	<span class="cm">/* 21: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iSKIP</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_7fffffff</span><span class="p">,</span> <span class="n">C_00000002</span><span class="p">);</span>

	<span class="cm">/* 22: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT1</span><span class="p">,</span> <span class="n">ETRAM_ADDR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="n">GPR_DBAC</span><span class="p">,</span> <span class="n">C_ffffffff</span><span class="p">);</span>
	<span class="cm">/* 23: */</span> <span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT1</span><span class="p">,</span> <span class="n">ETRAM_ADDR</span><span class="p">(</span><span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">etram</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">gpr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">),</span> <span class="n">GPR_DBAC</span><span class="p">,</span> <span class="n">C_ffffffff</span><span class="p">);</span>

	<span class="cm">/* 24: */</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">13</span><span class="p">;</span>

	<span class="cm">/* Wave Playback Volume */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VOLUME</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Wave Surround Playback Volume */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VOLUME</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave Surround Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="cm">/* Wave Center/LFE Playback Volume */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_LEFT</span><span class="p">),</span> <span class="n">FXBUS</span><span class="p">(</span><span class="n">FXBUS_PCM_RIGHT</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000002</span><span class="p">);</span>
	<span class="n">VOLUME</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave Center Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">VOLUME</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave LFE Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Wave Capture Volume + Switch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">VOLUME</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Wave Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Synth Playback Volume */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Synth Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Synth Capture Volume + Switch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Synth Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Synth Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Surround Digital Playback Volume (renamed later without Digital) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Surround Digital Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Surround Capture Volume + Switch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Surround Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Surround Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Center Playback Volume (renamed later without Digital) */</span>
	<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Center Digital Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">++</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* LFE Playback Volume + Switch (renamed later without Digital) */</span>
	<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_mono_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;LFE Digital Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">++</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Front Playback Volume */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Front Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Front Capture Volume + Switch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Front Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_emu10k1_init_mono_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Front Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Process inputs</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_AC97_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_AC97_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* AC&#39;97 Playback Volume */</span>
		<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_AC97_L</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EXTIN_AC97_R</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;AC97 Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* AC&#39;97 Capture Volume */</span>
		<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_AC97_L</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EXTIN_AC97_R</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span> <span class="n">gpr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;AC97 Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_SPDIF_CD_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_SPDIF_CD_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* IEC958 TTL Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_SPDIF_CD_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;TTL &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* IEC958 TTL Capture Volume + Switch */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_SPDIF_CD_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;TTL &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;TTL &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_ZOOM_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_ZOOM_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Zoom Video Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_ZOOM_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Zoom Video Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* Zoom Video Capture Volume + Switch */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_ZOOM_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Zoom Video Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Zoom Video Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_TOSLINK_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_TOSLINK_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* IEC958 Optical Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_TOSLINK_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;LiveDrive &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* IEC958 Optical Capture Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_TOSLINK_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;LiveDrive &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;LiveDrive &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_LINE1_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_LINE1_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Line LiveDrive Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_LINE1_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line LiveDrive Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* Line LiveDrive Capture Volume + Switch */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_LINE1_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line LiveDrive Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line LiveDrive Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_COAX_SPDIF_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_COAX_SPDIF_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* IEC958 Coax Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_COAX_SPDIF_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Coaxial &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* IEC958 Coax Capture Volume + Switch */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_COAX_SPDIF_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Coaxial &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Coaxial &quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_LINE2_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTIN_LINE2_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Line LiveDrive Playback Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">VOLUME_ADDIN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">EXTIN_LINE2_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line2 LiveDrive Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
		<span class="cm">/* Line LiveDrive Capture Volume */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH_IN</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXTIN_LINE2_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">VOLUME_ADD</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line2 LiveDrive Capture Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Line2 LiveDrive Capture Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Process tone control</span>
<span class="cm">	 */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* left */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* right */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* rear left */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* rear right */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* center */</span>
	<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span> <span class="cm">/* LFE */</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_bass_treble_db_scale</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_BASS</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">snd_emu10k1_bass_treble_db_scale</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">translation</span> <span class="o">=</span> <span class="n">EMU10K1_GPR_TRANSLATION_TREBLE</span><span class="p">;</span>

<span class="cp">#define BASS_GPR	0x8c</span>
<span class="cp">#define TREBLE_GPR	0x96</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">].</span><span class="n">gpr</span><span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASS_GPR</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">gpr</span><span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* front/rear/center-lfe */</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* left/right */</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mh">0xa0</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mh">0xd0</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR_ACCU</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">BASS_GPR</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>

			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACMV</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMAC0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR_ACCU</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">TREBLE_GPR</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iMACINT0</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_00000010</span><span class="p">);</span>

			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* center */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cp">#undef BASS_GPR</span>
<span class="cp">#undef TREBLE_GPR</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SWITCH_NEG</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Tone Control - Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Process outputs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* AC&#39;97 Playback Volume */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_TOSLINK_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_TOSLINK_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* IEC958 Optical Raw Playback Switch */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">SWITCH_NEG</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_TOSLINK_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#ifdef EMU10K1_CAPTURE_DIGITAL_OUT</span>
	 		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ADC_CAP_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">snd_emu10k1_init_stereo_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Optical Raw &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="n">gpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_HEADPHONE_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_HEADPHONE_R</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Headphone Playback Volume */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">SWITCH_NEG</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
			<span class="n">SWITCH</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">);</span>
			<span class="n">VOLUME_OUT</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">EXTOUT_HEADPHONE_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="n">z</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_emu10k1_init_stereo_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* AC&#39;97 can have also Headphone control */</span>
		<span class="n">snd_emu10k1_init_mono_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Headphone Center Playback Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_emu10k1_init_mono_onoff_control</span><span class="p">(</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Headphone LFE Playback Switch&quot;</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">gpr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_REAR_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_REAR_R</span><span class="p">)))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_REAR_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_REAR_L</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_REAR_R</span><span class="p">)))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_REAR_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_CENTER</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef EMU10K1_CENTER_LFE_FROM_FRONT</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_CENTER</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ACENTER</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_CENTER</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ACENTER</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_AC97_LFE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef EMU10K1_CENTER_LFE_FROM_FRONT</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_LFE</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ALFE</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_AC97_LFE</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ALFE</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">playback</span> <span class="o">+</span> <span class="n">SND_EMU10K1_PLAYBACK_CHANNELS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	
<span class="cp">#ifndef EMU10K1_CAPTURE_DIGITAL_OUT</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
 		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_ADC_CAP_L</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">capture</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>
<span class="cp">#endif</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EXTOUT_MIC_CAP</span><span class="p">))</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">EXTOUT</span><span class="p">(</span><span class="n">EXTOUT_MIC_CAP</span><span class="p">),</span> <span class="n">GPR</span><span class="p">(</span><span class="n">capture</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="cm">/* EFX capture - capture the 16 EXTINS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card_capabilities</span><span class="o">-&gt;</span><span class="n">sblive51</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On the Live! 5.1, FXBUS2(1) and FXBUS(2) are shared with EXTOUT_ACENTER</span>
<span class="cm">		 * and EXTOUT_ALFE, so we can&#39;t connect inputs to them for multitrack recording.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Since only 14 of the 16 EXTINs are used, this is not a big problem.  </span>
<span class="cm">		 * We route AC97L and R to FX capture 14 and 15, SPDIF CD in to FX capture </span>
<span class="cm">		 * 0 and 3, then the rest of the EXTINs to the corresponding FX capture </span>
<span class="cm">		 * channel.  Multitrack recorders will still see the center/lfe output signal </span>
<span class="cm">		 * on the second and third channels.</span>
<span class="cm">		 */</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span>
			<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">FXBUS2</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">EXTIN</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
	<span class="p">}</span>
	    

	<span class="k">if</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">SND_EMU10K1_GPR_CONTROLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* clear remaining instruction memory */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">OP</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">iACC3</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">,</span> <span class="n">C_00000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_tram_setup</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ipcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">seg</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_control_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_add_controls</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_control_gpr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">controls</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* support TLV */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_icode_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* clear again */</span>
	<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu10k1_ipcm_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ipcm</span><span class="p">);</span>
      <span class="nl">__err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">controls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">icode</span><span class="o">-&gt;</span><span class="n">gpr_map</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_emu10k1_init_efx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">gpr_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_snd_emu10k1_audigy_init_efx</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">_snd_emu10k1_init_efx</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_emu10k1_free_efx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop processor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="n">A_DBG_SINGLE_STEP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* FIXME: who use them? */</span>
<span class="c">int snd_emu10k1_fx8010_tone_control_activate(struct snd_emu10k1 *emu, int output)</span>
<span class="c">{</span>
<span class="c">	if (output &lt; 0 || output &gt;= 6)</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	snd_emu10k1_ptr_write(emu, emu-&gt;gpr_base + 0x94 + output, 0, 1);</span>
<span class="c">	return 0;</span>
<span class="c">}</span>

<span class="c">int snd_emu10k1_fx8010_tone_control_deactivate(struct snd_emu10k1 *emu, int output)</span>
<span class="c">{</span>
<span class="c">	if (output &lt; 0 || output &gt;= 6)</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	snd_emu10k1_ptr_write(emu, emu-&gt;gpr_base + 0x94 + output, 0, 0);</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_tram_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">size_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* size is in samples */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">size_reg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mh">0x2000</span> <span class="o">&lt;&lt;</span> <span class="n">size_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">bytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">emu_lock</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">HCFG_LOCKTANKCACHE_MASK</span> <span class="o">|</span> <span class="n">inl</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">),</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">emu_lock</span><span class="p">);</span>
	<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCBS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">area</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">);</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					<span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCBS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_reg</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">emu_lock</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCFG_LOCKTANKCACHE_MASK</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">emu_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">null</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">&quot;%s %02X&quot;</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_emu10k1_fx8010_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">fxbus</span><span class="p">,</span> <span class="o">**</span><span class="n">extin</span><span class="p">,</span> <span class="o">**</span><span class="n">extout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fxbus_mask</span><span class="p">,</span> <span class="n">extin_mask</span><span class="p">,</span> <span class="n">extout_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">internal_tram_size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">itram_size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">external_tram_size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">bytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fxbus</span> <span class="o">=</span> <span class="n">fxbuses</span><span class="p">;</span>
	<span class="n">extin</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="n">audigy_ins</span> <span class="o">:</span> <span class="n">creative_ins</span><span class="p">;</span>
	<span class="n">extout</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="n">audigy_outs</span> <span class="o">:</span> <span class="n">creative_outs</span><span class="p">;</span>
	<span class="n">fxbus_mask</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">fxbus_mask</span><span class="p">;</span>
	<span class="n">extin_mask</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extin_mask</span><span class="p">;</span>
	<span class="n">extout_mask</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">extout_mask</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">res</span><span class="o">++</span><span class="p">,</span> <span class="n">fxbus</span><span class="o">++</span><span class="p">,</span> <span class="n">extin</span><span class="o">++</span><span class="p">,</span> <span class="n">extout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copy_string</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fxbus_names</span><span class="p">[</span><span class="n">res</span><span class="p">],</span> <span class="n">fxbus_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">fxbus</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FXBUS&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">copy_string</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">extin_names</span><span class="p">[</span><span class="n">res</span><span class="p">],</span> <span class="n">extin_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">extin</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Unused&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">copy_string</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">extout_names</span><span class="p">[</span><span class="n">res</span><span class="p">],</span> <span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">extout</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Unused&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">res</span><span class="o">++</span><span class="p">,</span> <span class="n">extout</span><span class="o">++</span><span class="p">)</span>
		<span class="n">copy_string</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">extout_names</span><span class="p">[</span><span class="n">res</span><span class="p">],</span> <span class="n">extout_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">extout</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Unused&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">gpr_controls</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">gpr_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_code</span> <span class="o">*</span><span class="n">icode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu10k1_fx8010_pcm_rec</span> <span class="o">*</span><span class="n">ipcm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_PVERSION</span>:
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">support_tlv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SNDRV_EMU10K1_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_INFO</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">snd_emu10k1_fx8010_info</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_CODE_POKE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">icode</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">icode</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">icode</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_emu10k1_icode_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_CODE_PEEK</span>:
		<span class="n">icode</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">icode</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">icode</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_emu10k1_icode_peek</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">icode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">icode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">icode</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">icode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_PCM_POKE</span>:
		<span class="n">ipcm</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipcm</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipcm</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_emu10k1_ipcm_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ipcm</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_PCM_PEEK</span>:
		<span class="n">ipcm</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipcm</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipcm</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_emu10k1_ipcm_peek</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ipcm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">ipcm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipcm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipcm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_TRAM_SETUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_tram_setup</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">A_DBG_SINGLE_STEP</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_CONTINUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_ZERO_TRAM_COUNTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">A_DBG_ZC</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">EMU10K1_DBG_ZC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_SINGLE_STEP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">A_DBG_SINGLE_STEP</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">A_DBG_SINGLE_STEP</span> <span class="o">|</span> <span class="n">A_DBG_STEP_ADDR</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|=</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span> <span class="o">|</span> <span class="n">EMU10K1_DBG_STEP</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_EMU10K1_IOCTL_DBG_READ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu10k1_fx8010_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_emu10k1_fx8010_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">**</span> <span class="n">rhwdep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">rhwdep</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rhwdep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hwdep_new</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;FX8010&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;EMU10K1 (FX8010)&quot;</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_HWDEP_IFACE_EMU10K1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_open</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_ioctl</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">snd_emu10k1_fx8010_release</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">emu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rhwdep</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rhwdep</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_emu10k1_efx_alloc_pm_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_gpr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_gpr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_val_saved</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_val_saved</span> <span class="o">||</span> <span class="o">!</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_icode</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_icode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_emu10k1_efx_free_pm_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_gpr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_val_saved</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_icode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * save/restore GPR, TRAM and codes</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_emu10k1_efx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_gpr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_val_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMDATAREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">snd_emu10k1_ptr_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_TANKMEMCTLREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_icode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_emu10k1_efx_read</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_emu10k1_efx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu10k1</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* set up TRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">size_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">bytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">size_reg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">HCFG_LOCKTANKCACHE_MASK</span> <span class="o">|</span> <span class="n">inl</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">),</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">);</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">etram_pages</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TCBS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_reg</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCFG_LOCKTANKCACHE_MASK</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HCFG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">A_DBG_SINGLE_STEP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span> <span class="o">|</span> <span class="n">EMU10K1_DBG_SINGLE_STEP</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">gpr_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_gpr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMDATAREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_val_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">TANKMEMADDRREGBASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">emu</span><span class="o">-&gt;</span><span class="n">tram_addr_saved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_emu10k1_efx_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">saved_icode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* start FX processor when the DSP code is updated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">audigy</span><span class="p">)</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">A_DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_emu10k1_ptr_write</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">DBG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fx8010</span><span class="p">.</span><span class="n">dbg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
