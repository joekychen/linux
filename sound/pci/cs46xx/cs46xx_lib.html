<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › cs46xx › cs46xx_lib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cs46xx_lib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *                   Abramo Bagnara &lt;abramo@alsa-project.org&gt;</span>
<span class="cm"> *                   Cirrus Logic, Inc.</span>
<span class="cm"> *  Routines for control of Cirrus Logic CS461x chips</span>
<span class="cm"> *</span>
<span class="cm"> *  KNOWN BUGS:</span>
<span class="cm"> *    - Sometimes the SPDIF input DSP tasks get&#39;s unsynchronized</span>
<span class="cm"> *      and the SPDIF get somewhat &quot;distorcionated&quot;, or/and left right channel</span>
<span class="cm"> *      are swapped. To get around this problem when it happens, mute and unmute </span>
<span class="cm"> *      the SPDIF input mixer control.</span>
<span class="cm"> *    - On the Hercules Game Theater XP the amplifier are sometimes turned</span>
<span class="cm"> *      off on inadecuate moments which causes distorcions on sound.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *    - Secondary CODEC on some soundcards</span>
<span class="cm"> *    - SPDIF input support for other sample rates then 48khz</span>
<span class="cm"> *    - Posibility to mix the SPDIF output with analog sources.</span>
<span class="cm"> *    - PCM channels for Center and LFE on secondary codec</span>
<span class="cm"> *</span>
<span class="cm"> *  NOTE: with CONFIG_SND_CS46XX_NEW_DSP unset uses old DSP image (which</span>
<span class="cm"> *        is default configuration), no SPDIF, no secondary codec, no</span>
<span class="cm"> *        multi channel PCM.  But known to work.</span>
<span class="cm"> *</span>
<span class="cm"> *  FINALLY: A credit to the developers Tom and Jordan </span>
<span class="cm"> *           at Cirrus for have helping me out with the DSP, however we</span>
<span class="cm"> *           still don&#39;t have sufficient documentation and technical</span>
<span class="cm"> *           references to be able to implement all fancy feutures</span>
<span class="cm"> *           supported by the cs46xx DSP&#39;s. </span>
<span class="cm"> *           Benny &lt;benny@hostmobility.com&gt;</span>
<span class="cm"> *                </span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>


<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/cs46xx.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;cs46xx_lib.h&quot;</span>
<span class="cp">#include &quot;dsp_spos.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">amp_voyetra</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_rear_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_rear_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_clfe_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_clfe_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_iec958_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_iec958_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_capture_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_capture_indirect_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_cs46xx_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">codec_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">result</span><span class="p">,</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span> <span class="o">&amp;&amp;</span>
		       <span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_index</span> <span class="o">==</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">CS46XX_SECONDARY_CODEC_OFFSET</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  1. Write ACCAD = Command Address Register = 46Ch for AC97 register address</span>
<span class="cm">	 *  2. Write ACCDA = Command Data Register = 470h    for data to write to AC97 </span>
<span class="cm">	 *  3. Write ACCTL = Control Register = 460h for initiating the write7---55</span>
<span class="cm">	 *  4. Read ACCTL = 460h, DCV should be reset by now and 460h = 17h</span>
<span class="cm">	 *  5. if DCV not cleared, break and return error</span>
<span class="cm">	 *  6. Read ACSTS = Status Register = 464h, check VSTS bit</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSDA</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">ACCTL_VFRM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>  <span class="s">&quot;cs46xx: ACCTL_VFRM not set 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ACCTL_ESYN</span><span class="p">))</span> <span class="o">|</span> <span class="n">ACCTL_VFRM</span> <span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_VFRM</span> <span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Setup the AC97 control registers on the CS461x to send the</span>
<span class="cm">	 *  appropriate command to the AC97 to perform the read.</span>
<span class="cm">	 *  ACCAD = Command Address Register = 46Ch</span>
<span class="cm">	 *  ACCDA = Command Data Register = 470h</span>
<span class="cm">	 *  ACCTL = Control Register = 460h</span>
<span class="cm">	 *  set DCV - will clear when process completed</span>
<span class="cm">	 *  set CRW - Read command</span>
<span class="cm">	 *  set VFRM - valid frame enabled</span>
<span class="cm">	 *  set ESYN - ASYNC generation enabled</span>
<span class="cm">	 *  set RSTN - ARST# inactive, AC97 codec not reset</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCAD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCDA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_index</span> <span class="o">==</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span><span class="cm">/* clear ACCTL_DCV */</span> <span class="n">ACCTL_CRW</span> <span class="o">|</span> 
				   <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span>
				   <span class="n">ACCTL_RSTN</span><span class="p">);</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_DCV</span> <span class="o">|</span> <span class="n">ACCTL_CRW</span> <span class="o">|</span>
				   <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span>
				   <span class="n">ACCTL_RSTN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_DCV</span> <span class="o">|</span> <span class="n">ACCTL_TC</span> <span class="o">|</span>
				   <span class="n">ACCTL_CRW</span> <span class="o">|</span> <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span>
				   <span class="n">ACCTL_RSTN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Wait for the read to occur.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  First, we want to wait for a short time.</span>
<span class="cm">	 	 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Now, check to see if the read has completed.</span>
<span class="cm">		 *  ACCTL = 460h, DCV should be reset by now and 460h = 17h</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACCTL_DCV</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ok1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 read problem (ACCTL_DCV), reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	
 <span class="nl">ok1:</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Wait for the valid status bit to go active.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the AC97 status register.</span>
<span class="cm">		 *  ACSTS = Status Register = 464h</span>
<span class="cm">		 *  VSTS - Valid Status</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACSTS_VSTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ok2</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 read problem (ACSTS_VSTS), codec_index %d, reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec_index</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

 <span class="nl">ok2:</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Read the data returned from the AC97 register.</span>
<span class="cm">	 *  ACSDA = Status Data Register = 474h</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;e) reg = 0x%x, val = 0x%x, BA0_ACCAD = 0x%x\n&quot;, reg,</span>
<span class="c">			snd_cs46xx_peekBA0(chip, BA0_ACSDA),</span>
<span class="c">			snd_cs46xx_peekBA0(chip, BA0_ACCAD));</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd<em>cs46xx</em>peekBA0(chip, BA0_ACCAD);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSDA</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
 <span class="nl">end:</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_cs46xx_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">codec_index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span> <span class="o">&amp;&amp;</span>
		       <span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">codec_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">codec_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span> <span class="o">&amp;&amp;</span>
		       <span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  1. Write ACCAD = Command Address Register = 46Ch for AC97 register address</span>
<span class="cm">	 *  2. Write ACCDA = Command Data Register = 470h    for data to write to AC97</span>
<span class="cm">	 *  3. Write ACCTL = Control Register = 460h for initiating the write</span>
<span class="cm">	 *  4. Read ACCTL = 460h, DCV should be reset by now and 460h = 07h</span>
<span class="cm">	 *  5. if DCV not cleared, break and return error</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Setup the AC97 control registers on the CS461x to send the</span>
<span class="cm">	 *  appropriate command to the AC97 to perform the read.</span>
<span class="cm">	 *  ACCAD = Command Address Register = 46Ch</span>
<span class="cm">	 *  ACCDA = Command Data Register = 470h</span>
<span class="cm">	 *  ACCTL = Control Register = 460h</span>
<span class="cm">	 *  set DCV - will clear when process completed</span>
<span class="cm">	 *  reset CRW - Write command</span>
<span class="cm">	 *  set VFRM - valid frame enabled</span>
<span class="cm">	 *  set ESYN - ASYNC generation enabled</span>
<span class="cm">	 *  set RSTN - ARST# inactive, AC97 codec not reset</span>
<span class="cm">         */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCAD</span> <span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCDA</span> <span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_index</span> <span class="o">==</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="cm">/* clear ACCTL_DCV */</span> <span class="n">ACCTL_VFRM</span> <span class="o">|</span>
				   <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_DCV</span> <span class="o">|</span> <span class="n">ACCTL_VFRM</span> <span class="o">|</span>
				   <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_DCV</span> <span class="o">|</span> <span class="n">ACCTL_TC</span> <span class="o">|</span>
				   <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  First, we want to wait for a short time.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Now, check to see if the write has completed.</span>
<span class="cm">		 *  ACCTL = 460h, DCV should be reset by now and 460h = 07h</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACCTL_DCV</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 write problem, codec_index = %d, reg = 0x%x, val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec_index</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
 <span class="nl">end:</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">codec_index</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span> <span class="o">&amp;&amp;</span>
		       <span class="n">codec_index</span> <span class="o">!=</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">codec_index</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Chip initialization</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">snd_cs46xx_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="n">bank</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* writel already converts 32-bit value to right endianess */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>

<span class="cp">#include &quot;imgs/cwc4630.h&quot;</span>
<span class="cp">#include &quot;imgs/cwcasync.h&quot;</span>
<span class="cp">#include &quot;imgs/cwcsnoop.h&quot;</span>
<span class="cp">#include &quot;imgs/cwcbinhack.h&quot;</span>
<span class="cp">#include &quot;imgs/cwcdma.h&quot;</span>

<span class="kt">int</span> <span class="nf">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="n">bank</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* writel already converts 32-bit value to right endianess */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* old DSP image */</span><span class="cp"></span>

<span class="cp">#include &quot;cs46xx_image.h&quot;</span>

<span class="kt">int</span> <span class="nf">snd_cs46xx_download_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">BA1_MEMORY_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs46xx_download</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">BA1Struct</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
					       <span class="n">BA1Struct</span><span class="p">.</span><span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
					       <span class="n">BA1Struct</span><span class="p">.</span><span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">BA1Struct</span><span class="p">.</span><span class="n">memory</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_CS46XX_NEW_DSP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Chip reset</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Write the reset bit of the SP control register.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">,</span> <span class="n">SPCR_RSTSP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Write the control register.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">,</span> <span class="n">SPCR_DRQEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Clear the trap registers.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_DREG</span><span class="p">,</span> <span class="n">DREG_REGID_TRAP_SELECT</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_TWPR</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_DREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set the frame timer to reflect the number of cycles per frame.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_FRMT</span><span class="p">,</span> <span class="mh">0xadf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs46xx_wait_for_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span><span class="kt">int</span> <span class="n">retry_timeout</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure the previous FIFO write operation has completed.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBST</span><span class="p">);</span>
    
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SERBST_WBSY</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="n">retry_timeout</span><span class="p">);</span>
	<span class="p">}</span>
  
	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SERBST_WBSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: failure waiting for &quot;</span>
			   <span class="s">&quot;FIFO command to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_clear_serial_FIFOs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">powerdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  See if the devices are powered down.  If so, we must power them up first</span>
<span class="cm">	 *  or they will not respond.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CLKCR1_SWCE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">CLKCR1_SWCE</span><span class="p">);</span>
		<span class="n">powerdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  We want to clear out the serial port FIFOs so we don&#39;t end up playing</span>
<span class="cm">	 *  whatever random garbage happens to be in them.  We fill the sample FIFOS</span>
<span class="cm">	 *  with zero (silence).</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBWP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Fill all 256 sample FIFO locations.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Make sure the previous FIFO write operation has completed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_wait_for_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;failed waiting for FIFO at addr (%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">powerdown</span><span class="p">)</span>
				<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
          
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Write the serial port FIFO index.</span>
<span class="cm">		 */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBAD</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Tell the serial port to load the new value into the FIFO location.</span>
<span class="cm">		 */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBCM</span><span class="p">,</span> <span class="n">SERBCM_WRC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Now, if we powered up the devices, then power them back down again.</span>
<span class="cm">	 *  This is kinda ugly, but should never happen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">powerdown</span><span class="p">)</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_proc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set the frame timer to reflect the number of cycles per frame.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_FRMT</span><span class="p">,</span> <span class="mh">0xadf</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Turn on the run, run at frame, and DMA enable bits in the local copy of</span>
<span class="cm">	 *  the SP control register.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">,</span> <span class="n">SPCR_RUN</span> <span class="o">|</span> <span class="n">SPCR_RUNFR</span> <span class="o">|</span> <span class="n">SPCR_DRQEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Wait until the run at frame bit resets itself in the SP control</span>
<span class="cm">	 *  register.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SPCR_RUNFR</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SPCR_RUNFR</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SPCR_RUNFR never reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_proc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Turn off the run, run at frame, and DMA enable bits in the local copy of</span>
<span class="cm">	 *  the SP control register.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_SPCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Sample rate routines</span>
<span class="cm"> */</span>

<span class="cp">#define GOF_PER_SEC 200</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_set_play_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phiIncr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">correctionPerGOF</span><span class="p">,</span> <span class="n">correctionPerSec</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Compute the values used to drive the actual sample rate conversion.</span>
<span class="cm">	 *  The following formulas are being computed, using inline assembly</span>
<span class="cm">	 *  since we need to use 64 bit arithmetic to compute the values:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  phiIncr = floor((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *  correctionPerGOF = floor((Fs,in * 2^26 - Fs,out * phiIncr) /</span>
<span class="cm">         *                                   GOF_PER_SEC)</span>
<span class="cm">         *  ulCorrectionPerSec = Fs,in * 2^26 - Fs,out * phiIncr -M</span>
<span class="cm">         *                       GOF_PER_SEC * correctionPerGOF</span>
<span class="cm">	 *</span>
<span class="cm">	 *  i.e.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  phiIncr:other = dividend:remainder((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *  correctionPerGOF:correctionPerSec =</span>
<span class="cm">	 *      dividend:remainder(ulOther / GOF_PER_SEC)</span>
<span class="cm">	 */</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">phiIncr</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">+=</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">tmp2</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">correctionPerGOF</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">correctionPerGOF</span> <span class="o">*</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">correctionPerSec</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Fill in the SampleRateConverter control block.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PSRC</span><span class="p">,</span>
	  <span class="p">((</span><span class="n">correctionPerSec</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">correctionPerGOF</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PPI</span><span class="p">,</span> <span class="n">phiIncr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_set_capture_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phiIncr</span><span class="p">,</span> <span class="n">coeffIncr</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">correctionPerGOF</span><span class="p">,</span> <span class="n">correctionPerSec</span><span class="p">,</span> <span class="n">initialDelay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frameGroupLength</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  We can only decimate by up to a factor of 1/9th the hardware rate.</span>
<span class="cm">	 *  Correct the value if an attempt is made to stray outside that limit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span> <span class="o">/</span> <span class="mi">9</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  We can not capture at at rate greater than the Input Rate (48000).</span>
<span class="cm">	 *  Return an error if an attempt is made to stray outside that limit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Compute the values used to drive the actual sample rate conversion.</span>
<span class="cm">	 *  The following formulas are being computed, using inline assembly</span>
<span class="cm">	 *  since we need to use 64 bit arithmetic to compute the values:</span>
<span class="cm">	 *</span>
<span class="cm">	 *     coeffIncr = -floor((Fs,out * 2^23) / Fs,in)</span>
<span class="cm">	 *     phiIncr = floor((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *     correctionPerGOF = floor((Fs,in * 2^26 - Fs,out * phiIncr) /</span>
<span class="cm">	 *                                GOF_PER_SEC)</span>
<span class="cm">	 *     correctionPerSec = Fs,in * 2^26 - Fs,out * phiIncr -</span>
<span class="cm">	 *                          GOF_PER_SEC * correctionPerGOF</span>
<span class="cm">	 *     initialDelay = ceil((24 * Fs,in) / Fs,out)</span>
<span class="cm">	 *</span>
<span class="cm">	 * i.e.</span>
<span class="cm">	 *</span>
<span class="cm">	 *     coeffIncr = neg(dividend((Fs,out * 2^23) / Fs,in))</span>
<span class="cm">	 *     phiIncr:ulOther = dividend:remainder((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *     correctionPerGOF:correctionPerSec =</span>
<span class="cm">	 * 	    dividend:remainder(ulOther / GOF_PER_SEC)</span>
<span class="cm">	 *     initialDelay = dividend(((24 * Fs,in) + Fs,out - 1) / Fs,out)</span>
<span class="cm">	 */</span>

	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">coeffIncr</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">coeffIncr</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">coeffIncr</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">coeffIncr</span> <span class="o">+=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">coeffIncr</span> <span class="o">^=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">coeffIncr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="mi">48000</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">phiIncr</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">+=</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">tmp2</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">correctionPerGOF</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">correctionPerGOF</span> <span class="o">*</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">correctionPerSec</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>
	<span class="n">initialDelay</span> <span class="o">=</span> <span class="p">((</span><span class="mi">48000</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="n">rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Fill in the VariDecimate control block.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CSRC</span><span class="p">,</span>
		<span class="p">((</span><span class="n">correctionPerSec</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">correctionPerGOF</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCI</span><span class="p">,</span> <span class="n">coeffIncr</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CD</span><span class="p">,</span>
		<span class="p">(((</span><span class="n">BA1_VARIDEC_BUF_1</span> <span class="o">+</span> <span class="p">(</span><span class="n">initialDelay</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CPI</span><span class="p">,</span> <span class="n">phiIncr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Figure out the frame group length for the write back task.  Basically,</span>
<span class="cm">	 *  this is just the factors of 24000 (2^6*3*5^3) that are not present in</span>
<span class="cm">	 *  the output sample rate.</span>
<span class="cm">	 */</span>
	<span class="n">frameGroupLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">/</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">*</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span>
			<span class="n">frameGroupLength</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frameGroupLength</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">*=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">/</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">*</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span> 
			<span class="n">frameGroupLength</span> <span class="o">*=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the WriteBack control block.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CFG1</span><span class="p">,</span> <span class="n">frameGroupLength</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CFG2</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x00800000</span> <span class="o">|</span> <span class="n">frameGroupLength</span><span class="p">));</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCST</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CSPB</span><span class="p">,</span> <span class="p">((</span><span class="mi">65536</span> <span class="o">*</span> <span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24000</span><span class="p">));</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">BA1_CSPB</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_pb_trans_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_indirect</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span> <span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_data</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">sw_data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span> <span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">snd_pcm_indirect_playback_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="n">snd_cs46xx_pb_trans_copy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_cp_trans_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_indirect</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">sw_data</span><span class="p">,</span>
	       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_indirect_capture_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="n">snd_cs46xx_cp_trans_copy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs46xx_playback_direct_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PBA</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ptr</span> <span class="o">-=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">&gt;&gt;</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs46xx_playback_indirect_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PBA</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ptr</span> <span class="o">-=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_indirect_playback_pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs46xx_capture_direct_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CBA</span><span class="p">)</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs46xx_capture_indirect_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CBA</span><span class="p">)</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_indirect_capture_pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="cm">/*struct snd_pcm_runtime *runtime = substream-&gt;runtime;*/</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
		<span class="cm">/* magic value to unmute PCM stream  playback volume */</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> 
				       <span class="n">SCBVolumeCtrl</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x80008000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
			<span class="n">cs46xx_dsp_pcm_link</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span> <span class="o">!=</span> <span class="n">CS46XX_FRAGS</span><span class="p">)</span>
			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span> <span class="o">!=</span> <span class="n">CS46XX_FRAGS</span><span class="p">)</span>
			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">play_ctl</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
		<span class="cm">/* magic mute channel */</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> 
				       <span class="n">SCBVolumeCtrl</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
			<span class="n">cs46xx_dsp_pcm_unlink</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">ctl</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_cs46xx_adjust_sample_rate</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">sample_rate</span><span class="p">)</span> 
<span class="p">{</span>

	<span class="cm">/* If PCMReaderSCB and SrcTaskSCB not created yet ... */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_pcm_channel</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> 
								   <span class="n">cpcm</span><span class="p">,</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: failed to create virtual PCM channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="cm">/* if sample rate is changed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">!=</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">unlinked</span> <span class="o">=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">;</span>
		<span class="n">cs46xx_dsp_destroy_pcm_channel</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_pcm_channel</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">cpcm</span><span class="p">,</span> 
									 <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
									 <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: failed to re-create virtual PCM channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unlinked</span><span class="p">)</span> <span class="n">cs46xx_dsp_pcm_link</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">period_size</span> <span class="o">=</span> <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sample_rate</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_cs46xx_adjust_sample_rate</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="p">,</span><span class="n">sample_rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_pcm_channel_set_period</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">,</span><span class="n">period_size</span><span class="p">))</span> <span class="p">{</span>
		 <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	 <span class="p">}</span>

	<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;period_size (%d), periods (%d) buffer_size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">period_size</span><span class="p">,</span> <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
		     <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS46XX_FRAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">!=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
			<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_MAIN_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_REAR_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_rear_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_CENTER_LFE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_clfe_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_IEC958_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_iec958_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">==</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_MAIN_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_indirect_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_REAR_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_indirect_rear_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_PCM_CENTER_LFE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_indirect_clfe_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">==</span> <span class="n">DSP_IEC958_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_indirect_iec958_ops</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_indirect_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*struct snd_cs46xx *chip = snd_pcm_substream_chip(substream);*/</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span><span class="p">;</span>

	<span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* if play_back open fails, then this function</span>
<span class="cm">	   is called and cpcm can actually be NULL here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">!=</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
    
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pfie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span><span class="p">;</span>

	<span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">pfie</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="p">);</span>
	<span class="n">pfie</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000f03f</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* old dsp */</span>
	<span class="n">pfie</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">);</span>
 	<span class="n">pfie</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000f03f</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* if to convert from stereo to mono */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="o">--</span><span class="p">;</span>
		<span class="n">pfie</span> <span class="o">|=</span> <span class="mh">0x00002000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if to convert from 8 bit to 16 bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="o">--</span><span class="p">;</span>
		<span class="n">pfie</span> <span class="o">|=</span> <span class="mh">0x00001000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if to convert to unsigned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">pfie</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>

	<span class="cm">/* Never convert byte order when sample stream is 8 bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* convert from big endian to little endian */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_big_endian</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
			<span class="n">pfie</span> <span class="o">|=</span> <span class="mh">0x00004000</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">));</span>
	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_rec</span><span class="p">.</span><span class="n">hw_buffer_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="n">CS46XX_FRAGS</span> <span class="o">&lt;&lt;</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000003ff</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* playback transaction count register */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* playback format &amp;&amp; interrupt enable */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pfie</span> <span class="o">|</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_slot</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PBA</span><span class="p">,</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PDTC</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000003ff</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PDTC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">,</span> <span class="n">pfie</span><span class="p">);</span>
	<span class="n">snd_cs46xx_set_play_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">cs46xx_dsp_pcm_ostream_set_period</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span> <span class="o">==</span> <span class="n">CS46XX_FRAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
			<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_capture_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_capture_indirect_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CBA</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">));</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">pcm_rec</span><span class="p">.</span><span class="n">hw_buffer_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">*</span> <span class="n">CS46XX_FRAGS</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">snd_cs46xx_set_capture_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_cs46xx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span><span class="n">cpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Read the Interrupt Status Register to clear the interrupt</span>
<span class="cm">	 */</span>
	<span class="n">status1</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">HICR_CHGM</span> <span class="o">|</span> <span class="n">HICR_IEV</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HSR0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DSP_MAX_PCM_CHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">status1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CS46XX_DSP_CAPTURE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span><span class="p">)</span>
						<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span> <span class="o">&amp;&amp;</span>
					    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_data</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unlinked</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cpcm</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
						<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span> <span class="o">&amp;&amp;</span> 
				    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_data</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unlinked</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cpcm</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#else</span>
	<span class="cm">/* old dsp */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">HISR_VC0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_pcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_pcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">HISR_VC1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">HISR_MIDI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIDSR_RBE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDRP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_RIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">snd_rawmidi_receive</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIDSR_TBF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_TIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDCR_TIE</span><span class="p">;</span>
				<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDWP</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  EOI to the PCI part....reenables interrupts</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">HICR_CHGM</span> <span class="o">|</span> <span class="n">HICR_IEV</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs46xx_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="cm">/*|*/</span>
				 <span class="cm">/*SNDRV_PCM_INFO_RESUME*/</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_BE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">5500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="n">CS46XX_MIN_PERIOD_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="n">CS46XX_MAX_PERIOD_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="n">CS46XX_FRAGS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs46xx_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="cm">/*|*/</span>
				 <span class="cm">/*SNDRV_PCM_INFO_RESUME*/</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">5500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="n">CS46XX_MIN_PERIOD_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="n">CS46XX_MAX_PERIOD_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="n">CS46XX_FRAGS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_period_sizes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">period_sizes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">period_sizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_pcm_free_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_cs46xx_playback_open_channel</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span><span class="kt">int</span> <span class="n">pcm_channel_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span> <span class="n">cpcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">cpcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cpcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cpcm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs46xx_playback</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">cpcm</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_cs46xx_pcm_free_substream</span><span class="p">;</span>

	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel_id</span> <span class="o">=</span> <span class="n">pcm_channel_id</span><span class="p">;</span>


	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span> 
				   <span class="o">&amp;</span><span class="n">hw_constraints_period_sizes</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_pcm</span> <span class="o">=</span> <span class="n">cpcm</span><span class="p">;</span> <span class="cm">/* HACK */</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">accept_valid</span><span class="p">)</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">info</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;open front channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_cs46xx_playback_open_channel</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span><span class="n">DSP_PCM_MAIN_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_open_rear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;open rear channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_cs46xx_playback_open_channel</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span><span class="n">DSP_PCM_REAR_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_open_clfe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;open center - LFE channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_cs46xx_playback_open_channel</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span><span class="n">DSP_PCM_CENTER_LFE_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_open_iec958</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;open raw iec958 channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">cs46xx_iec958_pre_open</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_cs46xx_playback_open_channel</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span><span class="n">DSP_IEC958_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_cs46xx_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_close_iec958</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
  
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;close raw iec958 channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs46xx_playback_close</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">cs46xx_iec958_post_close</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs46xx_capture</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">accept_valid</span><span class="p">)</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">info</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span> 
				   <span class="o">&amp;</span><span class="n">hw_constraints_period_sizes</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_pcm</span> <span class="o">*</span> <span class="n">cpcm</span><span class="p">;</span>

	<span class="n">cpcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* when playback_open fails, then cpcm can be NULL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpcm</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_destroy_pcm_channel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span><span class="p">);</span>
		<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">pcm_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpcm</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">hw_buf</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_rear_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_rear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_direct_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_rear_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_rear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_indirect_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_clfe_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_clfe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_direct_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_clfe_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_clfe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_indirect_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_iec958_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_iec958</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close_iec958</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_direct_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_iec958_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open_iec958</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close_iec958</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_indirect_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_direct_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_playback_indirect_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_playback_indirect_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack</span> <span class="o">=</span>			<span class="n">snd_cs46xx_playback_transfer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_direct_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs46xx_capture_indirect_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_cs46xx_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_cs46xx_capture_indirect_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack</span> <span class="o">=</span>			<span class="n">snd_cs46xx_capture_transfer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="cp">#define MAX_PLAYBACK_CHANNELS	(DSP_MAX_PCM_CHANNELS - 1)</span>
<span class="cp">#else</span>
<span class="cp">#define MAX_PLAYBACK_CHANNELS	1</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS46xx&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">MAX_PLAYBACK_CHANNELS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_capture_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_pcm_rear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS46xx - Rear&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">MAX_PLAYBACK_CHANNELS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_rear_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx - Rear&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_rear</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_pcm_center_lfe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS46xx - Center LFE&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">MAX_PLAYBACK_CHANNELS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_clfe_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx - Center LFE&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_center_lfe</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_pcm_iec958</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS46xx - IEC958&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_playback_iec958_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx - IEC958&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_rear</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ac97</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		       <span class="n">ac97</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">eapd_switch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> 
			    <span class="p">(</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_vol_dac_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_vol_dac_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_set_dac_volume</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					  <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int snd_cs46xx_vol_iec958_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)</span>
<span class="c">{</span>
<span class="c">	struct snd_cs46xx *chip = snd_kcontrol_chip(kcontrol);</span>

<span class="c">	ucontrol-&gt;value.integer.value[0] = chip-&gt;dsp_spos_instance-&gt;spdif_input_volume_left;</span>
<span class="c">	ucontrol-&gt;value.integer.value[1] = chip-&gt;dsp_spos_instance-&gt;spdif_input_volume_right;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>

<span class="c">static int snd_cs46xx_vol_iec958_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)</span>
<span class="c">{</span>
<span class="c">	struct snd_cs46xx *chip = snd_kcontrol_chip(kcontrol);</span>
<span class="c">	int change = 0;</span>

<span class="c">	if (chip-&gt;dsp_spos_instance-&gt;spdif_input_volume_left  != ucontrol-&gt;value.integer.value[0] ||</span>
<span class="c">	    chip-&gt;dsp_spos_instance-&gt;spdif_input_volume_right!= ucontrol-&gt;value.integer.value[1]) {</span>
<span class="c">		cs46xx_dsp_set_iec958_volume (chip,</span>
<span class="c">					      ucontrol-&gt;value.integer.value[0],</span>
<span class="c">					      ucontrol-&gt;value.integer.value[1]);</span>
<span class="c">		change = 1;</span>
<span class="c">	}</span>

<span class="c">	return change;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#define snd_mixer_boolean_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_iec958_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">CS46XX_MIXER_SPDIF_OUTPUT_ELEMENT</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_iec958_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS46XX_MIXER_SPDIF_OUTPUT_ELEMENT</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">change</span><span class="p">)</span> 
			<span class="n">cs46xx_dsp_enable_spdif_out</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">cs46xx_dsp_disable_spdif_out</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">change</span> <span class="o">!=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS46XX_MIXER_SPDIF_INPUT_ELEMENT</span>:
		<span class="n">change</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs46xx_dsp_enable_spdif_in</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="cm">/* restore volume */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">cs46xx_dsp_disable_spdif_in</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		
		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">change</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">snd_BUG</span><span class="p">();</span> <span class="cm">/* should never happen ... */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_adc_capture_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> 
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_adc_capture_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_adc_capture</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_disable_adc_capture</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_pcm_capture_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> 
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_pcm_capture_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_pcm_capture</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_disable_pcm_capture</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_herc_spdif_select_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="n">EGPIODR_GPOE0</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Game Theatre XP card - EGPIO[0] is used to select SPDIF input optical or coaxial.</span>
<span class="cm"> */</span> 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_herc_spdif_select_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
                                       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* optical is default */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span> 
				   <span class="n">EGPIODR_GPOE0</span> <span class="o">|</span> <span class="n">val1</span><span class="p">);</span>  <span class="cm">/* enable EGPIO0 output */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> 
				   <span class="n">EGPIOPTR_GPPT0</span> <span class="o">|</span> <span class="n">val2</span><span class="p">);</span> <span class="cm">/* open-drain on output */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* coaxial */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span>  <span class="n">val1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EGPIODR_GPOE0</span><span class="p">);</span> <span class="cm">/* disable */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> <span class="n">val2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EGPIOPTR_GPPT0</span><span class="p">);</span> <span class="cm">/* disable */</span>
	<span class="p">}</span>

	<span class="cm">/* checking diff from the EGPIO direction register </span>
<span class="cm">	   should be enough */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val1</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>  <span class="o">|</span>
		<span class="cm">/* left and right validity bit */</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>


	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
                                         <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_all_bits</span><span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">|</span>
		<span class="cm">/* left and right validity bit */</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>


	<span class="n">change</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span> <span class="p">)</span>
		<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_CS46XX_NEW_DSP */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cs46xx_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DAC Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_info</span><span class="p">,</span>
<span class="cp">#ifndef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">BA1_PVOL</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_dac_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_dac_put</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">},</span>

<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ADC Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_vol_put</span><span class="p">,</span>
<span class="cp">#ifndef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">BA1_CVOL</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">VARIDECIMATE_SCB_ADDR</span> <span class="o">+</span> <span class="mh">0xE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">},</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ADC Capture Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_adc_capture_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_adc_capture_put</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DAC Capture Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_pcm_capture_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_pcm_capture_put</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Output &quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_iec958_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_iec958_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">CS46XX_MIXER_SPDIF_OUTPUT_ELEMENT</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Input &quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_iec958_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_iec958_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">CS46XX_MIXER_SPDIF_INPUT_ELEMENT</span><span class="p">,</span>
<span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Input IEC958 volume does not work for the moment. (Benny) */</span>
<span class="c">{</span>
<span class="c">	.iface = SNDRV_CTL_ELEM_IFACE_MIXER,</span>
<span class="c">	.name = SNDRV_CTL_NAME_IEC958(&quot;Input &quot;,NONE,VOLUME),</span>
<span class="c">	.info = snd_cs46xx_vol_info,</span>
<span class="c">	.get = snd_cs46xx_vol_iec958_get,</span>
<span class="c">	.put = snd_cs46xx_vol_iec958_put,</span>
<span class="c">	.private_value = (ASYNCRX_SCB_ADDR + 0xE) &lt;&lt; 2,</span>
<span class="c">},</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>  <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_default_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>   <span class="n">snd_cs46xx_spdif_default_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>	 <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_info</span><span class="p">,</span>
        <span class="p">.</span><span class="n">get</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>	 <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_stream_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>	 <span class="n">snd_cs46xx_spdif_stream_put</span>
<span class="p">},</span>

<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="cm">/* set primary cs4294 codec into Extended Audio Mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_front_dup_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">],</span> <span class="n">AC97_CSR_ACMODE</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_front_dup_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> 
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">],</span>
				    <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span>
				    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cs46xx_front_dup_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Duplicate Front&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs46xx_front_dup_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs46xx_front_dup_put</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="cm">/* Only available on the Hercules Game Theater XP soundcard */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hercules_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Optical/Coaxial SPDIF Input Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_mixer_boolean_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_herc_spdif_select_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_herc_spdif_select_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_codec_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* reset to defaults */</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	

	<span class="cm">/* set the desired CODEC mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs46xx: CODEC1 mode %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">snd_cs46xx_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs46xx: CODEC2 mode %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">snd_cs46xx_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span> <span class="cm">/* should never happen ... */</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* it&#39;s necessary to wait awhile until registers are accessible after RESET */</span>
	<span class="cm">/* because the PCM or MASTER volume registers can be modified, */</span>
	<span class="cm">/* the REC_GAIN register is used for tests */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ext_mid</span><span class="p">;</span>
    
		<span class="cm">/* use preliminary reads to settle the communication */</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
		<span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
		<span class="cm">/* modem? */</span>
		<span class="n">ext_mid</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_mid</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ext_mid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* test if we can write to the record gain volume register */</span>
		<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mh">0x8a05</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x8a05</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CS46xx secondary codec doesn&#39;t respond!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs46xx_detect_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_cs46xx_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span> <span class="o">==</span> <span class="n">amp_voyetra</span><span class="p">)</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_INV_EAPD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_codec_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="n">codec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_cs46xx: seconadry codec not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_codec_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="n">codec</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">codec</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_cs46xx: codec %d detection timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spdif_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
		<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_reset</span><span class="p">,</span>
<span class="cp">#endif</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_cs46xx_ac97_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs46xx_ac97_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* detect primary codec */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_cs46xx: detecting primary codec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_cs46xx_mixer_free_ac97_bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_detect_codec</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_cs46xx: detecting seconadry codec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* try detect a secondary codec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cs46xx_detect_codec</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_CS46XX_NEW_DSP */</span><span class="cp"></span>

	<span class="cm">/* add cs4630 mixer controls */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_cs46xx_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cs46xx_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">&amp;&amp;</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">==</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">)</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">spdif_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get EAPD mixer switch (for voyetra hack) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;External Amplifier&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">eapd_switch</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
    
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id2</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id2</span> <span class="o">==</span> <span class="mh">0x592b</span> <span class="o">||</span> <span class="n">id2</span> <span class="o">==</span> <span class="mh">0x592d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cs46xx_front_dup_ctl</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">snd_ac97_write_cache</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">],</span>
					     <span class="n">AC97_CSR_ACMODE</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* do soundcard specific mixer setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;calling chip-&gt;mixer_init(chip);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

 	<span class="cm">/* turn on amplifier */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  RawMIDI interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_midi_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">MIDCR_MRST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">|=</span> <span class="n">CS46XX_MODE_INPUT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">MIDCR_RXE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS46XX_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MIDCR_RXE</span> <span class="o">|</span> <span class="n">MIDCR_RIE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS46XX_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS46XX_MODE_INPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">|=</span> <span class="n">CS46XX_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">MIDCR_TXE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS46XX_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MIDCR_TXE</span> <span class="o">|</span> <span class="n">MIDCR_TIE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS46XX_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS46XX_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_RIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">MIDCR_RIE</span><span class="p">;</span>
			<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_RIE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDCR_RIE</span><span class="p">;</span>
			<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_TIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">MIDCR_TIE</span><span class="p">;</span>
			<span class="cm">/* fill UART FIFO buffer at first, and turn Tx interrupts only if necessary */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_TIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MIDSR_TBF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDCR_TIE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDWP</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">MIDCR_TIE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDCR_TIE</span><span class="p">;</span>
			<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_cs46xx_midi_output</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_cs46xx_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs46xx_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs46xx_midi_output_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_cs46xx_midi_input</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_cs46xx_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs46xx_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs46xx_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_midi</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">**</span><span class="n">rrawmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS46XX&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmidi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46XX&quot;</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_midi_output</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_midi_input</span><span class="p">);</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span> <span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span> <span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span> <span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * gameport interface</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_gameport_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>  <span class="c1">//outb(gameport-&gt;io, 0xFF);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_cs46xx_gameport_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">);</span> <span class="c1">//inb(gameport-&gt;io);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_gameport_cooked_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">axes</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buttons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">js1</span><span class="p">,</span> <span class="n">js2</span><span class="p">,</span> <span class="n">jst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">js1</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSC1</span><span class="p">);</span>
	<span class="n">js2</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSC2</span><span class="p">);</span>
	<span class="n">jst</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">);</span>
	
	<span class="o">*</span><span class="n">buttons</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">jst</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span> 
	
	<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js1</span> <span class="o">&amp;</span> <span class="n">JSC1_Y1V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC1_Y1V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js1</span> <span class="o">&amp;</span> <span class="n">JSC1_X1V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC1_X1V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js2</span> <span class="o">&amp;</span> <span class="n">JSC2_Y2V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC2_Y2V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js2</span> <span class="o">&amp;</span> <span class="n">JSC2_X2V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC2_X2V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">jst</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">jst</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="o">++</span><span class="n">jst</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">jst</span><span class="p">]</span><span class="o">==</span><span class="mh">0xFFFF</span><span class="p">)</span> <span class="n">axes</span><span class="p">[</span><span class="n">jst</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_gameport_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GAMEPORT_MODE_COOKED</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GAMEPORT_MODE_RAW</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;CS46xx Gameport&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gameport_set_port_data</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_cs46xx_gameport_open</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs46xx_gameport_read</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_cs46xx_gameport_trigger</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">cooked_read</span> <span class="o">=</span> <span class="n">snd_cs46xx_gameport_cooked_read</span><span class="p">;</span>

	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSIO</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="c1">// ?</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSCTL</span><span class="p">,</span> <span class="n">JSCTL_SP_MEDIUM_SLOW</span><span class="p">);</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_remove_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_remove_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_GAMEPORT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/*</span>
<span class="cm"> *  proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_cs46xx_io_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">file_private_data</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_region</span> <span class="o">*</span><span class="n">region</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry_ops</span> <span class="n">snd_cs46xx_proc_io_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs46xx_io_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_cs46xx_region</span> <span class="o">*</span><span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_DATA</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs46xx_proc_io_ops</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUSR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">cs46xx_dsp_proc_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_proc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">cs46xx_dsp_proc_done</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="cp">#define snd_cs46xx_proc_init(card, chip)</span>
<span class="cp">#define snd_cs46xx_proc_done(chip)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * stop the h/w</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs46xx_hw_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000f03f</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>  <span class="mh">0x00000010</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* playback interrupt disable */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CIE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000003f</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>  <span class="mh">0x00000011</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CIE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* capture interrupt disable */</span>

	<span class="cm">/*</span>
<span class="cm">         *  Stop playback DMA.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">         *  Stop capture DMA.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">         *  Reset the processor.</span>
<span class="cm">         */</span>
	<span class="n">snd_cs46xx_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs46xx_proc_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Power down the PLL.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Turn off the Processor by turning off the software clock enable flag in </span>
<span class="cm">	 *  the clock control register.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CLKCR1_SWCE</span><span class="p">;</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_cs46xx_remove_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">);</span> <span class="cm">/* force to off */</span>
	
	<span class="n">snd_cs46xx_proc_done</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">resource</span><span class="p">)</span>
		<span class="n">snd_cs46xx_hw_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_cs46xx_region</span> <span class="o">*</span><span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">remap_addr</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">remap_addr</span><span class="p">);</span>
		<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_spos_destroy</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  initialize chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs46xx_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 *  First, blast the clock control register to zero so that the PLL starts</span>
<span class="cm">         *  out in a known state, and blast the master serial port control register</span>
<span class="cm">         *  to zero so that the serial ports also start out in a known state.</span>
<span class="cm">         */</span>
        <span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If we are in AC97 mode, then we must set the part to a host controlled</span>
<span class="cm">         *  AC-link.  Otherwise, we won&#39;t be able to bring up the link.</span>
<span class="cm">         */</span>        
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERACC</span><span class="p">,</span> <span class="n">SERACC_HSP</span> <span class="o">|</span> <span class="n">SERACC_CHIP_TYPE_2_0</span> <span class="o">|</span> 
			   <span class="n">SERACC_TWO_CODECS</span><span class="p">);</span>	<span class="cm">/* 2.00 dual codecs */</span>
	<span class="cm">/* snd_cs46xx_pokeBA0(chip, BA0_SERACC, SERACC_HSP | SERACC_CHIP_TYPE_2_0); */</span> <span class="cm">/* 2.00 codec */</span>
<span class="cp">#else</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERACC</span><span class="p">,</span> <span class="n">SERACC_HSP</span> <span class="o">|</span> <span class="n">SERACC_CHIP_TYPE_1_03</span><span class="p">);</span> <span class="cm">/* 1.03 codec */</span>
<span class="cp">#endif</span>

        <span class="cm">/*</span>
<span class="cm">         *  Drive the ARST# pin low for a minimum of 1uS (as defined in the AC97</span>
<span class="cm">         *  spec) and then drive it high.  This is done for non AC97 modes since</span>
<span class="cm">         *  there might be logic external to the CS461x that uses the ARST# line</span>
<span class="cm">         *  for a reset.</span>
<span class="cm">         */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL2</span><span class="p">,</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#endif</span>
    
	<span class="cm">/*</span>
<span class="cm">	 *  The first thing we do here is to enable sync generation.  As soon</span>
<span class="cm">	 *  as we start receiving bit clock, we&#39;ll start producing the SYNC</span>
<span class="cm">	 *  signal.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL2</span><span class="p">,</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Now wait for a short while to allow the AC97 part to start</span>
<span class="cm">	 *  generating bit clock (so we don&#39;t try to start the PLL without an</span>
<span class="cm">	 *  input clock).</span>
<span class="cm">	 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set the serial port timing configuration, so that</span>
<span class="cm">	 *  the clock control circuit gets its clock from the correct place.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC1</span><span class="p">,</span> <span class="n">SERMC1_PTC_AC97</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Write the selected clock control setup to the hardware.  Do not turn on</span>
<span class="cm">	 *  SWCE yet (if requested), so that the devices clocked by the output of</span>
<span class="cm">	 *  PLL are not clocked until the PLL is stable.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_PLLCC</span><span class="p">,</span> <span class="n">PLLCC_LPF_1050_2780_KHZ</span> <span class="o">|</span> <span class="n">PLLCC_CDR_73_104_MHZ</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_PLLM</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR2</span><span class="p">,</span> <span class="n">CLKCR2_PDIVS_8</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Power up the PLL.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">CLKCR1_PLLP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">         *  Wait until the PLL has stabilized.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Turn on clocking of the core so that we can setup the serial ports.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">CLKCR1_PLLP</span> <span class="o">|</span> <span class="n">CLKCR1_SWCE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable FIFO  Host Bypass</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBCF</span><span class="p">,</span> <span class="n">SERBCF_HBP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Fill the serial port FIFOs with silence.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_clear_serial_FIFOs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set the serial port FIFO pointer to the first sample in the FIFO.</span>
<span class="cm">	 */</span>
	<span class="cm">/* snd_cs46xx_pokeBA0(chip, BA0_SERBSP, 0); */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Write the serial port configuration to the part.  The master</span>
<span class="cm">	 *  enable bit is not set until all other values have been written.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC1</span><span class="p">,</span> <span class="n">SERC1_SO1F_AC97</span> <span class="o">|</span> <span class="n">SERC1_SO1EN</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC2</span><span class="p">,</span> <span class="n">SERC2_SI1F_AC97</span> <span class="o">|</span> <span class="n">SERC1_SO1EN</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC1</span><span class="p">,</span> <span class="n">SERMC1_PTC_AC97</span> <span class="o">|</span> <span class="n">SERMC1_MSPE</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC7</span><span class="p">,</span> <span class="n">SERC7_ASDI2EN</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Wait for the codec ready signal from the AC97 codec.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the AC97 status register to see if we&#39;ve seen a CODEC READY</span>
<span class="cm">		 *  signal from the AC97 codec.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACSTS_CRDY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ok1</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;create - never read codec ready from AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;it is not probably bug, try to use CS4236 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
 <span class="nl">ok1:</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First, we want to wait for a short time. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
        
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACSTS_CRDY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *  Make sure CODEC is READY.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACSTS_CRDY</span><span class="p">))</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs46xx: never read card ready from secondary AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Assert the vaid frame signal so that we can start sending commands</span>
<span class="cm">	 *  to the AC97 codec.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL2</span><span class="p">,</span> <span class="n">ACCTL_VFRM</span> <span class="o">|</span> <span class="n">ACCTL_ESYN</span> <span class="o">|</span> <span class="n">ACCTL_RSTN</span><span class="p">);</span>
<span class="cp">#endif</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Wait until we&#39;ve sampled input slots 3 and 4 as valid, meaning that</span>
<span class="cm">	 *  the codec is pumping ADC data across the AC-link.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the input slot valid register and see if input slots 3 and</span>
<span class="cm">		 *  4 are valid yet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACISV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACISV_ISV3</span> <span class="o">|</span> <span class="n">ACISV_ISV4</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">ACISV_ISV3</span> <span class="o">|</span> <span class="n">ACISV_ISV4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ok2</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;create - never read ISV3 &amp; ISV4 from AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* This may happen on a cold boot with a Terratec SiXPack 5.1.</span>
<span class="cm">	   Reloading the driver may help, if there&#39;s other soundcards </span>
<span class="cm">	   with the same problem I would like to know. (Benny) */</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR: snd-cs46xx: never read ISV3 &amp; ISV4 from AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;       Try reloading the ALSA driver, if you find something</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;       broken or not working on your soundcard upon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;       this message please report to alsa-devel@alsa-project.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#endif</span>
 <span class="nl">ok2:</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Now, assert valid frame and the slot 3 and 4 valid bits.  This will</span>
<span class="cm">	 *  commense the transfer of digital audio data to the AC97 codec.</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">,</span> <span class="n">ACOSV_SLV3</span> <span class="o">|</span> <span class="n">ACOSV_SLV4</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Power down the DAC and ADC.  We will power them up (if) when we need</span>
<span class="cm">	 *  them.</span>
<span class="cm">	 */</span>
	<span class="cm">/* snd_cs46xx_pokeBA0(chip, BA0_AC97_POWERDOWN, 0x300); */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Turn off the Processor by turning off the software clock enable flag in </span>
<span class="cm">	 *  the clock control register.</span>
<span class="cm">	 */</span>
	<span class="cm">/* tmp = snd_cs46xx_peekBA0(chip, BA0_CLKCR1) &amp; ~CLKCR1_SWCE; */</span>
	<span class="cm">/* snd_cs46xx_pokeBA0(chip, BA0_CLKCR1, tmp); */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  start and load DSP </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_enable_stream_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">HICR_IEV</span> <span class="o">|</span> <span class="n">HICR_CHGM</span><span class="p">);</span>
        
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000f03f</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PFIE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* playback interrupt enable */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CIE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000003f</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>  <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CIE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* capture interrupt enable */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_start_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Reset the processor.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs46xx_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Download the image to the processor.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (cs46xx_dsp_load_module(chip, &amp;cwcemb80_module) &lt; 0) {</span>
<span class="c">		snd_printk(KERN_ERR &quot;image download error\n&quot;);</span>
<span class="c">		return -EIO;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_load_module</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwc4630_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error [cwc4630]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_load_module</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwcasync_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error [cwcasync]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_load_module</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwcsnoop_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error [cwcsnoop]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_load_module</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwcbinhack_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error [cwcbinhack]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_load_module</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cwcdma_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error [cwcdma]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_scb_and_task_init</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* old image */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_download_image</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;image download error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">         *  Stop playback DMA.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">play_ctl</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">         *  Stop capture DMA.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">snd_cs46xx_set_play_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
	<span class="n">snd_cs46xx_set_capture_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="n">snd_cs46xx_proc_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">cs46xx_enable_stream_irqs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	
<span class="cp">#ifndef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="cm">/* set the attenuation to 0dB */</span> 
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_PVOL</span><span class="p">,</span> <span class="mh">0x80008000</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CVOL</span><span class="p">,</span> <span class="mh">0x80008000</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	AMP control - null AMP</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amp_none</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>	
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">voyetra_setup_eapd_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	
	<span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">valid_slots</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">powerdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">modem_power</span><span class="p">,</span><span class="n">pin_config</span><span class="p">,</span><span class="n">logic_type</span><span class="p">;</span>

	<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;cs46xx: cs46xx_setup_eapd_slot()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  See if the devices are powered down.  If so, we must power them up first</span>
<span class="cm">	 *  or they will not respond.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CLKCR1_SWCE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">CLKCR1_SWCE</span><span class="p">);</span>
		<span class="n">powerdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear PRA.  The Bonzo chip will be used for GPIO not for modem</span>
<span class="cm">	 * stuff.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: cs46xx_setup_eapd_slot() - no secondary codec configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">modem_power</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_read</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> 
					     <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span>
					     <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>
	<span class="n">modem_power</span> <span class="o">&amp;=</span><span class="mh">0xFEFF</span><span class="p">;</span>

	<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> 
			       <span class="n">AC97_EXTENDED_MSTATUS</span><span class="p">,</span> <span class="n">modem_power</span><span class="p">,</span>
			       <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set GPIO pin&#39;s 7 and 8 so that they are configured for output.</span>
<span class="cm">	 */</span>
	<span class="n">pin_config</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_read</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> 
					    <span class="n">AC97_GPIO_CFG</span><span class="p">,</span>
					    <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>
	<span class="n">pin_config</span> <span class="o">&amp;=</span><span class="mh">0x27F</span><span class="p">;</span>

	<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> 
			       <span class="n">AC97_GPIO_CFG</span><span class="p">,</span> <span class="n">pin_config</span><span class="p">,</span>
			       <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>
    
	<span class="cm">/*</span>
<span class="cm">	 * Set GPIO pin&#39;s 7 and 8 so that they are compatible with CMOS logic.</span>
<span class="cm">	 */</span>

	<span class="n">logic_type</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span>
					   <span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>
	<span class="n">logic_type</span> <span class="o">&amp;=</span><span class="mh">0x27F</span><span class="p">;</span> 

	<span class="n">snd_cs46xx_codec_write</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">,</span>
				<span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">);</span>

	<span class="n">valid_slots</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">);</span>
	<span class="n">valid_slots</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">,</span> <span class="n">valid_slots</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">cs46xx_wait_for_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	  <span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;FIFO is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  
	  <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill slots 12 with the correct value for the GPIO pins. </span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mh">0x9F</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize the fifo so that bits 7 and 8 are on.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Remember that the GPIO pins in bonzo are shifted by 4 bits to</span>
<span class="cm">		 * the left.  0x1800 corresponds to bits 7 and 8.</span>
<span class="cm">		 */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBWP</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for command to complete</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">cs46xx_wait_for_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;failed waiting for FIFO at addr (%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
            
		<span class="cm">/*</span>
<span class="cm">		 * Write the serial port FIFO index.</span>
<span class="cm">		 */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBAD</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
      
		<span class="cm">/*</span>
<span class="cm">		 * Tell the serial port to load the new value into the FIFO location.</span>
<span class="cm">		 */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERBCM</span><span class="p">,</span> <span class="n">SERBCM_WRC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait for last command to complete */</span>
	<span class="n">cs46xx_wait_for_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Now, if we powered up the devices, then power them back down again.</span>
<span class="cm">	 *  This is kinda ugly, but should never happen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">powerdown</span><span class="p">)</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Crystal EAPD mode</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amp_voyetra</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Manage the EAPD bit on the Crystal 4297 </span>
<span class="cm">	   and the Analog AD1885 */</span>
	   
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">oval</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">snd_cs46xx_codec_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span>
				     <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">oval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn the EAPD amp on */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn the EAPD amp off */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_codec_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				       <span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">eapd_switch</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">eapd_switch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">voyetra_setup_eapd_slot</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hercules_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="cm">/* default: AMP off, and SPDIF input optical */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span> <span class="n">EGPIODR_GPOE0</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> <span class="n">EGPIODR_GPOE0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Game Theatre XP card - EGPIO[2] is used to enable the external amp.</span>
<span class="cm"> */</span> 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amp_hercules</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;Hercules amplifier ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span> 
				   <span class="n">EGPIODR_GPOE2</span> <span class="o">|</span> <span class="n">val1</span><span class="p">);</span>     <span class="cm">/* enable EGPIO2 output */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> 
				   <span class="n">EGPIOPTR_GPPT2</span> <span class="o">|</span> <span class="n">val2</span><span class="p">);</span>   <span class="cm">/* open-drain on output */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;Hercules amplifier OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span>  <span class="n">val1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EGPIODR_GPOE2</span><span class="p">);</span> <span class="cm">/* disable */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> <span class="n">val2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EGPIOPTR_GPPT2</span><span class="p">);</span> <span class="cm">/* disable */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">voyetra_mixer_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;initializing Voyetra mixer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Enable SPDIF out */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIODR</span><span class="p">,</span> <span class="n">EGPIODR_GPOE0</span><span class="p">);</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EGPIOPTR</span><span class="p">,</span> <span class="n">EGPIODR_GPOE0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hercules_mixer_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* set EGPIO to default */</span>
	<span class="n">hercules_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;initializing Hercules mixer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hercules_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hercules_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: failed to initialize Hercules mixer (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> *	Untested</span>
<span class="c"> */</span>
<span class="c"> </span>
<span class="c">static void amp_voyetra_4294(struct snd_cs46xx *chip, int change)</span>
<span class="c">{</span>
<span class="c">	chip-&gt;amplifier += change;</span>

<span class="c">	if (chip-&gt;amplifier) {</span>
<span class="c">		/* Switch the GPIO pins 7 and 8 to open drain */</span>
<span class="c">		snd_cs46xx_codec_write(chip, 0x4C,</span>
<span class="c">				       snd_cs46xx_codec_read(chip, 0x4C) &amp; 0xFE7F);</span>
<span class="c">		snd_cs46xx_codec_write(chip, 0x4E,</span>
<span class="c">				       snd_cs46xx_codec_read(chip, 0x4E) | 0x0180);</span>
<span class="c">		/* Now wake the AMP (this might be backwards) */</span>
<span class="c">		snd_cs46xx_codec_write(chip, 0x54,</span>
<span class="c">				       snd_cs46xx_codec_read(chip, 0x54) &amp; ~0x0180);</span>
<span class="c">	} else {</span>
<span class="c">		snd_cs46xx_codec_write(chip, 0x54,</span>
<span class="c">				       snd_cs46xx_codec_read(chip, 0x54) | 0x0180);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *	Handle the CLKRUN on a thinkpad. We must disable CLKRUN support</span>
<span class="cm"> *	whenever we need to beat on the chip.</span>
<span class="cm"> *</span>
<span class="cm"> *	The original idea and code for this hack comes from David Kaiser at</span>
<span class="cm"> *	Linuxcare. Perhaps one day Crystal will document their chips well</span>
<span class="cm"> *	enough to make them useful.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkrun_hack</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">acpi_port</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	
	<span class="cm">/* Read ACPI port */</span>	
	<span class="n">nval</span> <span class="o">=</span> <span class="n">control</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">acpi_port</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* Flip CLKRUN off while running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">)</span>
		<span class="n">nval</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x2000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nval</span> <span class="o">!=</span> <span class="n">control</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">nval</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">acpi_port</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
<span class="p">}</span>

	
<span class="cm">/*</span>
<span class="cm"> * detect intel piix4</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkrun_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pp</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">acpi_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_INTEL_82371AB_3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Not a thinkpad thats for sure */</span>

	<span class="cm">/* Find the control port */</span>		
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">acpi_port</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Card subid table</span>
<span class="cm"> */</span>
 
<span class="k">struct</span> <span class="n">cs_card_type</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">amp</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">active</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">mixer_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cs_card_type</span> <span class="n">__devinitdata</span> <span class="n">cards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1489</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x7001</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Genius Soundmaker 128 value&quot;</span><span class="p">,</span>
		<span class="cm">/* nothing special */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x5053</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x3357</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Voyetra&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_voyetra</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">voyetra_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1071</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x6003</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mitac MI6020/21&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_voyetra</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Hercules Game Theatre XP */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x14af</span><span class="p">,</span> <span class="cm">/* Guillemot Corporation */</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0050</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0051</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0052</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0053</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0054</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Game Theatre XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp_hercules</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">hercules_mixer_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Herculess Fortissimo */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa010</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Gamesurround Fortissimo II&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x1681</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa011</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hercules Gamesurround Fortissimo III 7.1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Teratec */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x153b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x112e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Terratec DMX XFire 1024&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x153b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1136</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Terratec SiXPack 5.1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Not sure if the 570 needs the clkrun hack */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0132</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Thinkpad 570&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">clkrun_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">clkrun_hack</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0153</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Thinkpad 600X/A20/T20&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">clkrun_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">clkrun_hack</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x1010</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Thinkpad 600E (unsupported)&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * APM support</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BA0_ACOSV</span><span class="p">,</span>
	<span class="cm">/*BA0_ASER_FADDR,*/</span>
	<span class="n">BA0_ASER_MASTER</span><span class="p">,</span>
	<span class="n">BA1_PVOL</span><span class="p">,</span>
	<span class="n">BA1_CVOL</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">snd_cs46xx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">amp_saved</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>chip->ac97<em>powerdown = snd</em>cs46xx<em>codec</em>read(chip, AC97<em>POWER</em>CONTROL);
chip->ac97<em>general</em>purpose = snd<em>cs46xx</em>codec<em>read(chip, BA0</em>AC97<em>GENERAL</em>PURPOSE);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">]);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">]);</span>

	<span class="cm">/* save some registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">saved_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">amp_saved</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">;</span>
	<span class="cm">/* turn off amp */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">);</span>
	<span class="n">snd_cs46xx_hw_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* disable CLKRUN */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">=</span> <span class="n">amp_saved</span><span class="p">;</span> <span class="cm">/* restore the status */</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_cs46xx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">amp_saved</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs46xx: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">amp_saved</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* force to on */</span>

	<span class="n">snd_cs46xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs46xx_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">cs46xx_dsp_resume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* restore some registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">saved_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#else</span>
	<span class="n">snd_cs46xx_download_image</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	snd_cs46xx_codec_write(chip, BA0_AC97_GENERAL_PURPOSE, </span>
<span class="c">			       chip-&gt;ac97_general_purpose);</span>
<span class="c">	snd_cs46xx_codec_write(chip, AC97_POWER_CONTROL, </span>
<span class="c">			       chip-&gt;ac97_powerdown);</span>
<span class="c">	mdelay(10);</span>
<span class="c">	snd_cs46xx_codec_write(chip, BA0_AC97_POWERDOWN,</span>
<span class="c">			       chip-&gt;ac97_powerdown);</span>
<span class="c">	mdelay(5);</span>
<span class="cp">#endif</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_PRIMARY_CODEC_INDEX</span><span class="p">]);</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">CS46XX_SECONDARY_CODEC_INDEX</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">         *  Stop capture DMA.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capt</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA1_CCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* reset playback/capture */</span>
	<span class="n">snd_cs46xx_set_play_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
	<span class="n">snd_cs46xx_set_capture_sample_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
	<span class="n">snd_cs46xx_proc_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">cs46xx_enable_stream_irqs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amp_saved</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* turn amp on */</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* disable CLKRUN */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier</span> <span class="o">=</span> <span class="n">amp_saved</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs46xx_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">external_amp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">thinkpad</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">**</span> <span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx_region</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs_card_type</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ss_card</span><span class="p">,</span> <span class="n">ss_vendor</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_cs46xx_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	
	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wrong address(es) - ba0 = 0x%lx, ba1 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span><span class="p">);</span>
	    	<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	    	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">ba0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx_BA0&quot;</span><span class="p">);</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span><span class="p">;</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS46XX_BA0_SIZE</span><span class="p">;</span>

	<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx_BA1_data0&quot;</span><span class="p">);</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">+</span> <span class="n">BA1_SP_DMEM0</span><span class="p">;</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS46XX_BA1_DATA0_SIZE</span><span class="p">;</span>

	<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx_BA1_data1&quot;</span><span class="p">);</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">+</span> <span class="n">BA1_SP_DMEM1</span><span class="p">;</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS46XX_BA1_DATA1_SIZE</span><span class="p">;</span>

	<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">pmem</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx_BA1_pmem&quot;</span><span class="p">);</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">+</span> <span class="n">BA1_SP_PMEM</span><span class="p">;</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS46XX_BA1_PRG_SIZE</span><span class="p">;</span>

	<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS46xx_BA1_reg&quot;</span><span class="p">);</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">+</span> <span class="n">BA1_SP_REG</span><span class="p">;</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS46XX_BA1_REG_SIZE</span><span class="p">;</span>

	<span class="cm">/* set up amp and clkrun hack */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss_vendor</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss_card</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">ss_vendor</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">ss_card</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;hack for %s enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">amp</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_init</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">mixer_init</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
				<span class="n">cp</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">external_amp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Crystal EAPD support forced on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span> <span class="o">=</span> <span class="n">amp_voyetra</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thinkpad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Activating CLKRUN hack for Thinkpad.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span> <span class="o">=</span> <span class="n">clkrun_hack</span><span class="p">;</span>
		<span class="n">clkrun_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span> <span class="o">=</span> <span class="n">amp_none</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span> <span class="o">=</span> <span class="n">amp_none</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* enable CLKRUN */</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
							   <span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to request memory region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">region</span><span class="o">-&gt;</span><span class="n">remap_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">remap_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ioremap problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_cs46xx_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_CS46XX_NEW_DSP</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span> <span class="o">=</span> <span class="n">cs46xx_dsp_spos_create</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs46xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">snd_cs46xx_proc_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">saved_regs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs46xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* disable CLKRUN */</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
