<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › cs46xx › dsp_spos_scb_lib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dsp_spos_scb_lib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 2002-07 Benny Sjostrand benny@hostmobility.com</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/cs46xx.h&gt;</span>

<span class="cp">#include &quot;cs46xx_lib.h&quot;</span>
<span class="cp">#include &quot;dsp_spos.h&quot;</span>

<span class="k">struct</span> <span class="n">proc_scb_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_symbol</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">symbol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">symbol_index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">symbol</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">symbol_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		       <span class="n">symbol_index</span> <span class="o">&gt;=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">symbol_index</span><span class="p">].</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_index</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">=</span> <span class="n">symbol_index</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_index</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">&gt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_scb_info_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_scb_info</span> <span class="o">*</span> <span class="n">scb_info</span>  <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span> <span class="o">=</span> <span class="n">scb_info</span><span class="o">-&gt;</span><span class="n">scb_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">scb_info</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span><span class="n">col</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">;</span>

	<span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%04x %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span><span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08x &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
	<span class="p">}</span>
  
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;parent [%s:%04x] &quot;</span><span class="p">,</span> 
			    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
			    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;parent [none] &quot;</span><span class="p">);</span>
  
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;sub_list_ptr [%s:%04x]</span><span class="se">\n</span><span class="s">next_scb_ptr [%s:%04x]  task_entry [%s:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">task_entry</span><span class="o">-&gt;</span><span class="n">symbol_name</span><span class="p">,</span>
		    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">task_entry</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;index [%d] ref_count [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>  
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsp_unlink_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unlink parent SCB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span> <span class="n">scb</span> <span class="o">&amp;&amp;</span>
			       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span> <span class="n">scb</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
  
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">==</span> <span class="n">scb</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* last and only node in parent sublist */</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* first node in parent sublist */</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* update next node parent ptr. */</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* update next node parent ptr. */</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update parent first entry in DSP RAM */</span>
		<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">);</span>

		<span class="cm">/* then update entry in DSP RAM */</span>
		<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="p">);</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsp_clear_sample_buffer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sample_buffer_addr</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">dword_count</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">sample_buffer_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dword_count</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>  
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* check integrety */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">+</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="n">scb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* can&#39;t remove a SCB with childs before </span>
<span class="c">	   removing childs first  */</span>
<span class="c">	if (snd_BUG_ON(scb-&gt;sub_list_ptr != ins-&gt;the_null_scb ||</span>
<span class="c">		       scb-&gt;next_scb_ptr != ins-&gt;the_null_scb))</span>
<span class="c">		goto _end;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>    
	<span class="n">_dsp_unlink_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cs46xx_dsp_proc_free_scb_desc</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_symbol</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">remove_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_symbol</span><span class="p">);</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span><span class="p">)</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span> <span class="o">&gt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* !!!! THIS IS A PIECE OF SHIT MADE BY ME !!! */</span>
<span class="c">	for(i = scb-&gt;index + 1;i &lt; ins-&gt;nscb; ++i) {</span>
<span class="c">		ins-&gt;scbs[i - 1].index = i - 1;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_free_scb_desc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">proc_scb_info</span> <span class="o">*</span> <span class="n">scb_info</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs46xx_dsp_proc_free_scb_desc: freeing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">);</span>

		<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">kfree</span> <span class="p">(</span><span class="n">scb_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_scb_info</span> <span class="o">*</span> <span class="n">scb_info</span><span class="p">;</span>

	<span class="cm">/* register to proc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">snd_card</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  
		<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span> 
							<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scb_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_scb_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scb_info</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
			<span class="n">scb_info</span><span class="o">-&gt;</span><span class="n">scb_desc</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
      
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">scb_info</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
      
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_scb_info_read</span><span class="p">;</span>
      
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">scb_info</span><span class="p">);</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="nl">out:</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">proc_info</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">_dsp_create_generic_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">scb_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">task_entry</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                         <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* fill the data that will be wroten to DSP */</span>
	<span class="n">scb_data</span><span class="p">[</span><span class="n">SCBsubListPtr</span><span class="p">]</span> <span class="o">=</span> 
		<span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="n">scb_data</span><span class="p">[</span><span class="n">SCBfuncEntryPtr</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF0000</span><span class="p">;</span>
	<span class="n">scb_data</span><span class="p">[</span><span class="n">SCBfuncEntryPtr</span><span class="p">]</span> <span class="o">|=</span> <span class="n">task_entry</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: creating SCB &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">scb_data</span><span class="p">,</span><span class="n">dest</span><span class="p">);</span>


	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">parent_scb</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">task_entry</span> <span class="o">=</span> <span class="n">task_entry</span><span class="p">;</span>

  
	<span class="cm">/* update parent SCB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk (&quot;scb-&gt;parent_scb_ptr = %s\n&quot;,scb-&gt;parent_scb_ptr-&gt;scb_name);</span>
<span class="c">		printk (&quot;scb-&gt;parent_scb_ptr-&gt;next_scb_ptr = %s\n&quot;,scb-&gt;parent_scb_ptr-&gt;next_scb_ptr-&gt;scb_name);</span>
<span class="c">		printk (&quot;scb-&gt;parent_scb_ptr-&gt;sub_list_ptr = %s\n&quot;,scb-&gt;parent_scb_ptr-&gt;sub_list_ptr-&gt;scb_name);</span>
<span class="cp">#endif</span>
		<span class="cm">/* link to  parent SCB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb_child_type</span> <span class="o">==</span> <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span>
				       <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb_child_type</span> <span class="o">==</span> <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span>
				       <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* update entry in DSP RAM */</span>
		<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_generic_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">scb_data</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">task_entry_name</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                               <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">task_entry</span><span class="p">;</span>

	<span class="n">task_entry</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">task_entry_name</span><span class="p">,</span>
					       <span class="n">SYMBOL_CODE</span><span class="p">);</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">task_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">task_entry_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="k">return</span> <span class="n">_dsp_create_generic_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">scb_data</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">task_entry</span><span class="p">,</span>
					<span class="n">parent_scb</span><span class="p">,</span><span class="n">scb_child_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_timing_master_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_timing_master_scb</span> <span class="n">timing_master_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span>
		<span class="p">},</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>             <span class="cm">/* extraSampleAccum:TMreserved */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>             <span class="cm">/* codecFIFOptr:codecFIFOsyncd */</span>
		<span class="mh">0x0001</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span>   <span class="cm">/* fracSampAccumQm1:TMfrmsLeftInGroup */</span>
		<span class="mh">0x0001</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>   <span class="cm">/* fracSampCorrectionQm1:TMfrmGroupLength */</span>
		<span class="mh">0x00060000</span>       <span class="cm">/* nSampPerFrmQ15 */</span>
	<span class="p">};</span>    
  
	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;TimingMasterSCBInst&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">timing_master_scb</span><span class="p">,</span>
					    <span class="n">TIMINGMASTER_SCB_ADDR</span><span class="p">,</span>
					    <span class="s">&quot;TIMINGMASTER&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SCB_NO_PARENT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_codec_out_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">codec_name</span><span class="p">,</span>
                                <span class="n">u16</span> <span class="n">channel_disp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fifo_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">child_scb_addr</span><span class="p">,</span>
                                <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_codec_output_scb</span> <span class="n">codec_out_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>
		<span class="p">},</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>                      <span class="cm">/* COstrmRsConfig */</span>
		<span class="mi">0</span><span class="p">,</span>                      <span class="cm">/* COstrmBufPtr */</span>
		<span class="n">channel_disp</span><span class="p">,</span><span class="n">fifo_addr</span><span class="p">,</span> <span class="cm">/* leftChanBaseIOaddr:rightChanIOdisp */</span>
		<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0080</span><span class="p">,</span>          <span class="cm">/* (!AC97!) COexpVolChangeRate:COscaleShiftCount */</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">child_scb_addr</span>        <span class="cm">/* COreserved - need child scb to work with rom code */</span>
	<span class="p">};</span>
  
  
	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">codec_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">codec_out_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;S16_CODECOUTPUTTASK&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_codec_in_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">codec_name</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">channel_disp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fifo_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sample_buffer_addr</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_codec_input_scb</span> <span class="n">codec_input_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>
		<span class="p">},</span>
    
<span class="cp">#if 0</span><span class="c">  /* cs4620 */</span>
<span class="c">		SyncIOSCB,NULL_SCB_ADDR</span>
<span class="cp">#else</span>
		<span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#endif</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>

		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_64</span><span class="p">,</span>  <span class="cm">/* strmRsConfig */</span>
		<span class="n">sample_buffer_addr</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>       <span class="cm">/* strmBufPtr; defined as a dword ptr, used as a byte ptr */</span>
		<span class="n">channel_disp</span><span class="p">,</span><span class="n">fifo_addr</span><span class="p">,</span>           <span class="cm">/* (!AC97!) leftChanBaseINaddr=AC97primary </span>
<span class="cm">						     link input slot 3 :rightChanINdisp=&quot;&quot;slot 4 */</span>
		<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>                    <span class="cm">/* (!AC97!) ????:scaleShiftCount; no shift needed </span>
<span class="cm">						     because AC97 is already 20 bits */</span>
		<span class="mh">0x80008000</span>                        <span class="cm">/* ??clw cwcgame.scb has 0 */</span>
	<span class="p">};</span>
  
	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">codec_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">codec_input_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;S16_CODECINPUTTASK&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_pcm_reader_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span>
                                 <span class="n">u16</span> <span class="n">sample_buffer_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                 <span class="kt">int</span> <span class="n">virtual_channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">playback_hw_addr</span><span class="p">,</span>
                                 <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                 <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_generic_scb</span> <span class="n">pcm_reader_scb</span> <span class="o">=</span> <span class="p">{</span>
    
		<span class="cm">/*</span>
<span class="cm">		  Play DMA Task xfers data from host buffer to SP buffer</span>
<span class="cm">		  init/runtime variables:</span>
<span class="cm">		  PlayAC: Play Audio Data Conversion - SCB loc: 2nd dword, mask: 0x0000F000L</span>
<span class="cm">		  DATA_FMT_16BIT_ST_LTLEND(0x00000000L)   from 16-bit stereo, little-endian</span>
<span class="cm">		  DATA_FMT_8_BIT_ST_SIGNED(0x00001000L)   from 8-bit stereo, signed</span>
<span class="cm">		  DATA_FMT_16BIT_MN_LTLEND(0x00002000L)   from 16-bit mono, little-endian</span>
<span class="cm">		  DATA_FMT_8_BIT_MN_SIGNED(0x00003000L)   from 8-bit mono, signed</span>
<span class="cm">		  DATA_FMT_16BIT_ST_BIGEND(0x00004000L)   from 16-bit stereo, big-endian</span>
<span class="cm">		  DATA_FMT_16BIT_MN_BIGEND(0x00006000L)   from 16-bit mono, big-endian</span>
<span class="cm">		  DATA_FMT_8_BIT_ST_UNSIGNED(0x00009000L) from 8-bit stereo, unsigned</span>
<span class="cm">		  DATA_FMT_8_BIT_MN_UNSIGNED(0x0000b000L) from 8-bit mono, unsigned</span>
<span class="cm">		  ? Other combinations possible from:</span>
<span class="cm">		  DMA_RQ_C2_AUDIO_CONVERT_MASK    0x0000F000L</span>
<span class="cm">		  DMA_RQ_C2_AC_NONE               0x00000000L</span>
<span class="cm">		  DMA_RQ_C2_AC_8_TO_16_BIT        0x00001000L</span>
<span class="cm">		  DMA_RQ_C2_AC_MONO_TO_STEREO     0x00002000L</span>
<span class="cm">		  DMA_RQ_C2_AC_ENDIAN_CONVERT     0x00004000L</span>
<span class="cm">		  DMA_RQ_C2_AC_SIGNED_CONVERT     0x00008000L</span>
<span class="cm">        </span>
<span class="cm">		  HostBuffAddr: Host Buffer Physical Byte Address - SCB loc:3rd dword, Mask: 0xFFFFFFFFL</span>
<span class="cm">		  aligned to dword boundary</span>
<span class="cm">		*/</span>
		<span class="cm">/* Basic (non scatter/gather) DMA requestor (4 ints) */</span>
		<span class="p">{</span> <span class="n">DMA_RQ_C1_SOURCE_ON_HOST</span> <span class="o">+</span>        <span class="cm">/* source buffer is on the host */</span>
		  <span class="n">DMA_RQ_C1_SOURCE_MOD1024</span> <span class="o">+</span>        <span class="cm">/* source buffer is 1024 dwords (4096 bytes) */</span>
		  <span class="n">DMA_RQ_C1_DEST_MOD32</span> <span class="o">+</span>            <span class="cm">/* dest buffer(PCMreaderBuf) is 32 dwords*/</span>
		  <span class="n">DMA_RQ_C1_WRITEBACK_SRC_FLAG</span> <span class="o">+</span>    <span class="cm">/* ?? */</span>
		  <span class="n">DMA_RQ_C1_WRITEBACK_DEST_FLAG</span> <span class="o">+</span>   <span class="cm">/* ?? */</span>
		  <span class="mi">15</span><span class="p">,</span>                             <span class="cm">/* DwordCount-1: picked 16 for DwordCount because Jim */</span>
		  <span class="cm">/*        Barnette said that is what we should use since */</span>
		  <span class="cm">/*        we are not running in optimized mode? */</span>
		  <span class="n">DMA_RQ_C2_AC_NONE</span> <span class="o">+</span>
		  <span class="n">DMA_RQ_C2_SIGNAL_SOURCE_PINGPONG</span> <span class="o">+</span> <span class="cm">/* set play interrupt (bit0) in HISR when source */</span>
		  <span class="cm">/*   buffer (on host) crosses half-way point */</span>
		  <span class="n">virtual_channel</span><span class="p">,</span>                   <span class="cm">/* Play DMA channel arbitrarily set to 0 */</span>
		  <span class="n">playback_hw_addr</span><span class="p">,</span>                  <span class="cm">/* HostBuffAddr (source) */</span>
		  <span class="n">DMA_RQ_SD_SP_SAMPLE_ADDR</span> <span class="o">+</span>         <span class="cm">/* destination buffer is in SP Sample Memory */</span>
		  <span class="n">sample_buffer_addr</span>                 <span class="cm">/* SP Buffer Address (destination) */</span>
		<span class="p">},</span>
		<span class="cm">/* Scatter/gather DMA requestor extension   (5 ints) */</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span> 
		<span class="p">},</span>
		<span class="cm">/* Sublist pointer &amp; next stream control block (SCB) link. */</span>
		<span class="n">NULL_SCB_ADDR</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
		<span class="cm">/* Pointer to this tasks parameter block &amp; stream function pointer */</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
		<span class="cm">/* rsConfig register for stream buffer (rsDMA reg. is loaded from basicReq.daw */</span>
		<span class="cm">/*   for incoming streams, or basicReq.saw, for outgoing streams) */</span>
		<span class="n">RSCONFIG_DMA_ENABLE</span> <span class="o">+</span>                 <span class="cm">/* enable DMA */</span>
		<span class="p">(</span><span class="mi">19</span> <span class="o">&lt;&lt;</span> <span class="n">RSCONFIG_MAX_DMA_SIZE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* MAX_DMA_SIZE picked to be 19 since SPUD  */</span>
		<span class="cm">/*  uses it for some reason */</span>
		<span class="p">((</span><span class="n">dest</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RSCONFIG_STREAM_NUM_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* stream number = SCBaddr/16 */</span>
		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span>
		<span class="n">RSCONFIG_MODULO_32</span><span class="p">,</span>             <span class="cm">/* dest buffer(PCMreaderBuf) is 32 dwords (256 bytes) */</span>
		<span class="cm">/* Stream sample pointer &amp; MAC-unit mode for this stream */</span>
		<span class="p">(</span><span class="n">sample_buffer_addr</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">),</span>
		<span class="cm">/* Fractional increment per output sample in the input sample buffer */</span>
		<span class="mi">0</span><span class="p">,</span> 
		<span class="p">{</span>
			<span class="cm">/* Standard stereo volume control</span>
<span class="cm">			   default muted */</span>
			<span class="mh">0xffff</span><span class="p">,</span><span class="mh">0xffff</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span><span class="mh">0xffff</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">null_algorithm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">null_algorithm</span> <span class="o">=</span>  <span class="n">cs46xx_dsp_lookup_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;NULLALGORITHM&quot;</span><span class="p">,</span>
								 <span class="n">SYMBOL_CODE</span><span class="p">);</span>
    
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">null_algorithm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol NULLALGORITHM not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>    
	<span class="p">}</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcm_reader_scb</span><span class="p">,</span>
				      <span class="n">dest</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">null_algorithm</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
				      <span class="n">scb_child_type</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define GOF_PER_SEC 200</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_src_task_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
                               <span class="n">u16</span> <span class="n">src_buffer_addr</span><span class="p">,</span>
                               <span class="n">u16</span> <span class="n">src_delay_buffer_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                               <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">,</span>
	                       <span class="kt">int</span> <span class="n">pass_through</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phiIncr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">correctionPerGOF</span><span class="p">,</span> <span class="n">correctionPerSec</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span> <span class="s">&quot;dsp_spos: setting %s rate to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,</span><span class="n">rate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Compute the values used to drive the actual sample rate conversion.</span>
<span class="cm">	 *  The following formulas are being computed, using inline assembly</span>
<span class="cm">	 *  since we need to use 64 bit arithmetic to compute the values:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  phiIncr = floor((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *  correctionPerGOF = floor((Fs,in * 2^26 - Fs,out * phiIncr) /</span>
<span class="cm">	 *                                   GOF_PER_SEC)</span>
<span class="cm">	 *  ulCorrectionPerSec = Fs,in * 2^26 - Fs,out * phiIncr -M</span>
<span class="cm">	 *                       GOF_PER_SEC * correctionPerGOF</span>
<span class="cm">	 *</span>
<span class="cm">	 *  i.e.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  phiIncr:other = dividend:remainder((Fs,in * 2^26) / Fs,out)</span>
<span class="cm">	 *  correctionPerGOF:correctionPerSec =</span>
<span class="cm">	 *      dividend:remainder(ulOther / GOF_PER_SEC)</span>
<span class="cm">	 */</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">phiIncr</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">phiIncr</span> <span class="o">+=</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">tmp2</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">correctionPerGOF</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">/</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">-=</span> <span class="n">correctionPerGOF</span> <span class="o">*</span> <span class="n">GOF_PER_SEC</span><span class="p">;</span>
	<span class="n">correctionPerSec</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_src_task_scb</span> <span class="n">src_task_scb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0x0028</span><span class="p">,</span><span class="mh">0x00c8</span><span class="p">,</span>
			<span class="mh">0x5555</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>
			<span class="n">src_buffer_addr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">correctionPerGOF</span><span class="p">,</span><span class="n">correctionPerSec</span><span class="p">,</span>
			<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_32</span><span class="p">,</span>  
			<span class="mh">0x0000</span><span class="p">,</span><span class="n">src_delay_buffer_addr</span><span class="p">,</span>                  
			<span class="mh">0x0</span><span class="p">,</span>                                            
			<span class="mh">0x080</span><span class="p">,(</span><span class="n">src_delay_buffer_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)),</span>
			<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* next_scb, sub_list_ptr */</span>
			<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* entry, this_spb */</span>
			<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_8</span><span class="p">,</span>
			<span class="n">src_buffer_addr</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>
			<span class="n">phiIncr</span><span class="p">,</span>
			<span class="p">{</span> 
				<span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span><span class="p">,</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span><span class="p">,</span>
				<span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span><span class="p">,</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span>
			<span class="p">}</span>
		<span class="p">};</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">s16_up</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">s16_up</span> <span class="o">=</span>  <span class="n">cs46xx_dsp_lookup_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;S16_UPSRC&quot;</span><span class="p">,</span>
								 <span class="n">SYMBOL_CODE</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">s16_up</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol S16_UPSRC not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>    
		<span class="p">}</span>
		
		<span class="cm">/* clear buffers */</span>
		<span class="n">_dsp_clear_sample_buffer</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">src_buffer_addr</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">_dsp_clear_sample_buffer</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">src_delay_buffer_addr</span><span class="p">,</span><span class="mi">32</span><span class="p">);</span>
				
		<span class="k">if</span> <span class="p">(</span><span class="n">pass_through</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wont work with any other rate than</span>
<span class="cm">			   the native DSP rate */</span>
			<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">48000</span><span class="p">);</span>

			<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src_task_scb</span><span class="p">,</span>
							    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;DMAREADER&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
							    <span class="n">scb_child_type</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scb</span> <span class="o">=</span> <span class="n">_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src_task_scb</span><span class="p">,</span>
						      <span class="n">dest</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">s16_up</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
						      <span class="n">scb_child_type</span><span class="p">);</span>
		<span class="p">}</span>


	<span class="p">}</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* not used */</span>
<span class="c">struct dsp_scb_descriptor * </span>
<span class="c">cs46xx_dsp_create_filter_scb(struct snd_cs46xx * chip, char * scb_name,</span>
<span class="c">			     u16 buffer_addr, u32 dest,</span>
<span class="c">			     struct dsp_scb_descriptor * parent_scb,</span>
<span class="c">			     int scb_child_type) {</span>
<span class="c">	struct dsp_scb_descriptor * scb;</span>
<span class="c">	</span>
<span class="c">	struct dsp_filter_scb filter_scb = {</span>
<span class="c">		.a0_right            = 0x41a9,</span>
<span class="c">		.a0_left             = 0x41a9,</span>
<span class="c">		.a1_right            = 0xb8e4,</span>
<span class="c">		.a1_left             = 0xb8e4,</span>
<span class="c">		.a2_right            = 0x3e55,</span>
<span class="c">		.a2_left             = 0x3e55,</span>
<span class="c">		</span>
<span class="c">		.filter_unused3      = 0x0000,</span>
<span class="c">		.filter_unused2      = 0x0000,</span>

<span class="c">		.output_buf_ptr      = buffer_addr,</span>
<span class="c">		.init                = 0x000,</span>

<span class="c">		.prev_sample_output1 = 0x00000000,</span>
<span class="c">		.prev_sample_output2 = 0x00000000,</span>

<span class="c">		.prev_sample_input1  = 0x00000000,</span>
<span class="c">		.prev_sample_input2  = 0x00000000,</span>

<span class="c">		.next_scb_ptr        = 0x0000,</span>
<span class="c">		.sub_list_ptr        = 0x0000,</span>

<span class="c">		.entry_point         = 0x0000,</span>
<span class="c">		.spb_ptr             = 0x0000,</span>

<span class="c">		.b0_right            = 0x0e38,</span>
<span class="c">		.b0_left             = 0x0e38,</span>
<span class="c">		.b1_right            = 0x1c71,</span>
<span class="c">		.b1_left             = 0x1c71,</span>
<span class="c">		.b2_right            = 0x0e38,</span>
<span class="c">		.b2_left             = 0x0e38,</span>
<span class="c">	};</span>


<span class="c">	scb = cs46xx_dsp_create_generic_scb(chip,scb_name,(u32 *)&amp;filter_scb,</span>
<span class="c">					    dest,&quot;FILTERTASK&quot;,parent_scb,</span>
<span class="c">					    scb_child_type);</span>

<span class="c"> 	return scb;</span>
<span class="c">}</span>
<span class="cp">#endif /* not used */</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_mix_only_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span>
                               <span class="n">u16</span> <span class="n">mix_buffer_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                               <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_mix_only_scb</span> <span class="n">master_mix_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 0 */</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="cm">/* 1 */</span>   <span class="mi">0</span><span class="p">,</span>
			  <span class="cm">/* 2 */</span>  <span class="n">mix_buffer_addr</span><span class="p">,</span>
			  <span class="cm">/* 3 */</span>  <span class="mi">0</span>
			  <span class="cm">/*   */</span> <span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* 4 */</span>  <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 5 */</span>  <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 6 */</span>  <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 7 */</span>  <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 8 */</span>  <span class="mh">0x00000080</span>
		<span class="p">},</span>
		<span class="cm">/* 9 */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* A */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* B */</span> <span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_32</span><span class="p">,</span>
		<span class="cm">/* C */</span> <span class="p">(</span><span class="n">mix_buffer_addr</span>  <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span> 
		<span class="cm">/* D */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">{</span>
			<span class="cm">/* E */</span> <span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span>
			<span class="cm">/* F */</span> <span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span>
		<span class="p">}</span>
	<span class="p">};</span>


	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">master_mix_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;S16_MIX&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_mix_to_ostream_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span>
                                     <span class="n">u16</span> <span class="n">mix_buffer_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">writeback_spb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                     <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                     <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_mix2_ostream_scb</span> <span class="n">mix2_ostream_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Basic (non scatter/gather) DMA requestor (4 ints) */</span>
		<span class="p">{</span> 
			<span class="n">DMA_RQ_C1_SOURCE_MOD64</span> <span class="o">+</span>
			<span class="n">DMA_RQ_C1_DEST_ON_HOST</span> <span class="o">+</span>
			<span class="n">DMA_RQ_C1_DEST_MOD1024</span> <span class="o">+</span>
			<span class="n">DMA_RQ_C1_WRITEBACK_SRC_FLAG</span> <span class="o">+</span> 
			<span class="n">DMA_RQ_C1_WRITEBACK_DEST_FLAG</span> <span class="o">+</span>
			<span class="mi">15</span><span class="p">,</span>                            
      
			<span class="n">DMA_RQ_C2_AC_NONE</span> <span class="o">+</span>
			<span class="n">DMA_RQ_C2_SIGNAL_DEST_PINGPONG</span> <span class="o">+</span> 
      
			<span class="n">CS46XX_DSP_CAPTURE_CHANNEL</span><span class="p">,</span>                                 
			<span class="n">DMA_RQ_SD_SP_SAMPLE_ADDR</span> <span class="o">+</span> 
			<span class="n">mix_buffer_addr</span><span class="p">,</span> 
			<span class="mh">0x0</span>                   
		<span class="p">},</span>
    
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">writeback_spb</span><span class="p">,</span>
    
		<span class="n">RSCONFIG_DMA_ENABLE</span> <span class="o">+</span> 
		<span class="p">(</span><span class="mi">19</span> <span class="o">&lt;&lt;</span> <span class="n">RSCONFIG_MAX_DMA_SIZE_SHIFT</span><span class="p">)</span> <span class="o">+</span> 
    
		<span class="p">((</span><span class="n">dest</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RSCONFIG_STREAM_NUM_SHIFT</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">RSCONFIG_DMA_TO_HOST</span> <span class="o">+</span> 
		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span>
		<span class="n">RSCONFIG_MODULO_64</span><span class="p">,</span>    
		<span class="p">(</span><span class="n">mix_buffer_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>            
		<span class="mh">0x0001</span><span class="p">,</span><span class="mh">0x0080</span><span class="p">,</span>
		<span class="mh">0xFFFF</span><span class="p">,</span><span class="mi">0</span>
	<span class="p">};</span>


	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mix2_ostream_scb</span><span class="p">,</span>
				
	    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;S16_MIX_TO_OSTREAM&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_vari_decimate_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span>
                                    <span class="n">u16</span> <span class="n">vari_buffer_addr0</span><span class="p">,</span>
                                    <span class="n">u16</span> <span class="n">vari_buffer_addr1</span><span class="p">,</span>
                                    <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                    <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                    <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_vari_decimate_scb</span> <span class="n">vari_decimate_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x0028</span><span class="p">,</span><span class="mh">0x00c8</span><span class="p">,</span>
		<span class="mh">0x5555</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>
		<span class="n">vari_buffer_addr0</span><span class="p">,</span><span class="n">vari_buffer_addr1</span><span class="p">,</span>
    
		<span class="mh">0x0028</span><span class="p">,</span><span class="mh">0x00c8</span><span class="p">,</span>
		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_256</span><span class="p">,</span> 
    
		<span class="mh">0xFF800000</span><span class="p">,</span>   
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x0080</span><span class="p">,</span><span class="n">vari_buffer_addr1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> 
    
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> 
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>

		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_8</span><span class="p">,</span>
		<span class="n">vari_buffer_addr0</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>   
		<span class="mh">0x04000000</span><span class="p">,</span>                   
		<span class="p">{</span>
			<span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span> 
			<span class="mh">0xFFFF</span><span class="p">,</span><span class="mh">0xFFFF</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vari_decimate_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;VARIDECIMATE&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_pcm_serial_input_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                       <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">input_scb</span><span class="p">,</span>
                                       <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                       <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>


	<span class="k">struct</span> <span class="n">dsp_pcm_serial_input_scb</span> <span class="n">pcm_serial_input_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>
		<span class="p">},</span>

		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>

		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_16</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
      <span class="cm">/* 0xD */</span> <span class="mi">0</span><span class="p">,</span><span class="n">input_scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
		<span class="p">{</span>
      <span class="cm">/* 0xE */</span>   <span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span>
      <span class="cm">/* 0xF */</span>	  <span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcm_serial_input_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;PCMSERIALINPUTTASK&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_asynch_fg_tx_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                   <span class="n">u16</span> <span class="n">hfg_scb_address</span><span class="p">,</span>
                                   <span class="n">u16</span> <span class="n">asynch_buffer_address</span><span class="p">,</span>
                                   <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                   <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_asynch_fg_tx_scb</span> <span class="n">asynch_fg_tx_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xfc00</span><span class="p">,</span><span class="mh">0x03ff</span><span class="p">,</span>      <span class="cm">/*  Prototype sample buffer size of 256 dwords */</span>
		<span class="mh">0x0058</span><span class="p">,</span><span class="mh">0x0028</span><span class="p">,</span>      <span class="cm">/* Min Delta 7 dwords == 28 bytes */</span>
		<span class="cm">/* : Max delta 25 dwords == 100 bytes */</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">hfg_scb_address</span><span class="p">,</span>  <span class="cm">/* Point to HFG task SCB */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>		    <span class="cm">/* Initialize current Delta and Consumer ptr adjustment count */</span>
		<span class="mi">0</span><span class="p">,</span>                  <span class="cm">/* Initialize accumulated Phi to 0 */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mh">0x2aab</span><span class="p">,</span>           <span class="cm">/* Const 1/3 */</span>
    
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>         <span class="cm">/* Define the unused elements */</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>
		<span class="p">},</span>
    
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">dest</span> <span class="o">+</span> <span class="n">AFGTxAccumPhi</span><span class="p">,</span>
    
		<span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_256</span><span class="p">,</span> <span class="cm">/* Stereo, 256 dword */</span>
		<span class="p">(</span><span class="n">asynch_buffer_address</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>  <span class="cm">/* This should be automagically synchronized</span>
<span class="cm">                                                     to the producer pointer */</span>
    
		<span class="cm">/* There is no correct initial value, it will depend upon the detected</span>
<span class="cm">		   rate etc  */</span>
		<span class="mh">0x18000000</span><span class="p">,</span>                     <span class="cm">/* Phi increment for approx 32k operation */</span>
		<span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span>                  <span class="cm">/* Volume controls are unused at this time */</span>
		<span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span>
	<span class="p">};</span>
  
	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">asynch_fg_tx_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;ASYNCHFGTXCODE&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_asynch_fg_rx_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                   <span class="n">u16</span> <span class="n">hfg_scb_address</span><span class="p">,</span>
                                   <span class="n">u16</span> <span class="n">asynch_buffer_address</span><span class="p">,</span>
                                   <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                   <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_asynch_fg_rx_scb</span> <span class="n">asynch_fg_rx_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xfe00</span><span class="p">,</span><span class="mh">0x01ff</span><span class="p">,</span>      <span class="cm">/*  Prototype sample buffer size of 128 dwords */</span>
		<span class="mh">0x0064</span><span class="p">,</span><span class="mh">0x001c</span><span class="p">,</span>      <span class="cm">/* Min Delta 7 dwords == 28 bytes */</span>
		                    <span class="cm">/* : Max delta 25 dwords == 100 bytes */</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">hfg_scb_address</span><span class="p">,</span>  <span class="cm">/* Point to HFG task SCB */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>				<span class="cm">/* Initialize current Delta and Consumer ptr adjustment count */</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span>                <span class="cm">/* Define the unused elements */</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>
		<span class="p">},</span>
      
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span>
    
		<span class="n">RSCONFIG_MODULO_128</span> <span class="o">|</span>
        <span class="n">RSCONFIG_SAMPLE_16STEREO</span><span class="p">,</span>                         <span class="cm">/* Stereo, 128 dword */</span>
		<span class="p">(</span> <span class="p">(</span><span class="n">asynch_buffer_address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>  <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">),</span>   <span class="cm">/* This should be automagically </span>
<span class="cm">							                                  synchrinized to the producer pointer */</span>
    
		<span class="cm">/* There is no correct initial value, it will depend upon the detected</span>
<span class="cm">		   rate etc  */</span>
		<span class="mh">0x18000000</span><span class="p">,</span>         

		<span class="cm">/* Set IEC958 input volume */</span>
		<span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_right</span><span class="p">,</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_left</span><span class="p">,</span>
		<span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_right</span><span class="p">,</span><span class="mh">0xffff</span> <span class="o">-</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_left</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">asynch_fg_rx_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;ASYNCHFGRXCODE&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"> /* not used */</span>
<span class="c">struct dsp_scb_descriptor * </span>
<span class="c">cs46xx_dsp_create_output_snoop_scb(struct snd_cs46xx * chip, char * scb_name, u32 dest,</span>
<span class="c">                                   u16 snoop_buffer_address,</span>
<span class="c">                                   struct dsp_scb_descriptor * snoop_scb,</span>
<span class="c">                                   struct dsp_scb_descriptor * parent_scb,</span>
<span class="c">                                   int scb_child_type)</span>
<span class="c">{</span>

<span class="c">	struct dsp_scb_descriptor * scb;</span>
<span class="c">  </span>
<span class="c">	struct dsp_output_snoop_scb output_snoop_scb = {</span>
<span class="c">		{ 0,	/*  not used.  Zero */</span>
<span class="c">		  0,</span>
<span class="c">		  0,</span>
<span class="c">		  0,</span>
<span class="c">		},</span>
<span class="c">		{</span>
<span class="c">			0, /* not used.  Zero */</span>
<span class="c">			0,</span>
<span class="c">			0,</span>
<span class="c">			0,</span>
<span class="c">			0</span>
<span class="c">		},</span>
<span class="c">    </span>
<span class="c">		0,0,</span>
<span class="c">		0,0,</span>
<span class="c">    </span>
<span class="c">		RSCONFIG_SAMPLE_16STEREO + RSCONFIG_MODULO_64,</span>
<span class="c">		snoop_buffer_address &lt;&lt; 0x10,  </span>
<span class="c">		0,0,</span>
<span class="c">		0,</span>
<span class="c">		0,snoop_scb-&gt;address</span>
<span class="c">	};</span>
<span class="c">  </span>
<span class="c">	scb = cs46xx_dsp_create_generic_scb(chip,scb_name,(u32 *)&amp;output_snoop_scb,</span>
<span class="c">					    dest,&quot;OUTPUTSNOOP&quot;,parent_scb,</span>
<span class="c">					    scb_child_type);</span>
<span class="c">	return scb;</span>
<span class="c">}</span>
<span class="cp">#endif /* not used */</span>


<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> 
<span class="nf">cs46xx_dsp_create_spio_write_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
                                 <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
                                 <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_spio_write_scb</span> <span class="n">spio_write_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>         <span class="cm">/*   SPIOWAddress2:SPIOWAddress1; */</span>
		<span class="mi">0</span><span class="p">,</span>           <span class="cm">/*   SPIOWData1; */</span>
		<span class="mi">0</span><span class="p">,</span>           <span class="cm">/*   SPIOWData2; */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>         <span class="cm">/*   SPIOWAddress4:SPIOWAddress3; */</span>
		<span class="mi">0</span><span class="p">,</span>           <span class="cm">/*   SPIOWData3; */</span>
		<span class="mi">0</span><span class="p">,</span>           <span class="cm">/*   SPIOWData4; */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>         <span class="cm">/*   SPIOWDataPtr:Unused1; */</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">},</span>     <span class="cm">/*   Unused2[2]; */</span>
    
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>	     <span class="cm">/*   SPIOWChildPtr:SPIOWSiblingPtr; */</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>         <span class="cm">/*   SPIOWThisPtr:SPIOWEntryPoint; */</span>
    
		<span class="p">{</span> 
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span>          <span class="cm">/*   Unused3[5];  */</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">spio_write_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;SPIOWRITE&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_create_magic_snoop_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">snoop_buffer_address</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">snoop_scb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">scb_child_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span>
  
	<span class="k">struct</span> <span class="n">dsp_magic_snoop_task</span> <span class="n">magic_snoop_scb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 0 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i0 */</span>
		<span class="cm">/* 1 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i1 */</span>
		<span class="cm">/* 2 */</span> <span class="n">snoop_buffer_address</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="cm">/* 3 */</span> <span class="mi">0</span><span class="p">,</span><span class="n">snoop_scb</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
		<span class="cm">/* 4 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i3 */</span>
		<span class="cm">/* 5 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i4 */</span>
		<span class="cm">/* 6 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i5 */</span>
		<span class="cm">/* 7 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i6 */</span>
		<span class="cm">/* 8 */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* i7 */</span>
		<span class="cm">/* 9 */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* next_scb, sub_list_ptr */</span>
		<span class="cm">/* A */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* entry_point, this_ptr */</span>
		<span class="cm">/* B */</span> <span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_64</span><span class="p">,</span>
		<span class="cm">/* C */</span> <span class="n">snoop_buffer_address</span>  <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="cm">/* D */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* E */</span> <span class="p">{</span> <span class="mh">0x8000</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">,</span>
	        <span class="cm">/* F */</span>   <span class="mh">0xffff</span><span class="p">,</span><span class="mh">0xffff</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_generic_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">magic_snoop_scb</span><span class="p">,</span>
					    <span class="n">dest</span><span class="p">,</span><span class="s">&quot;MAGICSNOOPTASK&quot;</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">,</span>
					    <span class="n">scb_child_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span>
<span class="nf">find_next_free_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">pcm_reader_buffer_addr</span><span class="p">[</span><span class="n">DSP_MAX_PCM_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0600</span><span class="p">,</span> <span class="cm">/* 1 */</span>
	<span class="mh">0x1500</span><span class="p">,</span> <span class="cm">/* 2 */</span>
	<span class="mh">0x1580</span><span class="p">,</span> <span class="cm">/* 3 */</span>
	<span class="mh">0x1600</span><span class="p">,</span> <span class="cm">/* 4 */</span>
	<span class="mh">0x1680</span><span class="p">,</span> <span class="cm">/* 5 */</span>
	<span class="mh">0x1700</span><span class="p">,</span> <span class="cm">/* 6 */</span>
	<span class="mh">0x1780</span><span class="p">,</span> <span class="cm">/* 7 */</span>
	<span class="mh">0x1800</span><span class="p">,</span> <span class="cm">/* 8 */</span>
	<span class="mh">0x1880</span><span class="p">,</span> <span class="cm">/* 9 */</span>
	<span class="mh">0x1900</span><span class="p">,</span> <span class="cm">/* 10 */</span>
	<span class="mh">0x1980</span><span class="p">,</span> <span class="cm">/* 11 */</span>
	<span class="mh">0x1A00</span><span class="p">,</span> <span class="cm">/* 12 */</span>
	<span class="mh">0x1A80</span><span class="p">,</span> <span class="cm">/* 13 */</span>
	<span class="mh">0x1B00</span><span class="p">,</span> <span class="cm">/* 14 */</span>
	<span class="mh">0x1B80</span><span class="p">,</span> <span class="cm">/* 15 */</span>
	<span class="mh">0x1C00</span><span class="p">,</span> <span class="cm">/* 16 */</span>
	<span class="mh">0x1C80</span><span class="p">,</span> <span class="cm">/* 17 */</span>
	<span class="mh">0x1D00</span><span class="p">,</span> <span class="cm">/* 18 */</span>
	<span class="mh">0x1D80</span><span class="p">,</span> <span class="cm">/* 19 */</span>
	<span class="mh">0x1E00</span><span class="p">,</span> <span class="cm">/* 20 */</span>
	<span class="mh">0x1E80</span><span class="p">,</span> <span class="cm">/* 21 */</span>
	<span class="mh">0x1F00</span><span class="p">,</span> <span class="cm">/* 22 */</span>
	<span class="mh">0x1F80</span><span class="p">,</span> <span class="cm">/* 23 */</span>
	<span class="mh">0x2000</span><span class="p">,</span> <span class="cm">/* 24 */</span>
	<span class="mh">0x2080</span><span class="p">,</span> <span class="cm">/* 25 */</span>
	<span class="mh">0x2100</span><span class="p">,</span> <span class="cm">/* 26 */</span>
	<span class="mh">0x2180</span><span class="p">,</span> <span class="cm">/* 27 */</span>
	<span class="mh">0x2200</span><span class="p">,</span> <span class="cm">/* 28 */</span>
	<span class="mh">0x2280</span><span class="p">,</span> <span class="cm">/* 29 */</span>
	<span class="mh">0x2300</span><span class="p">,</span> <span class="cm">/* 30 */</span>
	<span class="mh">0x2380</span><span class="p">,</span> <span class="cm">/* 31 */</span>
	<span class="mh">0x2400</span><span class="p">,</span> <span class="cm">/* 32 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">src_output_buffer_addr</span><span class="p">[</span><span class="n">DSP_MAX_SRC_NR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x2B80</span><span class="p">,</span>
	<span class="mh">0x2BA0</span><span class="p">,</span>
	<span class="mh">0x2BC0</span><span class="p">,</span>
	<span class="mh">0x2BE0</span><span class="p">,</span>
	<span class="mh">0x2D00</span><span class="p">,</span>  
	<span class="mh">0x2D20</span><span class="p">,</span>  
	<span class="mh">0x2D40</span><span class="p">,</span>  
	<span class="mh">0x2D60</span><span class="p">,</span>
	<span class="mh">0x2D80</span><span class="p">,</span>
	<span class="mh">0x2DA0</span><span class="p">,</span>
	<span class="mh">0x2DC0</span><span class="p">,</span>
	<span class="mh">0x2DE0</span><span class="p">,</span>
	<span class="mh">0x2E00</span><span class="p">,</span>
	<span class="mh">0x2E20</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">src_delay_buffer_addr</span><span class="p">[</span><span class="n">DSP_MAX_SRC_NR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x2480</span><span class="p">,</span>
	<span class="mh">0x2500</span><span class="p">,</span>
	<span class="mh">0x2580</span><span class="p">,</span>
	<span class="mh">0x2600</span><span class="p">,</span>
	<span class="mh">0x2680</span><span class="p">,</span>
	<span class="mh">0x2700</span><span class="p">,</span>
	<span class="mh">0x2780</span><span class="p">,</span>
	<span class="mh">0x2800</span><span class="p">,</span>
	<span class="mh">0x2880</span><span class="p">,</span>
	<span class="mh">0x2900</span><span class="p">,</span>
	<span class="mh">0x2980</span><span class="p">,</span>
	<span class="mh">0x2A00</span><span class="p">,</span>
	<span class="mh">0x2A80</span><span class="p">,</span>
	<span class="mh">0x2B00</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsp_pcm_channel_descriptor</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_create_pcm_channel</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">private_data</span><span class="p">,</span> 
			       <span class="n">u32</span> <span class="n">hw_dma_addr</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">pcm_channel_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span> <span class="n">pcm_scb</span><span class="p">,</span> <span class="o">*</span> <span class="n">mixer_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src_parent_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* struct dsp_scb_descriptor * pcm_parent_scb; */</span>
	<span class="kt">char</span> <span class="n">scb_name</span><span class="p">[</span><span class="n">DSP_MAX_SCB_NAME</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pcm_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">insert_point</span><span class="p">,</span> <span class="n">src_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pass_through</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pcm_channel_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSP_PCM_MAIN_CHANNEL</span>:
		<span class="n">mixer_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_PCM_REAR_CHANNEL</span>:
		<span class="n">mixer_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">rear_mix_scb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_PCM_CENTER_LFE_CHANNEL</span>:
		<span class="n">mixer_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">center_lfe_mix_scb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_PCM_S71_CHANNEL</span>:
		<span class="cm">/* TODO */</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_IEC958_CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mixer_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">;</span>

		<span class="cm">/* if sample rate is set to 48khz we pass</span>
<span class="cm">		   the Sample Rate Converted (which could</span>
<span class="cm">		   alter the raw data stream ...) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sample_rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;IEC958 pass through</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Hack to bypass creating a new SRC */</span>
			<span class="n">pass_through</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* default sample rate is 44100 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sample_rate</span><span class="p">)</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>

	<span class="cm">/* search for a already created SRC SCB with the same sample rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DSP_MAX_PCM_CHANNELS</span> <span class="o">&amp;&amp;</span> 
		     <span class="p">(</span><span class="n">pcm_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">src_scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* virtual channel reserved </span>
<span class="cm">		   for capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CS46XX_DSP_CAPTURE_CHANNEL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_scb</span> <span class="o">&amp;&amp;</span> 
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sample_rate</span> <span class="o">==</span> <span class="n">sample_rate</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mixer_scb</span> <span class="o">==</span> <span class="n">mixer_scb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">src_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_scb</span><span class="p">;</span>
				<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">++</span><span class="p">;</span>
				<span class="n">src_index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_slot</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcm_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcm_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: no free PCM channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nsrc_scb</span> <span class="o">&gt;=</span> <span class="n">DSP_MAX_SRC_NR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: to many SRC instances</span><span class="se">\n</span><span class="s">!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* find a free slot */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DSP_MAX_SRC_NR</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">src_scb_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">src_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">ins</span><span class="o">-&gt;</span><span class="n">src_scb_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">src_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* we need to create a new SRC SCB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mixer_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src_parent_scb</span> <span class="o">=</span> <span class="n">mixer_scb</span><span class="p">;</span>
			<span class="n">insert_point</span> <span class="o">=</span> <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">src_parent_scb</span> <span class="o">=</span> <span class="n">find_next_free_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">mixer_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">);</span>
			<span class="n">insert_point</span> <span class="o">=</span> <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span> <span class="p">(</span><span class="n">scb_name</span><span class="p">,</span><span class="n">DSP_MAX_SCB_NAME</span><span class="p">,</span><span class="s">&quot;SrcTask_SCB%d&quot;</span><span class="p">,</span><span class="n">src_index</span><span class="p">);</span>
		
		<span class="n">snd_printdd</span><span class="p">(</span> <span class="s">&quot;dsp_spos: creating SRC </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb_name</span><span class="p">);</span>
		<span class="n">src_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_src_task_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,</span>
							 <span class="n">sample_rate</span><span class="p">,</span>
							 <span class="n">src_output_buffer_addr</span><span class="p">[</span><span class="n">src_index</span><span class="p">],</span>
							 <span class="n">src_delay_buffer_addr</span><span class="p">[</span><span class="n">src_index</span><span class="p">],</span>
							 <span class="cm">/* 0x400 - 0x600 source SCBs */</span>
							 <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(</span><span class="n">src_index</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">,</span>
							 <span class="n">src_parent_scb</span><span class="p">,</span>
							 <span class="n">insert_point</span><span class="p">,</span>
							 <span class="n">pass_through</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_scb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to create SRCtaskSCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* cs46xx_dsp_set_src_sample_rate(chip,src_scb,sample_rate); */</span>

		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nsrc_scb</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> 
  
  
	<span class="n">snprintf</span> <span class="p">(</span><span class="n">scb_name</span><span class="p">,</span><span class="n">DSP_MAX_SCB_NAME</span><span class="p">,</span><span class="s">&quot;PCMReader_SCB%d&quot;</span><span class="p">,</span><span class="n">pcm_index</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span> <span class="s">&quot;dsp_spos: creating PCM </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,</span>
                 <span class="n">pcm_channel_id</span><span class="p">);</span>

	<span class="n">pcm_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_pcm_reader_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,</span>
						   <span class="n">pcm_reader_buffer_addr</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">],</span>
						   <span class="cm">/* 0x200 - 400 PCMreader SCBs */</span>
						   <span class="p">(</span><span class="n">pcm_index</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span>
						   <span class="n">pcm_index</span><span class="p">,</span>    <span class="cm">/* virtual channel 0-31 */</span>
						   <span class="n">hw_dma_addr</span><span class="p">,</span>  <span class="cm">/* pcm hw addr */</span>
                           <span class="nb">NULL</span><span class="p">,</span>         <span class="cm">/* parent SCB ptr */</span>
                           <span class="mi">0</span>             <span class="cm">/* insert point */</span> 
                           <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to create PCMreaderSCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">pcm_reader_scb</span> <span class="o">=</span> <span class="n">pcm_scb</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">src_scb</span> <span class="o">=</span> <span class="n">src_scb</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">unlinked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">private_data</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">src_slot</span> <span class="o">=</span> <span class="n">src_index</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">pcm_slot</span> <span class="o">=</span> <span class="n">pcm_index</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">[</span><span class="n">pcm_index</span><span class="p">].</span><span class="n">mixer_scb</span> <span class="o">=</span> <span class="n">mixer_scb</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">npcm_channels</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_channels</span> <span class="o">+</span> <span class="n">pcm_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_pcm_channel_set_period</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dsp_pcm_channel_descriptor</span> <span class="o">*</span> <span class="n">pcm_channel</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">period_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RQ_C1_SOURCE_SIZE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		      
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_SOURCE_MOD16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span> 
	<span class="k">default</span><span class="o">:</span>
		<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;period size (%d) not supported by HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">period_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_cs46xx_poke</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_pcm_ostream_set_period</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">period_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">snd_cs46xx_peek</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">WRITEBACK_SCB_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RQ_C1_DEST_SIZE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		      
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DMA_RQ_C1_DEST_MOD16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span> 
	<span class="k">default</span><span class="o">:</span>
		<span class="n">snd_printdd</span> <span class="p">(</span><span class="s">&quot;period size (%d) not supported by HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">period_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_cs46xx_poke</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">WRITEBACK_SCB_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cs46xx_dsp_destroy_pcm_channel</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dsp_pcm_channel_descriptor</span> <span class="o">*</span> <span class="n">pcm_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span>
		       <span class="n">ins</span><span class="o">-&gt;</span><span class="n">npcm_channels</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
		       <span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">--</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">npcm_channels</span> <span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cs46xx_dsp_remove_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_remove_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_scb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			       <span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_slot</span> <span class="o">&gt;=</span> <span class="n">DSP_MAX_SRC_NR</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">src_scb_slots</span><span class="p">[</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_slot</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nsrc_scb</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_pcm_unlink</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">dsp_pcm_channel_descriptor</span> <span class="o">*</span> <span class="n">pcm_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span>
		       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">npcm_channels</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">_dsp_unlink_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_pcm_link</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">dsp_pcm_channel_descriptor</span> <span class="o">*</span> <span class="n">pcm_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src_scb</span> <span class="o">=</span> <span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">src_scb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parent_scb</span> <span class="o">=</span> <span class="n">src_scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="p">;</span>
		<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">src_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="p">;</span>

	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">);</span>
	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">parent_scb</span><span class="p">;</span>

	<span class="cm">/* update SCB entry in DSP RAM */</span>
	<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">pcm_reader_scb</span><span class="p">);</span>

	<span class="cm">/* update parent SCB entry */</span>
	<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">);</span>

	<span class="n">pcm_channel</span><span class="o">-&gt;</span><span class="n">unlinked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span>
<span class="nf">cs46xx_add_record_source</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">source</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scb_name</span><span class="p">)</span>
<span class="p">{</span>
  	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">pcm_input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">insert_point</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">record_mixer_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">record_mixer_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">find_next_free_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">record_mixer_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">);</span>
		<span class="n">insert_point</span> <span class="o">=</span> <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">record_mixer_scb</span><span class="p">;</span>
		<span class="n">insert_point</span> <span class="o">=</span> <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcm_input</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_pcm_serial_input_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_name</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span>
							   <span class="n">source</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
							   <span class="n">insert_point</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pcm_input</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_src_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* mute SCB */</span>
	<span class="n">cs46xx_dsp_scb_set_volume</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_dsp_unlink_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">src</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_src_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">parent_scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent_scb</span> <span class="o">=</span> <span class="n">find_next_free_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">);</span>
		<span class="n">parent_scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">parent_scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">;</span>
		<span class="n">parent_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">parent_scb</span><span class="p">;</span>

	<span class="cm">/* update entry in DSP RAM */</span>
	<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">parent_scb</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_enable_spdif_out</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_HW_ENABLED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_spdif_hw</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* dont touch anything if SPDIF is open */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* when cs46xx_iec958_post_close(...) is called it</span>
<span class="cm">		   will call this function if necessary depending on</span>
<span class="cm">		   this bit */</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">;</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span>
		       <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* reset output snooper sample buffer pointer */</span>
	<span class="n">snd_cs46xx_poke</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">OUTPUT_SNOOP_BUFFER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span> <span class="p">);</span>
	
	<span class="cm">/* The asynch. transfer task */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_asynch_fg_tx_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;AsynchFGTxSCB&quot;</span><span class="p">,</span><span class="n">ASYNCTX_SCB_ADDR</span><span class="p">,</span>
								<span class="n">SPDIFO_SCB_INST</span><span class="p">,</span>
								<span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="p">,</span>
								<span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">,</span>
								<span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_pcm_serial_input_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;PCMSerialInput_II&quot;</span><span class="p">,</span>
									  <span class="n">PCMSERIALINII_SCB_ADDR</span><span class="p">,</span>
									  <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span><span class="p">,</span>
									  <span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">,</span>
									  <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
  
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>  <span class="nf">cs46xx_dsp_disable_spdif_out</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="cm">/* dont touch anything if SPDIF is open */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check integrety */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">!=</span>
		       <span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span><span class="p">);</span>
	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">);</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* clear buffer to prevent any undesired noise */</span>
	<span class="n">_dsp_clear_sample_buffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">;</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_iec958_pre_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove AsynchFGTxSCB and and PCMSerialInput_II */</span>
		<span class="n">cs46xx_dsp_disable_spdif_out</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="cm">/* save state */</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* if not enabled already */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_HW_ENABLED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_spdif_hw</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Create the asynch. transfer task  for playback */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_asynch_fg_tx_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;AsynchFGTxSCB&quot;</span><span class="p">,</span><span class="n">ASYNCTX_SCB_ADDR</span><span class="p">,</span>
								<span class="n">SPDIFO_SCB_INST</span><span class="p">,</span>
								<span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="p">,</span>
								<span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="p">,</span>
								<span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>


	<span class="cm">/* set spdif channel status value for streaming */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span><span class="p">);</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span>  <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_iec958_post_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">;</span>

	<span class="cm">/* restore settings */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span><span class="p">);</span>
	
	<span class="cm">/* deallocate stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span><span class="p">);</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_pcm_input_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_tx_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* clear buffer to prevent any undesired noise */</span>
	<span class="n">_dsp_clear_sample_buffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>

	<span class="cm">/* restore state */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_OUTPUT_ENABLED</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_spdif_out</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
