<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › cs46xx › dsp_spos.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dsp_spos.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 2002-07 Benny Sjostrand benny@hostmobility.com</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/cs46xx.h&gt;</span>

<span class="cp">#include &quot;cs46xx_lib.h&quot;</span>
<span class="cp">#include &quot;dsp_spos.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cs46xx_dsp_async_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">fg_entry</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">wide_opcode</span> <span class="n">wide_opcodes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> 
	<span class="n">WIDE_FOR_BEGIN_LOOP</span><span class="p">,</span>
	<span class="n">WIDE_FOR_BEGIN_LOOP2</span><span class="p">,</span>
	<span class="n">WIDE_COND_GOTO_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_COND_GOTO_CALL</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_COND_GOTO_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_COND_CALL_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_NCOND_GOTO_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_NCOND_CALL_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_COND_GOTO1_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_COND_CALL1_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_NCOND_GOTOI_ADDR</span><span class="p">,</span>
	<span class="n">WIDE_TBEQ_NCOND_CALL1_ADDR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">shadow_and_reallocate_code</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">overlay_begin_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nreallocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hival</span><span class="p">,</span><span class="n">loval</span><span class="p">,</span><span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mop_operands</span><span class="p">,</span><span class="n">mop_type</span><span class="p">,</span><span class="n">wide_op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">%</span><span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loval</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="n">hival</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mop_operands</span> <span class="o">=</span> <span class="p">(</span><span class="n">hival</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03fff</span><span class="p">;</span>
			<span class="n">mop_type</span> <span class="o">=</span> <span class="n">mop_operands</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
      
			<span class="cm">/* check for wide type instruction */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mop_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mop_operands</span> <span class="o">&amp;</span> <span class="n">WIDE_LADD_INSTR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mop_operands</span> <span class="o">&amp;</span> <span class="n">WIDE_INSTR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wide_op</span> <span class="o">=</span> <span class="n">loval</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wide_opcodes</span><span class="p">);</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">wide_opcodes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">wide_op</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* need to reallocate instruction */</span>
						<span class="n">address</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hival</span> <span class="o">&amp;</span> <span class="mh">0x00FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
						<span class="n">address</span> <span class="o">|=</span>  <span class="n">loval</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
            
						<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;handle_wideop[1]: %05x:%05x addr %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">hival</span><span class="p">,</span><span class="n">loval</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
            
						<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
							<span class="n">address</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">overlay_begin_address</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;handle_wideop[1]: ROM symbol not reallocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span>
            
						<span class="n">hival</span> <span class="o">&amp;=</span> <span class="mh">0xFF000</span><span class="p">;</span>
						<span class="n">loval</span> <span class="o">&amp;=</span> <span class="mh">0x07FFF</span><span class="p">;</span>
            
						<span class="n">hival</span> <span class="o">|=</span> <span class="p">(</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0x00FFF</span><span class="p">);</span>
						<span class="n">loval</span> <span class="o">|=</span> <span class="p">(</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF8000</span><span class="p">);</span>
            
						<span class="n">address</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hival</span> <span class="o">&amp;</span> <span class="mh">0x00FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
						<span class="n">address</span> <span class="o">|=</span>  <span class="n">loval</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
            
						<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;handle_wideop:[2] %05x:%05x addr %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">hival</span><span class="p">,</span><span class="n">loval</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>            
						<span class="n">nreallocated</span> <span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="cm">/* wide_opcodes[j] == wide_op */</span>
				<span class="p">}</span> <span class="cm">/* for */</span>
			<span class="p">}</span> <span class="cm">/* mod_type == 0 ... */</span>
		<span class="p">}</span> <span class="cm">/* ins-&gt;code.offset &gt; 0 */</span>

		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">loval</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hival</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: %d instructions reallocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nreallocated</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nreallocated</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span> <span class="nf">get_segment_desc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_module_desc</span> <span class="o">*</span> <span class="n">module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">nsegments</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_type</span> <span class="o">==</span> <span class="n">seg_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">segments</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_free_symbol_index</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_symbols</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_module_desc</span> <span class="o">*</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">symbol_name</span><span class="p">,</span> <span class="s">&quot;OVERLAYBEGINADDRESS&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">symbol_type</span> <span class="o">==</span> <span class="n">SYMBOL_CONSTANT</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">module</span><span class="o">-&gt;</span><span class="n">overlay_begin_address</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">==</span> <span class="p">(</span><span class="n">DSP_MAX_SYMBOLS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol table is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					     <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_name</span><span class="p">,</span>
					     <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">].</span><span class="n">address</span> <span class="o">+=</span> <span class="p">((</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">overlay_begin_address</span><span class="p">);</span>
			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">].</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">].</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">&gt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span><span class="p">)</span> 
				<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span>

			<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="cm">/* if (0) printk (&quot;dsp_spos: symbol &lt;%s&gt; duplicated, probably nothing wrong with that (Cirrus?)\n&quot;,</span>
<span class="cm">                             module-&gt;symbol_table.symbols[i].symbol_name); */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span>
<span class="nf">add_symbol</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">symbol_name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">symbol</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">==</span> <span class="p">(</span><span class="n">DSP_MAX_SYMBOLS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol table is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				     <span class="n">symbol_name</span><span class="p">,</span>
				     <span class="n">type</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol &lt;%s&gt; duplicated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">symbol_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">find_free_symbol_index</span> <span class="p">(</span><span class="n">ins</span><span class="p">);</span>

	<span class="n">strcpy</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">symbol_name</span><span class="p">,</span> <span class="n">symbol_name</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">symbol_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">symbol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span><span class="p">)</span> 
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">)</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* no frag. in list */</span>

	<span class="k">return</span> <span class="n">symbol</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span><span class="nf">cs46xx_dsp_spos_create</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_spos_instance</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* better to use vmalloc for this big table */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_symbol_entry</span><span class="p">)</span> <span class="o">*</span>
					    <span class="n">DSP_MAX_SYMBOLS</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">DSP_CODE_BYTE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_module_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">DSP_MAX_MODULES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span> <span class="o">||</span> <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_spos_destroy</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">highest_frag_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* default SPDIF input sample rate</span>
<span class="cm">	   to 48000 khz */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_sample_rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>

	<span class="cm">/* maximize volume */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_right</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_left</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="cm">/* set left and right validity bits and</span>
<span class="cm">	   default channel status */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span> <span class="o">=</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span> <span class="o">=</span>
	 <span class="cm">/* byte 0 */</span>  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span>  <span class="p">(</span><span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
	 <span class="cm">/* byte 1 */</span>  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span> <span class="p">((</span><span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	 <span class="cm">/* byte 3 */</span>   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_wrap_all_bits</span><span class="p">(</span>  <span class="p">(</span><span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
	 <span class="cm">/* left and right validity bits */</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ins</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="nf">cs46xx_dsp_spos_destroy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">cs46xx_dsp_proc_free_scb_desc</span> <span class="p">(</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ins</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsp_load_parameter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: module got no parameter segment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">doffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">);</span>
	<span class="n">dsize</span>   <span class="o">=</span> <span class="n">parameter</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: &quot;</span>
		    <span class="s">&quot;downloading parameter data to chip (%08x-%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">doffset</span><span class="p">,</span><span class="n">doffset</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_download</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">parameter</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: &quot;</span>
			   <span class="s">&quot;failed to download parameter data to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsp_load_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sample</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: module got no sample segment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">doffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span>  <span class="o">+</span> <span class="n">DSP_SAMPLE_BYTE_OFFSET</span><span class="p">);</span>
	<span class="n">dsize</span>   <span class="o">=</span>  <span class="n">sample</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: downloading sample data to chip (%08x-%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">doffset</span><span class="p">,</span><span class="n">doffset</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_download</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">doffset</span><span class="p">,</span><span class="n">dsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to sample data to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_load_module</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_module_desc</span> <span class="o">*</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span> <span class="n">code</span> <span class="o">=</span> <span class="n">get_segment_desc</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">SEGTYPE_SP_PROGRAM</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span> <span class="o">==</span> <span class="n">DSP_MAX_MODULES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: to many modules loaded into DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: loading module %s into DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">);</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: clearing parameter area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">,</span> <span class="n">DSP_PARAMETER_BYTE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
  
	<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_load_parameter</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">get_segment_desc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span>
							<span class="n">SEGTYPE_SP_PARAMETER</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: clearing sample area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_SAMPLE_BYTE_OFFSET</span><span class="p">,</span> <span class="n">DSP_SAMPLE_BYTE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_load_sample</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">get_segment_desc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span>
						     <span class="n">SEGTYPE_SP_SAMPLE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: clearing code area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_CODE_BYTE_OFFSET</span><span class="p">,</span> <span class="n">DSP_CODE_BYTE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: module got no code segment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">DSP_CODE_BYTE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: no space available in DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">module</span><span class="o">-&gt;</span><span class="n">load_address</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">module</span><span class="o">-&gt;</span><span class="n">overlay_begin_address</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>

		<span class="cm">/* if module has a code segment it must have</span>
<span class="cm">		   symbol table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">add_symbols</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to load symbol table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
    
		<span class="n">doffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">DSP_CODE_BYTE_OFFSET</span><span class="p">);</span>
		<span class="n">dsize</span>   <span class="o">=</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;dsp_spos: downloading code to chip (%08x-%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">doffset</span><span class="p">,</span><span class="n">doffset</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">);</span>   

		<span class="n">module</span><span class="o">-&gt;</span><span class="n">nfixups</span> <span class="o">=</span> <span class="n">shadow_and_reallocate_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">overlay_begin_address</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs46xx_download</span> <span class="p">(</span><span class="n">chip</span><span class="p">,(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span><span class="p">),</span><span class="n">doffset</span><span class="p">,</span><span class="n">dsize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to download code to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE: module segments and symbol table must be</span>
<span class="cm">	   statically allocated. Case that module data is</span>
<span class="cm">	   not generated by the ospparser */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_lookup_symbol</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">symbol_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">symbol_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_name</span><span class="p">,</span><span class="n">symbol_name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_type</span> <span class="o">==</span> <span class="n">symbol_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk (&quot;dsp_spos: symbol &lt;%s&gt; type %02x not found\n&quot;,</span>
<span class="c">		symbol_name,symbol_type);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_lookup_symbol_addr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">symbol_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">==</span> <span class="n">address</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_type</span> <span class="o">==</span> <span class="n">symbol_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_symbol_table_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SYMBOLS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">module_str</span> <span class="o">=</span> <span class="s">&quot;system&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">module</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">module_str</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">;</span>
		<span class="p">}</span>

    
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &lt;%02X&gt; %s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_type</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_name</span><span class="p">,</span>
			    <span class="n">module_str</span><span class="p">);</span>    
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_modules_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MODULES:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">module_name</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;   %d symbols</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">symbol_table</span><span class="p">.</span><span class="n">nsymbols</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;   %d fixups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nfixups</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nsegments</span><span class="p">;</span> <span class="o">++</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segments</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;   segment %02x offset %08x size %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">segment_type</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_task_tree_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;TASK TREES:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%04x %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">task_name</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span><span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08x &quot;</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_scb_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SCB&#39;s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%04x %s:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scb_name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent_scb_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;parent [%s:%04x] &quot;</span><span class="p">,</span> 
				    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
				    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent_scb_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;parent [none] &quot;</span><span class="p">);</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;sub_list_ptr [%s:%04x]</span><span class="se">\n</span><span class="s">next_scb_ptr [%s:%04x]  task_entry [%s:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sub_list_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">scb_name</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_scb_ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">task_entry</span><span class="o">-&gt;</span><span class="n">symbol_name</span><span class="p">,</span>
			    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">task_entry</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_parameter_dump_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="cm">/*struct dsp_spos_instance * ins = chip-&gt;dsp_spos_instance; */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">symbol</span><span class="p">;</span> 

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">DSP_PARAMETER_BYTE_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol_addr</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">i</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">SYMBOL_PARAMETER</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">-&gt;</span><span class="n">symbol_name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_proc_sample_dump_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;PCMREADER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">PCM_READER_BUF1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCM_READER_BUF1</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">MIX_SAMPLE_BUF1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MIX_SAMPLE_BUF1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MIX_SAMPLE_BUF1</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SRC_TASK_SCB1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x2480</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x2480</span> <span class="o">+</span> <span class="mh">0x40</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>


	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SPDIFO_BUFFER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span><span class="o">+</span><span class="mh">0xD0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span> <span class="o">+</span> <span class="mh">0x110</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>


	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">OUTPUT_SNOOP:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">OUTPUT_SNOOP_BUFFER</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">OUTPUT_SNOOP_BUFFER</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">CODEC_INPUT_BUF1: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CODEC_INPUT_BUF1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">CODEC_INPUT_BUF1</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	snd_iprintf(buffer,&quot;\nWRITE_BACK_BUF1: \n&quot;);</span>
<span class="c">	col = 0;</span>
<span class="c">	for (i = WRITE_BACK_BUF1;i &lt; WRITE_BACK_BUF1 + 0x40; i += sizeof(u32),col ++) {</span>
<span class="c">		if (col == 4) {</span>
<span class="c">			snd_iprintf(buffer,&quot;\n&quot;);</span>
<span class="c">			col = 0;</span>
<span class="c">		}</span>

<span class="c">		if (col == 0) {</span>
<span class="c">			snd_iprintf(buffer, &quot;%04X &quot;,i);</span>
<span class="c">		}</span>

<span class="c">		snd_iprintf(buffer,&quot;%08X &quot;,readl(dst + i));</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SPDIFI_IP_OUTPUT_BUFFER1: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SPDIFI_IP_OUTPUT_BUFFER1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPDIFI_IP_OUTPUT_BUFFER1</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span><span class="n">col</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04X &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;%08X &quot;</span><span class="p">,</span><span class="n">readl</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_proc_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">snd_card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;dsp&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">;</span>
      
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;spos_symbols&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_symbol_table_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sym_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
    
	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;spos_modules&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_modules_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_modules_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;parameter&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_parameter_dump_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_parameter_dump_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;sample&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_sample_dump_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sample_dump_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;task_tree&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_task_tree_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_task_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;scb_info&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cs46xx_dsp_proc_scb_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_scb_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="cm">/* register/update SCB&#39;s entries on proc */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_proc_done</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sym_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sym_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_modules_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_modules_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_parameter_dump_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_parameter_dump_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sample_dump_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_sample_dump_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_scb_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_scb_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_task_info_entry</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_task_info_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">cs46xx_dsp_proc_free_scb_desc</span> <span class="p">(</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">proc_dsp_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_tree</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsp_create_task_tree</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">task_data</span><span class="p">,</span>
				   <span class="n">u32</span>  <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">spdst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> 
		<span class="n">DSP_PARAMETER_BYTE_OFFSET</span> <span class="o">+</span> <span class="n">dest</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_tree</span><span class="p">)</span> <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;addr %p, val %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">spdst</span><span class="p">,</span><span class="n">task_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">task_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">spdst</span><span class="p">);</span>
		<span class="n">spdst</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_scb</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsp_create_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">scb_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">spdst</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">+</span> 
		<span class="n">DSP_PARAMETER_BYTE_OFFSET</span> <span class="o">+</span> <span class="n">dest</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_scb</span><span class="p">)</span> <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;addr %p, val %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">spdst</span><span class="p">,</span><span class="n">scb_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">scb_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">spdst</span><span class="p">);</span>
		<span class="n">spdst</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_free_scb_index</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="nf">_map_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span> <span class="o">==</span> <span class="n">DSP_MAX_SCB_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: got no place for other SCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">find_free_scb_index</span> <span class="p">(</span><span class="n">ins</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">scb_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ref_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">scb_symbol</span> <span class="o">=</span> <span class="n">add_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">SYMBOL_PARAMETER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span><span class="p">)</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">scb_highest_frag_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">)</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_task_descriptor</span> <span class="o">*</span>
<span class="nf">_map_task_tree</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_task_descriptor</span> <span class="o">*</span> <span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span> <span class="o">==</span> <span class="n">DSP_MAX_TASK_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: got no place for other TASK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">].</span><span class="n">task_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">].</span><span class="n">task_name</span><span class="p">,</span> <span class="s">&quot;(NULL)&quot;</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* quick find in list */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span> <span class="o">+</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">add_symbol</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">SYMBOL_PARAMETER</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCB_BYTES	(0x10 * 4)</span>

<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_create_scb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">scb_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">desc</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* copy the data for resume */</span>
	<span class="n">scb_data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">scb_data</span><span class="p">,</span> <span class="n">SCB_BYTES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">_map_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">scb_data</span><span class="p">;</span>
		<span class="n">_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb_data</span><span class="p">,</span><span class="n">dest</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to map SCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scb_data</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_task_descriptor</span> <span class="o">*</span>
<span class="nf">cs46xx_dsp_create_task_tree</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">task_data</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_task_descriptor</span> <span class="o">*</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">_map_task_tree</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">;</span>
		<span class="n">_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">task_data</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to map TASK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_scb_and_task_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">fg_task_tree_header_code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">task_tree_header_code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">task_tree_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">null_algorithm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">magic_snoop_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">timing_master_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">codec_out_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">codec_in_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">src_task_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">master_mix_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">rear_mix_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">record_mix_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">write_back_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">vari_decimate_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">rear_codec_out_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">clfe_codec_out_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">magic_snoop_scb</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">fifo_addr</span><span class="p">,</span> <span class="n">fifo_span</span><span class="p">,</span> <span class="n">valid_slots</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_spos_control_block</span> <span class="n">sposcb</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 0 */</span> <span class="n">HFG_TREE_SCB</span><span class="p">,</span><span class="n">HFG_STACK</span><span class="p">,</span>
		<span class="cm">/* 1 */</span> <span class="n">SPOSCB_ADDR</span><span class="p">,</span><span class="n">BG_TREE_SCB_ADDR</span><span class="p">,</span>
		<span class="cm">/* 2 */</span> <span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 3 */</span> <span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
		<span class="cm">/* 4 */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 5 */</span> <span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 6 */</span> <span class="n">FG_TASK_HEADER_ADDR</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 7 */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 8 */</span> <span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
		<span class="cm">/* 9 */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* A */</span> <span class="mi">0</span><span class="p">,</span><span class="n">HFG_FIRST_EXECUTE_MODE</span><span class="p">,</span>
		<span class="cm">/* B */</span> <span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="n">DSP_SPOS_UU</span><span class="p">,</span>
		<span class="cm">/* C */</span> <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
		<span class="cm">/* D */</span> <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
		<span class="cm">/* E */</span> <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
		<span class="cm">/* F */</span> <span class="n">DSP_SPOS_DC_DC</span>
	<span class="p">};</span>

	<span class="n">cs46xx_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;sposCB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sposcb</span><span class="p">,</span> <span class="n">SPOSCB_ADDR</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">null_algorithm</span>  <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;NULLALGORITHM&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">null_algorithm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol NULLALGORITHM not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fg_task_tree_header_code</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;FGTASKTREEHEADERCODE&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">fg_task_tree_header_code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol FGTASKTREEHEADERCODE not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task_tree_header_code</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;TASKTREEHEADERCODE&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">task_tree_header_code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol TASKTREEHEADERCODE not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="n">task_tree_thread</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;TASKTREETHREAD&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_tree_thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol TASKTREETHREAD not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">magic_snoop_task</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;MAGICSNOOPTASK&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">magic_snoop_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol MAGICSNOOPTASK not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="p">{</span>
		<span class="cm">/* create the null SCB */</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_generic_scb</span> <span class="n">null_scb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
			<span class="n">NULL_SCB_ADDR</span><span class="p">,</span> <span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">{</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">};</span>

		<span class="n">null_scb</span><span class="p">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">null_algorithm</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;nullSCB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">null_scb</span><span class="p">,</span> <span class="n">NULL_SCB_ADDR</span><span class="p">);</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">task_entry</span> <span class="o">=</span> <span class="n">null_algorithm</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="cm">/* setup foreground task tree */</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_task_tree_control_block</span> <span class="n">fg_task_tree_hdr</span> <span class="o">=</span>  <span class="p">{</span>
			<span class="p">{</span> <span class="n">FG_TASK_HEADER_ADDR</span> <span class="o">|</span> <span class="p">(</span><span class="n">DSP_SPOS_DC</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">),</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="mh">0x0000</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC</span><span class="p">,</span> <span class="n">DSP_SPOS_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span> <span class="p">},</span>
    
			<span class="p">{</span>
				<span class="n">BG_TREE_SCB_ADDR</span><span class="p">,</span><span class="n">TIMINGMASTER_SCB_ADDR</span><span class="p">,</span> 
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">FG_TASK_HEADER_ADDR</span> <span class="o">+</span> <span class="n">TCBData</span><span class="p">,</span>                  
			<span class="p">},</span>

			<span class="p">{</span>    
				<span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">2</span><span class="p">,</span><span class="n">SPOSCB_ADDR</span> <span class="o">+</span> <span class="n">HFGFlags</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">FG_TASK_HEADER_ADDR</span> <span class="o">+</span> <span class="n">TCBContextBlk</span><span class="p">,</span><span class="n">FG_STACK</span>
			<span class="p">},</span>

			<span class="p">{</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span> 
			<span class="p">},</span>                                               
			<span class="p">{</span> 
				<span class="n">FG_INTERVAL_TIMER_PERIOD</span><span class="p">,</span><span class="n">DSP_SPOS_UU</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
			<span class="p">}</span>
		<span class="p">};</span>

		<span class="n">fg_task_tree_hdr</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">fg_task_tree_header_code</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">fg_task_tree_hdr</span><span class="p">.</span><span class="n">context_blk</span><span class="p">.</span><span class="n">stack0</span> <span class="o">=</span> <span class="n">task_tree_thread</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">cs46xx_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;FGtaskTreeHdr&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fg_task_tree_hdr</span><span class="p">,</span><span class="n">FG_TASK_HEADER_ADDR</span><span class="p">,</span><span class="mh">0x35</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="p">{</span>
		<span class="cm">/* setup foreground task tree */</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_task_tree_control_block</span> <span class="n">bg_task_tree_hdr</span> <span class="o">=</span>  <span class="p">{</span>
			<span class="p">{</span> <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC</span><span class="p">,</span> <span class="n">DSP_SPOS_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC</span><span class="p">,</span> <span class="n">DSP_SPOS_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC_DC</span><span class="p">,</span>
			  <span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span> <span class="p">},</span>
    
			<span class="p">{</span>
				<span class="n">NULL_SCB_ADDR</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>  <span class="cm">/* Set up the background to do nothing */</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">BG_TREE_SCB_ADDR</span> <span class="o">+</span> <span class="n">TCBData</span><span class="p">,</span>
			<span class="p">},</span>

			<span class="p">{</span>    
				<span class="mi">9999</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="n">SPOSCB_ADDR</span> <span class="o">+</span> <span class="n">HFGFlags</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">BG_TREE_SCB_ADDR</span> <span class="o">+</span> <span class="n">TCBContextBlk</span><span class="p">,</span><span class="n">BG_STACK</span>
			<span class="p">},</span>

			<span class="p">{</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DC</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span><span class="p">,</span>
				<span class="n">DSP_SPOS_DCDC</span> 
			<span class="p">},</span>                                               
			<span class="p">{</span> 
				<span class="n">BG_INTERVAL_TIMER_PERIOD</span><span class="p">,</span><span class="n">DSP_SPOS_UU</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
			<span class="p">}</span>
		<span class="p">};</span>

		<span class="n">bg_task_tree_hdr</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">task_tree_header_code</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">bg_task_tree_hdr</span><span class="p">.</span><span class="n">context_blk</span><span class="p">.</span><span class="n">stack0</span> <span class="o">=</span> <span class="n">task_tree_thread</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">cs46xx_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;BGtaskTreeHdr&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bg_task_tree_hdr</span><span class="p">,</span><span class="n">BG_TREE_SCB_ADDR</span><span class="p">,</span><span class="mh">0x35</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* create timing master SCB */</span>
	<span class="n">timing_master_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_timing_master_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* create the CODEC output task */</span>
	<span class="n">codec_out_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_codec_out_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;CodecOutSCB_I&quot;</span><span class="p">,</span><span class="mh">0x0010</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>
							<span class="n">MASTERMIX_SCB_ADDR</span><span class="p">,</span>
							<span class="n">CODECOUT_SCB_ADDR</span><span class="p">,</span><span class="n">timing_master_scb</span><span class="p">,</span>
							<span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec_out_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	<span class="cm">/* create the master mix SCB */</span>
	<span class="n">master_mix_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_mix_only_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;MasterMixSCB&quot;</span><span class="p">,</span>
							<span class="n">MIX_SAMPLE_BUF1</span><span class="p">,</span><span class="n">MASTERMIX_SCB_ADDR</span><span class="p">,</span>
							<span class="n">codec_out_scb</span><span class="p">,</span>
							<span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span> <span class="o">=</span> <span class="n">master_mix_scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_mix_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="cm">/* create codec in */</span>
	<span class="n">codec_in_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_codec_in_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;CodecInSCB&quot;</span><span class="p">,</span><span class="mh">0x0010</span><span class="p">,</span><span class="mh">0x00A0</span><span class="p">,</span>
						      <span class="n">CODEC_INPUT_BUF1</span><span class="p">,</span>
						      <span class="n">CODECIN_SCB_ADDR</span><span class="p">,</span><span class="n">codec_out_scb</span><span class="p">,</span>
						      <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec_in_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">codec_in_scb</span> <span class="o">=</span> <span class="n">codec_in_scb</span><span class="p">;</span>

	<span class="cm">/* create write back scb */</span>
	<span class="n">write_back_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_mix_to_ostream_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;WriteBackSCB&quot;</span><span class="p">,</span>
							      <span class="n">WRITE_BACK_BUF1</span><span class="p">,</span><span class="n">WRITE_BACK_SPB</span><span class="p">,</span>
							      <span class="n">WRITEBACK_SCB_ADDR</span><span class="p">,</span>
							      <span class="n">timing_master_scb</span><span class="p">,</span>
							      <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_back_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_mix2_ostream_spb</span> <span class="n">mix2_ostream_spb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0x00020000</span><span class="p">,</span>
			<span class="mh">0x0000ffff</span>
		<span class="p">};</span>
    
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs46xx_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mix2_ostream_spb</span><span class="p">,</span>
						 <span class="n">WRITE_BACK_SPB</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* input sample converter */</span>
	<span class="n">vari_decimate_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_vari_decimate_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;VariDecimateSCB&quot;</span><span class="p">,</span>
								<span class="n">VARI_DECIMATE_BUF0</span><span class="p">,</span>
								<span class="n">VARI_DECIMATE_BUF1</span><span class="p">,</span>
								<span class="n">VARIDECIMATE_SCB_ADDR</span><span class="p">,</span>
								<span class="n">write_back_scb</span><span class="p">,</span>
								<span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vari_decimate_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="cm">/* create the record mixer SCB */</span>
	<span class="n">record_mix_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_mix_only_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;RecordMixerSCB&quot;</span><span class="p">,</span>
							<span class="n">MIX_SAMPLE_BUF2</span><span class="p">,</span>
							<span class="n">RECORD_MIXER_SCB_ADDR</span><span class="p">,</span>
							<span class="n">vari_decimate_scb</span><span class="p">,</span>
							<span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">record_mixer_scb</span> <span class="o">=</span> <span class="n">record_mix_scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">record_mix_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="n">valid_slots</span> <span class="o">=</span> <span class="n">snd_cs46xx_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* output on slot 5 and 11 </span>
<span class="cm">		   on primary CODEC */</span>
		<span class="n">fifo_addr</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">fifo_span</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>

		<span class="cm">/* enable slot 5 and 11 */</span>
		<span class="n">valid_slots</span> <span class="o">|=</span> <span class="n">ACOSV_SLV5</span> <span class="o">|</span> <span class="n">ACOSV_SLV11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* output on slot 7 and 8 </span>
<span class="cm">		   on secondary CODEC */</span>
		<span class="n">fifo_addr</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">fifo_span</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="cm">/* enable slot 7 and 8 */</span>
		<span class="n">valid_slots</span> <span class="o">|=</span> <span class="n">ACOSV_SLV7</span> <span class="o">|</span> <span class="n">ACOSV_SLV8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* create CODEC tasklet for rear speakers output*/</span>
	<span class="n">rear_codec_out_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_codec_out_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;CodecOutSCB_Rear&quot;</span><span class="p">,</span><span class="n">fifo_span</span><span class="p">,</span><span class="n">fifo_addr</span><span class="p">,</span>
							     <span class="n">REAR_MIXER_SCB_ADDR</span><span class="p">,</span>
							     <span class="n">REAR_CODECOUT_SCB_ADDR</span><span class="p">,</span><span class="n">codec_in_scb</span><span class="p">,</span>
							     <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rear_codec_out_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	
	
	<span class="cm">/* create the rear PCM channel  mixer SCB */</span>
	<span class="n">rear_mix_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_mix_only_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;RearMixerSCB&quot;</span><span class="p">,</span>
						      <span class="n">MIX_SAMPLE_BUF3</span><span class="p">,</span>
						      <span class="n">REAR_MIXER_SCB_ADDR</span><span class="p">,</span>
						      <span class="n">rear_codec_out_scb</span><span class="p">,</span>
						      <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">rear_mix_scb</span> <span class="o">=</span> <span class="n">rear_mix_scb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rear_mix_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nr_ac97_codecs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create CODEC tasklet for rear Center/LFE output </span>
<span class="cm">		   slot 6 and 9 on seconadry CODEC */</span>
		<span class="n">clfe_codec_out_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_codec_out_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;CodecOutSCB_CLFE&quot;</span><span class="p">,</span><span class="mh">0x0030</span><span class="p">,</span><span class="mh">0x0030</span><span class="p">,</span>
								     <span class="n">CLFE_MIXER_SCB_ADDR</span><span class="p">,</span>
								     <span class="n">CLFE_CODEC_SCB_ADDR</span><span class="p">,</span>
								     <span class="n">rear_codec_out_scb</span><span class="p">,</span>
								     <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clfe_codec_out_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
		
		
		<span class="cm">/* create the rear PCM channel  mixer SCB */</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">center_lfe_mix_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_mix_only_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;CLFEMixerSCB&quot;</span><span class="p">,</span>
									 <span class="n">MIX_SAMPLE_BUF4</span><span class="p">,</span>
									 <span class="n">CLFE_MIXER_SCB_ADDR</span><span class="p">,</span>
									 <span class="n">clfe_codec_out_scb</span><span class="p">,</span>
									 <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">center_lfe_mix_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

		<span class="cm">/* enable slot 6 and 9 */</span>
		<span class="n">valid_slots</span> <span class="o">|=</span> <span class="n">ACOSV_SLV6</span> <span class="o">|</span> <span class="n">ACOSV_SLV9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clfe_codec_out_scb</span> <span class="o">=</span> <span class="n">rear_codec_out_scb</span><span class="p">;</span>
		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">center_lfe_mix_scb</span> <span class="o">=</span> <span class="n">rear_mix_scb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable slots depending on CODEC configuration */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">,</span> <span class="n">valid_slots</span><span class="p">);</span>

	<span class="cm">/* the magic snooper */</span>
	<span class="n">magic_snoop_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_magic_snoop_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;MagicSnoopSCB_I&quot;</span><span class="p">,</span><span class="n">OUTPUTSNOOP_SCB_ADDR</span><span class="p">,</span>
							     <span class="n">OUTPUT_SNOOP_BUFFER</span><span class="p">,</span>
							     <span class="n">codec_out_scb</span><span class="p">,</span>
							     <span class="n">clfe_codec_out_scb</span><span class="p">,</span>
							     <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">);</span>

    
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">magic_snoop_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span> <span class="o">=</span> <span class="n">magic_snoop_scb</span><span class="p">;</span>

	<span class="cm">/* SP IO access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs46xx_dsp_create_spio_write_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;SPIOWriteSCB&quot;</span><span class="p">,</span><span class="n">SPIOWRITE_SCB_ADDR</span><span class="p">,</span>
					      <span class="n">magic_snoop_scb</span><span class="p">,</span>
					      <span class="n">SCB_ON_PARENT_NEXT_SCB</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>

	<span class="cm">/* SPDIF input sampel rate converter */</span>
	<span class="n">src_task_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_src_task_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;SrcTaskSCB_SPDIFI&quot;</span><span class="p">,</span>
						      <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_sample_rate</span><span class="p">,</span>
						      <span class="n">SRC_OUTPUT_BUF1</span><span class="p">,</span>
						      <span class="n">SRC_DELAY_BUF1</span><span class="p">,</span><span class="n">SRCTASK_SCB_ADDR</span><span class="p">,</span>
						      <span class="n">master_mix_scb</span><span class="p">,</span>
						      <span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_task_scb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">_fail_end</span><span class="p">;</span>
	<span class="n">cs46xx_src_unlink</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">src_task_scb</span><span class="p">);</span>

	<span class="cm">/* NOTE: when we now how to detect the SPDIF input</span>
<span class="cm">	   sample rate we will use this SRC to adjust it */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span> <span class="o">=</span> <span class="n">src_task_scb</span><span class="p">;</span>

	<span class="n">cs46xx_dsp_async_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">timing_master_scb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">_fail_end:</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: failed to setup SCB&#39;s in DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs46xx_dsp_async_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">fg_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">s16_async_codec_input_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">spdifo_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_symbol_entry</span> <span class="o">*</span> <span class="n">spdifi_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">spdifi_scb_desc</span><span class="p">,</span> <span class="o">*</span> <span class="n">spdifo_scb_desc</span><span class="p">,</span> <span class="o">*</span> <span class="n">async_codec_scb_desc</span><span class="p">;</span>

	<span class="n">s16_async_codec_input_task</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;S16_ASYNCCODECINPUTTASK&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s16_async_codec_input_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol S16_ASYNCCODECINPUTTASK not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spdifo_task</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;SPDIFOTASK&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdifo_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol SPDIFOTASK not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spdifi_task</span> <span class="o">=</span> <span class="n">cs46xx_dsp_lookup_symbol</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;SPDIFITASK&quot;</span><span class="p">,</span> <span class="n">SYMBOL_CODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdifi_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: symbol SPDIFITASK not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="cm">/* 0xBC0 */</span>
		<span class="k">struct</span> <span class="n">dsp_spdifoscb</span> <span class="n">spdifo_scb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* 0 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span>
			<span class="p">{</span>
				<span class="cm">/* 1 */</span> <span class="mh">0xb0</span><span class="p">,</span> 
				<span class="cm">/* 2 */</span> <span class="mi">0</span><span class="p">,</span> 
				<span class="cm">/* 3 */</span> <span class="mi">0</span><span class="p">,</span> 
				<span class="cm">/* 4 */</span> <span class="mi">0</span><span class="p">,</span> 
			<span class="p">},</span>
			<span class="cm">/* NOTE: the SPDIF output task read samples in mono</span>
<span class="cm">			   format, the AsynchFGTxSCB task writes to buffer</span>
<span class="cm">			   in stereo format</span>
<span class="cm">			*/</span>
			<span class="cm">/* 5 */</span> <span class="n">RSCONFIG_SAMPLE_16MONO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_256</span><span class="p">,</span>
			<span class="cm">/* 6 */</span> <span class="p">(</span> <span class="n">SPDIFO_IP_OUTPUT_BUFFER1</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span> <span class="p">)</span>  <span class="o">|</span>  <span class="mh">0xFFFC</span><span class="p">,</span>
			<span class="cm">/* 7 */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> 
			<span class="cm">/* 8 */</span> <span class="mi">0</span><span class="p">,</span> 
			<span class="cm">/* 9 */</span> <span class="n">FG_TASK_HEADER_ADDR</span><span class="p">,</span> <span class="n">NULL_SCB_ADDR</span><span class="p">,</span> 
			<span class="cm">/* A */</span> <span class="n">spdifo_task</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			<span class="n">SPDIFO_SCB_INST</span> <span class="o">+</span> <span class="n">SPDIFOFIFOPointer</span><span class="p">,</span>
			<span class="p">{</span>
				<span class="cm">/* B */</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="cm">/*DSP_SPOS_UUUU,*/</span>
				<span class="cm">/* C */</span> <span class="mh">0x20ff</span><span class="p">,</span> <span class="cm">/*DSP_SPOS_UUUU,*/</span>
			<span class="p">},</span>
			<span class="cm">/* D */</span> <span class="mh">0x804c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>							  <span class="cm">/* SPDIFOFIFOPointer:SPDIFOStatRegAddr; */</span>
			<span class="cm">/* E */</span> <span class="mh">0x0108</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">,</span>					  <span class="cm">/* SPDIFOStMoFormat:SPDIFOFIFOBaseAddr; */</span>
			<span class="cm">/* F */</span> <span class="n">DSP_SPOS_UUUU</span>	  			          <span class="cm">/* SPDIFOFree; */</span>
		<span class="p">};</span>

		<span class="cm">/* 0xBB0 */</span>
		<span class="k">struct</span> <span class="n">dsp_spdifiscb</span> <span class="n">spdifi_scb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* 0 */</span> <span class="n">DSP_SPOS_UULO</span><span class="p">,</span><span class="n">DSP_SPOS_UUHI</span><span class="p">,</span>
			<span class="cm">/* 1 */</span> <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 2 */</span> <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 3 */</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span>        <span class="cm">/* SPDIFICountLimit SPDIFICount */</span> 
			<span class="cm">/* 4 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span> <span class="cm">/* SPDIFIStatusData */</span>
			<span class="cm">/* 5 */</span> <span class="mi">0</span><span class="p">,</span><span class="n">DSP_SPOS_UUHI</span><span class="p">,</span> <span class="cm">/* StatusData, Free4 */</span>
			<span class="cm">/* 6 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span>  <span class="cm">/* Free3 */</span>
			<span class="cm">/* 7 */</span> <span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="n">DSP_SPOS_DC</span><span class="p">,</span>  <span class="cm">/* Free2 BitCount*/</span>
			<span class="cm">/* 8 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span>	<span class="cm">/* TempStatus */</span>
			<span class="cm">/* 9 */</span> <span class="n">SPDIFO_SCB_INST</span><span class="p">,</span> <span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
			<span class="cm">/* A */</span> <span class="n">spdifi_task</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			<span class="n">SPDIFI_SCB_INST</span> <span class="o">+</span> <span class="n">SPDIFIFIFOPointer</span><span class="p">,</span>
			<span class="cm">/* NOTE: The SPDIF input task write the sample in mono</span>
<span class="cm">			   format from the HW FIFO, the AsynchFGRxSCB task  reads </span>
<span class="cm">			   them in stereo </span>
<span class="cm">			*/</span>
			<span class="cm">/* B */</span> <span class="n">RSCONFIG_SAMPLE_16MONO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_128</span><span class="p">,</span>
			<span class="cm">/* C */</span> <span class="p">(</span><span class="n">SPDIFI_IP_OUTPUT_BUFFER1</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFFC</span><span class="p">,</span>
			<span class="cm">/* D */</span> <span class="mh">0x8048</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* E */</span> <span class="mh">0x01f0</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">,</span>
			<span class="cm">/* F */</span> <span class="n">DSP_SPOS_UUUU</span> <span class="cm">/* SPDIN_STATUS monitor */</span>
		<span class="p">};</span>

		<span class="cm">/* 0xBA0 */</span>
		<span class="k">struct</span> <span class="n">dsp_async_codec_input_scb</span> <span class="n">async_codec_input_scb</span> <span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* 0 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span>
			<span class="cm">/* 1 */</span> <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 2 */</span> <span class="mi">0</span><span class="p">,</span>
			<span class="cm">/* 3 */</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span>
			<span class="cm">/* 4 */</span> <span class="mh">0x0118</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">,</span>
			<span class="cm">/* 5 */</span> <span class="n">RSCONFIG_SAMPLE_16MONO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_64</span><span class="p">,</span>
			<span class="cm">/* 6 */</span> <span class="p">(</span><span class="n">ASYNC_IP_OUTPUT_BUFFER1</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFFC</span><span class="p">,</span>
			<span class="cm">/* 7 */</span> <span class="n">DSP_SPOS_UU</span><span class="p">,</span><span class="mh">0x3</span><span class="p">,</span>
			<span class="cm">/* 8 */</span> <span class="n">DSP_SPOS_UUUU</span><span class="p">,</span>
			<span class="cm">/* 9 */</span> <span class="n">SPDIFI_SCB_INST</span><span class="p">,</span><span class="n">NULL_SCB_ADDR</span><span class="p">,</span>
			<span class="cm">/* A */</span> <span class="n">s16_async_codec_input_task</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			<span class="n">HFG_TREE_SCB</span> <span class="o">+</span> <span class="n">AsyncCIOFIFOPointer</span><span class="p">,</span>
              
			<span class="cm">/* B */</span> <span class="n">RSCONFIG_SAMPLE_16STEREO</span> <span class="o">+</span> <span class="n">RSCONFIG_MODULO_64</span><span class="p">,</span>
			<span class="cm">/* C */</span> <span class="p">(</span><span class="n">ASYNC_IP_OUTPUT_BUFFER1</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">),</span>  <span class="cm">/*(ASYNC_IP_OUTPUT_BUFFER1 &lt;&lt; 0x10) | 0xFFFC,*/</span>
      
<span class="cp">#ifdef UseASER1Input</span>
			<span class="cm">/* short AsyncCIFIFOPointer:AsyncCIStatRegAddr;	       </span>
<span class="cm">			   Init. 0000:8042: for ASER1</span>
<span class="cm">			   0000:8044: for ASER2 */</span>
			<span class="cm">/* D */</span> <span class="mh">0x8042</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
      
			<span class="cm">/* short AsyncCIStMoFormat:AsyncCIFIFOBaseAddr;</span>
<span class="cm">			   Init 1 stero:8050 ASER1</span>
<span class="cm">			   Init 0  mono:8070 ASER2</span>
<span class="cm">			   Init 1 Stereo : 0100 ASER1 (Set by script) */</span>
			<span class="cm">/* E */</span> <span class="mh">0x0100</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">,</span>
      
<span class="cp">#endif</span>
      
<span class="cp">#ifdef UseASER2Input</span>
			<span class="cm">/* short AsyncCIFIFOPointer:AsyncCIStatRegAddr;</span>
<span class="cm">			   Init. 0000:8042: for ASER1</span>
<span class="cm">			   0000:8044: for ASER2 */</span>
			<span class="cm">/* D */</span> <span class="mh">0x8044</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
      
			<span class="cm">/* short AsyncCIStMoFormat:AsyncCIFIFOBaseAddr;</span>
<span class="cm">			   Init 1 stero:8050 ASER1</span>
<span class="cm">			   Init 0  mono:8070 ASER2</span>
<span class="cm">			   Init 1 Stereo : 0100 ASER1 (Set by script) */</span>
			<span class="cm">/* E */</span> <span class="mh">0x0110</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">,</span>
      
<span class="cp">#endif</span>
      
			<span class="cm">/* short AsyncCIOutputBufModulo:AsyncCIFree;</span>
<span class="cm">			   AsyncCIOutputBufModulo: The modulo size for   </span>
<span class="cm">			   the output buffer of this task */</span>
			<span class="cm">/* F */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* DSP_SPOS_UUUU */</span>
		<span class="p">};</span>

		<span class="n">spdifo_scb_desc</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;SPDIFOSCB&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">spdifo_scb</span><span class="p">,</span><span class="n">SPDIFO_SCB_INST</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spdifo_scb_desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">spdifi_scb_desc</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;SPDIFISCB&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">spdifi_scb</span><span class="p">,</span><span class="n">SPDIFI_SCB_INST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spdifi_scb_desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">async_codec_scb_desc</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;AsynCodecInputSCB&quot;</span><span class="p">,(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">async_codec_input_scb</span><span class="p">,</span> <span class="n">HFG_TREE_SCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">async_codec_scb_desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">async_codec_scb_desc</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">async_codec_scb_desc</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">spdifi_scb_desc</span><span class="p">;</span>
		<span class="n">async_codec_scb_desc</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="n">async_codec_scb_desc</span><span class="o">-&gt;</span><span class="n">task_entry</span> <span class="o">=</span> <span class="n">s16_async_codec_input_task</span><span class="p">;</span>

		<span class="n">spdifi_scb_desc</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">async_codec_scb_desc</span><span class="p">;</span>
		<span class="n">spdifi_scb_desc</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">spdifo_scb_desc</span><span class="p">;</span>
		<span class="n">spdifi_scb_desc</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="n">spdifi_scb_desc</span><span class="o">-&gt;</span><span class="n">task_entry</span> <span class="o">=</span> <span class="n">spdifi_task</span><span class="p">;</span>

		<span class="n">spdifo_scb_desc</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">spdifi_scb_desc</span><span class="p">;</span>
		<span class="n">spdifo_scb_desc</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span> <span class="o">=</span> <span class="n">fg_entry</span><span class="p">;</span>
		<span class="n">spdifo_scb_desc</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">;</span>
		<span class="n">spdifo_scb_desc</span><span class="o">-&gt;</span><span class="n">task_entry</span> <span class="o">=</span> <span class="n">spdifo_task</span><span class="p">;</span>

		<span class="cm">/* this one is faked, as the parnet of SPDIFO task</span>
<span class="cm">		   is the FG task tree */</span>
		<span class="n">fg_entry</span><span class="o">-&gt;</span><span class="n">parent_scb_ptr</span> <span class="o">=</span> <span class="n">spdifo_scb_desc</span><span class="p">;</span>

		<span class="cm">/* for proc fs */</span>
		<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">spdifo_scb_desc</span><span class="p">);</span>
		<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">spdifi_scb_desc</span><span class="p">);</span>
		<span class="n">cs46xx_dsp_proc_register_scb_desc</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">async_codec_scb_desc</span><span class="p">);</span>

		<span class="cm">/* Async MASTER ENABLE, affects both SPDIF input and output */</span>
		<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ASER_MASTER</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs46xx_dsp_disable_spdif_hw</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="cm">/* set SPDIF output FIFO slot */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ASER_FADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* SPDIF output MASTER ENABLE */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* right and left validate bit */</span>
	<span class="cm">/*cs46xx_poke_via_dsp (chip,SP_SPDOUT_CSUV, ins-&gt;spdif_csuv_default);*/</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* clear fifo pointer */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDIN_FIFOPTR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_SPDIF_STATUS_HW_ENABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_enable_spdif_hw</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="cm">/* if hw-ctrl already enabled, turn off to reset logic ... */</span>
	<span class="n">cs46xx_dsp_disable_spdif_hw</span> <span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* set SPDIF output FIFO slot */</span>
	<span class="n">snd_cs46xx_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ASER_FADDR</span><span class="p">,</span> <span class="p">(</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="p">((</span><span class="n">SP_SPDOUT_FIFO</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">));</span>

	<span class="cm">/* SPDIF output MASTER ENABLE */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CONTROL</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>

	<span class="cm">/* right and left validate bit */</span>
	<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_default</span><span class="p">);</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_HW_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_enable_spdif_in</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="cm">/* turn on amplifier */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_INPUT_CTRL_ENABLED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* time countdown enable */</span>
		<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_ASER_COUNTDOWN</span><span class="p">,</span> <span class="mh">0x80000005</span><span class="p">);</span>
		<span class="cm">/* NOTE: 80000005 value is just magic. With all values</span>
<span class="cm">		   that I&#39;ve tested this one seem to give the best result.</span>
<span class="cm">		   Got no explication why. (Benny) */</span>

		<span class="cm">/* SPDIF input MASTER ENABLE */</span>
		<span class="n">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">SP_SPDIN_CONTROL</span><span class="p">,</span> <span class="mh">0x800003ff</span><span class="p">);</span>

		<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">|=</span> <span class="n">DSP_SPDIF_STATUS_INPUT_CTRL_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create and start the asynchronous receiver SCB */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span> <span class="o">=</span> <span class="n">cs46xx_dsp_create_asynch_fg_rx_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;AsynchFGRxSCB&quot;</span><span class="p">,</span>
								<span class="n">ASYNCRX_SCB_ADDR</span><span class="p">,</span>
								<span class="n">SPDIFI_SCB_INST</span><span class="p">,</span>
								<span class="n">SPDIFI_IP_OUTPUT_BUFFER1</span><span class="p">,</span>
								<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">,</span>
								<span class="n">SCB_ON_PARENT_SUBLIST_SCB</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* reset SPDIF input sample buffer pointer */</span>
	<span class="cm">/*snd_cs46xx_poke (chip, (SPDIFI_SCB_INST + 0x0c) &lt;&lt; 2,</span>
<span class="cm">	  (SPDIFI_IP_OUTPUT_BUFFER1 &lt;&lt; 0x10) | 0xFFFC);*/</span>

	<span class="cm">/* reset FIFO ptr */</span>
	<span class="cm">/*cs46xx_poke_via_dsp (chip,SP_SPDIN_FIFOPTR, 0x0);*/</span>
	<span class="n">cs46xx_src_link</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">);</span>

	<span class="cm">/* unmute SRC volume */</span>
	<span class="n">cs46xx_dsp_scb_set_volume</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">,</span><span class="mh">0x7fff</span><span class="p">,</span><span class="mh">0x7fff</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* set SPDIF input sample rate and unmute</span>
<span class="cm">	   NOTE: only 48khz support for SPDIF input this time */</span>
	<span class="cm">/* cs46xx_dsp_set_src_sample_rate(chip,ins-&gt;spdif_in_src,48000); */</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_disable_spdif_in</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="cm">/* Remove the asynchronous receiver SCB */</span>
	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cs46xx_src_unlink</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_in_src</span><span class="p">);</span>

	<span class="cm">/* monitor state */</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="cm">/* restore amplifier */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">amplifier_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_enable_pcm_capture</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span> <span class="o">=</span> <span class="n">cs46xx_add_record_source</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span><span class="p">,</span><span class="n">PCMSERIALIN_PCM_SCB_ADDR</span><span class="p">,</span>
                                                  <span class="s">&quot;PCMSerialInput_Wave&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_disable_pcm_capture</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">pcm_input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_enable_adc_capture</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">codec_in_scb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span> <span class="o">=</span> <span class="n">cs46xx_add_record_source</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">codec_in_scb</span><span class="p">,</span><span class="n">PCMSERIALIN_SCB_ADDR</span><span class="p">,</span>
						  <span class="s">&quot;PCMSerialInput_ADC&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_disable_adc_capture</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	<span class="n">cs46xx_dsp_remove_scb</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">adc_input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_poke_via_dsp</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* santiy check the parameters.  (These numbers are not 100% correct.  They are</span>
<span class="cm">	   a rough guess from looking at the controller spec.) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mh">0x8000</span> <span class="o">||</span> <span class="n">address</span> <span class="o">&gt;=</span> <span class="mh">0x9000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        
	<span class="cm">/* initialize the SP_IO_WRITE SCB with the data. */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span> <span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>   <span class="cm">/* offset 0 &lt;-- address2 : address1 */</span>

	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,(</span> <span class="n">SPIOWRITE_SCB_ADDR</span>      <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,((</span><span class="n">SPIOWRITE_SCB_ADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span> <span class="cm">/* offset 1 &lt;-- data1 */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,((</span><span class="n">SPIOWRITE_SCB_ADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span> <span class="cm">/* offset 1 &lt;-- data2 */</span>
    
	<span class="cm">/* Poke this location to tell the task to start */</span>
	<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,((</span><span class="n">SPIOWRITE_SCB_ADDR</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SPIOWRITE_SCB_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* Verify that the task ran */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span>  <span class="n">snd_cs46xx_peek</span><span class="p">(</span><span class="n">chip</span><span class="p">,((</span><span class="n">SPIOWRITE_SCB_ADDR</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dsp_spos: SPIOWriteTask not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_set_dac_volume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">left</span><span class="p">,</span> <span class="n">u16</span> <span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span> <span class="n">scb</span><span class="p">;</span> 

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>
	
	<span class="cm">/* main output */</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">master_mix_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_scb_set_volume</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rear output */</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">rear_mix_scb</span><span class="o">-&gt;</span><span class="n">sub_list_ptr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">the_null_scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_scb_set_volume</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">scb</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">next_scb_ptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">dac_volume_right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cs46xx_dsp_set_iec958_volume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">left</span><span class="p">,</span> <span class="n">u16</span> <span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cs46xx_dsp_scb_set_volume</span> <span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">asynch_rx_scb</span><span class="p">,</span>
					   <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">);</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_input_volume_right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spos_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">cs46xx_dsp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs46xx</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_spos_instance</span> <span class="o">*</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* clear parameter, sample and code areas */</span>
	<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_PARAMETER_BYTE_OFFSET</span><span class="p">,</span>
			     <span class="n">DSP_PARAMETER_BYTE_SIZE</span><span class="p">);</span>
	<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_SAMPLE_BYTE_OFFSET</span><span class="p">,</span>
			     <span class="n">DSP_SAMPLE_BYTE_SIZE</span><span class="p">);</span>
	<span class="n">snd_cs46xx_clear_BA1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DSP_CODE_BYTE_OFFSET</span><span class="p">,</span> <span class="n">DSP_CODE_BYTE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nmodules</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_module_desc</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">dsp_segment_desc</span> <span class="o">*</span><span class="n">seg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">;</span>

		<span class="n">seg</span> <span class="o">=</span> <span class="n">get_segment_desc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">SEGTYPE_SP_PARAMETER</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_load_parameter</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">seg</span> <span class="o">=</span> <span class="n">get_segment_desc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">SEGTYPE_SP_SAMPLE</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_load_sample</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">seg</span> <span class="o">=</span> <span class="n">get_segment_desc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">SEGTYPE_SP_PROGRAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seg</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">doffset</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">load_address</span> <span class="o">*</span> <span class="mi">4</span>
			<span class="o">+</span> <span class="n">DSP_CODE_BYTE_OFFSET</span><span class="p">;</span>
		<span class="n">dsize</span>   <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs46xx_download</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					  <span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">load_address</span><span class="p">,</span>
					  <span class="n">doffset</span><span class="p">,</span> <span class="n">dsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ntask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_task_descriptor</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">_dsp_create_task_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">_dsp_create_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">nscb</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsp_scb_descriptor</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">updated</span><span class="p">)</span>
			<span class="n">cs46xx_dsp_spos_update_scb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">volume_set</span><span class="p">)</span>
			<span class="n">cs46xx_dsp_scb_set_volume</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
						  <span class="n">s</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_HW_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_dsp_enable_spdif_hw</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_cs46xx_poke</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ref_snoop_scb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
				<span class="p">(</span><span class="n">OUTPUT_SNOOP_BUFFER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_status_out</span> <span class="o">&amp;</span> <span class="n">DSP_SPDIF_STATUS_PLAYBACK_OPEN</span><span class="p">)</span>
			<span class="n">cs46xx_poke_via_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SP_SPDOUT_CSUV</span><span class="p">,</span>
					    <span class="n">ins</span><span class="o">-&gt;</span><span class="n">spdif_csuv_stream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_spos_instance</span><span class="o">-&gt;</span><span class="n">spdif_status_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs46xx_poke_via_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SP_ASER_COUNTDOWN</span><span class="p">,</span> <span class="mh">0x80000005</span><span class="p">);</span>
		<span class="n">cs46xx_poke_via_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SP_SPDIN_CONTROL</span><span class="p">,</span> <span class="mh">0x800003ff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
