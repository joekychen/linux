<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › lx6464es › lx_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lx_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* -*- linux-c -*- *</span>
<span class="cm"> *</span>
<span class="cm"> * ALSA driver for the digigram lx6464es interface</span>
<span class="cm"> * low-level interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Tim Blechmann &lt;tim@klingt.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,</span>
<span class="cm"> * Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* #define RMH_DEBUG 1 */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &quot;lx6464es.h&quot;</span>
<span class="cp">#include &quot;lx_core.h&quot;</span>

<span class="cm">/* low-level register access */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dsp_port_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mh">0x400</span><span class="p">,</span>
	<span class="mh">0x401</span><span class="p">,</span>
	<span class="mh">0x402</span><span class="p">,</span>
	<span class="mh">0x403</span><span class="p">,</span>
	<span class="mh">0x404</span><span class="p">,</span>
	<span class="mh">0x405</span><span class="p">,</span>
	<span class="mh">0x406</span><span class="p">,</span>
	<span class="mh">0x407</span><span class="p">,</span>
	<span class="mh">0x408</span><span class="p">,</span>
	<span class="mh">0x409</span><span class="p">,</span>
	<span class="mh">0x40a</span><span class="p">,</span>
	<span class="mh">0x40b</span><span class="p">,</span>
	<span class="mh">0x40c</span><span class="p">,</span>

	<span class="mh">0x410</span><span class="p">,</span>
	<span class="mh">0x411</span><span class="p">,</span>
	<span class="mh">0x412</span><span class="p">,</span>
	<span class="mh">0x413</span><span class="p">,</span>
	<span class="mh">0x414</span><span class="p">,</span>
	<span class="mh">0x415</span><span class="p">,</span>
	<span class="mh">0x416</span><span class="p">,</span>

	<span class="mh">0x420</span><span class="p">,</span>
	<span class="mh">0x430</span><span class="p">,</span>
	<span class="mh">0x431</span><span class="p">,</span>
	<span class="mh">0x432</span><span class="p">,</span>
	<span class="mh">0x433</span><span class="p">,</span>
	<span class="mh">0x434</span><span class="p">,</span>
	<span class="mh">0x440</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">lx_dsp_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port_dsp_bar</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">base_address</span> <span class="o">+</span> <span class="n">dsp_port_offsets</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">lx_dsp_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_dsp_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lx_dsp_reg_readbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_dsp_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* we cannot use memcpy_fromio */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">lx_dsp_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_dsp_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lx_dsp_reg_writebuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_dsp_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* we cannot use memcpy_to */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">address</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">plx_port_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x4c</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x54</span><span class="p">,</span>
	<span class="mh">0x58</span><span class="p">,</span>
	<span class="mh">0x5c</span><span class="p">,</span>
	<span class="mh">0x64</span><span class="p">,</span>
	<span class="mh">0x68</span><span class="p">,</span>
	<span class="mh">0x6C</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">lx_plx_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port_plx_remapped</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">base_address</span> <span class="o">+</span> <span class="n">plx_port_offsets</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">lx_plx_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_plx_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lx_plx_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">lx_plx_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">lx_plx_mbox_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX1</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX2</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX3</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX4</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX5</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX6</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX7</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* reserved for HF flags */</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lx_plx_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_plx_mbox_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox_nr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX1</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX3</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX4</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX5</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX6</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">ePLX_MBOX7</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* reserved for HF flags */</span>
	<span class="k">case</span> <span class="mi">2</span>:			<span class="cm">/* reserved for Pipe States</span>
<span class="cm">				 * the DSP keeps an image of it */</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADRQC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lx_plx_reg_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* rmh */</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
<span class="cp">#define CMD_NAME(a) a</span>
<span class="cp">#else</span>
<span class="cp">#define CMD_NAME(a) NULL</span>
<span class="cp">#endif</span>

<span class="cp">#define Reg_CSM_MR			0x00000002</span>
<span class="cp">#define Reg_CSM_MC			0x00000001</span>

<span class="k">struct</span> <span class="n">dsp_cmd_info</span> <span class="p">{</span>
	<span class="n">u32</span>    <span class="n">dcCodeOp</span><span class="p">;</span>	<span class="cm">/* Op Code of the command (usually 1st 24-bits</span>
<span class="cm">				 * word).*/</span>
	<span class="n">u16</span>    <span class="n">dcCmdLength</span><span class="p">;</span>	<span class="cm">/* Command length in words of 24 bits.*/</span>
	<span class="n">u16</span>    <span class="n">dcStatusType</span><span class="p">;</span>	<span class="cm">/* Status type: 0 for fixed length, 1 for</span>
<span class="cm">				 * random. */</span>
	<span class="n">u16</span>    <span class="n">dcStatusLength</span><span class="p">;</span>	<span class="cm">/* Status length (if fixed).*/</span>
	<span class="kt">char</span>  <span class="o">*</span><span class="n">dcOpName</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">  Initialization and control data for the Microblaze interface</span>
<span class="cm">  - OpCode:</span>
<span class="cm">    the opcode field of the command set at the proper offset</span>
<span class="cm">  - CmdLength</span>
<span class="cm">    the number of command words</span>
<span class="cm">  - StatusType</span>
<span class="cm">    offset in the status registers: 0 means that the return value may be</span>
<span class="cm">    different from 0, and must be read</span>
<span class="cm">  - StatusLength</span>
<span class="cm">    the number of status words (in addition to the return value)</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_cmd_info</span> <span class="n">dsp_commands</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_00_INFO_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/*custom*/</span>
	  <span class="p">,</span> <span class="mi">1</span>	<span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;INFO_DEBUG&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_01_GET_SYS_CFG</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span> 		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">2</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_SYS_CFG&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_02_SET_GRANULARITY</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>	        <span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;SET_GRANULARITY&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_03_SET_TIMER_IRQ</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;SET_TIMER_IRQ&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_04_GET_EVENT</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/*up to 10*/</span>     <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_EVENT&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_05_GET_PIPES</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">2</span> <span class="cm">/*up to 4*/</span>      <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_PIPES&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_06_ALLOCATE_PIPE</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">0</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;ALLOCATE_PIPE&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_07_RELEASE_PIPE</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">0</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;RELEASE_PIPE&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_08_ASK_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span> 		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="n">MAX_STREAM_BUFFER</span>  <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;ASK_BUFFERS&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_09_STOP_PIPE</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">0</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/*up to 2*/</span>      <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;STOP_PIPE&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0A_GET_PIPE_SPL_COUNT</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>	        <span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">1</span> <span class="cm">/*up to 2*/</span>      <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_PIPE_SPL_COUNT&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0B_TOGGLE_PIPE_STATE</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>           <span class="p">,</span> <span class="mi">1</span> <span class="cm">/*up to 5*/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;TOGGLE_PIPE_STATE&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0C_DEF_STREAM</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/*up to 4*/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;DEF_STREAM&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0D_SET_MUTE</span>  <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">3</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;SET_MUTE&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0E_GET_STREAM_SPL_COUNT</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>        <span class="p">,</span> <span class="mi">1</span><span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">2</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_STREAM_SPL_COUNT&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_0F_UPDATE_BUFFER</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>		<span class="p">,</span> <span class="mi">3</span> <span class="cm">/*up to 4*/</span>
	  <span class="p">,</span> <span class="mi">0</span>      <span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;UPDATE_BUFFER&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_10_GET_BUFFER</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">4</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_BUFFER&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_11_CANCEL_BUFFER</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>		<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">1</span> <span class="cm">/*up to 4*/</span>      <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;CANCEL_BUFFER&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_12_GET_PEAK</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;GET_PEAK&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">CMD_13_SET_STREAM_STATE</span> <span class="o">&lt;&lt;</span> <span class="n">OPCODE_OFFSET</span><span class="p">)</span>	        <span class="p">,</span> <span class="mi">1</span> <span class="cm">/**/</span>
	  <span class="p">,</span> <span class="mi">1</span>      <span class="p">,</span> <span class="mi">0</span> <span class="cm">/**/</span>		    <span class="p">,</span> <span class="n">CMD_NAME</span><span class="p">(</span><span class="s">&quot;SET_STREAM_STATE&quot;</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lx_message_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx_rmh</span> <span class="o">*</span><span class="n">rmh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cmd_mb_opcodes</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;=</span> <span class="n">CMD_14_INVALID</span><span class="p">);</span>

	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp_commands</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">dcCodeOp</span><span class="p">;</span>
	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">dsp_commands</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">dcCmdLength</span><span class="p">;</span>
	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat_len</span> <span class="o">=</span> <span class="n">dsp_commands</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">dcStatusLength</span><span class="p">;</span>
	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">dsp_stat</span> <span class="o">=</span> <span class="n">dsp_commands</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">dcStatusType</span><span class="p">;</span>
	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">REG_CRM_NUMBER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REG_CRM_NUMBER</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef RMH_DEBUG</span>
	<span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef RMH_DEBUG</span>
<span class="cp">#define LXRMH &quot;lx6464es rmh: &quot;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lx_message_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx_rmh</span> <span class="o">*</span><span class="n">rmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXRMH</span> <span class="s">&quot;command %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsp_commands</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dcOpName</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXRMH</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">cmd[%d] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXRMH</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">stat[%d]: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lx_message_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx_rmh</span> <span class="o">*</span><span class="n">rmh</span><span class="p">)</span>
<span class="p">{}</span>
<span class="cp">#endif</span>



<span class="cm">/* sleep 500 - 100 = 400 times 100us -&gt; the timeout is &gt;= 40 ms */</span>
<span class="cp">#define XILINX_TIMEOUT_MS       40</span>
<span class="cp">#define XILINX_POLL_NO_SLEEP    100</span>
<span class="cp">#define XILINX_POLL_ITERATIONS  150</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_message_send_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lx_rmh</span> <span class="o">*</span><span class="n">rmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ED_DSP_TIMED_OUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dwloop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Reg_CSM_MC</span> <span class="o">|</span> <span class="n">Reg_CSM_MR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span> <span class="s">&quot;PIOSendMessage eReg_CSM %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write command */</span>
	<span class="n">lx_dsp_reg_writebuf</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CRM1</span><span class="p">,</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="cm">/* MicoBlaze gogogo */</span>
	<span class="n">lx_dsp_reg_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CSM</span><span class="p">,</span> <span class="n">Reg_CSM_MC</span><span class="p">);</span>

	<span class="cm">/* wait for device to answer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dwloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dwloop</span> <span class="o">!=</span> <span class="n">XILINX_TIMEOUT_MS</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">dwloop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Reg_CSM_MR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rmh</span><span class="o">-&gt;</span><span class="n">dsp_stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CRM1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">polling_successful</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">LXP</span> <span class="s">&quot;TIMEOUT lx_message_send_atomic! &quot;</span>
		   <span class="s">&quot;polling failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">polling_successful:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">ERROR_VALUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read response */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat_len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">REG_CRM_NUMBER</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">lx_dsp_reg_readbuf</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CRM2</span><span class="p">,</span> <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span>
					   <span class="n">rmh</span><span class="o">-&gt;</span><span class="n">stat_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;rmh error: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* clear Reg_CSM_MR */</span>
	<span class="n">lx_dsp_reg_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CSM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ED_DSP_TIMED_OUT</span>:
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">LXP</span> <span class="s">&quot;lx_message_send: dsp timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ED_DSP_CRASHED</span>:
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">LXP</span> <span class="s">&quot;lx_message_send: dsp crashed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lx_message_dump</span><span class="p">(</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* low-level dsp access */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lx_dsp_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rdsp_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_01_GET_SYS_CFG</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rdsp_version</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_dsp_get_clock_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_01_GET_SYS_CFG</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq_raw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">FREQ_FIELD_OFFSET</span><span class="p">;</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">freq_raw</span> <span class="o">&amp;</span> <span class="n">XES_FREQ_COUNT8_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">XES_FREQ_COUNT8_48_MAX</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">XES_FREQ_COUNT8_44_MIN</span><span class="p">))</span>
			<span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unknown */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">XES_FREQ_COUNT8_44_MAX</span><span class="p">)</span>
			<span class="n">frequency</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">frequency</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rfreq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_ratio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_dsp_get_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macmsb</span><span class="p">,</span> <span class="n">maclsb</span><span class="p">;</span>

	<span class="n">macmsb</span> <span class="o">=</span> <span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_ADMACESMSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span>
	<span class="n">maclsb</span> <span class="o">=</span> <span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_ADMACESLSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span>

	<span class="cm">/* todo: endianess handling */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">maclsb</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">maclsb</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">maclsb</span><span class="p">))[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">macmsb</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">macmsb</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">macmsb</span><span class="p">))[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">lx_dsp_set_granularity</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gran</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_02_SET_GRANULARITY</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">gran</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_dsp_read_async_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_04_GET_EVENT</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>	<span class="cm">/* we don&#39;t necessarily need the full length */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CSES_TIMEOUT        100     </span><span class="cm">/* microseconds */</span><span class="cp"></span>
<span class="cp">#define CSES_CE             0x0001</span>
<span class="cp">#define CSES_BROADCAST      0x0002</span>
<span class="cp">#define CSES_UPDATE_LDSV    0x0004</span>

<span class="kt">int</span> <span class="nf">lx_dsp_es_check_pipeline</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">CSES_TIMEOUT</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * le bit CSES_UPDATE_LDSV est Ã  1 dÃ©s que le macprog</span>
<span class="cm">		 * est pret. il re-passe Ã  0 lorsque le premier read a</span>
<span class="cm">		 * Ã©tÃ© fait. pour l&#39;instant on retire le test car ce bit</span>
<span class="cm">		 * passe a 1 environ 200 Ã  400 ms aprÃ©s que le registre</span>
<span class="cm">		 * confES Ã  Ã©tÃ© Ã©crit (kick du xilinx ES).</span>
<span class="cm">		 *</span>
<span class="cm">		 * On ne teste que le bit CE.</span>
<span class="cm">		 * */</span>

		<span class="n">u32</span> <span class="n">cses</span> <span class="o">=</span> <span class="n">lx_dsp_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">eReg_CSES</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cses</span> <span class="o">&amp;</span> <span class="n">CSES_CE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define PIPE_INFO_TO_CMD(capture, pipe)					\</span>
<span class="cp">	((u32)((u32)(pipe) | ((capture) ? ID_IS_CAPTURE : 0L)) &lt;&lt; ID_OFFSET)</span>



<span class="cm">/* low-level pipe handling */</span>
<span class="kt">int</span> <span class="nf">lx_pipe_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_06_ALLOCATE_PIPE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">channels</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lx6464es: could not allocate pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_pipe_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_07_RELEASE_PIPE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_buffer_ask</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="o">*</span><span class="n">r_needed</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">r_freed</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">size_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size_array</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">size_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_STREAM_BUFFER</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">r_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">r_freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_08_ASK_BUFFERS</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_STREAM_BUFFER</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BF_EOB</span> <span class="o">&lt;&lt;</span> <span class="n">BUFF_FLAGS_OFFSET</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* finished */</span>
				<span class="o">*</span><span class="n">r_freed</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">size_array</span><span class="p">)</span>
					<span class="n">size_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="n">MASK_DATA_SIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BF_VALID</span> <span class="o">&lt;&lt;</span> <span class="n">BUFF_FLAGS_OFFSET</span><span class="p">))</span>
				   <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* free */</span>
				<span class="o">*</span><span class="n">r_needed</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		snd_printdd(LXP &quot;CMD_08_ASK_BUFFERS: needed %d, freed %d\n&quot;,</span>
<span class="c">			    *r_needed, *r_freed);</span>
<span class="c">		for (i = 0; i &lt; MAX_STREAM_BUFFER; ++i) {</span>
<span class="c">			for (i = 0; i != chip-&gt;rmh.stat_len; ++i)</span>
<span class="c">				snd_printdd(&quot;  stat[%d]: %x, %x\n&quot;, i,</span>
<span class="c">					    chip-&gt;rmh.stat[i],</span>
<span class="c">					    chip-&gt;rmh.stat[i] &amp; MASK_DATA_SIZE);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">lx_pipe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_09_STOP_PIPE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_pipe_toggle_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0B_TOGGLE_PIPE_STATE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">lx_pipe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_pipe_wait_for_idle</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_pipe_toggle_state</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_pipe_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_pipe_wait_for_start</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_pipe_toggle_state</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">lx_pipe_sample_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="o">*</span><span class="n">rsample_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0A_GET_PIPE_SPL_COUNT</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* need all words here! */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span> <span class="cm">/* don&#39;t sleep! */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;lx6464es: could not query pipe&#39;s sample count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rsample_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MASK_SPL_COUNT_HI</span><span class="p">)</span>
				  <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>     <span class="cm">/* hi part */</span>
			<span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* lo part */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_pipe_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0A_GET_PIPE_SPL_COUNT</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lx6464es: could not query pipe&#39;s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">rstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">PSTATE_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_pipe_wait_for_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">u16</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* max 2*PCMOnlyGranularity = 2*1024 at 44100 = &lt; 50 ms:</span>
<span class="cm">	 * timeout 50 ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">50</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">current_state</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">lx_pipe_state</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_pipe_wait_for_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lx_pipe_wait_for_state</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">PSTATE_RUN</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_pipe_wait_for_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lx_pipe_wait_for_state</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">PSTATE_IDLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* low-level stream handling */</span>
<span class="kt">int</span> <span class="nf">lx_stream_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="k">enum</span> <span class="n">stream_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_13_SET_STREAM_STATE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_stream_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="n">channels</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span> <span class="s">&quot;channel count mismatch: %d vs %d&quot;</span><span class="p">,</span>
			   <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">channels</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0C_DEF_STREAM</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sample_bits</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="cm">/* 16 bit format */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STREAM_FMT_16b</span> <span class="o">&lt;&lt;</span> <span class="n">STREAM_FMT_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_little_endian</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="cm">/* little endian/intel format */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STREAM_FMT_intel</span> <span class="o">&lt;&lt;</span> <span class="n">STREAM_FMT_OFFSET</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">channels</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_stream_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="o">*</span><span class="n">rstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0E_GET_STREAM_SPL_COUNT</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SF_START</span><span class="p">)</span> <span class="o">?</span> <span class="n">START_STATE</span> <span class="o">:</span> <span class="n">PAUSE_STATE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_stream_sample_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="o">*</span><span class="n">r_bytepos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0E_GET_STREAM_SPL_COUNT</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_bytepos</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MASK_SPL_COUNT_HI</span><span class="p">)</span>
		      <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>	     <span class="cm">/* hi part */</span>
		<span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* lo part */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* low-level buffer handling */</span>
<span class="kt">int</span> <span class="nf">lx_buffer_give</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_address_lo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_address_hi</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">r_buffer_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0F_UPDATE_BUFFER</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BF_NOTIFY_EOB</span><span class="p">;</span> <span class="cm">/* request interrupt notification */</span>

	<span class="cm">/* todo: pause request, circular buffer */</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer_size</span> <span class="o">&amp;</span> <span class="n">MASK_DATA_SIZE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf_address_lo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_address_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf_address_hi</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BF_64BITS_ADR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">r_buffer_index</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EB_RBUFFERS_TABLE_OVERFLOW</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;lx_buffer_give EB_RBUFFERS_TABLE_OVERFLOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EB_INVALID_STREAM</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;lx_buffer_give EB_INVALID_STREAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EB_CMD_REFUSED</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;lx_buffer_give EB_CMD_REFUSED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">r_buffer_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_11_CANCEL_BUFFER</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MASK_BUFFER_ID</span><span class="p">;</span> <span class="cm">/* ask for the current buffer: the</span>
<span class="cm">					     * microblaze will seek for it */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_buffer_size</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="n">MASK_DATA_SIZE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lx_buffer_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">buffer_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pipe_cmd</span> <span class="o">=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_11_CANCEL_BUFFER</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe_cmd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">buffer_index</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* low-level gain/peak handling</span>
<span class="cm"> *</span>
<span class="cm"> * \todo: can we unmute capture/playback channels independently?</span>
<span class="cm"> *</span>
<span class="cm"> * */</span>
<span class="kt">int</span> <span class="nf">lx_level_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unmute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* bit set to 1: channel muted */</span>
	<span class="n">u64</span> <span class="n">mute_mask</span> <span class="o">=</span> <span class="n">unmute</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0xFFFFFFFFFFFFFFFFLLU</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_0D_SET_MUTE</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mute_mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">32</span><span class="p">);</span>	       <span class="cm">/* hi part */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mute_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="cm">/* lo part */</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="s">&quot;mute %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">peak_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000109</span><span class="p">,</span> <span class="cm">/* -90.308dB */</span>
	<span class="mh">0x0000083B</span><span class="p">,</span> <span class="cm">/* -72.247dB */</span>
	<span class="mh">0x000020C4</span><span class="p">,</span> <span class="cm">/* -60.205dB */</span>
	<span class="mh">0x00008273</span><span class="p">,</span> <span class="cm">/* -48.030dB */</span>
	<span class="mh">0x00020756</span><span class="p">,</span> <span class="cm">/* -36.005dB */</span>
	<span class="mh">0x00040C37</span><span class="p">,</span> <span class="cm">/* -30.001dB */</span>
	<span class="mh">0x00081385</span><span class="p">,</span> <span class="cm">/* -24.002dB */</span>
	<span class="mh">0x00101D3F</span><span class="p">,</span> <span class="cm">/* -18.000dB */</span>
	<span class="mh">0x0016C310</span><span class="p">,</span> <span class="cm">/* -15.000dB */</span>
	<span class="mh">0x002026F2</span><span class="p">,</span> <span class="cm">/* -12.001dB */</span>
	<span class="mh">0x002D6A86</span><span class="p">,</span> <span class="cm">/* -9.000dB */</span>
	<span class="mh">0x004026E6</span><span class="p">,</span> <span class="cm">/* -6.004dB */</span>
	<span class="mh">0x005A9DF6</span><span class="p">,</span> <span class="cm">/* -3.000dB */</span>
	<span class="mh">0x0065AC8B</span><span class="p">,</span> <span class="cm">/* -2.000dB */</span>
	<span class="mh">0x00721481</span><span class="p">,</span> <span class="cm">/* -1.000dB */</span>
	<span class="mh">0x007FFFFF</span><span class="p">,</span> <span class="cm">/* FS */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">lx_level_peaks</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">r_levels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">;</span>

		<span class="n">lx_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_12_GET_PEAK</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PIPE_INFO_TO_CMD</span><span class="p">(</span><span class="n">is_capture</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">lx_message_send_atomic</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s0</span> <span class="o">=</span> <span class="n">peak_map</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">];</span>
			<span class="n">s1</span> <span class="o">=</span> <span class="n">peak_map</span><span class="p">[(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
			<span class="n">s2</span> <span class="o">=</span> <span class="n">peak_map</span><span class="p">[(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
			<span class="n">s3</span> <span class="o">=</span> <span class="n">peak_map</span><span class="p">[(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>  <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">s0</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">r_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0</span><span class="p">;</span>
		<span class="n">r_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span><span class="p">;</span>
		<span class="n">r_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="p">;</span>
		<span class="n">r_levels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">s3</span><span class="p">;</span>

		<span class="n">r_levels</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* interrupt handling */</span>
<span class="cp">#define PCX_IRQ_NONE 0</span>
<span class="cp">#define IRQCS_ACTIVE_PCIDB  0x00002000L         </span><span class="cm">/* Bit nÃÂ¸ 13 */</span><span class="cp"></span>
<span class="cp">#define IRQCS_ENABLE_PCIIRQ 0x00000100L         </span><span class="cm">/* Bit nÃÂ¸ 08 */</span><span class="cp"></span>
<span class="cp">#define IRQCS_ENABLE_PCIDB  0x00000200L         </span><span class="cm">/* Bit nÃÂ¸ 09 */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">lx_interrupt_test_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">irqcs</span> <span class="o">=</span> <span class="n">lx_plx_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ePLX_IRQCS</span><span class="p">);</span>

	<span class="cm">/* Test if PCI Doorbell interrupt is active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqcs</span> <span class="o">&amp;</span> <span class="n">IRQCS_ACTIVE_PCIDB</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">irqcs</span> <span class="o">=</span> <span class="n">PCX_IRQ_NONE</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">temp</span> <span class="o">=</span> <span class="n">lx_plx_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ePLX_L2PCIDB</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* RAZ interrupt */</span>
			<span class="n">irqcs</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">lx_plx_reg_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ePLX_L2PCIDB</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">irqcs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCX_IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_interrupt_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">r_irqsrc</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">r_async_pending</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">r_async_escmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">irq_async</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqsrc</span> <span class="o">=</span> <span class="n">lx_interrupt_test_ack</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsrc</span> <span class="o">==</span> <span class="n">PCX_IRQ_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_irqsrc</span> <span class="o">=</span> <span class="n">irqsrc</span><span class="p">;</span>

	<span class="n">irq_async</span> <span class="o">=</span> <span class="n">irqsrc</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_ASYNC_EVENTS</span><span class="p">;</span> <span class="cm">/* + EtherSound response</span>
<span class="cm">						     * (set by xilinx) + EOB */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_async</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_STATUS_ESA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_async</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_SYS_STATUS_ESA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">r_async_escmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_async</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* snd_printd(&quot;interrupt: async event pending\n&quot;); */</span>
		<span class="o">*</span><span class="n">r_async_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_interrupt_handle_async_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqsrc</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="o">*</span><span class="n">r_freq_changed</span><span class="p">,</span>
					    <span class="n">u64</span> <span class="o">*</span><span class="n">r_notified_in_pipe_mask</span><span class="p">,</span>
					    <span class="n">u64</span> <span class="o">*</span><span class="n">r_notified_out_pipe_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>		<span class="cm">/* answer from CMD_04_GET_EVENT */</span>

	<span class="cm">/* On peut optimiser pour ne pas lire les evenements vides</span>
<span class="cm">	 * les mots de rÃÂ©ponse sont dans l&#39;ordre suivant :</span>
<span class="cm">	 * Stat[0]	mot de status gÃÂ©nÃÂ©ral</span>
<span class="cm">	 * Stat[1]	fin de buffer OUT pF</span>
<span class="cm">	 * Stat[2]	fin de buffer OUT pf</span>
<span class="cm">	 * Stat[3]	fin de buffer IN pF</span>
<span class="cm">	 * Stat[4]	fin de buffer IN pf</span>
<span class="cm">	 * Stat[5]	underrun poid fort</span>
<span class="cm">	 * Stat[6]	underrun poid faible</span>
<span class="cm">	 * Stat[7]	overrun poid fort</span>
<span class="cm">	 * Stat[8]	overrun poid faible</span>
<span class="cm">	 * */</span>

	<span class="n">u64</span> <span class="n">orun_mask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">urun_mask</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	int has_underrun   = (irqsrc &amp; MASK_SYS_STATUS_URUN) ? 1 : 0;</span>
<span class="c">	int has_overrun    = (irqsrc &amp; MASK_SYS_STATUS_ORUN) ? 1 : 0;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">eb_pending_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">irqsrc</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_STATUS_EOBO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eb_pending_in</span>  <span class="o">=</span> <span class="p">(</span><span class="n">irqsrc</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_STATUS_EOBI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_freq_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">irqsrc</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_STATUS_FREQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_dsp_read_async_events</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eb_pending_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">r_notified_in_pipe_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">stat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">stat</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;interrupt: EOBI pending %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="o">*</span><span class="n">r_notified_in_pipe_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eb_pending_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">r_notified_out_pipe_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">stat</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;interrupt: EOBO pending %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="o">*</span><span class="n">r_notified_out_pipe_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">orun_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">stat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">stat</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">urun_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">stat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">stat</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="cm">/* todo: handle xrun notification */</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_interrupt_request_new_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">lx_stream</span> <span class="o">*</span><span class="n">lx_stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_capture</span> <span class="o">=</span> <span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">is_capture</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u32</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">bytes_per_frame</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">period_size</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">period_bytes</span> <span class="o">=</span> <span class="n">period_size</span> <span class="o">*</span> <span class="n">bytes_per_frame</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">frame_pos</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">next_pos</span> <span class="o">=</span> <span class="p">((</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">)</span> <span class="o">?</span>
		<span class="mi">0</span> <span class="o">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_addr_t</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">period_bytes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">needed</span><span class="p">,</span> <span class="n">freed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size_array</span><span class="p">[</span><span class="n">MAX_STREAM_BUFFER</span><span class="p">];</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;-&gt;lx_interrupt_request_new_buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_buffer_ask</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freed</span><span class="p">,</span> <span class="n">size_array</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;interrupt: needed %d, freed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">needed</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>

	<span class="n">unpack_pointer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_hi</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_buffer_give</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">period_bytes</span><span class="p">,</span> <span class="n">buf_lo</span><span class="p">,</span> <span class="n">buf_hi</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">buffer_index</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;interrupt: gave buffer index %x on %p (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">buffer_index</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">period_bytes</span><span class="p">);</span>

	<span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">frame_pos</span> <span class="o">=</span> <span class="n">next_pos</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lx_tasklet_playback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lx_stream</span> <span class="o">*</span><span class="n">lx_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;-&gt;lx_tasklet_playback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_interrupt_request_new_buffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lx_stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span>
			   <span class="s">&quot;cannot request new buffer for playback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lx_tasklet_capture</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lx_stream</span> <span class="o">*</span><span class="n">lx_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;-&gt;lx_tasklet_capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lx_interrupt_request_new_buffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lx_stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span>
			   <span class="s">&quot;cannot request new buffer for capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">lx_stream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">lx_interrupt_handle_audio_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="n">notified_in_pipe_mask</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="n">notified_out_pipe_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notified_in_pipe_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;requesting audio transfer for capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tasklet_capture</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notified_out_pipe_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">LXP</span> <span class="s">&quot;requesting audio transfer for playback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tasklet_playback</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">irqreturn_t</span> <span class="nf">lx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">async_pending</span><span class="p">,</span> <span class="n">async_escmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqsrc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;**************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lx_interrupt_ack</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqsrc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async_pending</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async_escmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;IRQ_NONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span> <span class="cm">/* this device did not cause the interrupt */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsrc</span> <span class="o">&amp;</span> <span class="n">MASK_SYS_STATUS_CMD_DONE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (irqsrc &amp; MASK_SYS_STATUS_EOBI)</span>
<span class="c">		snd_printdd(LXP &quot;interrupt: EOBI\n&quot;);</span>

<span class="c">	if (irqsrc &amp; MASK_SYS_STATUS_EOBO)</span>
<span class="c">		snd_printdd(LXP &quot;interrupt: EOBO\n&quot;);</span>

<span class="c">	if (irqsrc &amp; MASK_SYS_STATUS_URUN)</span>
<span class="c">		snd_printdd(LXP &quot;interrupt: URUN\n&quot;);</span>

<span class="c">	if (irqsrc &amp; MASK_SYS_STATUS_ORUN)</span>
<span class="c">		snd_printdd(LXP &quot;interrupt: ORUN\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">notified_in_pipe_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">notified_out_pipe_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">freq_changed</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* handle async events */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">lx_interrupt_handle_async_events</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">irqsrc</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">freq_changed</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">notified_in_pipe_mask</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">notified_out_pipe_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span>
				   <span class="s">&quot;error handling async events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">lx_interrupt_handle_audio_transfer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
							 <span class="n">notified_in_pipe_mask</span><span class="p">,</span>
							 <span class="n">notified_out_pipe_mask</span>
			<span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">LXP</span>
				   <span class="s">&quot;error during audio transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async_escmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* backdoor for ethersound commands</span>
<span class="c">		 *</span>
<span class="c">		 * for now, we do not need this</span>
<span class="c">		 *</span>
<span class="c">		 * */</span>

<span class="c">		snd_printdd(&quot;lx6464es: interrupt requests escmd handling\n&quot;);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>	<span class="cm">/* this device caused the interrupt */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">lx_irq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">lx_plx_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ePLX_IRQCS</span><span class="p">);</span>

	<span class="cm">/* enable/disable interrupts</span>
<span class="cm">	 *</span>
<span class="cm">	 * Set the Doorbell and PCI interrupt enable bits</span>
<span class="cm">	 *</span>
<span class="cm">	 * */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">IRQCS_ENABLE_PCIIRQ</span> <span class="o">|</span> <span class="n">IRQCS_ENABLE_PCIDB</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQCS_ENABLE_PCIIRQ</span> <span class="o">|</span> <span class="n">IRQCS_ENABLE_PCIDB</span><span class="p">);</span>
	<span class="n">lx_plx_reg_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ePLX_IRQCS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lx_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;-&gt;lx_irq_enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lx_irq_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lx_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lx6464es</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;-&gt;lx_irq_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lx_irq_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
