<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › cs4281.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cs4281.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for Cirrus Logic CS4281 based PCI soundcard</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;,</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/rawmidi.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Cirrus Logic CS4281&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Cirrus Logic,CS4281}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable switches */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">dual_codec</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>	<span class="cm">/* dual codec */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for CS4281 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for CS4281 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable CS4281 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dual_codec</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dual_codec</span><span class="p">,</span> <span class="s">&quot;Secondary Codec ID (0 = disabled).&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Direct registers</span>
<span class="cm"> */</span>

<span class="cp">#define CS4281_BA0_SIZE		0x1000</span>
<span class="cp">#define CS4281_BA1_SIZE		0x10000</span>

<span class="cm">/*</span>
<span class="cm"> *  BA0 registers</span>
<span class="cm"> */</span>
<span class="cp">#define BA0_HISR		0x0000	</span><span class="cm">/* Host Interrupt Status Register */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_INTENA		(1&lt;&lt;31)	</span><span class="cm">/* Internal Interrupt Enable Bit */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_MIDI		(1&lt;&lt;22)	</span><span class="cm">/* MIDI port interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_FIFOI		(1&lt;&lt;20)	</span><span class="cm">/* FIFO polled interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_DMAI		(1&lt;&lt;18)	</span><span class="cm">/* DMA interrupt (half or end) */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_FIFO(c)	(1&lt;&lt;(12+(c))) </span><span class="cm">/* FIFO channel interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_DMA(c)		(1&lt;&lt;(8+(c)))  </span><span class="cm">/* DMA channel interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_GPPI		(1&lt;&lt;5)	</span><span class="cm">/* General Purpose Input (Primary chip) */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_GPSI		(1&lt;&lt;4)	</span><span class="cm">/* General Purpose Input (Secondary chip) */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_GP3I		(1&lt;&lt;3)	</span><span class="cm">/* GPIO3 pin Interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_GP1I		(1&lt;&lt;2)	</span><span class="cm">/* GPIO1 pin Interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_VUPI		(1&lt;&lt;1)	</span><span class="cm">/* VOLUP pin Interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_HISR_VDNI		(1&lt;&lt;0)	</span><span class="cm">/* VOLDN pin Interrupt */</span><span class="cp"></span>

<span class="cp">#define BA0_HICR		0x0008	</span><span class="cm">/* Host Interrupt Control Register */</span><span class="cp"></span>
<span class="cp">#define BA0_HICR_CHGM		(1&lt;&lt;1)	</span><span class="cm">/* INTENA Change Mask */</span><span class="cp"></span>
<span class="cp">#define BA0_HICR_IEV		(1&lt;&lt;0)	</span><span class="cm">/* INTENA Value */</span><span class="cp"></span>
<span class="cp">#define BA0_HICR_EOI		(3&lt;&lt;0)	</span><span class="cm">/* End of Interrupt command */</span><span class="cp"></span>

<span class="cp">#define BA0_HIMR		0x000c	</span><span class="cm">/* Host Interrupt Mask Register */</span><span class="cp"></span>
					<span class="cm">/* Use same contants as for BA0_HISR */</span>

<span class="cp">#define BA0_IIER		0x0010	</span><span class="cm">/* ISA Interrupt Enable Register */</span><span class="cp"></span>

<span class="cp">#define BA0_HDSR0		0x00f0	</span><span class="cm">/* Host DMA Engine 0 Status Register */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR1		0x00f4	</span><span class="cm">/* Host DMA Engine 1 Status Register */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR2		0x00f8	</span><span class="cm">/* Host DMA Engine 2 Status Register */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR3		0x00fc	</span><span class="cm">/* Host DMA Engine 3 Status Register */</span><span class="cp"></span>

<span class="cp">#define BA0_HDSR_CH1P		(1&lt;&lt;25)	</span><span class="cm">/* Channel 1 Pending */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR_CH2P		(1&lt;&lt;24)	</span><span class="cm">/* Channel 2 Pending */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR_DHTC		(1&lt;&lt;17)	</span><span class="cm">/* DMA Half Terminal Count */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR_DTC		(1&lt;&lt;16)	</span><span class="cm">/* DMA Terminal Count */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR_DRUN		(1&lt;&lt;15)	</span><span class="cm">/* DMA Running */</span><span class="cp"></span>
<span class="cp">#define BA0_HDSR_RQ		(1&lt;&lt;7)	</span><span class="cm">/* Pending Request */</span><span class="cp"></span>

<span class="cp">#define BA0_DCA0		0x0110	</span><span class="cm">/* Host DMA Engine 0 Current Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DCC0		0x0114	</span><span class="cm">/* Host DMA Engine 0 Current Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DBA0		0x0118	</span><span class="cm">/* Host DMA Engine 0 Base Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DBC0		0x011c	</span><span class="cm">/* Host DMA Engine 0 Base Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DCA1		0x0120	</span><span class="cm">/* Host DMA Engine 1 Current Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DCC1		0x0124	</span><span class="cm">/* Host DMA Engine 1 Current Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DBA1		0x0128	</span><span class="cm">/* Host DMA Engine 1 Base Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DBC1		0x012c	</span><span class="cm">/* Host DMA Engine 1 Base Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DCA2		0x0130	</span><span class="cm">/* Host DMA Engine 2 Current Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DCC2		0x0134	</span><span class="cm">/* Host DMA Engine 2 Current Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DBA2		0x0138	</span><span class="cm">/* Host DMA Engine 2 Base Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DBC2		0x013c	</span><span class="cm">/* Host DMA Engine 2 Base Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DCA3		0x0140	</span><span class="cm">/* Host DMA Engine 3 Current Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DCC3		0x0144	</span><span class="cm">/* Host DMA Engine 3 Current Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DBA3		0x0148	</span><span class="cm">/* Host DMA Engine 3 Base Address */</span><span class="cp"></span>
<span class="cp">#define BA0_DBC3		0x014c	</span><span class="cm">/* Host DMA Engine 3 Base Count */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR0		0x0150	</span><span class="cm">/* Host DMA Engine 0 Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR0		0x0154	</span><span class="cm">/* Host DMA Engine 0 Command */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR1		0x0158	</span><span class="cm">/* Host DMA Engine 1 Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR1		0x015c	</span><span class="cm">/* Host DMA Engine 1 Command */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR2		0x0160	</span><span class="cm">/* Host DMA Engine 2 Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR2		0x0164	</span><span class="cm">/* Host DMA Engine 2 Command */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR3		0x0168	</span><span class="cm">/* Host DMA Engine 3 Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR3		0x016c	</span><span class="cm">/* Host DMA Engine 3 Command */</span><span class="cp"></span>

<span class="cp">#define BA0_DMR_DMA		(1&lt;&lt;29)	</span><span class="cm">/* Enable DMA mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_POLL		(1&lt;&lt;28)	</span><span class="cm">/* Enable poll mode */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_TBC		(1&lt;&lt;25)	</span><span class="cm">/* Transfer By Channel */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_CBC		(1&lt;&lt;24)	</span><span class="cm">/* Count By Channel (0 = frame resolution) */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_SWAPC		(1&lt;&lt;22)	</span><span class="cm">/* Swap Left/Right Channels */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_SIZE20		(1&lt;&lt;20)	</span><span class="cm">/* Sample is 20-bit */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_USIGN		(1&lt;&lt;19)	</span><span class="cm">/* Unsigned */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_BEND		(1&lt;&lt;18)	</span><span class="cm">/* Big Endian */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_MONO		(1&lt;&lt;17)	</span><span class="cm">/* Mono */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_SIZE8		(1&lt;&lt;16)	</span><span class="cm">/* Sample is 8-bit */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_TYPE_DEMAND	(0&lt;&lt;6)</span>
<span class="cp">#define BA0_DMR_TYPE_SINGLE	(1&lt;&lt;6)</span>
<span class="cp">#define BA0_DMR_TYPE_BLOCK	(2&lt;&lt;6)</span>
<span class="cp">#define BA0_DMR_TYPE_CASCADE	(3&lt;&lt;6)	</span><span class="cm">/* Not supported */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_DEC		(1&lt;&lt;5)	</span><span class="cm">/* Access Increment (0) or Decrement (1) */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_AUTO		(1&lt;&lt;4)	</span><span class="cm">/* Auto-Initialize */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_TR_VERIFY	(0&lt;&lt;2)	</span><span class="cm">/* Verify Transfer */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_TR_WRITE	(1&lt;&lt;2)	</span><span class="cm">/* Write Transfer */</span><span class="cp"></span>
<span class="cp">#define BA0_DMR_TR_READ		(2&lt;&lt;2)	</span><span class="cm">/* Read Transfer */</span><span class="cp"></span>

<span class="cp">#define BA0_DCR_HTCIE		(1&lt;&lt;17)	</span><span class="cm">/* Half Terminal Count Interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR_TCIE		(1&lt;&lt;16)	</span><span class="cm">/* Terminal Count Interrupt */</span><span class="cp"></span>
<span class="cp">#define BA0_DCR_MSK		(1&lt;&lt;0)	</span><span class="cm">/* DMA Mask bit */</span><span class="cp"></span>

<span class="cp">#define BA0_FCR0		0x0180	</span><span class="cm">/* FIFO Control 0 */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR1		0x0184	</span><span class="cm">/* FIFO Control 1 */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR2		0x0188	</span><span class="cm">/* FIFO Control 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR3		0x018c	</span><span class="cm">/* FIFO Control 3 */</span><span class="cp"></span>

<span class="cp">#define BA0_FCR_FEN		(1&lt;&lt;31)	</span><span class="cm">/* FIFO Enable bit */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_DACZ		(1&lt;&lt;30)	</span><span class="cm">/* DAC Zero */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_PSH		(1&lt;&lt;29)	</span><span class="cm">/* Previous Sample Hold */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_RS(x)		(((x)&amp;0x1f)&lt;&lt;24) </span><span class="cm">/* Right Slot Mapping */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_LS(x)		(((x)&amp;0x1f)&lt;&lt;16) </span><span class="cm">/* Left Slot Mapping */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_SZ(x)		(((x)&amp;0x7f)&lt;&lt;8)	</span><span class="cm">/* FIFO buffer size (in samples) */</span><span class="cp"></span>
<span class="cp">#define BA0_FCR_OF(x)		(((x)&amp;0x7f)&lt;&lt;0)	</span><span class="cm">/* FIFO starting offset (in samples) */</span><span class="cp"></span>

<span class="cp">#define BA0_FPDR0		0x0190	</span><span class="cm">/* FIFO Polled Data 0 */</span><span class="cp"></span>
<span class="cp">#define BA0_FPDR1		0x0194	</span><span class="cm">/* FIFO Polled Data 1 */</span><span class="cp"></span>
<span class="cp">#define BA0_FPDR2		0x0198	</span><span class="cm">/* FIFO Polled Data 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_FPDR3		0x019c	</span><span class="cm">/* FIFO Polled Data 3 */</span><span class="cp"></span>

<span class="cp">#define BA0_FCHS		0x020c	</span><span class="cm">/* FIFO Channel Status */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_RCO(x)		(1&lt;&lt;(7+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Right Channel Out */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_LCO(x)		(1&lt;&lt;(6+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Left Channel Out */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_MRP(x)		(1&lt;&lt;(5+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Move Read Pointer */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_FE(x)		(1&lt;&lt;(4+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* FIFO Empty */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_FF(x)		(1&lt;&lt;(3+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* FIFO Full */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_IOR(x)		(1&lt;&lt;(2+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Internal Overrun Flag */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_RCI(x)		(1&lt;&lt;(1+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Right Channel In */</span><span class="cp"></span>
<span class="cp">#define BA0_FCHS_LCI(x)		(1&lt;&lt;(0+(((x)&amp;3)&lt;&lt;3))) </span><span class="cm">/* Left Channel In */</span><span class="cp"></span>

<span class="cp">#define BA0_FSIC0		0x0210	</span><span class="cm">/* FIFO Status and Interrupt Control 0 */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC1		0x0214	</span><span class="cm">/* FIFO Status and Interrupt Control 1 */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC2		0x0218	</span><span class="cm">/* FIFO Status and Interrupt Control 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC3		0x021c	</span><span class="cm">/* FIFO Status and Interrupt Control 3 */</span><span class="cp"></span>

<span class="cp">#define BA0_FSIC_FIC(x)		(((x)&amp;0x7f)&lt;&lt;24) </span><span class="cm">/* FIFO Interrupt Count */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FORIE		(1&lt;&lt;23) </span><span class="cm">/* FIFO OverRun Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FURIE		(1&lt;&lt;22) </span><span class="cm">/* FIFO UnderRun Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FSCIE		(1&lt;&lt;16)	</span><span class="cm">/* FIFO Sample Count Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FSC(x)		(((x)&amp;0x7f)&lt;&lt;8) </span><span class="cm">/* FIFO Sample Count */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FOR		(1&lt;&lt;7)	</span><span class="cm">/* FIFO OverRun */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FUR		(1&lt;&lt;6)	</span><span class="cm">/* FIFO UnderRun */</span><span class="cp"></span>
<span class="cp">#define BA0_FSIC_FSCR		(1&lt;&lt;0)	</span><span class="cm">/* FIFO Sample Count Reached */</span><span class="cp"></span>

<span class="cp">#define BA0_PMCS		0x0344	</span><span class="cm">/* Power Management Control/Status */</span><span class="cp"></span>
<span class="cp">#define BA0_CWPR		0x03e0	</span><span class="cm">/* Configuration Write Protect */</span><span class="cp"></span>

<span class="cp">#define BA0_EPPMC		0x03e4	</span><span class="cm">/* Extended PCI Power Management Control */</span><span class="cp"></span>
<span class="cp">#define BA0_EPPMC_FPDN		(1&lt;&lt;14) </span><span class="cm">/* Full Power DowN */</span><span class="cp"></span>

<span class="cp">#define BA0_GPIOR		0x03e8	</span><span class="cm">/* GPIO Pin Interface Register */</span><span class="cp"></span>

<span class="cp">#define BA0_SPMC		0x03ec	</span><span class="cm">/* Serial Port Power Management Control (&amp; ASDIN2 enable) */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_GIPPEN		(1&lt;&lt;15)	</span><span class="cm">/* GP INT Primary PME# Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_GISPEN		(1&lt;&lt;14)	</span><span class="cm">/* GP INT Secondary PME# Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_EESPD		(1&lt;&lt;9)	</span><span class="cm">/* EEPROM Serial Port Disable */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_ASDI2E		(1&lt;&lt;8)	</span><span class="cm">/* ASDIN2 Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_ASDO		(1&lt;&lt;7)	</span><span class="cm">/* Asynchronous ASDOUT Assertion */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_WUP2		(1&lt;&lt;3)	</span><span class="cm">/* Wakeup for Secondary Input */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_WUP1		(1&lt;&lt;2)	</span><span class="cm">/* Wakeup for Primary Input */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_ASYNC		(1&lt;&lt;1)	</span><span class="cm">/* Asynchronous ASYNC Assertion */</span><span class="cp"></span>
<span class="cp">#define BA0_SPMC_RSTN		(1&lt;&lt;0)	</span><span class="cm">/* Reset Not! */</span><span class="cp"></span>

<span class="cp">#define BA0_CFLR		0x03f0	</span><span class="cm">/* Configuration Load Register (EEPROM or BIOS) */</span><span class="cp"></span>
<span class="cp">#define BA0_CFLR_DEFAULT	0x00000001 </span><span class="cm">/* CFLR must be in AC97 link mode */</span><span class="cp"></span>
<span class="cp">#define BA0_IISR		0x03f4	</span><span class="cm">/* ISA Interrupt Select */</span><span class="cp"></span>
<span class="cp">#define BA0_TMS			0x03f8	</span><span class="cm">/* Test Register */</span><span class="cp"></span>
<span class="cp">#define BA0_SSVID		0x03fc	</span><span class="cm">/* Subsystem ID register */</span><span class="cp"></span>

<span class="cp">#define BA0_CLKCR1		0x0400	</span><span class="cm">/* Clock Control Register 1 */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_CLKON	(1&lt;&lt;25)	</span><span class="cm">/* Read Only */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_DLLRDY	(1&lt;&lt;24)	</span><span class="cm">/* DLL Ready */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_DLLOS	(1&lt;&lt;6)	</span><span class="cm">/* DLL Output Select */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_SWCE		(1&lt;&lt;5)	</span><span class="cm">/* Clock Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_DLLP		(1&lt;&lt;4)	</span><span class="cm">/* DLL PowerUp */</span><span class="cp"></span>
<span class="cp">#define BA0_CLKCR1_DLLSS	(((x)&amp;3)&lt;&lt;3) </span><span class="cm">/* DLL Source Select */</span><span class="cp"></span>

<span class="cp">#define BA0_FRR			0x0410	</span><span class="cm">/* Feature Reporting Register */</span><span class="cp"></span>
<span class="cp">#define BA0_SLT12O		0x041c	</span><span class="cm">/* Slot 12 GPIO Output Register for AC-Link */</span><span class="cp"></span>

<span class="cp">#define BA0_SERMC		0x0420	</span><span class="cm">/* Serial Port Master Control */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_FCRN		(1&lt;&lt;27)	</span><span class="cm">/* Force Codec Ready Not */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_ODSEN2	(1&lt;&lt;25)	</span><span class="cm">/* On-Demand Support Enable ASDIN2 */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_ODSEN1	(1&lt;&lt;24)	</span><span class="cm">/* On-Demand Support Enable ASDIN1 */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_SXLB		(1&lt;&lt;21)	</span><span class="cm">/* ASDIN2 to ASDOUT Loopback */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_SLB		(1&lt;&lt;20)	</span><span class="cm">/* ASDOUT to ASDIN2 Loopback */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_LOVF		(1&lt;&lt;19)	</span><span class="cm">/* Loopback Output Valid Frame bit */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_TCID(x)	(((x)&amp;3)&lt;&lt;16) </span><span class="cm">/* Target Secondary Codec ID */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_PXLB		(5&lt;&lt;1)	</span><span class="cm">/* Primary Port External Loopback */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_PLB		(4&lt;&lt;1)	</span><span class="cm">/* Primary Port Internal Loopback */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_PTC		(7&lt;&lt;1)	</span><span class="cm">/* Port Timing Configuration */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_PTC_AC97	(1&lt;&lt;1)	</span><span class="cm">/* AC97 mode */</span><span class="cp"></span>
<span class="cp">#define BA0_SERMC_MSPE		(1&lt;&lt;0)	</span><span class="cm">/* Master Serial Port Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_SERC1		0x0428	</span><span class="cm">/* Serial Port Configuration 1 */</span><span class="cp"></span>
<span class="cp">#define BA0_SERC1_SO1F(x)	(((x)&amp;7)&gt;&gt;1) </span><span class="cm">/* Primary Output Port Format */</span><span class="cp"></span>
<span class="cp">#define BA0_SERC1_AC97		(1&lt;&lt;1)</span>
<span class="cp">#define BA0_SERC1_SO1EN		(1&lt;&lt;0)	</span><span class="cm">/* Primary Output Port Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_SERC2		0x042c	</span><span class="cm">/* Serial Port Configuration 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_SERC2_SI1F(x)	(((x)&amp;7)&gt;&gt;1) </span><span class="cm">/* Primary Input Port Format */</span><span class="cp"></span>
<span class="cp">#define BA0_SERC2_AC97		(1&lt;&lt;1)</span>
<span class="cp">#define BA0_SERC2_SI1EN		(1&lt;&lt;0)	</span><span class="cm">/* Primary Input Port Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_SLT12M		0x045c	</span><span class="cm">/* Slot 12 Monitor Register for Primary AC-Link */</span><span class="cp"></span>

<span class="cp">#define BA0_ACCTL		0x0460	</span><span class="cm">/* AC&#39;97 Control */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCTL_TC		(1&lt;&lt;6)	</span><span class="cm">/* Target Codec */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCTL_CRW		(1&lt;&lt;4)	</span><span class="cm">/* 0=Write, 1=Read Command */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCTL_DCV		(1&lt;&lt;3)	</span><span class="cm">/* Dynamic Command Valid */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCTL_VFRM		(1&lt;&lt;2)	</span><span class="cm">/* Valid Frame */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCTL_ESYN		(1&lt;&lt;1)	</span><span class="cm">/* Enable Sync */</span><span class="cp"></span>

<span class="cp">#define BA0_ACSTS		0x0464	</span><span class="cm">/* AC&#39;97 Status */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSTS_VSTS		(1&lt;&lt;1)	</span><span class="cm">/* Valid Status */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSTS_CRDY		(1&lt;&lt;0)	</span><span class="cm">/* Codec Ready */</span><span class="cp"></span>

<span class="cp">#define BA0_ACOSV		0x0468	</span><span class="cm">/* AC&#39;97 Output Slot Valid */</span><span class="cp"></span>
<span class="cp">#define BA0_ACOSV_SLV(x)	(1&lt;&lt;((x)-3))</span>

<span class="cp">#define BA0_ACCAD		0x046c	</span><span class="cm">/* AC&#39;97 Command Address */</span><span class="cp"></span>
<span class="cp">#define BA0_ACCDA		0x0470	</span><span class="cm">/* AC&#39;97 Command Data */</span><span class="cp"></span>

<span class="cp">#define BA0_ACISV		0x0474	</span><span class="cm">/* AC&#39;97 Input Slot Valid */</span><span class="cp"></span>
<span class="cp">#define BA0_ACISV_SLV(x)	(1&lt;&lt;((x)-3))</span>

<span class="cp">#define BA0_ACSAD		0x0478	</span><span class="cm">/* AC&#39;97 Status Address */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSDA		0x047c	</span><span class="cm">/* AC&#39;97 Status Data */</span><span class="cp"></span>
<span class="cp">#define BA0_JSPT		0x0480	</span><span class="cm">/* Joystick poll/trigger */</span><span class="cp"></span>
<span class="cp">#define BA0_JSCTL		0x0484	</span><span class="cm">/* Joystick control */</span><span class="cp"></span>
<span class="cp">#define BA0_JSC1		0x0488	</span><span class="cm">/* Joystick control */</span><span class="cp"></span>
<span class="cp">#define BA0_JSC2		0x048c	</span><span class="cm">/* Joystick control */</span><span class="cp"></span>
<span class="cp">#define BA0_JSIO		0x04a0</span>

<span class="cp">#define BA0_MIDCR		0x0490	</span><span class="cm">/* MIDI Control */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_MRST		(1&lt;&lt;5)	</span><span class="cm">/* Reset MIDI Interface */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_MLB		(1&lt;&lt;4)	</span><span class="cm">/* MIDI Loop Back Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_TIE		(1&lt;&lt;3)	</span><span class="cm">/* MIDI Transmuit Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_RIE		(1&lt;&lt;2)	</span><span class="cm">/* MIDI Receive Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_RXE		(1&lt;&lt;1)	</span><span class="cm">/* MIDI Receive Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDCR_TXE		(1&lt;&lt;0)	</span><span class="cm">/* MIDI Transmit Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_MIDCMD		0x0494	</span><span class="cm">/* MIDI Command (wo) */</span><span class="cp"></span>

<span class="cp">#define BA0_MIDSR		0x0494	</span><span class="cm">/* MIDI Status (ro) */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDSR_RDA		(1&lt;&lt;15)	</span><span class="cm">/* Sticky bit (RBE 1-&gt;0) */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDSR_TBE		(1&lt;&lt;14) </span><span class="cm">/* Sticky bit (TBF 0-&gt;1) */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDSR_RBE		(1&lt;&lt;7)	</span><span class="cm">/* Receive Buffer Empty */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDSR_TBF		(1&lt;&lt;6)	</span><span class="cm">/* Transmit Buffer Full */</span><span class="cp"></span>

<span class="cp">#define BA0_MIDWP		0x0498	</span><span class="cm">/* MIDI Write */</span><span class="cp"></span>
<span class="cp">#define BA0_MIDRP		0x049c	</span><span class="cm">/* MIDI Read (ro) */</span><span class="cp"></span>

<span class="cp">#define BA0_AODSD1		0x04a8	</span><span class="cm">/* AC&#39;97 On-Demand Slot Disable for primary link (ro) */</span><span class="cp"></span>
<span class="cp">#define BA0_AODSD1_NDS(x)	(1&lt;&lt;((x)-3))</span>

<span class="cp">#define BA0_AODSD2		0x04ac	</span><span class="cm">/* AC&#39;97 On-Demand Slot Disable for secondary link (ro) */</span><span class="cp"></span>
<span class="cp">#define BA0_AODSD2_NDS(x)	(1&lt;&lt;((x)-3))</span>

<span class="cp">#define BA0_CFGI		0x04b0	</span><span class="cm">/* Configure Interface (EEPROM interface) */</span><span class="cp"></span>
<span class="cp">#define BA0_SLT12M2		0x04dc	</span><span class="cm">/* Slot 12 Monitor Register 2 for secondary AC-link */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSTS2		0x04e4	</span><span class="cm">/* AC&#39;97 Status Register 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_ACISV2		0x04f4	</span><span class="cm">/* AC&#39;97 Input Slot Valid Register 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSAD2		0x04f8	</span><span class="cm">/* AC&#39;97 Status Address Register 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_ACSDA2		0x04fc	</span><span class="cm">/* AC&#39;97 Status Data Register 2 */</span><span class="cp"></span>
<span class="cp">#define BA0_FMSR		0x0730	</span><span class="cm">/* FM Synthesis Status (ro) */</span><span class="cp"></span>
<span class="cp">#define BA0_B0AP		0x0730	</span><span class="cm">/* FM Bank 0 Address Port (wo) */</span><span class="cp"></span>
<span class="cp">#define BA0_FMDP		0x0734	</span><span class="cm">/* FM Data Port */</span><span class="cp"></span>
<span class="cp">#define BA0_B1AP		0x0738	</span><span class="cm">/* FM Bank 1 Address Port */</span><span class="cp"></span>
<span class="cp">#define BA0_B1DP		0x073c	</span><span class="cm">/* FM Bank 1 Data Port */</span><span class="cp"></span>

<span class="cp">#define BA0_SSPM		0x0740	</span><span class="cm">/* Sound System Power Management */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_MIXEN		(1&lt;&lt;6)	</span><span class="cm">/* Playback SRC + FM/Wavetable MIX */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_CSRCEN		(1&lt;&lt;5)	</span><span class="cm">/* Capture Sample Rate Converter Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_PSRCEN		(1&lt;&lt;4)	</span><span class="cm">/* Playback Sample Rate Converter Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_JSEN		(1&lt;&lt;3)	</span><span class="cm">/* Joystick Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_ACLEN		(1&lt;&lt;2)	</span><span class="cm">/* Serial Port Engine and AC-Link Enable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSPM_FMEN		(1&lt;&lt;1)	</span><span class="cm">/* FM Synthesis Block Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_DACSR		0x0744	</span><span class="cm">/* DAC Sample Rate - Playback SRC */</span><span class="cp"></span>
<span class="cp">#define BA0_ADCSR		0x0748	</span><span class="cm">/* ADC Sample Rate - Capture SRC */</span><span class="cp"></span>

<span class="cp">#define BA0_SSCR		0x074c	</span><span class="cm">/* Sound System Control Register */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_HVS1		(1&lt;&lt;23)	</span><span class="cm">/* Hardwave Volume Step (0=1,1=2) */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_MVCS		(1&lt;&lt;19)	</span><span class="cm">/* Master Volume Codec Select */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_MVLD		(1&lt;&lt;18)	</span><span class="cm">/* Master Volume Line Out Disable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_MVAD		(1&lt;&lt;17)	</span><span class="cm">/* Master Volume Alternate Out Disable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_MVMD		(1&lt;&lt;16)	</span><span class="cm">/* Master Volume Mono Out Disable */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_XLPSRC		(1&lt;&lt;8)	</span><span class="cm">/* External SRC Loopback Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_LPSRC		(1&lt;&lt;7)	</span><span class="cm">/* SRC Loopback Mode */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_CDTX		(1&lt;&lt;5)	</span><span class="cm">/* CD Transfer Data */</span><span class="cp"></span>
<span class="cp">#define BA0_SSCR_HVC		(1&lt;&lt;3)	</span><span class="cm">/* Harware Volume Control Enable */</span><span class="cp"></span>

<span class="cp">#define BA0_FMLVC		0x0754	</span><span class="cm">/* FM Synthesis Left Volume Control */</span><span class="cp"></span>
<span class="cp">#define BA0_FMRVC		0x0758	</span><span class="cm">/* FM Synthesis Right Volume Control */</span><span class="cp"></span>
<span class="cp">#define BA0_SRCSA		0x075c	</span><span class="cm">/* SRC Slot Assignments */</span><span class="cp"></span>
<span class="cp">#define BA0_PPLVC		0x0760	</span><span class="cm">/* PCM Playback Left Volume Control */</span><span class="cp"></span>
<span class="cp">#define BA0_PPRVC		0x0764	</span><span class="cm">/* PCM Playback Right Volume Control */</span><span class="cp"></span>
<span class="cp">#define BA0_PASR		0x0768	</span><span class="cm">/* playback sample rate */</span><span class="cp"></span>
<span class="cp">#define BA0_CASR		0x076C	</span><span class="cm">/* capture sample rate */</span><span class="cp"></span>

<span class="cm">/* Source Slot Numbers - Playback */</span>
<span class="cp">#define SRCSLOT_LEFT_PCM_PLAYBACK		0</span>
<span class="cp">#define SRCSLOT_RIGHT_PCM_PLAYBACK		1</span>
<span class="cp">#define SRCSLOT_PHONE_LINE_1_DAC		2</span>
<span class="cp">#define SRCSLOT_CENTER_PCM_PLAYBACK		3</span>
<span class="cp">#define SRCSLOT_LEFT_SURROUND_PCM_PLAYBACK	4</span>
<span class="cp">#define SRCSLOT_RIGHT_SURROUND_PCM_PLAYBACK	5</span>
<span class="cp">#define SRCSLOT_LFE_PCM_PLAYBACK		6</span>
<span class="cp">#define SRCSLOT_PHONE_LINE_2_DAC		7</span>
<span class="cp">#define SRCSLOT_HEADSET_DAC			8</span>
<span class="cp">#define SRCSLOT_LEFT_WT				29  </span><span class="cm">/* invalid for BA0_SRCSA */</span><span class="cp"></span>
<span class="cp">#define SRCSLOT_RIGHT_WT			30  </span><span class="cm">/* invalid for BA0_SRCSA */</span><span class="cp"></span>

<span class="cm">/* Source Slot Numbers - Capture */</span>
<span class="cp">#define SRCSLOT_LEFT_PCM_RECORD			10</span>
<span class="cp">#define SRCSLOT_RIGHT_PCM_RECORD		11</span>
<span class="cp">#define SRCSLOT_PHONE_LINE_1_ADC		12</span>
<span class="cp">#define SRCSLOT_MIC_ADC				13</span>
<span class="cp">#define SRCSLOT_PHONE_LINE_2_ADC		17</span>
<span class="cp">#define SRCSLOT_HEADSET_ADC			18</span>
<span class="cp">#define SRCSLOT_SECONDARY_LEFT_PCM_RECORD	20</span>
<span class="cp">#define SRCSLOT_SECONDARY_RIGHT_PCM_RECORD	21</span>
<span class="cp">#define SRCSLOT_SECONDARY_PHONE_LINE_1_ADC	22</span>
<span class="cp">#define SRCSLOT_SECONDARY_MIC_ADC		23</span>
<span class="cp">#define SRCSLOT_SECONDARY_PHONE_LINE_2_ADC	27</span>
<span class="cp">#define SRCSLOT_SECONDARY_HEADSET_ADC		28</span>

<span class="cm">/* Source Slot Numbers - Others */</span>
<span class="cp">#define SRCSLOT_POWER_DOWN			31</span>

<span class="cm">/* MIDI modes */</span>
<span class="cp">#define CS4281_MODE_OUTPUT		(1&lt;&lt;0)</span>
<span class="cp">#define CS4281_MODE_INPUT		(1&lt;&lt;1)</span>

<span class="cm">/* joystick bits */</span>
<span class="cm">/* Bits for JSPT */</span>
<span class="cp">#define JSPT_CAX                                0x00000001</span>
<span class="cp">#define JSPT_CAY                                0x00000002</span>
<span class="cp">#define JSPT_CBX                                0x00000004</span>
<span class="cp">#define JSPT_CBY                                0x00000008</span>
<span class="cp">#define JSPT_BA1                                0x00000010</span>
<span class="cp">#define JSPT_BA2                                0x00000020</span>
<span class="cp">#define JSPT_BB1                                0x00000040</span>
<span class="cp">#define JSPT_BB2                                0x00000080</span>

<span class="cm">/* Bits for JSCTL */</span>
<span class="cp">#define JSCTL_SP_MASK                           0x00000003</span>
<span class="cp">#define JSCTL_SP_SLOW                           0x00000000</span>
<span class="cp">#define JSCTL_SP_MEDIUM_SLOW                    0x00000001</span>
<span class="cp">#define JSCTL_SP_MEDIUM_FAST                    0x00000002</span>
<span class="cp">#define JSCTL_SP_FAST                           0x00000003</span>
<span class="cp">#define JSCTL_ARE                               0x00000004</span>

<span class="cm">/* Data register pairs masks */</span>
<span class="cp">#define JSC1_Y1V_MASK                           0x0000FFFF</span>
<span class="cp">#define JSC1_X1V_MASK                           0xFFFF0000</span>
<span class="cp">#define JSC1_Y1V_SHIFT                          0</span>
<span class="cp">#define JSC1_X1V_SHIFT                          16</span>
<span class="cp">#define JSC2_Y2V_MASK                           0x0000FFFF</span>
<span class="cp">#define JSC2_X2V_MASK                           0xFFFF0000</span>
<span class="cp">#define JSC2_Y2V_SHIFT                          0</span>
<span class="cp">#define JSC2_X2V_SHIFT                          16</span>

<span class="cm">/* JS GPIO */</span>
<span class="cp">#define JSIO_DAX                                0x00000001</span>
<span class="cp">#define JSIO_DAY                                0x00000002</span>
<span class="cp">#define JSIO_DBX                                0x00000004</span>
<span class="cp">#define JSIO_DBY                                0x00000008</span>
<span class="cp">#define JSIO_AXOE                               0x00000010</span>
<span class="cp">#define JSIO_AYOE                               0x00000020</span>
<span class="cp">#define JSIO_BXOE                               0x00000040</span>
<span class="cp">#define JSIO_BYOE                               0x00000080</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDBA</span><span class="p">;</span>		<span class="cm">/* offset to DBA register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDCA</span><span class="p">;</span>		<span class="cm">/* offset to DCA register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDBC</span><span class="p">;</span>		<span class="cm">/* offset to DBC register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDCC</span><span class="p">;</span>		<span class="cm">/* offset to DCC register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDMR</span><span class="p">;</span>		<span class="cm">/* offset to DMR register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regDCR</span><span class="p">;</span>		<span class="cm">/* offset to DCR register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regHDSR</span><span class="p">;</span>		<span class="cm">/* offset to HDSR register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regFCR</span><span class="p">;</span>		<span class="cm">/* offset to FCR register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regFSIC</span><span class="p">;</span>		<span class="cm">/* offset to FSIC register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valDMR</span><span class="p">;</span>		<span class="cm">/* DMA mode */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valDCR</span><span class="p">;</span>		<span class="cm">/* DMA command */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valFCR</span><span class="p">;</span>		<span class="cm">/* FIFO control */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fifo_offset</span><span class="p">;</span>	<span class="cm">/* FIFO offset within BA1 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">left_slot</span><span class="p">;</span>	<span class="cm">/* FIFO left slot */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">right_slot</span><span class="p">;</span>	<span class="cm">/* FIFO right slot */</span>
	<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>			<span class="cm">/* period number */</span>
<span class="p">};</span>

<span class="cp">#define SUSPEND_REGISTERS	20</span>

<span class="k">struct</span> <span class="n">cs4281</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ba0</span><span class="p">;</span>		<span class="cm">/* virtual (accessible) address */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ba1</span><span class="p">;</span>		<span class="cm">/* virtual (accessible) address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ba0_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ba1_addr</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dual_codec</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97_secondary</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">midi_input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">midi_output</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="n">dma</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src_left_play_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src_right_play_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src_left_rec_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src_right_rec_slot</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spurious_dhtc_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spurious_dtc_irq</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">midcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uartm</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">u32</span> <span class="n">suspend_regs</span><span class="p">[</span><span class="n">SUSPEND_REGISTERS</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_cs4281_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_cs4281_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CIRRUS</span><span class="p">,</span> <span class="mh">0x6005</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* CS4281 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_cs4281_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  constants</span>
<span class="cm"> */</span>

<span class="cp">#define CS4281_FIFO_SIZE	32</span>

<span class="cm">/*</span>
<span class="cm"> *  common I/O routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_cs4281_peekBA0</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  1. Write ACCAD = Command Address Register = 46Ch for AC97 register address</span>
<span class="cm">	 *  2. Write ACCDA = Command Data Register = 470h    for data to write to AC97</span>
<span class="cm">	 *  3. Write ACCTL = Control Register = 460h for initiating the write</span>
<span class="cm">	 *  4. Read ACCTL = 460h, DCV should be reset by now and 460h = 07h</span>
<span class="cm">	 *  5. if DCV not cleared, break and return error</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Setup the AC97 control registers on the CS461x to send the</span>
<span class="cm">	 *  appropriate command to the AC97 to perform the read.</span>
<span class="cm">	 *  ACCAD = Command Address Register = 46Ch</span>
<span class="cm">	 *  ACCDA = Command Data Register = 470h</span>
<span class="cm">	 *  ACCTL = Control Register = 460h</span>
<span class="cm">	 *  set DCV - will clear when process completed</span>
<span class="cm">	 *  reset CRW - Write command</span>
<span class="cm">	 *  set VFRM - valid frame enabled</span>
<span class="cm">	 *  set ESYN - ASYNC generation enabled</span>
<span class="cm">	 *  set RSTN - ARST# inactive, AC97 codec not reset</span>
<span class="cm">         */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCAD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCDA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">BA0_ACCTL_DCV</span> <span class="o">|</span> <span class="n">BA0_ACCTL_VFRM</span> <span class="o">|</span>
				            <span class="n">BA0_ACCTL_ESYN</span> <span class="o">|</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">?</span> <span class="n">BA0_ACCTL_TC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  First, we want to wait for a short time.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Now, check to see if the write has completed.</span>
<span class="cm">		 *  ACCTL = 460h, DCV should be reset by now and 460h = 07h</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_ACCTL_DCV</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 write problem, reg = 0x%x, val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_cs4281_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">result</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME: volatile is necessary in the following due to a bug of
some gcc versions</p></td><td class="code"><div class="highlight"><pre>	<span class="k">volatile</span> <span class="kt">int</span> <span class="n">ac97_num</span> <span class="o">=</span> <span class="p">((</span><span class="k">volatile</span> <span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="p">)</span><span class="n">ac97</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  1. Write ACCAD = Command Address Register = 46Ch for AC97 register address</span>
<span class="cm">	 *  2. Write ACCDA = Command Data Register = 470h    for data to write to AC97 </span>
<span class="cm">	 *  3. Write ACCTL = Control Register = 460h for initiating the write</span>
<span class="cm">	 *  4. Read ACCTL = 460h, DCV should be reset by now and 460h = 17h</span>
<span class="cm">	 *  5. if DCV not cleared, break and return error</span>
<span class="cm">	 *  6. Read ACSTS = Status Register = 464h, check VSTS bit</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_num</span> <span class="o">?</span> <span class="n">BA0_ACSDA2</span> <span class="o">:</span> <span class="n">BA0_ACSDA</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Setup the AC97 control registers on the CS461x to send the</span>
<span class="cm">	 *  appropriate command to the AC97 to perform the read.</span>
<span class="cm">	 *  ACCAD = Command Address Register = 46Ch</span>
<span class="cm">	 *  ACCDA = Command Data Register = 470h</span>
<span class="cm">	 *  ACCTL = Control Register = 460h</span>
<span class="cm">	 *  set DCV - will clear when process completed</span>
<span class="cm">	 *  set CRW - Read command</span>
<span class="cm">	 *  set VFRM - valid frame enabled</span>
<span class="cm">	 *  set ESYN - ASYNC generation enabled</span>
<span class="cm">	 *  set RSTN - ARST# inactive, AC97 codec not reset</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCAD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCDA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">BA0_ACCTL_DCV</span> <span class="o">|</span> <span class="n">BA0_ACCTL_CRW</span> <span class="o">|</span>
					    <span class="n">BA0_ACCTL_VFRM</span> <span class="o">|</span> <span class="n">BA0_ACCTL_ESYN</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">ac97_num</span> <span class="o">?</span> <span class="n">BA0_ACCTL_TC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Wait for the read to occur.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  First, we want to wait for a short time.</span>
<span class="cm">	 	 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Now, check to see if the read has completed.</span>
<span class="cm">		 *  ACCTL = 460h, DCV should be reset by now and 460h = 17h</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_ACCTL_DCV</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">__ok1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 read problem (ACCTL_DCV), reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	
      <span class="nl">__ok1:</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Wait for the valid status bit to go active.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the AC97 status register.</span>
<span class="cm">		 *  ACSTS = Status Register = 464h</span>
<span class="cm">		 *  VSTS - Valid Status</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_num</span> <span class="o">?</span> <span class="n">BA0_ACSTS2</span> <span class="o">:</span> <span class="n">BA0_ACSTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_ACSTS_VSTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__ok2</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 read problem (ACSTS_VSTS), reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

      <span class="nl">__ok2:</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Read the data returned from the AC97 register.</span>
<span class="cm">	 *  ACSDA = Status Data Register = 474h</span>
<span class="cm">	 */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_num</span> <span class="o">?</span> <span class="n">BA0_ACSDA2</span> <span class="o">:</span> <span class="n">BA0_ACSDA</span><span class="p">);</span>

      <span class="nl">__end:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">|=</span> <span class="n">BA0_DCR_MSK</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">|=</span> <span class="n">BA0_FCR_FEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_DCR_MSK</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_FCR_FEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDMR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BA0_DMR_DMA</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_DMA</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_DCR_MSK</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">|=</span> <span class="n">BA0_FCR_FEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BA0_DMR_DMA</span><span class="o">|</span><span class="n">BA0_DMR_POLL</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">|=</span> <span class="n">BA0_DCR_MSK</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_FCR_FEN</span><span class="p">;</span>
		<span class="cm">/* Leave wave playback FIFO enabled for FM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span> <span class="o">!=</span> <span class="n">BA0_FCR0</span><span class="p">)</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_FCR_FEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDMR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDCR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_cs4281_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">real_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">real_rate</span><span class="p">)</span>
		<span class="o">*</span><span class="n">real_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="cm">/* special &quot;hardcoded&quot; rates */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>:	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>:	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>:	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">__variable</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">__variable:</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">1536000</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">real_rate</span><span class="p">)</span>
		<span class="o">*</span><span class="n">real_rate</span> <span class="o">=</span> <span class="mi">1536000</span> <span class="o">/</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rec_mono</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">=</span> <span class="n">BA0_DMR_TYPE_SINGLE</span> <span class="o">|</span> <span class="n">BA0_DMR_AUTO</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">capture</span> <span class="o">?</span> <span class="n">BA0_DMR_TR_WRITE</span> <span class="o">:</span> <span class="n">BA0_DMR_TR_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_USIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_big_endian</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_BEND</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_SIZE8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_SWAPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>: <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">|=</span> <span class="n">BA0_DMR_SIZE20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* for workaround */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">=</span> <span class="n">BA0_DCR_TCIE</span> <span class="o">|</span> <span class="n">BA0_DCR_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">!=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDCR</span> <span class="o">|=</span> <span class="n">BA0_DCR_HTCIE</span><span class="p">;</span>
	<span class="cm">/* Initialize DMA */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDBA</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDBC</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rec_mono</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">valDMR</span> <span class="o">&amp;</span> <span class="n">BA0_DMR_MONO</span><span class="p">)</span> <span class="o">==</span> <span class="n">BA0_DMR_MONO</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SRCSA</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_play_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_play_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_rec_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">((</span><span class="n">rec_mono</span> <span class="o">?</span> <span class="mi">31</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_rec_slot</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__skip_src</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">left_slot</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_play_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_cs4281_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">right_slot</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_play_slot</span><span class="p">);</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_DACSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">left_slot</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_rec_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_cs4281_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">right_slot</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_rec_slot</span><span class="p">);</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ADCSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
      <span class="nl">__skip_src:</span>
	<span class="cm">/* Deactivate wave playback FIFO before changing slot assignments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span> <span class="o">==</span> <span class="n">BA0_FCR0</span><span class="p">)</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">,</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BA0_FCR_FEN</span><span class="p">);</span>
	<span class="cm">/* Initialize FIFO */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">=</span> <span class="n">BA0_FCR_LS</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">left_slot</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">BA0_FCR_RS</span><span class="p">(</span><span class="n">capture</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">valDMR</span> <span class="o">&amp;</span> <span class="n">BA0_DMR_MONO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">31</span> <span class="o">:</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">right_slot</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">BA0_FCR_SZ</span><span class="p">(</span><span class="n">CS4281_FIFO_SIZE</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">BA0_FCR_OF</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_offset</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">|</span> <span class="p">(</span><span class="n">capture</span> <span class="o">?</span> <span class="n">BA0_FCR_PSH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/* Activate FIFO again for FM playback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span> <span class="o">==</span> <span class="n">BA0_FCR0</span><span class="p">)</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">valFCR</span> <span class="o">|</span> <span class="n">BA0_FCR_FEN</span><span class="p">);</span>
	<span class="cm">/* Clear FIFO Status and Interrupt Control Register */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFSIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_cs4281_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_cs4281_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs4281_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;DCC = 0x%x, buffer_size = 0x%x, jiffies = %li\n&quot;,</span>
<span class="cm">	       snd_cs4281_peekBA0(chip, dma-&gt;regDCC), runtime-&gt;buffer_size,</span>
<span class="cm">	       jiffies);</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span>
	       <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDCC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs4281_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U16_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U32_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S32_LE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U32_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="n">CS4281_FIFO_SIZE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs4281_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U16_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U32_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S32_LE</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_FMTBIT_U32_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="n">CS4281_FIFO_SIZE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">left_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">right_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs4281_playback</span><span class="p">;</span>
	<span class="cm">/* should be detected from the AC&#39;97 layer, but it seems</span>
<span class="cm">	   that although CS4297A rev B reports 18-bit ADC resolution,</span>
<span class="cm">	   samples are 20-bit */</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">left_slot</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">right_slot</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs4281_capture</span><span class="p">;</span>
	<span class="cm">/* should be detected from the AC&#39;97 layer, but it seems</span>
<span class="cm">	   that although CS4297A rev B reports 18-bit ADC resolution,</span>
<span class="cm">	   samples are 20-bit */</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs4281_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_cs4281_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs4281_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_cs4281_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_cs4281_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_cs4281_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs4281_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_cs4281_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs4281_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_cs4281_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs4281_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_cs4281_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_cs4281_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_cs4281_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs4281_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_cs4281_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4281_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4281_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer section</span>
<span class="cm"> */</span>

<span class="cp">#define CS_VOL_MASK	0x1f</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span>              <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span>             <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">regL</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regR</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volL</span><span class="p">,</span> <span class="n">volR</span><span class="p">;</span>

	<span class="n">volL</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>
	<span class="n">volR</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">volL</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">volR</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regL</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regR</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volL</span><span class="p">,</span> <span class="n">volR</span><span class="p">;</span>

	<span class="n">volL</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>
	<span class="n">volR</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">volL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volL</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regL</span><span class="p">,</span> <span class="n">volL</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">volR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volR</span> <span class="o">=</span> <span class="n">CS_VOL_MASK</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS_VOL_MASK</span><span class="p">);</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">regR</span><span class="p">,</span> <span class="n">volR</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_dsp</span><span class="p">,</span> <span class="o">-</span><span class="mi">4650</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cs4281_fm_vol</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Synth Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_cs4281_info_volume</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs4281_get_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs4281_put_volume</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">BA0_FMLVC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BA0_FMRVC</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_dsp</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cs4281_pcm_vol</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCM Stream Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_cs4281_info_volume</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_cs4281_get_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_cs4281_put_volume</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">BA0_PPLVC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BA0_PPRVC</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_dsp</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_cs4281_ac97_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs4281_ac97_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_cs4281_mixer_free_ac97_bus</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_cs4281_mixer_free_ac97</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cs4281_fm_vol</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cs4281_pcm_vol</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Cirrus Logic CS4281</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Spurious half IRQs   : %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spurious_dhtc_irq</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Spurious end IRQs    : %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spurious_dtc_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_cs4281_BA0_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">file_private_data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_cs4281_BA1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">file_private_data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry_ops</span> <span class="n">snd_cs4281_proc_ops_BA0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs4281_BA0_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry_ops</span> <span class="n">snd_cs4281_proc_ops_BA1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs4281_BA1_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;cs4281&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_cs4281_proc_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;cs4281_BA0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_DATA</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs4281_proc_ops_BA0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS4281_BA0_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;cs4281_BA1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_DATA</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_cs4281_proc_ops_BA1</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CS4281_BA1_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * joystick support</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_gameport_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_cs4281_gameport_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef COOKED_MODE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_gameport_cooked_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="o">*</span><span class="n">axes</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buttons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">js1</span><span class="p">,</span> <span class="n">js2</span><span class="p">,</span> <span class="n">jst</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">js1</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSC1</span><span class="p">);</span>
	<span class="n">js2</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSC2</span><span class="p">);</span>
	<span class="n">jst</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSPT</span><span class="p">);</span>
	
	<span class="o">*</span><span class="n">buttons</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">jst</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span> 
	
	<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js1</span> <span class="o">&amp;</span> <span class="n">JSC1_Y1V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC1_Y1V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js1</span> <span class="o">&amp;</span> <span class="n">JSC1_X1V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC1_X1V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js2</span> <span class="o">&amp;</span> <span class="n">JSC2_Y2V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC2_Y2V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">js2</span> <span class="o">&amp;</span> <span class="n">JSC2_X2V_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">JSC2_X2V_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">jst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jst</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">jst</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">jst</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="n">axes</span><span class="p">[</span><span class="n">jst</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define snd_cs4281_gameport_cooked_read	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_gameport_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef COOKED_MODE</span>
	<span class="k">case</span> <span class="n">GAMEPORT_MODE_COOKED</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">GAMEPORT_MODE_RAW</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4281: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;CS4281 Gameport&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_cs4281_gameport_open</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_cs4281_gameport_read</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_cs4281_gameport_trigger</span><span class="p">;</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">cooked_read</span> <span class="o">=</span> <span class="n">snd_cs4281_gameport_cooked_read</span><span class="p">;</span>
	<span class="n">gameport_set_port_data</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSIO</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="c1">// ?</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_JSCTL</span><span class="p">,</span> <span class="n">JSCTL_SP_MEDIUM_SLOW</span><span class="p">);</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_cs4281_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_cs4281_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_GAMEPORT || (MODULE &amp;&amp; CONFIG_GAMEPORT_MODULE) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs4281_free_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Mask interrupts */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HIMR</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>
	<span class="cm">/* Stop the DLL Clock logic. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Sound System Power Management - Turn Everything OFF */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SSPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* PCI interface - D3 state */</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_cs4281_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_cs4281_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span> <span class="cm">/* defined below */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cs4281</span> <span class="o">**</span> <span class="n">rchip</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">dual_codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_cs4281_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dual_codec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dual_codec</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid dual_codec option %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dual_codec</span><span class="p">);</span>
		<span class="n">dual_codec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span> <span class="o">=</span> <span class="n">dual_codec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4281_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_cs4281_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_cs4281_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4281_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4281_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_cs4281_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Having EPPMC.FPDN=1 prevent proper chip initialisation */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EPPMC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BA0_EPPMC_FPDN</span><span class="p">)</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_EPPMC</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BA0_EPPMC_FPDN</span><span class="p">);</span>

      <span class="nl">__retry:</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CFLR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">BA0_CFLR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CFLR</span><span class="p">,</span> <span class="n">BA0_CFLR_DEFAULT</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CFLR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">BA0_CFLR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CFLR setup failed (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set the &#39;Configuration Write Protect&#39; register</span>
<span class="cm">	 * to 4281h.  Allows vendor-defined configuration</span>
<span class="cm">         * space between 0e4h and 0ffh to be written. */</span>	
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CWPR</span><span class="p">,</span> <span class="mh">0x4281</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BA0_SERC1_SO1EN</span> <span class="o">|</span> <span class="n">BA0_SERC1_AC97</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SERC1 AC&#39;97 check failed (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERC2</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BA0_SERC2_SI1EN</span> <span class="o">|</span> <span class="n">BA0_SERC2_AC97</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SERC2 AC&#39;97 check failed (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sound System Power Management */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SSPM</span><span class="p">,</span> <span class="n">BA0_SSPM_MIXEN</span> <span class="o">|</span> <span class="n">BA0_SSPM_CSRCEN</span> <span class="o">|</span>
				           <span class="n">BA0_SSPM_PSRCEN</span> <span class="o">|</span> <span class="n">BA0_SSPM_JSEN</span> <span class="o">|</span>
				           <span class="n">BA0_SSPM_ACLEN</span> <span class="o">|</span> <span class="n">BA0_SSPM_FMEN</span><span class="p">);</span>

	<span class="cm">/* Serial Port Power Management */</span>
 	<span class="cm">/* Blast the clock control register to zero so that the</span>
<span class="cm">         * PLL starts out in a known state, and blast the master serial</span>
<span class="cm">         * port control register to zero so that the serial ports also</span>
<span class="cm">         * start out in a known state. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="cm">/* Make ESYN go to zero to turn off</span>
<span class="cm">         * the Sync pulse on the AC97 link. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                
	<span class="cm">/*  Drive the ARST# pin low for a minimum of 1uS (as defined in the AC97</span>
<span class="cm">	 *  spec) and then drive it high.  This is done for non AC97 modes since</span>
<span class="cm">	 *  there might be logic external to the CS4281 that uses the ARST# line</span>
<span class="cm">	 *  for a reset. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SPMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SPMC</span><span class="p">,</span> <span class="n">BA0_SPMC_RSTN</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span><span class="p">)</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SPMC</span><span class="p">,</span> <span class="n">BA0_SPMC_RSTN</span> <span class="o">|</span> <span class="n">BA0_SPMC_ASDI2E</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set the serial port timing configuration.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span> <span class="o">?</span> <span class="n">BA0_SERMC_TCID</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span><span class="p">)</span> <span class="o">:</span> <span class="n">BA0_SERMC_TCID</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
			   <span class="n">BA0_SERMC_PTC_AC97</span> <span class="o">|</span> <span class="n">BA0_SERMC_MSPE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Start the DLL Clock logic.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">BA0_CLKCR1_DLLP</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">BA0_CLKCR1_SWCE</span> <span class="o">|</span> <span class="n">BA0_CLKCR1_DLLP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the DLL ready signal from the clock logic.</span>
<span class="cm">	 */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the AC97 status register to see if we&#39;ve seen a CODEC</span>
<span class="cm">		 *  signal from the AC97 codec.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_CLKCR1_DLLRDY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__ok0</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DLLRDY not seen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

      <span class="nl">__ok0:</span>

	<span class="cm">/*</span>
<span class="cm">	 *  The first thing we do here is to enable sync generation.  As soon</span>
<span class="cm">	 *  as we start receiving bit clock, we&#39;ll start producing the SYNC</span>
<span class="cm">	 *  signal.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">BA0_ACCTL_ESYN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the codec ready signal from the AC97 codec.</span>
<span class="cm">	 */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the AC97 status register to see if we&#39;ve seen a CODEC</span>
<span class="cm">		 *  signal from the AC97 codec.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_ACSTS_CRDY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__ok1</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;never read codec ready from AC&#39;97 (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

      <span class="nl">__ok1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACSTS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_ACSTS_CRDY</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__codec2_ok</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;secondary codec doesn&#39;t respond. disable it...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dual_codec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">__codec2_ok:</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Assert the valid frame signal so that we can start sending commands</span>
<span class="cm">	 *  to the AC97 codec.</span>
<span class="cm">	 */</span>

	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACCTL</span><span class="p">,</span> <span class="n">BA0_ACCTL_VFRM</span> <span class="o">|</span> <span class="n">BA0_ACCTL_ESYN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Wait until we&#39;ve sampled input slots 3 and 4 as valid, meaning that</span>
<span class="cm">	 *  the codec is pumping ADC data across the AC-link.</span>
<span class="cm">	 */</span>

	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Read the input slot valid register and see if input slots 3</span>
<span class="cm">		 *  4 are valid yet.</span>
<span class="cm">		 */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACISV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BA0_ACISV_SLV</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BA0_ACISV_SLV</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span> <span class="o">==</span> <span class="p">(</span><span class="n">BA0_ACISV_SLV</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BA0_ACISV_SLV</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
                        <span class="k">goto</span> <span class="n">__ok2</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__retry</span><span class="p">;</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;never read ISV3 and ISV4 from AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

      <span class="nl">__ok2:</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Now, assert valid frame and the slot 3 and 4 valid bits.  This will</span>
<span class="cm">	 *  commense the transfer of digital audio data to the AC97 codec.</span>
<span class="cm">	 */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_ACOSV</span><span class="p">,</span> <span class="n">BA0_ACOSV_SLV</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BA0_ACOSV_SLV</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Initialize DMA structures</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDBA</span> <span class="o">=</span> <span class="n">BA0_DBA0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDCA</span> <span class="o">=</span> <span class="n">BA0_DCA0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDBC</span> <span class="o">=</span> <span class="n">BA0_DBC0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDCC</span> <span class="o">=</span> <span class="n">BA0_DCC0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDMR</span> <span class="o">=</span> <span class="n">BA0_DMR0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regDCR</span> <span class="o">=</span> <span class="n">BA0_DCR0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regHDSR</span> <span class="o">=</span> <span class="n">BA0_HDSR0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span> <span class="o">=</span> <span class="n">BA0_FCR0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFSIC</span> <span class="o">=</span> <span class="n">BA0_FSIC0</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_offset</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">CS4281_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">regFCR</span><span class="p">,</span>
				   <span class="n">BA0_FCR_LS</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">BA0_FCR_RS</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">BA0_FCR_SZ</span><span class="p">(</span><span class="n">CS4281_FIFO_SIZE</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">BA0_FCR_OF</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_offset</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_play_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* AC&#39;97 left PCM playback (3) */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_play_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* AC&#39;97 right PCM playback (4) */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_rec_slot</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* AC&#39;97 left PCM record (3) */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_rec_slot</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>	<span class="cm">/* AC&#39;97 right PCM record (4) */</span>

	<span class="cm">/* Activate wave playback FIFO for FM playback */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">valFCR</span> <span class="o">=</span> <span class="n">BA0_FCR_FEN</span> <span class="o">|</span> <span class="n">BA0_FCR_LS</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		              <span class="n">BA0_FCR_RS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
 	  	              <span class="n">BA0_FCR_SZ</span><span class="p">(</span><span class="n">CS4281_FIFO_SIZE</span><span class="p">)</span> <span class="o">|</span>
		              <span class="n">BA0_FCR_OF</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fifo_offset</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regFCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">valFCR</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SRCSA</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_play_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_play_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_left_rec_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src_right_rec_slot</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

	<span class="cm">/* Initialize digital volume */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_PPLVC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_PPRVC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable IRQs */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">BA0_HICR_EOI</span><span class="p">);</span>
	<span class="cm">/* Unmask interrupts */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HIMR</span><span class="p">,</span> <span class="mh">0x7fffffff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span>
					<span class="n">BA0_HISR_MIDI</span> <span class="o">|</span>
					<span class="n">BA0_HISR_DMAI</span> <span class="o">|</span>
					<span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">3</span><span class="p">)));</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  MIDI section</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_midi_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|</span> <span class="n">BA0_MIDCR_MRST</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
 	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">BA0_MIDCR_RXE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS4281_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4281_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BA0_MIDCR_RXE</span> <span class="o">|</span> <span class="n">BA0_MIDCR_RIE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS4281_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4281_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS4281_MODE_INPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">|=</span> <span class="n">CS4281_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">BA0_MIDCR_TXE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS4281_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4281_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4281_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BA0_MIDCR_TXE</span> <span class="o">|</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">CS4281_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4281_midi_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS4281_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_RIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">BA0_MIDCR_RIE</span><span class="p">;</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_RIE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_MIDCR_RIE</span><span class="p">;</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">|=</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">;</span>
			<span class="cm">/* fill UART FIFO buffer at first, and turn Tx interrupts only if necessary */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_MIDSR_TBF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_MIDCR_TIE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDWP</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_MIDCR_TIE</span><span class="p">;</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_cs4281_midi_output</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_cs4281_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs4281_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs4281_midi_output_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_cs4281_midi_input</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> 	<span class="n">snd_cs4281_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_cs4281_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_cs4281_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_midi</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">**</span><span class="n">rrawmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmidi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4281_midi_output</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4281_midi_input</span><span class="p">);</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span> <span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span> <span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span> <span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_cs4281_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281_dma</span> <span class="o">*</span><span class="n">cdma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">BA0_HICR_EOI</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">|</span><span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">dma</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BA0_HISR_DMA</span><span class="p">(</span><span class="n">dma</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cdma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">dma</span><span class="p">];</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
				<span class="cm">/* ack DMA IRQ */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cdma</span><span class="o">-&gt;</span><span class="n">regHDSR</span><span class="p">);</span>
				<span class="cm">/* workaround, sometimes CS4281 acknowledges */</span>
				<span class="cm">/* end or middle transfer position twice */</span>
				<span class="n">cdma</span><span class="o">-&gt;</span><span class="n">frag</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BA0_HDSR_DHTC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cdma</span><span class="o">-&gt;</span><span class="n">frag</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cdma</span><span class="o">-&gt;</span><span class="n">frag</span><span class="o">--</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spurious_dhtc_irq</span><span class="o">++</span><span class="p">;</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BA0_HDSR_DTC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cdma</span><span class="o">-&gt;</span><span class="n">frag</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cdma</span><span class="o">-&gt;</span><span class="n">frag</span><span class="o">--</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spurious_dtc_irq</span><span class="o">++</span><span class="p">;</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
				<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">cdma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BA0_HISR_MIDI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_MIDSR_RBE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDRP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_RIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">snd_rawmidi_receive</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BA0_MIDSR_TBF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;</span> <span class="n">BA0_MIDCR_TIE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">midi_output</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BA0_MIDCR_TIE</span><span class="p">;</span>
				<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDCR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">midcr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_MIDWP</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* EOI to the PCI part... reenables interrupts */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">BA0_HICR_EOI</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * OPL3 command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4281_opl3_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">OPL3_RIGHT</span><span class="p">)</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">+</span> <span class="n">BA0_B1AP</span><span class="p">;</span> <span class="cm">/* right port */</span>
	<span class="k">else</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0</span> <span class="o">+</span> <span class="n">BA0_B0AP</span><span class="p">;</span> <span class="cm">/* left port */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4281_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4281_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">,</span> <span class="n">dual_codec</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4281_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4281_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4281_midi</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">OPL3_HW_OPL3_CS4281</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opl3</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">snd_cs4281_opl3_command</span><span class="p">;</span>
	<span class="n">snd_opl3_init</span><span class="p">(</span><span class="n">opl3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_hwdep_new</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cs4281_create_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;CS4281&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Cirrus Logic CS4281&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ba0_addr</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_cs4281_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Power Management</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">SUSPEND_REGISTERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BA0_JSCTL</span><span class="p">,</span>
	<span class="n">BA0_GPIOR</span><span class="p">,</span>
	<span class="n">BA0_SSCR</span><span class="p">,</span>
	<span class="n">BA0_MIDCR</span><span class="p">,</span>
	<span class="n">BA0_SRCSA</span><span class="p">,</span>
	<span class="n">BA0_PASR</span><span class="p">,</span>
	<span class="n">BA0_CASR</span><span class="p">,</span>
	<span class="n">BA0_DACSR</span><span class="p">,</span>
	<span class="n">BA0_ADCSR</span><span class="p">,</span>
	<span class="n">BA0_FMLVC</span><span class="p">,</span>
	<span class="n">BA0_FMRVC</span><span class="p">,</span>
	<span class="n">BA0_PPLVC</span><span class="p">,</span>
	<span class="n">BA0_PPRVC</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define CLKCR1_CKRA                             0x00010000L</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4281_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulCLK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>

	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">);</span>

	<span class="n">ulCLK</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>
	<span class="n">ulCLK</span> <span class="o">|=</span> <span class="n">CLKCR1_CKRA</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">ulCLK</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_HICR</span><span class="p">,</span> <span class="n">BA0_HICR_CHGM</span><span class="p">);</span>

	<span class="cm">/* remember the status registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">saved_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Turn off the serial ports. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SERMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Power off FM, Joystick, AC link, */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SSPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* DLL off. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* AC link off. */</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_SPMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ulCLK</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>
	<span class="n">ulCLK</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLKCR1_CKRA</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">ulCLK</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4281_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4281</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulCLK</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4281: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">ulCLK</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>
	<span class="n">ulCLK</span> <span class="o">|=</span> <span class="n">CLKCR1_CKRA</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">ulCLK</span><span class="p">);</span>

	<span class="n">snd_cs4281_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* restore the status registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">saved_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">);</span>

	<span class="n">ulCLK</span> <span class="o">=</span> <span class="n">snd_cs4281_peekBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">);</span>
	<span class="n">ulCLK</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLKCR1_CKRA</span><span class="p">;</span>
	<span class="n">snd_cs4281_pokeBA0</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BA0_CLKCR1</span><span class="p">,</span> <span class="n">ulCLK</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cs4281_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_cs4281_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_cs4281_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_cs4281_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">cs4281_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">cs4281_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
	
<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">cs4281_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
