<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › bt87x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bt87x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * bt87x.c - Brooktree Bt878/Bt879 driver for ALSA</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) Clemens Ladisch &lt;clemens@ladisch.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * based on btaudio.c by Gerd Knorr &lt;kraxel@bytesex.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Clemens Ladisch &lt;clemens@ladisch.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Brooktree Bt87x audio driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Brooktree,Bt878},&quot;</span>
		<span class="s">&quot;{Brooktree,Bt879}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">};</span> <span class="cm">/* Exclude the first card */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">digital_rate</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>	<span class="cm">/* digital input rate */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">load_all</span><span class="p">;</span>	<span class="cm">/* allow to load the non-whitelisted cards */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Bt87x soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Bt87x soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Bt87x soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">digital_rate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">digital_rate</span><span class="p">,</span> <span class="s">&quot;Digital input rate for Bt87x soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">load_all</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">load_all</span><span class="p">,</span> <span class="s">&quot;Allow to load the non-whitelisted cards&quot;</span><span class="p">);</span>


<span class="cm">/* register offsets */</span>
<span class="cp">#define REG_INT_STAT		0x100	</span><span class="cm">/* interrupt status */</span><span class="cp"></span>
<span class="cp">#define REG_INT_MASK		0x104	</span><span class="cm">/* interrupt mask */</span><span class="cp"></span>
<span class="cp">#define REG_GPIO_DMA_CTL	0x10c	</span><span class="cm">/* audio control */</span><span class="cp"></span>
<span class="cp">#define REG_PACKET_LEN		0x110	</span><span class="cm">/* audio packet lengths */</span><span class="cp"></span>
<span class="cp">#define REG_RISC_STRT_ADD	0x114	</span><span class="cm">/* RISC program start address */</span><span class="cp"></span>
<span class="cp">#define REG_RISC_COUNT		0x120	</span><span class="cm">/* RISC program counter */</span><span class="cp"></span>

<span class="cm">/* interrupt bits */</span>
<span class="cp">#define INT_OFLOW	(1 &lt;&lt;  3)	</span><span class="cm">/* audio A/D overflow */</span><span class="cp"></span>
<span class="cp">#define INT_RISCI	(1 &lt;&lt; 11)	</span><span class="cm">/* RISC instruction IRQ bit set */</span><span class="cp"></span>
<span class="cp">#define INT_FBUS	(1 &lt;&lt; 12)	</span><span class="cm">/* FIFO overrun due to bus access latency */</span><span class="cp"></span>
<span class="cp">#define INT_FTRGT	(1 &lt;&lt; 13)	</span><span class="cm">/* FIFO overrun due to target latency */</span><span class="cp"></span>
<span class="cp">#define INT_FDSR	(1 &lt;&lt; 14)	</span><span class="cm">/* FIFO data stream resynchronization */</span><span class="cp"></span>
<span class="cp">#define INT_PPERR	(1 &lt;&lt; 15)	</span><span class="cm">/* PCI parity error */</span><span class="cp"></span>
<span class="cp">#define INT_RIPERR	(1 &lt;&lt; 16)	</span><span class="cm">/* RISC instruction parity error */</span><span class="cp"></span>
<span class="cp">#define INT_PABORT	(1 &lt;&lt; 17)	</span><span class="cm">/* PCI master or target abort */</span><span class="cp"></span>
<span class="cp">#define INT_OCERR	(1 &lt;&lt; 18)	</span><span class="cm">/* invalid opcode */</span><span class="cp"></span>
<span class="cp">#define INT_SCERR	(1 &lt;&lt; 19)	</span><span class="cm">/* sync counter overflow */</span><span class="cp"></span>
<span class="cp">#define INT_RISC_EN	(1 &lt;&lt; 27)	</span><span class="cm">/* DMA controller running */</span><span class="cp"></span>
<span class="cp">#define INT_RISCS_SHIFT	      28	</span><span class="cm">/* RISC status bits */</span><span class="cp"></span>

<span class="cm">/* audio control bits */</span>
<span class="cp">#define CTL_FIFO_ENABLE		(1 &lt;&lt;  0)	</span><span class="cm">/* enable audio data FIFO */</span><span class="cp"></span>
<span class="cp">#define CTL_RISC_ENABLE		(1 &lt;&lt;  1)	</span><span class="cm">/* enable audio DMA controller */</span><span class="cp"></span>
<span class="cp">#define CTL_PKTP_4		(0 &lt;&lt;  2)	</span><span class="cm">/* packet mode FIFO trigger point - 4 DWORDs */</span><span class="cp"></span>
<span class="cp">#define CTL_PKTP_8		(1 &lt;&lt;  2)	</span><span class="cm">/* 8 DWORDs */</span><span class="cp"></span>
<span class="cp">#define CTL_PKTP_16		(2 &lt;&lt;  2)	</span><span class="cm">/* 16 DWORDs */</span><span class="cp"></span>
<span class="cp">#define CTL_ACAP_EN		(1 &lt;&lt;  4)	</span><span class="cm">/* enable audio capture */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_APP		(1 &lt;&lt;  5)	</span><span class="cm">/* GPIO input */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_IOM_AFE		(0 &lt;&lt;  6)	</span><span class="cm">/* audio A/D input */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_IOM_DA		(1 &lt;&lt;  6)	</span><span class="cm">/* digital audio input */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_SDR_SHIFT	       8	</span><span class="cm">/* DDF first stage decimation rate */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_SDR_MASK		(0xf&lt;&lt; 8)</span>
<span class="cp">#define CTL_DA_LMT		(1 &lt;&lt; 12)	</span><span class="cm">/* limit audio data values */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_ES2		(1 &lt;&lt; 13)	</span><span class="cm">/* enable DDF stage 2 */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_SBR		(1 &lt;&lt; 14)	</span><span class="cm">/* samples rounded to 8 bits */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_DPM		(1 &lt;&lt; 15)	</span><span class="cm">/* data packet mode */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_LRD_SHIFT	      16	</span><span class="cm">/* ALRCK delay */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_MLB		(1 &lt;&lt; 21)	</span><span class="cm">/* MSB/LSB format */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_LRI		(1 &lt;&lt; 22)	</span><span class="cm">/* left/right indication */</span><span class="cp"></span>
<span class="cp">#define CTL_DA_SCE		(1 &lt;&lt; 23)	</span><span class="cm">/* sample clock edge */</span><span class="cp"></span>
<span class="cp">#define CTL_A_SEL_STV		(0 &lt;&lt; 24)	</span><span class="cm">/* TV tuner audio input */</span><span class="cp"></span>
<span class="cp">#define CTL_A_SEL_SFM		(1 &lt;&lt; 24)	</span><span class="cm">/* FM audio input */</span><span class="cp"></span>
<span class="cp">#define CTL_A_SEL_SML		(2 &lt;&lt; 24)	</span><span class="cm">/* mic/line audio input */</span><span class="cp"></span>
<span class="cp">#define CTL_A_SEL_SMXC		(3 &lt;&lt; 24)	</span><span class="cm">/* MUX bypass */</span><span class="cp"></span>
<span class="cp">#define CTL_A_SEL_SHIFT		      24</span>
<span class="cp">#define CTL_A_SEL_MASK		(3 &lt;&lt; 24)</span>
<span class="cp">#define CTL_A_PWRDN		(1 &lt;&lt; 26)	</span><span class="cm">/* analog audio power-down */</span><span class="cp"></span>
<span class="cp">#define CTL_A_G2X		(1 &lt;&lt; 27)	</span><span class="cm">/* audio gain boost */</span><span class="cp"></span>
<span class="cp">#define CTL_A_GAIN_SHIFT	      28	</span><span class="cm">/* audio input gain */</span><span class="cp"></span>
<span class="cp">#define CTL_A_GAIN_MASK		(0xf&lt;&lt;28)</span>

<span class="cm">/* RISC instruction opcodes */</span>
<span class="cp">#define RISC_WRITE	(0x1 &lt;&lt; 28)	</span><span class="cm">/* write FIFO data to memory at address */</span><span class="cp"></span>
<span class="cp">#define RISC_WRITEC	(0x5 &lt;&lt; 28)	</span><span class="cm">/* write FIFO data to memory at current address */</span><span class="cp"></span>
<span class="cp">#define RISC_SKIP	(0x2 &lt;&lt; 28)	</span><span class="cm">/* skip FIFO data */</span><span class="cp"></span>
<span class="cp">#define RISC_JUMP	(0x7 &lt;&lt; 28)	</span><span class="cm">/* jump to address */</span><span class="cp"></span>
<span class="cp">#define RISC_SYNC	(0x8 &lt;&lt; 28)	</span><span class="cm">/* synchronize with FIFO */</span><span class="cp"></span>

<span class="cm">/* RISC instruction bits */</span>
<span class="cp">#define RISC_BYTES_ENABLE	(0xf &lt;&lt; 12)	</span><span class="cm">/* byte enable bits */</span><span class="cp"></span>
<span class="cp">#define RISC_RESYNC		(  1 &lt;&lt; 15)	</span><span class="cm">/* disable FDSR errors */</span><span class="cp"></span>
<span class="cp">#define RISC_SET_STATUS_SHIFT	        16	</span><span class="cm">/* set status bits */</span><span class="cp"></span>
<span class="cp">#define RISC_RESET_STATUS_SHIFT	        20	</span><span class="cm">/* clear status bits */</span><span class="cp"></span>
<span class="cp">#define RISC_IRQ		(  1 &lt;&lt; 24)	</span><span class="cm">/* interrupt */</span><span class="cp"></span>
<span class="cp">#define RISC_EOL		(  1 &lt;&lt; 26)	</span><span class="cm">/* end of line */</span><span class="cp"></span>
<span class="cp">#define RISC_SOL		(  1 &lt;&lt; 27)	</span><span class="cm">/* start of line */</span><span class="cp"></span>

<span class="cm">/* SYNC status bits values */</span>
<span class="cp">#define RISC_SYNC_FM1	0x6</span>
<span class="cp">#define RISC_SYNC_VRO	0xc</span>

<span class="cp">#define ANALOG_CLOCK 1792000</span>
<span class="cp">#ifdef CONFIG_SND_BT87X_OVERCLOCK</span>
<span class="cp">#define CLOCK_DIV_MIN 1</span>
<span class="cp">#else</span>
<span class="cp">#define CLOCK_DIV_MIN 4</span>
<span class="cp">#endif</span>
<span class="cp">#define CLOCK_DIV_MAX 15</span>

<span class="cp">#define ERROR_INTERRUPTS (INT_FBUS | INT_FTRGT | INT_PPERR | \</span>
<span class="cp">			  INT_RIPERR | INT_PABORT | INT_OCERR)</span>
<span class="cp">#define MY_INTERRUPTS (INT_RISCI | ERROR_INTERRUPTS)</span>

<span class="cm">/* SYNC, one WRITE per line, one extra WRITE per page boundary, SYNC, JUMP */</span>
<span class="cp">#define MAX_RISC_SIZE ((1 + 255 + (PAGE_ALIGN(255 * 4092) / PAGE_SIZE - 1) + 1 + 1) * 8)</span>

<span class="cm">/* Cards with configuration information */</span>
<span class="k">enum</span> <span class="n">snd_bt87x_boardid</span> <span class="p">{</span>
	<span class="n">SND_BT87X_BOARD_UNKNOWN</span><span class="p">,</span>
	<span class="n">SND_BT87X_BOARD_GENERIC</span><span class="p">,</span>	<span class="cm">/* both an &amp; dig interfaces, 32kHz */</span>
	<span class="n">SND_BT87X_BOARD_ANALOG</span><span class="p">,</span>		<span class="cm">/* board with no external A/D */</span>
	<span class="n">SND_BT87X_BOARD_OSPREY2x0</span><span class="p">,</span>
	<span class="n">SND_BT87X_BOARD_OSPREY440</span><span class="p">,</span>
	<span class="n">SND_BT87X_BOARD_AVPHONE98</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Card configuration */</span>
<span class="k">struct</span> <span class="n">snd_bt87x_board</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dig_rate</span><span class="p">;</span>		<span class="cm">/* Digital input sampling rate */</span>
	<span class="n">u32</span> <span class="n">digital_fmt</span><span class="p">;</span>	<span class="cm">/* Register settings for digital input */</span>
	<span class="kt">unsigned</span> <span class="n">no_analog</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No analog input */</span>
	<span class="kt">unsigned</span> <span class="n">no_digital</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No digital input */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">snd_bt87x_board</span> <span class="n">snd_bt87x_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span> <span class="cm">/* just a guess */</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_GENERIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_ANALOG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">no_digital</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_OSPREY2x0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">digital_fmt</span> <span class="o">=</span> <span class="n">CTL_DA_LRI</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_DA_LRD_SHIFT</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_OSPREY440</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">digital_fmt</span> <span class="o">=</span> <span class="n">CTL_DA_LRI</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_DA_LRD_SHIFT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">no_analog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SND_BT87X_BOARD_AVPHONE98</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_bt87x_board</span> <span class="n">board</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opened</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_risc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">reg_control</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">interrupt_mask</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">current_line</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">pci_parity_errors</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">DEVICE_DIGITAL</span><span class="p">,</span> <span class="n">DEVICE_ANALOG</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">snd_bt87x_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_bt87x_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_create_risc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       	 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">periods</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">risc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">MAX_RISC_SIZE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">risc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_SYNC</span> <span class="o">|</span> <span class="n">RISC_SYNC_FM1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rest</span><span class="p">;</span>

		<span class="n">rest</span> <span class="o">=</span> <span class="n">period_bytes</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">rest</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">RISC_WRITE</span> <span class="o">|</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">==</span> <span class="n">period_bytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">block</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">periods</span><span class="p">;</span>
				<span class="n">cmd</span> <span class="o">|=</span> <span class="n">RISC_SOL</span><span class="p">;</span>
				<span class="n">cmd</span> <span class="o">|=</span> <span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="n">RISC_SET_STATUS_SHIFT</span><span class="p">;</span>
				<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RISC_RESET_STATUS_SHIFT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">rest</span><span class="p">)</span>
				<span class="n">cmd</span> <span class="o">|=</span> <span class="n">RISC_EOL</span> <span class="o">|</span> <span class="n">RISC_IRQ</span><span class="p">;</span>
			<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">rest</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_SYNC</span> <span class="o">|</span> <span class="n">RISC_SYNC_VRO</span><span class="p">);</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_JUMP</span><span class="p">);</span>
	<span class="o">*</span><span class="n">risc</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">line_bytes</span> <span class="o">=</span> <span class="n">period_bytes</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">=</span> <span class="n">periods</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_bt87x_free_risc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_bt87x_pci_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pci_status</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_status</span><span class="p">);</span>
	<span class="n">pci_status</span> <span class="o">&amp;=</span> <span class="n">PCI_STATUS_PARITY</span> <span class="o">|</span> <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span> <span class="o">|</span>
		<span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span> <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span>
		<span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span> <span class="o">|</span> <span class="n">PCI_STATUS_DETECTED_PARITY</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">pci_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_status</span> <span class="o">!=</span> <span class="n">PCI_STATUS_DETECTED_PARITY</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Aieee - PCI error! status %#08x, PCI status %#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">status</span> <span class="o">&amp;</span> <span class="n">ERROR_INTERRUPTS</span><span class="p">,</span> <span class="n">pci_status</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Aieee - PCI parity error detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* error &#39;handling&#39; similar to aic7xxx_pci.c: */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci_parity_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci_parity_errors</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Too many PCI parity errors observed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Some device on this bus is generating bad parity.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;This is an error *observed by*, not *generated by*, this card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCI parity error checking has been disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INT_PPERR</span> <span class="o">|</span> <span class="n">INT_RIPERR</span><span class="p">);</span>
			<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_MASK</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_bt87x_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snd_bt87x_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_STAT</span><span class="p">);</span>
	<span class="n">irq_status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_STAT</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">ERROR_INTERRUPTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_FBUS</span> <span class="o">|</span> <span class="n">INT_FTRGT</span><span class="p">))</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;FIFO overrun, status %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">INT_OCERR</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;internal RISC error, status %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_PPERR</span> <span class="o">|</span> <span class="n">INT_RIPERR</span> <span class="o">|</span> <span class="n">INT_PABORT</span><span class="p">))</span>
			<span class="n">snd_bt87x_pci_error</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">INT_RISCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="n">CTL_ACAP_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">current_block</span><span class="p">,</span> <span class="n">irq_block</span><span class="p">;</span>

		<span class="cm">/* assume that exactly one line has been recorded */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">;</span>
		<span class="cm">/* but check if some interrupts have been skipped */</span>
		<span class="n">current_block</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">;</span>
		<span class="n">irq_block</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">INT_RISCS_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_block</span> <span class="o">!=</span> <span class="n">irq_block</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq_block</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_bt87x_digital_hw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* set at runtime */</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="mi">4092</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mi">4092</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_bt87x_analog_hw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
		<span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">ANALOG_CLOCK</span> <span class="o">/</span> <span class="n">CLOCK_DIV_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">ANALOG_CLOCK</span> <span class="o">/</span> <span class="n">CLOCK_DIV_MIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="mi">4092</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mi">4092</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_set_digital_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">CTL_DA_IOM_DA</span> <span class="o">|</span> <span class="n">CTL_A_PWRDN</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_bt87x_digital_hw</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">snd_pcm_rate_to_rate_bit</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dig_rate</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dig_rate</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dig_rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_set_analog_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ratnum</span> <span class="n">analog_clock</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ANALOG_CLOCK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_min</span> <span class="o">=</span> <span class="n">CLOCK_DIV_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_max</span> <span class="o">=</span> <span class="n">CLOCK_DIV_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_step</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_ratnums</span> <span class="n">constraint_rates</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nrats</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">analog_clock</span>
	<span class="p">};</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CTL_DA_IOM_DA</span> <span class="o">|</span> <span class="n">CTL_A_PWRDN</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_bt87x_analog_hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">constraint_rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">DEVICE_DIGITAL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_set_digital_hw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_set_analog_hw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_error:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">CTL_A_PWRDN</span><span class="p">;</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
				       <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_bt87x_create_risc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span>
				     <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
				     <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">snd_bt87x_free_risc</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">decimation</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CTL_DA_SDR_MASK</span> <span class="o">|</span> <span class="n">CTL_DA_SBR</span><span class="p">);</span>
	<span class="n">decimation</span> <span class="o">=</span> <span class="p">(</span><span class="n">ANALOG_CLOCK</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">decimation</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_DA_SDR_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S8</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">CTL_DA_SBR</span><span class="p">;</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">CTL_FIFO_ENABLE</span> <span class="o">|</span> <span class="n">CTL_RISC_ENABLE</span> <span class="o">|</span> <span class="n">CTL_ACAP_EN</span><span class="p">;</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_RISC_STRT_ADD</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_risc</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_PACKET_LEN</span><span class="p">,</span>
			 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">line_bytes</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_MASK</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CTL_FIFO_ENABLE</span> <span class="o">|</span> <span class="n">CTL_RISC_ENABLE</span> <span class="o">|</span> <span class="n">CTL_ACAP_EN</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_STAT</span><span class="p">,</span> <span class="n">MY_INTERRUPTS</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="k">return</span> <span class="n">snd_bt87x_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="k">return</span> <span class="n">snd_bt87x_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_bt87x_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">snd_pcm_uframes_t</span><span class="p">)</span><span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_line</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">line_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_bt87x_pcm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_bt87x_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_bt87x_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_bt87x_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_bt87x_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_bt87x_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_bt87x_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_bt87x_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="n">CTL_A_GAIN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CTL_A_GAIN_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">old_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old_control</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTL_A_GAIN_MASK</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_A_GAIN_SHIFT</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">old_control</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_bt87x_capture_volume</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_volume_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_volume_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_volume_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define snd_bt87x_capture_boost_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_boost_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="n">CTL_A_G2X</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_boost_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">old_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old_control</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTL_A_G2X</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">CTL_A_G2X</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">!=</span> <span class="n">old_control</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_bt87x_capture_boost</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Boost&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_boost_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_boost_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_boost_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;TV Tuner&quot;</span><span class="p">,</span> <span class="s">&quot;FM&quot;</span><span class="p">,</span> <span class="s">&quot;Mic/Line&quot;</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">snd_ctl_enum_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">texts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="n">CTL_A_SEL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CTL_A_SEL_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_capture_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">old_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old_control</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTL_A_SEL_MASK</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_A_SEL_SHIFT</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">!=</span> <span class="n">old_control</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_bt87x_capture_source</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_bt87x_capture_source_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span>
		<span class="n">snd_bt87x_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_bt87x_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_bt87x_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_bt87x_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_bt87x_pcm_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span>
						     <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
						     <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
							<span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
							<span class="n">ALIGN</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="mi">4092</span><span class="p">,</span> <span class="mi">1024</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_bt87x_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">**</span><span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_bt87x_dev_free</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;Bt87x audio&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot remap io memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">=</span> <span class="n">CTL_A_PWRDN</span> <span class="o">|</span> <span class="n">CTL_DA_ES2</span> <span class="o">|</span>
			    <span class="n">CTL_PKTP_16</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="n">CTL_DA_SDR_SHIFT</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span> <span class="o">=</span> <span class="n">MY_INTERRUPTS</span><span class="p">;</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_GPIO_DMA_CTL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_bt87x_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_INT_STAT</span><span class="p">,</span> <span class="n">MY_INTERRUPTS</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_bt87x_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot grab irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">snd_bt87x_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BT_DEVICE(chip, subvend, subdev, id) \</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_BROOKTREE, \</span>
<span class="cp">	  .device = chip, \</span>
<span class="cp">	  .subvendor = subvend, .subdevice = subdev, \</span>
<span class="cp">	  .driver_data = SND_BT87X_BOARD_ ## id }</span>
<span class="cm">/* driver_data is the card id for that device */</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_bt87x_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Hauppauge WinTV series */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x13eb</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Hauppauge WinTV series */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_879</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x13eb</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Viewcast Osprey 200 */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0xff01</span><span class="p">,</span> <span class="n">OSPREY2x0</span><span class="p">),</span>
	<span class="cm">/* Viewcast Osprey 440 (rate is configurable via gpio) */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0xff07</span><span class="p">,</span> <span class="n">OSPREY440</span><span class="p">),</span>
	<span class="cm">/* ATI TV-Wonder */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Leadtek Winfast tv 2000xp delux */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x107d</span><span class="p">,</span> <span class="mh">0x6606</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Pinnacle PCTV */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x11bd</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Voodoo TV 200 */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x121a</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Askey Computer Corp. MagicTView&#39;99 */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x144f</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* AVerMedia Studio No. 103, 203, ...? */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x1461</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">AVPHONE98</span><span class="p">),</span>
	<span class="cm">/* Prolink PixelView PV-M4900 */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0x1554</span><span class="p">,</span> <span class="mh">0x4011</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="cm">/* Pinnacle  Studio PCTV rave */</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="mh">0xbd11</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">,</span> <span class="n">GENERIC</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_bt87x_ids</span><span class="p">);</span>

<span class="cm">/* cards known not to have audio</span>
<span class="cm"> * (DVB cards use the audio function to transfer MPEG data) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">subvendor</span><span class="p">,</span> <span class="n">subdevice</span><span class="p">;</span>
<span class="p">}</span> <span class="n">blacklist</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x0071</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">},</span> <span class="cm">/* Nebula Electronics DigiTV */</span>
	<span class="p">{</span><span class="mh">0x11bd</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">},</span> <span class="cm">/* Pinnacle PCTV Sat */</span>
	<span class="p">{</span><span class="mh">0x11bd</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">},</span> <span class="cm">/* Pinnacle PCTV SAT CI */</span>
	<span class="p">{</span><span class="mh">0x1461</span><span class="p">,</span> <span class="mh">0x0761</span><span class="p">},</span> <span class="cm">/* AVermedia AverTV DVB-T */</span>
	<span class="p">{</span><span class="mh">0x1461</span><span class="p">,</span> <span class="mh">0x0771</span><span class="p">},</span> <span class="cm">/* AVermedia DVB-T 771 */</span>
	<span class="p">{</span><span class="mh">0x1822</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/* Twinhan VisionPlus DVB-T */</span>
	<span class="p">{</span><span class="mh">0x18ac</span><span class="p">,</span> <span class="mh">0xd500</span><span class="p">},</span> <span class="cm">/* DVICO FusionHDTV 5 Lite */</span>
	<span class="p">{</span><span class="mh">0x18ac</span><span class="p">,</span> <span class="mh">0xdb10</span><span class="p">},</span> <span class="cm">/* DVICO FusionHDTV DVB-T Lite */</span>
	<span class="p">{</span><span class="mh">0x18ac</span><span class="p">,</span> <span class="mh">0xdb11</span><span class="p">},</span> <span class="cm">/* Ultraview DVB-T Lite */</span>
	<span class="p">{</span><span class="mh">0x270f</span><span class="p">,</span> <span class="mh">0xfc00</span><span class="p">},</span> <span class="cm">/* Chaintech Digitop DST-1000 DVB-S */</span>
	<span class="p">{</span><span class="mh">0x7063</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">},</span> <span class="cm">/* pcHDTV HD-2000 TV */</span>
<span class="p">};</span>

<span class="cm">/* return the id of the card, or a negative value if it&#39;s blacklisted */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_bt87x_detect_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">supported</span><span class="p">;</span>

	<span class="n">supported</span> <span class="o">=</span> <span class="n">pci_match_id</span><span class="p">(</span><span class="n">snd_bt87x_ids</span><span class="p">,</span> <span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">supported</span> <span class="o">&amp;&amp;</span> <span class="n">supported</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">supported</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">blacklist</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subvendor</span> <span class="o">==</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdevice</span> <span class="o">==</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;card %#04x-%#04x:%#04x has no audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;unknown card %#04x-%#04x:%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;please mail id, board name, and, &quot;</span>
		   <span class="s">&quot;if it works, the correct digital_rate option to &quot;</span>
		   <span class="s">&quot;&lt;alsa-devel@alsa-project.org&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SND_BT87X_BOARD_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_bt87x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_bt87x</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">snd_bt87x_boardid</span> <span class="n">boardid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_detect_card</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">boardid</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">boardid</span> <span class="o">=</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_bt87x_boards</span><span class="p">[</span><span class="n">boardid</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_digital</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digital_rate</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dig_rate</span> <span class="o">=</span> <span class="n">digital_rate</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_control</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">digital_fmt</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DEVICE_DIGITAL</span><span class="p">,</span> <span class="s">&quot;Bt87x Digital&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_analog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_bt87x_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DEVICE_ANALOG</span><span class="p">,</span> <span class="s">&quot;Bt87x Analog&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span>
				  <span class="o">&amp;</span><span class="n">snd_bt87x_capture_volume</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span>
				  <span class="o">&amp;</span><span class="n">snd_bt87x_capture_boost</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span>
				  <span class="o">&amp;</span><span class="n">snd_bt87x_capture_source</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;bt87x%d: Using board %d, %sanalog, %sdigital &quot;</span>
		   <span class="s">&quot;(rate %d Hz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">boardid</span><span class="p">,</span>
		   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_analog</span> <span class="o">?</span> <span class="s">&quot;no &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">no_digital</span> <span class="o">?</span> <span class="s">&quot;no &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">dig_rate</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Bt87x&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Brooktree Bt%x&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at %#llx, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;Bt87x&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="o">++</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_error:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_bt87x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* default entries for all Bt87x cards - it&#39;s not exported */</span>
<span class="cm">/* driver_data is set to 0 to call detection */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_bt87x_default_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_878</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">UNKNOWN</span><span class="p">),</span>
	<span class="n">BT_DEVICE</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_BROOKTREE_879</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">UNKNOWN</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">bt87x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_bt87x_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_bt87x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_bt87x_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">bt87x_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
