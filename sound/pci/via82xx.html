<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › via82xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>via82xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for VIA VT82xx (South Bridge)</span>
<span class="cm"> *</span>
<span class="cm"> *   VT82C686A/B/C, VT8233A/C, VT8235</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *	                   Tjeerd.Mulder &lt;Tjeerd.Mulder@fujitsu-siemens.com&gt;</span>
<span class="cm"> *                    2002 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *</span>
<span class="cm"> * Dec. 19, 2002	Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *	- use the DSX channels for the first pcm playback.</span>
<span class="cm"> *	  (on VIA8233, 8233C and 8235 only)</span>
<span class="cm"> *	  this will allow you play simultaneously up to 4 streams.</span>
<span class="cm"> *	  multi-channel playback is assigned to the second device</span>
<span class="cm"> *	  on these chips.</span>
<span class="cm"> *	- support the secondary capture (on VIA8233/C,8235)</span>
<span class="cm"> *	- SPDIF support</span>
<span class="cm"> *	  the DSX3 channel can be used for SPDIF output.</span>
<span class="cm"> *	  on VIA8233A, this channel is assigned to the second pcm</span>
<span class="cm"> *	  playback.</span>
<span class="cm"> *	  the card config of alsa-lib will assign the correct</span>
<span class="cm"> *	  device for applications.</span>
<span class="cm"> *	- clean up the code, separate low-level initialization</span>
<span class="cm"> *	  routines for each chipset.</span>
<span class="cm"> *</span>
<span class="cm"> * Sep. 26, 2005	Karsten Wiese &lt;annabellesgarden@yahoo.de&gt;</span>
<span class="cm"> *	- Optimize position calculation for the 823x chips. </span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define POINTER_DEBUG</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA VT82xx audio&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{VIA,VT82C686A/B/C,pci},{VIA,VT8233A/C,8235}}&quot;</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>
<span class="cp">#define SUPPORT_JOYSTICK 1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX1</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">mpu_port</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">joystick</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ac97_clock</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ac97_quirk</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dxs_support</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dxs_init_volume</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nodelay</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for VIA 82xx bridge.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for VIA 82xx bridge.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="s">&quot;MPU-401 port. (VT82C686x only)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="s">&quot;Enable joystick. (VT82C686x only)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codec clock (default 48000Hz).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_quirk</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_quirk</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 workaround for strange hardware.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dxs_support</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dxs_support</span><span class="p">,</span> <span class="s">&quot;Support for DXS channels (0 = auto, 1 = enable, 2 = disable, 3 = 48k only, 4 = no VRA, 5 = enable any sample rate)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dxs_init_volume</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dxs_init_volume</span><span class="p">,</span> <span class="s">&quot;initial DXS volume (0-31)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nodelay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nodelay</span><span class="p">,</span> <span class="s">&quot;Disable 500ms init delay&quot;</span><span class="p">);</span>

<span class="cm">/* just for backward compatibility */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>


<span class="cm">/* revision numbers for via686 */</span>
<span class="cp">#define VIA_REV_686_A		0x10</span>
<span class="cp">#define VIA_REV_686_B		0x11</span>
<span class="cp">#define VIA_REV_686_C		0x12</span>
<span class="cp">#define VIA_REV_686_D		0x13</span>
<span class="cp">#define VIA_REV_686_E		0x14</span>
<span class="cp">#define VIA_REV_686_H		0x20</span>

<span class="cm">/* revision numbers for via8233 */</span>
<span class="cp">#define VIA_REV_PRE_8233	0x10	</span><span class="cm">/* not in market */</span><span class="cp"></span>
<span class="cp">#define VIA_REV_8233C		0x20	</span><span class="cm">/* 2 rec, 4 pb, 1 multi-pb */</span><span class="cp"></span>
<span class="cp">#define VIA_REV_8233		0x30	</span><span class="cm">/* 2 rec, 4 pb, 1 multi-pb, spdif */</span><span class="cp"></span>
<span class="cp">#define VIA_REV_8233A		0x40	</span><span class="cm">/* 1 rec, 1 multi-pb, spdf */</span><span class="cp"></span>
<span class="cp">#define VIA_REV_8235		0x50	</span><span class="cm">/* 2 rec, 4 pb, 1 multi-pb, spdif */</span><span class="cp"></span>
<span class="cp">#define VIA_REV_8237		0x60</span>
<span class="cp">#define VIA_REV_8251		0x70</span>

<span class="cm">/*</span>
<span class="cm"> *  Direct registers</span>
<span class="cm"> */</span>

<span class="cp">#define VIAREG(via, x) ((via)-&gt;port + VIA_REG_##x)</span>
<span class="cp">#define VIADEV_REG(viadev, x) ((viadev)-&gt;port + VIA_REG_##x)</span>

<span class="cm">/* common offsets */</span>
<span class="cp">#define VIA_REG_OFFSET_STATUS		0x00	</span><span class="cm">/* byte - channel status */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_ACTIVE		0x80	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA8233_SHADOW_STAT_ACTIVE	0x08	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_PAUSED		0x40	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_TRIGGER_QUEUED	0x08	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_STOPPED		0x04	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_EOL		0x02	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_FLAG		0x01	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CONTROL		0x01	</span><span class="cm">/* byte - channel control */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_START		0x80	</span><span class="cm">/* WO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_TERMINATE	0x40	</span><span class="cm">/* WO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_AUTOSTART	0x20</span>
<span class="cp">#define   VIA_REG_CTRL_PAUSE		0x08	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_INT_STOP		0x04		</span>
<span class="cp">#define   VIA_REG_CTRL_INT_EOL		0x02</span>
<span class="cp">#define   VIA_REG_CTRL_INT_FLAG		0x01</span>
<span class="cp">#define   VIA_REG_CTRL_RESET		0x01	</span><span class="cm">/* RW - probably reset? undocumented */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_INT (VIA_REG_CTRL_INT_FLAG | VIA_REG_CTRL_INT_EOL | VIA_REG_CTRL_AUTOSTART)</span>
<span class="cp">#define VIA_REG_OFFSET_TYPE		0x02	</span><span class="cm">/* byte - channel type (686 only) */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_AUTOSTART	0x80	</span><span class="cm">/* RW - autostart at EOL */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_16BIT		0x20	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_STEREO		0x10	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_INT_LLINE	0x00</span>
<span class="cp">#define   VIA_REG_TYPE_INT_LSAMPLE	0x04</span>
<span class="cp">#define   VIA_REG_TYPE_INT_LESSONE	0x08</span>
<span class="cp">#define   VIA_REG_TYPE_INT_MASK		0x0c</span>
<span class="cp">#define   VIA_REG_TYPE_INT_EOL		0x02</span>
<span class="cp">#define   VIA_REG_TYPE_INT_FLAG		0x01</span>
<span class="cp">#define VIA_REG_OFFSET_TABLE_PTR	0x04	</span><span class="cm">/* dword - channel table pointer */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_PTR		0x04	</span><span class="cm">/* dword - channel current pointer */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_STOP_IDX		0x08	</span><span class="cm">/* dword - stop index, channel type, sample rate */</span><span class="cp"></span>
<span class="cp">#define   VIA8233_REG_TYPE_16BIT	0x00200000	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA8233_REG_TYPE_STEREO	0x00100000	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_COUNT	0x0c	</span><span class="cm">/* dword - channel current count (24 bit) */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_INDEX	0x0f	</span><span class="cm">/* byte - channel current index (for via8233 only) */</span><span class="cp"></span>

<span class="cp">#define DEFINE_VIA_REGSET(name,val) \</span>
<span class="cp">enum {\</span>
<span class="cp">	VIA_REG_##name##_STATUS		= (val),\</span>
<span class="cp">	VIA_REG_##name##_CONTROL	= (val) + 0x01,\</span>
<span class="cp">	VIA_REG_##name##_TYPE		= (val) + 0x02,\</span>
<span class="cp">	VIA_REG_##name##_TABLE_PTR	= (val) + 0x04,\</span>
<span class="cp">	VIA_REG_##name##_CURR_PTR	= (val) + 0x04,\</span>
<span class="cp">	VIA_REG_##name##_STOP_IDX	= (val) + 0x08,\</span>
<span class="cp">	VIA_REG_##name##_CURR_COUNT	= (val) + 0x0c,\</span>
<span class="cp">}</span>

<span class="cm">/* playback block */</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">PLAYBACK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">CAPTURE</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">FM</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

<span class="cm">/* AC&#39;97 */</span>
<span class="cp">#define VIA_REG_AC97			0x80	</span><span class="cm">/* dword */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_MASK	(3&lt;&lt;30)</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_SHIFT	30</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_PRIMARY	0x00</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_SECONDARY 0x01</span>
<span class="cp">#define   VIA_REG_AC97_SECONDARY_VALID	(1&lt;&lt;27)</span>
<span class="cp">#define   VIA_REG_AC97_PRIMARY_VALID	(1&lt;&lt;25)</span>
<span class="cp">#define   VIA_REG_AC97_BUSY		(1&lt;&lt;24)</span>
<span class="cp">#define   VIA_REG_AC97_READ		(1&lt;&lt;23)</span>
<span class="cp">#define   VIA_REG_AC97_CMD_SHIFT	16</span>
<span class="cp">#define   VIA_REG_AC97_CMD_MASK		0x7e</span>
<span class="cp">#define   VIA_REG_AC97_DATA_SHIFT	0</span>
<span class="cp">#define   VIA_REG_AC97_DATA_MASK	0xffff</span>

<span class="cp">#define VIA_REG_SGD_SHADOW		0x84	</span><span class="cm">/* dword */</span><span class="cp"></span>
<span class="cm">/* via686 */</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_FLAG	(1&lt;&lt;0)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_FLAG	(1&lt;&lt;1)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_FLAG	(1&lt;&lt;2)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_EOL	(1&lt;&lt;4)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_EOL	(1&lt;&lt;5)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_EOL	(1&lt;&lt;6)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_STOP	(1&lt;&lt;8)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_STOP	(1&lt;&lt;9)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_STOP	(1&lt;&lt;10)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_ACTIVE	(1&lt;&lt;12)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_ACTIVE	(1&lt;&lt;13)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_ACTIVE	(1&lt;&lt;14)</span>
<span class="cm">/* via8233 */</span>
<span class="cp">#define   VIA8233_REG_SGD_STAT_FLAG	(1&lt;&lt;0)</span>
<span class="cp">#define   VIA8233_REG_SGD_STAT_EOL	(1&lt;&lt;1)</span>
<span class="cp">#define   VIA8233_REG_SGD_STAT_STOP	(1&lt;&lt;2)</span>
<span class="cp">#define   VIA8233_REG_SGD_STAT_ACTIVE	(1&lt;&lt;3)</span>
<span class="cp">#define VIA8233_INTR_MASK(chan) ((VIA8233_REG_SGD_STAT_FLAG|VIA8233_REG_SGD_STAT_EOL) &lt;&lt; ((chan) * 4))</span>
<span class="cp">#define   VIA8233_REG_SGD_CHAN_SDX	0</span>
<span class="cp">#define   VIA8233_REG_SGD_CHAN_MULTI	4</span>
<span class="cp">#define   VIA8233_REG_SGD_CHAN_REC	6</span>
<span class="cp">#define   VIA8233_REG_SGD_CHAN_REC1	7</span>

<span class="cp">#define VIA_REG_GPI_STATUS		0x88</span>
<span class="cp">#define VIA_REG_GPI_INTR		0x8c</span>

<span class="cm">/* multi-channel and capture registers for via8233 */</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">MULTPLAY</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">CAPTURE_8233</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>

<span class="cm">/* via8233-specific registers */</span>
<span class="cp">#define VIA_REG_OFS_PLAYBACK_VOLUME_L	0x02	</span><span class="cm">/* byte */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFS_PLAYBACK_VOLUME_R	0x03	</span><span class="cm">/* byte */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFS_MULTPLAY_FORMAT	0x02	</span><span class="cm">/* byte - format and channels */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_MULTPLAY_FMT_8BIT	0x00</span>
<span class="cp">#define   VIA_REG_MULTPLAY_FMT_16BIT	0x80</span>
<span class="cp">#define   VIA_REG_MULTPLAY_FMT_CH_MASK	0x70	</span><span class="cm">/* # channels &lt;&lt; 4 (valid = 1,2,4,6) */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFS_CAPTURE_FIFO	0x02	</span><span class="cm">/* byte - bit 6 = fifo  enable */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CAPTURE_FIFO_ENABLE	0x40</span>

<span class="cp">#define VIA_DXS_MAX_VOLUME		31	</span><span class="cm">/* max. volume (attenuation) of reg 0x32/33 */</span><span class="cp"></span>

<span class="cp">#define VIA_REG_CAPTURE_CHANNEL		0x63	</span><span class="cm">/* byte - input select */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CAPTURE_CHANNEL_MIC	0x4</span>
<span class="cp">#define   VIA_REG_CAPTURE_CHANNEL_LINE	0</span>
<span class="cp">#define   VIA_REG_CAPTURE_SELECT_CODEC	0x03	</span><span class="cm">/* recording source codec (0 = primary) */</span><span class="cp"></span>

<span class="cp">#define VIA_TBL_BIT_FLAG	0x40000000</span>
<span class="cp">#define VIA_TBL_BIT_EOL		0x80000000</span>

<span class="cm">/* pci space */</span>
<span class="cp">#define VIA_ACLINK_STAT		0x40</span>
<span class="cp">#define  VIA_ACLINK_C11_READY	0x20</span>
<span class="cp">#define  VIA_ACLINK_C10_READY	0x10</span>
<span class="cp">#define  VIA_ACLINK_C01_READY	0x04 </span><span class="cm">/* secondary codec ready */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_LOWPOWER	0x02 </span><span class="cm">/* low-power state */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_C00_READY	0x01 </span><span class="cm">/* primary codec ready */</span><span class="cp"></span>
<span class="cp">#define VIA_ACLINK_CTRL		0x41</span>
<span class="cp">#define  VIA_ACLINK_CTRL_ENABLE	0x80 </span><span class="cm">/* 0: disable, 1: enable */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_RESET	0x40 </span><span class="cm">/* 0: assert, 1: de-assert */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SYNC	0x20 </span><span class="cm">/* 0: release SYNC, 1: force SYNC hi */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SDO	0x10 </span><span class="cm">/* 0: release SDO, 1: force SDO hi */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_VRA	0x08 </span><span class="cm">/* 0: disable VRA, 1: enable VRA */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_PCM	0x04 </span><span class="cm">/* 0: disable PCM, 1: enable PCM */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_FM	0x02 </span><span class="cm">/* via686 only */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SB	0x01 </span><span class="cm">/* via686 only */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_INIT	(VIA_ACLINK_CTRL_ENABLE|\</span>
<span class="cp">				 VIA_ACLINK_CTRL_RESET|\</span>
<span class="cp">				 VIA_ACLINK_CTRL_PCM|\</span>
<span class="cp">				 VIA_ACLINK_CTRL_VRA)</span>
<span class="cp">#define VIA_FUNC_ENABLE		0x42</span>
<span class="cp">#define  VIA_FUNC_MIDI_PNP	0x80 </span><span class="cm">/* FIXME: it&#39;s 0x40 in the datasheet! */</span><span class="cp"></span>
<span class="cp">#define  VIA_FUNC_MIDI_IRQMASK	0x40 </span><span class="cm">/* FIXME: not documented! */</span><span class="cp"></span>
<span class="cp">#define  VIA_FUNC_RX2C_WRITE	0x20</span>
<span class="cp">#define  VIA_FUNC_SB_FIFO_EMPTY	0x10</span>
<span class="cp">#define  VIA_FUNC_ENABLE_GAME	0x08</span>
<span class="cp">#define  VIA_FUNC_ENABLE_FM	0x04</span>
<span class="cp">#define  VIA_FUNC_ENABLE_MIDI	0x02</span>
<span class="cp">#define  VIA_FUNC_ENABLE_SB	0x01</span>
<span class="cp">#define VIA_PNP_CONTROL		0x43</span>
<span class="cp">#define VIA_FM_NMI_CTRL		0x48</span>
<span class="cp">#define VIA8233_VOLCHG_CTRL	0x48</span>
<span class="cp">#define VIA8233_SPDIF_CTRL	0x49</span>
<span class="cp">#define  VIA8233_SPDIF_DX3	0x08</span>
<span class="cp">#define  VIA8233_SPDIF_SLOT_MASK	0x03</span>
<span class="cp">#define  VIA8233_SPDIF_SLOT_1011	0x00</span>
<span class="cp">#define  VIA8233_SPDIF_SLOT_34		0x01</span>
<span class="cp">#define  VIA8233_SPDIF_SLOT_78		0x02</span>
<span class="cp">#define  VIA8233_SPDIF_SLOT_69		0x03</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cp">#define VIA_DXS_AUTO	0</span>
<span class="cp">#define VIA_DXS_ENABLE	1</span>
<span class="cp">#define VIA_DXS_DISABLE	2</span>
<span class="cp">#define VIA_DXS_48K	3</span>
<span class="cp">#define VIA_DXS_NO_VRA	4</span>
<span class="cp">#define VIA_DXS_SRC	5</span>


<span class="cm">/*</span>
<span class="cm"> * pcm stream</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">snd_via_sg_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cp">#define VIA_TABLE_SIZE	255</span>
<span class="cp">#define VIA_MAX_BUFSIZE	(1&lt;&lt;24)</span>

<span class="k">struct</span> <span class="n">viadev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>	<span class="cm">/* playback = 0, capture = 1 */</span>
        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbl_entries</span><span class="p">;</span> <span class="cm">/* # descriptors */</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_via_sg_table</span> <span class="o">*</span><span class="n">idx_table</span><span class="p">;</span>
	<span class="cm">/* for recovery from the unexpected pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lastpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hwptr_done</span><span class="p">;</span>		<span class="cm">/* processed frame position in the buffer */</span>
	<span class="kt">int</span> <span class="n">in_interrupt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shadow_shift</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="p">{</span> <span class="n">TYPE_CARD_VIA686</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TYPE_CARD_VIA8233</span> <span class="p">};</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">TYPE_VIA686</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span><span class="p">,</span> <span class="n">TYPE_VIA8233A</span> <span class="p">};</span>

<span class="cp">#define VIA_MAX_DEVS	7	</span><span class="cm">/* 4 playback, 1 multi, 2 capture */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">via_rate_lock</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">via82xx</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mpu_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">revision</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_legacy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_legacy_cfg</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">legacy_saved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">legacy_cfg_saved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spdif_ctrl_saved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">capture_src_saved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpu_port_saved</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">playback_volume</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* for VIA8233/C/8235; default = 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">playback_volume_c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* for VIA8233/C/8235; default = 0 */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_mask</span><span class="p">;</span> <span class="cm">/* SGD_SHADOW mask to check interrupts */</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_devs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">playback_devno</span><span class="p">,</span> <span class="n">multi_devno</span><span class="p">,</span> <span class="n">capture_devno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="n">devs</span><span class="p">[</span><span class="n">VIA_MAX_DEVS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">via_rate_lock</span> <span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* playback and capture */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dxs_fixed</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* DXS channel accepts only 48kHz */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no_vra</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* no need to set VRA on DXS channels */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dxs_src</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* use full SRC capabilities of DXS */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_on</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* only spdif rates work to external DACs */</span>

	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcms</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">dxs_controls</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_secondary</span><span class="p">;</span>	<span class="cm">/* secondary AC&#39;97 codec is present */</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">proc_entry</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_via82xx_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x1106, 0x3058 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VIA_82C686_5</span><span class="p">),</span> <span class="n">TYPE_CARD_VIA686</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* 686A */</span>
	<span class="cm">/* 0x1106, 0x3059 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VIA_8233_5</span><span class="p">),</span> <span class="n">TYPE_CARD_VIA8233</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* VT8233 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_via82xx_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * allocate and initialize the descriptor buffers</span>
<span class="cm"> * periods = number of periods</span>
<span class="cm"> * fragsize = period size in bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_via_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">periods</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the start of each lists must be aligned to 8 bytes,</span>
<span class="cm">		 * but the kernel pages are much bigger, so we don&#39;t care</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">VIA_TABLE_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span> <span class="o">*</span> <span class="n">VIA_TABLE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill the entries */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rest</span> <span class="o">=</span> <span class="n">fragsize</span><span class="p">;</span>
		<span class="cm">/* fill descriptors for a period.</span>
<span class="cm">		 * a period can be split to several descriptors if it&#39;s</span>
<span class="cm">		 * over page boundary.</span>
<span class="cm">		 */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">VIA_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via82xx: too much table size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)[</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_get_chunk_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
			<span class="n">rest</span> <span class="o">-=</span> <span class="n">r</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">rest</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">VIA_TBL_BIT_EOL</span><span class="p">;</span> <span class="cm">/* buffer boundary */</span>
				<span class="k">else</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">VIA_TBL_BIT_FLAG</span><span class="p">;</span> <span class="cm">/* period boundary */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* period continues to the next */</span>
			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG &quot;via: tbl %d: at %d  size %d &quot;</span>
<span class="cm">			       &quot;(rest %d)\n&quot;, idx, ofs, r, rest);</span>
<span class="cm">			*/</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)[(</span><span class="n">idx</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r</span> <span class="o">|</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">periods</span> <span class="o">*</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize2</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">clean_via_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_xread</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1ms */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_AC97_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_ready: codec %i is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">secondary</span><span class="p">,</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1ms */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">val1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="o">!</span><span class="n">secondary</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_PRIMARY_VALID</span> <span class="o">:</span>
					 <span class="n">VIA_REG_AC97_SECONDARY_VALID</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VIA_REG_AC97_BUSY</span> <span class="o">|</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">==</span> <span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="cm">/* here we need to wait fairly for long time.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nodelay</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xval</span><span class="p">;</span>

	<span class="n">xval</span> <span class="o">=</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_CODEC_ID_PRIMARY</span> <span class="o">:</span> <span class="n">VIA_REG_AC97_CODEC_ID_SECONDARY</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">&lt;&lt;=</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CMD_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_DATA_SHIFT</span><span class="p">;</span>
	<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xval</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_via82xx_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xval</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xval</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_SECONDARY_VALID</span> <span class="o">:</span> <span class="n">VIA_REG_AC97_PRIMARY_VALID</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">VIA_REG_AC97_READ</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CMD_SHIFT</span><span class="p">;</span>
      	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      		<span class="k">if</span> <span class="p">(</span><span class="n">again</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read: codec %i is not valid [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		      	<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xval</span><span class="p">);</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_via82xx_codec_valid</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_channel_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VIA_REG_CTRL_PAUSE</span> <span class="o">|</span> <span class="n">VIA_REG_CTRL_TERMINATE</span> <span class="o">|</span> <span class="n">VIA_REG_CTRL_RESET</span><span class="p">,</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="cm">/* clear interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TYPE</span><span class="p">));</span> <span class="cm">/* for via686 */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>outl(0, VIADEV<em>REG(viadev, OFFSET</em>CURR_PTR));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> *  Used for 686 and 8233A</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_via686_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SGD_SHADOW</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span>
			<span class="cm">/* check mpu401 interrupt */</span>
			<span class="k">return</span> <span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check status for each stream */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">c_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VIA_REG_STAT_EOL</span><span class="o">|</span><span class="n">VIA_REG_STAT_FLAG</span><span class="o">|</span><span class="n">VIA_REG_STAT_STOPPED</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Update hwptr_done based on &#39;period elapsed&#39;</span>
<span class="cm">			 * interrupts. We&#39;ll use it, when the chip returns 0 </span>
<span class="cm">			 * for OFFSET_CURR_COUNT.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_EOL</span><span class="p">)</span>
				<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span> <span class="o">+=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
			<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">=</span> <span class="n">c_status</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">c_status</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span> <span class="cm">/* ack */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_via8233_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqreturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check status for each stream */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SGD_SHADOW</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c_status</span><span class="p">,</span> <span class="n">shadow_status</span><span class="p">;</span>

		<span class="n">shadow_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">shadow_shift</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">VIA8233_SHADOW_STAT_ACTIVE</span><span class="o">|</span><span class="n">VIA_REG_STAT_EOL</span><span class="o">|</span>
			 <span class="n">VIA_REG_STAT_FLAG</span><span class="p">);</span>
		<span class="n">c_status</span> <span class="o">=</span> <span class="n">shadow_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VIA_REG_STAT_EOL</span><span class="o">|</span><span class="n">VIA_REG_STAT_FLAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c_status</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">substream</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Update hwptr_done based on &#39;period elapsed&#39;</span>
<span class="cm">			 * interrupts. We&#39;ll use it, when the chip returns 0 </span>
<span class="cm">			 * for OFFSET_CURR_COUNT.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_EOL</span><span class="p">)</span>
				<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span> <span class="o">+=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
			<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">=</span> <span class="n">c_status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shadow_status</span> <span class="o">&amp;</span> <span class="n">VIA8233_SHADOW_STAT_ACTIVE</span><span class="p">)</span>
				<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">|=</span> <span class="n">VIA_REG_STAT_ACTIVE</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">c_status</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span> <span class="cm">/* ack */</span>
		<span class="n">irqreturn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">irqreturn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM callbacks</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * trigger callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA686</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_REG_CTRL_INT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA_REG_CTRL_START</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_REG_CTRL_TERMINATE</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA_REG_CTRL_PAUSE</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pointer callbacks</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * calculate the linear position at the given sg-buffer index and the rest count</span>
<span class="cm"> */</span>

<span class="cp">#define check_invalid_pos(viadev,pos) \</span>
<span class="cp">	((pos) &lt; viadev-&gt;lastpos &amp;&amp; ((pos) &gt;= viadev-&gt;bufsize2 ||\</span>
<span class="cp">				     viadev-&gt;lastpos &lt; viadev-&gt;bufsize2))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_linear_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">-=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>

	<span class="cm">/* check the validity of the calculated position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid via82xx_cur_ptr (size = %d, count = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Some mobos report count = 0 on the DMA boundary,</span>
<span class="cm">			 * i.e. count = size indeed.</span>
<span class="cm">			 * Let&#39;s check whether this step is above the expected size.</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">res</span> <span class="o">-</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">delta</span> <span class="o">+=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_invalid_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef POINTER_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;fail: idx = %i/%i, lastpos = 0x%x, &quot;</span>
			       <span class="s">&quot;bufsize2 = 0x%x, offsize = 0x%x, size = 0x%x, &quot;</span>
			       <span class="s">&quot;count = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">,</span>
			       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">,</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize2</span><span class="p">,</span>
			       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
			       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* count register returns full size when end of buffer is reached */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_invalid_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid via82xx_cur_ptr (2), &quot;</span>
					   <span class="s">&quot;using last valid pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the current pointer on via686</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_via686_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_ACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CURR_COUNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="cm">/* The via686a does not have the current index register,</span>
<span class="cm">	 * so we need to calculate the index from CURR_PTR.</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CURR_PTR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* CURR_PTR holds the address + 8 */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">calc_linear_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span> <span class="cm">/* remember the last position */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the current pointer on via823x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_via8233_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CURR_COUNT</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span>

	<span class="cm">/* An apparent bug in the 8251 is worked around by sending a </span>
<span class="cm">	 * REG_CTRL_START. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">VIA_REV_8251</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_EOL</span><span class="p">))</span>
		<span class="n">snd_via82xx_pcm_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef POINTER_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;fail: invalid idx = %i/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">&amp;=</span> <span class="mh">0xffffff</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">calc_linear_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">hwptr_done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">in_interrupt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_EOL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_FLAG</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">+=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>			    
<span class="nl">unlock:</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * hw_params callback:</span>
<span class="cm"> * allocate the buffer and build up the buffer description table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_via_table</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>
			      <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
			      <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hw_free callback:</span>
<span class="cm"> * clean up the buffer description table and release the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">clean_via_table</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * set up the table pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TABLE_PTR</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prepare callback for playback and capture on via686</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via686_setup_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="cm">/* this must be set after channel_reset */</span>
	<span class="n">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VIA_REG_TYPE_AUTOSTART</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span> <span class="o">?</span> <span class="n">VIA_REG_TYPE_16BIT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">VIA_REG_TYPE_STEREO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">((</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">VIA_REG_TYPE_INT_LSAMPLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">VIA_REG_TYPE_INT_EOL</span> <span class="o">|</span>
	     <span class="n">VIA_REG_TYPE_INT_FLAG</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TYPE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via686_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">via686_setup_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via686_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">via686_setup_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lock the current rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_lock_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_rate_lock</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* already set */</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rec</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prepare callback for DSX playback on via823x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac97_rate</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_src</span> <span class="o">?</span> <span class="mi">48000</span> <span class="o">:</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_changed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rbits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rate_changed</span> <span class="o">=</span> <span class="n">via_lock_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97_rate</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rate_changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_changed</span><span class="p">)</span>
		<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span>
				  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">?</span> <span class="mi">48000</span> <span class="o">:</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_on</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">rbits</span> <span class="o">=</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rbits</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x100000</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">+</span>
			<span class="p">((</span><span class="mh">0x100000</span> <span class="o">%</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">rbits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfffff</span><span class="p">);</span>
	<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFS_PLAYBACK_VOLUME_L</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFS_PLAYBACK_VOLUME_R</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span> <span class="o">?</span> <span class="n">VIA8233_REG_TYPE_16BIT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* format */</span>
	     <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">VIA8233_REG_TYPE_STEREO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* stereo */</span>
	     <span class="n">rbits</span> <span class="o">|</span> <span class="cm">/* rate */</span>
	     <span class="mh">0xff000000</span><span class="p">,</span>    <span class="cm">/* STOP index is never reached */</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STOP_IDX</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prepare callback for multi-channel playback on via823x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_multi_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slots</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">via_lock_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_SURR_DAC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LFE_DAC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">VIA_REG_MULTPLAY_FMT_16BIT</span> <span class="o">:</span> <span class="n">VIA_REG_MULTPLAY_FMT_8BIT</span><span class="p">;</span>
	<span class="n">fmt</span> <span class="o">|=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFS_MULTPLAY_FORMAT</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (chip-&gt;revision == VIA_REV_8233A)</span>
<span class="c">		slots = 0;</span>
<span class="c">	else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="cm">/* set sample number to slot 3, 4, 7, 8, 6, 9 (for VIA8233/C,8235) */</span>
		<span class="cm">/* corresponding to FL, FR, RL, RR, C, LFE ?? */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>: <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">slots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* STOP index is never reached */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xff000000</span> <span class="o">|</span> <span class="n">slots</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STOP_IDX</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prepare callback for capture on via823x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">via_lock_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VIA_REG_CAPTURE_FIFO_ENABLE</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFS_CAPTURE_FIFO</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span> <span class="o">?</span> <span class="n">VIA8233_REG_TYPE_16BIT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">VIA8233_REG_TYPE_STEREO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	     <span class="mh">0xff000000</span><span class="p">,</span>    <span class="cm">/* STOP index is never reached */</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STOP_IDX</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pcm hardware definition, identical for both playback and capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_via82xx_hw</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="cm">/* SNDRV_PCM_INFO_RESUME | */</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="n">VIA_MAX_BUFSIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="n">VIA_MAX_BUFSIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="n">VIA_TABLE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * open callback skeleton</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_rate_lock</span> <span class="o">*</span><span class="n">ratep</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_src</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_via82xx_hw</span><span class="p">;</span>
	
	<span class="cm">/* set the hw rate condition */</span>
	<span class="n">ratep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">];</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ratep</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_on</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DXS#3 and spdif is on */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">AC97_RATES_SPDIF</span><span class="p">];</span>
		<span class="n">snd_pcm_limit_hw_rates</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_fixed</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fixed DXS playback rate */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_src</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use full SRC capabilities of DXS */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span>
				     <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="n">use_src</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ratep</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">?</span> <span class="n">AC97_RATES_ADC</span> <span class="o">:</span> <span class="n">AC97_RATES_FRONT_DAC</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">snd_pcm_limit_hw_rates</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* a fixed rate */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">ratep</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* we may remove following constaint when we modify table entries</span>
<span class="cm">	   in interrupt */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_rule_noresample</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">viadev</span><span class="p">;</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * open callback for playback on via686</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via686_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">+</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open callback for playback on via823x DXS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">+</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">stream</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">stream</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="p">(</span><span class="n">dxs_init_volume</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">stream</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="p">(</span><span class="n">dxs_init_volume</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
			       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open callback for playback on via823x multi-channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_multi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi_devno</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* channels constraint for VIA8233A</span>
<span class="cm">	 * 3 and 5 channels are not supported</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_channels</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span>
		<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">VIA_REV_8233A</span><span class="p">)</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hw_constraints_channels</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open callback for capture on via686 and via823x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">+</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">snd_via82xx_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * close callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_rate_lock</span> <span class="o">*</span><span class="n">ratep</span><span class="p">;</span>

	<span class="cm">/* release the rate lock */</span>
	<span class="n">ratep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">];</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ratep</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ratep</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span>
		<span class="n">ratep</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ratep</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ac97_update_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span>
					      <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">snd_ac97_update_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span>
					      <span class="n">AC97_PCM_SURR_DAC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">snd_ac97_update_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span>
					      <span class="n">AC97_PCM_LFE_DAC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">snd_ac97_update_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span>
					      <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">;</span>

	<span class="n">stream</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span>
			<span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_via82xx_pcm_close</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* via686 playback callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via686_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via686_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via686_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via686_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* via686 capture callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via686_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via82xx_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via686_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via686_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* via823x DSX playback callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via8233_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via8233_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via8233_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via8233_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via8233_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* via823x multi-channel playback callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via8233_multi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via8233_multi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via8233_multi_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via8233_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* via823x capture callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via8233_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via82xx_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via8233_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via8233_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_viadev</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_offset</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">shadow_pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">shadow_shift</span> <span class="o">=</span> <span class="n">shadow_pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create pcm instances for VIA8233, 8233C and 8235 (not 8233A)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via8233_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* x 4 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi_devno</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* x 1 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* x 2 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="mh">0x33033333</span><span class="p">;</span> <span class="cm">/* FLAG|EOL for rec0-1, mc, sdx0-3 */</span>

	<span class="cm">/* PCM #0:  4 DSX playbacks and 1 capture */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="cm">/* set up playbacks */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* capture */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span><span class="p">,</span> <span class="n">VIA_REG_CAPTURE_8233_STATUS</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">VIA_MAX_BUFSIZE</span><span class="p">);</span>

	<span class="cm">/* PCM #1:  multi-channel playback and 2nd capture */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_multi_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="cm">/* set up playback */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi_devno</span><span class="p">,</span> <span class="n">VIA_REG_MULTPLAY_STATUS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* set up capture */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VIA_REG_CAPTURE_8233_STATUS</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">VIA_MAX_BUFSIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create pcm instances for VIA8233A</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via8233a_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi_devno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="mh">0x03033000</span><span class="p">;</span> <span class="cm">/* FLAG|EOL for rec0, mc, sdx3 */</span>

	<span class="cm">/* PCM #0:  multi-channel playback and capture */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_multi_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="cm">/* set up playback */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi_devno</span><span class="p">,</span> <span class="n">VIA_REG_MULTPLAY_STATUS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* capture */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span><span class="p">,</span> <span class="n">VIA_REG_CAPTURE_8233_STATUS</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">VIA_MAX_BUFSIZE</span><span class="p">);</span>

	<span class="cm">/* SPDIF supported? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ac97_can_spdif</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* PCM #1:  DXS3 playback (for spdif) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via8233_playback_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="cm">/* set up playback */</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">VIA_MAX_BUFSIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a pcm instance for via686a/b</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via686_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span> <span class="cm">/* FLAG | EOL for PB, CP, FM */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via686_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via686_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VIA_REG_PLAYBACK_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VIA_REG_CAPTURE_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">VIA_MAX_BUFSIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Mixer part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_capture_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* formerly they were &quot;Line&quot; and &quot;Mic&quot;, but it looks like that they</span>
<span class="cm">	 * have nothing to do with the actual physical connections...</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Input1&quot;</span><span class="p">,</span> <span class="s">&quot;Input2&quot;</span>
	<span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_capture_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">?</span> <span class="p">(</span><span class="n">VIA_REG_CAPTURE_CHANNEL</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">:</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VIA_REG_CAPTURE_CHANNEL_MIC</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_capture_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">?</span> <span class="p">(</span><span class="n">VIA_REG_CAPTURE_CHANNEL</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">:</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">oval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VIA_REG_CAPTURE_CHANNEL_MIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA_REG_CAPTURE_CHANNEL_MIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_via8233_capture_source</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Input Source Select&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_via8233_capture_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_via8233_capture_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_via8233_capture_source_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define snd_via8233_dxs3_spdif_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_dxs3_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VIA8233_SPDIF_DX3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_dxs3_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oval</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">oval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VIA8233_SPDIF_DX3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA8233_SPDIF_DX3</span><span class="p">;</span>
	<span class="cm">/* save the spdif flag for rate filtering */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_on</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_via8233_dxs3_spdif_control</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Output &quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_via8233_dxs3_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_via8233_dxs3_spdif_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_via8233_dxs3_spdif_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_dxs_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_dxs_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_pcmdxs_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_dxs_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">VIA_DXS_MAX_VOLUME</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_OFS_PLAYBACK_VOLUME_L</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via8233_pcmdxs_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">VIA_DXS_MAX_VOLUME</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_DXS_MAX_VOLUME</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">idx</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_OFS_PLAYBACK_VOLUME_L</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_dxs</span><span class="p">,</span> <span class="o">-</span><span class="mi">4650</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_via8233_pcmdxs_volume_control</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
		   <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_via8233_dxs_volume_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_via8233_pcmdxs_volume_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_via8233_pcmdxs_volume_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_dxs</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_via8233_dxs_volume_control</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* .subdevice set later */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
		  <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span> <span class="o">|</span>
		  <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_via8233_dxs_volume_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_via8233_dxs_volume_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_via8233_dxs_volume_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_dxs</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97_quirk</span> <span class="n">ac97_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1106</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4161</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_id</span> <span class="o">=</span> <span class="mh">0x56494161</span><span class="p">,</span> <span class="cm">/* VT1612A */</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Soltek SL-75DRV5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_NONE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* FIXME: which codec? */</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1106</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4161</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ASRock K7VT2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x110a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0079</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Siemens D1289&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1019</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0a81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ECS K7VTA3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1019</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0a85</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ECS L7VMM2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1019</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x1841</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ECS K7VTA3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1849</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x3059</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ASRock K7VM2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>	<span class="cm">/* VT1616 */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x14cd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x7002</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_ALC_JACK</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1071</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x8590</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mitac Mobo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_ALC_JACK</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x161f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x202b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Arima Notebook&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x161f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2032</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Targa Traveller 811&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x161f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2032</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;m680x&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span><span class="p">,</span> <span class="cm">/* http://launchpad.net/bugs/38546 */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1297</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0xa232</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Shuttle AK32VN&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_mixer_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">quirk_override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_wait</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_free_ac97_bus</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_clock</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_SKIP_MODEM</span> <span class="o">|</span> <span class="n">AC97_SCAP_POWER_SAVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_ac97_tune_hardware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">ac97_quirks</span><span class="p">,</span> <span class="n">quirk_override</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use slot 10/11 */</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="cp">#define JOYSTICK_ADDR	0x200</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via686_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">legacy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">joystick</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">JOYSTICK_ADDR</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;VIA686 gameport&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;via82xx: cannot reserve joystick port 0x%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">JOYSTICK_ADDR</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via82xx: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;VIA686 Gameport&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">JOYSTICK_ADDR</span><span class="p">;</span>
	<span class="n">gameport_set_port_data</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Enable legacy joystick port */</span>
	<span class="o">*</span><span class="n">legacy</span> <span class="o">|=</span> <span class="n">VIA_FUNC_ENABLE_GAME</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">legacy</span><span class="p">);</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via686_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>

		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_via686_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">legacy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_via686_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via8233_init_misc</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caps</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">caps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA8233A</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">caps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via8233_capture_source</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_via8233_capture_source</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_can_spdif</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_via8233_dxs3_spdif_control</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA8233A</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* when no h/w PCM volume control is found, use DXS volume control</span>
<span class="cm">		 * as the PCM vol control</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">sid</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid</span><span class="p">));</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">);</span>
		<span class="n">sid</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Using DXS as PCM Playback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_via8233_pcmdxs_volume_control</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* Using DXS when PCM emulation is enabled is really weird */</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

				<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">snd_via8233_dxs_volume_control</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* select spdif data slot 10/11 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VIA8233_SPDIF_SLOT_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">VIA8233_SPDIF_SLOT_1011</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA8233_SPDIF_DX3</span><span class="p">;</span> <span class="cm">/* SPDIF off as default */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via686_init_misc</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">legacy</span><span class="p">,</span> <span class="n">legacy_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">legacy</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy</span><span class="p">;</span>
	<span class="n">legacy_cfg</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy_cfg</span><span class="p">;</span>
	<span class="n">legacy</span> <span class="o">|=</span> <span class="n">VIA_FUNC_MIDI_IRQMASK</span><span class="p">;</span>	<span class="cm">/* FIXME: correct? (disable MIDI) */</span>
	<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNC_ENABLE_GAME</span><span class="p">;</span>	<span class="cm">/* disable joystick */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">VIA_REV_686_H</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rev_h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span> <span class="o">&gt;=</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* force MIDI */</span>
			<span class="n">mpu_port</span> <span class="o">&amp;=</span> <span class="mh">0xfffc</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">mpu_port</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port_saved</span> <span class="o">=</span> <span class="n">mpu_port</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* force MIDI */</span>
		<span class="k">case</span> <span class="mh">0x300</span>:
		<span class="k">case</span> <span class="mh">0x310</span>:
		<span class="k">case</span> <span class="mh">0x320</span>:
		<span class="k">case</span> <span class="mh">0x330</span>:
			<span class="n">legacy_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">legacy_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mpu_port</span> <span class="o">&amp;</span> <span class="mh">0x0030</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>			<span class="cm">/* no, use BIOS settings */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span> <span class="o">&amp;</span> <span class="n">VIA_FUNC_ENABLE_MIDI</span><span class="p">)</span>
				<span class="n">mpu_port</span> <span class="o">=</span> <span class="mh">0x300</span> <span class="o">+</span> <span class="p">((</span><span class="n">legacy_cfg</span> <span class="o">&amp;</span> <span class="mh">0x000c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span> <span class="o">&gt;=</span> <span class="mh">0x200</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;VIA82xx MPU401&quot;</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev_h</span><span class="p">)</span>
			<span class="n">legacy</span> <span class="o">|=</span> <span class="n">VIA_FUNC_MIDI_PNP</span><span class="p">;</span>	<span class="cm">/* enable PCI I/O 2 */</span>
		<span class="n">legacy</span> <span class="o">|=</span> <span class="n">VIA_FUNC_ENABLE_MIDI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev_h</span><span class="p">)</span>
			<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNC_MIDI_PNP</span><span class="p">;</span>	<span class="cm">/* disable PCI I/O 2 */</span>
		<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNC_ENABLE_MIDI</span><span class="p">;</span>
		<span class="n">mpu_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="n">legacy</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_PNP_CONTROL</span><span class="p">,</span> <span class="n">legacy_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPU401_HW_VIA686A</span><span class="p">,</span>
					<span class="n">mpu_port</span><span class="p">,</span> <span class="n">MPU401_INFO_INTEGRATED</span> <span class="o">|</span>
					<span class="n">MPU401_INFO_IRQ_HOOK</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;unable to initialize MPU-401&quot;</span>
			       <span class="s">&quot; at 0x%lx, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpu_port</span><span class="p">);</span>
			<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNC_ENABLE_MIDI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNC_MIDI_IRQMASK</span><span class="p">;</span>	<span class="cm">/* enable MIDI interrupt */</span>
		<span class="p">}</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="n">legacy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_via686_create_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">legacy</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">legacy_saved</span> <span class="o">=</span> <span class="n">legacy</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">legacy_cfg_saved</span> <span class="o">=</span> <span class="n">legacy_cfg</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xa0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%02x: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;via82xx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_via82xx_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pval</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* broken on K7M? */</span>
<span class="c">	if (chip-&gt;chip_type == TYPE_VIA686)</span>
<span class="c">		/* disable all legacy ports */</span>
<span class="c">		pci_write_config_byte(chip-&gt;pci, VIA_FUNC_ENABLE, 0);</span>
<span class="cp">#endif</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_C00_READY</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* codec not ready? */</span>
		<span class="cm">/* deassert ACLink reset, force SYNC */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span>
				      <span class="n">VIA_ACLINK_CTRL_ENABLE</span> <span class="o">|</span>
				      <span class="n">VIA_ACLINK_CTRL_RESET</span> <span class="o">|</span>
				      <span class="n">VIA_ACLINK_CTRL_SYNC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#if 1 </span><span class="cm">/* FIXME: should we do full reset here for all chip models? */</span><span class="cp"></span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="cm">/* deassert ACLink reset, force SYNC (warm AC&#39;97 reset) */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span>
				      <span class="n">VIA_ACLINK_CTRL_RESET</span><span class="o">|</span><span class="n">VIA_ACLINK_CTRL_SYNC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* ACLink on, deassert ACLink reset, VSR, SGD data out */</span>
		<span class="cm">/* note - FM data out has trouble with non VRA codecs !! */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* Make sure VRA is enabled, in case we didn&#39;t do a</span>
<span class="cm">	 * complete codec reset, above */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ACLink on, deassert ACLink reset, VSR, SGD data out */</span>
		<span class="cm">/* note - FM data out has trouble with non VRA codecs !! */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait until codec ready */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_C00_READY</span><span class="p">)</span> <span class="cm">/* primary codec ready */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_AC97_BUSY</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 codec is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"> /* FIXME: we don&#39;t support the second codec yet so skip the detection now.. */</span>
<span class="c">	snd_via82xx_codec_xwrite(chip, VIA_REG_AC97_READ |</span>
<span class="c">				 VIA_REG_AC97_SECONDARY_VALID |</span>
<span class="c">				 (VIA_REG_AC97_CODEC_ID_SECONDARY &lt;&lt; VIA_REG_AC97_CODEC_ID_SHIFT));</span>
<span class="c">	end_time = jiffies + msecs_to_jiffies(750);</span>
<span class="c">	snd_via82xx_codec_xwrite(chip, VIA_REG_AC97_READ |</span>
<span class="c">				 VIA_REG_AC97_SECONDARY_VALID |</span>
<span class="c">				 (VIA_REG_AC97_CODEC_ID_SECONDARY &lt;&lt; VIA_REG_AC97_CODEC_ID_SHIFT));</span>
<span class="c">	do {</span>
<span class="c">		if ((val = snd_via82xx_codec_xread(chip)) &amp; VIA_REG_AC97_SECONDARY_VALID) {</span>
<span class="c">			chip-&gt;ac97_secondary = 1;</span>
<span class="c">			goto __ac97_ok2;</span>
<span class="c">		}</span>
<span class="c">		schedule_timeout_uninterruptible(1);</span>
<span class="c">	} while (time_before(jiffies, end_time));</span>
<span class="c">	/* This is ok, the most of motherboards have only one codec */</span>

<span class="c">      __ac97_ok2:</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* route FM trap to IRQ, disable FM trap */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FM_NMI_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* disable all GPI interrupts */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GPI_INTR</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Workaround for Award BIOS bug:</span>
<span class="cm">		 * DXS channels don&#39;t work properly with VRA if MC97 is disabled.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
		<span class="n">pci</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x1106</span><span class="p">,</span> <span class="mh">0x3068</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* MC97 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA8233A</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">idx</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_volume_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_OFS_PLAYBACK_VOLUME_L</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * power management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="cm">/* save misc values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_ctrl_saved</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_src_saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_src_saved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via82xx: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_via82xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port_saved</span><span class="p">)</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port_saved</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">legacy_saved</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_PNP_CONTROL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">legacy_cfg_saved</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA8233_SPDIF_CTRL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_ctrl_saved</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_src_saved</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_src_saved</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">VIA_REG_CAPTURE_CHANNEL</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end_hw</span><span class="p">;</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
 <span class="nl">__end_hw:</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_res</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via686_free_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_PNP_CONTROL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy_cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">revision</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">**</span> <span class="n">r_via</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_dev_free</span><span class="p">,</span>
        <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">revision</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_PNP_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy_cfg</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_FUNC_ENABLE</span><span class="p">,</span>
			      <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">VIA_FUNC_ENABLE_SB</span><span class="o">|</span><span class="n">VIA_FUNC_ENABLE_FM</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA8233</span> <span class="o">?</span>
			<span class="n">snd_via8233_interrupt</span> <span class="o">:</span>	<span class="n">snd_via686_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">&amp;&amp;</span> <span class="n">ac97_clock</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_clock</span> <span class="o">=</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The 8233 ac97 controller does not implement the master bit</span>
<span class="cm">	 * in the pci command register. IMHO this is a violation of the PCI spec.</span>
<span class="cm">	 * We call pci_set_master here because it does not hurt. */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_via</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">via823x_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">revision</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">via823x_info</span> <span class="n">via823x_cards</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">VIA_REV_PRE_8233</span><span class="p">,</span> <span class="s">&quot;VIA 8233-Pre&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8233C</span><span class="p">,</span> <span class="s">&quot;VIA 8233C&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8233</span><span class="p">,</span> <span class="s">&quot;VIA 8233&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8233A</span><span class="p">,</span> <span class="s">&quot;VIA 8233A&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8235</span><span class="p">,</span> <span class="s">&quot;VIA 8235&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8237</span><span class="p">,</span> <span class="s">&quot;VIA 8237&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VIA_REV_8251</span><span class="p">,</span> <span class="s">&quot;VIA 8251&quot;</span><span class="p">,</span> <span class="n">TYPE_VIA8233</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * auto detection of DXS channel supports.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">dxs_whitelist</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1005</span><span class="p">,</span> <span class="mh">0x4710</span><span class="p">,</span> <span class="s">&quot;Avance Logic Mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1019</span><span class="p">,</span> <span class="mh">0x0996</span><span class="p">,</span> <span class="s">&quot;ESC Mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_48K</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1019</span><span class="p">,</span> <span class="mh">0x0a81</span><span class="p">,</span> <span class="s">&quot;ECS K7VTA3 v8.0&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1019</span><span class="p">,</span> <span class="mh">0x0a85</span><span class="p">,</span> <span class="s">&quot;ECS L7VMM2&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1019</span><span class="p">,</span> <span class="s">&quot;ESC K8&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1019</span><span class="p">,</span> <span class="mh">0xaa01</span><span class="p">,</span> <span class="s">&quot;ESC K8T890-A&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="s">&quot;Acer Inspire 1353LM&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="s">&quot;Acer Aspire 1524 WLMi&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1043</span><span class="p">,</span> <span class="s">&quot;ASUS A7/A8&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1071</span><span class="p">,</span> <span class="s">&quot;Diverse Notebook&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x10cf</span><span class="p">,</span> <span class="mh">0x118e</span><span class="p">,</span> <span class="s">&quot;FSC Laptop&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1106</span><span class="p">,</span> <span class="s">&quot;ASRock&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1297</span><span class="p">,</span> <span class="mh">0xa231</span><span class="p">,</span> <span class="s">&quot;Shuttle AK31v2&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1297</span><span class="p">,</span> <span class="mh">0xa232</span><span class="p">,</span> <span class="s">&quot;Shuttle&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1297</span><span class="p">,</span> <span class="mh">0xc160</span><span class="p">,</span> <span class="s">&quot;Shuttle Sk41G&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1458</span><span class="p">,</span> <span class="mh">0xa002</span><span class="p">,</span> <span class="s">&quot;Gigabyte GA-7VAXP&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1462</span><span class="p">,</span> <span class="mh">0x3800</span><span class="p">,</span> <span class="s">&quot;MSI KT266&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1462</span><span class="p">,</span> <span class="mh">0x7120</span><span class="p">,</span> <span class="s">&quot;MSI KT4V&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1462</span><span class="p">,</span> <span class="mh">0x7142</span><span class="p">,</span> <span class="s">&quot;MSI K8MM-V&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1462</span><span class="p">,</span> <span class="s">&quot;MSI Mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x147b</span><span class="p">,</span> <span class="mh">0x1401</span><span class="p">,</span> <span class="s">&quot;ABIT KD7(-RAID)&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x147b</span><span class="p">,</span> <span class="mh">0x1411</span><span class="p">,</span> <span class="s">&quot;ABIT VA-20&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x147b</span><span class="p">,</span> <span class="mh">0x1413</span><span class="p">,</span> <span class="s">&quot;ABIT KV8 Pro&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x147b</span><span class="p">,</span> <span class="mh">0x1415</span><span class="p">,</span> <span class="s">&quot;ABIT AV8&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14ff</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="s">&quot;Twinhead mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x14ff</span><span class="p">,</span> <span class="mh">0x0408</span><span class="p">,</span> <span class="s">&quot;Twinhead laptop&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1558</span><span class="p">,</span> <span class="mh">0x4701</span><span class="p">,</span> <span class="s">&quot;Clevo D470&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1584</span><span class="p">,</span> <span class="mh">0x8120</span><span class="p">,</span> <span class="s">&quot;Diverse Laptop&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1584</span><span class="p">,</span> <span class="mh">0x8123</span><span class="p">,</span> <span class="s">&quot;Targa/Uniwill&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x161f</span><span class="p">,</span> <span class="mh">0x202b</span><span class="p">,</span> <span class="s">&quot;Amira Notebook&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x161f</span><span class="p">,</span> <span class="mh">0x2032</span><span class="p">,</span> <span class="s">&quot;m680x machines&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_48K</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1631</span><span class="p">,</span> <span class="mh">0xe004</span><span class="p">,</span> <span class="s">&quot;PB EasyNote 3174&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1695</span><span class="p">,</span> <span class="mh">0x3005</span><span class="p">,</span> <span class="s">&quot;EPoX EP-8K9A&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_ENABLE</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1695</span><span class="p">,</span> <span class="s">&quot;EPoX mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x16f3</span><span class="p">,</span> <span class="s">&quot;Jetway K8&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1734</span><span class="p">,</span> <span class="s">&quot;FSC Laptop&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1849</span><span class="p">,</span> <span class="mh">0x3059</span><span class="p">,</span> <span class="s">&quot;ASRock K7VM2&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_VENDOR</span><span class="p">(</span><span class="mh">0x1849</span><span class="p">,</span> <span class="s">&quot;ASRock mobo&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1919</span><span class="p">,</span> <span class="mh">0x200a</span><span class="p">,</span> <span class="s">&quot;Soltek SL-K8&quot;</span><span class="p">,</span>  <span class="n">VIA_DXS_NO_VRA</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x4005</span><span class="p">,</span> <span class="mh">0x4710</span><span class="p">,</span> <span class="s">&quot;MSI K7T266&quot;</span><span class="p">,</span> <span class="n">VIA_DXS_SRC</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">check_dxs_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">revision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">dxs_whitelist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;via82xx: DXS white list for %s found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for newer revision, default to DXS_SRC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">VIA_REV_8235</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VIA_DXS_SRC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * not detected, try 48k rate only to be sure.</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;via82xx: Assuming DXS channels with 48k fixed sample rate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         Please try dxs_support=5 option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         and report if it works on your machine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         For more details, read ALSA-Configuration.txt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VIA_DXS_48K</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via82xx</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card_type</span> <span class="o">=</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_CARD_VIA686</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;VIA686A&quot;</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;VIA 82C686A/B rev%x&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">chip_type</span> <span class="o">=</span> <span class="n">TYPE_VIA686</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_CARD_VIA8233</span>:
		<span class="n">chip_type</span> <span class="o">=</span> <span class="n">TYPE_VIA8233</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;VIA 823x rev%x&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">via823x_cards</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">via823x_cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip_type</span> <span class="o">=</span> <span class="n">via823x_cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">via823x_cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">TYPE_VIA8233A</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dxs_support</span> <span class="o">==</span> <span class="n">VIA_DXS_AUTO</span><span class="p">)</span>
				<span class="n">dxs_support</span> <span class="o">=</span> <span class="n">check_dxs_list</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
			<span class="cm">/* force to use VIA8233 or 8233A model according to</span>
<span class="cm">			 * dxs_support module option</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dxs_support</span> <span class="o">==</span> <span class="n">VIA_DXS_DISABLE</span><span class="p">)</span>
				<span class="n">chip_type</span> <span class="o">=</span> <span class="n">TYPE_VIA8233A</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">chip_type</span> <span class="o">=</span> <span class="n">TYPE_VIA8233</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA8233A</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;VIA8233A&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">VIA_REV_8237</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;VIA8237&quot;</span><span class="p">);</span> <span class="cm">/* no slog assignment */</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;VIA8233&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid card type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card_type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">chip_type</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
				      <span class="n">ac97_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_new</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_quirk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA686</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via686_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via686_init_misc</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">TYPE_VIA8233A</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via8233a_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>chip->dxs_fixed = 1; /* FIXME: use 48k for DXS #3? */</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via8233_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dxs_support</span> <span class="o">==</span> <span class="n">VIA_DXS_48K</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dxs_support</span> <span class="o">==</span> <span class="n">VIA_DXS_NO_VRA</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dxs_support</span> <span class="o">==</span> <span class="n">VIA_DXS_SRC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dxs_src</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via8233_init_misc</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s with %s at %#lx, irq %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		 <span class="n">snd_ac97_get_short_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">snd_via82xx_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__error:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_via82xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">via82xx_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_via82xx_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_via82xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_via82xx_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_via82xx_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_via82xx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">via82xx_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
