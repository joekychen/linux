<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › pcxhr › pcxhr_mix22.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pcxhr_mix22.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Digigram pcxhr compatible soundcards</span>
<span class="cm"> *</span>
<span class="cm"> * mixer interface for stereo cards</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004 by Digigram &lt;alsa@digigram.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &quot;pcxhr.h&quot;</span>
<span class="cp">#include &quot;pcxhr_core.h&quot;</span>
<span class="cp">#include &quot;pcxhr_mix22.h&quot;</span>


<span class="cm">/* registers used on the DSP and Xilinx (port 2) : HR stereo cards only */</span>
<span class="cp">#define PCXHR_DSP_RESET		0x20</span>
<span class="cp">#define PCXHR_XLX_CFG		0x24</span>
<span class="cp">#define PCXHR_XLX_RUER		0x28</span>
<span class="cp">#define PCXHR_XLX_DATA		0x2C</span>
<span class="cp">#define PCXHR_XLX_STATUS	0x30</span>
<span class="cp">#define PCXHR_XLX_LOFREQ	0x34</span>
<span class="cp">#define PCXHR_XLX_HIFREQ	0x38</span>
<span class="cp">#define PCXHR_XLX_CSUER		0x3C</span>
<span class="cp">#define PCXHR_XLX_SELMIC	0x40</span>

<span class="cp">#define PCXHR_DSP 2</span>

<span class="cm">/* byte access only ! */</span>
<span class="cp">#define PCXHR_INPB(mgr, x)	inb((mgr)-&gt;port[PCXHR_DSP] + (x))</span>
<span class="cp">#define PCXHR_OUTPB(mgr, x, data) outb((data), (mgr)-&gt;port[PCXHR_DSP] + (x))</span>


<span class="cm">/* values for PCHR_DSP_RESET register */</span>
<span class="cp">#define PCXHR_DSP_RESET_DSP	0x01</span>
<span class="cp">#define PCXHR_DSP_RESET_MUTE	0x02</span>
<span class="cp">#define PCXHR_DSP_RESET_CODEC	0x08</span>
<span class="cp">#define PCXHR_DSP_RESET_GPO_OFFSET	5</span>
<span class="cp">#define PCXHR_DSP_RESET_GPO_MASK	0x60</span>

<span class="cm">/* values for PCHR_XLX_CFG register */</span>
<span class="cp">#define PCXHR_CFG_SYNCDSP_MASK		0x80</span>
<span class="cp">#define PCXHR_CFG_DEPENDENCY_MASK	0x60</span>
<span class="cp">#define PCXHR_CFG_INDEPENDANT_SEL	0x00</span>
<span class="cp">#define PCXHR_CFG_MASTER_SEL		0x40</span>
<span class="cp">#define PCXHR_CFG_SLAVE_SEL		0x20</span>
<span class="cp">#define PCXHR_CFG_DATA_UER1_SEL_MASK	0x10	</span><span class="cm">/* 0 (UER0), 1(UER1) */</span><span class="cp"></span>
<span class="cp">#define PCXHR_CFG_DATAIN_SEL_MASK	0x08	</span><span class="cm">/* 0 (ana), 1 (UER) */</span><span class="cp"></span>
<span class="cp">#define PCXHR_CFG_SRC_MASK		0x04	</span><span class="cm">/* 0 (Bypass), 1 (SRC Actif) */</span><span class="cp"></span>
<span class="cp">#define PCXHR_CFG_CLOCK_UER1_SEL_MASK	0x02	</span><span class="cm">/* 0 (UER0), 1(UER1) */</span><span class="cp"></span>
<span class="cp">#define PCXHR_CFG_CLOCKIN_SEL_MASK	0x01	</span><span class="cm">/* 0 (internal), 1 (AES/EBU) */</span><span class="cp"></span>

<span class="cm">/* values for PCHR_XLX_DATA register */</span>
<span class="cp">#define PCXHR_DATA_CODEC	0x80</span>
<span class="cp">#define AKM_POWER_CONTROL_CMD	0xA007</span>
<span class="cp">#define AKM_RESET_ON_CMD	0xA100</span>
<span class="cp">#define AKM_RESET_OFF_CMD	0xA103</span>
<span class="cp">#define AKM_CLOCK_INF_55K_CMD	0xA240</span>
<span class="cp">#define AKM_CLOCK_SUP_55K_CMD	0xA24D</span>
<span class="cp">#define AKM_MUTE_CMD		0xA38D</span>
<span class="cp">#define AKM_UNMUTE_CMD		0xA30D</span>
<span class="cp">#define AKM_LEFT_LEVEL_CMD	0xA600</span>
<span class="cp">#define AKM_RIGHT_LEVEL_CMD	0xA700</span>

<span class="cm">/* values for PCHR_XLX_STATUS register - READ */</span>
<span class="cp">#define PCXHR_STAT_SRC_LOCK		0x01</span>
<span class="cp">#define PCXHR_STAT_LEVEL_IN		0x02</span>
<span class="cp">#define PCXHR_STAT_GPI_OFFSET		2</span>
<span class="cp">#define PCXHR_STAT_GPI_MASK		0x0C</span>
<span class="cp">#define PCXHR_STAT_MIC_CAPS		0x10</span>
<span class="cm">/* values for PCHR_XLX_STATUS register - WRITE */</span>
<span class="cp">#define PCXHR_STAT_FREQ_SYNC_MASK	0x01</span>
<span class="cp">#define PCXHR_STAT_FREQ_UER1_MASK	0x02</span>
<span class="cp">#define PCXHR_STAT_FREQ_SAVE_MASK	0x80</span>

<span class="cm">/* values for PCHR_XLX_CSUER register */</span>
<span class="cp">#define PCXHR_SUER1_BIT_U_READ_MASK	0x80</span>
<span class="cp">#define PCXHR_SUER1_BIT_C_READ_MASK	0x40</span>
<span class="cp">#define PCXHR_SUER1_DATA_PRESENT_MASK	0x20</span>
<span class="cp">#define PCXHR_SUER1_CLOCK_PRESENT_MASK	0x10</span>
<span class="cp">#define PCXHR_SUER_BIT_U_READ_MASK	0x08</span>
<span class="cp">#define PCXHR_SUER_BIT_C_READ_MASK	0x04</span>
<span class="cp">#define PCXHR_SUER_DATA_PRESENT_MASK	0x02</span>
<span class="cp">#define PCXHR_SUER_CLOCK_PRESENT_MASK	0x01</span>

<span class="cp">#define PCXHR_SUER_BIT_U_WRITE_MASK	0x02</span>
<span class="cp">#define PCXHR_SUER_BIT_C_WRITE_MASK	0x01</span>

<span class="cm">/* values for PCXHR_XLX_SELMIC register - WRITE */</span>
<span class="cp">#define PCXHR_SELMIC_PREAMPLI_OFFSET	2</span>
<span class="cp">#define PCXHR_SELMIC_PREAMPLI_MASK	0x0C</span>
<span class="cp">#define PCXHR_SELMIC_PHANTOM_ALIM	0x80</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g_hr222_p_level</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x00</span><span class="p">,</span>   <span class="cm">/* [000] -49.5 dB:	AKM[000] = -1.#INF dB	(mute) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [001] -49.0 dB:	AKM[001] = -48.131 dB	(diff=0.86920 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [002] -48.5 dB:	AKM[001] = -48.131 dB	(diff=0.36920 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [003] -48.0 dB:	AKM[001] = -48.131 dB	(diff=0.13080 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [004] -47.5 dB:	AKM[001] = -48.131 dB	(diff=0.63080 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [005] -46.5 dB:	AKM[001] = -48.131 dB	(diff=1.63080 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [006] -47.0 dB:	AKM[001] = -48.131 dB	(diff=1.13080 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [007] -46.0 dB:	AKM[001] = -48.131 dB	(diff=2.13080 dB) */</span>
    <span class="mh">0x01</span><span class="p">,</span>   <span class="cm">/* [008] -45.5 dB:	AKM[001] = -48.131 dB	(diff=2.63080 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [009] -45.0 dB:	AKM[002] = -42.110 dB	(diff=2.88980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [010] -44.5 dB:	AKM[002] = -42.110 dB	(diff=2.38980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [011] -44.0 dB:	AKM[002] = -42.110 dB	(diff=1.88980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [012] -43.5 dB:	AKM[002] = -42.110 dB	(diff=1.38980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [013] -43.0 dB:	AKM[002] = -42.110 dB	(diff=0.88980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [014] -42.5 dB:	AKM[002] = -42.110 dB	(diff=0.38980 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [015] -42.0 dB:	AKM[002] = -42.110 dB	(diff=0.11020 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [016] -41.5 dB:	AKM[002] = -42.110 dB	(diff=0.61020 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [017] -41.0 dB:	AKM[002] = -42.110 dB	(diff=1.11020 dB) */</span>
    <span class="mh">0x02</span><span class="p">,</span>   <span class="cm">/* [018] -40.5 dB:	AKM[002] = -42.110 dB	(diff=1.61020 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [019] -40.0 dB:	AKM[003] = -38.588 dB	(diff=1.41162 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [020] -39.5 dB:	AKM[003] = -38.588 dB	(diff=0.91162 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [021] -39.0 dB:	AKM[003] = -38.588 dB	(diff=0.41162 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [022] -38.5 dB:	AKM[003] = -38.588 dB	(diff=0.08838 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [023] -38.0 dB:	AKM[003] = -38.588 dB	(diff=0.58838 dB) */</span>
    <span class="mh">0x03</span><span class="p">,</span>   <span class="cm">/* [024] -37.5 dB:	AKM[003] = -38.588 dB	(diff=1.08838 dB) */</span>
    <span class="mh">0x04</span><span class="p">,</span>   <span class="cm">/* [025] -37.0 dB:	AKM[004] = -36.090 dB	(diff=0.91040 dB) */</span>
    <span class="mh">0x04</span><span class="p">,</span>   <span class="cm">/* [026] -36.5 dB:	AKM[004] = -36.090 dB	(diff=0.41040 dB) */</span>
    <span class="mh">0x04</span><span class="p">,</span>   <span class="cm">/* [027] -36.0 dB:	AKM[004] = -36.090 dB	(diff=0.08960 dB) */</span>
    <span class="mh">0x04</span><span class="p">,</span>   <span class="cm">/* [028] -35.5 dB:	AKM[004] = -36.090 dB	(diff=0.58960 dB) */</span>
    <span class="mh">0x05</span><span class="p">,</span>   <span class="cm">/* [029] -35.0 dB:	AKM[005] = -34.151 dB	(diff=0.84860 dB) */</span>
    <span class="mh">0x05</span><span class="p">,</span>   <span class="cm">/* [030] -34.5 dB:	AKM[005] = -34.151 dB	(diff=0.34860 dB) */</span>
    <span class="mh">0x05</span><span class="p">,</span>   <span class="cm">/* [031] -34.0 dB:	AKM[005] = -34.151 dB	(diff=0.15140 dB) */</span>
    <span class="mh">0x05</span><span class="p">,</span>   <span class="cm">/* [032] -33.5 dB:	AKM[005] = -34.151 dB	(diff=0.65140 dB) */</span>
    <span class="mh">0x06</span><span class="p">,</span>   <span class="cm">/* [033] -33.0 dB:	AKM[006] = -32.568 dB	(diff=0.43222 dB) */</span>
    <span class="mh">0x06</span><span class="p">,</span>   <span class="cm">/* [034] -32.5 dB:	AKM[006] = -32.568 dB	(diff=0.06778 dB) */</span>
    <span class="mh">0x06</span><span class="p">,</span>   <span class="cm">/* [035] -32.0 dB:	AKM[006] = -32.568 dB	(diff=0.56778 dB) */</span>
    <span class="mh">0x07</span><span class="p">,</span>   <span class="cm">/* [036] -31.5 dB:	AKM[007] = -31.229 dB	(diff=0.27116 dB) */</span>
    <span class="mh">0x07</span><span class="p">,</span>   <span class="cm">/* [037] -31.0 dB:	AKM[007] = -31.229 dB	(diff=0.22884 dB) */</span>
    <span class="mh">0x08</span><span class="p">,</span>   <span class="cm">/* [038] -30.5 dB:	AKM[008] = -30.069 dB	(diff=0.43100 dB) */</span>
    <span class="mh">0x08</span><span class="p">,</span>   <span class="cm">/* [039] -30.0 dB:	AKM[008] = -30.069 dB	(diff=0.06900 dB) */</span>
    <span class="mh">0x09</span><span class="p">,</span>   <span class="cm">/* [040] -29.5 dB:	AKM[009] = -29.046 dB	(diff=0.45405 dB) */</span>
    <span class="mh">0x09</span><span class="p">,</span>   <span class="cm">/* [041] -29.0 dB:	AKM[009] = -29.046 dB	(diff=0.04595 dB) */</span>
    <span class="mh">0x0a</span><span class="p">,</span>   <span class="cm">/* [042] -28.5 dB:	AKM[010] = -28.131 dB	(diff=0.36920 dB) */</span>
    <span class="mh">0x0a</span><span class="p">,</span>   <span class="cm">/* [043] -28.0 dB:	AKM[010] = -28.131 dB	(diff=0.13080 dB) */</span>
    <span class="mh">0x0b</span><span class="p">,</span>   <span class="cm">/* [044] -27.5 dB:	AKM[011] = -27.303 dB	(diff=0.19705 dB) */</span>
    <span class="mh">0x0b</span><span class="p">,</span>   <span class="cm">/* [045] -27.0 dB:	AKM[011] = -27.303 dB	(diff=0.30295 dB) */</span>
    <span class="mh">0x0c</span><span class="p">,</span>   <span class="cm">/* [046] -26.5 dB:	AKM[012] = -26.547 dB	(diff=0.04718 dB) */</span>
    <span class="mh">0x0d</span><span class="p">,</span>   <span class="cm">/* [047] -26.0 dB:	AKM[013] = -25.852 dB	(diff=0.14806 dB) */</span>
    <span class="mh">0x0e</span><span class="p">,</span>   <span class="cm">/* [048] -25.5 dB:	AKM[014] = -25.208 dB	(diff=0.29176 dB) */</span>
    <span class="mh">0x0e</span><span class="p">,</span>   <span class="cm">/* [049] -25.0 dB:	AKM[014] = -25.208 dB	(diff=0.20824 dB) */</span>
    <span class="mh">0x0f</span><span class="p">,</span>   <span class="cm">/* [050] -24.5 dB:	AKM[015] = -24.609 dB	(diff=0.10898 dB) */</span>
    <span class="mh">0x10</span><span class="p">,</span>   <span class="cm">/* [051] -24.0 dB:	AKM[016] = -24.048 dB	(diff=0.04840 dB) */</span>
    <span class="mh">0x11</span><span class="p">,</span>   <span class="cm">/* [052] -23.5 dB:	AKM[017] = -23.522 dB	(diff=0.02183 dB) */</span>
    <span class="mh">0x12</span><span class="p">,</span>   <span class="cm">/* [053] -23.0 dB:	AKM[018] = -23.025 dB	(diff=0.02535 dB) */</span>
    <span class="mh">0x13</span><span class="p">,</span>   <span class="cm">/* [054] -22.5 dB:	AKM[019] = -22.556 dB	(diff=0.05573 dB) */</span>
    <span class="mh">0x14</span><span class="p">,</span>   <span class="cm">/* [055] -22.0 dB:	AKM[020] = -22.110 dB	(diff=0.11020 dB) */</span>
    <span class="mh">0x15</span><span class="p">,</span>   <span class="cm">/* [056] -21.5 dB:	AKM[021] = -21.686 dB	(diff=0.18642 dB) */</span>
    <span class="mh">0x17</span><span class="p">,</span>   <span class="cm">/* [057] -21.0 dB:	AKM[023] = -20.896 dB	(diff=0.10375 dB) */</span>
    <span class="mh">0x18</span><span class="p">,</span>   <span class="cm">/* [058] -20.5 dB:	AKM[024] = -20.527 dB	(diff=0.02658 dB) */</span>
    <span class="mh">0x1a</span><span class="p">,</span>   <span class="cm">/* [059] -20.0 dB:	AKM[026] = -19.831 dB	(diff=0.16866 dB) */</span>
    <span class="mh">0x1b</span><span class="p">,</span>   <span class="cm">/* [060] -19.5 dB:	AKM[027] = -19.504 dB	(diff=0.00353 dB) */</span>
    <span class="mh">0x1d</span><span class="p">,</span>   <span class="cm">/* [061] -19.0 dB:	AKM[029] = -18.883 dB	(diff=0.11716 dB) */</span>
    <span class="mh">0x1e</span><span class="p">,</span>   <span class="cm">/* [062] -18.5 dB:	AKM[030] = -18.588 dB	(diff=0.08838 dB) */</span>
    <span class="mh">0x20</span><span class="p">,</span>   <span class="cm">/* [063] -18.0 dB:	AKM[032] = -18.028 dB	(diff=0.02780 dB) */</span>
    <span class="mh">0x22</span><span class="p">,</span>   <span class="cm">/* [064] -17.5 dB:	AKM[034] = -17.501 dB	(diff=0.00123 dB) */</span>
    <span class="mh">0x24</span><span class="p">,</span>   <span class="cm">/* [065] -17.0 dB:	AKM[036] = -17.005 dB	(diff=0.00475 dB) */</span>
    <span class="mh">0x26</span><span class="p">,</span>   <span class="cm">/* [066] -16.5 dB:	AKM[038] = -16.535 dB	(diff=0.03513 dB) */</span>
    <span class="mh">0x28</span><span class="p">,</span>   <span class="cm">/* [067] -16.0 dB:	AKM[040] = -16.090 dB	(diff=0.08960 dB) */</span>
    <span class="mh">0x2b</span><span class="p">,</span>   <span class="cm">/* [068] -15.5 dB:	AKM[043] = -15.461 dB	(diff=0.03857 dB) */</span>
    <span class="mh">0x2d</span><span class="p">,</span>   <span class="cm">/* [069] -15.0 dB:	AKM[045] = -15.067 dB	(diff=0.06655 dB) */</span>
    <span class="mh">0x30</span><span class="p">,</span>   <span class="cm">/* [070] -14.5 dB:	AKM[048] = -14.506 dB	(diff=0.00598 dB) */</span>
    <span class="mh">0x33</span><span class="p">,</span>   <span class="cm">/* [071] -14.0 dB:	AKM[051] = -13.979 dB	(diff=0.02060 dB) */</span>
    <span class="mh">0x36</span><span class="p">,</span>   <span class="cm">/* [072] -13.5 dB:	AKM[054] = -13.483 dB	(diff=0.01707 dB) */</span>
    <span class="mh">0x39</span><span class="p">,</span>   <span class="cm">/* [073] -13.0 dB:	AKM[057] = -13.013 dB	(diff=0.01331 dB) */</span>
    <span class="mh">0x3c</span><span class="p">,</span>   <span class="cm">/* [074] -12.5 dB:	AKM[060] = -12.568 dB	(diff=0.06778 dB) */</span>
    <span class="mh">0x40</span><span class="p">,</span>   <span class="cm">/* [075] -12.0 dB:	AKM[064] = -12.007 dB	(diff=0.00720 dB) */</span>
    <span class="mh">0x44</span><span class="p">,</span>   <span class="cm">/* [076] -11.5 dB:	AKM[068] = -11.481 dB	(diff=0.01937 dB) */</span>
    <span class="mh">0x48</span><span class="p">,</span>   <span class="cm">/* [077] -11.0 dB:	AKM[072] = -10.984 dB	(diff=0.01585 dB) */</span>
    <span class="mh">0x4c</span><span class="p">,</span>   <span class="cm">/* [078] -10.5 dB:	AKM[076] = -10.515 dB	(diff=0.01453 dB) */</span>
    <span class="mh">0x51</span><span class="p">,</span>   <span class="cm">/* [079] -10.0 dB:	AKM[081] = -9.961 dB	(diff=0.03890 dB) */</span>
    <span class="mh">0x55</span><span class="p">,</span>   <span class="cm">/* [080] -9.5 dB:	AKM[085] = -9.542 dB	(diff=0.04243 dB) */</span>
    <span class="mh">0x5a</span><span class="p">,</span>   <span class="cm">/* [081] -9.0 dB:	AKM[090] = -9.046 dB	(diff=0.04595 dB) */</span>
    <span class="mh">0x60</span><span class="p">,</span>   <span class="cm">/* [082] -8.5 dB:	AKM[096] = -8.485 dB	(diff=0.01462 dB) */</span>
    <span class="mh">0x66</span><span class="p">,</span>   <span class="cm">/* [083] -8.0 dB:	AKM[102] = -7.959 dB	(diff=0.04120 dB) */</span>
    <span class="mh">0x6c</span><span class="p">,</span>   <span class="cm">/* [084] -7.5 dB:	AKM[108] = -7.462 dB	(diff=0.03767 dB) */</span>
    <span class="mh">0x72</span><span class="p">,</span>   <span class="cm">/* [085] -7.0 dB:	AKM[114] = -6.993 dB	(diff=0.00729 dB) */</span>
    <span class="mh">0x79</span><span class="p">,</span>   <span class="cm">/* [086] -6.5 dB:	AKM[121] = -6.475 dB	(diff=0.02490 dB) */</span>
    <span class="mh">0x80</span><span class="p">,</span>   <span class="cm">/* [087] -6.0 dB:	AKM[128] = -5.987 dB	(diff=0.01340 dB) */</span>
    <span class="mh">0x87</span><span class="p">,</span>   <span class="cm">/* [088] -5.5 dB:	AKM[135] = -5.524 dB	(diff=0.02413 dB) */</span>
    <span class="mh">0x8f</span><span class="p">,</span>   <span class="cm">/* [089] -5.0 dB:	AKM[143] = -5.024 dB	(diff=0.02408 dB) */</span>
    <span class="mh">0x98</span><span class="p">,</span>   <span class="cm">/* [090] -4.5 dB:	AKM[152] = -4.494 dB	(diff=0.00607 dB) */</span>
    <span class="mh">0xa1</span><span class="p">,</span>   <span class="cm">/* [091] -4.0 dB:	AKM[161] = -3.994 dB	(diff=0.00571 dB) */</span>
    <span class="mh">0xaa</span><span class="p">,</span>   <span class="cm">/* [092] -3.5 dB:	AKM[170] = -3.522 dB	(diff=0.02183 dB) */</span>
    <span class="mh">0xb5</span><span class="p">,</span>   <span class="cm">/* [093] -3.0 dB:	AKM[181] = -2.977 dB	(diff=0.02277 dB) */</span>
    <span class="mh">0xbf</span><span class="p">,</span>   <span class="cm">/* [094] -2.5 dB:	AKM[191] = -2.510 dB	(diff=0.01014 dB) */</span>
    <span class="mh">0xcb</span><span class="p">,</span>   <span class="cm">/* [095] -2.0 dB:	AKM[203] = -1.981 dB	(diff=0.01912 dB) */</span>
    <span class="mh">0xd7</span><span class="p">,</span>   <span class="cm">/* [096] -1.5 dB:	AKM[215] = -1.482 dB	(diff=0.01797 dB) */</span>
    <span class="mh">0xe3</span><span class="p">,</span>   <span class="cm">/* [097] -1.0 dB:	AKM[227] = -1.010 dB	(diff=0.01029 dB) */</span>
    <span class="mh">0xf1</span><span class="p">,</span>   <span class="cm">/* [098] -0.5 dB:	AKM[241] = -0.490 dB	(diff=0.00954 dB) */</span>
    <span class="mh">0xff</span><span class="p">,</span>   <span class="cm">/* [099] +0.0 dB:	AKM[255] = +0.000 dB	(diff=0.00000 dB) */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hr222_config_akm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="cm">/* activate access to codec registers */</span>
	<span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_HIFREQ</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_DATA</span><span class="p">,</span>
			    <span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">?</span> <span class="n">PCXHR_DATA_CODEC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* termiate access to codec registers */</span>
	<span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_RUER</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_set_hw_playback_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_hr222_p_level</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">AKM_LEFT_LEVEL_CMD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">AKM_RIGHT_LEVEL_CMD</span><span class="p">;</span>

	<span class="cm">/* conversion from PmBoardCodedLevel to AKM nonlinear programming */</span>
	<span class="n">cmd</span> <span class="o">+=</span> <span class="n">g_hr222_p_level</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>

	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_set_hw_capture_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">level_l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level_r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level_mic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* program all input levels at the same time */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">capture_chips</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* no PCX22 */</span>

	<span class="n">data</span>  <span class="o">=</span> <span class="p">((</span><span class="n">level_mic</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* micro is mono, but apply */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">level_mic</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* level on both channels */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">level_r</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* line input right channel */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">level_l</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>		<span class="cm">/* line input left channel */</span>

	<span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_DATA</span><span class="p">);</span>	<span class="cm">/* activate input codec */</span>
	<span class="cm">/* send 32 bits (4 x 8 bits) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_DATA</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">?</span> <span class="n">PCXHR_DATA_CODEC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_RUER</span><span class="p">);</span>	<span class="cm">/* close input level codec */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hr222_micro_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hr222_sub_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_analog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* analog always available */</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">=</span> <span class="n">PCXHR_CFG_SYNCDSP_MASK</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PCXHR_STAT_MIC_CAPS</span><span class="p">)</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_mic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* microphone available */</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;MIC input available = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_mic</span><span class="p">);</span>

	<span class="cm">/* reset codec */</span>
	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_DSP_RESET</span><span class="p">,</span>
		    <span class="n">PCXHR_DSP_RESET_DSP</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_reset</span> <span class="o">=</span> <span class="n">PCXHR_DSP_RESET_DSP</span>  <span class="o">|</span>
			 <span class="n">PCXHR_DSP_RESET_MUTE</span> <span class="o">|</span>
			 <span class="n">PCXHR_DSP_RESET_CODEC</span><span class="p">;</span>
	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_DSP_RESET</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_reset</span><span class="p">);</span>
	<span class="cm">/* hr222_write_gpo(mgr, 0); does the same */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* config AKM */</span>
	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_POWER_CONTROL_CMD</span><span class="p">);</span>
	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_CLOCK_INF_55K_CMD</span><span class="p">);</span>
	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_UNMUTE_CMD</span><span class="p">);</span>
	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_RESET_OFF_CMD</span><span class="p">);</span>

	<span class="cm">/* init micro boost */</span>
	<span class="n">hr222_micro_boost</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* calc PLL register */</span>
<span class="cm">/* TODO : there is a very similar fct in pcxhr.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_pll_freq_register</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pllreg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">realfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">6900</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">219000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28224000</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0xC00</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realfreq</span><span class="p">)</span>
		<span class="o">*</span><span class="n">realfreq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28224000</span> <span class="o">/</span> <span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hr222_sub_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="n">pllreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">realfreq</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HR22_CLOCK_TYPE_INTERNAL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hr222_pll_freq_register</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">realfreq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCXHR_CFG_CLOCKIN_SEL_MASK</span> <span class="o">|</span>
				  <span class="n">PCXHR_CFG_CLOCK_UER1_SEL_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HR22_CLOCK_TYPE_AES_SYNC</span>:
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">|=</span> <span class="n">PCXHR_CFG_CLOCKIN_SEL_MASK</span><span class="p">;</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCXHR_CFG_CLOCK_UER1_SEL_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HR22_CLOCK_TYPE_AES_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_aes1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCXHR_CFG_CLOCKIN_SEL_MASK</span> <span class="o">|</span>
				 <span class="n">PCXHR_CFG_CLOCK_UER1_SEL_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_MUTE_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span> <span class="o">==</span> <span class="n">HR22_CLOCK_TYPE_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_HIFREQ</span><span class="p">,</span> <span class="n">pllreg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_LOFREQ</span><span class="p">,</span> <span class="n">pllreg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set clock source */</span>
	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CFG</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span><span class="p">);</span>

	<span class="cm">/* codec speed modes */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">55000</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">codec_speed</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">codec_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_CLOCK_INF_55K_CMD</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_CLOCK_SUP_55K_CMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span> <span class="o">=</span> <span class="n">realfreq</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">cur_clock_type</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hr222_config_akm</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">AKM_UNMUTE_CMD</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;set_clock to %dHz (realfreq=%d pllreg=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rate</span><span class="p">,</span> <span class="n">realfreq</span><span class="p">,</span> <span class="n">pllreg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hr222_get_external_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">pcxhr_clock_type</span> <span class="n">clock_type</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">calc_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_type</span> <span class="o">==</span> <span class="n">HR22_CLOCK_TYPE_AES_SYNC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCXHR_SUER_CLOCK_PRESENT_MASK</span> <span class="o">|</span>
			<span class="n">PCXHR_SUER_DATA_PRESENT_MASK</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PCXHR_STAT_FREQ_SYNC_MASK</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock_type</span> <span class="o">==</span> <span class="n">HR22_CLOCK_TYPE_AES_1</span> <span class="o">&amp;&amp;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_aes1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCXHR_SUER1_CLOCK_PRESENT_MASK</span> <span class="o">|</span>
			<span class="n">PCXHR_SUER1_DATA_PRESENT_MASK</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PCXHR_STAT_FREQ_UER1_MASK</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;get_external_clock : type %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">clock_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* other clocks not supported */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CSUER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;get_external_clock(%d) = 0 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock_type</span><span class="p">);</span>
		<span class="o">*</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no external clock locked */</span>
	<span class="p">}</span>

	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span> <span class="cm">/* calculate freq */</span>

	<span class="cm">/* save the measured clock frequency */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCXHR_STAT_FREQ_SAVE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">last_reg_stat</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>	<span class="cm">/* wait min 2 cycles of lowest freq (8000) */</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">last_reg_stat</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span> <span class="cm">/* save */</span>

	<span class="cm">/* get the frequency */</span>
	<span class="n">ticks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CFG</span><span class="p">);</span>
	<span class="n">ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ticks</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_DSP_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">calc_rate</span> <span class="o">=</span> <span class="mi">28224000</span> <span class="o">/</span> <span class="n">ticks</span><span class="p">;</span>
	<span class="cm">/* rounding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">184200</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">152200</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">112000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">92100</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">76100</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">56000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">46050</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">38050</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">28000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">23025</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">24000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">19025</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">22050</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">14000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">11512</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">9512</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">11025</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calc_rate</span> <span class="o">&gt;</span> <span class="mi">7000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;External clock is at %d Hz (measured %d Hz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rate</span><span class="p">,</span> <span class="n">calc_rate</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">hr222_read_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_gpi</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_gpi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_STATUS</span><span class="p">);</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PCXHR_STAT_GPI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			      <span class="n">PCXHR_STAT_GPI_OFFSET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_reset</span> <span class="o">&amp;</span> <span class="n">PCXHR_DSP_RESET_GPO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			 <span class="n">PCXHR_DSP_RESET_GPO_OFFSET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">hr222_write_gpo</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_reset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCXHR_DSP_RESET_GPO_MASK</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_DSP_RESET_GPO_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
	       <span class="n">PCXHR_DSP_RESET_GPO_MASK</span><span class="p">;</span>

	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_DSP_RESET</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_reset</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">hr222_update_analog_audio_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">is_capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hr222_update_analog_audio_level(%s chan=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">is_capture</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">level_l</span><span class="p">,</span> <span class="n">level_r</span><span class="p">,</span> <span class="n">level_mic</span><span class="p">;</span>
		<span class="cm">/* we have to update all levels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">level_l</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_volume</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">level_r</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_volume</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">level_l</span> <span class="o">=</span> <span class="n">HR222_LINE_CAPTURE_LEVEL_MIN</span><span class="p">;</span>
			<span class="n">level_r</span> <span class="o">=</span> <span class="n">HR222_LINE_CAPTURE_LEVEL_MIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_active</span><span class="p">)</span>
			<span class="n">level_mic</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_volume</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">level_mic</span> <span class="o">=</span> <span class="n">HR222_MICRO_CAPTURE_LEVEL_MIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">hr222_set_hw_capture_level</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span>
						 <span class="n">level_l</span><span class="p">,</span> <span class="n">level_r</span><span class="p">,</span> <span class="n">level_mic</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vol</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_playback_active</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span>
			<span class="n">vol</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_playback_volume</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">vol</span> <span class="o">=</span> <span class="n">HR222_LINE_PLAYBACK_LEVEL_MIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">hr222_set_hw_playback_level</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*texts[5] = {&quot;Line&quot;, &quot;Digital&quot;, &quot;Digi+SRC&quot;, &quot;Mic&quot;, &quot;Line+Mic&quot;}*/</span>
<span class="cp">#define SOURCE_LINE	0</span>
<span class="cp">#define SOURCE_DIGITAL	1</span>
<span class="cp">#define SOURCE_DIGISRC	2</span>
<span class="cp">#define SOURCE_MIC	3</span>
<span class="cp">#define SOURCE_LINEMIC	4</span>

<span class="kt">int</span> <span class="nf">hr222_set_audio_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">digital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* default analog source */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCXHR_CFG_SRC_MASK</span> <span class="o">|</span>
				<span class="n">PCXHR_CFG_DATAIN_SEL_MASK</span> <span class="o">|</span>
				<span class="n">PCXHR_CFG_DATA_UER1_SEL_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_DIGISRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">|=</span> <span class="n">PCXHR_CFG_SRC_MASK</span><span class="p">;</span>
		<span class="n">digital</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_DIGITAL</span><span class="p">)</span>
			<span class="n">digital</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">digital</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">|=</span>  <span class="n">PCXHR_CFG_DATAIN_SEL_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_aes1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get data from the AES1 plug */</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span> <span class="o">|=</span> <span class="n">PCXHR_CFG_DATA_UER1_SEL_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* chip-&gt;mic_active = 0; */</span>
		<span class="cm">/* chip-&gt;analog_capture_active = 0; */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">update_lvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_LINE</span> <span class="o">||</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_LINEMIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">update_lvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">analog_capture_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_MIC</span> <span class="o">||</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">audio_capture_source</span> <span class="o">==</span> <span class="n">SOURCE_LINEMIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">update_lvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">update_lvl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* capture: update all 3 mutes/unmutes with one call */</span>
			<span class="n">hr222_update_analog_audio_level</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* set the source infos (max 3 bits modified) */</span>
	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CFG</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">hr222_iec958_capture_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">aes_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aes_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">aes_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_aes1</span> <span class="o">?</span>
		<span class="n">PCXHR_SUER1_BIT_C_READ_MASK</span> <span class="o">:</span> <span class="n">PCXHR_SUER_BIT_C_READ_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_RUER</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* idx &lt; 192 */</span>
		<span class="n">temp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCXHR_INPB</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CSUER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;read iec958 AES %d byte %d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">aes_idx</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aes_bits</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">hr222_iec958_update_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">aes_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aes_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_bits</span> <span class="o">=</span> <span class="n">aes_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_bits</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aes_bits</span><span class="p">[</span><span class="n">aes_idx</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">aes_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">old_bits</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">new_bits</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* idx &lt; 192 */</span>
			<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_RUER</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="cm">/* write C and U bit */</span>
			<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_CSUER</span><span class="p">,</span> <span class="n">new_bits</span><span class="o">&amp;</span><span class="mh">0x01</span> <span class="o">?</span>
				    <span class="n">PCXHR_SUER_BIT_C_WRITE_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">old_bits</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">new_bits</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aes_bits</span><span class="p">[</span><span class="n">aes_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_bits</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hr222_micro_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boost_mask</span><span class="p">;</span>
	<span class="n">boost_mask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_SELMIC_PREAMPLI_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boost_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PCXHR_SELMIC_PREAMPLI_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* only values form 0 to 3 accepted */</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCXHR_SELMIC_PREAMPLI_MASK</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span> <span class="o">|=</span> <span class="n">boost_mask</span><span class="p">;</span>

	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_SELMIC</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hr222_micro_boost : set %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boost_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hr222_phantom_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="p">)</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span> <span class="o">|=</span> <span class="n">PCXHR_SELMIC_PHANTOM_ALIM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCXHR_SELMIC_PHANTOM_ALIM</span><span class="p">;</span>

	<span class="n">PCXHR_OUTPB</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_XLX_SELMIC</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">xlx_selmic</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hr222_phantom_power : set %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* mic level */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_mic_hr222</span><span class="p">,</span> <span class="o">-</span><span class="mi">9850</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">650</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">HR222_MICRO_CAPTURE_LEVEL_MIN</span><span class="p">;</span> <span class="cm">/* -98 dB */</span>
	<span class="cm">/* gains from 9 dB to 31.5 dB not recommended; use micboost instead */</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">HR222_MICRO_CAPTURE_LEVEL_MAX</span><span class="p">;</span> <span class="cm">/*  +7 dB */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_volume</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_volume</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_volume</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">hr222_update_analog_audio_level</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">hr222_control_mic_level</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
			 <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">hr222_mic_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">hr222_mic_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">hr222_mic_vol_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_mic_hr222</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/* mic boost level */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_micboost_hr222</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">5400</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_boost_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  0 dB */</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 54 dB */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_boost_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_boost</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_mic_boost_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_boost</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_boost</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">hr222_micro_boost</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mic_boost</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">hr222_control_mic_boost</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
			 <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;MicBoost Capture Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">hr222_mic_boost_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">hr222_mic_boost_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">hr222_mic_boost_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_micboost_hr222</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/******************* Phantom power switch *******************/</span>
<span class="cp">#define hr222_phantom_power_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_phantom_power_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phantom_power</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hr222_phantom_power_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">power</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phantom_power</span> <span class="o">!=</span> <span class="n">power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hr222_phantom_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phantom_power</span> <span class="o">=</span> <span class="n">power</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mixer_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">hr222_phantom_power_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Phantom Power Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">hr222_phantom_power_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">hr222_phantom_power_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">hr222_phantom_power_put</span><span class="p">,</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">hr222_add_mic_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_mic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* controls */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr222_control_mic_level</span><span class="p">,</span>
						   <span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr222_control_mic_boost</span><span class="p">,</span>
						   <span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hr222_phantom_power_switch</span><span class="p">,</span>
						   <span class="n">chip</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
