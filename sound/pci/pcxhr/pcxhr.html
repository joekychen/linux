<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › pcxhr › pcxhr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pcxhr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Digigram pcxhr compatible soundcards</span>
<span class="cm"> *</span>
<span class="cm"> * main file with alsa callbacks</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004 by Digigram &lt;alsa@digigram.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &quot;pcxhr.h&quot;</span>
<span class="cp">#include &quot;pcxhr_mixer.h&quot;</span>
<span class="cp">#include &quot;pcxhr_hwdep.h&quot;</span>
<span class="cp">#include &quot;pcxhr_core.h&quot;</span>
<span class="cp">#include &quot;pcxhr_mix22.h&quot;</span>

<span class="cp">#define DRIVER_NAME &quot;pcxhr&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Markus Bollinger &lt;bollinger@digigram.com&gt;, &quot;</span>
	      <span class="s">&quot;Marc Titinger &lt;titinger@digigram.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Digigram &quot;</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot; &quot;</span> <span class="n">PCXHR_DRIVER_VERSION_STRING</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Digigram,&quot;</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span><span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">mono</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>				<span class="cm">/* capture  mono only */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Digigram &quot;</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot; soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Digigram &quot;</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot; soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Digigram &quot;</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot; soundcard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mono</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mono</span><span class="p">,</span> <span class="s">&quot;Mono capture mode (default is stereo)&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PCI_ID_VX882HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX882HR</span><span class="p">,</span>
	<span class="n">PCI_ID_VX881HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX881HR</span><span class="p">,</span>
	<span class="n">PCI_ID_VX882E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX882E</span><span class="p">,</span>
	<span class="n">PCI_ID_VX881E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX881E</span><span class="p">,</span>
	<span class="n">PCI_ID_VX1222HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX1222HR</span><span class="p">,</span>
	<span class="n">PCI_ID_VX1221HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX1221HR</span><span class="p">,</span>
	<span class="n">PCI_ID_VX1222E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX1222E</span><span class="p">,</span>
	<span class="n">PCI_ID_VX1221E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX1221E</span><span class="p">,</span>
	<span class="n">PCI_ID_VX222HR</span><span class="p">,</span>
	<span class="n">PCI_ID_VX222E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX22HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX22E</span><span class="p">,</span>
	<span class="n">PCI_ID_VX222HRMIC</span><span class="p">,</span>
	<span class="n">PCI_ID_VX222E_MIC</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX924HR</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX924E</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX924HRMIC</span><span class="p">,</span>
	<span class="n">PCI_ID_PCX924E_MIC</span><span class="p">,</span>
	<span class="n">PCI_ID_LAST</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcxhr_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX882HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX882HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb201</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX881HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb301</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX881HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb021</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX882E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb121</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX882E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb221</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX881E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb321</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX881E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb401</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX1222HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb501</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX1222HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb601</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX1221HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9656</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb701</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX1221HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb421</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX1222E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb521</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX1222E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb621</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX1221E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xb721</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX1221E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xba01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX222HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xba21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX222E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbd01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX22HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbd21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX22E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbc01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX222HRMIC</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbc21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_VX222E_MIC</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbb01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX924HR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbb21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX924E</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbf01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX924HRMIC</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10b5</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0x1369</span><span class="p">,</span> <span class="mh">0xbf21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_ID_PCX924E_MIC</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pcxhr_ids</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">board_parameters</span> <span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">board_name</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">playback_chips</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">capture_chips</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">fw_file_set</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">firmware_num</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">board_parameters</span> <span class="n">pcxhr_board_params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">[</span><span class="n">PCI_ID_VX882HR</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;VX882HR&quot;</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX882HR</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;PCX882HR&quot;</span><span class="p">,</span>     <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX881HR</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;VX881HR&quot;</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX881HR</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;PCX881HR&quot;</span><span class="p">,</span>     <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX882E</span><span class="p">]</span> <span class="o">=</span>       <span class="p">{</span> <span class="s">&quot;VX882e&quot;</span><span class="p">,</span>       <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX882E</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;PCX882e&quot;</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX881E</span><span class="p">]</span> <span class="o">=</span>       <span class="p">{</span> <span class="s">&quot;VX881e&quot;</span><span class="p">,</span>       <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX881E</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;PCX881e&quot;</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX1222HR</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;VX1222HR&quot;</span><span class="p">,</span>     <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX1222HR</span><span class="p">]</span> <span class="o">=</span>    <span class="p">{</span> <span class="s">&quot;PCX1222HR&quot;</span><span class="p">,</span>    <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX1221HR</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;VX1221HR&quot;</span><span class="p">,</span>     <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX1221HR</span><span class="p">]</span> <span class="o">=</span>    <span class="p">{</span> <span class="s">&quot;PCX1221HR&quot;</span><span class="p">,</span>    <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX1222E</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;VX1222e&quot;</span><span class="p">,</span>      <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX1222E</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;PCX1222e&quot;</span><span class="p">,</span>     <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX1221E</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;VX1221e&quot;</span><span class="p">,</span>      <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX1221E</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;PCX1221e&quot;</span><span class="p">,</span>     <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX222HR</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;VX222HR&quot;</span><span class="p">,</span>      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX222E</span><span class="p">]</span> <span class="o">=</span>       <span class="p">{</span> <span class="s">&quot;VX222e&quot;</span><span class="p">,</span>       <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX22HR</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;PCX22HR&quot;</span><span class="p">,</span>      <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX22E</span><span class="p">]</span> <span class="o">=</span>       <span class="p">{</span> <span class="s">&quot;PCX22e&quot;</span><span class="p">,</span>       <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX222HRMIC</span><span class="p">]</span> <span class="o">=</span>   <span class="p">{</span> <span class="s">&quot;VX222HR-Mic&quot;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_VX222E_MIC</span><span class="p">]</span> <span class="o">=</span>   <span class="p">{</span> <span class="s">&quot;VX222e-Mic&quot;</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX924HR</span><span class="p">]</span> <span class="o">=</span>     <span class="p">{</span> <span class="s">&quot;PCX924HR&quot;</span><span class="p">,</span>     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX924E</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span> <span class="s">&quot;PCX924e&quot;</span><span class="p">,</span>      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX924HRMIC</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span> <span class="s">&quot;PCX924HR-Mic&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">[</span><span class="n">PCI_ID_PCX924E_MIC</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span> <span class="s">&quot;PCX924e-Mic&quot;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* boards without hw AES1 and SRC onboard are all using fw_file_set==4 */</span>
<span class="cm">/* VX222HR, VX222e, PCX22HR and PCX22e */</span>
<span class="cp">#define PCXHR_BOARD_HAS_AES1(x) (x-&gt;fw_file_set != 4)</span>
<span class="cm">/* some boards do not support 192kHz on digital AES input plugs */</span>
<span class="cp">#define PCXHR_BOARD_AESIN_NO_192K(x) ((x-&gt;capture_chips == 0) || \</span>
<span class="cp">				      (x-&gt;fw_file_set == 0)   || \</span>
<span class="cp">				      (x-&gt;fw_file_set == 2))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_pll_freq_register</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">pllreg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">realfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">6900</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">110000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28224000</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pllreg</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realfreq</span><span class="p">)</span>
		<span class="o">*</span><span class="n">realfreq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28224000</span> <span class="o">/</span> <span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define PCXHR_FREQ_REG_MASK		0x1f</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_48000		0x00</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_24000		0x01</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_12000		0x09</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_32000		0x08</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_16000		0x04</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_8000		0x0c</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_44100		0x02</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_22050		0x0a</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_11025		0x06</span>
<span class="cp">#define PCXHR_FREQ_PLL			0x05</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_192000	0x10</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_96000		0x18</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_176400	0x14</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_88200		0x1c</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_128000	0x12</span>
<span class="cp">#define PCXHR_FREQ_QUARTZ_64000		0x1a</span>

<span class="cp">#define PCXHR_FREQ_WORD_CLOCK		0x0f</span>
<span class="cp">#define PCXHR_FREQ_SYNC_AES		0x0e</span>
<span class="cp">#define PCXHR_FREQ_AES_1		0x07</span>
<span class="cp">#define PCXHR_FREQ_AES_2		0x0b</span>
<span class="cp">#define PCXHR_FREQ_AES_3		0x03</span>
<span class="cp">#define PCXHR_FREQ_AES_4		0x0d</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_get_clock_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">realfreq</span><span class="p">,</span> <span class="n">pllreg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">realfreq</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_INTERNAL</span> :	<span class="cm">/* clock by quartz or pll */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">48000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_48000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_24000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_12000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_32000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_16000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_8000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">44100</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_44100</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">22050</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_22050</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">11025</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_11025</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">192000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_192000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">96000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_96000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">176400</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_176400</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">88200</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_88200</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_128000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64000</span> :	<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_QUARTZ_64000</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_PLL</span><span class="p">;</span>
			<span class="cm">/* get the value for the pll register */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_pll_freq_register</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">realfreq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_ACCESS_IO_WRITE</span><span class="p">);</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IO_NUM_REG_GENCLK</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pllreg</span> <span class="o">&amp;</span> <span class="n">MASK_DSP_WORD</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pllreg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					   <span class="s">&quot;error CMD_ACCESS_IO_WRITE &quot;</span>
					   <span class="s">&quot;for PLL register : %x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_WORD_CLOCK</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_WORD_CLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_SYNC</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_SYNC_AES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_AES_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_AES_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_AES_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">PCXHR_FREQ_AES_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">realfreq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_sub_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">realfreq</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_get_clock_reg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">realfreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* codec speed modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">55000</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* single speed */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* dual speed */</span>
	<span class="k">else</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* quad speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">codec_speed</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_ACCESS_IO_WRITE</span><span class="p">);</span> <span class="cm">/* mute outputs */</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IO_NUM_REG_MUTE_OUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DSP_EXT_CMD_SET</span><span class="p">(</span><span class="n">mgr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_ACCESS_IO_WRITE</span><span class="p">);</span> <span class="cm">/* set speed ratio */</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IO_NUM_SPEED_RATIO</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set the new frequency */</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;clock register : set %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_write_io_num_reg_cont</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">PCXHR_FREQ_REG_MASK</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span> <span class="o">=</span> <span class="n">realfreq</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">cur_clock_type</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span><span class="p">;</span>

	<span class="cm">/* unmute after codec speed modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">codec_speed</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_ACCESS_IO_READ</span><span class="p">);</span> <span class="cm">/* unmute outputs */</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IO_NUM_REG_MUTE_OUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DSP_EXT_CMD_SET</span><span class="p">(</span><span class="n">mgr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">codec_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>	<span class="cm">/* save new codec speed */</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_sub_set_clock to %dHz (realfreq=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rate</span><span class="p">,</span> <span class="n">realfreq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PCXHR_MODIFY_CLOCK_S_BIT	0x04</span>

<span class="cp">#define PCXHR_IRQ_TIMER_FREQ		92000</span>
<span class="cp">#define PCXHR_IRQ_TIMER_PERIOD		48</span>

<span class="kt">int</span> <span class="nf">pcxhr_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">changed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hr222_sub_set_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">changed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_sub_set_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">changed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_MODIFY_CLOCK</span><span class="p">);</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PCXHR_MODIFY_CLOCK_S_BIT</span><span class="p">;</span> <span class="cm">/* resync fifos  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">PCXHR_IRQ_TIMER_FREQ</span><span class="p">)</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCXHR_IRQ_TIMER_PERIOD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCXHR_IRQ_TIMER_PERIOD</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_sub_get_external_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">pcxhr_clock_type</span> <span class="n">clock_type</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clock_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_WORD_CLOCK</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_WORD_CLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_SYNC</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_AES_SYNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_AES_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_AES_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_3</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_AES_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCXHR_CLOCK_TYPE_AES_4</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_STATUS_AES_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_ACCESS_IO_READ</span><span class="p">);</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IO_NUM_REG_STATUS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">last_reg_stat</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>	<span class="cm">/* wait minimum 2 sample_frames at 32kHz ! */</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">last_reg_stat</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">REG_STATUS_CURRENT</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_32000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_44100</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_48000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_64000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_88200</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_96000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_128000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_176400</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_STATUS_SYNC_192000</span> :	<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;External clock is at %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pcxhr_get_external_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">pcxhr_clock_type</span> <span class="n">clock_type</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hr222_get_external_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">clock_type</span><span class="p">,</span>
						<span class="n">sample_rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pcxhr_sub_get_external_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">clock_type</span><span class="p">,</span>
						    <span class="n">sample_rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  start or stop playback/capture substream</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_set_stream_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream_mask</span><span class="p">,</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PCXHR_STREAM_STATUS_SCHEDULE_RUN</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">PCXHR_STREAM_STATUS_SCHEDULE_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR pcxhr_set_stream_state &quot;</span>
				   <span class="s">&quot;CANNOT be stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_abs_periods</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_period_frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reset theoretical stream pos */</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_buf_periods</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_is_synced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stream_mask</span> <span class="o">=</span>
	  <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">is_capture</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">start</span> <span class="o">?</span> <span class="n">CMD_START_STREAM</span> <span class="o">:</span> <span class="n">CMD_STOP_STREAM</span><span class="p">);</span>
	<span class="n">pcxhr_set_pipe_cmd_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">is_capture</span><span class="p">,</span>
				  <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stream_mask</span><span class="p">);</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR pcxhr_set_stream_state err=%x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">err</span><span class="p">);</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
	  <span class="n">start</span> <span class="o">?</span> <span class="n">PCXHR_STREAM_STATUS_STARTED</span> <span class="o">:</span> <span class="n">PCXHR_STREAM_STATUS_STOPPED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HEADER_FMT_BASE_LIN		0xfed00000</span>
<span class="cp">#define HEADER_FMT_BASE_FLOAT		0xfad00000</span>
<span class="cp">#define HEADER_FMT_INTEL		0x00008000</span>
<span class="cp">#define HEADER_FMT_24BITS		0x00004000</span>
<span class="cp">#define HEADER_FMT_16BITS		0x00002000</span>
<span class="cp">#define HEADER_FMT_UPTO11		0x00000200</span>
<span class="cp">#define HEADER_FMT_UPTO32		0x00000100</span>
<span class="cp">#define HEADER_FMT_MONO			0x00000080</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">stream_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">header</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_LIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_LIN</span> <span class="o">|</span>
			 <span class="n">HEADER_FMT_16BITS</span> <span class="o">|</span> <span class="n">HEADER_FMT_INTEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_LIN</span> <span class="o">|</span> <span class="n">HEADER_FMT_16BITS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3LE</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_LIN</span> <span class="o">|</span>
			 <span class="n">HEADER_FMT_24BITS</span> <span class="o">|</span> <span class="n">HEADER_FMT_INTEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3BE</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_LIN</span> <span class="o">|</span> <span class="n">HEADER_FMT_24BITS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_FLOAT_LE</span>:
		<span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_FMT_BASE_FLOAT</span> <span class="o">|</span> <span class="n">HEADER_FMT_INTEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;error pcxhr_set_format() : unknown format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">sample_rate</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample_rate</span> <span class="o">&lt;=</span> <span class="mi">32000</span> <span class="o">&amp;&amp;</span> <span class="n">sample_rate</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sample_rate</span> <span class="o">&lt;=</span> <span class="mi">11025</span><span class="p">)</span>
			<span class="n">header</span> <span class="o">|=</span> <span class="n">HEADER_FMT_UPTO11</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">header</span> <span class="o">|=</span> <span class="n">HEADER_FMT_UPTO32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">header</span> <span class="o">|=</span> <span class="n">HEADER_FMT_MONO</span><span class="p">;</span>

	<span class="n">is_capture</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">is_capture</span><span class="p">;</span>
	<span class="n">stream_num</span> <span class="o">=</span> <span class="n">is_capture</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">is_capture</span> <span class="o">?</span>
		       <span class="n">CMD_FORMAT_STREAM_IN</span> <span class="o">:</span> <span class="n">CMD_FORMAT_STREAM_OUT</span><span class="p">);</span>
	<span class="n">pcxhr_set_pipe_cmd_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">,</span>
				  <span class="n">stream_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bug with old dsp versions: */</span>
		<span class="cm">/* bit 12 also sets the format of the playback stream */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DSP_EXT_CMD_SET</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">))</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DSP_EXT_CMD_SET</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* add channels and set bit 19 if channels&gt;2 */</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_capture</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* playback : add channel mask to command */</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR pcxhr_set_format err=%x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_update_r_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">stream_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">is_capture</span> <span class="o">=</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
	<span class="n">stream_num</span> <span class="o">=</span> <span class="n">is_capture</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_update_r_buffer(pcm%c%d) : &quot;</span>
		    <span class="s">&quot;addr(%p) bytes(%zx) subs(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">is_capture</span> <span class="o">?</span> <span class="sc">&#39;c&#39;</span> <span class="o">:</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
		    <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_UPDATE_R_BUFFERS</span><span class="p">);</span>
	<span class="n">pcxhr_set_pipe_cmd_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">is_capture</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">,</span>
				  <span class="n">stream_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* max buffer size is 2 MByte */</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">&gt;=</span> <span class="mh">0x200000</span><span class="p">);</span>
	<span class="cm">/* size in bits */</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* most significant byte */</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="cm">/* this is a circular buffer */</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">;</span>
	<span class="cm">/* least 3 significant bytes */</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">&amp;</span> <span class="n">MASK_DSP_WORD</span><span class="p">;</span>
	<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;ERROR CMD_UPDATE_R_BUFFERS err=%x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int pcxhr_pipe_sample_count(struct pcxhr_stream *stream,</span>
<span class="c">				   snd_pcm_uframes_t *sample_count)</span>
<span class="c">{</span>
<span class="c">	struct pcxhr_rmh rmh;</span>
<span class="c">	int err;</span>
<span class="c">	pcxhr_t *chip = snd_pcm_substream_chip(stream-&gt;substream);</span>
<span class="c">	pcxhr_init_rmh(&amp;rmh, CMD_PIPE_SAMPLE_COUNT);</span>
<span class="c">	pcxhr_set_pipe_cmd_params(&amp;rmh, stream-&gt;pipe-&gt;is_capture, 0, 0,</span>
<span class="c">				  1&lt;&lt;stream-&gt;pipe-&gt;first_audio);</span>
<span class="c">	err = pcxhr_send_msg(chip-&gt;mgr, &amp;rmh);</span>
<span class="c">	if (err == 0) {</span>
<span class="c">		*sample_count = ((snd_pcm_uframes_t)rmh.stat[0]) &lt;&lt; 24;</span>
<span class="c">		*sample_count += (snd_pcm_uframes_t)rmh.stat[1];</span>
<span class="c">	}</span>
<span class="c">	snd_printdd(&quot;PIPE_SAMPLE_COUNT = %lx\n&quot;, *sample_count);</span>
<span class="c">	return err;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">pcxhr_pipe</span> <span class="o">**</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PCXHR_STREAM_STATUS_SCHEDULE_RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcxhr_trigger_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span><span class="o">*</span><span class="p">)(</span><span class="n">arg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">capture_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">playback_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG_VERBOSE</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">my_tv1</span><span class="p">,</span> <span class="n">my_tv2</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_tv1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="cm">/* check the pipes concerned and build pipe_array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span>
				<span class="n">capture_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">playback_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* add only once, as all playback</span>
<span class="cm">					 * streams of one chip use the same pipe</span>
<span class="cm">					 */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capture_mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">playback_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcxhr_trigger_tasklet : no pipes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_trigger_tasklet : &quot;</span>
		    <span class="s">&quot;playback_mask=%x capture_mask=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">playback_mask</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">);</span>

	<span class="cm">/* synchronous stop of all the pipes concerned */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_pipe_state</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span>  <span class="n">playback_mask</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcxhr_trigger_tasklet : &quot;</span>
			   <span class="s">&quot;error stop pipes (P%x C%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">playback_mask</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the dsp lost format and buffer info with the stop pipe */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_format</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_update_r_buffer</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_format</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_update_r_buffer</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* start all the streams */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_stream_scheduled_get_pipe</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* synchronous start of all the pipes concerned */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_pipe_state</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">playback_mask</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcxhr_trigger_tasklet : &quot;</span>
			   <span class="s">&quot;error start pipes (P%x C%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">playback_mask</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put the streams into the running state now</span>
<span class="cm">	 * (increment pointer by interrupt)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PCXHR_STREAM_STATUS_STARTED</span><span class="p">)</span>
				<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_RUNNING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PCXHR_STREAM_STATUS_STARTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* playback will already have advanced ! */</span>
				<span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_period_frag</span> <span class="o">+=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">;</span>
				<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_RUNNING</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG_VERBOSE</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_tv2</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;***TRIGGER TASKLET*** TIME = %ld (err = %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">my_tv2</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">my_tv1</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  trigger callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_TRIGGER_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_stream_linked</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
			<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chip</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">stream</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
				<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">PCXHR_STREAM_STATUS_SCHEDULE_RUN</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">trigger_taskq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Only one Substream %c %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">is_capture</span> <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span>
				    <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">first_audio</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_set_format</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_update_r_buffer</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_SCHEDULE_RUN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_RUNNING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_TRIGGER_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_SCHEDULE_STOP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="cm">/* TODO */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_hardware_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_SET_TIMER_INTERRUPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* last dsp time invalid */</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_time_last</span> <span class="o">=</span> <span class="n">PCXHR_DSP_TIME_INVALID</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error pcxhr_hardware_timer err(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  prepare callback for all pcms</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_prepare : period_size(%lx) periods(%x) buffer_size(%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">,</span>
		    <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* only the first stream can choose the sample rate */</span>
		<span class="cm">/* set the clock only once (first stream) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">!=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_set_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* start the DSP-timer */</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_hardware_timer</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* do only once (so we can use break instead of goto) */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  HW_PARAMS callback for all pcms</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* set up channels */</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*  set up format for the stream */</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">params_format</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>

	<span class="cm">/* allocate buffer */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  CONFIGURATION SPACE for all pcms, mono pcm must update channels_max</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">pcxhr_caps</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>             <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span>	  <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_FMTBIT_S24_3LE</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_FMTBIT_S24_3BE</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_FMTBIT_FLOAT_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span>            <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_RATE_8000_192000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span>         <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>         <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="cm">/* 1 byte == 1 frame U8 mono (PCXHR_GRANULARITY is frames!) */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PCXHR_GRANULARITY</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="o">/</span><span class="n">PCXHR_GRANULARITY</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span>       <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span>       <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_stream</span>    <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="cm">/* copy the struct snd_pcm_hardware struct */</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pcxhr_caps</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_open playback chip%d subs%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_open capture chip%d subs%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mono_capture</span><span class="p">)</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">PCXHR_STREAM_STATUS_FREE</span><span class="p">){</span>
		<span class="cm">/* streams in use */</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcxhr_open chip%d subs%d in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* float format support is in some cases buggy on stereo cards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_PCM_FMTBIT_FLOAT_LE</span><span class="p">;</span>

	<span class="cm">/* buffer-size should better be multiple of period-size */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					    <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if a sample rate is already used or fixed by external clock,</span>
<span class="cm">	 * the stream cannot change</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span> <span class="o">!=</span> <span class="n">PCXHR_CLOCK_TYPE_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">external_rate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcxhr_get_external_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">use_clock_type</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">external_rate</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">external_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* cannot detect the external clock rate */</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">external_rate</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">external_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span>      <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_OPEN</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span>   <span class="o">=</span> <span class="n">subs</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not configured yet */</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>

	<span class="cm">/* better get a divisor of granularity values (96 or 192) */</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;pcxhr_close chip%d subs%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* sample rate released */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* the sample rate is no more locked */</span>
		<span class="n">pcxhr_hardware_timer</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* stop the DSP-timer */</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span>    <span class="o">=</span> <span class="n">PCXHR_STREAM_STATUS_FREE</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">pcxhr_stream_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">timer_period_frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timer_buf_periods</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_stream</span> <span class="o">*</span><span class="n">stream</span>  <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* get the period fragment and the nb of periods in the buffer */</span>
	<span class="n">timer_period_frag</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_period_frag</span><span class="p">;</span>
	<span class="n">timer_buf_periods</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">timer_buf_periods</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">snd_pcm_uframes_t</span><span class="p">)((</span><span class="n">timer_buf_periods</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">timer_period_frag</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">pcxhr_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>      <span class="o">=</span> <span class="n">pcxhr_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>     <span class="o">=</span> <span class="n">pcxhr_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>     <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>   <span class="o">=</span> <span class="n">pcxhr_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">pcxhr_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>   <span class="o">=</span> <span class="n">pcxhr_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>   <span class="o">=</span> <span class="n">pcxhr_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>   <span class="o">=</span> <span class="n">pcxhr_stream_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pcxhr_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;pcxhr %d&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot create pcm %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcxhr_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcxhr_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_chip_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_chip_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pcxhr_chip_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcxhr_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">pcxhr_chip_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">mgr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">playback_chips</span><span class="p">)</span>
		<span class="cm">/* stereo or mono streams */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_play</span> <span class="o">=</span> <span class="n">PCXHR_PLAYBACK_STREAMS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">capture_chips</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mono_capture</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 2 mono streams */</span>
		<span class="k">else</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">nb_streams_capt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* or 1 stereo stream */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_chip_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* proc interface */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcxhr_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>

	<span class="cm">/* stats available when embedded DSP is running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_FIRMWARE_DSP_MAIN_INDEX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pcxhr_rmh</span> <span class="n">rmh</span><span class="p">;</span>
		<span class="kt">short</span> <span class="n">ver_maj</span> <span class="o">=</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="kt">short</span> <span class="n">ver_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="kt">short</span> <span class="n">ver_build</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;module version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">PCXHR_DRIVER_VERSION_STRING</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dsp version %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ver_maj</span><span class="p">,</span> <span class="n">ver_min</span><span class="p">,</span> <span class="n">ver_build</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_analog</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;analog io available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;digital only board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* calc cpu load of the dsp */</span>
		<span class="n">pcxhr_init_rmh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmh</span><span class="p">,</span> <span class="n">CMD_GET_DSP_RESOURCES</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span> <span class="o">!=</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">/</span>
					  <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span> <span class="o">&gt;=</span>
					    <span class="n">PCXHR_IRQ_TIMER_FREQ</span><span class="p">)</span>
						<span class="n">ref</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">cur</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">cur</span><span class="p">)</span> <span class="o">/</span> <span class="n">ref</span><span class="p">;</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;cpu load    %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;buffer pool %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dma granularity : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dsp time errors : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_time_err</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dsp async pipe xrun errors : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">async_err_pipe_xrun</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dsp async stream xrun errors : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">async_err_stream_xrun</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;dsp async last other error : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">async_err_other_last</span><span class="p">);</span>
		<span class="cm">/* debug zone dsp */</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4200</span> <span class="o">+</span> <span class="n">PCXHR_SIZE_MAX_STATUS</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">=</span> <span class="n">PCXHR_SIZE_MAX_STATUS</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">dsp_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rmh</span><span class="p">.</span><span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">CMD_LAST_INDEX</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">pcxhr_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmh</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rmh</span><span class="p">.</span><span class="n">stat_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;debug[%02d] = %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">i</span><span class="p">,</span>  <span class="n">rmh</span><span class="p">.</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;no firmware loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcxhr_proc_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">textsHR22</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Internal&quot;</span><span class="p">,</span> <span class="s">&quot;AES Sync&quot;</span><span class="p">,</span> <span class="s">&quot;AES 1&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">textsPCXHR</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Internal&quot;</span><span class="p">,</span> <span class="s">&quot;Word&quot;</span><span class="p">,</span> <span class="s">&quot;AES Sync&quot;</span><span class="p">,</span>
		<span class="s">&quot;AES 1&quot;</span><span class="p">,</span> <span class="s">&quot;AES 2&quot;</span><span class="p">,</span> <span class="s">&quot;AES 3&quot;</span><span class="p">,</span> <span class="s">&quot;AES 4&quot;</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">texts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">texts</span> <span class="o">=</span> <span class="n">textsHR22</span><span class="p">;</span>
		<span class="n">max_clock</span> <span class="o">=</span> <span class="n">HR22_CLOCK_TYPE_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">texts</span> <span class="o">=</span> <span class="n">textsPCXHR</span><span class="p">;</span>
		<span class="n">max_clock</span> <span class="o">=</span> <span class="n">PCXHR_CLOCK_TYPE_MAX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Current Sample Clock</span><span class="se">\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">texts</span><span class="p">[</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">cur_clock_type</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Current Sample Rate</span><span class="se">\t</span><span class="s">= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate_real</span><span class="p">);</span>
	<span class="cm">/* commands available when embedded DSP is running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_FIRMWARE_DSP_MAIN_INDEX</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_clock</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_get_external_clock</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample_rate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s Clock</span><span class="se">\t\t</span><span class="s">= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sample_rate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;no firmware loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcxhr_proc_gpio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="cm">/* commands available when embedded DSP is running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_FIRMWARE_DSP_MAIN_INDEX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* gpio ports on stereo boards only available */</span>
		<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hr222_read_gpio</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>	<span class="cm">/* GPI */</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;GPI: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">hr222_read_gpio</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>	<span class="cm">/* GP0 */</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;GPO: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;no firmware loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcxhr_proc_gpo_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="cm">/* commands available when embedded DSP is running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCXHR_FIRMWARE_DSP_MAIN_INDEX</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_info_get_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;GPO: 0x%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">hr222_write_gpo</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>	<span class="cm">/* GP0 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pcxhr_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcxhr</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">pcxhr_proc_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">pcxhr_proc_sync</span><span class="p">);</span>
	<span class="cm">/* gpio available on stereo sound cards only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;gpio&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">pcxhr_proc_gpio_read</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pcxhr_proc_gpo_write</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* end of proc interface */</span>

<span class="cm">/*</span>
<span class="cm"> * release all the cards assigned to a manager instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcxhr_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset board if some firmware was loaded */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_reset_board</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;reset pcxhr !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* release irq  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mgr</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* free hostport purgebuffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">hostport</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">hostport</span><span class="p">);</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">hostport</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">prmh</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    probe function - creates the card manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcxhr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcxhr_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* check if we can restrict PCI DMA transfers to 32 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support &quot;</span>
			   <span class="s">&quot;32bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* alloc card manager */</span>
	<span class="n">mgr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mgr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;=</span> <span class="n">PCI_ID_LAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card_name</span> <span class="o">=</span>
		<span class="n">pcxhr_board_params</span><span class="p">[</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">board_name</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">playback_chips</span> <span class="o">=</span>
		<span class="n">pcxhr_board_params</span><span class="p">[</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">playback_chips</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">capture_chips</span>  <span class="o">=</span>
		<span class="n">pcxhr_board_params</span><span class="p">[</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">capture_chips</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">fw_file_set</span> <span class="o">=</span>
		<span class="n">pcxhr_board_params</span><span class="p">[</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">fw_file_set</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">firmware_num</span>  <span class="o">=</span>
		<span class="n">pcxhr_board_params</span><span class="p">[</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">firmware_num</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mono_capture</span> <span class="o">=</span> <span class="n">mono</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span> <span class="o">=</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">playback_chips</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_has_aes1</span> <span class="o">=</span> <span class="n">PCXHR_BOARD_HAS_AES1</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_aes_in_192k</span> <span class="o">=</span> <span class="o">!</span><span class="n">PCXHR_BOARD_AESIN_NO_192K</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">is_hr_stereo</span><span class="p">)</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">granularity</span> <span class="o">=</span> <span class="n">PCXHR_GRANULARITY_HR22</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">granularity</span> <span class="o">=</span> <span class="n">PCXHR_GRANULARITY</span><span class="p">;</span>

	<span class="cm">/* resource assignment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card_name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pcxhr_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">mgr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Digigram %s&quot;</span><span class="p">,</span> <span class="n">card_name</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx &amp; 0x%lx, 0x%lx irq %i&quot;</span><span class="p">,</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* ISR spinlock  */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">);</span>

	<span class="cm">/* init setup mutex*/</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="cm">/* init taslket */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_taskq</span><span class="p">,</span> <span class="n">pcxhr_msg_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mgr</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">trigger_taskq</span><span class="p">,</span> <span class="n">pcxhr_trigger_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mgr</span><span class="p">);</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">prmh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">prmh</span><span class="p">)</span> <span class="o">+</span> 
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PCXHR_SIZE_MAX_LONG_STATUS</span> <span class="o">-</span>
					   <span class="n">PCXHR_SIZE_MAX_STATUS</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">prmh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCXHR_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">tmpid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">playback_chips</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">capture_chips</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">tmpid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpid</span><span class="p">),</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span>
			 <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">?</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">:</span> <span class="n">card_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">tmpid</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate the card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;%s [PCM #%d]&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s [PCM #%d]&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_create</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* init proc interface only for chip0 */</span>
			<span class="n">pcxhr_proc_init</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* create hostport purgebuffer */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcxhr_hostport</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">hostport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* init purgebuffer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">hostport</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* create a DSP loader */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcxhr_setup_firmware</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mgr</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pcxhr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcxhr_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pcxhr_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pcxhr_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pcxhr_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pcxhr_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">pcxhr_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
