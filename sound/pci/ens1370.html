<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ens1370.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ens1370.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for Ensoniq ES1370/ES1371 AudioPCI soundcard</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;,</span>
<span class="cm"> *		     Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Power-Management-Code ( CONFIG_PM )</span>
<span class="cm"> * for ens1371 only ( FIXME )</span>
<span class="cm"> * derived from cs4281.c, atiixp.c and via82xx.c</span>
<span class="cm"> * using http://www.alsa-project.org/~tiwai/writing-an-alsa-driver/ </span>
<span class="cm"> * by Kurt J. Bosch</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/rawmidi.h&gt;</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;sound/ak4531_codec.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>

<span class="cp">#ifndef CHIP1371</span>
<span class="cp">#undef CHIP1370</span>
<span class="cp">#define CHIP1370</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CHIP1370</span>
<span class="cp">#define DRIVER_NAME &quot;ENS1370&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define DRIVER_NAME &quot;ENS1371&quot;</span>
<span class="cp">#endif</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;, Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Ensoniq AudioPCI ES1370&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Ensoniq,AudioPCI-97 ES1370},&quot;</span>
	        <span class="s">&quot;{Creative Labs,SB PCI64/128 (ES1370)}}&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Ensoniq/Creative AudioPCI ES1371+&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Ensoniq,AudioPCI ES1371/73},&quot;</span>
		<span class="s">&quot;{Ensoniq,AudioPCI ES1373},&quot;</span>
		<span class="s">&quot;{Creative Labs,Ectiva EV1938},&quot;</span>
		<span class="s">&quot;{Creative Labs,SB PCI64/128 (ES1371/73)},&quot;</span>
		<span class="s">&quot;{Creative Labs,Vibra PCI128},&quot;</span>
		<span class="s">&quot;{Ectiva,EV1938}}&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>
<span class="cp">#define SUPPORT_JOYSTICK</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable switches */</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">joystick</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">spdif</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lineio</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Ensoniq AudioPCI soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Ensoniq AudioPCI soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Ensoniq AudioPCI soundcard.&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick_port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick_port</span><span class="p">,</span> <span class="s">&quot;Joystick port address.&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="s">&quot;Enable joystick.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* SUPPORT_JOYSTICK */</span><span class="cp"></span>
<span class="cp">#ifdef CHIP1371</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="s">&quot;S/PDIF output (-1 = none, 0 = auto, 1 = force).&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">lineio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lineio</span><span class="p">,</span> <span class="s">&quot;Line In to Rear Out (0 = auto, 1 = force).&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* ES1371 chip ID */</span>
<span class="cm">/* This is a little confusing because all ES1371 compatible chips have the</span>
<span class="cm">   same DEVICE_ID, the only thing differentiating them is the REV_ID field.</span>
<span class="cm">   This is only significant if you want to enable features on the later parts.</span>
<span class="cm">   Yes, I know it&#39;s stupid and why didn&#39;t we use the sub IDs?</span>
<span class="cm">*/</span>
<span class="cp">#define ES1371REV_ES1373_A  0x04</span>
<span class="cp">#define ES1371REV_ES1373_B  0x06</span>
<span class="cp">#define ES1371REV_CT5880_A  0x07</span>
<span class="cp">#define CT5880REV_CT5880_C  0x02</span>
<span class="cp">#define CT5880REV_CT5880_D  0x03	</span><span class="cm">/* ??? -jk */</span><span class="cp"></span>
<span class="cp">#define CT5880REV_CT5880_E  0x04	</span><span class="cm">/* mw */</span><span class="cp"></span>
<span class="cp">#define ES1371REV_ES1371_B  0x09</span>
<span class="cp">#define EV1938REV_EV1938_A  0x00</span>
<span class="cp">#define ES1371REV_ES1373_8  0x08</span>

<span class="cm">/*</span>
<span class="cm"> * Direct registers</span>
<span class="cm"> */</span>

<span class="cp">#define ES_REG(ensoniq, x) ((ensoniq)-&gt;port + ES_REG_##x)</span>

<span class="cp">#define ES_REG_CONTROL	0x00	</span><span class="cm">/* R/W: Interrupt/Chip select control register */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_ADC_STOP	(1&lt;&lt;31)		</span><span class="cm">/* disable capture buffer transfers */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_XCTL1 	(1&lt;&lt;30)		</span><span class="cm">/* general purpose output bit */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_BYPASS_P1	(1&lt;&lt;31)		</span><span class="cm">/* bypass SRC for PB1 */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_BYPASS_P2	(1&lt;&lt;30)		</span><span class="cm">/* bypass SRC for PB2 */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_BYPASS_R	(1&lt;&lt;29)		</span><span class="cm">/* bypass SRC for REC */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_TEST_BIT	(1&lt;&lt;28)		</span><span class="cm">/* should be set to 0 for normal operation */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_RECEN_B	(1&lt;&lt;27)		</span><span class="cm">/* mix record with playback for I2S/SPDIF out */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_SPDIF_THRU	(1&lt;&lt;26)		</span><span class="cm">/* 0 = SPDIF thru mode, 1 = SPDIF == dig out */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_JOY_ASEL(o)	(((o)&amp;0x03)&lt;&lt;24)</span><span class="cm">/* joystick port mapping */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_JOY_ASELM	(0x03&lt;&lt;24)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_JOY_ASELI(i)  (((i)&gt;&gt;24)&amp;0x03)</span>
<span class="cp">#define   ES_1371_GPIO_IN(i)	(((i)&gt;&gt;20)&amp;0x0f)</span><span class="cm">/* GPIO in [3:0] pins - R/O */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_PCLKDIVO(o)	(((o)&amp;0x1fff)&lt;&lt;16)</span><span class="cm">/* clock divide ratio for DAC2 */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_PCLKDIVM	((0x1fff)&lt;&lt;16)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_PCLKDIVI(i)	(((i)&gt;&gt;16)&amp;0x1fff)</span><span class="cm">/* clock divide ratio for DAC2 */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_GPIO_OUT(o)	(((o)&amp;0x0f)&lt;&lt;16)</span><span class="cm">/* GPIO out [3:0] pins - W/R */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_GPIO_OUTM     (0x0f&lt;&lt;16)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_MSFMTSEL		(1&lt;&lt;15)		</span><span class="cm">/* MPEG serial data format; 0 = SONY, 1 = I2S */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_M_SBB		(1&lt;&lt;14)		</span><span class="cm">/* clock source for DAC - 0 = clock generator; 1 = MPEG clocks */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SYNC_RES	(1&lt;&lt;14)		</span><span class="cm">/* Warm AC97 reset */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_WTSRSEL(o)	(((o)&amp;0x03)&lt;&lt;12)</span><span class="cm">/* fixed frequency clock for DAC1 */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_WTSRSELM	(0x03&lt;&lt;12)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_ADC_STOP	(1&lt;&lt;13)		</span><span class="cm">/* disable CCB transfer capture information */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_PWR_INTRM	(1&lt;&lt;12)		</span><span class="cm">/* power level change interrupts enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_DAC_SYNC	(1&lt;&lt;11)		</span><span class="cm">/* DAC&#39;s are synchronous */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_M_CB		(1&lt;&lt;11)		</span><span class="cm">/* capture clock source; 0 = AC&#39;97 ADC; 1 = I2S */</span><span class="cp"></span>
<span class="cp">#define   ES_CCB_INTRM		(1&lt;&lt;10)		</span><span class="cm">/* CCB voice interrupts enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_M_CB		(1&lt;&lt;9)		</span><span class="cm">/* capture clock source; 0 = ADC; 1 = MPEG */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_XCTL0		(1&lt;&lt;8)		</span><span class="cm">/* generap purpose output bit */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_PDLEV(o)	(((o)&amp;0x03)&lt;&lt;8)	</span><span class="cm">/* current power down level */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_PDLEVM	(0x03&lt;&lt;8)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_BREQ		(1&lt;&lt;7)		</span><span class="cm">/* memory bus request enable */</span><span class="cp"></span>
<span class="cp">#define   ES_DAC1_EN		(1&lt;&lt;6)		</span><span class="cm">/* DAC1 playback channel enable */</span><span class="cp"></span>
<span class="cp">#define   ES_DAC2_EN		(1&lt;&lt;5)		</span><span class="cm">/* DAC2 playback channel enable */</span><span class="cp"></span>
<span class="cp">#define   ES_ADC_EN		(1&lt;&lt;4)		</span><span class="cm">/* ADC capture channel enable */</span><span class="cp"></span>
<span class="cp">#define   ES_UART_EN		(1&lt;&lt;3)		</span><span class="cm">/* UART enable */</span><span class="cp"></span>
<span class="cp">#define   ES_JYSTK_EN		(1&lt;&lt;2)		</span><span class="cm">/* Joystick module enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_CDC_EN	(1&lt;&lt;1)		</span><span class="cm">/* Codec interface enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_XTALCKDIS	(1&lt;&lt;1)		</span><span class="cm">/* Xtal clock disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_SERR_DISABLE	(1&lt;&lt;0)		</span><span class="cm">/* PCI serr signal disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_PCICLKDIS     (1&lt;&lt;0)		</span><span class="cm">/* PCI clock disable */</span><span class="cp"></span>
<span class="cp">#define ES_REG_STATUS	0x04	</span><span class="cm">/* R/O: Interrupt/Chip select status register */</span><span class="cp"></span>
<span class="cp">#define   ES_INTR               (1&lt;&lt;31)		</span><span class="cm">/* Interrupt is pending */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_ST_AC97_RST	(1&lt;&lt;29)		</span><span class="cm">/* CT5880 AC&#39;97 Reset bit */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_REAR_BIT27	(1&lt;&lt;27)		</span><span class="cm">/* rear bits: 000 - front, 010 - mirror, 101 - separate */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_REAR_BIT26	(1&lt;&lt;26)</span>
<span class="cp">#define   ES_1373_REAR_BIT24	(1&lt;&lt;24)</span>
<span class="cp">#define   ES_1373_GPIO_INT_EN(o)(((o)&amp;0x0f)&lt;&lt;20)</span><span class="cm">/* GPIO [3:0] pins - interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_SPDIF_EN	(1&lt;&lt;18)		</span><span class="cm">/* SPDIF enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_SPDIF_TEST	(1&lt;&lt;17)		</span><span class="cm">/* SPDIF test */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_TEST          (1&lt;&lt;16)		</span><span class="cm">/* test ASIC */</span><span class="cp"></span>
<span class="cp">#define   ES_1373_GPIO_INT(i)	(((i)&amp;0x0f)&gt;&gt;12)</span><span class="cm">/* GPIO [3:0] pins - interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_CSTAT		(1&lt;&lt;10)		</span><span class="cm">/* CODEC is busy or register write in progress */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_CBUSY         (1&lt;&lt;9)		</span><span class="cm">/* CODEC is busy */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_CWRIP		(1&lt;&lt;8)		</span><span class="cm">/* CODEC register write in progress */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SYNC_ERR	(1&lt;&lt;8)		</span><span class="cm">/* CODEC synchronization error occurred */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VC(i)         (((i)&gt;&gt;6)&amp;0x03)	</span><span class="cm">/* voice code from CCB module */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_VC(i)		(((i)&gt;&gt;5)&amp;0x03)	</span><span class="cm">/* voice code from CCB module */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_MPWR          (1&lt;&lt;5)		</span><span class="cm">/* power level interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_MCCB		(1&lt;&lt;4)		</span><span class="cm">/* CCB interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_UART		(1&lt;&lt;3)		</span><span class="cm">/* UART interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_DAC1		(1&lt;&lt;2)		</span><span class="cm">/* DAC1 channel interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_DAC2		(1&lt;&lt;1)		</span><span class="cm">/* DAC2 channel interrupt pending */</span><span class="cp"></span>
<span class="cp">#define   ES_ADC		(1&lt;&lt;0)		</span><span class="cm">/* ADC channel interrupt pending */</span><span class="cp"></span>
<span class="cp">#define ES_REG_UART_DATA 0x08	</span><span class="cm">/* R/W: UART data register */</span><span class="cp"></span>
<span class="cp">#define ES_REG_UART_STATUS 0x09	</span><span class="cm">/* R/O: UART status register */</span><span class="cp"></span>
<span class="cp">#define   ES_RXINT		(1&lt;&lt;7)		</span><span class="cm">/* RX interrupt occurred */</span><span class="cp"></span>
<span class="cp">#define   ES_TXINT		(1&lt;&lt;2)		</span><span class="cm">/* TX interrupt occurred */</span><span class="cp"></span>
<span class="cp">#define   ES_TXRDY		(1&lt;&lt;1)		</span><span class="cm">/* transmitter ready */</span><span class="cp"></span>
<span class="cp">#define   ES_RXRDY		(1&lt;&lt;0)		</span><span class="cm">/* receiver ready */</span><span class="cp"></span>
<span class="cp">#define ES_REG_UART_CONTROL 0x09	</span><span class="cm">/* W/O: UART control register */</span><span class="cp"></span>
<span class="cp">#define   ES_RXINTEN		(1&lt;&lt;7)		</span><span class="cm">/* RX interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_TXINTENO(o)	(((o)&amp;0x03)&lt;&lt;5)	</span><span class="cm">/* TX interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_TXINTENM		(0x03&lt;&lt;5)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_TXINTENI(i)	(((i)&gt;&gt;5)&amp;0x03)</span>
<span class="cp">#define   ES_CNTRL(o)		(((o)&amp;0x03)&lt;&lt;0)	</span><span class="cm">/* control */</span><span class="cp"></span>
<span class="cp">#define   ES_CNTRLM		(0x03&lt;&lt;0)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define ES_REG_UART_RES	0x0a	</span><span class="cm">/* R/W: UART reserver register */</span><span class="cp"></span>
<span class="cp">#define   ES_TEST_MODE		(1&lt;&lt;0)		</span><span class="cm">/* test mode enabled */</span><span class="cp"></span>
<span class="cp">#define ES_REG_MEM_PAGE	0x0c	</span><span class="cm">/* R/W: Memory page register */</span><span class="cp"></span>
<span class="cp">#define   ES_MEM_PAGEO(o)	(((o)&amp;0x0f)&lt;&lt;0)	</span><span class="cm">/* memory page select - out */</span><span class="cp"></span>
<span class="cp">#define   ES_MEM_PAGEM		(0x0f&lt;&lt;0)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_MEM_PAGEI(i)	(((i)&gt;&gt;0)&amp;0x0f) </span><span class="cm">/* memory page select - in */</span><span class="cp"></span>
<span class="cp">#define ES_REG_1370_CODEC 0x10	</span><span class="cm">/* W/O: Codec write register address */</span><span class="cp"></span>
<span class="cp">#define   ES_1370_CODEC_WRITE(a,d) ((((a)&amp;0xff)&lt;&lt;8)|(((d)&amp;0xff)&lt;&lt;0))</span>
<span class="cp">#define ES_REG_1371_CODEC 0x14	</span><span class="cm">/* W/R: Codec Read/Write register address */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_CODEC_RDY	   (1&lt;&lt;31)	</span><span class="cm">/* codec ready */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_CODEC_WIP	   (1&lt;&lt;30)	</span><span class="cm">/* codec register access in progress */</span><span class="cp"></span>
<span class="cp">#define   EV_1938_CODEC_MAGIC	   (1&lt;&lt;26)</span>
<span class="cp">#define   ES_1371_CODEC_PIRD	   (1&lt;&lt;23)	</span><span class="cm">/* codec read/write select register */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_CODEC_WRITE(a,d) ((((a)&amp;0x7f)&lt;&lt;16)|(((d)&amp;0xffff)&lt;&lt;0))</span>
<span class="cp">#define   ES_1371_CODEC_READS(a)   ((((a)&amp;0x7f)&lt;&lt;16)|ES_1371_CODEC_PIRD)</span>
<span class="cp">#define   ES_1371_CODEC_READ(i)    (((i)&gt;&gt;0)&amp;0xffff)</span>

<span class="cp">#define ES_REG_1371_SMPRATE 0x10	</span><span class="cm">/* W/R: Codec rate converter interface register */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_ADDRO(o) (((o)&amp;0x7f)&lt;&lt;25)</span><span class="cm">/* address of the sample rate converter */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_ADDRM	   (0x7f&lt;&lt;25)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_ADDRI(i) (((i)&gt;&gt;25)&amp;0x7f)</span><span class="cm">/* address of the sample rate converter */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_WE	   (1&lt;&lt;24)	</span><span class="cm">/* R/W: read/write control for sample rate converter */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_BUSY     (1&lt;&lt;23)	</span><span class="cm">/* R/O: sample rate memory is busy */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_DISABLE      (1&lt;&lt;22)	</span><span class="cm">/* sample rate converter disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_DIS_P1	   (1&lt;&lt;21)	</span><span class="cm">/* playback channel 1 accumulator update disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_DIS_P2	   (1&lt;&lt;20)	</span><span class="cm">/* playback channel 1 accumulator update disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_DIS_R1	   (1&lt;&lt;19)	</span><span class="cm">/* capture channel accumulator update disable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_DATAO(o) (((o)&amp;0xffff)&lt;&lt;0)</span><span class="cm">/* current value of the sample rate converter */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_DATAM	   (0xffff&lt;&lt;0)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SRC_RAM_DATAI(i) (((i)&gt;&gt;0)&amp;0xffff)</span><span class="cm">/* current value of the sample rate converter */</span><span class="cp"></span>

<span class="cp">#define ES_REG_1371_LEGACY 0x18	</span><span class="cm">/* W/R: Legacy control/status register */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_JFAST		(1&lt;&lt;31)		</span><span class="cm">/* fast joystick timing */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_HIB		(1&lt;&lt;30)		</span><span class="cm">/* host interrupt blocking enable */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VSB		(1&lt;&lt;29)		</span><span class="cm">/* SB; 0 = addr 0x220xH, 1 = 0x22FxH */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VMPUO(o)	(((o)&amp;0x03)&lt;&lt;27)</span><span class="cm">/* base register address; 0 = 0x320xH; 1 = 0x330xH; 2 = 0x340xH; 3 = 0x350xH */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VMPUM		(0x03&lt;&lt;27)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VMPUI(i)	(((i)&gt;&gt;27)&amp;0x03)</span><span class="cm">/* base register address */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VCDCO(o)	(((o)&amp;0x03)&lt;&lt;25)</span><span class="cm">/* CODEC; 0 = 0x530xH; 1 = undefined; 2 = 0xe80xH; 3 = 0xF40xH */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VCDCM		(0x03&lt;&lt;25)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_VCDCI(i)	(((i)&gt;&gt;25)&amp;0x03)</span><span class="cm">/* CODEC address */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_FIRQ		(1&lt;&lt;24)		</span><span class="cm">/* force an interrupt */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SDMACAP	(1&lt;&lt;23)		</span><span class="cm">/* enable event capture for slave DMA controller */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SPICAP	(1&lt;&lt;22)		</span><span class="cm">/* enable event capture for slave IRQ controller */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_MDMACAP	(1&lt;&lt;21)		</span><span class="cm">/* enable event capture for master DMA controller */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_MPICAP	(1&lt;&lt;20)		</span><span class="cm">/* enable event capture for master IRQ controller */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_ADCAP		(1&lt;&lt;19)		</span><span class="cm">/* enable event capture for ADLIB register; 0x388xH */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_SVCAP		(1&lt;&lt;18)		</span><span class="cm">/* enable event capture for SB registers */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_CDCCAP	(1&lt;&lt;17)		</span><span class="cm">/* enable event capture for CODEC registers */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_BACAP		(1&lt;&lt;16)		</span><span class="cm">/* enable event capture for SoundScape base address */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_EXI(i)	(((i)&gt;&gt;8)&amp;0x07)	</span><span class="cm">/* event number */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_AI(i)		(((i)&gt;&gt;3)&amp;0x1f)	</span><span class="cm">/* event significant I/O address */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_WR		(1&lt;&lt;2)	</span><span class="cm">/* event capture; 0 = read; 1 = write */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_LEGINT	(1&lt;&lt;0)	</span><span class="cm">/* interrupt for legacy events; 0 = interrupt did occur */</span><span class="cp"></span>

<span class="cp">#define ES_REG_CHANNEL_STATUS 0x1c </span><span class="cm">/* R/W: first 32-bits from S/PDIF channel status block, es1373 */</span><span class="cp"></span>

<span class="cp">#define ES_REG_SERIAL	0x20	</span><span class="cm">/* R/W: Serial interface control register */</span><span class="cp"></span>
<span class="cp">#define   ES_1371_DAC_TEST	(1&lt;&lt;22)		</span><span class="cm">/* DAC test mode enable */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_END_INCO(o)	(((o)&amp;0x07)&lt;&lt;19)</span><span class="cm">/* binary offset value to increment / loop end */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_END_INCM	(0x07&lt;&lt;19)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_END_INCI(i)	(((i)&gt;&gt;16)&amp;0x07)</span><span class="cm">/* binary offset value to increment / loop end */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_ST_INCO(o)	(((o)&amp;0x07)&lt;&lt;16)</span><span class="cm">/* binary offset value to increment / start */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_ST_INCM		(0x07&lt;&lt;16)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_ST_INCI(i)	(((i)&lt;&lt;16)&amp;0x07)</span><span class="cm">/* binary offset value to increment / start */</span><span class="cp"></span>
<span class="cp">#define   ES_R1_LOOP_SEL	(1&lt;&lt;15)		</span><span class="cm">/* ADC; 0 - loop mode; 1 = stop mode */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_LOOP_SEL	(1&lt;&lt;14)		</span><span class="cm">/* DAC2; 0 - loop mode; 1 = stop mode */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_LOOP_SEL	(1&lt;&lt;13)		</span><span class="cm">/* DAC1; 0 - loop mode; 1 = stop mode */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_PAUSE		(1&lt;&lt;12)		</span><span class="cm">/* DAC2; 0 - play mode; 1 = pause mode */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_PAUSE		(1&lt;&lt;11)		</span><span class="cm">/* DAC1; 0 - play mode; 1 = pause mode */</span><span class="cp"></span>
<span class="cp">#define   ES_R1_INT_EN		(1&lt;&lt;10)		</span><span class="cm">/* ADC interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_INT_EN		(1&lt;&lt;9)		</span><span class="cm">/* DAC2 interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_INT_EN		(1&lt;&lt;8)		</span><span class="cm">/* DAC1 interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_SCT_RLD		(1&lt;&lt;7)		</span><span class="cm">/* force sample counter reload for DAC1 */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_DAC_SEN		(1&lt;&lt;6)		</span><span class="cm">/* when stop mode: 0 - DAC2 play back zeros; 1 = DAC2 play back last sample */</span><span class="cp"></span>
<span class="cp">#define   ES_R1_MODEO(o)	(((o)&amp;0x03)&lt;&lt;4)	</span><span class="cm">/* ADC mode; 0 = 8-bit mono; 1 = 8-bit stereo; 2 = 16-bit mono; 3 = 16-bit stereo */</span><span class="cp"></span>
<span class="cp">#define   ES_R1_MODEM		(0x03&lt;&lt;4)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_R1_MODEI(i)	(((i)&gt;&gt;4)&amp;0x03)</span>
<span class="cp">#define   ES_P2_MODEO(o)	(((o)&amp;0x03)&lt;&lt;2)	</span><span class="cm">/* DAC2 mode; -- &#39;&#39; -- */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_MODEM		(0x03&lt;&lt;2)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_P2_MODEI(i)	(((i)&gt;&gt;2)&amp;0x03)</span>
<span class="cp">#define   ES_P1_MODEO(o)	(((o)&amp;0x03)&lt;&lt;0)	</span><span class="cm">/* DAC1 mode; -- &#39;&#39; -- */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_MODEM		(0x03&lt;&lt;0)	</span><span class="cm">/* mask for above */</span><span class="cp"></span>
<span class="cp">#define   ES_P1_MODEI(i)	(((i)&gt;&gt;0)&amp;0x03)</span>

<span class="cp">#define ES_REG_DAC1_COUNT 0x24	</span><span class="cm">/* R/W: DAC1 sample count register */</span><span class="cp"></span>
<span class="cp">#define ES_REG_DAC2_COUNT 0x28	</span><span class="cm">/* R/W: DAC2 sample count register */</span><span class="cp"></span>
<span class="cp">#define ES_REG_ADC_COUNT  0x2c	</span><span class="cm">/* R/W: ADC sample count register */</span><span class="cp"></span>
<span class="cp">#define   ES_REG_CURR_COUNT(i)  (((i)&gt;&gt;16)&amp;0xffff)</span>
<span class="cp">#define   ES_REG_COUNTO(o)	(((o)&amp;0xffff)&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_COUNTM		(0xffff&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_COUNTI(i)	(((i)&gt;&gt;0)&amp;0xffff)</span>

<span class="cp">#define ES_REG_DAC1_FRAME 0x30	</span><span class="cm">/* R/W: PAGE 0x0c; DAC1 frame address */</span><span class="cp"></span>
<span class="cp">#define ES_REG_DAC1_SIZE  0x34	</span><span class="cm">/* R/W: PAGE 0x0c; DAC1 frame size */</span><span class="cp"></span>
<span class="cp">#define ES_REG_DAC2_FRAME 0x38	</span><span class="cm">/* R/W: PAGE 0x0c; DAC2 frame address */</span><span class="cp"></span>
<span class="cp">#define ES_REG_DAC2_SIZE  0x3c	</span><span class="cm">/* R/W: PAGE 0x0c; DAC2 frame size */</span><span class="cp"></span>
<span class="cp">#define ES_REG_ADC_FRAME  0x30	</span><span class="cm">/* R/W: PAGE 0x0d; ADC frame address */</span><span class="cp"></span>
<span class="cp">#define ES_REG_ADC_SIZE	  0x34	</span><span class="cm">/* R/W: PAGE 0x0d; ADC frame size */</span><span class="cp"></span>
<span class="cp">#define   ES_REG_FCURR_COUNTO(o) (((o)&amp;0xffff)&lt;&lt;16)</span>
<span class="cp">#define   ES_REG_FCURR_COUNTM    (0xffff&lt;&lt;16)</span>
<span class="cp">#define   ES_REG_FCURR_COUNTI(i) (((i)&gt;&gt;14)&amp;0x3fffc)</span>
<span class="cp">#define   ES_REG_FSIZEO(o)	 (((o)&amp;0xffff)&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_FSIZEM		 (0xffff&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_FSIZEI(i)	 (((i)&gt;&gt;0)&amp;0xffff)</span>
<span class="cp">#define ES_REG_PHANTOM_FRAME 0x38 </span><span class="cm">/* R/W: PAGE 0x0d: phantom frame address */</span><span class="cp"></span>
<span class="cp">#define ES_REG_PHANTOM_COUNT 0x3c </span><span class="cm">/* R/W: PAGE 0x0d: phantom frame count */</span><span class="cp"></span>

<span class="cp">#define ES_REG_UART_FIFO  0x30	</span><span class="cm">/* R/W: PAGE 0x0e; UART FIFO register */</span><span class="cp"></span>
<span class="cp">#define   ES_REG_UF_VALID	 (1&lt;&lt;8)</span>
<span class="cp">#define   ES_REG_UF_BYTEO(o)	 (((o)&amp;0xff)&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_UF_BYTEM	 (0xff&lt;&lt;0)</span>
<span class="cp">#define   ES_REG_UF_BYTEI(i)	 (((i)&gt;&gt;0)&amp;0xff)</span>


<span class="cm">/*</span>
<span class="cm"> *  Pages</span>
<span class="cm"> */</span>

<span class="cp">#define ES_PAGE_DAC	0x0c</span>
<span class="cp">#define ES_PAGE_ADC	0x0d</span>
<span class="cp">#define ES_PAGE_UART	0x0e</span>
<span class="cp">#define ES_PAGE_UART1	0x0f</span>

<span class="cm">/*</span>
<span class="cm"> *  Sample rate converter addresses</span>
<span class="cm"> */</span>

<span class="cp">#define ES_SMPREG_DAC1		0x70</span>
<span class="cp">#define ES_SMPREG_DAC2		0x74</span>
<span class="cp">#define ES_SMPREG_ADC		0x78</span>
<span class="cp">#define ES_SMPREG_VOL_ADC	0x6c</span>
<span class="cp">#define ES_SMPREG_VOL_DAC1	0x7c</span>
<span class="cp">#define ES_SMPREG_VOL_DAC2	0x7e</span>
<span class="cp">#define ES_SMPREG_TRUNC_N	0x00</span>
<span class="cp">#define ES_SMPREG_INT_REGS	0x01</span>
<span class="cp">#define ES_SMPREG_ACCUM_FRAC	0x02</span>
<span class="cp">#define ES_SMPREG_VFREQ_FRAC	0x03</span>

<span class="cm">/*</span>
<span class="cm"> *  Some contants</span>
<span class="cm"> */</span>

<span class="cp">#define ES_1370_SRCLOCK	   1411200</span>
<span class="cp">#define ES_1370_SRTODIV(x) (ES_1370_SRCLOCK/(x)-2)</span>

<span class="cm">/*</span>
<span class="cm"> *  Open modes</span>
<span class="cm"> */</span>

<span class="cp">#define ES_MODE_PLAY1	0x0001</span>
<span class="cp">#define ES_MODE_PLAY2	0x0002</span>
<span class="cp">#define ES_MODE_CAPTURE	0x0004</span>

<span class="cp">#define ES_MODE_OUTPUT	0x0001	</span><span class="cm">/* for MIDI */</span><span class="cp"></span>
<span class="cp">#define ES_MODE_INPUT	0x0002	</span><span class="cm">/* for MIDI */</span><span class="cp"></span>

<span class="cm">/*</span>

<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ensoniq</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">src_mutex</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">playback1size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">playback2size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">capture3size</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uartm</span><span class="p">;</span>	<span class="cm">/* UART mode */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>	<span class="cm">/* control register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctrl</span><span class="p">;</span>	<span class="cm">/* serial control register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cssr</span><span class="p">;</span>	<span class="cm">/* control status register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uartc</span><span class="p">;</span>	<span class="cm">/* uart control register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">;</span>	<span class="cm">/* chip revision */</span>

	<span class="k">union</span> <span class="p">{</span>
<span class="cp">#ifdef CHIP1371</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">es1371</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pclkdiv_lock</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">snd_ak4531</span> <span class="o">*</span><span class="n">ak4531</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">es1370</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm1</span><span class="p">;</span>	<span class="cm">/* DAC1/ADC PCM */</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm2</span><span class="p">;</span>	<span class="cm">/* DAC2 PCM */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback1_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback2_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p1_dma_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p2_dma_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c_dma_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p1_period_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p2_period_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c_period_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">midi_input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">midi_output</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_default</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_stream</span><span class="p">;</span>

<span class="cp">#ifdef CHIP1370</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_bug</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_audiopci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_audiopci_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ENSONIQ</span><span class="p">,</span> <span class="mh">0x5000</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* ES1370 */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP1371</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ENSONIQ</span><span class="p">,</span> <span class="mh">0x1371</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* ES1371 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ENSONIQ</span><span class="p">,</span> <span class="mh">0x5880</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* ES1373 - CT5880 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ECTIVA</span><span class="p">,</span> <span class="mh">0x8938</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* Ectiva EV1938 */</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_audiopci_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  constants</span>
<span class="cm"> */</span>

<span class="cp">#define POLL_COUNT	0xa000</span>

<span class="cp">#ifdef CHIP1370</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_es1370_fixed_rates</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span><span class="mi">5512</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="mi">44100</span><span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">snd_es1370_hw_constraints_rates</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">snd_es1370_fixed_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ratnum</span> <span class="n">es1370_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ES_1370_SRCLOCK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">den_min</span> <span class="o">=</span> <span class="mi">29</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">den_max</span> <span class="o">=</span> <span class="mi">353</span><span class="p">,</span>
	<span class="p">.</span><span class="n">den_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_ratnums</span> <span class="n">snd_es1370_hw_constraints_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nrats</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">es1370_clock</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ratden</span> <span class="n">es1371_dac_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_min</span> <span class="o">=</span> <span class="mi">3000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_max</span> <span class="o">=</span> <span class="mi">48000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_step</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">den</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_ratdens</span> <span class="n">snd_es1371_hw_constraints_dac_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nrats</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">es1371_dac_clock</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ratnum</span> <span class="n">es1371_adc_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">48000</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span>
	<span class="p">.</span><span class="n">den_min</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">den_max</span> <span class="o">=</span> <span class="mi">393216</span><span class="p">,</span>
	<span class="p">.</span><span class="n">den_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_ratnums</span> <span class="n">snd_es1371_hw_constraints_adc_clock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nrats</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">es1371_adc_clock</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_ensoniq_sample_shift</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  common I/O routines</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CHIP1371</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">ES_1371_SRC_RAM_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wait src ready timeout 0x%lx [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">),</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_es1371_src_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* wait for ready */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>

	<span class="cm">/* expose the SRC state bits */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span> <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span>
		    <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">ES_1371_SRC_RAM_ADDRO</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>

	<span class="cm">/* now, wait for busy and the correct time to read */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for the right state */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00010000</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* hide the state bits */</span>	
	<span class="n">r</span> <span class="o">=</span> <span class="n">orig</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span> <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span>
		   <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">ES_1371_SRC_RAM_ADDRO</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_src_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span> <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span>
	     <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">ES_1371_SRC_RAM_ADDRO</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">ES_1371_SRC_RAM_DATAO</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span> <span class="o">|</span> <span class="n">ES_1371_SRC_RAM_WE</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CHIP1371 */</span><span class="cp"></span>

<span class="cp">#ifdef CHIP1370</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1370_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ak4531</span> <span class="o">*</span><span class="n">ak4531</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">ak4531</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG</span>
<span class="c">	       &quot;CODEC WRITE: reg = 0x%x, val = 0x%x (0x%x), creg = 0x%x\n&quot;,</span>
<span class="c">	       reg, val, ES_1370_CODEC_WRITE(reg, val), ES_REG(ensoniq, 1370_CODEC));</span>
<span class="cp">#endif</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_1370_CSTAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">ES_1370_CODEC_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec write timeout, status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CHIP1370 */</span><span class="cp"></span>

<span class="cp">#ifdef CHIP1371</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_ev1938</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8938</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="n">is_ev1938</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">?</span> <span class="n">EV_1938_CODEC_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_1371_CODEC_WIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* save the current state for latter */</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span> <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span>
			           <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00010000</span><span class="p">,</span>
			     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
			<span class="cm">/* wait for not busy (state 0) first to avoid</span>
<span class="cm">			   transition states */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">==</span>
				    <span class="mh">0x00000000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* wait for a SAFE time to write addr/data and then do it, dammit */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">==</span>
				    <span class="mh">0x00010000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">ES_1371_CODEC_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">|</span> <span class="n">flag</span><span class="p">,</span>
			     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">));</span>
			<span class="cm">/* restore SRC reg */</span>
			<span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec write timeout at 0x%lx [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">),</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_es1371_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="n">is_ev1938</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">?</span> <span class="n">EV_1938_CODEC_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nl">__again:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_1371_CODEC_WIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* save the current state for latter */</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span> <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span>
			           <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00010000</span><span class="p">,</span>
			     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
			<span class="cm">/* wait for not busy (state 0) first to avoid</span>
<span class="cm">			   transition states */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">==</span>
				    <span class="mh">0x00000000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* wait for a SAFE time to write addr/data and then do it, dammit */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00870000</span><span class="p">)</span> <span class="o">==</span>
				    <span class="mh">0x00010000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">ES_1371_CODEC_READS</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">flag</span><span class="p">,</span>
			     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">));</span>
			<span class="cm">/* restore SRC reg */</span>
			<span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
			<span class="cm">/* wait for WIP again */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_1371_CODEC_WIP</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>		
			<span class="p">}</span>
			<span class="cm">/* now wait for the stinkin&#39; data (RDY) */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">POLL_COUNT</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">ES_1371_CODEC_RDY</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is_ev1938</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
						<span class="n">x</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">ES_1371_CODEC_READ</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">fail</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec read timeout (final) &quot;</span>
					   <span class="s">&quot;at 0x%lx, reg = 0x%x [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span>
					   <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">)));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">__again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1371: codec read timeout at 0x%lx [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">),</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">)));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_codec_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="n">snd_es1371_codec_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
	<span class="n">snd_es1371_codec_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
	<span class="n">snd_es1371_codec_read</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_adc_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">truncm</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)))</span>
		<span class="n">n</span><span class="o">--</span><span class="p">;</span>
	<span class="n">truncm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">21</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="mi">48000UL</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mi">48000UL</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">24000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">truncm</span> <span class="o">&gt;</span> <span class="mi">239</span><span class="p">)</span>
			<span class="n">truncm</span> <span class="o">=</span> <span class="mi">239</span><span class="p">;</span>
		<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_ADC</span> <span class="o">+</span> <span class="n">ES_SMPREG_TRUNC_N</span><span class="p">,</span>
				<span class="p">(((</span><span class="mi">239</span> <span class="o">-</span> <span class="n">truncm</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">truncm</span> <span class="o">&gt;</span> <span class="mi">119</span><span class="p">)</span>
			<span class="n">truncm</span> <span class="o">=</span> <span class="mi">119</span><span class="p">;</span>
		<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_ADC</span> <span class="o">+</span> <span class="n">ES_SMPREG_TRUNC_N</span><span class="p">,</span>
				<span class="mh">0x8000</span> <span class="o">|</span> <span class="p">(((</span><span class="mi">119</span> <span class="o">-</span> <span class="n">truncm</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_ADC</span> <span class="o">+</span> <span class="n">ES_SMPREG_INT_REGS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">snd_es1371_src_read</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_ADC</span> <span class="o">+</span>
						  <span class="n">ES_SMPREG_INT_REGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">));</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_ADC</span> <span class="o">+</span> <span class="n">ES_SMPREG_VFREQ_FRAC</span><span class="p">,</span> <span class="n">freq</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_ADC</span><span class="p">,</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_ADC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_dac1_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span>
						   <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">ES_1371_DIS_P1</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC1</span> <span class="o">+</span> <span class="n">ES_SMPREG_INT_REGS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">snd_es1371_src_read</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC1</span> <span class="o">+</span>
						  <span class="n">ES_SMPREG_INT_REGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">));</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC1</span> <span class="o">+</span> <span class="n">ES_SMPREG_VFREQ_FRAC</span><span class="p">,</span> <span class="n">freq</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span>
						   <span class="n">ES_1371_DIS_P2</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1371_dac2_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span>
						   <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">ES_1371_DIS_P2</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC2</span> <span class="o">+</span> <span class="n">ES_SMPREG_INT_REGS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">snd_es1371_src_read</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC2</span> <span class="o">+</span>
						  <span class="n">ES_SMPREG_INT_REGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">));</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC2</span> <span class="o">+</span> <span class="n">ES_SMPREG_VFREQ_FRAC</span><span class="p">,</span>
			     <span class="n">freq</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span> <span class="o">|</span>
						   <span class="n">ES_1371_DIS_P1</span> <span class="o">|</span> <span class="n">ES_1371_DIS_R1</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CHIP1371 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">ES_P1_PAUSE</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">ES_P2_PAUSE</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span><span class="p">)</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">what</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">what</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">ES_DAC1_EN</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">ES_DAC2_EN</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">ES_ADC_EN</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">what</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">what</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback1_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p1_dma_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p1_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_DAC1_EN</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1371</span>
	<span class="cm">/* 48k doesn&#39;t need SRC (it breaks AC3-passthru) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1373_BYPASS_P1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1373_BYPASS_P1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_DAC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC1_FRAME</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p1_dma_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC1_SIZE</span><span class="p">));</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ES_P1_LOOP_SEL</span> <span class="o">|</span> <span class="n">ES_P1_PAUSE</span> <span class="o">|</span> <span class="n">ES_P1_SCT_RLD</span> <span class="o">|</span> <span class="n">ES_P1_MODEM</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">ES_P1_INT_EN</span> <span class="o">|</span> <span class="n">ES_P1_MODEO</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p1_period_size</span> <span class="o">&gt;&gt;</span> <span class="n">snd_ensoniq_sample_shift</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC1_COUNT</span><span class="p">));</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1370_WTSRSELM</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5512</span>: <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_WTSRSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>: <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_WTSRSEL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>: <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_WTSRSEL</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>: <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_WTSRSEL</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">snd_BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifndef CHIP1370</span>
	<span class="n">snd_es1371_dac1_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback2_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p2_dma_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p2_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_DAC2_EN</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_DAC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC2_FRAME</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p2_dma_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC2_SIZE</span><span class="p">));</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ES_P2_LOOP_SEL</span> <span class="o">|</span> <span class="n">ES_P2_PAUSE</span> <span class="o">|</span> <span class="n">ES_P2_DAC_SEN</span> <span class="o">|</span>
			    <span class="n">ES_P2_END_INCM</span> <span class="o">|</span> <span class="n">ES_P2_ST_INCM</span> <span class="o">|</span> <span class="n">ES_P2_MODEM</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">ES_P2_INT_EN</span> <span class="o">|</span> <span class="n">ES_P2_MODEO</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">ES_P2_END_INCO</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ES_P2_ST_INCO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">p2_period_size</span> <span class="o">&gt;&gt;</span> <span class="n">snd_ensoniq_sample_shift</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC2_COUNT</span><span class="p">));</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">&amp;</span> <span class="n">ES_MODE_CAPTURE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1370_PCLKDIVM</span><span class="p">;</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_PCLKDIVO</span><span class="p">(</span><span class="n">ES_1370_SRTODIV</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">));</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">|=</span> <span class="n">ES_MODE_PLAY2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifndef CHIP1370</span>
	<span class="n">snd_es1371_dac2_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">c_dma_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">c_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_ADC_EN</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_ADC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ADC_FRAME</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">c_dma_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ADC_SIZE</span><span class="p">));</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ES_R1_LOOP_SEL</span> <span class="o">|</span> <span class="n">ES_R1_MODEM</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">ES_R1_INT_EN</span> <span class="o">|</span> <span class="n">ES_R1_MODEO</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">c_period_size</span> <span class="o">&gt;&gt;</span> <span class="n">snd_ensoniq_sample_shift</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	     <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ADC_COUNT</span><span class="p">));</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">&amp;</span> <span class="n">ES_MODE_PLAY2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1370_PCLKDIVM</span><span class="p">;</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1370_PCLKDIVO</span><span class="p">(</span><span class="n">ES_1370_SRTODIV</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">));</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">|=</span> <span class="n">ES_MODE_CAPTURE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifndef CHIP1370</span>
	<span class="n">snd_es1371_adc_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ensoniq_playback1_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_DAC1_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_DAC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ES_REG_FCURR_COUNTI</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC1_SIZE</span><span class="p">)));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ensoniq_playback2_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_DAC2_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_DAC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ES_REG_FCURR_COUNTI</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">DAC2_SIZE</span><span class="p">)));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ensoniq_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_ADC_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_ADC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ES_REG_FCURR_COUNTI</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ADC_SIZE</span><span class="p">)));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ensoniq_playback1</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>
<span class="cp">#ifndef CHIP1370</span>
				<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
<span class="cp">#else</span>
				<span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> 	<span class="cm">/* 5512Hz rate */</span>
				 <span class="n">SNDRV_PCM_RATE_11025</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_22050</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_RATE_44100</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ensoniq_playback2</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ensoniq_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback1_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">ES_MODE_PLAY1</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ensoniq_playback1</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">snd_es1370_hw_constraints_rates</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_pcm_hw_constraint_ratdens</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">snd_es1371_hw_constraints_dac_clock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">ES_MODE_PLAY2</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ensoniq_playback2</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">snd_es1370_hw_constraints_clock</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_pcm_hw_constraint_ratdens</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">snd_es1371_hw_constraints_dac_clock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">ES_MODE_CAPTURE</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ensoniq_capture</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">snd_es1370_hw_constraints_clock</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">snd_es1371_hw_constraints_adc_clock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback1_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_PLAY1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_playback2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_PLAY2</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_PLAY2</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">pclkdiv_lock</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_CAPTURE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_CAPTURE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ensoniq_playback1_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ensoniq_playback1_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback1_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback1_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ensoniq_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback1_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ensoniq_playback2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ensoniq_playback2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback2_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ensoniq_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ensoniq_playback2_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ensoniq_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ensoniq_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ensoniq_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ensoniq_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ensoniq_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ensoniq_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ensoniq_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ES1370/1&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ES1371/1&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_playback2_ops</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_playback1_ops</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1370 DAC2/ADC&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1371 DAC2/ADC&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pcm1</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_pcm2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ES1370/2&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ES1371/2&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_playback1_ops</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_playback2_ops</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1370 DAC1&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1371 DAC1&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pcm2</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer section</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ENS1371 mixer (including SPDIF interface)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CHIP1371</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
                                         <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
                                         <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CHANNEL_STATUS</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ens1373_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span>
		       <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CHANNEL_STATUS</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ES1371_SPDIF(xname) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .info = snd_es1371_spdif_info, \</span>
<span class="cp">  .get = snd_es1371_spdif_get, .put = snd_es1371_spdif_put }</span>

<span class="cp">#define snd_es1371_spdif_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1371_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_1373_SPDIF_THRU</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1371_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nval1</span><span class="p">,</span> <span class="n">nval2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	
	<span class="n">nval1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ES_1373_SPDIF_THRU</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nval2</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ES_1373_SPDIF_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_1373_SPDIF_THRU</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nval1</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1373_SPDIF_THRU</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">nval1</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1373_SPDIF_EN</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">|=</span> <span class="n">nval2</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* spdif controls */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_es1371_mixer_spdif</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ES1371_SPDIF</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">)),</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_default_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_default_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">MASK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_mask_get</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_stream_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_ens1373_spdif_stream_put</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cp">#define snd_es1373_rear_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1373_rear_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1373_REAR_BIT27</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT26</span><span class="o">|</span>
			      <span class="n">ES_1373_REAR_BIT24</span><span class="p">))</span> <span class="o">==</span> <span class="n">ES_1373_REAR_BIT26</span><span class="p">)</span>
	    	<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1373_rear_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nval1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	
	<span class="n">nval1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span>
		<span class="n">ES_1373_REAR_BIT26</span> <span class="o">:</span> <span class="p">(</span><span class="n">ES_1373_REAR_BIT27</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT24</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ES_1373_REAR_BIT27</span><span class="o">|</span>
				   <span class="n">ES_1373_REAR_BIT26</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT24</span><span class="p">))</span> <span class="o">!=</span> <span class="n">nval1</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ES_1373_REAR_BIT27</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT26</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT24</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">|=</span> <span class="n">nval1</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ens1373_rear</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;AC97 2ch-&gt;4ch Copy Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_es1373_rear_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_es1373_rear_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_es1373_rear_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define snd_es1373_line_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1373_line_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_1371_GPIO_OUTM</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
	    	<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1373_line_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1371_GPIO_OUT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>	<span class="cm">/* switch line-in -&gt; rear out */</span>
	<span class="k">else</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1371_GPIO_OUT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ens1373_line</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;Line In-&gt;Rear Out Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_es1373_line_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_es1373_line_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_es1373_line_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">es1371_quirk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">;</span>		<span class="cm">/* vendor ID */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">did</span><span class="p">;</span>		<span class="cm">/* device ID */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rev</span><span class="p">;</span>		<span class="cm">/* revision */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">es1371_quirk_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">es1371_quirk</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">PCI_ANY_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">es1371_quirk</span> <span class="n">es1371_spdif_present</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_ES1371</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ES1371REV_CT5880_A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_ES1371</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ES1371REV_ES1373_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">ens1373_line_quirk</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x1274</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">),</span> <span class="cm">/* GA-7DXR */</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x1458</span><span class="p">,</span> <span class="mh">0xa000</span><span class="p">),</span> <span class="cm">/* GA-8IEXP */</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_1371_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">has_spdif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">has_line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_es1371_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_es1371_codec_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">snd_es1371_codec_wait</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ensoniq_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_AUDIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_spdif</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">has_spdif</span> <span class="o">&amp;&amp;</span> <span class="n">es1371_quirk_lookup</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">es1371_spdif_present</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_spdif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_stream</span> <span class="o">=</span>
			<span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">spdif_default</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CHANNEL_STATUS</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SPDIF</span><span class="p">)</span>
			<span class="n">is_spdif</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_es1371_mixer_spdif</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_es1371_mixer_spdif</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ensoniq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">is_spdif</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mirror rear to front speakers */</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ES_1373_REAR_BIT27</span><span class="o">|</span><span class="n">ES_1373_REAR_BIT24</span><span class="p">);</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">|=</span> <span class="n">ES_1373_REAR_BIT26</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ens1373_rear</span><span class="p">,</span> <span class="n">ensoniq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_line</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">ens1373_line_quirk</span><span class="p">))</span> <span class="p">{</span>
		 <span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ens1373_line</span><span class="p">,</span>
						      <span class="n">ensoniq</span><span class="p">));</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CHIP1371 */</span><span class="cp"></span>

<span class="cm">/* generic control callbacks for ens1370 */</span>
<span class="cp">#ifdef CHIP1370</span>
<span class="cp">#define ENSONIQ_CONTROL(xname, mask) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_CARD, .name = xname, .info = snd_ensoniq_control_info, \</span>
<span class="cp">  .get = snd_ensoniq_control_get, .put = snd_ensoniq_control_put, \</span>
<span class="cp">  .private_value = mask }</span>

<span class="cp">#define snd_ensoniq_control_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	
	<span class="n">nval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ENS1370 mixer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_es1370_controls</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">ENSONIQ_CONTROL</span><span class="p">(</span><span class="s">&quot;PCM 0 Output also on Line-In Jack&quot;</span><span class="p">,</span> <span class="n">ES_1370_XCTL0</span><span class="p">),</span>
<span class="n">ENSONIQ_CONTROL</span><span class="p">(</span><span class="s">&quot;Mic +5V bias&quot;</span><span class="p">,</span> <span class="n">ES_1370_XCTL1</span><span class="p">)</span>
<span class="p">};</span>

<span class="cp">#define ES1370_CONTROLS ARRAY_SIZE(snd_es1370_controls)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_mixer_free_ak4531</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ak4531</span> <span class="o">*</span><span class="n">ak4531</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">ak4531</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">ak4531</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_1370_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ak4531</span> <span class="n">ak4531</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* try reset AK4531 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ES_1370_CODEC_WRITE</span><span class="p">(</span><span class="n">AK4531_RESET</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ES_1370_CODEC_WRITE</span><span class="p">(</span><span class="n">AK4531_RESET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ak4531</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ak4531</span><span class="p">));</span>
	<span class="n">ak4531</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_es1370_codec_write</span><span class="p">;</span>
	<span class="n">ak4531</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="n">ak4531</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ensoniq_mixer_free_ak4531</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ak4531_mixer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ak4531</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">ak4531</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ES1370_CONTROLS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_es1370_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ensoniq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CHIP1370 */</span><span class="cp"></span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>

<span class="cp">#ifdef CHIP1371</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_get_joystick_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* disabled */</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* auto-detect */</span>
	<span class="k">case</span> <span class="mh">0x200</span>:
	<span class="k">case</span> <span class="mh">0x208</span>:
	<span class="k">case</span> <span class="mh">0x210</span>:
	<span class="k">case</span> <span class="mh">0x218</span>:
		<span class="k">return</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ens1371: invalid joystick port %#x&quot;</span><span class="p">,</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_get_joystick_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">joystick</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x200</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io_port</span><span class="p">;</span>

	<span class="n">io_port</span> <span class="o">=</span> <span class="n">snd_ensoniq_get_joystick_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">io_port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* auto_detect */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">io_port</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span> <span class="n">io_port</span> <span class="o">&lt;=</span> <span class="mh">0x218</span><span class="p">;</span> <span class="n">io_port</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ens137x: gameport&quot;</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_port</span> <span class="o">&gt;</span> <span class="mh">0x218</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ens137x: no gameport ports available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ens137x: gameport&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ens137x: gameport io port 0x%#x in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">io_port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ens137x: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;ES137x&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">io_port</span><span class="p">;</span>

	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_JYSTK_EN</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1371</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_1371_JOY_ASELM</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1371_JOY_ASEL</span><span class="p">((</span><span class="n">io_port</span> <span class="o">-</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">;</span>

		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_JYSTK_EN</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* SUPPORT_JOYSTICK */</span><span class="cp"></span>

<span class="cm">/*</span>

<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Ensoniq AudioPCI ES1370</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Ensoniq AudioPCI ES1371</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Joystick enable  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_JYSTK_EN</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MIC +5V bias     : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_1370_XCTL1</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line In to AOUT  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ES_1370_XCTL0</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Joystick port    : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ES_1371_JOY_ASELI</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;audiopci&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="n">snd_ensoniq_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>

<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ensoniq_free_gameport</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__hw_end</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_1370_SERR_DISABLE</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>	<span class="cm">/* switch everything off */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>	<span class="cm">/* clear serial interface */</span>
<span class="cp">#else</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>	<span class="cm">/* switch everything off */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>	<span class="cm">/* clear serial interface */</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="nl">__hw_end:</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">dma_bug</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">dma_bug</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ensoniq</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ensoniq_free</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CHIP1371</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">es1371_amplifier_hack</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x107b</span><span class="p">,</span> <span class="mh">0x2150</span><span class="p">),</span>	<span class="cm">/* Gateway Solo 2150 */</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x13bd</span><span class="p">,</span> <span class="mh">0x100c</span><span class="p">),</span>	<span class="cm">/* EV1938 on Mebius PC-MJ100V */</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x1102</span><span class="p">,</span> <span class="mh">0x5938</span><span class="p">),</span>	<span class="cm">/* Targa Xtender300 */</span>
	<span class="n">SND_PCI_QUIRK_ID</span><span class="p">(</span><span class="mh">0x1102</span><span class="p">,</span> <span class="mh">0x8938</span><span class="p">),</span>	<span class="cm">/* IPC Topnote G notebook */</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">es1371_quirk</span> <span class="n">es1371_ac97_reset_hack</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_CT5880</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">CT5880REV_CT5880_E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_ES1371</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ES1371REV_CT5880_A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENSONIQ</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENSONIQ_ES1371</span><span class="p">,</span> <span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ES1371REV_ES1373_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CHIP1371</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* this code was part of snd_ensoniq_create before intruduction</span>
<span class="cm">	  * of suspend/resume</span>
<span class="cm">	  */</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_MEM_PAGEO</span><span class="p">(</span><span class="n">ES_PAGE_ADC</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">MEM_PAGE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">dma_bug</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">PHANTOM_FRAME</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">PHANTOM_COUNT</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_LEGACY</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es1371_quirk_lookup</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">es1371_ac97_reset_hack</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	    <span class="cm">/* need to delay around 20ms(bleech) to give</span>
<span class="cm">	       some CODECs enough time to wakeup */</span>
	    <span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* AC&#39;97 warm reset to start the bitclk */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">ES_1371_SYNC_RES</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="cm">/* Init the sample rate converter */</span>
	<span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>	
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_1371_SRC_DISABLE</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC1</span> <span class="o">+</span> <span class="n">ES_SMPREG_TRUNC_N</span><span class="p">,</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC1</span> <span class="o">+</span> <span class="n">ES_SMPREG_INT_REGS</span><span class="p">,</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC2</span> <span class="o">+</span> <span class="n">ES_SMPREG_TRUNC_N</span><span class="p">,</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_DAC2</span> <span class="o">+</span> <span class="n">ES_SMPREG_INT_REGS</span><span class="p">,</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_ADC</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_ADC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_DAC1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_DAC1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_DAC2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_src_write</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">ES_SMPREG_VOL_DAC2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">snd_es1371_adc_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">22050</span><span class="p">);</span>
	<span class="n">snd_es1371_dac1_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">22050</span><span class="p">);</span>
	<span class="n">snd_es1371_dac2_rate</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">22050</span><span class="p">);</span>
	<span class="cm">/* WARNING:</span>
<span class="cm">	 * enabling the sample rate converter without properly programming</span>
<span class="cm">	 * its parameters causes the chip to lock up (the SRC busy bit will</span>
<span class="cm">	 * be stuck high, and I&#39;ve found no way to rectify this other than</span>
<span class="cm">	 * power cycle) - Thomas Sailer</span>
<span class="cm">	 */</span>
	<span class="n">snd_es1371_wait_src_ready</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_SMPRATE</span><span class="p">));</span>
	<span class="cm">/* try reset codec directly */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ES_1371_CODEC_WRITE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1371</span><span class="n">_CODEC</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_RES</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>

	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pcm1</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pcm2</span><span class="p">);</span>
	
<span class="cp">#ifdef CHIP1371	</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/* try to reset AK4531 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ES_1370_CODEC_WRITE</span><span class="p">(</span><span class="n">AK4531_RESET</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ES_1370_CODEC_WRITE</span><span class="p">(</span><span class="n">AK4531_RESET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1370</span><span class="n">_CODEC</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">snd_ak4531_suspend</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">ak4531</span><span class="p">);</span>
<span class="cp">#endif	</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_ensoniq_chip_init</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>

<span class="cp">#ifdef CHIP1371	</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1371</span><span class="p">.</span><span class="n">ac97</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_ak4531_resume</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">es1370</span><span class="p">.</span><span class="n">ak4531</span><span class="p">);</span>
<span class="cp">#endif	</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">**</span> <span class="n">rensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_ensoniq_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rensoniq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ensoniq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ensoniq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">src_mutex</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;Ensoniq AudioPCI&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_audiopci_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">ensoniq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_ensoniq_free</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">dma_bug</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to allocate space for phantom area - dma_bug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_ensoniq_free</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	ensoniq-&gt;ctrl = ES_1370_CDC_EN | ES_1370_SERR_DISABLE |</span>
<span class="c">		ES_1370_PCLKDIVO(ES_1370_SRTODIV(8000));</span>
<span class="cp">#else	/* get microphone working */</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ES_1370_CDC_EN</span> <span class="o">|</span> <span class="n">ES_1370_PCLKDIVO</span><span class="p">(</span><span class="n">ES_1370_SRTODIV</span><span class="p">(</span><span class="mi">8000</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">es1371_amplifier_hack</span><span class="p">))</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_1371_GPIO_OUT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* turn amplifier on */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">es1371_quirk_lookup</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">es1371_ac97_reset_hack</span><span class="p">))</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">cssr</span> <span class="o">|=</span> <span class="n">ES_1371_ST_AC97_RST</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">snd_ensoniq_chip_init</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ensoniq_free</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ensoniq_proc_init</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rensoniq</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  MIDI section</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_midi_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rmidi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* do Rx at first */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_INPUT</span> <span class="o">?</span> <span class="n">ES_RXRDY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_STATUS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_DATA</span><span class="p">));</span>
		<span class="n">snd_rawmidi_receive</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* do Tx at second */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_OUTPUT</span> <span class="o">?</span> <span class="n">ES_TXRDY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_STATUS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_output</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_TXINTENM</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_TXRDY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_DATA</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">|=</span> <span class="n">ES_MODE_INPUT</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ES_CNTRL</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_UART_EN</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_UART_EN</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_RXINTEN</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_INPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">|=</span> <span class="n">ES_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ES_CNTRL</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">ES_UART_EN</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ensoniq_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;</span> <span class="n">ES_MODE_INPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_UART_EN</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_TXINTENM</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_MODE_OUTPUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;</span> <span class="n">ES_RXINTEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* empty input FIFO */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inb</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_DATA</span><span class="p">));</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">|=</span> <span class="n">ES_RXINTEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;</span> <span class="n">ES_RXINTEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_RXINTEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ensoniq_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ES_TXINTENI</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">|=</span> <span class="n">ES_TXINTENO</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fill UART FIFO buffer at first, and turn Tx interrupts only if necessary */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ES_TXINTENI</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ES_TXRDY</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_TXINTENM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_DATA</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ES_TXINTENI</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_TXINTENM</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">uartc</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">UART_CONTROL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_ensoniq_midi_output</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ensoniq_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ensoniq_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ensoniq_midi_output_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_ensoniq_midi_input</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ensoniq_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ensoniq_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ensoniq_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ensoniq_midi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span> <span class="n">ensoniq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">**</span><span class="n">rrawmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ES1370/1&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmidi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1370&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ES1371&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_midi_output</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ensoniq_midi_input</span><span class="p">);</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span> <span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span> <span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span>
		<span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>
	<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>
	<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">rmidi</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrawmidi</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rrawmidi</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_audiopci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">sctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ensoniq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_INTR</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">sctrl</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_DAC1</span><span class="p">)</span>
		<span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_P1_INT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_DAC2</span><span class="p">)</span>
		<span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_P2_INT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_ADC</span><span class="p">)</span>
		<span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ES_R1_INT_EN</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">sctrl</span><span class="p">,</span> <span class="n">ES_REG</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">SERIAL</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_UART</span><span class="p">)</span>
		<span class="n">snd_ensoniq_midi_interrupt</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_DAC2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_ADC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ES_DAC1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">playback1_substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_audiopci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ensoniq</span> <span class="o">*</span><span class="n">ensoniq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">pcm_devs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ensoniq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ensoniq</span><span class="p">;</span>

	<span class="n">pcm_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pcm_devs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CHIP1370</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_1370_mixer</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP1371</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_1371_mixer</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">spdif</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">lineio</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_pcm</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_pcm2</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ensoniq_midi</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ensoniq_create_gameport</span><span class="p">(</span><span class="n">ensoniq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Ensoniq AudioPCI&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s %s at 0x%lx, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
		<span class="n">ensoniq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_audiopci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ens137x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_audiopci_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_audiopci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_audiopci_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_ensoniq_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_ensoniq_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
	
<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">ens137x_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
