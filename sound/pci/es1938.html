<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › es1938.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>es1938.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for ESS Solo-1 (ES1938, ES1946, ES1969) soundcard</span>
<span class="cm"> *  Copyright (c) by Jaromir Koutek &lt;miri@punknet.cz&gt;,</span>
<span class="cm"> *                   Jaroslav Kysela &lt;perex@perex.cz&gt;,</span>
<span class="cm"> *                   Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;,</span>
<span class="cm"> *                   Abramo Bagnara &lt;abramo@alsa-project.org&gt;,</span>
<span class="cm"> *                   Markus Gruber &lt;gruber@eikon.tum.de&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * Rewritten from sonicvibes.c source.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *    Rewrite better spinlocks</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">  NOTES:</span>
<span class="cm">  - Capture data is written unaligned starting from dma_base + 1 so I need to</span>
<span class="cm">    disable mmap and to add a copy callback.</span>
<span class="cm">  - After several cycle of the following:</span>
<span class="cm">    while : ; do arecord -d1 -f cd -t raw | aplay -f cd ; done</span>
<span class="cm">    a &quot;playback write error (DMA or IRQ trouble?)&quot; may happen.</span>
<span class="cm">    This is due to playback interrupts not generated.</span>
<span class="cm">    I suspect a timing issue.</span>
<span class="cm">  - Sometimes the interrupt handler is invoked wrongly during playback.</span>
<span class="cm">    This generates some harmless &quot;Unexpected hw_pointer: wrong interrupt</span>
<span class="cm">    acknowledge&quot;.</span>
<span class="cm">    I&#39;ve seen that using small period sizes.</span>
<span class="cm">    Reproducible with:</span>
<span class="cm">    mpg123 test.mp3 &amp;</span>
<span class="cm">    hdparm -t -T /dev/hda</span>
<span class="cm">*/</span>


<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaromir Koutek &lt;miri@punknet.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ESS Solo-1&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{ESS,ES1938},&quot;</span>
                <span class="s">&quot;{ESS,ES1946},&quot;</span>
                <span class="s">&quot;{ESS,ES1969},&quot;</span>
		<span class="s">&quot;{TerraTec,128i PCI}}&quot;</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>
<span class="cp">#define SUPPORT_JOYSTICK 1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for ESS Solo-1 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for ESS Solo-1 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable ESS Solo-1 soundcard.&quot;</span><span class="p">);</span>

<span class="cp">#define SLIO_REG(chip, x) ((chip)-&gt;io_port + ESSIO_REG_##x)</span>

<span class="cp">#define SLDM_REG(chip, x) ((chip)-&gt;ddma_port + ESSDM_REG_##x)</span>

<span class="cp">#define SLSB_REG(chip, x) ((chip)-&gt;sb_port + ESSSB_REG_##x)</span>

<span class="cp">#define SL_PCI_LEGACYCONTROL		0x40</span>
<span class="cp">#define SL_PCI_CONFIG			0x50</span>
<span class="cp">#define SL_PCI_DDMACONTROL		0x60</span>

<span class="cp">#define ESSIO_REG_AUDIO2DMAADDR		0</span>
<span class="cp">#define ESSIO_REG_AUDIO2DMACOUNT	4</span>
<span class="cp">#define ESSIO_REG_AUDIO2MODE		6</span>
<span class="cp">#define ESSIO_REG_IRQCONTROL		7</span>

<span class="cp">#define ESSDM_REG_DMAADDR		0x00</span>
<span class="cp">#define ESSDM_REG_DMACOUNT		0x04</span>
<span class="cp">#define ESSDM_REG_DMACOMMAND		0x08</span>
<span class="cp">#define ESSDM_REG_DMASTATUS		0x08</span>
<span class="cp">#define ESSDM_REG_DMAMODE		0x0b</span>
<span class="cp">#define ESSDM_REG_DMACLEAR		0x0d</span>
<span class="cp">#define ESSDM_REG_DMAMASK		0x0f</span>

<span class="cp">#define ESSSB_REG_FMLOWADDR		0x00</span>
<span class="cp">#define ESSSB_REG_FMHIGHADDR		0x02</span>
<span class="cp">#define ESSSB_REG_MIXERADDR		0x04</span>
<span class="cp">#define ESSSB_REG_MIXERDATA		0x05</span>

<span class="cp">#define ESSSB_IREG_AUDIO1		0x14</span>
<span class="cp">#define ESSSB_IREG_MICMIX		0x1a</span>
<span class="cp">#define ESSSB_IREG_RECSRC		0x1c</span>
<span class="cp">#define ESSSB_IREG_MASTER		0x32</span>
<span class="cp">#define ESSSB_IREG_FM			0x36</span>
<span class="cp">#define ESSSB_IREG_AUXACD		0x38</span>
<span class="cp">#define ESSSB_IREG_AUXB			0x3a</span>
<span class="cp">#define ESSSB_IREG_PCSPEAKER		0x3c</span>
<span class="cp">#define ESSSB_IREG_LINE			0x3e</span>
<span class="cp">#define ESSSB_IREG_SPATCONTROL		0x50</span>
<span class="cp">#define ESSSB_IREG_SPATLEVEL		0x52</span>
<span class="cp">#define ESSSB_IREG_MASTER_LEFT		0x60</span>
<span class="cp">#define ESSSB_IREG_MASTER_RIGHT		0x62</span>
<span class="cp">#define ESSSB_IREG_MPU401CONTROL	0x64</span>
<span class="cp">#define ESSSB_IREG_MICMIXRECORD		0x68</span>
<span class="cp">#define ESSSB_IREG_AUDIO2RECORD		0x69</span>
<span class="cp">#define ESSSB_IREG_AUXACDRECORD		0x6a</span>
<span class="cp">#define ESSSB_IREG_FMRECORD		0x6b</span>
<span class="cp">#define ESSSB_IREG_AUXBRECORD		0x6c</span>
<span class="cp">#define ESSSB_IREG_MONO			0x6d</span>
<span class="cp">#define ESSSB_IREG_LINERECORD		0x6e</span>
<span class="cp">#define ESSSB_IREG_MONORECORD		0x6f</span>
<span class="cp">#define ESSSB_IREG_AUDIO2SAMPLE		0x70</span>
<span class="cp">#define ESSSB_IREG_AUDIO2MODE		0x71</span>
<span class="cp">#define ESSSB_IREG_AUDIO2FILTER		0x72</span>
<span class="cp">#define ESSSB_IREG_AUDIO2TCOUNTL	0x74</span>
<span class="cp">#define ESSSB_IREG_AUDIO2TCOUNTH	0x76</span>
<span class="cp">#define ESSSB_IREG_AUDIO2CONTROL1	0x78</span>
<span class="cp">#define ESSSB_IREG_AUDIO2CONTROL2	0x7a</span>
<span class="cp">#define ESSSB_IREG_AUDIO2		0x7c</span>

<span class="cp">#define ESSSB_REG_RESET			0x06</span>

<span class="cp">#define ESSSB_REG_READDATA		0x0a</span>
<span class="cp">#define ESSSB_REG_WRITEDATA		0x0c</span>
<span class="cp">#define ESSSB_REG_READSTATUS		0x0c</span>

<span class="cp">#define ESSSB_REG_STATUS		0x0e</span>

<span class="cp">#define ESS_CMD_EXTSAMPLERATE		0xa1</span>
<span class="cp">#define ESS_CMD_FILTERDIV		0xa2</span>
<span class="cp">#define ESS_CMD_DMACNTRELOADL		0xa4</span>
<span class="cp">#define ESS_CMD_DMACNTRELOADH		0xa5</span>
<span class="cp">#define ESS_CMD_ANALOGCONTROL		0xa8</span>
<span class="cp">#define ESS_CMD_IRQCONTROL		0xb1</span>
<span class="cp">#define ESS_CMD_DRQCONTROL		0xb2</span>
<span class="cp">#define ESS_CMD_RECLEVEL		0xb4</span>
<span class="cp">#define ESS_CMD_SETFORMAT		0xb6</span>
<span class="cp">#define ESS_CMD_SETFORMAT2		0xb7</span>
<span class="cp">#define ESS_CMD_DMACONTROL		0xb8</span>
<span class="cp">#define ESS_CMD_DMATYPE			0xb9</span>
<span class="cp">#define ESS_CMD_OFFSETLEFT		0xba	</span>
<span class="cp">#define ESS_CMD_OFFSETRIGHT		0xbb</span>
<span class="cp">#define ESS_CMD_READREG			0xc0</span>
<span class="cp">#define ESS_CMD_ENABLEEXT		0xc6</span>
<span class="cp">#define ESS_CMD_PAUSEDMA		0xd0</span>
<span class="cp">#define ESS_CMD_ENABLEAUDIO1		0xd1</span>
<span class="cp">#define ESS_CMD_STOPAUDIO1		0xd3</span>
<span class="cp">#define ESS_CMD_AUDIO1STATUS		0xd8</span>
<span class="cp">#define ESS_CMD_CONTDMA			0xd4</span>
<span class="cp">#define ESS_CMD_TESTIRQ			0xf2</span>

<span class="cp">#define ESS_RECSRC_MIC		0</span>
<span class="cp">#define ESS_RECSRC_AUXACD	2</span>
<span class="cp">#define ESS_RECSRC_AUXB		5</span>
<span class="cp">#define ESS_RECSRC_LINE		6</span>
<span class="cp">#define ESS_RECSRC_NONE		7</span>

<span class="cp">#define DAC1 0x01</span>
<span class="cp">#define ADC1 0x02</span>
<span class="cp">#define DAC2 0x04</span>

<span class="cm">/*</span>

<span class="cm"> */</span>

<span class="cp">#define SAVED_REG_SIZE	32 </span><span class="cm">/* max. number of registers to save */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">es1938</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sb_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vc_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpu_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">game_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddma_port</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irqmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">revision</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">hw_volume</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">hw_switch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_volume</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_switch</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback1_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback2_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma1_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma2_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma1_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma2_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma1_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma2_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_capture_dmaaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">active</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mixer_lock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">proc_entry</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">SAVED_REG_SIZE</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_es1938_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_es1938_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ESS</span><span class="p">,</span> <span class="mh">0x1969</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>   <span class="cm">/* Solo-1 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_es1938_ids</span><span class="p">);</span>

<span class="cp">#define RESET_LOOP_TIMEOUT	0x10000</span>
<span class="cp">#define WRITE_LOOP_TIMEOUT	0x10000</span>
<span class="cp">#define GET_LOOP_TIMEOUT	0x01000</span>

<span class="cp">#undef REG_DEBUG</span>
<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Write to a mixer register</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_mixer_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERADDR</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERDATA</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef REG_DEBUG</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mixer reg %02x set to %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Read from a mixer register</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_mixer_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERADDR</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERDATA</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef REG_DEBUG</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mixer reg %02x now is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Write to some bits of a mixer register (return old value)</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_mixer_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERADDR</span><span class="p">));</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERDATA</span><span class="p">));</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MIXERDATA</span><span class="p">));</span>
<span class="cp">#ifdef REG_DEBUG</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mixer reg %02x was %02x, set to %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reg</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Write command to Controller Registers</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WRITE_LOOP_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READSTATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITEDATA</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_es1938_write_cmd timeout (0x02%x/0x02%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Read the Read Data Buffer</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">GET_LOOP_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READDATA</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;get_byte timeout: status 0x02%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Write value cmd register</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef REG_DEBUG</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reg %02x set to %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Read data from cmd register and return it</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_es1938_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_READREG</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_es1938_get_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef REG_DEBUG</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reg %02x now is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm"> * Write data to cmd register and return old value</span>
<span class="cm"> * -----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_READREG</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">snd_es1938_get_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="cp">#ifdef REG_DEBUG</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reg %02x was %02x, set to %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reg</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * Reset the chip</span>
<span class="cm"> * --------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RESET</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RESET</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RESET</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESET_LOOP_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READDATA</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS Solo-1 reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

     <span class="nl">__next:</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_ENABLEEXT</span><span class="p">);</span>

	<span class="cm">/* Demand transfer DMA: 4 bytes per DMA request */</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMATYPE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Change behaviour of register A1</span>
<span class="cm">	   4x oversampling</span>
<span class="cm">	   2nd channel DAC asynchronous */</span>                                                      
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2MODE</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
	<span class="cm">/* enable/select DMA channel and IRQ channel */</span>
	<span class="n">snd_es1938_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_IRQCONTROL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">snd_es1938_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DRQCONTROL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">snd_es1938_write_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_ENABLEAUDIO1</span><span class="p">);</span>
	<span class="cm">/* Set spatializer parameters to recommended values */</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">);</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * Reset the FIFOs</span>
<span class="cm"> * --------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_reset_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RESET</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RESET</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ratnum</span> <span class="n">clocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">793800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_max</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">768000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_max</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">den_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_ratnums</span> <span class="n">hw_constraints_clocks</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nrats</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rats</span> <span class="o">=</span> <span class="n">clocks</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_rate_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> 
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">div0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate_num</span> <span class="o">==</span> <span class="n">clocks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">num</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate_den</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate_den</span><span class="p">;</span>

	<span class="cm">/* set filter register */</span>
	<span class="n">div0</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">7160000</span><span class="o">*</span><span class="mi">20</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">82</span><span class="o">*</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DAC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="n">div0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="n">div0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * Configure Solo1 builtin DMA Controller</span>
<span class="cm"> * --------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_playback1_setdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2MODE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_start</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2DMAADDR</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2DMACOUNT</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_size</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2DMACOUNT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_playback2_setdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable DMA controller */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc4</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOMMAND</span><span class="p">));</span>
	<span class="cm">/* 1. Master reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACLEAR</span><span class="p">));</span>
	<span class="cm">/* 2. Mask DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMASK</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMODE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAADDR</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOUNT</span><span class="p">));</span>
	<span class="cm">/* 3. Unmask DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_capture_setdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable DMA controller */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc4</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOMMAND</span><span class="p">));</span>
	<span class="cm">/* 1. Master reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACLEAR</span><span class="p">));</span>
	<span class="cm">/* 2. Mask DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMASK</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMODE</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAADDR</span><span class="p">));</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_capture_dmaaddr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOUNT</span><span class="p">));</span>
	<span class="cm">/* 3. Unmask DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAMASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *                           *** PCM part ***</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">|=</span> <span class="n">ADC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback1_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="cm">/* According to the documentation this should be:</span>
<span class="cm">		   0x13 but that value may randomly swap stereo channels */</span>
                <span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2CONTROL1</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>
                <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2CONTROL1</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">);</span>
                <span class="cm">/* This two stage init gives the FIFO -&gt; DAC connection time to</span>
<span class="cm">                 * settle before first data from DMA flows in.  This should ensure</span>
<span class="cm">                 * no swapping of stereo channels.  Report a bug if otherwise :-) */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2MODE</span><span class="p">));</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">|=</span> <span class="n">DAC2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2MODE</span><span class="p">));</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2CONTROL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback2_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">|=</span> <span class="n">DAC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback1_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback2_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * First channel for Extended Mode Audio 1 ADC Operation</span>
<span class="cm"> * --------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">is8</span><span class="p">,</span> <span class="n">mono</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">mono</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">is8</span> <span class="o">=</span> <span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">mono</span> <span class="o">-</span> <span class="n">is8</span><span class="p">;</span>

	<span class="n">snd_es1938_reset_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	
	<span class="cm">/* program type */</span>
	<span class="n">snd_es1938_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_ANALOGCONTROL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="n">mono</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* set clock and counters */</span>
        <span class="n">snd_es1938_rate_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">ADC1</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACNTRELOADL</span><span class="p">,</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACNTRELOADH</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* initialize and configure ADC */</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_SETFORMAT2</span><span class="p">,</span> <span class="n">u</span> <span class="o">?</span> <span class="mh">0x51</span> <span class="o">:</span> <span class="mh">0x71</span><span class="p">);</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_SETFORMAT2</span><span class="p">,</span> <span class="mh">0x90</span> <span class="o">|</span> 
		       <span class="p">(</span><span class="n">u</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> 
		       <span class="p">(</span><span class="n">is8</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">|</span> 
		       <span class="p">(</span><span class="n">mono</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd<em>es1938</em>reset_fifo(chip);    </p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* 11. configure system interrupt controller and DMA controller */</span>
	<span class="n">snd_es1938_capture_setdma</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ------------------------------------------------------------------------------</span>
<span class="cm"> * Second Audio channel DAC Operation</span>
<span class="cm"> * ------------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback1_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">is8</span><span class="p">,</span> <span class="n">mono</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_start</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">mono</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">is8</span> <span class="o">=</span> <span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">mono</span> <span class="o">-</span> <span class="n">is8</span><span class="p">;</span>

        <span class="n">snd_es1938_reset_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* set clock and counters */</span>
        <span class="n">snd_es1938_rate_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">DAC2</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2TCOUNTL</span><span class="p">,</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2TCOUNTH</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* initialize and configure Audio 2 DAC */</span>
	<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2CONTROL2</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">mono</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">is8</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* program DMA */</span>
	<span class="n">snd_es1938_playback1_setdma</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback2_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">is8</span><span class="p">,</span> <span class="n">mono</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">mono</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">is8</span> <span class="o">=</span> <span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">mono</span> <span class="o">-</span> <span class="n">is8</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
 
	<span class="cm">/* reset */</span>
	<span class="n">snd_es1938_reset_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	
	<span class="n">snd_es1938_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_ANALOGCONTROL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="n">mono</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* set clock and counters */</span>
        <span class="n">snd_es1938_rate_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">DAC1</span><span class="p">);</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACNTRELOADL</span><span class="p">,</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_DMACNTRELOADH</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* initialized and configure DAC */</span>
        <span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_SETFORMAT</span><span class="p">,</span> <span class="n">u</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
        <span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_SETFORMAT</span><span class="p">,</span> <span class="n">u</span> <span class="o">?</span> <span class="mh">0x51</span> <span class="o">:</span> <span class="mh">0x71</span><span class="p">);</span>
        <span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESS_CMD_SETFORMAT2</span><span class="p">,</span> 
			 <span class="mh">0x90</span> <span class="o">|</span> <span class="p">(</span><span class="n">mono</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">is8</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">));</span>

	<span class="cm">/* program DMA */</span>
	<span class="n">snd_es1938_playback2_setdma</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback1_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback2_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* during the incrementing of dma counters the DMA register reads sometimes</span>
<span class="cm">   returns garbage. To ensure a valid hw pointer, the following checks which</span>
<span class="cm">   should be very unlikely to fail are used:</span>
<span class="cm">   - is the current DMA address in the valid DMA range ?</span>
<span class="cm">   - is the sum of DMA address and DMA counter pointing to the last DMA byte ?</span>
<span class="cm">   One can argue this could differ by one byte depending on which register is</span>
<span class="cm">   updated first, so the implementation below allows for that.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_es1938_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	size_t old, new;</span>
<span class="c">	/* This stuff is *needed*, don&#39;t ask why - AB */</span>
<span class="c">	old = inw(SLDM_REG(chip, DMACOUNT));</span>
<span class="c">	while ((new = inw(SLDM_REG(chip, DMACOUNT))) != old)</span>
<span class="c">		old = new;</span>
<span class="c">	ptr = chip-&gt;dma1_size - 1 - new;</span>
<span class="cp">#else</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAADDR</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOUNT</span><span class="p">));</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span>
	      <span class="o">||</span> <span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="o">+</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span><span class="p">)</span>
	  <span class="n">ptr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_capture_dmaaddr</span><span class="p">;</span>            <span class="cm">/* bad, use last saved */</span>
	<span class="k">else</span>
	  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_capture_dmaaddr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>            <span class="cm">/* good, remember it */</span>

	<span class="n">ptr</span> <span class="o">-=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_es1938_playback1_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
<span class="cp">#if 1</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_size</span> <span class="o">-</span> <span class="n">inw</span><span class="p">(</span><span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2DMACOUNT</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AUDIO2DMAADDR</span><span class="p">))</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_start</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2_shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_es1938_playback2_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
<span class="cp">#if 1</span>
	<span class="cm">/* This stuff is *needed*, don&#39;t ask why - AB */</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOUNT</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">new</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACOUNT</span><span class="p">)))</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">new</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMAADDR</span><span class="p">))</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_start</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_es1938_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback1_pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">snd_es1938_playback2_pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_capture_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				   <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				   <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">&lt;&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">&lt;&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * buffer management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------</span>
<span class="cm"> * Audio1 Capture (ADC)</span>
<span class="cm"> * ----------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_es1938_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				<span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">6000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
        <span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mh">0x8000</span><span class="p">,</span>       <span class="cm">/* DMA controller screws on higher values */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mh">0x8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">256</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------</span>
<span class="cm"> * Audio2 Playback (DAC)</span>
<span class="cm"> * -----------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_es1938_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">6000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
        <span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mh">0x8000</span><span class="p">,</span>       <span class="cm">/* DMA controller screws on higher values */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mh">0x8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">256</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_es1938_capture</span><span class="p">;</span>
	<span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">hw_constraints_clocks</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_es1938_playback</span><span class="p">;</span>
	<span class="n">snd_pcm_hw_constraint_ratnums</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">hw_constraints_clocks</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback1_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback2_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_es1938_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_es1938_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_es1938_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_es1938_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_es1938_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_es1938_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_es1938_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_es1938_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_es1938_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_es1938_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_es1938_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_es1938_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_es1938_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_es1938_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_es1938_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_es1938_capture_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_es1938_capture_copy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1938_new_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;es-1938-1946&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_es1938_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_es1938_capture_ops</span><span class="p">);</span>
	
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ESS Solo-1&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------</span>
<span class="cm"> * </span>
<span class="cm"> *                       *** Mixer part ***</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_info_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Master&quot;</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">,</span> <span class="s">&quot;AOUT&quot;</span><span class="p">,</span>
		<span class="s">&quot;Mic1&quot;</span><span class="p">,</span> <span class="s">&quot;Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Master&quot;</span>
	<span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_put_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_es1938_mixer_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_es1938_info_spatializer_enable	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_spatializer_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_put_spatializer_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oval</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">nval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x0c</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">nval</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">nval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">nval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_info_hw_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_hw_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_es1938_info_hw_switch		snd_ctl_boolean_stereo_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_hw_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_hwv_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_volume</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_switch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_reg_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xa0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_es1938_mixer_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snd_es1938_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xa0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snd_es1938_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ES1938_SINGLE_TLV(xname, xindex, reg, shift, mask, invert, xtlv)    \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READWRITE | SNDRV_CTL_ELEM_ACCESS_TLV_READ,\</span>
<span class="cp">  .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_es1938_info_single, \</span>
<span class="cp">  .get = snd_es1938_get_single, .put = snd_es1938_put_single, \</span>
<span class="cp">  .private_value = reg | (shift &lt;&lt; 8) | (mask &lt;&lt; 16) | (invert &lt;&lt; 24), \</span>
<span class="cp">  .tlv = { .p = xtlv } }</span>
<span class="cp">#define ES1938_SINGLE(xname, xindex, reg, shift, mask, invert) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_es1938_info_single, \</span>
<span class="cp">  .get = snd_es1938_get_single, .put = snd_es1938_put_single, \</span>
<span class="cp">  .private_value = reg | (shift &lt;&lt; 8) | (mask &lt;&lt; 16) | (invert &lt;&lt; 24) }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_info_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_es1938_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_put_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_es1938_reg_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ES1938_DOUBLE_TLV(xname, xindex, left_reg, right_reg, shift_left, shift_right, mask, invert, xtlv) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READWRITE | SNDRV_CTL_ELEM_ACCESS_TLV_READ,\</span>
<span class="cp">  .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_es1938_info_double, \</span>
<span class="cp">  .get = snd_es1938_get_double, .put = snd_es1938_put_double, \</span>
<span class="cp">  .private_value = left_reg | (right_reg &lt;&lt; 8) | (shift_left &lt;&lt; 16) | (shift_right &lt;&lt; 19) | (mask &lt;&lt; 24) | (invert &lt;&lt; 22), \</span>
<span class="cp">  .tlv = { .p = xtlv } }</span>
<span class="cp">#define ES1938_DOUBLE(xname, xindex, left_reg, right_reg, shift_left, shift_right, mask, invert) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_es1938_info_double, \</span>
<span class="cp">  .get = snd_es1938_get_double, .put = snd_es1938_put_double, \</span>
<span class="cp">  .private_value = left_reg | (right_reg &lt;&lt; 8) | (shift_left &lt;&lt; 16) | (shift_right &lt;&lt; 19) | (mask &lt;&lt; 24) | (invert &lt;&lt; 22) }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_info_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_get_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">left_reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	
	<span class="n">left</span> <span class="o">=</span> <span class="n">snd_es1938_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">left_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left_reg</span> <span class="o">!=</span> <span class="n">right_reg</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">snd_es1938_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">right_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;&gt;</span> <span class="n">shift_left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">right</span> <span class="o">&gt;&gt;</span> <span class="n">shift_right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_put_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">left_reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">;</span>
	
	<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val1</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val1</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_left</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_right</span><span class="p">;</span>
	<span class="n">mask1</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_left</span><span class="p">;</span>
	<span class="n">mask2</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_right</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left_reg</span> <span class="o">!=</span> <span class="n">right_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_es1938_reg_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">left_reg</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">val1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val1</span><span class="p">)</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_es1938_reg_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">right_reg</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val2</span><span class="p">)</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_es1938_reg_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">left_reg</span><span class="p">,</span> <span class="n">mask1</span> <span class="o">|</span> <span class="n">mask2</span><span class="p">,</span> 
					      <span class="n">val1</span> <span class="o">|</span> <span class="n">val2</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">val1</span> <span class="o">|</span> <span class="n">val2</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_scale_master</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">54</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_scale_audio1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">3300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_scale_audio2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">3450</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_scale_mic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">2400</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">db_scale_line</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">3150</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">750</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">db_scale_capture</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_es1938_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_master</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE</span><span class="p">(</span><span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hardware Master Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_es1938_info_hw_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_es1938_get_hw_volume</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span>
		   <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hardware Master Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_es1938_info_hw_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_es1938_get_hw_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_master</span> <span class="p">},</span>
<span class="p">},</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;Hardware Volume Split&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Line Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE</span><span class="p">(</span><span class="s">&quot;CD Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;FM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_mic</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Mono Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Mic Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_mic</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_capture</span><span class="p">),</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;Record Monitor&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_es1938_info_mux</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_es1938_get_mux</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_es1938_put_mux</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Mono Input Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;PCM Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_audio2</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_mic</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Line Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;FM Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_mic</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Mono Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;CD Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Aux Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_line</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_audio2</span><span class="p">),</span>
<span class="n">ES1938_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">db_scale_audio1</span><span class="p">),</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Control - Level&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;3D Control - Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_es1938_info_spatializer_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_es1938_get_spatializer_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_es1938_put_spatializer_enable</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">ES1938_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Boost (+26dB)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>


<span class="cm">/* ---------------------------------------------------------------------------- */</span>
<span class="cm">/* ---------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the chip - used by resume callback, too</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset chip */</span>
	<span class="n">snd_es1938_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* configure native mode */</span>

	<span class="cm">/* enable bus master */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* disable legacy audio */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">SL_PCI_LEGACYCONTROL</span><span class="p">,</span> <span class="mh">0x805f</span><span class="p">);</span>

	<span class="cm">/* set DDMA base */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">SL_PCI_DDMACONTROL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ddma_port</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set DMA/IRQ policy */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">SL_PCI_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* enable Audio 1, Audio 2, MPU401 IRQ and HW volume IRQ*/</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQCONTROL</span><span class="p">));</span>

	<span class="cm">/* reset DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SLDM_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACLEAR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * PM support</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_regs</span><span class="p">[</span><span class="n">SAVED_REG_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>
	<span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">es1938_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>

	<span class="cm">/* save mixer-related registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">saved_regs</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">,</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">snd_es1938_reg_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQCONTROL</span><span class="p">));</span> <span class="cm">/* disable irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">es1938_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1938: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_es1938_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1938: unable to grab IRQ %d, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">snd_es1938_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* restore mixer-related registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">saved_regs</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">,</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mh">0xa0</span><span class="p">)</span>
			<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_es1938_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1938_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1938: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;ES1938&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">game_port</span><span class="p">;</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1938_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_es1938_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_es1938_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* SUPPORT_JOYSTICK */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable irqs */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQCONTROL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span>
		<span class="n">snd_es1938_mixer_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_MPU401CONTROL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_es1938_free_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1938_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_es1938_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1938_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">es1938</span> <span class="o">**</span> <span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_es1938_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="cm">/* check, if we can restrict PCI DMA transfers to 24 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support 24bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;ESS Solo-1&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sb_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">vc_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">game_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_es1938_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_es1938_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="cp">#ifdef ES1938_DDEBUG</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;create: io: 0x%lx, sb: 0x%lx, vc: 0x%lx, mpu: 0x%lx, game: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sb_port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">vc_port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">game_port</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ddma_port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">vc_port</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* fix from Thomas Sailer */</span>

	<span class="n">snd_es1938_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1938_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * Interrupt handler</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_es1938_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span> <span class="n">audiostatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLIO_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQCONTROL</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;Es1938debug - interrupt status: =0x%x\n&quot;, status);</span>
<span class="cp">#endif</span>
	
	<span class="cm">/* AUDIO 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">                printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 1 interrupt\n&quot;);</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 1 DMAC DMA count: %u\n&quot;,</span>
<span class="c">		       inw(SLDM_REG(chip, DMACOUNT)));</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 1 DMAC DMA base: %u\n&quot;,</span>
<span class="c">		       inl(SLDM_REG(chip, DMAADDR)));</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 1 DMAC DMA status: 0x%x\n&quot;,</span>
<span class="c">		       inl(SLDM_REG(chip, DMASTATUS)));</span>
<span class="cp">#endif</span>
		<span class="cm">/* clear irq */</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">audiostatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">ADC1</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">DAC1</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback2_substream</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* AUDIO 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">                printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 2 interrupt\n&quot;);</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 2 DMAC DMA count: %u\n&quot;,</span>
<span class="c">		       inw(SLIO_REG(chip, AUDIO2DMACOUNT)));</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;Es1938debug - AUDIO channel 2 DMAC DMA base: %u\n&quot;,</span>
<span class="c">		       inl(SLIO_REG(chip, AUDIO2DMAADDR)));</span>

<span class="cp">#endif</span>
		<span class="cm">/* clear irq */</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_es1938_mixer_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_AUDIO2CONTROL2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">DAC2</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback1_substream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware volume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">split</span> <span class="o">=</span> <span class="n">snd_es1938_mixer_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_switch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_volume</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* ack interrupt */</span>
		<span class="n">snd_es1938_mixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MPU401 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>the following line is evil! It switches off MIDI interrupt handling after the first interrupt received.
replacing the last 0 by 0x40 works for ESS-Solo1, but just doing nothing works as well!
andreas@flying-snail.de
snd<em>es1938</em>mixer<em>bits(chip, ESSSB</em>IREG_MPU401CONTROL, 0x40, 0); /* ack? */</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ES1938_DMA_SIZE 64</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1938_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;ESS Solo-1&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_es1938_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_es1938_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_es1938_hwv_free</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_es1938_hwv_free</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_volume</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_es1938_hwv_free</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_switch</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
				<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_es1938_hwv_free</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
       

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1938_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">es1938</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">))</span> <span class="p">{</span>
		    	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		    	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1938_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ES1938&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ESS ES1938 (Solo-1)&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s rev %i, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1938_new_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1938_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_opl3_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			    <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FMLOWADDR</span><span class="p">),</span>
			    <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FMHIGHADDR</span><span class="p">),</span>
			    <span class="n">OPL3_HW_OPL3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opl3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1938: OPL3 not detected at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">SLSB_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FMLOWADDR</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_timer_new</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_hwdep_new</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPU401_HW_MPU401</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_port</span><span class="p">,</span>
				<span class="n">MPU401_INFO_INTEGRATED</span> <span class="o">|</span> <span class="n">MPU401_INFO_IRQ_HOOK</span><span class="p">,</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1938: unable to initialize MPU-401</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>this line is vital for MIDI interrupt handling on ess-solo1
andreas@flying-snail.de</p></td><td class="code"><div class="highlight"><pre>		<span class="n">snd_es1938_mixer_bits</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESSSB_IREG_MPU401CONTROL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_es1938_create_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_es1938_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">es1938_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_es1938_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_es1938_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_es1938_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">es1938_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">es1938_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">es1938_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
