<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ali5451 › ali5451.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ali5451.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Matt Wu &lt;Matt_Wu@acersoftech.com.cn&gt;</span>
<span class="cm"> *  Apr 26, 2001</span>
<span class="cm"> *  Routines for control of ALi pci audio M5451</span>
<span class="cm"> *</span>
<span class="cm"> *  BUGS:</span>
<span class="cm"> *    --</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *    --</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public Lcodecnse as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the Lcodecnse, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public Lcodecnse for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public Lcodecnse</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Matt Wu &lt;Matt_Wu@acersoftech.com.cn&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALI M5451&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{ALI,M5451,pci},{ALI,M5451}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX1</span><span class="p">;</span>	<span class="cm">/* Index */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcm_channels</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">spdif</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for ALI M5451 PCI Audio.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for ALI M5451 PCI Audio.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pcm_channels</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pcm_channels</span><span class="p">,</span> <span class="s">&quot;PCM Channels&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span> <span class="s">&quot;Support SPDIF I/O&quot;</span><span class="p">);</span>

<span class="cm">/* just for backward compatibility */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *  Debug part definitions</span>
<span class="cm"> */</span>

<span class="cm">/* #define ALI_DEBUG */</span>

<span class="cp">#ifdef ALI_DEBUG</span>
<span class="cp">#define snd_ali_printk(format, args...) printk(KERN_DEBUG format, ##args);</span>
<span class="cp">#else</span>
<span class="cp">#define snd_ali_printk(format, args...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Constants definition</span>
<span class="cm"> */</span>

<span class="cp">#define DEVICE_ID_ALI5451	((PCI_VENDOR_ID_AL&lt;&lt;16)|PCI_DEVICE_ID_AL_M5451)</span>


<span class="cp">#define ALI_CHANNELS		32</span>

<span class="cp">#define ALI_PCM_IN_CHANNEL	31</span>
<span class="cp">#define ALI_SPDIF_IN_CHANNEL	19</span>
<span class="cp">#define ALI_SPDIF_OUT_CHANNEL	15</span>
<span class="cp">#define ALI_CENTER_CHANNEL	24</span>
<span class="cp">#define ALI_LEF_CHANNEL		23</span>
<span class="cp">#define ALI_SURR_LEFT_CHANNEL	26</span>
<span class="cp">#define ALI_SURR_RIGHT_CHANNEL	25</span>
<span class="cp">#define ALI_MODEM_IN_CHANNEL    21</span>
<span class="cp">#define ALI_MODEM_OUT_CHANNEL   20</span>

<span class="cp">#define	SNDRV_ALI_VOICE_TYPE_PCM	01</span>
<span class="cp">#define SNDRV_ALI_VOICE_TYPE_OTH	02</span>

<span class="cp">#define	ALI_5451_V02		0x02</span>

<span class="cm">/*</span>
<span class="cm"> *  Direct Registers</span>
<span class="cm"> */</span>

<span class="cp">#define ALI_LEGACY_DMAR0        0x00  </span><span class="cm">/* ADR0 */</span><span class="cp"></span>
<span class="cp">#define ALI_LEGACY_DMAR4        0x04  </span><span class="cm">/* CNT0 */</span><span class="cp"></span>
<span class="cp">#define ALI_LEGACY_DMAR11       0x0b  </span><span class="cm">/* MOD  */</span><span class="cp"></span>
<span class="cp">#define ALI_LEGACY_DMAR15       0x0f  </span><span class="cm">/* MMR  */</span><span class="cp"></span>
<span class="cp">#define ALI_MPUR0		0x20</span>
<span class="cp">#define ALI_MPUR1		0x21</span>
<span class="cp">#define ALI_MPUR2		0x22</span>
<span class="cp">#define ALI_MPUR3		0x23</span>

<span class="cp">#define	ALI_AC97_WRITE		0x40</span>
<span class="cp">#define ALI_AC97_READ		0x44</span>

<span class="cp">#define ALI_SCTRL		0x48</span>
<span class="cp">#define   ALI_SPDIF_OUT_ENABLE		0x20</span>
<span class="cp">#define   ALI_SCTRL_LINE_IN2		(1 &lt;&lt; 9)</span>
<span class="cp">#define   ALI_SCTRL_GPIO_IN2		(1 &lt;&lt; 13)</span>
<span class="cp">#define   ALI_SCTRL_LINE_OUT_EN 	(1 &lt;&lt; 20)</span>
<span class="cp">#define   ALI_SCTRL_GPIO_OUT_EN 	(1 &lt;&lt; 23)</span>
<span class="cp">#define   ALI_SCTRL_CODEC1_READY	(1 &lt;&lt; 24)</span>
<span class="cp">#define   ALI_SCTRL_CODEC2_READY	(1 &lt;&lt; 25)</span>
<span class="cp">#define ALI_AC97_GPIO		0x4c</span>
<span class="cp">#define   ALI_AC97_GPIO_ENABLE		0x8000</span>
<span class="cp">#define   ALI_AC97_GPIO_DATA_SHIFT	16</span>
<span class="cp">#define ALI_SPDIF_CS		0x70</span>
<span class="cp">#define ALI_SPDIF_CTRL		0x74</span>
<span class="cp">#define   ALI_SPDIF_IN_FUNC_ENABLE	0x02</span>
<span class="cp">#define   ALI_SPDIF_IN_CH_STATUS	0x40</span>
<span class="cp">#define   ALI_SPDIF_OUT_CH_STATUS	0xbf</span>
<span class="cp">#define ALI_START		0x80</span>
<span class="cp">#define ALI_STOP		0x84</span>
<span class="cp">#define ALI_CSPF		0x90</span>
<span class="cp">#define ALI_AINT		0x98</span>
<span class="cp">#define ALI_GC_CIR		0xa0</span>
	<span class="cp">#define ENDLP_IE		0x00001000</span>
	<span class="cp">#define MIDLP_IE		0x00002000</span>
<span class="cp">#define ALI_AINTEN		0xa4</span>
<span class="cp">#define ALI_VOLUME		0xa8</span>
<span class="cp">#define ALI_SBDELTA_DELTA_R     0xac</span>
<span class="cp">#define ALI_MISCINT		0xb0</span>
	<span class="cp">#define ADDRESS_IRQ		0x00000020</span>
	<span class="cp">#define TARGET_REACHED		0x00008000</span>
	<span class="cp">#define MIXER_OVERFLOW		0x00000800</span>
	<span class="cp">#define MIXER_UNDERFLOW		0x00000400</span>
	<span class="cp">#define GPIO_IRQ		0x01000000</span>
<span class="cp">#define ALI_SBBL_SBCL           0xc0</span>
<span class="cp">#define ALI_SBCTRL_SBE2R_SBDD   0xc4</span>
<span class="cp">#define ALI_STIMER		0xc8</span>
<span class="cp">#define ALI_GLOBAL_CONTROL	0xd4</span>
<span class="cp">#define   ALI_SPDIF_OUT_SEL_PCM		0x00000400 </span><span class="cm">/* bit 10 */</span><span class="cp"></span>
<span class="cp">#define   ALI_SPDIF_IN_SUPPORT		0x00000800 </span><span class="cm">/* bit 11 */</span><span class="cp"></span>
<span class="cp">#define   ALI_SPDIF_OUT_CH_ENABLE	0x00008000 </span><span class="cm">/* bit 15 */</span><span class="cp"></span>
<span class="cp">#define   ALI_SPDIF_IN_CH_ENABLE	0x00080000 </span><span class="cm">/* bit 19 */</span><span class="cp"></span>
<span class="cp">#define   ALI_PCM_IN_ENABLE		0x80000000 </span><span class="cm">/* bit 31 */</span><span class="cp"></span>

<span class="cp">#define ALI_CSO_ALPHA_FMS	0xe0</span>
<span class="cp">#define ALI_LBA			0xe4</span>
<span class="cp">#define ALI_ESO_DELTA		0xe8</span>
<span class="cp">#define ALI_GVSEL_PAN_VOC_CTRL_EC	0xf0</span>
<span class="cp">#define ALI_EBUF1		0xf4</span>
<span class="cp">#define ALI_EBUF2		0xf8</span>

<span class="cp">#define ALI_REG(codec, x) ((codec)-&gt;port + x)</span>

<span class="cp">#define MAX_CODECS 2</span>


<span class="k">struct</span> <span class="n">snd_ali</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">snd_ali_voice</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">snd_ali_channel_control</span> <span class="p">{</span>
	<span class="cm">/* register data */</span>
	<span class="k">struct</span> <span class="n">REGDATA</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stop</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aint</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ainten</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">data</span><span class="p">;</span>
		
	<span class="cm">/* register addresses */</span>
	<span class="k">struct</span> <span class="n">REGS</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stop</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aint</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ainten</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97read</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97write</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">use</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">pcm</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">midi</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">mode</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">synth</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">running</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* PCM data */</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">extra</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">eso</span><span class="p">;</span>                <span class="cm">/* final ESO value for channel */</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>              <span class="cm">/* runtime-&gt;period_size */</span>

	<span class="cm">/* --- */</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">private_free</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">);</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">snd_alidev</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="n">voices</span><span class="p">[</span><span class="n">ALI_CHANNELS</span><span class="p">];</span>	

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">chcnt</span><span class="p">;</span>			<span class="cm">/* num of opened channels */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">chmap</span><span class="p">;</span>			<span class="cm">/* bitmap for opened channels */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">synthcount</span><span class="p">;</span>

<span class="p">};</span>


<span class="cp">#define ALI_GLOBAL_REGS		56</span>
<span class="cp">#define ALI_CHANNEL_REGS	8</span>
<span class="k">struct</span> <span class="n">snd_ali_image</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">regs</span><span class="p">[</span><span class="n">ALI_GLOBAL_REGS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">channel_regs</span><span class="p">[</span><span class="n">ALI_CHANNELS</span><span class="p">][</span><span class="n">ALI_CHANNEL_REGS</span><span class="p">];</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">snd_ali</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">revision</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_initialized</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_support</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci_m1533</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci_m7101</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_card</span>	<span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span>	<span class="o">*</span><span class="n">pcm</span><span class="p">[</span><span class="n">MAX_CODECS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_alidev</span>	<span class="n">synth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_channel_control</span> <span class="n">chregs</span><span class="p">;</span>

	<span class="cm">/* S/PDIF Mask */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">spdif_mask</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spurious_irq_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spurious_irq_max_delta</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_of_codecs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">[</span><span class="n">MAX_CODECS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">ac97_ext_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">ac97_ext_status</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">reg_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>	<span class="n">voice_alloc</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">struct</span> <span class="n">snd_ali_image</span> <span class="o">*</span><span class="n">image</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_ali_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AL_M5451</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_ali_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_ali_clear_voices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">snd_ali_codec_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_ali_codec_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  AC97 ACCESS</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_ali_5451_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">));</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_ali_5451_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_codec_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_ali_5451_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_ali_5451_poke</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">res</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;ali_codec_ready: codec is not ready.</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_stimer_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwChk1</span><span class="p">,</span><span class="n">dwChk2</span><span class="p">;</span>
	
	<span class="n">dwChk1</span> <span class="o">=</span> <span class="n">snd_ali_5451_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_STIMER</span><span class="p">);</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">dwChk2</span> <span class="o">=</span> <span class="n">snd_ali_5451_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_STIMER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwChk2</span> <span class="o">!=</span> <span class="n">dwChk1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_stimer_read: stimer is not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_codec_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span><span class="kt">int</span> <span class="n">secondary</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwVal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_codec_poke: reg(%xh) invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ac97write</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_codec_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_stimer_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dwVal</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondary</span><span class="p">)</span>
		<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x0080</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ALI_5451_V02</span><span class="p">)</span>
		<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>

	<span class="n">snd_ali_5451_poke</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dwVal</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_ali_codec_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">secondary</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwVal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_codec_peek: reg(%xh) invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ac97read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_codec_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_stimer_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">dwVal</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>				<span class="cm">/* bit 15*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondary</span><span class="p">)</span>
		<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x0080</span><span class="p">;</span>

	<span class="n">snd_ali_5451_poke</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dwVal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_stimer_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_codec_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="p">(</span><span class="n">snd_ali_5451_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;codec_write: reg=%xh data=%xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">ALI_AC97_GPIO_DATA_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ALI_AC97_GPIO_ENABLE</span><span class="p">,</span>
		     <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_AC97_GPIO</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ali_codec_poke</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_ali_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;codec_read reg=%xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ali_codec_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	AC97 Reset</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_reset_5451</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">wReg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">dwVal</span><span class="p">;</span>
	
	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwVal</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="n">dwVal</span> <span class="o">|</span> <span class="mh">0x08000000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwVal</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="n">dwVal</span> <span class="o">&amp;</span> <span class="mh">0xf7ffffff</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwVal</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">dwVal</span> <span class="o">|</span> <span class="mh">0x000c0000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwVal</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">dwVal</span> <span class="o">&amp;</span> <span class="mh">0xfffbffff</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
	
	<span class="n">wCount</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">wCount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wReg</span> <span class="o">=</span> <span class="n">snd_ali_codec_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wReg</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000f</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* non-fatal if you have a non PM capable codec */</span>
	<span class="cm">/* snd_printk(KERN_WARNING &quot;ali5451: reset time out\n&quot;); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ALI 5451 Controller</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_enable_special_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwVal</span><span class="p">;</span>

	<span class="n">dwVal</span>  <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">dwVal</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">dwVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_special_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwVal</span><span class="p">;</span>

	<span class="n">dwVal</span>  <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">dwVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">dwVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_enable_address_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gc</span><span class="p">;</span>

	<span class="n">gc</span>  <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
	<span class="n">gc</span> <span class="o">|=</span> <span class="n">ENDLP_IE</span><span class="p">;</span>
	<span class="n">gc</span> <span class="o">|=</span> <span class="n">MIDLP_IE</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span> <span class="n">gc</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_address_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gc</span><span class="p">;</span>

	<span class="n">gc</span>  <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
	<span class="n">gc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENDLP_IE</span><span class="p">;</span>
	<span class="n">gc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDLP_IE</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_voice_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_channel_control</span> <span class="o">*</span><span class="n">pchregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">);</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;disable_voice_irq channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ainten</span>  <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">ainten</span><span class="p">));</span>
	<span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ainten</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ainten</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">ainten</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_alloc_pcm_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span>  <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chcnt</span> <span class="o">&gt;=</span> <span class="n">ALI_CHANNELS</span><span class="p">){</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;ali_alloc_pcm_channel: no free channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chmap</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;alloc_pcm_channel no. %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_find_free_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;find_free_channel: for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rec</span> <span class="o">?</span> <span class="s">&quot;rec&quot;</span> <span class="o">:</span> <span class="s">&quot;pcm&quot;</span><span class="p">);</span>

	<span class="cm">/* recording */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span>
		     <span class="n">ALI_SPDIF_IN_SUPPORT</span><span class="p">))</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ALI_SPDIF_IN_CHANNEL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ALI_PCM_IN_CHANNEL</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_ali_alloc_pcm_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_find_free_channel: &quot;</span>
				   <span class="s">&quot;record channel is busy now.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* playback... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span>
	     <span class="n">ALI_SPDIF_OUT_CH_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ALI_SPDIF_OUT_CHANNEL</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_ali_alloc_pcm_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_find_free_channel: &quot;</span>
				   <span class="s">&quot;S/PDIF out channel is in busy now.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNELS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_ali_alloc_pcm_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_find_free_channel: no free channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_free_channel_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;free_channel_pcm channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">ALI_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_free_channel_pcm: &quot;</span>
			   <span class="s">&quot;channel %d is not in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chcnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_stop_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;stop_voice: channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">stop</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    S/PDIF Part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span><span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">begintimer</span><span class="p">,</span><span class="n">currenttimer</span><span class="p">;</span>

	<span class="n">begintimer</span>   <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_STIMER</span><span class="p">));</span>
	<span class="n">currenttimer</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_STIMER</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">currenttimer</span> <span class="o">&lt;</span> <span class="n">begintimer</span> <span class="o">+</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_stimer_ready</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">currenttimer</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>  <span class="n">ALI_STIMER</span><span class="p">));</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_detect_spdif_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">wval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">bval</span><span class="p">,</span> <span class="n">R1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R2</span><span class="p">;</span>

	<span class="n">bval</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">bval</span> <span class="o">|=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bval</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">R1</span> <span class="o">&lt;</span> <span class="mh">0x0b</span> <span class="o">||</span> <span class="n">R1</span> <span class="o">&gt;</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">R1</span> <span class="o">!=</span> <span class="mh">0x12</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">snd_ali_delay</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">R1</span> <span class="o">=</span> <span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_detect_spdif_rate: timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">50000</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_delay</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">R2</span> <span class="o">=</span> <span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">R2</span> <span class="o">!=</span> <span class="n">R1</span><span class="p">)</span>
			<span class="n">R1</span> <span class="o">=</span> <span class="n">R2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_detect_spdif_rate: timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">R2</span> <span class="o">&gt;=</span> <span class="mh">0x0b</span> <span class="o">&amp;&amp;</span> <span class="n">R2</span> <span class="o">&lt;=</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wval</span>  <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">wval</span> <span class="o">&amp;=</span> <span class="mh">0xe0f0</span><span class="p">;</span>
		<span class="n">wval</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x09</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">bval</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">bval</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">R2</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wval</span>  <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">wval</span> <span class="o">&amp;=</span> <span class="mh">0xe0f0</span><span class="p">;</span>
		<span class="n">wval</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0e</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">bval</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">bval</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_ali_get_spdif_in_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">dwRate</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">bval</span><span class="p">;</span>

	<span class="n">bval</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">bval</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">bval</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bval</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>

	<span class="n">snd_ali_detect_spdif_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">bval</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">bval</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">dwRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">dwRate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">dwRate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">dwRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dwRate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_enable_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwVal</span><span class="p">;</span>

	<span class="n">dwVal</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">dwVal</span> <span class="o">|=</span> <span class="n">ALI_SPDIF_IN_SUPPORT</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">dwVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>

	<span class="n">dwVal</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">dwVal</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dwVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>

	<span class="n">snd_ali_enable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_IN_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwVal</span><span class="p">;</span>
	
	<span class="n">dwVal</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">dwVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ALI_SPDIF_IN_SUPPORT</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">dwVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	
	<span class="n">snd_ali_disable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_IN_CHANNEL</span><span class="p">);</span>	
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_set_spdif_out_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">bVal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">dwRate</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>: <span class="n">dwRate</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>: <span class="n">dwRate</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">dwRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">bVal</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">bVal</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">));</span>
	
	<span class="n">bVal</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>		<span class="cm">/* select right */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dwRate</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	
	<span class="n">bVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* select left */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">rate</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_enable_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wVal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bVal</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>

        <span class="n">pci_dev</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bVal</span><span class="p">);</span>
        <span class="n">bVal</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
        <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="n">bVal</span><span class="p">);</span>
        <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bVal</span><span class="p">);</span>
        <span class="n">bVal</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
        <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="n">bVal</span><span class="p">);</span>

        <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bVal</span><span class="p">);</span>
        <span class="n">bVal</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
        <span class="n">bVal</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
        <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="n">bVal</span><span class="p">);</span>

	<span class="n">bVal</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bVal</span> <span class="o">|</span> <span class="n">ALI_SPDIF_OUT_ENABLE</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">));</span>

	<span class="n">bVal</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bVal</span> <span class="o">&amp;</span> <span class="n">ALI_SPDIF_OUT_CH_STATUS</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
   
	<span class="n">wVal</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">wVal</span> <span class="o">|=</span> <span class="n">ALI_SPDIF_OUT_SEL_PCM</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">wVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">snd_ali_disable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_OUT_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_enable_spdif_chnout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wVal</span><span class="p">;</span>

	<span class="n">wVal</span>  <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
   	<span class="n">wVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ALI_SPDIF_OUT_SEL_PCM</span><span class="p">;</span>
   	<span class="n">outw</span><span class="p">(</span><span class="n">wVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
<span class="cm">/*</span>
<span class="cm">	wVal = inw(ALI_REG(codec, ALI_SPDIF_CS));</span>
<span class="cm">	if (flag &amp; ALI_SPDIF_OUT_NON_PCM)</span>
<span class="cm">   		wVal |= 0x0002;</span>
<span class="cm">	else	</span>
<span class="cm">		wVal &amp;= (~0x0002);</span>
<span class="cm">   	outw(wVal, ALI_REG(codec, ALI_SPDIF_CS));</span>
<span class="cm">*/</span>
	<span class="n">snd_ali_enable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_OUT_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_spdif_chnout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wVal</span><span class="p">;</span>

  	<span class="n">wVal</span>  <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
   	<span class="n">wVal</span> <span class="o">|=</span> <span class="n">ALI_SPDIF_OUT_SEL_PCM</span><span class="p">;</span>
   	<span class="n">outw</span><span class="p">(</span><span class="n">wVal</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>

	<span class="n">snd_ali_enable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SPDIF_OUT_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_disable_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">bVal</span><span class="p">;</span>

	<span class="n">bVal</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bVal</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ALI_SPDIF_OUT_ENABLE</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">));</span>

	<span class="n">snd_ali_disable_spdif_chnout</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_update_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_channel_control</span> <span class="o">*</span><span class="n">pchregs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
<span class="cp">#ifdef ALI_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">cspf</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pchregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">);</span>

	<span class="cm">/* check if interrupt occurred for channel */</span>
	<span class="n">old</span>  <span class="o">=</span> <span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">aint</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pvoice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">&amp;&amp;</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pcm interrupt */</span>
<span class="cp">#ifdef ALI_DEBUG</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">),</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_CSO_ALPHA_FMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">cspf</span> <span class="o">=</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_CSPF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;update_ptr: cso=%4.4x cspf=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">temp</span><span class="p">,</span> <span class="n">cspf</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_ali_stop_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="n">snd_ali_disable_voice_irq</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span>	
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">synth</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* synth interrupt */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">midi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* midi interrupt */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* unknown interrupt */</span>
		<span class="n">snd_ali_stop_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">snd_ali_disable_voice_irq</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">aint</span><span class="p">));</span>
	<span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">aint</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_ali_card_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> 	<span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_channel_control</span> <span class="o">*</span><span class="n">pchregs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">hw_initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">audio_int</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_MISCINT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio_int</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">pchregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_int</span> <span class="o">&amp;</span> <span class="n">ADDRESS_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get interrupt status for all channels */</span>
		<span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">aint</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pchregs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">aint</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNELS</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_ali_update_ptr</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">TARGET_REACHED</span> <span class="o">|</span> <span class="n">MIXER_OVERFLOW</span> <span class="o">|</span> <span class="n">MIXER_UNDERFLOW</span><span class="p">),</span>
		<span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_MISCINT</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="nf">snd_ali_alloc_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;alloc_voice: type=%d rec=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_ALI_VOICE_TYPE_PCM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">snd_ali_alloc_pcm_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">snd_ali_find_free_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">rec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_alloc_voice: err.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvoice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pvoice</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_free_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">private_free</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;free_voice: channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_ali_clear_voices</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
	<span class="n">private_free</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">;</span>
	<span class="n">private_data</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span>
		<span class="n">snd_ali_free_channel_pcm</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">synth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private_free</span><span class="p">)</span>
		<span class="n">private_free</span><span class="p">(</span><span class="n">private_data</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_clear_voices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v_min</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">v_min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">v_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_stop_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">snd_ali_disable_voice_irq</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_write_voice_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LBA</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CSO</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ESO</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DELTA</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ALPHA_FMS</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">GVSEL</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PAN</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VOL</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRL</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">EC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctlcmds</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	
	<span class="n">outb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">Channel</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">),</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>

	<span class="n">ctlcmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">CSO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ALPHA_FMS</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">ctlcmds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">LBA</span><span class="p">;</span>
	<span class="n">ctlcmds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">ESO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DELTA</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">);</span>
	<span class="n">ctlcmds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">GVSEL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">PAN</span> <span class="o">&amp;</span> <span class="mh">0x0000007f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">VOL</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">CTRL</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">EC</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">Channel</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">ctlcmds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_CSO_ALPHA_FMS</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ctlcmds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_LBA</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ctlcmds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_ESO_DELTA</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ctlcmds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GVSEL_PAN_VOC_CTRL_EC</span><span class="p">));</span>

	<span class="n">outl</span><span class="p">(</span><span class="mh">0x30000000</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_EBUF1</span><span class="p">));</span>	<span class="cm">/* Still Mode */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x30000000</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_EBUF2</span><span class="p">));</span>	<span class="cm">/* Still Mode */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_ali_convert_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x116a</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x6000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="mi">48000</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0xeb3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x2ab</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">else</span> 
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_ali_control_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="cm">/* set ctrl mode</span>
<span class="cm">	   CTRL default: 8-bit (unsigned) mono, loop mode enabled</span>
<span class="cm">	 */</span>
	<span class="n">CTRL</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000008</span><span class="p">;</span>	<span class="cm">/* 16-bit data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000002</span><span class="p">;</span>	<span class="cm">/* signed data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">CTRL</span> <span class="o">|=</span> <span class="mh">0x00000004</span><span class="p">;</span>	<span class="cm">/* stereo data */</span>
	<span class="k">return</span> <span class="n">CTRL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
				    
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span><span class="p">,</span> <span class="n">whati</span><span class="p">,</span> <span class="n">capture_flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">,</span> <span class="o">*</span><span class="n">evoice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_start</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">do_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">do_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">what</span> <span class="o">=</span> <span class="n">whati</span> <span class="o">=</span> <span class="n">capture_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="p">)</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvoice</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">evoice</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
			<span class="n">what</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">whati</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">whati</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">evoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">evoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
				<span class="n">capture_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_start</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_STOP</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_AINTEN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_start</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">whati</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">whati</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_AINTEN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_start</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_START</span><span class="p">));</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;trigger: what=%xh whati=%xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">whati</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_playback_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
				       <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="cm">/* voice management */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params_buffer_size</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">!=</span>
	    <span class="n">params_period_size</span><span class="p">(</span><span class="n">hw_params</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evoice</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">evoice</span> <span class="o">=</span> <span class="n">snd_ali_alloc_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						     <span class="n">SNDRV_ALI_VOICE_TYPE_PCM</span><span class="p">,</span>
						     <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evoice</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">evoice</span><span class="p">;</span>
			<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ali_free_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
			<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">evoice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_playback_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">pvoice</span> <span class="o">?</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_free_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">evoice</span><span class="p">);</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">evoice</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LBA</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Delta</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ESO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">GVSEL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PAN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VOL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">EC</span><span class="p">;</span>
	
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;playback_prepare ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>	
	
	<span class="cm">/* set Delta (rate) value */</span>
	<span class="n">Delta</span> <span class="o">=</span> <span class="n">snd_ali_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_SPDIF_IN_CHANNEL</span> <span class="o">||</span> 
	    <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_PCM_IN_CHANNEL</span><span class="p">)</span>
		<span class="n">snd_ali_disable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span>
		  <span class="n">ALI_SPDIF_OUT_CH_ENABLE</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_SPDIF_OUT_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_set_spdif_out_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">Delta</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* set Loop Back Address */</span>
	<span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/* set interrupt count size */</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>

	<span class="cm">/* set target ESO for channel */</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span> 

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;playback_prepare: eso=%xh count=%xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">eso</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* set ESO to capture first MIDLP interrupt */</span>
	<span class="n">ESO</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* set ctrl mode */</span>
	<span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_ali_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">GVSEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">PAN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VOL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;playback_prepare:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;ch=%d, Rate=%d Delta=%xh,GVSEL=%xh,PAN=%xh,CTRL=%xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span><span class="n">Delta</span><span class="p">,</span><span class="n">GVSEL</span><span class="p">,</span><span class="n">PAN</span><span class="p">,</span><span class="n">CTRL</span><span class="p">);</span>
	<span class="n">snd_ali_write_voice_regs</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
				 <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				 <span class="n">LBA</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* cso */</span>
				 <span class="n">ESO</span><span class="p">,</span>
				 <span class="n">Delta</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* alpha */</span>
				 <span class="n">GVSEL</span><span class="p">,</span>
				 <span class="n">PAN</span><span class="p">,</span>
				 <span class="n">VOL</span><span class="p">,</span>
				 <span class="n">CTRL</span><span class="p">,</span>
				 <span class="n">EC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evoice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">evoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ESO</span> <span class="o">=</span> <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_ali_write_voice_regs</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
					 <span class="n">evoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
					 <span class="n">LBA</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* cso */</span>
					 <span class="n">ESO</span><span class="p">,</span>
					 <span class="n">Delta</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* alpha */</span>
					 <span class="n">GVSEL</span><span class="p">,</span>
					 <span class="mh">0x7f</span><span class="p">,</span>
					 <span class="mh">0x3ff</span><span class="p">,</span>
					 <span class="n">CTRL</span><span class="p">,</span>
					 <span class="n">EC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LBA</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Delta</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ESO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">GVSEL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PAN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VOL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">EC</span><span class="p">;</span>
	<span class="n">u8</span>	 <span class="n">bValue</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;ali_prepare...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_ali_enable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">Delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_MODEM_IN_CHANNEL</span> <span class="o">||</span>
		 <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_MODEM_OUT_CHANNEL</span><span class="p">)</span> <span class="o">?</span> 
		<span class="mh">0x1000</span> <span class="o">:</span> <span class="n">snd_ali_convert_rate</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* Prepare capture intr channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">ALI_SPDIF_IN_CHANNEL</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
		
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">ALI_5451_V02</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">snd_ali_get_spdif_in_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ali_capture_preapre: &quot;</span>
				   <span class="s">&quot;spdif rate detect err!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">bValue</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bValue</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">bValue</span><span class="p">,</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">ALI_SPDIF_CTRL</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;clear SPDIF parity error flag.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">Delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set target ESO for channel  */</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span> 

	<span class="cm">/* set interrupt count size  */</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>

	<span class="cm">/* set Loop Back Address  */</span>
	<span class="n">LBA</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/* set ESO to capture first MIDLP interrupt  */</span>
	<span class="n">ESO</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">eso</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">CTRL</span> <span class="o">=</span> <span class="n">snd_ali_control_mode</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">GVSEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PAN</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">VOL</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">EC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_ali_write_voice_regs</span><span class="p">(</span>    <span class="n">codec</span><span class="p">,</span>
				     <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				     <span class="n">LBA</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* cso */</span>
				     <span class="n">ESO</span><span class="p">,</span>
				     <span class="n">Delta</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* alpha */</span>
				     <span class="n">GVSEL</span><span class="p">,</span>
				     <span class="n">PAN</span><span class="p">,</span>
				     <span class="n">VOL</span><span class="p">,</span>
				     <span class="n">CTRL</span><span class="p">,</span>
				     <span class="n">EC</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span>
<span class="nf">snd_ali_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cso</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
	<span class="n">cso</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_CSO_ALPHA_FMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;playback pointer returned cso=%xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cso</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cso</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ali_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cso</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
	<span class="n">cso</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_CSO_ALPHA_FMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cso</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ali_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_RESUME</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Capture support device description</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ali_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_RESUME</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_pcm_free_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
		<span class="n">snd_ali_free_voice</span><span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">pvoice</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rec</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="o">*</span><span class="n">phw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">;</span>

	<span class="n">pvoice</span> <span class="o">=</span> <span class="n">snd_ali_alloc_voice</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SNDRV_ALI_VOICE_TYPE_PCM</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span>
				     <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvoice</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pvoice</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ali_pcm_free_substream</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="o">*</span><span class="n">phw</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ali_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ali_playback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ali_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ali_capture</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ali_voice</span> <span class="o">*</span><span class="n">pvoice</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_ali_disable_special_channel</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ali_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ali_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ali_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ali_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ali_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ali_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ali_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ali_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ali_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ali_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ali_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ali_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ali_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ali_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Modem PCM</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_modem_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modem_num</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">modem_num</span><span class="p">],</span> <span class="n">AC97_LINE1_RATE</span><span class="p">,</span>
		       <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">modem_num</span><span class="p">],</span> <span class="n">AC97_LINE1_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ali_hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ali_modem</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_RESUME</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>	<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_16000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">16000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_modem_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rec</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">16000</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraint_rates</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
		<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ali_modem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_constraint_rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_modem_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ali_modem_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ALI_MODEM_OUT_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_modem_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ali_modem_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ALI_MODEM_IN_CHANNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ali_modem_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ali_modem_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ali_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ali_modem_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ali_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ali_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ali_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ali_modem_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_ali_modem_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_ali_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_ali_modem_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_ali_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_ali_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_ali_pointer</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">ali_pcm_description</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">playback_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">capture_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">playback_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">capture_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">class</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_pcm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ali_pcm_description</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			  <span class="n">desc</span><span class="o">-&gt;</span><span class="n">playback_num</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">capture_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_ali_pcm: err called snd_pcm_new.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ali_pcm_free</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev_subclass</span> <span class="o">=</span> <span class="n">SNDRV_PCM_SUBCLASS_GENERIC_MIX</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ali_pcm_description</span> <span class="n">ali_pcms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALI 5451&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">playback_num</span> <span class="o">=</span> <span class="n">ALI_CHANNELS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">capture_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_ali_playback_ops</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_ali_capture_ops</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALI 5451 modem&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">playback_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">capture_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_ali_modem_playback_ops</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_ali_modem_capture_ops</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">SNDRV_PCM_CLASS_MODEM</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_build_pcms</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ali_pcms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_pcm</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ali_pcms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define ALI5451_SPDIF(xname, xindex, value) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex,\</span>
<span class="cp">.info = snd_ali5451_spdif_info, .get = snd_ali5451_spdif_get, \</span>
<span class="cp">.put = snd_ali5451_spdif_put, .private_value = value}</span>

<span class="cp">#define snd_ali5451_spdif_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali5451_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spdif_enable</span><span class="p">;</span>

	<span class="n">spdif_enable</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">spdif_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">spdif_enable</span> <span class="o">=</span> <span class="p">((</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">spdif_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spdif_enable</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali5451_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spdif_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spdif_enable</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">change</span> <span class="o">^</span> <span class="n">spdif_enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spdif_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="n">snd_ali_enable_spdif_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span>
				<span class="n">snd_ali_disable_spdif_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: 
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">change</span> <span class="o">^</span> <span class="n">spdif_enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spdif_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="n">snd_ali_enable_spdif_chnout</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span>
				<span class="n">snd_ali_disable_spdif_chnout</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">change</span> <span class="o">^</span> <span class="n">spdif_enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spdif_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">snd_ali_enable_spdif_in</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>
				<span class="n">snd_ali_disable_spdif_in</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ali5451_mixer_spdif</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* spdif aplayback switch */</span>
	<span class="cm">/* FIXME: &quot;IEC958 Playback Switch&quot; may conflict with one on ac97_codec */</span>
	<span class="n">ALI5451_SPDIF</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Output &quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="cm">/* spdif out to spdif channel */</span>
	<span class="n">ALI5451_SPDIF</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Channel Output &quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="cm">/* spdif in from spdif channel */</span>
	<span class="n">ALI5451_SPDIF</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_ali_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_ali_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;ali mixer %d creating error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ali5451_mixer_spdif</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					  <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ali5451_mixer_spdif</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">codec</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_image</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">im</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">im</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">ALI_MISCINT</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_MISCINT</span><span class="p">));</span>
	<span class="cm">/* im-&gt;regs[ALI_START &gt;&gt; 2] = inl(ALI_REG(chip, ALI_START)); */</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">ALI_STOP</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_STOP</span><span class="p">));</span>
	
	<span class="cm">/* disable all IRQ bits */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_MISCINT</span><span class="p">));</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALI_GLOBAL_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">==</span> <span class="n">ALI_MISCINT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">==</span> <span class="n">ALI_STOP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNEL_REGS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> 
			<span class="n">im</span><span class="o">-&gt;</span><span class="n">channel_regs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* stop all HW channel */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_STOP</span><span class="p">));</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali_image</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">im</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">im</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali5451: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_GC_CIR</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNEL_REGS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> 
			<span class="n">outl</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">channel_regs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">));</span>
	<span class="p">}</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALI_GLOBAL_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">==</span> <span class="n">ALI_MISCINT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">==</span> <span class="n">ALI_STOP</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">==</span> <span class="n">ALI_START</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	
	<span class="cm">/* start HW channel */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">ALI_START</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_START</span><span class="p">));</span>
	<span class="cm">/* restore IRQ enable bits */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">ALI_MISCINT</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_MISCINT</span><span class="p">));</span>
	
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">hw_initialized</span><span class="p">)</span>
		<span class="n">snd_ali_disable_address_interrupt</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m7101</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">legacy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;chip initializing ... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_reset_5451</span><span class="p">(</span><span class="n">codec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali_chip_init: reset 5451 error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ALI_5451_V02</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span><span class="p">;</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	
		<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m7101</span><span class="p">;</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">legacy</span><span class="p">);</span>
	<span class="n">legacy</span> <span class="o">&amp;=</span> <span class="mh">0xff00ff00</span><span class="p">;</span>
	<span class="n">legacy</span> <span class="o">|=</span> <span class="mh">0x000800aa</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">legacy</span><span class="p">);</span>

	<span class="n">outl</span><span class="p">(</span><span class="mh">0x80000001</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_GLOBAL_CONTROL</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_AINTEN</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_AINT</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_VOLUME</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> 	 <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_MPUR2</span><span class="p">));</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_ext_id</span> <span class="o">=</span> <span class="n">snd_ali_codec_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC97_EXTENDED_ID</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_ext_status</span> <span class="o">=</span> <span class="n">snd_ali_codec_peek</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_enable_spdif_out</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* secondary codec - modem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ALI_SCTRL_CODEC2_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_of_codecs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">))</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">ALI_SCTRL_LINE_IN2</span> <span class="o">|</span> <span class="n">ALI_SCTRL_GPIO_IN2</span> <span class="o">|</span>
		      <span class="n">ALI_SCTRL_LINE_OUT_EN</span><span class="p">),</span>
		     <span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ALI_SCTRL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;chip initialize succeed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* proc for register dump */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ali_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="p">;</span> <span class="n">i</span><span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02x: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">ALI_REG</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_ali_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ali5451&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">snd_ali_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;resources allocation ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;ALI 5451&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_ali_card_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">codec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to request irq.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;resources allocated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ali_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="n">snd_ali_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">pcm_streams</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">spdif_support</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">**</span> <span class="n">r_ali</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmdw</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_ali_dev_free</span><span class="p">,</span>
        <span class="p">};</span>

	<span class="o">*</span><span class="n">r_ali</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;creating ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* check, if we can restrict PCI DMA transfers to 31 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">31</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">31</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support &quot;</span>
			   <span class="s">&quot;31bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">codec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">voice_alloc</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_support</span> <span class="o">=</span> <span class="n">spdif_support</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_streams</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pcm_streams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_streams</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">pcm_streams</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmdw</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_COMMAND_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdw</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ali_resources</span><span class="p">(</span><span class="n">codec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_ali_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">chcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">spdif_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">synthcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ALI_5451_V02</span><span class="p">)</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ac97read</span> <span class="o">=</span> <span class="n">ALI_AC97_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ac97read</span> <span class="o">=</span> <span class="n">ALI_AC97_READ</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ac97write</span> <span class="o">=</span> <span class="n">ALI_AC97_WRITE</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">ALI_START</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">ALI_STOP</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">aint</span>   <span class="o">=</span> <span class="n">ALI_AINT</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ainten</span> <span class="o">=</span> <span class="n">ALI_AINTEN</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">aint</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">chregs</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ainten</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* M1533: southbridge */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x10b9</span><span class="p">,</span> <span class="mh">0x1533</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m1533</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali5451: cannot find ALi 1533 chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_ali_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* M7101: power management */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m7101</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x10b9</span><span class="p">,</span> <span class="mh">0x7101</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pci_m7101</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ALI_5451_V02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali5451: cannot find ALi 7101 chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_ali_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;snd_device_new is called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ali_free</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* initialise synth voices*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALI_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">synth</span><span class="p">.</span><span class="n">voices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_chip_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ali create: chip init error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;can&#39;t allocate apm buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">snd_ali_enable_address_interrupt</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">hw_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_ali</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;created.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ali_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ali</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;probe ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">pcm_channels</span><span class="p">,</span> <span class="n">spdif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;mixer building ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_mixer</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	
	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;pcm building ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ali_build_pcms</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">snd_ali_proc_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ALI5451&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ALI 5451&quot;</span><span class="p">);</span>
	
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">snd_ali_printk</span><span class="p">(</span><span class="s">&quot;register card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_ali_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ali5451_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_ali_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_ali_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_ali_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ali_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ali_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>                                

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">ali5451_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
