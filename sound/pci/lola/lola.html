<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › lola › lola.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lola.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Support for Digigram Lola PCI-e boards</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2011 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> *  Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> *  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &quot;lola.h&quot;</span>

<span class="cm">/* Standard options */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Digigram Lola driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Digigram Lola driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Digigram Lola driver.&quot;</span><span class="p">);</span>

<span class="cm">/* Lola-specific options */</span>

<span class="cm">/* for instance use always max granularity which is compatible</span>
<span class="cm"> * with all sample rates</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">granularity</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">LOLA_GRANULARITY_MAX</span>
<span class="p">};</span>

<span class="cm">/* below a sample_rate of 16kHz the analogue audio quality is NOT excellent */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sample_rate_min</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">16000</span>
<span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">granularity</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">granularity</span><span class="p">,</span> <span class="s">&quot;Granularity value&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sample_rate_min</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sample_rate_min</span><span class="p">,</span> <span class="s">&quot;Minimal sample rate&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Digigram, Lola}}&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Digigram Lola driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Takashi Iwai &lt;tiwai@suse.de&gt;&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG_VERBOSE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#define verbose_debug(fmt, args...)			\</span>
<span class="cp">	do { if (debug &gt; 1) printk(KERN_DEBUG SFX fmt, ##args); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define verbose_debug(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * pseudo-codec read/write via CORB/RIRB</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">corb_send_verb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nid</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_cmd_nid</span> <span class="o">=</span> <span class="n">nid</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_verb</span> <span class="o">=</span> <span class="n">verb</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_extdata</span> <span class="o">=</span> <span class="n">extdata</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nid</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">verb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span> <span class="o">&lt;</span> <span class="n">LOLA_CORB_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">wp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wp</span> <span class="o">%=</span> <span class="n">LOLA_CORB_ENTRIES</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">wp</span> <span class="o">=</span> <span class="n">wp</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">wp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">wp</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">extdata</span><span class="p">);</span>
		<span class="n">lola_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBWP</span><span class="p">,</span> <span class="n">wp</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span><span class="o">++</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_queue_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_ex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lola_update_ext_clock_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* retrieve RIRB entry - called from interrupt handler */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_update_rirb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rp</span><span class="p">,</span> <span class="n">wp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_ex</span><span class="p">;</span>

	<span class="n">wp</span> <span class="o">=</span> <span class="n">lola_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBWP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">wp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">wp</span> <span class="o">=</span> <span class="n">wp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">rp</span> <span class="o">!=</span> <span class="n">wp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">rp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">rp</span> <span class="o">%=</span> <span class="n">LOLA_CORB_ENTRIES</span><span class="p">;</span>

		<span class="n">rp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">rp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* an RIRB entry is 8-bytes */</span>
		<span class="n">res_ex</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">rp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">rp</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_ex</span> <span class="o">&amp;</span> <span class="n">LOLA_RIRB_EX_UNSOL_EV</span><span class="p">)</span>
			<span class="n">lola_queue_unsol_event</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_ex</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_ex</span> <span class="o">=</span> <span class="n">res_ex</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rirb_get_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">extval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

 <span class="nl">again:</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">polling_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">lola_update_rirb</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extval</span><span class="p">)</span>
				<span class="o">*</span><span class="n">extval</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_ex</span><span class="p">;</span>
			<span class="n">verbose_debug</span><span class="p">(</span><span class="s">&quot;get_response: %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">chip</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_ex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_ex</span> <span class="o">&amp;</span> <span class="n">LOLA_RIRB_EX_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SFX</span> <span class="s">&quot;RIRB ERROR: &quot;</span>
				       <span class="s">&quot;NID=%x, verb=%x, data=%x, ext=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_cmd_nid</span><span class="p">,</span>
				       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_verb</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_data</span><span class="p">,</span>
				       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">last_extdata</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SFX</span> <span class="s">&quot;RIRB response error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">polling_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SFX</span> <span class="s">&quot;switching to polling mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">polling_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* aynchronous write of a codec verb with data */</span>
<span class="kt">int</span> <span class="nf">lola_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verb</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">verbose_debug</span><span class="p">(</span><span class="s">&quot;codec_write NID=%x, verb=%x, data=%x, ext=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">nid</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">corb_send_verb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write a codec verb with data and read the returned status */</span>
<span class="kt">int</span> <span class="nf">lola_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verb</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extdata</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">extval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">verbose_debug</span><span class="p">(</span><span class="s">&quot;codec_read NID=%x, verb=%x, data=%x, ext=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">nid</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extdata</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">corb_send_verb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rirb_get_response</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">extval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* flush all pending codec writes */</span>
<span class="kt">int</span> <span class="nf">lola_codec_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rirb_get_response</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lola_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">notify_ins</span><span class="p">,</span> <span class="n">notify_outs</span><span class="p">,</span> <span class="n">error_ins</span><span class="p">,</span> <span class="n">error_outs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">notify_ins</span> <span class="o">=</span> <span class="n">notify_outs</span> <span class="o">=</span> <span class="n">error_ins</span> <span class="o">=</span> <span class="n">error_outs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">in_sts</span><span class="p">,</span> <span class="n">out_sts</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DINTSTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">in_sts</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DIINTSTS</span><span class="p">);</span>
		<span class="n">out_sts</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DOINTSTS</span><span class="p">);</span>

		<span class="cm">/* clear Input Interrupts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">in_sts</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">in_sts</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">lola_dsd_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LOLA_DSD_STS_DESE</span><span class="p">)</span> <span class="cm">/* error */</span>
				<span class="n">error_ins</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LOLA_DSD_STS_BCIS</span><span class="p">)</span> <span class="cm">/* notify */</span>
				<span class="n">notify_ins</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/* clear */</span>
			<span class="n">lola_dsd_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">STS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* clear Output Interrupts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">out_sts</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">out_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">out_sts</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">lola_dsd_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MAX_STREAM_IN_COUNT</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LOLA_DSD_STS_DESE</span><span class="p">)</span> <span class="cm">/* error */</span>
				<span class="n">error_outs</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LOLA_DSD_STS_BCIS</span><span class="p">)</span> <span class="cm">/* notify */</span>
				<span class="n">notify_outs</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">lola_dsd_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MAX_STREAM_IN_COUNT</span><span class="p">,</span> <span class="n">STS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LOLA_DINT_CTRL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rbsts</span><span class="p">;</span> <span class="cm">/* ring status is byte access */</span>
			<span class="n">rbsts</span> <span class="o">=</span> <span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBSTS</span><span class="p">);</span>
			<span class="n">rbsts</span> <span class="o">&amp;=</span> <span class="n">LOLA_RIRB_INT_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rbsts</span><span class="p">)</span>
				<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBSTS</span><span class="p">,</span> <span class="n">rbsts</span><span class="p">);</span>
			<span class="n">rbsts</span> <span class="o">=</span> <span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBSTS</span><span class="p">);</span>
			<span class="n">rbsts</span> <span class="o">&amp;=</span> <span class="n">LOLA_CORB_INT_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rbsts</span><span class="p">)</span>
				<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBSTS</span><span class="p">,</span> <span class="n">rbsts</span><span class="p">);</span>

			<span class="n">lola_update_rirb</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LOLA_DINT_FIFOERR</span> <span class="o">|</span> <span class="n">LOLA_DINT_MUERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* clear global fifo error interrupt */</span>
			<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DINTSTS</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LOLA_DINT_FIFOERR</span> <span class="o">|</span> <span class="n">LOLA_DINT_MUERR</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">lola_pcm_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">],</span> <span class="n">notify_ins</span><span class="p">);</span>
	<span class="n">lola_pcm_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">],</span> <span class="n">notify_outs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* to be sure */</span>
		<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">BOARD_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cold_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">,</span> <span class="n">LOLA_GCTL_RESET</span><span class="p">);</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">gctl</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gctl</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;cannot reset controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* enalbe all I/O streams */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DOINTCTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DIINTCTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* enable global irqs */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">LOLA_DINT_GLOBAL</span> <span class="o">|</span> <span class="n">LOLA_DINT_CTRL</span> <span class="o">|</span> <span class="n">LOLA_DINT_FIFOERR</span> <span class="o">|</span>
		<span class="n">LOLA_DINT_MUERR</span><span class="p">;</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DINTCTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DINTCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DIINTCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DOINTCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_corb_rirb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
				  <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				  <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="cm">/* disable ringbuffer DMAs */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBCTL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBCTL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>

	<span class="cm">/* CORB set up */</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBLBASE</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBUBASE</span><span class="p">,</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">addr</span><span class="p">));</span>
	<span class="cm">/* set the corb size to 256 entries */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBSIZE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="cm">/* set the corb write pointer to 0 */</span>
	<span class="n">lola_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBWP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* reset the corb hw read pointer */</span>
	<span class="n">lola_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBRP</span><span class="p">,</span> <span class="n">LOLA_RBRWP_CLR</span><span class="p">);</span>
	<span class="cm">/* enable corb dma */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBCTL</span><span class="p">,</span> <span class="n">LOLA_RBCTL_DMA_EN</span><span class="p">);</span>
	<span class="cm">/* clear flags if set */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBSTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOLA_CORB_INT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBSTS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">corb</span><span class="p">.</span><span class="n">wp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* RIRB set up */</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBLBASE</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">lola_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBUBASE</span><span class="p">,</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">addr</span><span class="p">));</span>
	<span class="cm">/* set the rirb size to 256 entries */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBSIZE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="cm">/* reset the rirb hw write pointer */</span>
	<span class="n">lola_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBWP</span><span class="p">,</span> <span class="n">LOLA_RBRWP_CLR</span><span class="p">);</span>
	<span class="cm">/* set N=1, get RIRB response interrupt for new entry */</span>
	<span class="n">lola_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RINTCNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* enable rirb dma and response irq */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBCTL</span><span class="p">,</span> <span class="n">LOLA_RBCTL_DMA_EN</span> <span class="o">|</span> <span class="n">LOLA_RBCTL_IRQ_EN</span><span class="p">);</span>
	<span class="cm">/* clear flags if set */</span>
	<span class="n">tmp</span> <span class="o">=</span>  <span class="n">lola_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBSTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOLA_RIRB_INT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBSTS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">rp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rirb</span><span class="p">.</span><span class="n">cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_corb_rirb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable ringbuffer DMAs */</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">RIRBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lola_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR0</span><span class="p">,</span> <span class="n">CORBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_reset_setups</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* update the granularity */</span>
	<span class="n">lola_set_granularity</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="cm">/* update the sample clock */</span>
	<span class="n">lola_set_clock_index</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">cur_index</span><span class="p">);</span>
	<span class="cm">/* enable unsolicited events of the clock widget */</span>
	<span class="n">lola_enable_clock_events</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* update the analog gains */</span>
	<span class="n">lola_setup_all_analog_gains</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CAPT</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="cm">/* input, update */</span>
	<span class="cm">/* update SRC configuration if applicable */</span>
	<span class="n">lola_set_src_config</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_src_mask</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="cm">/* update the analog outputs */</span>
	<span class="n">lola_setup_all_analog_gains</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PLAY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="cm">/* output, update */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lola_parse_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_read_param</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LOLA_PAR_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Can&#39;t read VENDOR_ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x1369</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Unknown codec vendor 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_read_param</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LOLA_PAR_FUNCTION_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Can&#39;t read FUNCTION_TYPE for 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Unknown function type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_read_param</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LOLA_PAR_SPECIFIC_CAPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Can&#39;t read SPECCAPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_pins</span> <span class="o">=</span> <span class="n">LOLA_AFG_INPUT_PIN_COUNT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_pins</span> <span class="o">=</span> <span class="n">LOLA_AFG_OUTPUT_PIN_COUNT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="n">SFX</span> <span class="s">&quot;speccaps=0x%x, pins in=%d, out=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_pins</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_pins</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_pins</span> <span class="o">&gt;</span> <span class="n">MAX_AUDIO_INOUT_COUNT</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_pins</span> <span class="o">&gt;</span> <span class="n">MAX_AUDIO_INOUT_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Invalid Lola-spec caps 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CAPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PLAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_pins</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CAPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_pins</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PLAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LOLA_AFG_CLOCK_WIDGET_PRESENT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_clock_widget</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">nid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LOLA_AFG_MIXER_WIDGET_PRESENT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lola_caps</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">lola_init_mixer_widget</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">nid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable unsolicited events of the clock widget */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_enable_clock_events</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* if last ResetController was not a ColdReset, we don&#39;t know</span>
<span class="cm">	 * the state of the card; initialize here again</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cold_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lola_reset_setups</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cold_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set the granularity if it is not the default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span> <span class="o">!=</span> <span class="n">LOLA_GRANULARITY_MIN</span><span class="p">)</span>
			<span class="n">lola_set_granularity</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_stop_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stop_corb_rirb</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">lola_irq_disable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lola_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">lola_stop_hw</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">lola_free_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">lola_free_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lola_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lola_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lola_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lola</span> <span class="o">**</span><span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dever</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">lola_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;cannot allocate chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span> <span class="o">=</span> <span class="n">granularity</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SFX</span>
			   <span class="s">&quot;Invalid granularity %d, reset to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span><span class="p">,</span> <span class="n">LOLA_GRANULARITY_MAX</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">granularity</span> <span class="o">=</span> <span class="n">LOLA_GRANULARITY_MAX</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_min</span> <span class="o">=</span> <span class="n">sample_rate_min</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_min</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SFX</span>
			   <span class="s">&quot;Invalid sample_rate_min %d, reset to 16000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_min</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sample_rate_min</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DRVNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">remap_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">remap_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;ioremap error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">reset_controller</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lola_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">dever</span> <span class="o">=</span> <span class="n">lola_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BAR1</span><span class="p">,</span> <span class="n">DEVER</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span> <span class="o">=</span> <span class="p">(</span><span class="n">dever</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span> <span class="o">=</span> <span class="p">(</span><span class="n">dever</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">dever</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="n">SFX</span> <span class="s">&quot;streams in=%d, out=%d, version=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="cm">/* Test LOLA_BAR1_DEVER */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span> <span class="o">&gt;</span> <span class="n">MAX_STREAM_IN_COUNT</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span> <span class="o">&gt;</span> <span class="n">MAX_STREAM_OUT_COUNT</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">CAPT</span><span class="p">].</span><span class="n">num_streams</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">PLAY</span><span class="p">].</span><span class="n">num_streams</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;invalid DEVER = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dever</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_corb_rirb</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Error creating device [card]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;Lola&quot;</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Digigram Lola&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s at 0x%lx irq %i&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>

	<span class="n">lola_irq_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">errout:</span>
	<span class="n">lola_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lola_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lola</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SFX</span> <span class="s">&quot;Error creating card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_parse_tree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_create_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lola_create_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">lola_proc_debug_new</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">lola_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PCI IDs */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">lola_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGIGRAM</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">lola_ids</span><span class="p">);</span>

<span class="cm">/* pci_driver definition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">lola_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">lola_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">lola_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">lola_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">lola_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
