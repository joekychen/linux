<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › es1968.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>es1968.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for ESS Maestro 1/2/2E Sound Card (started 21.8.99)</span>
<span class="cm"> *  Copyright (c) by Matze Braun &lt;MatzeBraun@gmx.de&gt;.</span>
<span class="cm"> *                   Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *                  </span>
<span class="cm"> *  Most of the driver code comes from Zach Brown(zab@redhat.com)</span>
<span class="cm"> *	Alan Cox OSS Driver</span>
<span class="cm"> *  Rewritted from card-es1938.c source.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *   Perhaps Synth</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Notes from Zach Brown about the driver code</span>
<span class="cm"> *</span>
<span class="cm"> *  Hardware Description</span>
<span class="cm"> *</span>
<span class="cm"> *	A working Maestro setup contains the Maestro chip wired to a </span>
<span class="cm"> *	codec or 2.  In the Maestro we have the APUs, the ASSP, and the</span>
<span class="cm"> *	Wavecache.  The APUs can be though of as virtual audio routing</span>
<span class="cm"> *	channels.  They can take data from a number of sources and perform</span>
<span class="cm"> *	basic encodings of the data.  The wavecache is a storehouse for</span>
<span class="cm"> *	PCM data.  Typically it deals with PCI and interracts with the</span>
<span class="cm"> *	APUs.  The ASSP is a wacky DSP like device that ESS is loth</span>
<span class="cm"> *	to release docs on.  Thankfully it isn&#39;t required on the Maestro</span>
<span class="cm"> *	until you start doing insane things like FM emulation and surround</span>
<span class="cm"> *	encoding.  The codecs are almost always AC-97 compliant codecs, </span>
<span class="cm"> *	but it appears that early Maestros may have had PT101 (an ESS</span>
<span class="cm"> *	part?) wired to them.  The only real difference in the Maestro</span>
<span class="cm"> *	families is external goop like docking capability, memory for</span>
<span class="cm"> *	the ASSP, and initialization differences.</span>
<span class="cm"> *</span>
<span class="cm"> *  Driver Operation</span>
<span class="cm"> *</span>
<span class="cm"> *	We only drive the APU/Wavecache as typical DACs and drive the</span>
<span class="cm"> *	mixers in the codecs.  There are 64 APUs.  We assign 6 to each</span>
<span class="cm"> *	/dev/dsp? device.  2 channels for output, and 4 channels for</span>
<span class="cm"> *	input.</span>
<span class="cm"> *</span>
<span class="cm"> *	Each APU can do a number of things, but we only really use</span>
<span class="cm"> *	3 basic functions.  For playback we use them to convert PCM</span>
<span class="cm"> *	data fetched over PCI by the wavecahche into analog data that</span>
<span class="cm"> *	is handed to the codec.  One APU for mono, and a pair for stereo.</span>
<span class="cm"> *	When in stereo, the combination of smarts in the APU and Wavecache</span>
<span class="cm"> *	decide which wavecache gets the left or right channel.</span>
<span class="cm"> *</span>
<span class="cm"> *	For record we still use the old overly mono system.  For each in</span>
<span class="cm"> *	coming channel the data comes in from the codec, through a &#39;input&#39;</span>
<span class="cm"> *	APU, through another rate converter APU, and then into memory via</span>
<span class="cm"> *	the wavecache and PCI.  If its stereo, we mash it back into LRLR in</span>
<span class="cm"> *	software.  The pass between the 2 APUs is supposedly what requires us</span>
<span class="cm"> *	to have a 512 byte buffer sitting around in wavecache/memory.</span>
<span class="cm"> *</span>
<span class="cm"> *	The wavecache makes our life even more fun.  First off, it can</span>
<span class="cm"> *	only address the first 28 bits of PCI address space, making it</span>
<span class="cm"> *	useless on quite a few architectures.  Secondly, its insane.</span>
<span class="cm"> *	It claims to fetch from 4 regions of PCI space, each 4 meg in length.</span>
<span class="cm"> *	But that doesn&#39;t really work.  You can only use 1 region.  So all our</span>
<span class="cm"> *	allocations have to be in 4meg of each other.  Booo.  Hiss.</span>
<span class="cm"> *	So we have a module parameter, dsps_order, that is the order of</span>
<span class="cm"> *	the number of dsps to provide.  All their buffer space is allocated</span>
<span class="cm"> *	on open time.  The sonicvibes OSS routines we inherited really want</span>
<span class="cm"> *	power of 2 buffers, so we have all those next to each other, then</span>
<span class="cm"> *	512 byte regions for the recording wavecaches.  This ends up</span>
<span class="cm"> *	wasting quite a bit of memory.  The only fixes I can see would be </span>
<span class="cm"> *	getting a kernel allocator that could work in zones, or figuring out</span>
<span class="cm"> *	just how to coerce the WP into doing what we want.</span>
<span class="cm"> *</span>
<span class="cm"> *	The indirection of the various registers means we have to spinlock</span>
<span class="cm"> *	nearly all register accesses.  We have the main register indirection</span>
<span class="cm"> *	like the wave cache, maestro registers, etc.  Then we have beasts</span>
<span class="cm"> *	like the APU interface that is indirect registers gotten at through</span>
<span class="cm"> *	the main maestro indirection.  Ouch.  We spinlock around the actual</span>
<span class="cm"> *	ports on a per card basis.  This means spinlock activity at each IO</span>
<span class="cm"> *	operation, but the only IO operation clusters are in non critical </span>
<span class="cm"> *	paths and it makes the code far easier to follow.  Interrupts are</span>
<span class="cm"> *	blocked while holding the locks because the int handler has to</span>
<span class="cm"> *	get at some of them :(.  The mixer interface doesn&#39;t, however.</span>
<span class="cm"> *	We also have an OSS state lock that is thrown around in a few</span>
<span class="cm"> *	places.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_RADIO</span>
<span class="cp">#include &lt;sound/tea575x-tuner.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define CARD_NAME &quot;ESS Maestro1/2&quot;</span>
<span class="cp">#define DRIVER_NAME &quot;ES1968&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ESS Maestro&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{ESS,Maestro 2e},&quot;</span>
		<span class="s">&quot;{ESS,Maestro 2},&quot;</span>
		<span class="s">&quot;{ESS,Maestro 1},&quot;</span>
		<span class="s">&quot;{TerraTec,DMX}}&quot;</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>
<span class="cp">#define SUPPORT_JOYSTICK 1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 1-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">total_bufsize</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1024</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcm_substreams_p</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcm_substreams_c</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_pm</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_mpu</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">};</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">joystick</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_nr</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">total_bufsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">total_bufsize</span><span class="p">,</span> <span class="s">&quot;Total buffer size in kB.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pcm_substreams_p</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pcm_substreams_p</span><span class="p">,</span> <span class="s">&quot;PCM Playback substreams for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pcm_substreams_c</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pcm_substreams_c</span><span class="p">,</span> <span class="s">&quot;PCM Capture substreams for &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="s">&quot;Clock on &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.  (0 = auto-detect)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">use_pm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_pm</span><span class="p">,</span> <span class="s">&quot;Toggle power-management.  (0 = off, 1 = on, 2 = auto)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable_mpu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_mpu</span><span class="p">,</span> <span class="s">&quot;Enable MPU401.  (0 = off, 1 = on, 2 = auto)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="s">&quot;Enable joystick.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;Radio device numbers&quot;</span><span class="p">);</span>



<span class="cp">#define NR_APUS			64</span>
<span class="cp">#define NR_APU_REGS		16</span>

<span class="cm">/* NEC Versas ? */</span>
<span class="cp">#define NEC_VERSA_SUBID1	0x80581033</span>
<span class="cp">#define NEC_VERSA_SUBID2	0x803c1033</span>

<span class="cm">/* Mode Flags */</span>
<span class="cp">#define ESS_FMT_STEREO     	0x01</span>
<span class="cp">#define ESS_FMT_16BIT      	0x02</span>

<span class="cp">#define DAC_RUNNING		1</span>
<span class="cp">#define ADC_RUNNING		2</span>

<span class="cm">/* Values for the ESM_LEGACY_AUDIO_CONTROL */</span>

<span class="cp">#define ESS_DISABLE_AUDIO	0x8000</span>
<span class="cp">#define ESS_ENABLE_SERIAL_IRQ	0x4000</span>
<span class="cp">#define IO_ADRESS_ALIAS		0x0020</span>
<span class="cp">#define MPU401_IRQ_ENABLE	0x0010</span>
<span class="cp">#define MPU401_IO_ENABLE	0x0008</span>
<span class="cp">#define GAME_IO_ENABLE		0x0004</span>
<span class="cp">#define FM_IO_ENABLE		0x0002</span>
<span class="cp">#define SB_IO_ENABLE		0x0001</span>

<span class="cm">/* Values for the ESM_CONFIG_A */</span>

<span class="cp">#define PIC_SNOOP1		0x4000</span>
<span class="cp">#define PIC_SNOOP2		0x2000</span>
<span class="cp">#define SAFEGUARD		0x0800</span>
<span class="cp">#define DMA_CLEAR		0x0700</span>
<span class="cp">#define DMA_DDMA		0x0000</span>
<span class="cp">#define DMA_TDMA		0x0100</span>
<span class="cp">#define DMA_PCPCI		0x0200</span>
<span class="cp">#define POST_WRITE		0x0080</span>
<span class="cp">#define PCI_TIMING		0x0040</span>
<span class="cp">#define SWAP_LR			0x0020</span>
<span class="cp">#define SUBTR_DECODE		0x0002</span>

<span class="cm">/* Values for the ESM_CONFIG_B */</span>

<span class="cp">#define SPDIF_CONFB		0x0100</span>
<span class="cp">#define HWV_CONFB		0x0080</span>
<span class="cp">#define DEBOUNCE		0x0040</span>
<span class="cp">#define GPIO_CONFB		0x0020</span>
<span class="cp">#define CHI_CONFB		0x0010</span>
<span class="cp">#define IDMA_CONFB		0x0008	</span><span class="cm">/*undoc */</span><span class="cp"></span>
<span class="cp">#define MIDI_FIX		0x0004	</span><span class="cm">/*undoc */</span><span class="cp"></span>
<span class="cp">#define IRQ_TO_ISA		0x0001	</span><span class="cm">/*undoc */</span><span class="cp"></span>

<span class="cm">/* Values for Ring Bus Control B */</span>
<span class="cp">#define	RINGB_2CODEC_ID_MASK	0x0003</span>
<span class="cp">#define RINGB_DIS_VALIDATION	0x0008</span>
<span class="cp">#define RINGB_EN_SPDIF		0x0010</span>
<span class="cp">#define	RINGB_EN_2CODEC		0x0020</span>
<span class="cp">#define RINGB_SING_BIT_DUAL	0x0040</span>

<span class="cm">/* ****Port Addresses**** */</span>

<span class="cm">/*   Write &amp; Read */</span>
<span class="cp">#define ESM_INDEX		0x02</span>
<span class="cp">#define ESM_DATA		0x00</span>

<span class="cm">/*   AC97 + RingBus */</span>
<span class="cp">#define ESM_AC97_INDEX		0x30</span>
<span class="cp">#define	ESM_AC97_DATA		0x32</span>
<span class="cp">#define ESM_RING_BUS_DEST	0x34</span>
<span class="cp">#define ESM_RING_BUS_CONTR_A	0x36</span>
<span class="cp">#define ESM_RING_BUS_CONTR_B	0x38</span>
<span class="cp">#define ESM_RING_BUS_SDO	0x3A</span>

<span class="cm">/*   WaveCache*/</span>
<span class="cp">#define WC_INDEX		0x10</span>
<span class="cp">#define WC_DATA			0x12</span>
<span class="cp">#define WC_CONTROL		0x14</span>

<span class="cm">/*   ASSP*/</span>
<span class="cp">#define ASSP_INDEX		0x80</span>
<span class="cp">#define ASSP_MEMORY		0x82</span>
<span class="cp">#define ASSP_DATA		0x84</span>
<span class="cp">#define ASSP_CONTROL_A		0xA2</span>
<span class="cp">#define ASSP_CONTROL_B		0xA4</span>
<span class="cp">#define ASSP_CONTROL_C		0xA6</span>
<span class="cp">#define ASSP_HOSTW_INDEX	0xA8</span>
<span class="cp">#define ASSP_HOSTW_DATA		0xAA</span>
<span class="cp">#define ASSP_HOSTW_IRQ		0xAC</span>
<span class="cm">/* Midi */</span>
<span class="cp">#define ESM_MPU401_PORT		0x98</span>
<span class="cm">/* Others */</span>
<span class="cp">#define ESM_PORT_HOST_IRQ	0x18</span>

<span class="cp">#define IDR0_DATA_PORT		0x00</span>
<span class="cp">#define IDR1_CRAM_POINTER	0x01</span>
<span class="cp">#define IDR2_CRAM_DATA		0x02</span>
<span class="cp">#define IDR3_WAVE_DATA		0x03</span>
<span class="cp">#define IDR4_WAVE_PTR_LOW	0x04</span>
<span class="cp">#define IDR5_WAVE_PTR_HI	0x05</span>
<span class="cp">#define IDR6_TIMER_CTRL		0x06</span>
<span class="cp">#define IDR7_WAVE_ROMRAM	0x07</span>

<span class="cp">#define WRITEABLE_MAP		0xEFFFFF</span>
<span class="cp">#define READABLE_MAP		0x64003F</span>

<span class="cm">/* PCI Register */</span>

<span class="cp">#define ESM_LEGACY_AUDIO_CONTROL 0x40</span>
<span class="cp">#define ESM_ACPI_COMMAND	0x54</span>
<span class="cp">#define ESM_CONFIG_A		0x50</span>
<span class="cp">#define ESM_CONFIG_B		0x52</span>
<span class="cp">#define ESM_DDMA		0x60</span>

<span class="cm">/* Bob Bits */</span>
<span class="cp">#define ESM_BOB_ENABLE		0x0001</span>
<span class="cp">#define ESM_BOB_START		0x0001</span>

<span class="cm">/* Host IRQ Control Bits */</span>
<span class="cp">#define ESM_RESET_MAESTRO	0x8000</span>
<span class="cp">#define ESM_RESET_DIRECTSOUND   0x4000</span>
<span class="cp">#define ESM_HIRQ_ClkRun		0x0100</span>
<span class="cp">#define ESM_HIRQ_HW_VOLUME	0x0040</span>
<span class="cp">#define ESM_HIRQ_HARPO		0x0030	</span><span class="cm">/* What&#39;s that? */</span><span class="cp"></span>
<span class="cp">#define ESM_HIRQ_ASSP		0x0010</span>
<span class="cp">#define	ESM_HIRQ_DSIE		0x0004</span>
<span class="cp">#define ESM_HIRQ_MPU401		0x0002</span>
<span class="cp">#define ESM_HIRQ_SB		0x0001</span>

<span class="cm">/* Host IRQ Status Bits */</span>
<span class="cp">#define ESM_MPU401_IRQ		0x02</span>
<span class="cp">#define ESM_SB_IRQ		0x01</span>
<span class="cp">#define ESM_SOUND_IRQ		0x04</span>
<span class="cp">#define	ESM_ASSP_IRQ		0x10</span>
<span class="cp">#define ESM_HWVOL_IRQ		0x40</span>

<span class="cp">#define ESS_SYSCLK		50000000</span>
<span class="cp">#define ESM_BOB_FREQ 		200</span>
<span class="cp">#define ESM_BOB_FREQ_MAX	800</span>

<span class="cp">#define ESM_FREQ_ESM1  		(49152000L / 1024L)	</span><span class="cm">/* default rate 48000 */</span><span class="cp"></span>
<span class="cp">#define ESM_FREQ_ESM2  		(50000000L / 1024L)</span>

<span class="cm">/* APU Modes: reg 0x00, bit 4-7 */</span>
<span class="cp">#define ESM_APU_MODE_SHIFT	4</span>
<span class="cp">#define ESM_APU_MODE_MASK	(0xf &lt;&lt; 4)</span>
<span class="cp">#define	ESM_APU_OFF		0x00</span>
<span class="cp">#define	ESM_APU_16BITLINEAR	0x01	</span><span class="cm">/* 16-Bit Linear Sample Player */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_16BITSTEREO	0x02	</span><span class="cm">/* 16-Bit Stereo Sample Player */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_8BITLINEAR	0x03	</span><span class="cm">/* 8-Bit Linear Sample Player */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_8BITSTEREO	0x04	</span><span class="cm">/* 8-Bit Stereo Sample Player */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_8BITDIFF	0x05	</span><span class="cm">/* 8-Bit Differential Sample Playrer */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_DIGITALDELAY	0x06	</span><span class="cm">/* Digital Delay Line */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_DUALTAP		0x07	</span><span class="cm">/* Dual Tap Reader */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_CORRELATOR	0x08	</span><span class="cm">/* Correlator */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_INPUTMIXER	0x09	</span><span class="cm">/* Input Mixer */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_WAVETABLE	0x0A	</span><span class="cm">/* Wave Table Mode */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_SRCONVERTOR	0x0B	</span><span class="cm">/* Sample Rate Convertor */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_16BITPINGPONG	0x0C	</span><span class="cm">/* 16-Bit Ping-Pong Sample Player */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_RESERVED1	0x0D	</span><span class="cm">/* Reserved 1 */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_RESERVED2	0x0E	</span><span class="cm">/* Reserved 2 */</span><span class="cp"></span>
<span class="cp">#define	ESM_APU_RESERVED3	0x0F	</span><span class="cm">/* Reserved 3 */</span><span class="cp"></span>

<span class="cm">/* reg 0x00 */</span>
<span class="cp">#define ESM_APU_FILTER_Q_SHIFT		0</span>
<span class="cp">#define ESM_APU_FILTER_Q_MASK		(3 &lt;&lt; 0)</span>
<span class="cm">/* APU Filtey Q Control */</span>
<span class="cp">#define ESM_APU_FILTER_LESSQ	0x00</span>
<span class="cp">#define ESM_APU_FILTER_MOREQ	0x03</span>

<span class="cp">#define ESM_APU_FILTER_TYPE_SHIFT	2</span>
<span class="cp">#define ESM_APU_FILTER_TYPE_MASK	(3 &lt;&lt; 2)</span>
<span class="cp">#define ESM_APU_ENV_TYPE_SHIFT		8</span>
<span class="cp">#define ESM_APU_ENV_TYPE_MASK		(3 &lt;&lt; 8)</span>
<span class="cp">#define ESM_APU_ENV_STATE_SHIFT		10</span>
<span class="cp">#define ESM_APU_ENV_STATE_MASK		(3 &lt;&lt; 10)</span>
<span class="cp">#define ESM_APU_END_CURVE		(1 &lt;&lt; 12)</span>
<span class="cp">#define ESM_APU_INT_ON_LOOP		(1 &lt;&lt; 13)</span>
<span class="cp">#define ESM_APU_DMA_ENABLE		(1 &lt;&lt; 14)</span>

<span class="cm">/* reg 0x02 */</span>
<span class="cp">#define ESM_APU_SUBMIX_GROUP_SHIRT	0</span>
<span class="cp">#define ESM_APU_SUBMIX_GROUP_MASK	(7 &lt;&lt; 0)</span>
<span class="cp">#define ESM_APU_SUBMIX_MODE		(1 &lt;&lt; 3)</span>
<span class="cp">#define ESM_APU_6dB			(1 &lt;&lt; 4)</span>
<span class="cp">#define ESM_APU_DUAL_EFFECT		(1 &lt;&lt; 5)</span>
<span class="cp">#define ESM_APU_EFFECT_CHANNELS_SHIFT	6</span>
<span class="cp">#define ESM_APU_EFFECT_CHANNELS_MASK	(3 &lt;&lt; 6)</span>

<span class="cm">/* reg 0x03 */</span>
<span class="cp">#define ESM_APU_STEP_SIZE_MASK		0x0fff</span>

<span class="cm">/* reg 0x04 */</span>
<span class="cp">#define ESM_APU_PHASE_SHIFT		0</span>
<span class="cp">#define ESM_APU_PHASE_MASK		(0xff &lt;&lt; 0)</span>
<span class="cp">#define ESM_APU_WAVE64K_PAGE_SHIFT	8	</span><span class="cm">/* most 8bit of wave start offset */</span><span class="cp"></span>
<span class="cp">#define ESM_APU_WAVE64K_PAGE_MASK	(0xff &lt;&lt; 8)</span>

<span class="cm">/* reg 0x05 - wave start offset */</span>
<span class="cm">/* reg 0x06 - wave end offset */</span>
<span class="cm">/* reg 0x07 - wave loop length */</span>

<span class="cm">/* reg 0x08 */</span>
<span class="cp">#define ESM_APU_EFFECT_GAIN_SHIFT	0</span>
<span class="cp">#define ESM_APU_EFFECT_GAIN_MASK	(0xff &lt;&lt; 0)</span>
<span class="cp">#define ESM_APU_TREMOLO_DEPTH_SHIFT	8</span>
<span class="cp">#define ESM_APU_TREMOLO_DEPTH_MASK	(0xf &lt;&lt; 8)</span>
<span class="cp">#define ESM_APU_TREMOLO_RATE_SHIFT	12</span>
<span class="cp">#define ESM_APU_TREMOLO_RATE_MASK	(0xf &lt;&lt; 12)</span>

<span class="cm">/* reg 0x09 */</span>
<span class="cm">/* bit 0-7 amplitude dest? */</span>
<span class="cp">#define ESM_APU_AMPLITUDE_NOW_SHIFT	8</span>
<span class="cp">#define ESM_APU_AMPLITUDE_NOW_MASK	(0xff &lt;&lt; 8)</span>

<span class="cm">/* reg 0x0a */</span>
<span class="cp">#define ESM_APU_POLAR_PAN_SHIFT		0</span>
<span class="cp">#define ESM_APU_POLAR_PAN_MASK		(0x3f &lt;&lt; 0)</span>
<span class="cm">/* Polar Pan Control */</span>
<span class="cp">#define	ESM_APU_PAN_CENTER_CIRCLE		0x00</span>
<span class="cp">#define	ESM_APU_PAN_MIDDLE_RADIUS		0x01</span>
<span class="cp">#define	ESM_APU_PAN_OUTSIDE_RADIUS		0x02</span>

<span class="cp">#define ESM_APU_FILTER_TUNING_SHIFT	8</span>
<span class="cp">#define ESM_APU_FILTER_TUNING_MASK	(0xff &lt;&lt; 8)</span>

<span class="cm">/* reg 0x0b */</span>
<span class="cp">#define ESM_APU_DATA_SRC_A_SHIFT	0</span>
<span class="cp">#define ESM_APU_DATA_SRC_A_MASK		(0x7f &lt;&lt; 0)</span>
<span class="cp">#define ESM_APU_INV_POL_A		(1 &lt;&lt; 7)</span>
<span class="cp">#define ESM_APU_DATA_SRC_B_SHIFT	8</span>
<span class="cp">#define ESM_APU_DATA_SRC_B_MASK		(0x7f &lt;&lt; 8)</span>
<span class="cp">#define ESM_APU_INV_POL_B		(1 &lt;&lt; 15)</span>

<span class="cp">#define ESM_APU_VIBRATO_RATE_SHIFT	0</span>
<span class="cp">#define ESM_APU_VIBRATO_RATE_MASK	(0xf &lt;&lt; 0)</span>
<span class="cp">#define ESM_APU_VIBRATO_DEPTH_SHIFT	4</span>
<span class="cp">#define ESM_APU_VIBRATO_DEPTH_MASK	(0xf &lt;&lt; 4)</span>
<span class="cp">#define ESM_APU_VIBRATO_PHASE_SHIFT	8</span>
<span class="cp">#define ESM_APU_VIBRATO_PHASE_MASK	(0xff &lt;&lt; 8)</span>

<span class="cm">/* reg 0x0c */</span>
<span class="cp">#define ESM_APU_RADIUS_SELECT		(1 &lt;&lt; 6)</span>

<span class="cm">/* APU Filter Control */</span>
<span class="cp">#define	ESM_APU_FILTER_2POLE_LOPASS	0x00</span>
<span class="cp">#define	ESM_APU_FILTER_2POLE_BANDPASS	0x01</span>
<span class="cp">#define	ESM_APU_FILTER_2POLE_HIPASS	0x02</span>
<span class="cp">#define	ESM_APU_FILTER_1POLE_LOPASS	0x03</span>
<span class="cp">#define	ESM_APU_FILTER_1POLE_HIPASS	0x04</span>
<span class="cp">#define	ESM_APU_FILTER_OFF		0x05</span>

<span class="cm">/* APU ATFP Type */</span>
<span class="cp">#define	ESM_APU_ATFP_AMPLITUDE			0x00</span>
<span class="cp">#define	ESM_APU_ATFP_TREMELO			0x01</span>
<span class="cp">#define	ESM_APU_ATFP_FILTER			0x02</span>
<span class="cp">#define	ESM_APU_ATFP_PAN			0x03</span>

<span class="cm">/* APU ATFP Flags */</span>
<span class="cp">#define	ESM_APU_ATFP_FLG_OFF			0x00</span>
<span class="cp">#define	ESM_APU_ATFP_FLG_WAIT			0x01</span>
<span class="cp">#define	ESM_APU_ATFP_FLG_DONE			0x02</span>
<span class="cp">#define	ESM_APU_ATFP_FLG_INPROCESS		0x03</span>


<span class="cm">/* capture mixing buffer size */</span>
<span class="cp">#define ESM_MEM_ALIGN		0x1000</span>
<span class="cp">#define ESM_MIXBUF_SIZE		0x400</span>

<span class="cp">#define ESM_MODE_PLAY		0</span>
<span class="cp">#define ESM_MODE_CAPTURE	1</span>


<span class="cm">/* APU use in the driver */</span>
<span class="k">enum</span> <span class="n">snd_enum_apu_type</span> <span class="p">{</span>
	<span class="n">ESM_APU_PCM_PLAY</span><span class="p">,</span>
	<span class="n">ESM_APU_PCM_CAPTURE</span><span class="p">,</span>
	<span class="n">ESM_APU_PCM_RATECONV</span><span class="p">,</span>
	<span class="n">ESM_APU_FREE</span>
<span class="p">};</span>

<span class="cm">/* chip type */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TYPE_MAESTRO</span><span class="p">,</span> <span class="n">TYPE_MAESTRO2</span><span class="p">,</span> <span class="n">TYPE_MAESTRO2E</span>
<span class="p">};</span>

<span class="cm">/* DMA Hack! */</span>
<span class="k">struct</span> <span class="n">esm_memory</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">empty</span><span class="p">;</span>	<span class="cm">/* status */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Playback Channel */</span>
<span class="k">struct</span> <span class="n">esschan</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">apu</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">apu_mode</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* playback/capture pcm buffer */</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">memory</span><span class="p">;</span>
	<span class="cm">/* capture mixer buffer */</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">mixbuf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwptr</span><span class="p">;</span>	<span class="cm">/* current hw pointer in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* sample counter in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_size</span><span class="p">;</span>	<span class="cm">/* total buffer size in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag_size</span><span class="p">;</span>	<span class="cm">/* period size in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wav_shift</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">base</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* offset for ptr */</span>

	<span class="cm">/* stereo/16bit flag */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>	<span class="cm">/* playback / capture */</span>

	<span class="kt">int</span> <span class="n">bob_freq</span><span class="p">;</span>	<span class="cm">/* required timer frequency */</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="cm">/* linked list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">u16</span> <span class="n">wc_map</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">es1968</span> <span class="p">{</span>
	<span class="cm">/* Module Config */</span>
	<span class="kt">int</span> <span class="n">total_bufsize</span><span class="p">;</span>			<span class="cm">/* in bytes */</span>

	<span class="kt">int</span> <span class="n">playback_streams</span><span class="p">,</span> <span class="n">capture_streams</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>		<span class="cm">/* clock */</span>
	<span class="cm">/* for clock measurement */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_measurement</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">measure_apu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">measure_lastpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">measure_count</span><span class="p">;</span>

	<span class="cm">/* buffer */</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* Resources... */</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_pm</span><span class="p">;</span>		<span class="cm">/* power-management enabled */</span>

	<span class="cm">/* DMA memory block */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">buf_list</span><span class="p">;</span>

	<span class="cm">/* ALSA Stuff */</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_suspend</span><span class="p">;</span>

	<span class="cm">/* Maestro Stuff */</span>
	<span class="n">u16</span> <span class="n">maestro_map</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bobclient</span><span class="p">;</span>		<span class="cm">/* active timer instancs */</span>
	<span class="kt">int</span> <span class="n">bob_freq</span><span class="p">;</span>		<span class="cm">/* timer frequency */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">memory_mutex</span><span class="p">;</span>	<span class="cm">/* memory lock */</span>

	<span class="cm">/* APU states */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">apu</span><span class="p">[</span><span class="n">NR_APUS</span><span class="p">];</span>

	<span class="cm">/* active substreams */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">substream_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">substream_lock</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">u16</span> <span class="n">apu_map</span><span class="p">[</span><span class="n">NR_APUS</span><span class="p">][</span><span class="n">NR_APU_REGS</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_INPUT</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>			<span class="cm">/* physical device path */</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_switch</span><span class="p">;</span> <span class="cm">/* for h/w volume control */</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_volume</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">hwvol_work</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_RADIO</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_tea575x</span> <span class="n">tea</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_es1968_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_es1968_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Maestro 1 */</span>
        <span class="p">{</span> <span class="mh">0x1285</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="n">TYPE_MAESTRO</span> <span class="p">},</span>
	<span class="cm">/* Maestro 2 */</span>
	<span class="p">{</span> <span class="mh">0x125d</span><span class="p">,</span> <span class="mh">0x1968</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="n">TYPE_MAESTRO2</span> <span class="p">},</span>
	<span class="cm">/* Maestro 2E */</span>
        <span class="p">{</span> <span class="mh">0x125d</span><span class="p">,</span> <span class="mh">0x1978</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_CLASS_MULTIMEDIA_AUDIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="n">TYPE_MAESTRO2E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_es1968_ids</span><span class="p">);</span>

<span class="cm">/* *********************</span>
<span class="cm">   * Low Level Funcs!  *</span>
<span class="cm">   *********************/</span>

<span class="cm">/* no spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__maestro_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_INDEX</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_DATA</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">maestro_map</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">maestro_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* no spinlock */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">__maestro_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">READABLE_MAP</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_INDEX</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">maestro_map</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_DATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">maestro_map</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">maestro_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait for the codec bus to be free */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_ac97_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;es1968: ac97 timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* timeout */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_ac97_wait_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;es1968: ac97 timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* timeout */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_es1968_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Write the bus */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_DATA</span><span class="p">);</span>
	<span class="cm">/*msleep(1);*/</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_INDEX</span><span class="p">);</span>
	<span class="cm">/*msleep(1);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_es1968_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_es1968_ac97_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_INDEX</span><span class="p">);</span>
	<span class="cm">/*msleep(1);*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_es1968_ac97_wait_poll</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_AC97_DATA</span><span class="p">);</span>
		<span class="cm">/*msleep(1);*/</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* no spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">apu_index_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR1_CRAM_POINTER</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR1_CRAM_POINTER</span><span class="p">)</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;es1968: APU register select failed. (Timeout)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* no spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">apu_data_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR0_DATA_PORT</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR0_DATA_PORT</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;es1968: APU register set probably failed (Timeout)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* no spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__apu_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">NR_APUS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu_map</span><span class="p">[</span><span class="n">channel</span><span class="p">][</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">apu_index_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">apu_data_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apu_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">__apu_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">NR_APUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">apu_index_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR0_DATA_PORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">apu_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">__apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* ASSP is not supported */</span>

<span class="c">static void assp_set_register(struct es1968 *chip, u32 reg, u32 value)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>

<span class="c">	spin_lock_irqsave(&amp;chip-&gt;reg_lock, flags);</span>
<span class="c">	outl(reg, chip-&gt;io_port + ASSP_INDEX);</span>
<span class="c">	outl(value, chip-&gt;io_port + ASSP_DATA);</span>
<span class="c">	spin_unlock_irqrestore(&amp;chip-&gt;reg_lock, flags);</span>
<span class="c">}</span>

<span class="c">static u32 assp_get_register(struct es1968 *chip, u32 reg)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>
<span class="c">	u32 value;</span>

<span class="c">	spin_lock_irqsave(&amp;chip-&gt;reg_lock, flags);</span>
<span class="c">	outl(reg, chip-&gt;io_port + ASSP_INDEX);</span>
<span class="c">	value = inl(chip-&gt;io_port + ASSP_DATA);</span>
<span class="c">	spin_unlock_irqrestore(&amp;chip-&gt;reg_lock, flags);</span>

<span class="c">	return value;</span>
<span class="c">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wave_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">WC_INDEX</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">WC_DATA</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">wave_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">WC_INDEX</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">WC_DATA</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* *******************</span>
<span class="cm">   * Bob the Timer!  *</span>
<span class="cm">   *******************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_bob_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESM_BOB_ENABLE</span><span class="p">;</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESM_BOB_START</span><span class="p">;</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_bob_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divide</span><span class="p">;</span>

	<span class="cm">/* compute ideal interrupt frequency for buffer size &amp; play rate */</span>
	<span class="cm">/* first, find best prescaler value to match freq */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">prescale</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">prescale</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ESS_SYSCLK</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* next, back off prescaler whilst getting divider into optimum range */</span>
	<span class="n">divide</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">prescale</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">divide</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prescale</span><span class="o">--</span><span class="p">;</span>
		<span class="n">divide</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">divide</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* now fine-tune the divider for best match */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">divide</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">divide</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">&gt;</span>
		    <span class="p">((</span><span class="n">ESS_SYSCLK</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">+</span> <span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">divide</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>

	<span class="cm">/* divide = 0 is illegal, but don&#39;t let prescale = 4! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divide</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divide</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">prescale</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">divide</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">divide</span><span class="o">--</span><span class="p">;</span>

	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x9000</span> <span class="o">|</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">divide</span><span class="p">);</span>	<span class="cm">/* set reg */</span>

	<span class="cm">/* Now set IDR 11/17 */</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">__maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* call with substream spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_bob_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bobclient</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bobclient</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">snd_es1968_bob_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_bob_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">snd_es1968_bob_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* call with substream spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_bob_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bobclient</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bobclient</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_es1968_bob_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">&gt;</span> <span class="n">ESM_BOB_FREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check reduction of timer frequency */</span>
		<span class="kt">int</span> <span class="n">max_freq</span> <span class="o">=</span> <span class="n">ESM_BOB_FREQ</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_freq</span> <span class="o">&lt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">bob_freq</span><span class="p">)</span>
				<span class="n">max_freq</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">bob_freq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_freq</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_es1968_bob_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">=</span> <span class="n">max_freq</span><span class="p">;</span>
			<span class="n">snd_es1968_bob_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_es1968_calc_bob_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we acquire 4 interrupts per period for precise control.. */</span>
	<span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">/=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">frag_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">ESM_BOB_FREQ</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">ESM_BOB_FREQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">ESM_BOB_FREQ_MAX</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">ESM_BOB_FREQ_MAX</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*************</span>
<span class="cm"> *  PCM Part *</span>
<span class="cm"> *************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_es1968_compute_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> /* XXX: do we need this? */ </span>
<span class="c">	if (rate &gt; 0x10000)</span>
<span class="c">		rate = 0x10000;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get current pointer */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">snd_es1968_get_dma_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">-=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFE</span><span class="p">);</span>	<span class="cm">/* hardware is in words */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">freq</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* spin lock held */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_es1968_trigger_apu</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">esm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set the APU mode */</span>
	<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">esm</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">__apu_get_register</span><span class="p">(</span><span class="n">esm</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0f</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_pcm_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ESM_MODE_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ESM_MODE_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_pcm_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ESM_MODE_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set the wavecache control reg */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_program_wavecache</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">capture</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmpval</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">))</span>
			<span class="n">tmpval</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 8bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span>
			<span class="n">tmpval</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* stereo */</span>
	<span class="p">}</span>

	<span class="cm">/* set the wavecache control reg */</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tmpval</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">wc_map</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpval</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_playback_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high_apu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">apu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">&gt;&gt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span>
		<span class="n">high_apu</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">high_apu</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apu</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

		<span class="n">snd_es1968_program_wavecache</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Offset to PCMBAR */</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">-=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* words */</span>

		<span class="n">pa</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>	<span class="cm">/* System RAM (Bit 22) */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable stereo */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
				<span class="n">pa</span> <span class="o">|=</span> <span class="mh">0x00800000</span><span class="p">;</span>	<span class="cm">/* (Bit 23) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">)</span>
				<span class="n">pa</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* base offset of dma calcs when reading the pointer</span>
<span class="cm">		   on this left one */</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

		<span class="cm">/* Load the buffer into the wave engine */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="cm">/* setting loop == sample len */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="cm">/* clear effects/env.. */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="cm">/* set amp now to 0xd0 (?), low byte is &#39;amplitude dest&#39;? */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xD000</span><span class="p">);</span>

		<span class="cm">/* clear routing stuff */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="cm">/* dma on, no envelopes, filter to all 1s) */</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400F</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">)</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESM_APU_16BITLINEAR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESM_APU_8BITLINEAR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set panning: left or right */</span>
			<span class="cm">/* Check: different panning. On my Canyon 3D Chipset the</span>
<span class="cm">			   Channels are swapped. I don&#39;t know, about the output</span>
<span class="cm">			   to the SPDif Link. Perhaps you have to change this</span>
<span class="cm">			   and not the APU Regs 4-5. */</span>
			<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
					 <span class="mh">0x8F00</span> <span class="o">|</span> <span class="p">(</span><span class="n">channel</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">));</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* stereo */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8F08</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* clear WP interrupts */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="cm">/* enable WP ints */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">)</span> <span class="o">|</span> <span class="n">ESM_HIRQ_DSIE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="cm">/* set frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

	<span class="cm">/* hmmm.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">))</span>
		<span class="n">freq</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">snd_es1968_compute_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* Load the frequency, turn on 6dB */</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_capture_apu</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">route</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">apu</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* set the wavecache control reg */</span>
	<span class="n">snd_es1968_program_wavecache</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Offset to PCMBAR */</span>
	<span class="n">pa</span> <span class="o">-=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">pa</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* words */</span>

	<span class="cm">/* base offset of dma calcs when reading the pointer</span>
<span class="cm">	   on this left one */</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">pa</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>	<span class="cm">/* bit 22 -&gt; System RAM */</span>

	<span class="cm">/* Begin loading the APU */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* need to enable subgroups.. and we should probably</span>
<span class="cm">	   have different groups for different /dev/dsps..  */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>

	<span class="cm">/* Load the buffer into the wave engine */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">bsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
	<span class="cm">/* clear effects/env.. */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x00F0</span><span class="p">);</span>
	<span class="cm">/* amplitude now?  sure.  why not.  */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="cm">/* set filter tune, radius, polar pan */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8F08</span><span class="p">);</span>
	<span class="cm">/* route input */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">route</span><span class="p">);</span>
	<span class="cm">/* dma on, no envelopes, filter to all 1s) */</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400F</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_capture_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">&gt;&gt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span><span class="p">;</span>

	<span class="cm">/* APU assignments:</span>
<span class="cm">	   0 = mono/left SRC</span>
<span class="cm">	   1 = right SRC</span>
<span class="cm">	   2 = mono/left Input Mixer</span>
<span class="cm">	   3 = right Input Mixer</span>
<span class="cm">	*/</span>
	<span class="cm">/* data seems to flow from the codec, through an apu into</span>
<span class="cm">	   the &#39;mixbuf&#39; bit of page, then through the SRC apu</span>
<span class="cm">	   and out to the real &#39;buffer&#39;.  ok.  sure.  */</span>

	<span class="cm">/* input mixer (left/mono) */</span>
	<span class="cm">/* parallel in crap, see maestro reg 0xC [8-11] */</span>
	<span class="n">init_capture_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			 <span class="n">es</span><span class="o">-&gt;</span><span class="n">mixbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ESM_MIXBUF_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="cm">/* in words */</span>
			 <span class="n">ESM_APU_INPUTMIXER</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="cm">/* SRC (left/mono); get input from inputing apu */</span>
	<span class="n">init_capture_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			 <span class="n">ESM_APU_SRCONVERTOR</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* input mixer (right) */</span>
		<span class="n">init_capture_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				 <span class="n">es</span><span class="o">-&gt;</span><span class="n">mixbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ESM_MIXBUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
				 <span class="n">ESM_MIXBUF_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="cm">/* in words */</span>
				 <span class="n">ESM_APU_INPUTMIXER</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
		<span class="cm">/* SRC (right) */</span>
		<span class="n">init_capture_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">es</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				 <span class="n">ESM_APU_SRCONVERTOR</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="cm">/* Sample Rate conversion APUs don&#39;t like 0x10000 for their rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">47999</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">47999</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">snd_es1968_compute_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* Load the frequency, turn on 6dB */</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* fix mixer rate at 48khz.  and its _must_ be 0x10000. */</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* clear WP interrupts */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="cm">/* enable WP ints */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">)</span> <span class="o">|</span> <span class="n">ESM_HIRQ_DSIE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************</span>
<span class="cm"> *  ALSA Interface *</span>
<span class="cm"> *******************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">frag_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* maestro handles always 16bit */</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">|=</span> <span class="n">ESS_FMT_16BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">|=</span> <span class="n">ESS_FMT_STEREO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_16BIT</span><span class="p">)</span> <span class="cm">/* 8bit is already word shifted */</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">bob_freq</span> <span class="o">=</span> <span class="n">snd_es1968_calc_bob_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESM_MODE_PLAY</span>:
		<span class="n">snd_es1968_playback_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESM_MODE_CAPTURE</span>:
		<span class="n">snd_es1968_capture_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">snd_es1968_bob_inc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">bob_freq</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_es1968_pcm_start</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">snd_es1968_pcm_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_es1968_bob_dec</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_es1968_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_es1968_get_dma_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">%</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_es1968_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
               		         <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="cm">/*SNDRV_PCM_INFO_PAUSE |*/</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">65536</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">65536</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_es1968_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="cm">/*SNDRV_PCM_INFO_PAUSE |*/</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="cm">/*SNDRV_PCM_FMTBIT_U8 |*/</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">65536</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">65536</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* *************************</span>
<span class="cm">   * DMA memory management *</span>
<span class="cm">   *************************/</span>

<span class="cm">/* Because the Maestro can only take addresses relative to the PCM base address</span>
<span class="cm">   register :( */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_available_memory_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span>
			<span class="n">max_size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
		<span class="n">max_size</span> <span class="o">=</span> <span class="mi">127</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">max_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allocate a new memory chunk with the specified size */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="nf">snd_es1968_new_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ESM_MEM_ALIGN</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">__found:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chunk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* free a memory chunk */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_free_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esm_memory</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esm_memory</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_free_dmabuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_dma_reserve_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esm_memory</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_es1968_init_dmabuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_dma_get_reserved_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_dma_alloc_pages_fallback</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
						   <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
						   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">total_bufsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1968: can&#39;t allocate dma pages for size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">total_bufsize</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1968: DMA buffer beyond 256MB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">);</span>
	<span class="cm">/* allocate an empty chunk */</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chunk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_dmabuf</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ESM_MEM_ALIGN</span><span class="p">);</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+=</span> <span class="n">ESM_MEM_ALIGN</span><span class="p">;</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">ESM_MEM_ALIGN</span><span class="p">;</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-=</span> <span class="n">ESM_MEM_ALIGN</span><span class="p">;</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup the dma_areas */</span>
<span class="cm">/* buffer is extracted from the pre-allocated memory chunk */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_es1968_free_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">snd_es1968_new_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd_printd("cannot allocate dma buffer: size = %d\n", size);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_pcm_set_runtime_buffer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* area was changed */</span>
<span class="p">}</span>

<span class="cm">/* remove dma areas if allocated */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * allocate APU pair</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_alloc_apu_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">apu</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">apu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">apu</span> <span class="o">&lt;</span> <span class="n">NR_APUS</span><span class="p">;</span> <span class="n">apu</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span><span class="p">]</span> <span class="o">==</span> <span class="n">ESM_APU_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ESM_APU_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">apu</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release APU pair</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">apu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESM_APU_FREE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************</span>
<span class="cm"> * PCM open/close *</span>
<span class="cm"> ******************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">apu1</span><span class="p">;</span>

	<span class="cm">/* search 2 APUs */</span>
	<span class="n">apu1</span> <span class="o">=</span> <span class="n">snd_es1968_alloc_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_APU_PCM_PLAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apu1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">apu1</span><span class="p">;</span>

	<span class="n">es</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">es</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu1</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ESM_MODE_PLAY</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_es1968_playback</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>
		<span class="n">calc_available_memory_size</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">apu1</span><span class="p">,</span> <span class="n">apu2</span><span class="p">;</span>

	<span class="n">apu1</span> <span class="o">=</span> <span class="n">snd_es1968_alloc_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_APU_PCM_CAPTURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apu1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">apu1</span><span class="p">;</span>
	<span class="n">apu2</span> <span class="o">=</span> <span class="n">snd_es1968_alloc_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_APU_PCM_RATECONV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apu2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">apu2</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">es</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">es</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu1</span><span class="p">);</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu1</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu2</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">apu2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">apu_mode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ESM_MODE_CAPTURE</span><span class="p">;</span>

	<span class="cm">/* get mixbuffer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mixbuf</span> <span class="o">=</span> <span class="n">snd_es1968_new_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_MIXBUF_SIZE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu1</span><span class="p">);</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu2</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mixbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ESM_MIXBUF_SIZE</span><span class="p">);</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_es1968_capture</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>
		<span class="n">calc_available_memory_size</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1024</span><span class="p">;</span> <span class="cm">/* keep MIXBUF size */</span>
	<span class="n">snd_pcm_hw_constraint_pow2</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">es</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">snd_es1968_free_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">mixbuf</span><span class="p">);</span>
	<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">es</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_es1968_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_es1968_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_es1968_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_es1968_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_es1968_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_es1968_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_es1968_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_es1968_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_es1968_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_es1968_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_es1968_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * measure clock</span>
<span class="cm"> */</span>
<span class="cp">#define CLOCK_MEASURE_BUFSIZE	16768	</span><span class="cm">/* enough large for a single shot */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">es1968_measure_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">apu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pa</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esm_memory</span> <span class="o">*</span><span class="n">memory</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="cm">/* default clock value */</span>

	<span class="cm">/* search 2 APUs (although one apu is enough) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">apu</span> <span class="o">=</span> <span class="n">snd_es1968_alloc_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_APU_PCM_PLAY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hmm, cannot find empty APU pair!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">memory</span> <span class="o">=</span> <span class="n">snd_es1968_new_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLOCK_MEASURE_BUFSIZE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate dma buffer - using default clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CLOCK_MEASURE_BUFSIZE</span><span class="p">);</span>

	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">);</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)((</span><span class="n">memory</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>	<span class="cm">/* System RAM (Bit 22) */</span>

	<span class="cm">/* initialize apu */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400f</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">CLOCK_MEASURE_BUFSIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">CLOCK_MEASURE_BUFSIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xD000</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8F08</span><span class="p">);</span>
	<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* clear WP interrupts */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">)</span> <span class="o">|</span> <span class="n">ESM_HIRQ_DSIE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span> <span class="cm">/* enable WP ints */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">snd_es1968_apu_set_freq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">48000</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span> <span class="cm">/* 48000 Hz */</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_apu</span> <span class="o">=</span> <span class="n">apu</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_es1968_bob_inc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ESM_BOB_FREQ</span><span class="p">);</span>
	<span class="n">__apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="n">ESM_APU_16BITLINEAR</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_time</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">__apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_time</span><span class="p">);</span>
	<span class="n">snd_es1968_trigger_apu</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* stop */</span>
	<span class="n">snd_es1968_bob_dec</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* check the current position */</span>
	<span class="n">offset</span> <span class="o">-=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xfffe</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_count</span> <span class="o">*</span> <span class="p">(</span><span class="n">CLOCK_MEASURE_BUFSIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">stop_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&lt;</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">-=</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">stop_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">stop_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;?? calculation error..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="p">((</span><span class="n">offset</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">47500</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">48500</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">40000</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="mi">50000</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;es1968: clocking to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_es1968_free_memory</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
	<span class="n">snd_es1968_free_apu_pair</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">apu</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_pcm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">esm</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">snd_es1968_free_dmabuf</span><span class="p">(</span><span class="n">esm</span><span class="p">);</span>
	<span class="n">esm</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_es1968_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* get DMA buffer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1968_init_dmabuf</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set PCMBAR */</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01FC</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01FD</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01FE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01FF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ESS Maestro&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_streams</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_streams</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_es1968_pcm_free</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_es1968_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_es1968_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ESS Maestro&quot;</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * suppress jitter on some maestros when playing stereo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_suppress_jitter</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cp1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>

	<span class="n">cp1</span> <span class="o">=</span> <span class="n">__apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">cp2</span> <span class="o">=</span> <span class="n">__apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp1</span> <span class="o">&gt;</span> <span class="n">cp2</span> <span class="o">?</span> <span class="n">cp1</span> <span class="o">-</span> <span class="n">cp2</span> <span class="o">:</span> <span class="n">cp2</span> <span class="o">-</span> <span class="n">cp1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">__maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR0_DATA_PORT</span><span class="p">,</span> <span class="n">cp1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * update pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_update_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
        
	<span class="k">if</span> <span class="p">(</span><span class="n">subs</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hwptr</span> <span class="o">=</span> <span class="n">snd_es1968_get_dma_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">wav_shift</span><span class="p">;</span>
	<span class="n">hwptr</span> <span class="o">%=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">;</span>

	<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">+</span> <span class="n">hwptr</span> <span class="o">-</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">)</span> <span class="o">%</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">;</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">frag_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">frag_size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The hardware volume works by incrementing / decrementing 2 counters</span>
<span class="cm">   (without wrap around) in response to volume button presses and then</span>
<span class="cm">   generating an interrupt. The pair of counters is stored in bits 1-3 and 5-7</span>
<span class="cm">   of a byte wide register. The meaning of bits 0 and 4 is unknown. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">es1968_update_hw_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">es1968</span><span class="p">,</span> <span class="n">hwvol_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Figure out which volume control button was pushed,</span>
<span class="cm">	   based on differences from the default register</span>
<span class="cm">	   values. */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xee</span><span class="p">;</span>
	<span class="cm">/* Reset the volume control registers. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1d</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SND_ES1968_INPUT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">||</span> <span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ac97_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x88</span>:
		<span class="cm">/* mute */</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xaa</span>:
		<span class="cm">/* volume up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x66</span>:
		<span class="cm">/* volume down */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1f</span><span class="p">)</span>
			<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1f00</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">+=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_update</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x88</span>:
		<span class="cm">/* The counters have not changed, yet we&#39;ve received a HV</span>
<span class="cm">		   interrupt. According to tests run by various people this</span>
<span class="cm">		   happens when pressing the mute button. */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_MUTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xaa</span>:
		<span class="cm">/* counters increased by 1 -&gt; volume up */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_VOLUMEUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x66</span>:
		<span class="cm">/* counters decreased by 1 -&gt; volume down */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">KEY_VOLUMEDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_es1968_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1A</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">ESM_HWVOL_IRQ</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>

	<span class="cm">/* else ack &#39;em all, i imagine */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">ESM_MPU401_IRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">ESM_SOUND_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_es1968_update_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">ESS_FMT_STEREO</span><span class="p">)</span>
					<span class="n">snd_es1968_suppress_jitter</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">curp</span> <span class="o">=</span> <span class="n">__apu_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_apu</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curp</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_lastpos</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">measure_lastpos</span> <span class="o">=</span> <span class="n">curp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer stuff</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_es1968_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_SND_ES1968_INPUT</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">elem_id</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_es1968_ac97_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_es1968_ac97_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ES1968 doesn&#39;t need VRA */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SND_ES1968_INPUT</span>
	<span class="cm">/* attach master switch / volumes for h/w volume control */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elem_id</span><span class="p">));</span>
	<span class="n">elem_id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">elem_id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_switch</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem_id</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elem_id</span><span class="p">));</span>
	<span class="n">elem_id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">elem_id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_volume</span> <span class="o">=</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem_id</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset ac97 codec</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_ac97_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">save_ringbus_a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">save_68</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vend</span><span class="p">;</span>

	<span class="cm">/* save configuration */</span>
	<span class="n">save_ringbus_a</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>outw(inw(ioaddr + 0x38) &amp; 0xfffc, ioaddr + 0x38); /* clear second codec id? */</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* set command/status address i/o to 1st codec */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">);</span>

	<span class="cm">/* disable ac link */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span>
	<span class="n">save_68</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>	<span class="cm">/* something magical with gpio and bus arb. */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">save_68</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0xfffe</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>	<span class="cm">/* unmask gpio 0 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>	<span class="cm">/* gpio write */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* write 0 to gpio 0 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* write 1 to gpio 1 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">save_68</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>	<span class="cm">/* now restore .. */</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">);</span>

	<span class="cm">/* now the second codec */</span>
	<span class="cm">/* disable ac link */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0xfff7</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>	<span class="cm">/* unmask gpio 3 */</span>
	<span class="n">save_68</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0009</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>	<span class="cm">/* gpio write 0 &amp; 3 ?? */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* write 1 to gpio */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0009</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* write 9 to gpio */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>outw(inw(ioaddr + 0x38) &amp; 0xfffc, ioaddr + 0x38);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c">				/* the loop here needs to be much better if we want it.. */</span>
<span class="c">	snd_printk(KERN_INFO &quot;trying software reset\n&quot;);</span>
<span class="c">	/* try and do a software reset */</span>
<span class="c">	outb(0x80 | 0x7c, ioaddr + 0x30);</span>
<span class="c">	for (w = 0;; w++) {</span>
<span class="c">		if ((inw(ioaddr + 0x30) &amp; 1) == 0) {</span>
<span class="c">			if (inb(ioaddr + 0x32) != 0)</span>
<span class="c">				break;</span>

<span class="c">			outb(0x80 | 0x7d, ioaddr + 0x30);</span>
<span class="c">			if (((inw(ioaddr + 0x30) &amp; 1) == 0)</span>
<span class="c">			    &amp;&amp; (inb(ioaddr + 0x32) != 0))</span>
<span class="c">				break;</span>
<span class="c">			outb(0x80 | 0x7f, ioaddr + 0x30);</span>
<span class="c">			if (((inw(ioaddr + 0x30) &amp; 1) == 0)</span>
<span class="c">			    &amp;&amp; (inb(ioaddr + 0x32) != 0))</span>
<span class="c">				break;</span>
<span class="c">		}</span>

<span class="c">		if (w &gt; 10000) {</span>
<span class="c">			outb(inb(ioaddr + 0x37) | 0x08, ioaddr + 0x37);	/* do a software reset */</span>
<span class="c">			msleep(500);	/* oh my.. */</span>
<span class="c">			outb(inb(ioaddr + 0x37) &amp; ~0x08,</span>
<span class="c">				ioaddr + 0x37);</span>
<span class="c">			udelay(1);</span>
<span class="c">			outw(0x80, ioaddr + 0x30);</span>
<span class="c">			for (w = 0; w &lt; 10000; w++) {</span>
<span class="c">				if ((inw(ioaddr + 0x30) &amp; 1) == 0)</span>
<span class="c">					break;</span>
<span class="c">			}</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vend</span> <span class="o">==</span> <span class="n">NEC_VERSA_SUBID1</span> <span class="o">||</span> <span class="n">vend</span> <span class="o">==</span> <span class="n">NEC_VERSA_SUBID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn on external amp? */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xf9ff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0209</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* restore.. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">save_ringbus_a</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span>

	<span class="cm">/* Turn on the 978 docking chip.</span>
<span class="cm">	   First frob the &quot;master output enable&quot; bit,</span>
<span class="cm">	   then set most of the playback volume control registers to max. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">),</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc6</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xcf</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xd0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ESM_RESET_MAESTRO</span> <span class="o">|</span> <span class="n">ESM_RESET_DIRECTSOUND</span><span class="p">,</span>
	     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize maestro chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/* We used to muck around with pci config space that</span>
<span class="cm">	 * we had no business messing with.  We don&#39;t know enough</span>
<span class="cm">	 * about the machine to know which DMA mode is appropriate, </span>
<span class="cm">	 * etc.  We were guessing wrong on some machines and making</span>
<span class="cm">	 * them unhappy.  We now trust in the BIOS to do things right,</span>
<span class="cm">	 * which almost certainly means a new host of problems will</span>
<span class="cm">	 * arise with broken BIOS implementations.  screw &#39;em. </span>
<span class="cm">	 * We&#39;re already intolerant of machines that don&#39;t assign</span>
<span class="cm">	 * IRQs.</span>
<span class="cm">	 */</span>
	
	<span class="cm">/* Config Reg A */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_CONFIG_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_CLEAR</span><span class="p">;</span>	<span class="cm">/* Clear DMA bits */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIC_SNOOP1</span> <span class="o">|</span> <span class="n">PIC_SNOOP2</span><span class="p">);</span>	<span class="cm">/* Clear Pic Snoop Mode Bits */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAFEGUARD</span><span class="p">;</span>	<span class="cm">/* Safeguard off */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">POST_WRITE</span><span class="p">;</span>	<span class="cm">/* Posted write */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">PCI_TIMING</span><span class="p">;</span>	<span class="cm">/* PCI timing on */</span>
	<span class="cm">/* XXX huh?  claims to be reserved.. */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SWAP_LR</span><span class="p">;</span>		<span class="cm">/* swap left/right </span>
<span class="cm">				   seems to only have effect on SB</span>
<span class="cm">				   Emulation */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUBTR_DECODE</span><span class="p">;</span>	<span class="cm">/* Subtractive decode off */</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_CONFIG_A</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* Config Reg B */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_CONFIG_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* Turn off internal clock multiplier */</span>
	<span class="cm">/* XXX how do we know which to use? */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* External clock */</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SPDIF_CONFB</span><span class="p">;</span>	<span class="cm">/* disable S/PDIF output */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">HWV_CONFB</span><span class="p">;</span>		<span class="cm">/* HWV on */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">DEBOUNCE</span><span class="p">;</span>		<span class="cm">/* Debounce off: easier to push the HW buttons */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_CONFB</span><span class="p">;</span>	<span class="cm">/* GPIO 4:5 */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">CHI_CONFB</span><span class="p">;</span>		<span class="cm">/* Disconnect from the CHI.  Enabling this made a dell 7500 work. */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDMA_CONFB</span><span class="p">;</span>	<span class="cm">/* IDMA off (undocumented) */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIDI_FIX</span><span class="p">;</span>		<span class="cm">/* MIDI fix off (undoc) */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* reserved, always write 0 */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRQ_TO_ISA</span><span class="p">;</span>	<span class="cm">/* IRQ to ISA off (undoc) */</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_CONFIG_B</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* DDMA off */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_DDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_DDMA</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Legacy mode</span>
<span class="cm">	 */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_LEGACY_AUDIO_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">|=</span> <span class="n">ESS_DISABLE_AUDIO</span><span class="p">;</span>	<span class="cm">/* Disable Legacy Audio */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESS_ENABLE_SERIAL_IRQ</span><span class="p">;</span>	<span class="cm">/* Disable SIRQ */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>		<span class="cm">/* disable mpu irq/io, game port, fm, SB */</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_LEGACY_AUDIO_CONTROL</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* Set up 978 docking control chip. */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span><span class="o">|=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Enable 978. */</span>
	<span class="n">w</span><span class="o">|=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Turn on 978 hardware volume control. */</span>
	<span class="n">w</span><span class="o">&amp;=~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>	<span class="cm">/* Turn on 978 mixer volume control. */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	
	<span class="cm">/* Sound Reset */</span>

	<span class="n">snd_es1968_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Ring Bus Setup</span>
<span class="cm">	 */</span>

	<span class="cm">/* setup usual 0x34 stuff.. 0x36 may be chip specific */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0xC090</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ESM_RING_BUS_DEST</span><span class="p">);</span> <span class="cm">/* direct sound, stereo */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ESM_RING_BUS_CONTR_A</span><span class="p">);</span> <span class="cm">/* enable ringbus/serial */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Reset the CODEC</span>
<span class="cm">	 */</span>
	 
	<span class="n">snd_es1968_ac97_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Ring Bus Control B */</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ESM_RING_BUS_CONTR_B</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RINGB_EN_SPDIF</span><span class="p">;</span>	<span class="cm">/* SPDIF off */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>w |= RINGB<em>EN</em>2CODEC;    /* enable 2nd codec */</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outl</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ESM_RING_BUS_CONTR_B</span><span class="p">);</span>

	<span class="cm">/* Set hardware volume control registers to midpoints.</span>
<span class="cm">	   We can tell which button was pushed based on how they change. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mh">0x1c</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mh">0x1d</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mh">0x1e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mh">0x1f</span><span class="p">);</span>

	<span class="cm">/* it appears some maestros (dell 7500) only work if these are set,</span>
<span class="cm">	   regardless of wether we use the assp or not. */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_B</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_A</span><span class="p">);</span>	<span class="cm">/* M: Reserved bits... */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">ASSP_CONTROL_C</span><span class="p">);</span>	<span class="cm">/* M: Disable ASSP, ASSP IRQ&#39;s and FM Port */</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up wavecache</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write 0 into the buffer area 0x1E0-&gt;1EF */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x01E0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_INDEX</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_DATA</span><span class="p">);</span>

		<span class="cm">/* The 1.10 test program seem to write 0 into the buffer area</span>
<span class="cm">		 * 0x1D0-0x1DF too.*/</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x01D0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_INDEX</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_DATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">wave_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">));</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">,</span>
			  <span class="n">wave_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">,</span>
			  <span class="n">wave_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x200</span><span class="p">);</span>
	<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">,</span>
			  <span class="n">wave_get_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR7_WAVE_ROMRAM</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="mh">0x400</span><span class="p">);</span>


	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IDR2_CRAM_DATA</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="cm">/* Now back to the DirectSound stuff */</span>
	<span class="cm">/* audio serial configuration.. ? */</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xB004</span><span class="p">);</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x001B</span><span class="p">);</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x3F37</span><span class="p">);</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">);</span>

	<span class="cm">/* parallel in, has something to do with recording :) */</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xF000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="cm">/* parallel out */</span>
	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">maestro_read</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0F00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0500</span><span class="p">);</span>

	<span class="n">maestro_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x7632</span><span class="p">);</span>

	<span class="cm">/* Wave cache control on - test off, sg off, </span>
<span class="cm">	   enable, enable extra chans 1Mb */</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_CONTROL</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFA00</span><span class="p">;</span>		<span class="cm">/* Seems to be reserved? I don&#39;t know */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="mh">0xA000</span><span class="p">;</span>		<span class="cm">/* reserved... I don&#39;t know */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0200</span><span class="p">;</span>		<span class="cm">/* Channels 56,57,58,59 as Extra Play,Rec Channel enable</span>
<span class="cm">				   Seems to crash the Computer if enabled... */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>		<span class="cm">/* Wave Cache Operation Enabled */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="mh">0x0080</span><span class="p">;</span>		<span class="cm">/* Channels 60/61 as Placback/Record enabled */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0060</span><span class="p">;</span>		<span class="cm">/* Clear Wavtable Size */</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>		<span class="cm">/* Wavetable Size : 1MB */</span>
	<span class="cm">/* Bit 4 is reserved */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000C</span><span class="p">;</span>		<span class="cm">/* DMA Stuff? I don&#39;t understand what the datasheet means */</span>
	<span class="cm">/* Bit 1 is reserved */</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0001</span><span class="p">;</span>		<span class="cm">/* Test Mode off */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">WC_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Now clear the APU control ram */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_APUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">NR_APU_REGS</span><span class="p">;</span> <span class="n">w</span><span class="o">++</span><span class="p">)</span>
			<span class="n">apu_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enable IRQ&#39;s */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_start_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">ESM_HIRQ_DSIE</span> <span class="o">|</span> <span class="n">ESM_HIRQ_HW_VOLUME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span>
		<span class="n">w</span> <span class="o">|=</span> <span class="n">ESM_HIRQ_MPU401</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x1A</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * PM support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">es1968_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">do_pm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_es1968_bob_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">es1968_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esschan</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">do_pm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* restore all our config */</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1968: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_es1968_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* need to restore the base pointers.. */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set PCMBAR */</span>
		<span class="n">wave_set_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01FC</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_es1968_start_irq</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* restore ac97 state */</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ESM_MODE_PLAY</span>:
			<span class="n">snd_es1968_playback_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ESM_MODE_CAPTURE</span>:
			<span class="n">snd_es1968_capture_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* start timer again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bobclient</span><span class="p">)</span>
		<span class="n">snd_es1968_bob_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="cp">#define JOYSTICK_ADDR	0x200</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1968_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">joystick</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">JOYSTICK_ADDR</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ES1968 gameport&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;es1968: cannot allocate memory for gameport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_LEGACY_AUDIO_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">ESM_LEGACY_AUDIO_CONTROL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="n">gameport_set_name</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;ES1968 Gameport&quot;</span><span class="p">);</span>
	<span class="n">gameport_set_phys</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="s">&quot;pci%s/gameport0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">gameport_set_dev_parent</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">JOYSTICK_ADDR</span><span class="p">;</span>
	<span class="n">gameport_set_port_data</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">gameport_get_port_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>

		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_es1968_create_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_es1968_free_gameport</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_INPUT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1968_input_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;pci-%s/input0&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_ES1968_INPUT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SND_ES1968_RADIO</span>
<span class="cp">#define GPIO_DATA	0x60</span>
<span class="cp">#define IO_MASK		4      </span><span class="cm">/* mask      register offset from GPIO_DATA</span>
<span class="cm">				bits 1=unmask write to given bit */</span><span class="cp"></span>
<span class="cp">#define IO_DIR		8      </span><span class="cm">/* direction register offset from GPIO_DATA</span>
<span class="cm">				bits 0/1=read/write direction */</span><span class="cp"></span>
<span class="cm">/* mask bits for GPIO lines */</span>
<span class="cp">#define STR_DATA	0x0040 </span><span class="cm">/* GPIO6 */</span><span class="cp"></span>
<span class="cp">#define STR_CLK		0x0080 </span><span class="cm">/* GPIO7 */</span><span class="cp"></span>
<span class="cp">#define STR_WREN	0x0100 </span><span class="cm">/* GPIO8 */</span><span class="cp"></span>
<span class="cp">#define STR_MOST	0x0200 </span><span class="cm">/* GPIO9 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_tea575x_set_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_tea575x</span> <span class="o">*</span><span class="n">tea</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">tea</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">TEA575X_DATA</span><span class="p">)</span> <span class="o">?</span> <span class="n">STR_DATA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">TEA575X_CLK</span><span class="p">)</span>  <span class="o">?</span> <span class="n">STR_CLK</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">TEA575X_WREN</span><span class="p">)</span> <span class="o">?</span> <span class="n">STR_WREN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">snd_es1968_tea575x_get_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_tea575x</span> <span class="o">*</span><span class="n">tea</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">tea</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>

	<span class="k">return</span>  <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">STR_DATA</span><span class="p">)</span> <span class="o">?</span> <span class="n">TEA575X_DATA</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">STR_MOST</span><span class="p">)</span> <span class="o">?</span> <span class="n">TEA575X_MOST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_es1968_tea575x_set_direction</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_tea575x</span> <span class="o">*</span><span class="n">tea</span><span class="p">,</span> <span class="n">bool</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">tea</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">GPIO_DATA</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">odir</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">IO_DIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">STR_DATA</span> <span class="o">|</span> <span class="n">STR_CLK</span> <span class="o">|</span> <span class="n">STR_WREN</span><span class="p">),</span> <span class="n">io</span> <span class="o">+</span> <span class="n">IO_MASK</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">odir</span> <span class="o">|</span> <span class="n">STR_DATA</span> <span class="o">|</span> <span class="n">STR_CLK</span> <span class="o">|</span> <span class="n">STR_WREN</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">IO_DIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">STR_CLK</span> <span class="o">|</span> <span class="n">STR_WREN</span> <span class="o">|</span> <span class="n">STR_DATA</span> <span class="o">|</span> <span class="n">STR_MOST</span><span class="p">),</span> <span class="n">io</span> <span class="o">+</span> <span class="n">IO_MASK</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">odir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">STR_DATA</span> <span class="o">|</span> <span class="n">STR_MOST</span><span class="p">))</span> <span class="o">|</span> <span class="n">STR_CLK</span> <span class="o">|</span> <span class="n">STR_WREN</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">IO_DIR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_tea575x_ops</span> <span class="n">snd_es1968_tea_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pins</span> <span class="o">=</span> <span class="n">snd_es1968_tea575x_set_pins</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pins</span> <span class="o">=</span> <span class="n">snd_es1968_tea575x_get_pins</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_direction</span> <span class="o">=</span> <span class="n">snd_es1968_tea575x_set_direction</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_ES1968_INPUT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* clear WP interrupts */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_PORT_HOST_IRQ</span><span class="p">);</span> <span class="cm">/* disable IRQ */</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_RADIO</span>
	<span class="n">snd_tea575x_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_es1968_free_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_es1968_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_es1968_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ess_device_list</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* chip type */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor</span><span class="p">;</span>	<span class="cm">/* subsystem vendor id */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_device_list</span> <span class="n">pm_whitelist</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x0e11</span> <span class="p">},</span>	<span class="cm">/* Compaq Armada */</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x1028</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x103c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x1179</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x14c0</span> <span class="p">},</span>	<span class="cm">/* HP omnibook 4150 */</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2E</span><span class="p">,</span> <span class="mh">0x1558</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_device_list</span> <span class="n">mpu_blacklist</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TYPE_MAESTRO2</span><span class="p">,</span> <span class="mh">0x125d</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1968_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">total_bufsize</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">play_streams</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">capt_streams</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">do_pm</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">radio_nr</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">es1968</span> <span class="o">**</span><span class="n">chip_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_es1968_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">chip_ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* check, if we can restrict PCI DMA transfers to 28 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support 28bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set Vars */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">substream_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">memory_mutex</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwvol_work</span><span class="p">,</span> <span class="n">es1968_update_hw_volume</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">total_bufsize</span> <span class="o">=</span> <span class="n">total_bufsize</span><span class="p">;</span>	<span class="cm">/* in bytes */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_streams</span> <span class="o">=</span> <span class="n">play_streams</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_streams</span> <span class="o">=</span> <span class="n">capt_streams</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;ESS Maestro&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_es1968_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_es1968_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	        
	<span class="cm">/* Clear Maestro_map */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">maestro_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear Apu Map */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_APUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">apu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESM_APU_FREE</span><span class="p">;</span>

	<span class="cm">/* just to be sure */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_pm</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable power-management if not on the whitelist */</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vend</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vend</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pm_whitelist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">pm_whitelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vend</span> <span class="o">==</span> <span class="n">pm_whitelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_pm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_pm</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not matched; disabling pm */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;es1968: not attempting power management.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">do_pm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">do_pm</span> <span class="o">=</span> <span class="n">do_pm</span><span class="p">;</span>

	<span class="n">snd_es1968_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_RADIO</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_es1968_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">radio_nr</span> <span class="o">=</span> <span class="n">radio_nr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_es1968_tea_ops</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SF64-PCE2&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">card</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">.</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_tea575x_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tea</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;es1968: detected TEA575x radio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">chip_ret</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_es1968_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">es1968</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
                
	<span class="k">if</span> <span class="p">(</span><span class="n">total_bufsize</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">total_bufsize</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_bufsize</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">total_bufsize</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1968_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span>
				     <span class="n">total_bufsize</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="cm">/* in bytes */</span>
				     <span class="n">pcm_substreams_p</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> 
				     <span class="n">pcm_substreams_c</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				     <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span>
				     <span class="n">use_pm</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				     <span class="n">radio_nr</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				     <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_MAESTRO2E</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ES1978&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ESS ES1978 (Maestro 2E)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_MAESTRO2</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ES1968&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ESS ES1968 (Maestro 2)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_MAESTRO</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ESM1&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ESS Maestro 1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1968_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1968_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_mpu</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check the black list */</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vend</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vend</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpu_blacklist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">mpu_blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vend</span> <span class="o">==</span> <span class="n">mpu_blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">enable_mpu</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_mpu</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPU401_HW_MPU401</span><span class="p">,</span>
					       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">ESM_MPU401_PORT</span><span class="p">,</span>
					       <span class="n">MPU401_INFO_INTEGRATED</span> <span class="o">|</span>
					       <span class="n">MPU401_INFO_IRQ_HOOK</span><span class="p">,</span>
					       <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;es1968: skipping MPU-401 MIDI support..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_es1968_create_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_ES1968_INPUT</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_es1968_input_register</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Input device registration &quot;</span>
			<span class="s">&quot;failed with error %i&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">snd_es1968_start_irq</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="n">es1968_measure_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_es1968_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">es1968_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_es1968_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_es1968_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_es1968_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">es1968_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">es1968_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">es1968_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
