<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › aoa › codecs › onyx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>onyx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Apple Onboard Audio driver for Onyx codec</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * GPL v2, can be found in COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This is a driver for the pcm3052 codec chip (codenamed Onyx)</span>
<span class="cm"> * that is present in newer Apple hardware (with digital output).</span>
<span class="cm"> *</span>
<span class="cm"> * The Onyx codec has the following connections (listed by the bit</span>
<span class="cm"> * to be used in aoa_codec.connected):</span>
<span class="cm"> *  0: analog output</span>
<span class="cm"> *  1: digital output</span>
<span class="cm"> *  2: line input</span>
<span class="cm"> *  3: microphone input</span>
<span class="cm"> * Note that even though I know of no machine that has for example</span>
<span class="cm"> * the digital output connected but not the analog, I have handled</span>
<span class="cm"> * all the different cases in the code so that this driver may serve</span>
<span class="cm"> * as a good example of what to do.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This driver assumes that there&#39;s at most one chip to be</span>
<span class="cm"> * 	 used with one alsa card, in form of creating all kinds</span>
<span class="cm"> *	 of mixer elements without regard for their existence.</span>
<span class="cm"> *	 But snd-aoa assumes that there&#39;s at most one card, so</span>
<span class="cm"> *	 this means you can only have one onyx on a system. This</span>
<span class="cm"> *	 should probably be fixed by changing the assumption of</span>
<span class="cm"> *	 having just a single card on a system, and making the</span>
<span class="cm"> *	 &#39;card&#39; pointer accessible to anyone who needs it instead</span>
<span class="cm"> *	 of hiding it in the aoa_snd_* functions...</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johannes Berg &lt;johannes@sipsolutions.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;pcm3052 (onyx) codec driver for snd-aoa&quot;</span><span class="p">);</span>

<span class="cp">#include &quot;onyx.h&quot;</span>
<span class="cp">#include &quot;../aoa.h&quot;</span>
<span class="cp">#include &quot;../soundbus/soundbus.h&quot;</span>


<span class="cp">#define PFX &quot;snd-aoa-codec-onyx: &quot;</span>

<span class="k">struct</span> <span class="n">onyx</span> <span class="p">{</span>
	<span class="cm">/* cache registers 65 to 80, they are write-only! */</span>
	<span class="n">u8</span>			<span class="n">cache</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoa_codec</span>	<span class="n">codec</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">initialised</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
				<span class="nl">spdif_locked:</span><span class="mi">1</span><span class="p">,</span>
				<span class="nl">analog_locked:</span><span class="mi">1</span><span class="p">,</span>
				<span class="nl">original_mute:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">open_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">codec_info</span>	<span class="o">*</span><span class="n">codec_info</span><span class="p">;</span>

	<span class="cm">/* mutex serializes concurrent access to the device</span>
<span class="cm">	 * and this structure.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define codec_to_onyx(c) container_of(c, struct onyx, codec)</span>

<span class="cm">/* both return 0 if all ok, else on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="o">-</span><span class="n">FIRSTREGISTER</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">ONYX_REG_CONTROL</span><span class="o">-</span><span class="n">FIRSTREGISTER</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="o">-</span><span class="n">FIRSTREGISTER</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* alsa stuff */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_dev_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_register</span> <span class="o">=</span> <span class="n">onyx_dev_register</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* this is necessary because most alsa mixer programs</span>
<span class="cm"> * can&#39;t properly handle the negative range */</span>
<span class="cp">#define VOLUME_RANGE_SHIFT	128</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_LEFT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_RIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">128</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">128</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_LEFT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_RIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span> <span class="o">==</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">r</span> <span class="o">+</span> <span class="n">VOLUME_RANGE_SHIFT</span> <span class="o">==</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_LEFT</span><span class="p">,</span>
			    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			     <span class="o">-</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">);</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_ATTEN_RIGHT</span><span class="p">,</span>
			    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			     <span class="o">-</span> <span class="n">VOLUME_RANGE_SHIFT</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">volume_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">onyx_snd_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">onyx_snd_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">onyx_snd_vol_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* like above, this is necessary because a lot</span>
<span class="cm"> * of alsa mixer programs don&#39;t handle ranges</span>
<span class="cm"> * that don&#39;t start at 0 properly.</span>
<span class="cm"> * even alsamixer is one of them... */</span>
<span class="cp">#define INPUTGAIN_RANGE_SHIFT	(-3)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_inputgain_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">+</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_inputgain_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ig</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ig</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ig</span> <span class="o">&amp;</span> <span class="n">ONYX_ADC_PGA_GAIN_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_inputgain_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">28</span> <span class="o">+</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONYX_ADC_PGA_GAIN_MASK</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">INPUTGAIN_RANGE_SHIFT</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">ONYX_ADC_PGA_GAIN_MASK</span><span class="p">;</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">inputgain_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Capture Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">onyx_snd_inputgain_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">onyx_snd_inputgain_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">onyx_snd_inputgain_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_capture_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Line-In&quot;</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_capture_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">v</span><span class="o">&amp;</span><span class="n">ONYX_ADC_INPUT_MIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onyx_set_capture_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONYX_ADC_INPUT_MIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mic</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">ONYX_ADC_INPUT_MIC</span><span class="p">;</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_capture_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">onyx_set_capture_source</span><span class="p">(</span><span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">),</span>
				<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">capture_source_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="cm">/* If we name this &#39;Input Source&#39;, it properly shows up in</span>
<span class="cm">	 * alsamixer as a selection, * but it&#39;s shown under the</span>
<span class="cm">	 * &#39;Playback&#39; category.</span>
<span class="cm">	 * If I name it &#39;Capture Source&#39;, it shows up in strange</span>
<span class="cm">	 * ways (two bools of which one can be selected at a</span>
<span class="cm">	 * time) but at least it&#39;s shown in the &#39;Capture&#39;</span>
<span class="cm">	 * category.</span>
<span class="cm">	 * I was told that this was due to backward compatibility,</span>
<span class="cm">	 * but I don&#39;t understand then why the mangling is *not*</span>
<span class="cm">	 * done when I name it &quot;Input Source&quot;.....</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">onyx_snd_capture_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">onyx_snd_capture_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">onyx_snd_capture_source_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define onyx_snd_mute_info	snd_ctl_boolean_stereo_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_mute_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">ONYX_MUTE_LEFT</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">ONYX_MUTE_RIGHT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_mute_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">analog_locked</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ONYX_MUTE_RIGHT</span> <span class="o">|</span> <span class="n">ONYX_MUTE_LEFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="n">ONYX_MUTE_LEFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="n">ONYX_MUTE_RIGHT</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">err</span> <span class="o">?</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mute_control</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">onyx_snd_mute_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">onyx_snd_mute_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">onyx_snd_mute_put</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#define onyx_snd_single_bit_info	snd_ctl_boolean_mono_info</span>

<span class="cp">#define FLAG_POLARITY_INVERT	1</span>
<span class="cp">#define FLAG_SPDIFLOCK		2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_single_bit_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">polarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FLAG_POLARITY_INVERT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pv</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">^</span> <span class="n">polarity</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_snd_single_bit_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">polarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FLAG_POLARITY_INVERT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">spdiflock</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FLAG_SPDIFLOCK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pv</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdiflock</span> <span class="o">&amp;&amp;</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">spdif_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* even if alsamixer doesn&#39;t care.. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">polarity</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">err</span> <span class="o">?</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SINGLE_BIT(n, type, description, address, mask, flags)	 	\</span>
<span class="cp">static struct snd_kcontrol_new n##_control = {				\</span>
<span class="cp">	.iface = SNDRV_CTL_ELEM_IFACE_##type,				\</span>
<span class="cp">	.name = description,						\</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE,			\</span>
<span class="cp">	.info = onyx_snd_single_bit_info,				\</span>
<span class="cp">	.get = onyx_snd_single_bit_get,					\</span>
<span class="cp">	.put = onyx_snd_single_bit_put,					\</span>
<span class="cp">	.private_value = (flags &lt;&lt; 16) | (address &lt;&lt; 8) | mask		\</span>
<span class="cp">}</span>

<span class="n">SINGLE_BIT</span><span class="p">(</span><span class="n">spdif</span><span class="p">,</span>
	   <span class="n">MIXER</span><span class="p">,</span>
	   <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">),</span>
	   <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span>
	   <span class="n">ONYX_SPDIF_ENABLE</span><span class="p">,</span>
	   <span class="n">FLAG_SPDIFLOCK</span><span class="p">);</span>
<span class="n">SINGLE_BIT</span><span class="p">(</span><span class="n">ovr1</span><span class="p">,</span>
	   <span class="n">MIXER</span><span class="p">,</span>
	   <span class="s">&quot;Oversampling Rate&quot;</span><span class="p">,</span>
	   <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span>
	   <span class="n">ONYX_OVR1</span><span class="p">,</span>
	   <span class="mi">0</span><span class="p">);</span>
<span class="n">SINGLE_BIT</span><span class="p">(</span><span class="n">flt0</span><span class="p">,</span>
	   <span class="n">MIXER</span><span class="p">,</span>
	   <span class="s">&quot;Fast Digital Filter Rolloff&quot;</span><span class="p">,</span>
	   <span class="n">ONYX_REG_DAC_FILTER</span><span class="p">,</span>
	   <span class="n">ONYX_ROLLOFF_FAST</span><span class="p">,</span>
	   <span class="n">FLAG_POLARITY_INVERT</span><span class="p">);</span>
<span class="n">SINGLE_BIT</span><span class="p">(</span><span class="n">hpf</span><span class="p">,</span>
	   <span class="n">MIXER</span><span class="p">,</span>
	   <span class="s">&quot;Highpass Filter&quot;</span><span class="p">,</span>
	   <span class="n">ONYX_REG_ADC_HPF_BYPASS</span><span class="p">,</span>
	   <span class="n">ONYX_HPF_DISABLE</span><span class="p">,</span>
	   <span class="n">FLAG_POLARITY_INVERT</span><span class="p">);</span>
<span class="n">SINGLE_BIT</span><span class="p">(</span><span class="n">dm12</span><span class="p">,</span>
	   <span class="n">MIXER</span><span class="p">,</span>
	   <span class="s">&quot;Digital De-Emphasis&quot;</span><span class="p">,</span>
	   <span class="n">ONYX_REG_DAC_DEEMPH</span><span class="p">,</span>
	   <span class="n">ONYX_DIGDEEMPH_CTRL</span><span class="p">,</span>
	   <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* datasheet page 30, all others are 0 */</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">onyx_spdif_mask</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">onyx_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">onyx_spdif_mask_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">;</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3e</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">);</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO1</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO2</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO3</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">onyx_spdif_ctrl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">onyx_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">onyx_spdif_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">onyx_spdif_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* our registers */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">register_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ONYX_REG_DAC_ATTEN_LEFT</span><span class="p">,</span>
	<span class="n">ONYX_REG_DAC_ATTEN_RIGHT</span><span class="p">,</span>
	<span class="n">ONYX_REG_CONTROL</span><span class="p">,</span>
	<span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span>
	<span class="n">ONYX_REG_DAC_DEEMPH</span><span class="p">,</span>
	<span class="n">ONYX_REG_DAC_FILTER</span><span class="p">,</span>
	<span class="n">ONYX_REG_DAC_OUTPHASE</span><span class="p">,</span>
	<span class="n">ONYX_REG_ADC_CONTROL</span><span class="p">,</span>
	<span class="n">ONYX_REG_ADC_HPF_BYPASS</span><span class="p">,</span>
	<span class="n">ONYX_REG_DIG_INFO1</span><span class="p">,</span>
	<span class="n">ONYX_REG_DIG_INFO2</span><span class="p">,</span>
	<span class="n">ONYX_REG_DIG_INFO3</span><span class="p">,</span>
	<span class="n">ONYX_REG_DIG_INFO4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">initial_values</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">register_map</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="cm">/* muted */</span>
	<span class="n">ONYX_MRST</span> <span class="o">|</span> <span class="n">ONYX_SRST</span><span class="p">,</span> <span class="cm">/* but handled specially! */</span>
	<span class="n">ONYX_MUTE_LEFT</span> <span class="o">|</span> <span class="n">ONYX_MUTE_RIGHT</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="cm">/* no deemphasis */</span>
	<span class="n">ONYX_DAC_FILTER_ALWAYS</span><span class="p">,</span>
	<span class="n">ONYX_OUTPHASE_INVERTED</span><span class="p">,</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="cm">/*dB*/</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="cm">/* line in selected, -1 dB gain*/</span>
	<span class="n">ONYX_ADC_HPF_ALWAYS</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span>	<span class="cm">/* pcm audio */</span>
	<span class="mi">2</span><span class="p">,</span>	<span class="cm">/* category: pcm coder */</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="cm">/* sampling frequency 44.1 kHz, clock accuracy level II */</span>
	<span class="mi">1</span>	<span class="cm">/* 24 bit depth */</span>
<span class="p">};</span>

<span class="cm">/* reset registers of chip, either to initial or to previous values */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_register_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regs</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">initial_values</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">initialised</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">initial_values</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONYX_SILICONVERSION</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">initial_values</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">register_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">register_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">FIRSTREGISTER</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">register_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">register_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">initialised</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">transfer_info</span> <span class="n">onyx_transfers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* this is first so we can skip it if no input is present...</span>
<span class="cm">	 * No hardware exists with that, but it&#39;s here as an example</span>
<span class="cm">	 * of what to do :) */</span>
	<span class="p">{</span>
		<span class="cm">/* analog input */</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transfer_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">must_be_clock_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* if analog and digital are currently off, anything should go,</span>
<span class="cm">		 * so this entry describes everything we can do... */</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span>
<span class="cp">#ifdef SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span>
			   <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span>
<span class="cp">#endif</span>
		<span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* analog output */</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transfer_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">must_be_clock_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* digital pcm output, also possible for analog out */</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			   <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">transfer_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">must_be_clock_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span>
	<span class="cm">/* Once alsa gets supports for this kind of thing we can add it... */</span>
	<span class="p">{</span>
		<span class="cm">/* digital compressed output */</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>  <span class="n">SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_usable</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">transfer_info</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">transfer_info</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spdif_enabled</span><span class="p">,</span> <span class="n">analog_enabled</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">spdif_enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ONYX_SPDIF_ENABLE</span><span class="p">);</span>
	<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="n">analog_enabled</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ONYX_MUTE_RIGHT</span><span class="o">|</span><span class="n">ONYX_MUTE_LEFT</span><span class="p">))</span>
		 <span class="o">!=</span> <span class="p">(</span><span class="n">ONYX_MUTE_RIGHT</span><span class="o">|</span><span class="n">ONYX_MUTE_LEFT</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="k">return</span> <span class="n">analog_enabled</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="n">spdif_enabled</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bus_info</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FMTBIT_COMPRESSED_16BE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mute and lock analog output */</span>
		<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span>
					<span class="n">ONYX_REG_DAC_CONTROL</span><span class="p">,</span>
					<span class="n">v</span> <span class="o">|</span> <span class="n">ONYX_MUTE_RIGHT</span> <span class="o">|</span> <span class="n">ONYX_MUTE_LEFT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">analog_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
	<span class="k">case</span> <span class="mi">44100</span>:
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="cm">/* these rates are ok for all outputs */</span>
		<span class="cm">/* FIXME: program spdif channel control bits here so that</span>
<span class="cm">		 *	  userspace doesn&#39;t have to if it only plays pcm! */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* got some rate that the digital output can&#39;t do,</span>
<span class="cm">		 * so disable and lock it */</span>
		<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span>
					<span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span>
					<span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ONYX_SPDIF_ENABLE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">spdif_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">)</span>
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">spdif_locked</span> <span class="o">=</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">analog_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_switch_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">clock_switch</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* this *MUST* be more elaborate later... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOCK_SWITCH_PREPARE_SLAVE</span>:
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">all_amps_off</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_SWITCH_SLAVE</span>:
		<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">all_amps_restore</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* silence warning */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="n">ONYX_ADPSV</span> <span class="o">|</span> <span class="n">ONYX_DAPSV</span><span class="p">);</span>
	<span class="cm">/* Apple does a sleep here but the datasheet says to do it on resume */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* reset codec */</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* take codec out of suspend (if it still is after reset) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ONYX_ADPSV</span> <span class="o">|</span> <span class="n">ONYX_DAPSV</span><span class="p">));</span>
	<span class="cm">/* FIXME: should divide by sample rate, but 8k is the lowest we go */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2205000</span><span class="o">/</span><span class="mi">8000</span><span class="p">);</span>
	<span class="cm">/* reset all values */</span>
	<span class="n">onyx_register_init</span><span class="p">(</span><span class="n">onyx</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">codec_info</span> <span class="n">onyx_codec_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="n">onyx_transfers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysclock_factor</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_factor</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">usable</span> <span class="o">=</span> <span class="n">onyx_usable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">onyx_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">onyx_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">onyx_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">switch_clock</span> <span class="o">=</span> <span class="n">onyx_switch_clock</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">onyx_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">onyx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_init_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoa_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">codec_to_onyx</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">codec_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">onyx_codec_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span> <span class="o">||</span> <span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;gpios not assigned!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">set_hw_reset</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onyx_register_init</span><span class="p">(</span><span class="n">onyx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to initialise onyx registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aoa_snd_device_new</span><span class="p">(</span><span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">onyx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create onyx snd device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* nothing connected? what a joke! */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="cm">/* if no inputs are present... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">)</span>
			<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ci</span> <span class="o">=</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">onyx_codec_info</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if no outputs are present... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">)</span>
			<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ci</span> <span class="o">=</span> <span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">;</span>
		<span class="cm">/* this is fine as there have to be inputs</span>
<span class="cm">		 * if we end up in this part of the code */</span>
		<span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">onyx_codec_info</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">formats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="o">-&gt;</span><span class="n">attach_codec</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="p">,</span>
						   <span class="n">aoa_get_card</span><span class="p">(),</span>
						   <span class="n">ci</span><span class="p">,</span> <span class="n">onyx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;error creating onyx pcm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#define ADDCTL(n)							\</span>
<span class="cp">	do {								\</span>
<span class="cp">		ctl = snd_ctl_new1(&amp;n, onyx);				\</span>
<span class="cp">		if (ctl) {						\</span>
<span class="cp">			ctl-&gt;id.device =				\</span>
<span class="cp">				onyx-&gt;codec.soundbus_dev-&gt;pcm-&gt;device;	\</span>
<span class="cp">			err = aoa_snd_ctl_add(ctl);			\</span>
<span class="cp">			if (err)					\</span>
<span class="cp">				goto error;				\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* give the user appropriate controls</span>
<span class="cm">		 * depending on what inputs are connected */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC</span><span class="p">)</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">capture_source_control</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">onyx_set_capture_source</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">onyx_set_capture_source</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">inputgain_control</span><span class="p">);</span>

		<span class="cm">/* depending on what output is connected,</span>
<span class="cm">		 * give the user appropriate controls */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">volume_control</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">mute_control</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">ovr1_control</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">flt0_control</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">hpf_control</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">dm12_control</span><span class="p">);</span>
			<span class="cm">/* spdif control defaults to off */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">onyx_spdif_mask</span><span class="p">);</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">onyx_spdif_ctrl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">ADDCTL</span><span class="p">(</span><span class="n">spdif_control</span><span class="p">);</span>
		<span class="cm">/* if only S/PDIF is connected, enable it unconditionally */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">connected</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">ONYX_SPDIF_ENABLE</span><span class="p">;</span>
			<span class="n">onyx_write_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_DIG_INFO4</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#undef ADDCTL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;attached to onyx codec via i2c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="o">-&gt;</span><span class="n">detach_codec</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="p">,</span> <span class="n">onyx</span><span class="p">);</span>
	<span class="n">snd_device_free</span><span class="p">(</span><span class="n">aoa_get_card</span><span class="p">(),</span> <span class="n">onyx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onyx_exit_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoa_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">codec_to_onyx</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;onyx_exit_codec called without soundbus_dev!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="o">-&gt;</span><span class="n">detach_codec</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">soundbus_dev</span><span class="p">,</span> <span class="n">onyx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;aoa_codec_onyx&quot;</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We know the driver is already loaded, so the device should be</span>
<span class="cm">	 * already bound. If not it means binding failed, which suggests</span>
<span class="cm">	 * the device doesn&#39;t really exist and should be deleted.</span>
<span class="cm">	 * Ideally this would be replaced by better checks _before_</span>
<span class="cm">	 * instantiating the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let i2c-core delete that device on driver removal.</span>
<span class="cm">	 * This is safe because i2c-core holds the core_lock mutex for us.</span>
<span class="cm">	 */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">detected</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_i2c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="n">onyx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">onyx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onyx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">onyx</span><span class="p">);</span>

	<span class="cm">/* we try to read from register ONYX_REG_CONTROL</span>
<span class="cm">	 * to check if the codec is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onyx_read_register</span><span class="p">(</span><span class="n">onyx</span><span class="p">,</span> <span class="n">ONYX_REG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to read control register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;onyx&quot;</span><span class="p">,</span> <span class="n">MAX_CODEC_NAME_LEN</span><span class="p">);</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">onyx_init_codec</span><span class="p">;</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">onyx_exit_codec</span><span class="p">;</span>
	<span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aoa_codec_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PFX</span> <span class="s">&quot;created and attached onyx instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">onyx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_i2c_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">busnode</span><span class="p">,</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_i2c_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">pmac_i2c_adapter_to_bus</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">busnode</span> <span class="o">=</span> <span class="n">pmac_i2c_get_bus_node</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">busnode</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pcm3052&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PFX</span> <span class="s">&quot;found pcm3052</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">onyx_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if that didn&#39;t work, try desperate mode for older</span>
<span class="cm">	 * machines that have stuff missing from the device tree */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">busnode</span><span class="p">,</span> <span class="s">&quot;k2-i2c&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PFX</span> <span class="s">&quot;found k2-i2c, checking if onyx chip is on it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* probe both possible addresses for the onyx chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onyx_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">onyx_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">onyx_i2c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onyx</span> <span class="o">*</span><span class="n">onyx</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">aoa_codec_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">onyx</span><span class="o">-&gt;</span><span class="n">codec_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">onyx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">onyx_i2c_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;aoa_codec_onyx&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">onyx_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;aoa_codec_onyx&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">attach_adapter</span> <span class="o">=</span> <span class="n">onyx_i2c_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">onyx_i2c_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">onyx_i2c_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">onyx_i2c_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">onyx_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
