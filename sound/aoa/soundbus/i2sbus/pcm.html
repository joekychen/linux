<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › aoa › soundbus › i2sbus › pcm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pcm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * i2sbus driver -- pcm routines</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * GPL v2, can be found in COPYING.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;asm/macio.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;../soundbus.h&quot;</span>
<span class="cp">#include &quot;i2sbus.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_pcm_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">**</span><span class="n">pi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">**</span><span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
			<span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
			<span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clock_and_divisors</span><span class="p">(</span><span class="kt">int</span> <span class="n">mclk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sclk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sclk must be derived from mclk! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">%</span> <span class="n">sclk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* derive sclk register value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2s_sf_sclkdiv</span><span class="p">(</span><span class="n">mclk</span> <span class="o">/</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I2S_CLOCK_SPEED_18MHz</span> <span class="o">%</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2s_sf_mclkdiv</span><span class="p">(</span><span class="n">I2S_CLOCK_SPEED_18MHz</span> <span class="o">/</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">),</span> <span class="n">out</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_CLOCK_SOURCE_18MHz</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I2S_CLOCK_SPEED_45MHz</span> <span class="o">%</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2s_sf_mclkdiv</span><span class="p">(</span><span class="n">I2S_CLOCK_SPEED_45MHz</span> <span class="o">/</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">),</span> <span class="n">out</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_CLOCK_SOURCE_45MHz</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I2S_CLOCK_SPEED_49MHz</span> <span class="o">%</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2s_sf_mclkdiv</span><span class="p">(</span><span class="n">I2S_CLOCK_SPEED_49MHz</span> <span class="o">/</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">),</span> <span class="n">out</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_CLOCK_SOURCE_49MHz</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CHECK_RATE(rate)						\</span>
<span class="cp">	do { if (rates &amp; SNDRV_PCM_RATE_ ##rate) {			\</span>
<span class="cp">		int dummy;						\</span>
<span class="cp">		if (clock_and_divisors(sysclock_factor,			\</span>
<span class="cp">				       bus_factor, rate, &amp;dummy))	\</span>
<span class="cp">			rates &amp;= ~SNDRV_PCM_RATE_ ##rate;		\</span>
<span class="cp">	} } while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundbus_dev</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">masks_inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">,</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">formats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">transfer_info</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sysclock_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_this</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">sdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* alsa messed up */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we now need to assign the hw */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">transfer_info</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">;</span>
		<span class="n">bus_factor</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus_factor</span><span class="p">;</span>
		<span class="n">sysclock_factor</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">sysclock_factor</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">&amp;&amp;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">transfer_in</span> <span class="o">==</span> <span class="n">in</span>
			    <span class="o">&amp;&amp;</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">usable</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">masks_inited</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">formats</span> <span class="o">&amp;=</span> <span class="n">v</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
					<span class="n">rates</span> <span class="o">&amp;=</span> <span class="n">v</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">formats</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
					<span class="n">rates</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
					<span class="n">masks_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ti</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">masks_inited</span> <span class="o">||</span> <span class="o">!</span><span class="n">bus_factor</span> <span class="o">||</span> <span class="o">!</span><span class="n">sysclock_factor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* bus dependent stuff */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
		   <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_RESUME</span> <span class="o">|</span>
		   <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>

	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">5512</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">11025</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">16000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">22050</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">32000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">44100</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">48000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">64000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">88200</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">96000</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">176400</span><span class="p">);</span>
	<span class="n">CHECK_RATE</span><span class="p">(</span><span class="mi">192000</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">rates</span><span class="p">;</span>

	<span class="cm">/* well. the codec might want 24 bits only, and we&#39;ll</span>
<span class="cm">	 * ever only transfer 24 bits, but they are top-aligned!</span>
<span class="cm">	 * So for alsa, we claim that we&#39;re doing full 32 bit</span>
<span class="cm">	 * while in reality we&#39;ll ignore the lower 8 bits of</span>
<span class="cm">	 * that when doing playback (they&#39;re transferred as 0</span>
<span class="cm">	 * as far as I know, no codecs we have are 32-bit capable</span>
<span class="cm">	 * so I can&#39;t really test) and when doing recording we&#39;ll</span>
<span class="cm">	 * always have those lower 8 bits recorded as 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span><span class="p">)</span>
		<span class="n">formats</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_FMTBIT_U24_BE</span><span class="p">)</span>
		<span class="n">formats</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_FMTBIT_U32_BE</span><span class="p">;</span>
	<span class="cm">/* now mask off what we can support. I suppose we could</span>
<span class="cm">	 * also support S24_3LE and some similar formats, but I</span>
<span class="cm">	 * doubt there&#39;s a codec that would be able to use that,</span>
<span class="cm">	 * so we don&#39;t support it here. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">=</span> <span class="n">formats</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_U16_BE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_S32_BE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_FMTBIT_U32_BE</span><span class="p">);</span>

	<span class="cm">/* we need to set the highest and lowest rate possible.</span>
<span class="cm">	 * These are the highest and lowest rates alsa can</span>
<span class="cm">	 * support properly in its bitfield.</span>
<span class="cm">	 * Below, we&#39;ll use that to restrict to the rate</span>
<span class="cm">	 * currently in use (if any). */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">5512</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
	<span class="cm">/* if the other stream is active, then we can only</span>
<span class="cm">	 * support what it is currently using.</span>
<span class="cm">	 * FIXME: I lied. This comment is wrong. We can support</span>
<span class="cm">	 * anything that works with the same serial format, ie.</span>
<span class="cm">	 * when recording 24 bit sound we can well play 16 bit</span>
<span class="cm">	 * sound at the same time iff using the same transfer mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: is this guaranteed by the alsa api? */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
		<span class="cm">/* see above, restrict rates to the one we already have */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* these are somewhat arbitrary */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mi">131072</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">periods_max</span> <span class="o">=</span> <span class="n">MAX_DBDMA_COMMANDS</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
					    <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="cm">/* unwind */</span>
				<span class="n">found_this</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">found_this</span> <span class="o">&amp;&amp;</span> <span class="n">rev</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rev</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span>
								<span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="n">cii</span><span class="p">)</span>
						<span class="n">found_this</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef CHECK_RATE</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2sbus_wait_for_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">stop_completion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">stop_completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* timeout expired, stop dbdma forcefully */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2sbus_wait_for_stop: timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* make sure RUN, PAUSE and S0 bits are cleared */</span>
			<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">PAUSE</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">void</span> <span class="nf">i2sbus_wait_for_stop_both</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">i2sbus_wait_for_stop</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">i2sbus_wait_for_stop</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i2sbus_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span><span class="p">)</span>
		<span class="n">i2sbus_wait_for_stop</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_playback_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2sbus_hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_record_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2sbus_hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* whee. Hard work now. The user has selected a bitrate</span>
<span class="cm">	 * and bit format, so now we have to program our</span>
<span class="cm">	 * I2S controller appropriately. */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">periodsize</span><span class="p">,</span> <span class="n">nperiods</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_info</span> <span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sfr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* serial format register */</span>
	<span class="kt">int</span> <span class="n">dws</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* data word sizes reg */</span>
	<span class="kt">int</span> <span class="n">input_16bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">stopaddr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span><span class="p">)</span>
		<span class="n">i2sbus_wait_for_stop</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">!=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span>
	     <span class="o">||</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="n">periodsize</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">nperiods</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">current_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* generate dbdma command ring first */</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">nperiods</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">));</span>

	<span class="cm">/* commands to DMA to/from the ring */</span>
	<span class="cm">/*</span>
<span class="cm">	 * For input, we need to do a graceful stop; if we abort</span>
<span class="cm">	 * the DMA, we end up with leftover bytes that corrupt</span>
<span class="cm">	 * the next recording.  To do this we set the S0 status</span>
<span class="cm">	 * bit and wait for the DMA controller to stop.  Each</span>
<span class="cm">	 * command has a branch condition to</span>
<span class="cm">	 * make it branch to a stop command if S0 is set.</span>
<span class="cm">	 * On input we also need to wait for the S7 bit to be</span>
<span class="cm">	 * set before turning off the DMA controller.</span>
<span class="cm">	 * In fact we do the graceful stop for output as well.</span>
<span class="cm">	 */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span><span class="o">?</span> <span class="n">INPUT_MORE</span><span class="o">:</span> <span class="n">OUTPUT_MORE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BR_IFSET</span> <span class="o">|</span> <span class="n">INTR_ALWAYS</span><span class="p">;</span>
	<span class="n">stopaddr</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">bus_cmd_start</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">nperiods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nperiods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">command</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">periodsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">command</span><span class="o">-&gt;</span><span class="n">cmd_dep</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">stopaddr</span><span class="p">);</span>
		<span class="n">command</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">command</span><span class="o">-&gt;</span><span class="n">req_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">periodsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* branch back to beginning of ring */</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DBDMA_NOP</span> <span class="o">|</span> <span class="n">BR_ALWAYS</span><span class="p">);</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">cmd_dep</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">bus_cmd_start</span><span class="p">);</span>
	<span class="n">command</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* set stop command */</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DBDMA_STOP</span><span class="p">);</span>

	<span class="cm">/* ok, let&#39;s set the serial format and stuff */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 16 bit formats */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U16_BE</span>:
		<span class="cm">/* FIXME: if we add different bus factors we need to</span>
<span class="cm">		 * do more here!! */</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus_factor</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_16bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_BE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U32_BE</span>:
		<span class="cm">/* force 64x bus speed, otherwise the data cannot be</span>
<span class="cm">		 * transferred quickly enough! */</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">input_16bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we assume all sysclocks are the same! */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">sysclock_factor</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">sysclock_factor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_and_divisors</span><span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">sysclock_factor</span><span class="p">,</span>
			       <span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span><span class="p">,</span>
			       <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">sfr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">bus_factor</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">sfr</span> <span class="o">|=</span> <span class="n">I2S_SF_SERIAL_FORMAT_I2S_32X</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">sfr</span> <span class="o">|=</span> <span class="n">I2S_SF_SERIAL_FORMAT_I2S_64X</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME: THIS ASSUMES MASTER ALL THE TIME */</span>
	<span class="n">sfr</span> <span class="o">|=</span> <span class="n">I2S_SF_SCLK_MASTER</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* codecs are fine with it, so set our clocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_16bit</span><span class="p">)</span>
		<span class="n">dws</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">I2S_DWS_NUM_CHANNELS_IN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">I2S_DWS_NUM_CHANNELS_OUT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2S_DWS_DATA_IN_16BIT</span> <span class="o">|</span> <span class="n">I2S_DWS_DATA_OUT_16BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dws</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">I2S_DWS_NUM_CHANNELS_IN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">I2S_DWS_NUM_CHANNELS_OUT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2S_DWS_DATA_IN_24BIT</span> <span class="o">|</span> <span class="n">I2S_DWS_DATA_OUT_24BIT</span><span class="p">;</span>

	<span class="cm">/* early exit if already programmed correctly */</span>
	<span class="cm">/* not locking these is fine since we touch them only in this function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">serial_format</span><span class="p">)</span> <span class="o">==</span> <span class="n">sfr</span>
	 <span class="o">&amp;&amp;</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">data_word_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="n">dws</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/* let&#39;s notify the codecs about clocks going away.</span>
<span class="cm">	 * For now we only do mastering on the i2s cell... */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">switch_clock</span><span class="p">)</span>
			<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">switch_clock</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">CLOCK_SWITCH_PREPARE_SLAVE</span><span class="p">);</span>

	<span class="n">i2sbus_control_enable</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">);</span>
	<span class="n">i2sbus_control_cell</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">intr_ctl</span><span class="p">,</span> <span class="n">I2S_PENDING_CLOCKS_STOPPED</span><span class="p">);</span>

	<span class="n">i2sbus_control_clock</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* wait for clock stopped. This can apparently take a while... */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">intr_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I2S_PENDING_CLOCKS_STOPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">intr_ctl</span><span class="p">,</span> <span class="n">I2S_PENDING_CLOCKS_STOPPED</span><span class="p">);</span>

	<span class="cm">/* not locking these is fine since we touch them only in this function */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">serial_format</span><span class="p">,</span> <span class="n">sfr</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">data_word_sizes</span><span class="p">,</span> <span class="n">dws</span><span class="p">);</span>

        <span class="n">i2sbus_control_enable</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">);</span>
        <span class="n">i2sbus_control_cell</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">i2sbus_control_clock</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">switch_clock</span><span class="p">)</span>
			<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">switch_clock</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">CLOCK_SWITCH_SLAVE</span><span class="p">);</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">void</span> <span class="nf">i2sbus_pcm_prepare_both</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2sbus_pcm_prepare</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i2sbus_pcm_prepare</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
				<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clear the S0 bit, then see if we stopped yet */</span>
			<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* possible race here? */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span> <span class="cm">/* keep running */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* make sure RUN, PAUSE and S0 bits are cleared */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">PAUSE</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* set branch condition select register */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">br_sel</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* write dma command buffer address to the dbdma chip */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">bus_cmd_start</span><span class="p">);</span>

		<span class="cm">/* initialize the frame count and current period */</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">current_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">);</span>

		<span class="cm">/* set the DMA controller running */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">RUN</span><span class="p">);</span>

		<span class="cm">/* off you go! */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Set the S0 bit to make the DMA branch to the stop cmd */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
				<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">i2sbus_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">%=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcm_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fc</span><span class="p">,</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>
	<span class="n">get_pcm_info</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">current_period</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xfer_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xfer_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BT</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * BT is the branch taken bit.  If it took a branch</span>
<span class="cm">			 * it is because we set the S0 bit to make it</span>
<span class="cm">			 * branch to the stop command.</span>
<span class="cm">			 */</span>
			<span class="n">dma_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xfer_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">+=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">current_period</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check the frame count.  The DMA tends to get a bit</span>
<span class="cm">		 * ahead of the frame counter, which confuses the core.</span>
<span class="cm">		 */</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">intfregs</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">);</span>
		<span class="n">nframes</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">+</span> <span class="n">nframes</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2sbus: timed out &quot;</span>
				       <span class="s">&quot;waiting for DMA to stop!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Turn off DMA controller, clear S0 bit */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">PAUSE</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">stop_completion</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">stop_completion</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dbdma_ring</span><span class="p">.</span><span class="n">running</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>
	<span class="cm">/* may call _trigger again, hence needs to be unlocked */</span>
	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">i2sbus_tx_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">handle_interrupt</span><span class="p">((</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">devid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">i2sbus_rx_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">handle_interrupt</span><span class="p">((</span><span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">devid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_open</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2sbus_pcm_close</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_prepare</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_trigger</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">i2sbus_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span>
						 <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_pointer</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">i2sbus_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">i2sbus_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">i2sbus_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">i2sbus_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">i2sbus_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">i2sbus_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">i2sbus_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">i2sbus_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_record_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_open</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_record_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2sbus_pcm_close</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_record_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_prepare</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2sbus_record_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_trigger</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">i2sbus_record_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span>
					       <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">substream</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2sbus_pcm_pointer</span><span class="p">(</span><span class="n">i2sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">i2sbus_record_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">i2sbus_record_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">i2sbus_record_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">i2sbus_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">i2sbus_record_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">i2sbus_record_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">i2sbus_record_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">i2sbus_record_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2sbus_private_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">snd_pcm_chip</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">.</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2sbus: a codec didn&#39;t unregister!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">soundbus_dev_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">sound</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i2sbus_attach_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundbus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">codec_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">transfer_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2sbus_dev</span> <span class="o">*</span><span class="n">i2sdev</span> <span class="o">=</span> <span class="n">soundbus_dev_to_i2sbus_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcmname</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcmid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2sbus: pcm name and id must be set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span> <span class="o">||</span> <span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="o">-&gt;</span><span class="n">formats</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">||</span> <span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">usable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* we currently code the i2s transfer on the clock, and support only</span>
<span class="cm">	 * 32 and 64 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bus_factor</span> <span class="o">!=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">bus_factor</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* If you want to fix this, you need to keep track of what transport infos</span>
<span class="cm">	 * are to be used, which codecs they belong to, and then fix all the</span>
<span class="cm">	 * sysclock/busclock stuff above to depend on which is usable */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">sysclock_factor</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">sysclock_factor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;cannot yet handle multiple different sysclocks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">bus_factor</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">bus_factor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;cannot yet handle multiple different bus clocks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">transfer_in</span><span class="p">)</span>
			<span class="n">in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cii</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">codec_info_item</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cii</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i2sbus: failed to allocate cii</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* use the private data to point to the codec info */</span>
	<span class="n">cii</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">soundbus_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">ci</span><span class="p">;</span>
	<span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;i2sbus: failed to get soundbus dev reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_cii</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i2sbus: failed to get module reference!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_put_sdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;i2sbus: failed to get module reference to codec owner!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_put_this_module</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcmname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcmid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i2sbus: failed to create pcm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ALSA yet again sucks.</span>
<span class="cm">	 * If it is ever fixed, remove this line. See below. */</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">created</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* eh? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Can&#39;t attach same bus to different cards!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new_stream</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">i2sbus_playback_ops</span><span class="p">);</span>
		<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">created</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Can&#39;t attach same bus to different cards!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new_stream</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">i2sbus_record_ops</span><span class="p">);</span>
		<span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* so we have to register the pcm after adding any substream</span>
<span class="cm">	 * to it because alsa doesn&#39;t create the devices for the</span>
<span class="cm">	 * substreams when we add them later.</span>
<span class="cm">	 * Therefore, force in and out on both busses (above) and</span>
<span class="cm">	 * register the pcm now instead of just after creating it.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_register</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2sbus: error registering new pcm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_ci_module</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no errors any more, so let&#39;s add this to our list */</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">i2sdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">i2sbus_private_free</span><span class="p">;</span>

	<span class="cm">/* well, we really should support scatter/gather DMA */</span>
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
		<span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">macio_get_pci_dev</span><span class="p">(</span><span class="n">i2sdev</span><span class="o">-&gt;</span><span class="n">macio</span><span class="p">)),</span>
		<span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_put_ci_module:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
 <span class="nl">out_put_this_module:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
 <span class="nl">out_put_sdev:</span>
	<span class="n">soundbus_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">out_free_cii:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cii</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i2sbus_detach_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundbus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">codec_info_item</span> <span class="o">*</span><span class="n">cii</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">codec_data</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cii</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cii</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">cii</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cii</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* no more codecs, but still a pcm? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">codec_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the actual cleanup is done by the callback above! */</span>
		<span class="n">snd_device_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
