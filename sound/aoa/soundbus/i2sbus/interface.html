<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › aoa › soundbus › i2sbus › interface.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>interface.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * i2sbus driver -- interface register definitions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * GPL v2, can be found in COPYING.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __I2SBUS_INTERFACE_H</span>
<span class="cp">#define __I2SBUS_INTERFACE_H</span>

<span class="cm">/* i2s bus control registers, at least what we know about them */</span>

<span class="cp">#define __PAD(m,n) u8 __pad##m[n]</span>
<span class="cp">#define _PAD(line, n) __PAD(line, n)</span>
<span class="cp">#define PAD(n) _PAD(__LINE__, (n))</span>
<span class="k">struct</span> <span class="n">i2s_interface_regs</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">intr_ctl</span><span class="p">;</span>	<span class="cm">/* 0x00 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">serial_format</span><span class="p">;</span>	<span class="cm">/* 0x10 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">codec_msg_out</span><span class="p">;</span>	<span class="cm">/* 0x20 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">codec_msg_in</span><span class="p">;</span>	<span class="cm">/* 0x30 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">frame_count</span><span class="p">;</span>	<span class="cm">/* 0x40 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">frame_match</span><span class="p">;</span>	<span class="cm">/* 0x50 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">data_word_sizes</span><span class="p">;</span>	<span class="cm">/* 0x60 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">peak_level_sel</span><span class="p">;</span>	<span class="cm">/* 0x70 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">peak_level_in0</span><span class="p">;</span>	<span class="cm">/* 0x80 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">peak_level_in1</span><span class="p">;</span>	<span class="cm">/* 0x90 */</span>
	<span class="n">PAD</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="cm">/* total size: 0x100 bytes */</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">));</span>

<span class="cm">/* interrupt register is just a bitfield with</span>
<span class="cm"> * interrupt enable and pending bits */</span>
<span class="cp">#define I2S_REG_INTR_CTL		0x00</span>
<span class="cp">#	define I2S_INT_FRAME_COUNT		(1&lt;&lt;31)</span>
<span class="cp">#	define I2S_PENDING_FRAME_COUNT		(1&lt;&lt;30)</span>
<span class="cp">#	define I2S_INT_MESSAGE_FLAG		(1&lt;&lt;29)</span>
<span class="cp">#	define I2S_PENDING_MESSAGE_FLAG		(1&lt;&lt;28)</span>
<span class="cp">#	define I2S_INT_NEW_PEAK			(1&lt;&lt;27)</span>
<span class="cp">#	define I2S_PENDING_NEW_PEAK		(1&lt;&lt;26)</span>
<span class="cp">#	define I2S_INT_CLOCKS_STOPPED		(1&lt;&lt;25)</span>
<span class="cp">#	define I2S_PENDING_CLOCKS_STOPPED	(1&lt;&lt;24)</span>
<span class="cp">#	define I2S_INT_EXTERNAL_SYNC_ERROR	(1&lt;&lt;23)</span>
<span class="cp">#	define I2S_PENDING_EXTERNAL_SYNC_ERROR	(1&lt;&lt;22)</span>
<span class="cp">#	define I2S_INT_EXTERNAL_SYNC_OK		(1&lt;&lt;21)</span>
<span class="cp">#	define I2S_PENDING_EXTERNAL_SYNC_OK	(1&lt;&lt;20)</span>
<span class="cp">#	define I2S_INT_NEW_SAMPLE_RATE		(1&lt;&lt;19)</span>
<span class="cp">#	define I2S_PENDING_NEW_SAMPLE_RATE	(1&lt;&lt;18)</span>
<span class="cp">#	define I2S_INT_STATUS_FLAG		(1&lt;&lt;17)</span>
<span class="cp">#	define I2S_PENDING_STATUS_FLAG		(1&lt;&lt;16)</span>

<span class="cm">/* serial format register is more interesting :)</span>
<span class="cm"> * It contains:</span>
<span class="cm"> *  - clock source</span>
<span class="cm"> *  - MClk divisor</span>
<span class="cm"> *  - SClk divisor</span>
<span class="cm"> *  - SClk master flag</span>
<span class="cm"> *  - serial format (sony, i2s 64x, i2s 32x, dav, silabs)</span>
<span class="cm"> *  - external sample frequency interrupt (don&#39;t understand)</span>
<span class="cm"> *  - external sample frequency</span>
<span class="cm"> */</span>
<span class="cp">#define I2S_REG_SERIAL_FORMAT		0x10</span>
<span class="cm">/* clock source. You get either 18.432, 45.1584 or 49.1520 MHz */</span>
<span class="cp">#	define I2S_SF_CLOCK_SOURCE_SHIFT	30</span>
<span class="cp">#	define I2S_SF_CLOCK_SOURCE_MASK		(3&lt;&lt;I2S_SF_CLOCK_SOURCE_SHIFT)</span>
<span class="cp">#	define I2S_SF_CLOCK_SOURCE_18MHz	(0&lt;&lt;I2S_SF_CLOCK_SOURCE_SHIFT)</span>
<span class="cp">#	define I2S_SF_CLOCK_SOURCE_45MHz	(1&lt;&lt;I2S_SF_CLOCK_SOURCE_SHIFT)</span>
<span class="cp">#	define I2S_SF_CLOCK_SOURCE_49MHz	(2&lt;&lt;I2S_SF_CLOCK_SOURCE_SHIFT)</span>
<span class="cm">/* also, let&#39;s define the exact clock speeds here, in Hz */</span>
<span class="cp">#define I2S_CLOCK_SPEED_18MHz	18432000</span>
<span class="cp">#define I2S_CLOCK_SPEED_45MHz	45158400</span>
<span class="cp">#define I2S_CLOCK_SPEED_49MHz	49152000</span>
<span class="cm">/* MClk is the clock that drives the codec, usually called its &#39;system clock&#39;.</span>
<span class="cm"> * It is derived by taking only every &#39;divisor&#39; tick of the clock.</span>
<span class="cm"> */</span>
<span class="cp">#	define I2S_SF_MCLKDIV_SHIFT		24</span>
<span class="cp">#	define I2S_SF_MCLKDIV_MASK		(0x1F&lt;&lt;I2S_SF_MCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_MCLKDIV_1			(0x14&lt;&lt;I2S_SF_MCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_MCLKDIV_3			(0x13&lt;&lt;I2S_SF_MCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_MCLKDIV_5			(0x12&lt;&lt;I2S_SF_MCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_MCLKDIV_14		(0x0E&lt;&lt;I2S_SF_MCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_MCLKDIV_OTHER(div)	(((div/2-1)&lt;&lt;I2S_SF_MCLKDIV_SHIFT)&amp;I2S_SF_MCLKDIV_MASK)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i2s_sf_mclkdiv</span><span class="p">(</span><span class="kt">int</span> <span class="n">div</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_MCLKDIV_1</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_MCLKDIV_3</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_MCLKDIV_5</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_MCLKDIV_14</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">div</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mh">0x14</span> <span class="o">||</span> <span class="n">d</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">||</span> <span class="n">d</span> <span class="o">==</span> <span class="mh">0x12</span> <span class="o">||</span> <span class="n">d</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_MCLKDIV_OTHER</span><span class="p">(</span><span class="n">div</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* SClk is the clock that drives the i2s wire bus. Note that it is</span>
<span class="cm"> * derived from the MClk above by taking only every &#39;divisor&#39; tick</span>
<span class="cm"> * of MClk.</span>
<span class="cm"> */</span>
<span class="cp">#	define I2S_SF_SCLKDIV_SHIFT		20</span>
<span class="cp">#	define I2S_SF_SCLKDIV_MASK		(0xF&lt;&lt;I2S_SF_SCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_SCLKDIV_1			(8&lt;&lt;I2S_SF_SCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_SCLKDIV_3			(9&lt;&lt;I2S_SF_SCLKDIV_SHIFT)</span>
<span class="cp">#	define I2S_SF_SCLKDIV_OTHER(div)	(((div/2-1)&lt;&lt;I2S_SF_SCLKDIV_SHIFT)&amp;I2S_SF_SCLKDIV_MASK)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i2s_sf_sclkdiv</span><span class="p">(</span><span class="kt">int</span> <span class="n">div</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_SCLKDIV_1</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_SCLKDIV_3</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">div</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">out</span> <span class="o">|=</span> <span class="n">I2S_SF_SCLKDIV_OTHER</span><span class="p">(</span><span class="n">div</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#	define I2S_SF_SCLK_MASTER		(1&lt;&lt;19)</span>
<span class="cm">/* serial format is the way the data is put to the i2s wire bus */</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_SHIFT	16</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_MASK	(7&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_SONY	(0&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_I2S_64X	(1&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_I2S_32X	(2&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_I2S_DAV	(4&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cp">#	define I2S_SF_SERIAL_FORMAT_I2S_SILABS	(5&lt;&lt;I2S_SF_SERIAL_FORMAT_SHIFT)</span>
<span class="cm">/* unknown */</span>
<span class="cp">#	define I2S_SF_EXT_SAMPLE_FREQ_INT_SHIFT	12</span>
<span class="cp">#	define I2S_SF_EXT_SAMPLE_FREQ_INT_MASK	(0xF&lt;&lt;I2S_SF_SAMPLE_FREQ_INT_SHIFT)</span>
<span class="cm">/* probably gives external frequency? */</span>
<span class="cp">#	define I2S_SF_EXT_SAMPLE_FREQ_MASK	0xFFF</span>

<span class="cm">/* used to send codec messages, but how isn&#39;t clear */</span>
<span class="cp">#define I2S_REG_CODEC_MSG_OUT		0x20</span>

<span class="cm">/* used to receive codec messages, but how isn&#39;t clear */</span>
<span class="cp">#define I2S_REG_CODEC_MSG_IN		0x30</span>

<span class="cm">/* frame count reg isn&#39;t clear to me yet, but probably useful */</span>
<span class="cp">#define I2S_REG_FRAME_COUNT		0x40</span>

<span class="cm">/* program to some value, and get interrupt if frame count reaches it */</span>
<span class="cp">#define I2S_REG_FRAME_MATCH		0x50</span>

<span class="cm">/* this register describes how the bus transfers data */</span>
<span class="cp">#define I2S_REG_DATA_WORD_SIZES		0x60</span>
<span class="cm">/* number of interleaved input channels */</span>
<span class="cp">#	define I2S_DWS_NUM_CHANNELS_IN_SHIFT	24</span>
<span class="cp">#	define I2S_DWS_NUM_CHANNELS_IN_MASK	(0x1F&lt;&lt;I2S_DWS_NUM_CHANNELS_IN_SHIFT)</span>
<span class="cm">/* word size of input data */</span>
<span class="cp">#	define I2S_DWS_DATA_IN_SIZE_SHIFT	16</span>
<span class="cp">#	define I2S_DWS_DATA_IN_16BIT		(0&lt;&lt;I2S_DWS_DATA_IN_SIZE_SHIFT)</span>
<span class="cp">#	define I2S_DWS_DATA_IN_24BIT		(3&lt;&lt;I2S_DWS_DATA_IN_SIZE_SHIFT)</span>
<span class="cm">/* number of interleaved output channels */</span>
<span class="cp">#	define I2S_DWS_NUM_CHANNELS_OUT_SHIFT	8</span>
<span class="cp">#	define I2S_DWS_NUM_CHANNELS_OUT_MASK	(0x1F&lt;&lt;I2S_DWS_NUM_CHANNELS_OUT_SHIFT)</span>
<span class="cm">/* word size of output data */</span>
<span class="cp">#	define I2S_DWS_DATA_OUT_SIZE_SHIFT	0</span>
<span class="cp">#	define I2S_DWS_DATA_OUT_16BIT		(0&lt;&lt;I2S_DWS_DATA_OUT_SIZE_SHIFT)</span>
<span class="cp">#	define I2S_DWS_DATA_OUT_24BIT		(3&lt;&lt;I2S_DWS_DATA_OUT_SIZE_SHIFT)</span>


<span class="cm">/* unknown */</span>
<span class="cp">#define I2S_REG_PEAK_LEVEL_SEL		0x70</span>

<span class="cm">/* unknown */</span>
<span class="cp">#define I2S_REG_PEAK_LEVEL_IN0		0x80</span>

<span class="cm">/* unknown */</span>
<span class="cp">#define I2S_REG_PEAK_LEVEL_IN1		0x90</span>

<span class="cp">#endif </span><span class="cm">/* __I2SBUS_INTERFACE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
