<!DOCTYPE html>
<html><head><title>joekychen/linux » security › apparmor › include › file.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>file.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AppArmor security module</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains AppArmor file mediation function definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998-2008 Novell/SUSE</span>
<span class="cm"> * Copyright 2009-2010 Canonical Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation, version 2 of the</span>
<span class="cm"> * License.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __AA_FILE_H</span>
<span class="cp">#define __AA_FILE_H</span>

<span class="cp">#include &quot;domain.h&quot;</span>
<span class="cp">#include &quot;match.h&quot;</span>

<span class="k">struct</span> <span class="n">aa_profile</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">path</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We use MAY_EXEC, MAY_WRITE, MAY_READ, MAY_APPEND and the following flags</span>
<span class="cm"> * for profile permissions</span>
<span class="cm"> */</span>
<span class="cp">#define AA_MAY_CREATE                  0x0010</span>
<span class="cp">#define AA_MAY_DELETE                  0x0020</span>
<span class="cp">#define AA_MAY_META_WRITE              0x0040</span>
<span class="cp">#define AA_MAY_META_READ               0x0080</span>

<span class="cp">#define AA_MAY_CHMOD                   0x0100</span>
<span class="cp">#define AA_MAY_CHOWN                   0x0200</span>
<span class="cp">#define AA_MAY_LOCK                    0x0400</span>
<span class="cp">#define AA_EXEC_MMAP                   0x0800</span>

<span class="cp">#define AA_MAY_LINK			0x1000</span>
<span class="cp">#define AA_LINK_SUBSET			AA_MAY_LOCK	</span><span class="cm">/* overlaid */</span><span class="cp"></span>
<span class="cp">#define AA_MAY_ONEXEC			0x40000000	</span><span class="cm">/* exec allows onexec */</span><span class="cp"></span>
<span class="cp">#define AA_MAY_CHANGE_PROFILE		0x80000000</span>
<span class="cp">#define AA_MAY_CHANGEHAT		0x80000000	</span><span class="cm">/* ctrl auditing only */</span><span class="cp"></span>

<span class="cp">#define AA_AUDIT_FILE_MASK	(MAY_READ | MAY_WRITE | MAY_EXEC | MAY_APPEND |\</span>
<span class="cp">				 AA_MAY_CREATE | AA_MAY_DELETE |	\</span>
<span class="cp">				 AA_MAY_META_READ | AA_MAY_META_WRITE | \</span>
<span class="cp">				 AA_MAY_CHMOD | AA_MAY_CHOWN | AA_MAY_LOCK | \</span>
<span class="cp">				 AA_EXEC_MMAP | AA_MAY_LINK)</span>

<span class="cm">/*</span>
<span class="cm"> * The xindex is broken into 3 parts</span>
<span class="cm"> * - index - an index into either the exec name table or the variable table</span>
<span class="cm"> * - exec type - which determines how the executable name and index are used</span>
<span class="cm"> * - flags - which modify how the destination name is applied</span>
<span class="cm"> */</span>
<span class="cp">#define AA_X_INDEX_MASK		0x03ff</span>

<span class="cp">#define AA_X_TYPE_MASK		0x0c00</span>
<span class="cp">#define AA_X_TYPE_SHIFT		10</span>
<span class="cp">#define AA_X_NONE		0x0000</span>
<span class="cp">#define AA_X_NAME		0x0400	</span><span class="cm">/* use executable name px */</span><span class="cp"></span>
<span class="cp">#define AA_X_TABLE		0x0800	</span><span class="cm">/* use a specified name -&gt;n# */</span><span class="cp"></span>

<span class="cp">#define AA_X_UNSAFE		0x1000</span>
<span class="cp">#define AA_X_CHILD		0x2000	</span><span class="cm">/* make &gt;AA_X_NONE apply to children */</span><span class="cp"></span>
<span class="cp">#define AA_X_INHERIT		0x4000</span>
<span class="cp">#define AA_X_UNCONFINED		0x8000</span>

<span class="cm">/* AA_SECURE_X_NEEDED - is passed in the bprm-&gt;unsafe field */</span>
<span class="cp">#define AA_SECURE_X_NEEDED	0x8000</span>

<span class="cm">/* need to make conditional which ones are being set */</span>
<span class="k">struct</span> <span class="n">path_cond</span> <span class="p">{</span>
	<span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* struct file_perms - file permission</span>
<span class="cm"> * @allow: mask of permissions that are allowed</span>
<span class="cm"> * @audit: mask of permissions to force an audit message for</span>
<span class="cm"> * @quiet: mask of permissions to quiet audit messages for</span>
<span class="cm"> * @kill: mask of permissions that when matched will kill the task</span>
<span class="cm"> * @xindex: exec transition index if @allow contains MAY_EXEC</span>
<span class="cm"> *</span>
<span class="cm"> * The @audit and @queit mask should be mutually exclusive.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">file_perms</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">allow</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">audit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">quiet</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">kill</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xindex</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">file_perms</span> <span class="n">nullperms</span><span class="p">;</span>

<span class="cp">#define COMBINED_PERM_MASK(X) ((X).allow | (X).audit | (X).quiet | (X).kill)</span>

<span class="cm">/* FIXME: split perms from dfa and match this to description</span>
<span class="cm"> *        also add delegation info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">dfa_map_xindex</span><span class="p">(</span><span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">old_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_UNSAFE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_INHERIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_UNCONFINED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_UNCONFINED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_NAME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_NAME</span> <span class="o">|</span> <span class="n">AA_X_CHILD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">AA_X_TABLE</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">old_index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * map old dfa inline permissions to new format</span>
<span class="cm"> */</span>
<span class="cp">#define dfa_user_allow(dfa, state) (((ACCEPT_TABLE(dfa)[state]) &amp; 0x7f) | \</span>
<span class="cp">				    ((ACCEPT_TABLE(dfa)[state]) &amp; 0x80000000))</span>
<span class="cp">#define dfa_user_audit(dfa, state) ((ACCEPT_TABLE2(dfa)[state]) &amp; 0x7f)</span>
<span class="cp">#define dfa_user_quiet(dfa, state) (((ACCEPT_TABLE2(dfa)[state]) &gt;&gt; 7) &amp; 0x7f)</span>
<span class="cp">#define dfa_user_xindex(dfa, state) \</span>
<span class="cp">	(dfa_map_xindex(ACCEPT_TABLE(dfa)[state] &amp; 0x3fff))</span>

<span class="cp">#define dfa_other_allow(dfa, state) ((((ACCEPT_TABLE(dfa)[state]) &gt;&gt; 14) &amp; \</span>
<span class="cp">				      0x7f) |				\</span>
<span class="cp">				     ((ACCEPT_TABLE(dfa)[state]) &amp; 0x80000000))</span>
<span class="cp">#define dfa_other_audit(dfa, state) (((ACCEPT_TABLE2(dfa)[state]) &gt;&gt; 14) &amp; 0x7f)</span>
<span class="cp">#define dfa_other_quiet(dfa, state) \</span>
<span class="cp">	((((ACCEPT_TABLE2(dfa)[state]) &gt;&gt; 7) &gt;&gt; 14) &amp; 0x7f)</span>
<span class="cp">#define dfa_other_xindex(dfa, state) \</span>
<span class="cp">	dfa_map_xindex((ACCEPT_TABLE(dfa)[state] &gt;&gt; 14) &amp; 0x3fff)</span>

<span class="kt">int</span> <span class="n">aa_audit_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_perms</span> <span class="o">*</span><span class="n">perms</span><span class="p">,</span>
		  <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">request</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">ouid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * struct aa_file_rules - components used for file rule permissions</span>
<span class="cm"> * @dfa: dfa to match path names and conditionals against</span>
<span class="cm"> * @perms: permission table indexed by the matched state accept entry of @dfa</span>
<span class="cm"> * @trans: transition table for indexed by named x transitions</span>
<span class="cm"> *</span>
<span class="cm"> * File permission are determined by matching a path against @dfa and then</span>
<span class="cm"> * then using the value of the accept entry for the matching state as</span>
<span class="cm"> * an index into @perms.  If a named exec transition is required it is</span>
<span class="cm"> * looked up in the transition table.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aa_file_rules</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aa_dfa</span> <span class="o">*</span><span class="n">dfa</span><span class="p">;</span>
	<span class="cm">/* struct perms perms; */</span>
	<span class="k">struct</span> <span class="n">aa_domain</span> <span class="n">trans</span><span class="p">;</span>
	<span class="cm">/* TODO: add delegate table */</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aa_str_perms</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_dfa</span> <span class="o">*</span><span class="n">dfa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">file_perms</span> <span class="o">*</span><span class="n">perms</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aa_path_perm</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aa_path_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aa_file_perm</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		 <span class="n">u32</span> <span class="n">request</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">aa_free_file_rules</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_file_rules</span> <span class="o">*</span><span class="n">rules</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aa_put_dfa</span><span class="p">(</span><span class="n">rules</span><span class="o">-&gt;</span><span class="n">dfa</span><span class="p">);</span>
	<span class="n">aa_free_domain_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rules</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ACC_FMODE(x) ((&quot;\000\004\002\006&quot;[(x)&amp;O_ACCMODE]) | (((x) &lt;&lt; 1) &amp; 0x40))</span>

<span class="cm">/* from namei.c */</span>
<span class="cp">#define MAP_OPEN_FLAGS(x) ((((x) + 1) &amp; O_ACCMODE) ? (x) + 1 : (x))</span>

<span class="cm">/**</span>
<span class="cm"> * aa_map_file_perms - map file flags to AppArmor permissions</span>
<span class="cm"> * @file: open file to map flags to AppArmor permissions</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: apparmor permission set for the file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">aa_map_file_to_perms</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">MAP_OPEN_FLAGS</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">perms</span> <span class="o">=</span> <span class="n">ACC_FMODE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_APPEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">perms</span> <span class="o">&amp;</span> <span class="n">MAY_WRITE</span><span class="p">))</span>
		<span class="n">perms</span> <span class="o">=</span> <span class="p">(</span><span class="n">perms</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAY_WRITE</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAY_APPEND</span><span class="p">;</span>
	<span class="cm">/* trunc implies write permission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_TRUNC</span><span class="p">)</span>
		<span class="n">perms</span> <span class="o">|=</span> <span class="n">MAY_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">)</span>
		<span class="n">perms</span> <span class="o">|=</span> <span class="n">AA_MAY_CREATE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">perms</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __AA_FILE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
