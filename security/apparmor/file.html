<!DOCTYPE html>
<html><head><title>joekychen/linux » security › apparmor › file.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>file.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AppArmor security module</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains AppArmor mediation of files</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998-2008 Novell/SUSE</span>
<span class="cm"> * Copyright 2009-2010 Canonical Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation, version 2 of the</span>
<span class="cm"> * License.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;include/apparmor.h&quot;</span>
<span class="cp">#include &quot;include/audit.h&quot;</span>
<span class="cp">#include &quot;include/file.h&quot;</span>
<span class="cp">#include &quot;include/match.h&quot;</span>
<span class="cp">#include &quot;include/path.h&quot;</span>
<span class="cp">#include &quot;include/policy.h&quot;</span>

<span class="k">struct</span> <span class="n">file_perms</span> <span class="n">nullperms</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * audit_file_mask - convert mask to permission string</span>
<span class="cm"> * @buffer: buffer to write string to (NOT NULL)</span>
<span class="cm"> * @mask: permission mask to convert</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_file_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AA_EXEC_MMAP</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;m&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAY_READ</span> <span class="o">|</span> <span class="n">AA_MAY_META_READ</span><span class="p">))</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAY_WRITE</span> <span class="o">|</span> <span class="n">AA_MAY_META_WRITE</span> <span class="o">|</span> <span class="n">AA_MAY_CHMOD</span> <span class="o">|</span>
		    <span class="n">AA_MAY_CHOWN</span><span class="p">))</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MAY_APPEND</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AA_MAY_CREATE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AA_MAY_DELETE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AA_MAY_LINK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;l&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AA_MAY_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;k&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MAY_EXEC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">m</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;x&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">audit_log_string</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * file_audit_cb - call back for file specific audit fields</span>
<span class="cm"> * @ab: audit_buffer  (NOT NULL)</span>
<span class="cm"> * @va: audit struct to audit values of  (NOT NULL)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">file_audit_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">common_audit_data</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">fsuid</span> <span class="o">=</span> <span class="n">current_fsuid</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="n">AA_AUDIT_FILE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; requested_mask=&quot;</span><span class="p">);</span>
		<span class="n">audit_file_mask</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">denied</span> <span class="o">&amp;</span> <span class="n">AA_AUDIT_FILE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; denied_mask=&quot;</span><span class="p">);</span>
		<span class="n">audit_file_mask</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">denied</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="n">AA_AUDIT_FILE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; fsuid=%d&quot;</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">);</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; ouid=%d&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">ouid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; target=&quot;</span><span class="p">);</span>
		<span class="n">audit_log_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aa_audit_file - handle the auditing of file operations</span>
<span class="cm"> * @profile: the profile being enforced  (NOT NULL)</span>
<span class="cm"> * @perms: the permissions computed for the request (NOT NULL)</span>
<span class="cm"> * @gfp: allocation flags</span>
<span class="cm"> * @op: operation being mediated</span>
<span class="cm"> * @request: permissions requested</span>
<span class="cm"> * @name: name of object being mediated (MAYBE NULL)</span>
<span class="cm"> * @target: name of target (MAYBE NULL)</span>
<span class="cm"> * @ouid: object uid</span>
<span class="cm"> * @info: extra information message (MAYBE NULL)</span>
<span class="cm"> * @error: 0 if operation allowed else failure error code</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 or error on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aa_audit_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_perms</span> <span class="o">*</span><span class="n">perms</span><span class="p">,</span>
		  <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">request</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">ouid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_APPARMOR_AUTO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">common_audit_data</span> <span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">apparmor_audit_data</span> <span class="n">aad</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
	<span class="n">sa</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">LSM_AUDIT_DATA_NONE</span><span class="p">;</span>
	<span class="n">sa</span><span class="p">.</span><span class="n">aad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aad</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">,</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">ouid</span> <span class="o">=</span> <span class="n">ouid</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">aad</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">perms</span><span class="o">-&gt;</span><span class="n">audit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">AUDIT_MODE</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUDIT_ALL</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="cm">/* mask off perms that are not being force audited */</span>
		<span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_APPARMOR_AUDIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* only report permissions that were denied */</span>
		<span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">perms</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="n">perms</span><span class="o">-&gt;</span><span class="n">kill</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_APPARMOR_KILL</span><span class="p">;</span>

		<span class="cm">/* quiet known rejects, assumes quiet and kill do not overlap */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="n">perms</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">AUDIT_MODE</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AUDIT_NOQUIET</span> <span class="o">&amp;&amp;</span>
		    <span class="n">AUDIT_MODE</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AUDIT_ALL</span><span class="p">)</span>
			<span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">perms</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">COMPLAIN_MODE</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">denied</span> <span class="o">=</span> <span class="n">sa</span><span class="p">.</span><span class="n">aad</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">request</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">perms</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aa_audit</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="n">file_audit_cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * map_old_perms - map old file perms layout to the new layout</span>
<span class="cm"> * @old: permission set in old mapping</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: new permission mapping</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">map_old_perms</span><span class="p">(</span><span class="n">u32</span> <span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="n">MAY_READ</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">AA_MAY_META_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="n">MAY_WRITE</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">AA_MAY_META_WRITE</span> <span class="o">|</span> <span class="n">AA_MAY_CREATE</span> <span class="o">|</span> <span class="n">AA_MAY_DELETE</span> <span class="o">|</span>
			<span class="n">AA_MAY_CHMOD</span> <span class="o">|</span> <span class="n">AA_MAY_CHOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">AA_MAY_LINK</span><span class="p">;</span>
	<span class="cm">/* the old mapping lock and link_subset flags where overlaid</span>
<span class="cm">	 * and use was determined by part of a pair that they were in</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">AA_MAY_LOCK</span> <span class="o">|</span> <span class="n">AA_LINK_SUBSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>	<span class="cm">/* AA_EXEC_MMAP */</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">AA_EXEC_MMAP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * compute_perms - convert dfa compressed perms to internal perms</span>
<span class="cm"> * @dfa: dfa to compute perms for   (NOT NULL)</span>
<span class="cm"> * @state: state in dfa</span>
<span class="cm"> * @cond:  conditions to consider  (NOT NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: convert from dfa + state to permission entry, do computation conversion</span>
<span class="cm"> *       at load time.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: computed permission set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_perms</span> <span class="nf">compute_perms</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_dfa</span> <span class="o">*</span><span class="n">dfa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">path_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file_perms</span> <span class="n">perms</span><span class="p">;</span>

	<span class="cm">/* FIXME: change over to new dfa format</span>
<span class="cm">	 * currently file perms are encoded in the dfa, new format</span>
<span class="cm">	 * splits the permissions from the dfa.  This mapping can be</span>
<span class="cm">	 * done at profile load</span>
<span class="cm">	 */</span>
	<span class="n">perms</span><span class="p">.</span><span class="n">kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_fsuid</span><span class="p">()</span> <span class="o">==</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_user_allow</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">audit</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_user_audit</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_user_quiet</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">xindex</span> <span class="o">=</span> <span class="n">dfa_user_xindex</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_other_allow</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">audit</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_other_audit</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">map_old_perms</span><span class="p">(</span><span class="n">dfa_other_quiet</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">xindex</span> <span class="o">=</span> <span class="n">dfa_other_xindex</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">|=</span> <span class="n">AA_MAY_META_READ</span><span class="p">;</span>

	<span class="cm">/* change_profile wasn&#39;t determined by ownership in old mapping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACCEPT_TABLE</span><span class="p">(</span><span class="n">dfa</span><span class="p">)[</span><span class="n">state</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">|=</span> <span class="n">AA_MAY_CHANGE_PROFILE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACCEPT_TABLE</span><span class="p">(</span><span class="n">dfa</span><span class="p">)[</span><span class="n">state</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span>
		<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">|=</span> <span class="n">AA_MAY_ONEXEC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">perms</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aa_str_perms - find permission that match @name</span>
<span class="cm"> * @dfa: to match against  (MAYBE NULL)</span>
<span class="cm"> * @state: state to start matching in</span>
<span class="cm"> * @name: string to match against dfa  (NOT NULL)</span>
<span class="cm"> * @cond: conditions to consider for permission set computation  (NOT NULL)</span>
<span class="cm"> * @perms: Returns - the permissions found when matching @name</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the final state in @dfa when beginning @start and walking @name</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">aa_str_perms</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_dfa</span> <span class="o">*</span><span class="n">dfa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">file_perms</span> <span class="o">*</span><span class="n">perms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dfa</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">perms</span> <span class="o">=</span> <span class="n">nullperms</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">DFA_NOMATCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">aa_dfa_match</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">perms</span> <span class="o">=</span> <span class="n">compute_perms</span><span class="p">(</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">cond</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_deleted - test if a file has been completely unlinked</span>
<span class="cm"> * @dentry: dentry of file to test for deletion  (NOT NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %1 if deleted else %0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d_unlinked</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aa_path_perm - do permissions check &amp; audit for @path</span>
<span class="cm"> * @op: operation being checked</span>
<span class="cm"> * @profile: profile being enforced  (NOT NULL)</span>
<span class="cm"> * @path: path to check permissions of  (NOT NULL)</span>
<span class="cm"> * @flags: any additional path flags beyond what the profile specifies</span>
<span class="cm"> * @request: requested permissions</span>
<span class="cm"> * @cond: conditional info for this request  (NOT NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 else error if access denied or other error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aa_path_perm</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_perms</span> <span class="n">perms</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">path_flags</span> <span class="o">|</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">?</span> <span class="n">PATH_IS_DIR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aa_path_name</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="n">is_deleted</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Access to open files that are deleted are</span>
<span class="cm">			 * give a pass (implicit delegation)</span>
<span class="cm">			 */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aa_str_perms</span><span class="p">(</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">dfa</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">perms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">perms</span><span class="p">.</span><span class="n">allow</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aa_audit_file</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perms</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xindex_is_subset - helper for aa_path_link</span>
<span class="cm"> * @link: link permission set</span>
<span class="cm"> * @target: target permission set</span>
<span class="cm"> *</span>
<span class="cm"> * test target x permissions are equal OR a subset of link x permissions</span>
<span class="cm"> * this is done as part of the subset test, where a hardlink must have</span>
<span class="cm"> * a subset of permissions that the target has.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %1 if subset else %0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">xindex_is_subset</span><span class="p">(</span><span class="n">u32</span> <span class="n">link</span><span class="p">,</span> <span class="n">u32</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">link</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AA_X_UNSAFE</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">target</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AA_X_UNSAFE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">link</span> <span class="o">&amp;</span> <span class="n">AA_X_UNSAFE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">target</span> <span class="o">&amp;</span> <span class="n">AA_X_UNSAFE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aa_path_link - Handle hard link permission check</span>
<span class="cm"> * @profile: the profile being enforced  (NOT NULL)</span>
<span class="cm"> * @old_dentry: the target dentry  (NOT NULL)</span>
<span class="cm"> * @new_dir: directory the new link will be created in  (NOT NULL)</span>
<span class="cm"> * @new_dentry: the link being created  (NOT NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * Handle the permission test for a link &amp; target pair.  Permission</span>
<span class="cm"> * is encoded as a pair where the link permission is determined</span>
<span class="cm"> * first, and if allowed, the target is tested.  The target test</span>
<span class="cm"> * is done from the point of the link match (not start of DFA)</span>
<span class="cm"> * making the target permission dependent on the link permission match.</span>
<span class="cm"> *</span>
<span class="cm"> * The subset test if required forces that permissions granted</span>
<span class="cm"> * on link are a subset of the permission granted to target.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 if allowed else error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aa_path_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path</span> <span class="n">link</span> <span class="o">=</span> <span class="p">{</span> <span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">,</span> <span class="n">new_dentry</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">path</span> <span class="n">target</span> <span class="o">=</span> <span class="p">{</span> <span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">,</span> <span class="n">old_dentry</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">path_cond</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">,</span>
		<span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span>
	<span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lname</span><span class="p">,</span> <span class="o">*</span><span class="n">tname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_perms</span> <span class="n">lperms</span><span class="p">,</span> <span class="n">perms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">request</span> <span class="o">=</span> <span class="n">AA_MAY_LINK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">lperms</span> <span class="o">=</span> <span class="n">nullperms</span><span class="p">;</span>

	<span class="cm">/* buffer freed below, lname is pointer in buffer */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aa_path_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">path_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lname</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>

	<span class="cm">/* buffer2 freed below, tname is pointer in buffer2 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aa_path_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">path_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tname</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="cm">/* aa_str_perms - handles the case of the dfa being NULL */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">aa_str_perms</span><span class="p">(</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">dfa</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lperms</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="n">AA_MAY_LINK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>

	<span class="cm">/* test to see if target can be paired with link */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">aa_dfa_null_transition</span><span class="p">(</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">aa_str_perms</span><span class="p">(</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">dfa</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perms</span><span class="p">);</span>

	<span class="cm">/* force audit/quiet masks for link are stored in the second entry</span>
<span class="cm">	 * in the link pair.</span>
<span class="cm">	 */</span>
	<span class="n">lperms</span><span class="p">.</span><span class="n">audit</span> <span class="o">=</span> <span class="n">perms</span><span class="p">.</span><span class="n">audit</span><span class="p">;</span>
	<span class="n">lperms</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">perms</span><span class="p">.</span><span class="n">quiet</span><span class="p">;</span>
	<span class="n">lperms</span><span class="p">.</span><span class="n">kill</span> <span class="o">=</span> <span class="n">perms</span><span class="p">.</span><span class="n">kill</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="n">AA_MAY_LINK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;target restricted&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* done if link subset test is not required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="n">AA_LINK_SUBSET</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done_tests</span><span class="p">;</span>

	<span class="cm">/* Do link perm subset test requiring allowed permission on link are a</span>
<span class="cm">	 * subset of the allowed permissions on target.</span>
<span class="cm">	 */</span>
	<span class="n">aa_str_perms</span><span class="p">(</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">dfa</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">perms</span><span class="p">);</span>

	<span class="cm">/* AA_MAY_LINK is not considered in the subset test */</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AA_MAY_LINK</span><span class="p">;</span>
	<span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;=</span> <span class="n">perms</span><span class="p">.</span><span class="n">allow</span> <span class="o">|</span> <span class="n">AA_MAY_LINK</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">|=</span> <span class="n">AA_AUDIT_FILE_MASK</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">perms</span><span class="p">.</span><span class="n">allow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">lperms</span><span class="p">.</span><span class="n">allow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;</span> <span class="n">MAY_EXEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">xindex_is_subset</span><span class="p">(</span><span class="n">lperms</span><span class="p">.</span><span class="n">xindex</span><span class="p">,</span> <span class="n">perms</span><span class="p">.</span><span class="n">xindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lperms</span><span class="p">.</span><span class="n">allow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAY_EXEC</span><span class="p">;</span>
		<span class="n">request</span> <span class="o">|=</span> <span class="n">MAY_EXEC</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;link not subset of target&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">audit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done_tests:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">audit:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aa_audit_file</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lperms</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">OP_LINK</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
			      <span class="n">lname</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">cond</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aa_file_perm - do permission revalidation check &amp; audit for @file</span>
<span class="cm"> * @op: operation being checked</span>
<span class="cm"> * @profile: profile being enforced   (NOT NULL)</span>
<span class="cm"> * @file: file to revalidate access permissions on  (NOT NULL)</span>
<span class="cm"> * @request: requested permissions</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: %0 if access allowed else error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aa_file_perm</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aa_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		 <span class="n">u32</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path_cond</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">aa_path_perm</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="n">PATH_DELEGATE_DELETED</span><span class="p">,</span>
			    <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
