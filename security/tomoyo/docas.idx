f | common.c | s | 75K | 2691 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1337041469 |  | TOMOYO: Accept manager programs which do not start with / .  The pathname of /usr/sbin/tomoyo-editpolicy seen from Ubuntu 12.04 Live CD is squashfs:/usr/sbin/tomoyo-editpolicy rather than /usr/sbin/tomoyo-editpolicy . Therefore, we need to accept manager programs which do not start with / .  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <james.l.morris@oracle.com>
f | mount.c | s | 6.6K | 225 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1330557799 |  | TOMOYO: Fix mount flags checking order.  Userspace can pass in arbitrary combinations of MS_* flags to mount().  If both MS_BIND and one of MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE are passed, device name which should be checked for MS_BIND was not checked because MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE had higher priority than MS_BIND.  If both one of MS_BIND/MS_MOVE and MS_REMOUNT are passed, device name which should not be checked for MS_REMOUNT was checked because MS_BIND/MS_MOVE had higher priority than MS_REMOUNT.  Fix these bugs by changing priority to MS_REMOUNT -> MS_BIND -> MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE -> MS_MOVE as with do_mount() does.  Also, unconditionally return -EINVAL if more than one of MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE is passed so that TOMOYO will not generate inaccurate audit logs, for commit 7a2e8a8f "VFS: Sanity check mount flags passed to change_mnt_propagation()" clarified that these flags must be exclusively passed.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <james.l.morris@oracle.com>
f | Makefile | g | 2.1K |  | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1316038461 |  | TOMOYO: Bump version.  Tell userland tools that this is TOMOYO 2.5.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | domain.c | s | 24K | 869 | Cong Wang | amwang@redhat.com | 1332251308 |  | tomoyo: remove the second argument of k[un]map_atomic()  Acked-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: Cong Wang <amwang@redhat.com>
f | tomoyo.c | s | 14K | 522 | Eric Paris | eparis@redhat.com | 1333988570 |  | SELinux: rename dentry_open to file_open  dentry_open takes a file, rename it to file_open  Signed-off-by: Eric Paris <eparis@redhat.com>
f | util.c | s | 27K | 1044 | Tetsuo Handa | from-tomoyo-users-en@I-love.SAKURA.ne.jp | 1326843659 |  | TOMOYO: Accept \000 as a valid character.  TOMOYO 2.5 in Linux 3.2 and later handles Unix domain socket's address. Thus, tomoyo_correct_word2() needs to accept \000 as a valid character, or TOMOYO 2.5 cannot handle Unix domain's abstract socket address.  Reported-by: Steven Allen <steven@stebalien.com> Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> CC: stable@vger.kernel.org [3.2+] Signed-off-by: James Morris <jmorris@namei.org>
f | environ.c | s | 3.0K | 111 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1315952825 |  | TOMOYO: Add environment variable name restriction support.  This patch adds support for checking environment variable's names. Although TOMOYO already provides ability to check argv[]/envp[] passed to execve() requests,    file execute /bin/sh exec.envp["LD_LIBRARY_PATH"]="bar"  will reject execution of /bin/sh if environment variable LD_LIBRARY_PATH is not defined. To grant execution of /bin/sh if LD_LIBRARY_PATH is not defined, administrators have to specify like    file execute /bin/sh exec.envp["LD_LIBRARY_PATH"]="/system/lib"   file execute /bin/sh exec.envp["LD_LIBRARY_PATH"]=NULL  . Since there are many environment variables whereas conditional checks are applied as "&&", it is difficult to cover all combinations. Therefore, this patch supports conditional checks that are applied as "||||", by specifying like    file execute /bin/sh   misc env LD_LIBRARY_PATH exec.envp["LD_LIBRARY_PATH"]="/system/lib"  which means "grant execution of /bin/sh if environment variable is not defined or is defined and its value is /system/lib".  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | network.c | s | 21K | 717 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1315952825 |  | TOMOYO: Add socket operation restriction support.  This patch adds support for permission checks for PF_INET/PF_INET6/PF_UNIX socket's bind()/listen()/connect()/send() operations.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | audit.c | s | 12K | 446 | Tetsuo Handa | penguin-kernel@i-love.sakura.ne.jp | 1331774958 |  | TOMOYO: Return appropriate value to poll().  "struct file_operations"->poll() expects "unsigned int" return value. All files in /sys/kernel/security/tomoyo/ directory other than /sys/kernel/security/tomoyo/query and /sys/kernel/security/tomoyo/audit should return POLLIN || POLLRDNORM || POLLOUT || POLLWRNORM rather than -ENOSYS. Also, /sys/kernel/security/tomoyo/query and /sys/kernel/security/tomoyo/audit should return POLLOUT || POLLWRNORM rather than 0 when there is no data to read.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <james.l.morris@oracle.com>
f | memory.c | s | 5.4K | 190 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1316997982 |  | TOMOYO: Remove tomoyo_policy_memory_lock spinlock.  tomoyo_policy_lock mutex already protects it.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | gc.c | s | 16K | 626 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1318382120 |  | TOMOYO: Fix quota and garbage collector.  Commit 059d84db "TOMOYO: Add socket operation restriction support" and commit 731d37aa "TOMOYO: Allow domain transition without execve()." forgot to update tomoyo_domain_quota_is_ok() and tomoyo_del_acl() which results in incorrect quota counting and memory leak.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | load_policy.c | s | 2.6K | 97 | Oleg Nesterov | oleg@redhat.com | 1332547121 |  | usermodehelper: use UMH_WAIT_PROC consistently  A few call_usermodehelper() callers use the hardcoded constant instead of the proper UMH_WAIT_PROC, fix them.  Reported-by: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp> Signed-off-by: Oleg Nesterov <oleg@redhat.com> Cc: Lars Ellenberg <drbd-dev@lists.linbit.com> Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org> Cc: Michal Januszewski <spock@gentoo.org> Cc: Florian Tobias Schandinat <FlorianSchandinat@gmx.de> Cc: Kentaro Takeda <takedakn@nttdata.co.jp> Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Cc: James Morris <jmorris@namei.org> Signed-off-by: Andrew Morton <akpm@linux-foundation.org> Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
f | Kconfig | g | 2.8K |  | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1315952825 |  | TOMOYO: Add socket operation restriction support.  This patch adds support for permission checks for PF_INET/PF_INET6/PF_UNIX socket's bind()/listen()/connect()/send() operations.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | condition.c | s | 26K | 1074 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1316997980 |  | TOMOYO: Simplify garbage collector.  When TOMOYO started using garbage collector at commit 847b173e "TOMOYO: Add garbage collector.", we waited for close() before kfree(). Thus, elements to be kfree()d were queued up using tomoyo_gc_list list.  But it turned out that tomoyo_element_linked_by_gc() tends to choke garbage collector when certain pattern of entries are queued.  Since garbage collector is no longer waiting for close() since commit 2e503bbb "TOMOYO: Fix lockdep warning.", we can remove tomoyo_gc_list list and tomoyo_element_linked_by_gc() by doing sequential processing.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | group.c | s | 5.6K | 187 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1315952825 |  | TOMOYO: Add socket operation restriction support.  This patch adds support for permission checks for PF_INET/PF_INET6/PF_UNIX socket's bind()/listen()/connect()/send() operations.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | file.c | s | 28K | 979 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1316997979 |  | TOMOYO: Fix make namespacecheck warnings.  Commit efe836ab "TOMOYO: Add built-in policy support." introduced tomoyo_load_builtin_policy() but was by error called from nowhere.  Commit b22b8b9f "TOMOYO: Rename meminfo to stat and show more statistics." introduced tomoyo_update_stat() but was by error not called from tomoyo_assign_domain().  Also, mark tomoyo_io_printf() and tomoyo_path_permission() static functions, as reported by "make namespacecheck".  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <jmorris@namei.org>
f | securityfs_if.c | s | 7.5K | 257 | Tetsuo Handa | penguin-kernel@i-love.sakura.ne.jp | 1331774958 |  | TOMOYO: Return appropriate value to poll().  "struct file_operations"->poll() expects "unsigned int" return value. All files in /sys/kernel/security/tomoyo/ directory other than /sys/kernel/security/tomoyo/query and /sys/kernel/security/tomoyo/audit should return POLLIN || POLLRDNORM || POLLOUT || POLLWRNORM rather than -ENOSYS. Also, /sys/kernel/security/tomoyo/query and /sys/kernel/security/tomoyo/audit should return POLLOUT || POLLWRNORM rather than 0 when there is no data to read.  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <james.l.morris@oracle.com>
f | common.h | s | 40K | 1228 | Tetsuo Handa | penguin-kernel@I-love.SAKURA.ne.jp | 1337041469 |  | TOMOYO: Accept manager programs which do not start with / .  The pathname of /usr/sbin/tomoyo-editpolicy seen from Ubuntu 12.04 Live CD is squashfs:/usr/sbin/tomoyo-editpolicy rather than /usr/sbin/tomoyo-editpolicy . Therefore, we need to accept manager programs which do not start with / .  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp> Signed-off-by: James Morris <james.l.morris@oracle.com>
f | realpath.c | s | 7.8K | 315 | Al Viro | viro@zeniv.linux.org.uk | 1325649433 |  | vfs: trim includes a bit  [folded fix for missing magic.h from Tetsuo Handa]  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
