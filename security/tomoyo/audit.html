<!DOCTYPE html>
<html><head><title>joekychen/linux » security › tomoyo › audit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>audit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * security/tomoyo/audit.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2011  NTT DATA CORPORATION</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_bprm - Print &quot;struct linux_binprm&quot; for auditing.</span>
<span class="cm"> *</span>
<span class="cm"> * @bprm: Pointer to &quot;struct linux_binprm&quot;.</span>
<span class="cm"> * @dump: Pointer to &quot;struct tomoyo_page_dump&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the contents of @bprm on success, NULL otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses kzalloc(), so caller must kfree() if this function</span>
<span class="cm"> * didn&#39;t return NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_print_bprm</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tomoyo_page_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">tomoyo_buffer_len</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">tomoyo_buffer_len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">last_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">argv_count</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">envp_count</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">truncated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;argv[]={ &quot;</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;} envp[]={ &quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_start</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">argv_count</span> <span class="o">||</span> <span class="n">envp_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_dump_page</span><span class="p">(</span><span class="n">bprm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dump</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="cm">/* Read. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kaddr</span> <span class="o">=</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">kaddr</span><span class="p">[</span><span class="n">offset</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">last_start</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Reserve some room for &quot;...&quot; string. */</span>
				<span class="n">truncated</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
				<span class="n">last_start</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">argv_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">truncated</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cp</span> <span class="o">=</span> <span class="n">last_start</span><span class="p">;</span>
						<span class="n">memmove</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;... &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
						<span class="n">cp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">memmove</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;} envp[]={ &quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
					<span class="n">cp</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
					<span class="n">last_start</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
					<span class="n">truncated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">envp_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">envp_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">truncated</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cp</span> <span class="o">=</span> <span class="n">last_start</span><span class="p">;</span>
						<span class="n">memmove</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;... &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
						<span class="n">cp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">envp_count</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;}&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		 <span class="s">&quot;argv[]={ ... } envp[]= { ... }&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_filetype - Get string representation of file type.</span>
<span class="cm"> *</span>
<span class="cm"> * @mode: Mode value for stat().</span>
<span class="cm"> *</span>
<span class="cm"> * Returns file type string.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_filetype</span><span class="p">(</span><span class="k">const</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S_IFREG</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_FILE</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFDIR</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_DIRECTORY</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFLNK</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_SYMLINK</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFIFO</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_FIFO</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFSOCK</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_SOCKET</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFBLK</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_BLOCK_DEV</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">S_IFCHR</span>:
		<span class="k">return</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_TYPE_IS_CHAR_DEV</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span> <span class="cm">/* This should not happen. */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_header - Get header line of audit log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r: Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns string representation.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses kmalloc(), so caller must kfree() if this function</span>
<span class="cm"> * didn&#39;t return NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_print_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_time</span> <span class="n">stamp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">pid_t</span> <span class="n">gpid</span> <span class="o">=</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tomoyo_obj_info</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">tomoyo_buffer_len</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tomoyo_buffer_len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="n">tomoyo_convert_time</span><span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stamp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="s">&quot;#%04u/%02u/%02u %02u:%02u:%02u# profile=%u mode=%s &quot;</span>
		       <span class="s">&quot;granted=%s (global-pid=%u) task={ pid=%u ppid=%u &quot;</span>
		       <span class="s">&quot;uid=%u gid=%u euid=%u egid=%u suid=%u sgid=%u &quot;</span>
		       <span class="s">&quot;fsuid=%u fsgid=%u }&quot;</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">month</span><span class="p">,</span>
		       <span class="n">stamp</span><span class="p">.</span><span class="n">day</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">sec</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span>
		       <span class="n">tomoyo_mode</span><span class="p">[</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">],</span> <span class="n">tomoyo_yesno</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">),</span> <span class="n">gpid</span><span class="p">,</span>
		       <span class="n">tomoyo_sys_getpid</span><span class="p">(),</span> <span class="n">tomoyo_sys_getppid</span><span class="p">(),</span>
		       <span class="n">current_uid</span><span class="p">(),</span> <span class="n">current_gid</span><span class="p">(),</span> <span class="n">current_euid</span><span class="p">(),</span>
		       <span class="n">current_egid</span><span class="p">(),</span> <span class="n">current_suid</span><span class="p">(),</span> <span class="n">current_sgid</span><span class="p">(),</span>
		       <span class="n">current_fsuid</span><span class="p">(),</span> <span class="n">current_fsgid</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_obj_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">validate_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_get_attributes</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">validate_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PATH_STAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_mini_stat</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat_valid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
					<span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot; path%u.parent={ uid=%u gid=%u &quot;</span>
					<span class="s">&quot;ino=%lu perm=0%o }&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">stat</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
				<span class="s">&quot; path%u={ uid=%u gid=%u ino=%lu major=%u&quot;</span>
				<span class="s">&quot; minor=%u perm=0%o type=%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
				<span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">,</span> <span class="n">tomoyo_filetype</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
					<span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot; dev_major=%u dev_minor=%u&quot;</span><span class="p">,</span>
					<span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
				<span class="s">&quot; }&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">no_obj_info:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">tomoyo_buffer_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_init_log - Allocate buffer for audit logs.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:    Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @len:  Buffer size needed for @fmt and @args.</span>
<span class="cm"> * @fmt:  The printf()&#39;s format string.</span>
<span class="cm"> * @args: va_list structure for @fmt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to allocated memory.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses kzalloc(), so caller must kfree() if this function</span>
<span class="cm"> * didn&#39;t return NULL.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_init_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		      <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bprm_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">realpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">domainname</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">header</span> <span class="o">=</span> <span class="n">tomoyo_print_header</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* +10 is for &#39;\n&#39; etc. and &#39;\0&#39;. */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">domainname</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
		<span class="n">realpath</span> <span class="o">=</span> <span class="n">tomoyo_realpath_from_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">);</span>
		<span class="n">bprm_info</span> <span class="o">=</span> <span class="n">tomoyo_print_bprm</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">realpath</span> <span class="o">||</span> <span class="o">!</span><span class="n">bprm_info</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="cm">/* +80 is for &quot; exec={ realpath=\&quot;%s\&quot; argc=%d envc=%d %s }&quot; */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">realpath</span><span class="p">)</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bprm_info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">symlink_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">symlink</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">symlink_target</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="cm">/* +18 is for &quot; symlink.target=\&quot;%s\&quot;&quot; */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">18</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">symlink</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">tomoyo_round2</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">bprm</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
				<span class="s">&quot; exec={ realpath=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> argc=%d envc=%d %s }&quot;</span><span class="p">,</span>
				<span class="n">realpath</span><span class="p">,</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">,</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">,</span> <span class="n">bprm_info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot; symlink.target=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">symlink</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domainname</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">realpath</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bprm_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait queue for /sys/kernel/security/tomoyo/audit. */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">tomoyo_log_wait</span><span class="p">);</span>

<span class="cm">/* Structure for audit log. */</span>
<span class="k">struct</span> <span class="n">tomoyo_log</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">log</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The list for &quot;struct tomoyo_log&quot;. */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tomoyo_log</span><span class="p">);</span>

<span class="cm">/* Lock for &quot;struct list_head tomoyo_log&quot;. */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">tomoyo_log_lock</span><span class="p">);</span>

<span class="cm">/* Length of &quot;stuct list_head tomoyo_log&quot;. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tomoyo_log_count</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_audit - Get audit mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns:          Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> * @profile:     Profile number.</span>
<span class="cm"> * @index:       Index number of functionality.</span>
<span class="cm"> * @is_granted:  True if granted log, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if this request should be audited, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_get_audit</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="n">profile</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">matched_acl</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">bool</span> <span class="n">is_granted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">category</span> <span class="o">=</span> <span class="n">tomoyo_index2category</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TOMOYO_MAX_MAC_INDEX</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_policy_loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">tomoyo_profile</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_log_count</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pref</span><span class="p">[</span><span class="n">TOMOYO_PREF_MAX_AUDIT_LOG</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_granted</span> <span class="o">&amp;&amp;</span> <span class="n">matched_acl</span> <span class="o">&amp;&amp;</span> <span class="n">matched_acl</span><span class="o">-&gt;</span><span class="n">cond</span> <span class="o">&amp;&amp;</span>
	    <span class="n">matched_acl</span><span class="o">-&gt;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">!=</span> <span class="n">TOMOYO_GRANTLOG_AUTO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">matched_acl</span><span class="o">-&gt;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">==</span> <span class="n">TOMOYO_GRANTLOG_YES</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">category</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">default_config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_granted</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">TOMOYO_CONFIG_WANT_GRANT_LOG</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">TOMOYO_CONFIG_WANT_REJECT_LOG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_log2 - Write an audit log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:    Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @len:  Buffer size needed for @fmt and @args.</span>
<span class="cm"> * @fmt:  The printf()&#39;s format string.</span>
<span class="cm"> * @args: va_list structure for @fmt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_write_log2</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		       <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_log</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">quota_exceeded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_get_audit</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			      <span class="n">r</span><span class="o">-&gt;</span><span class="n">matched_acl</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">tomoyo_init_log</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">tomoyo_round2</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The entry-&gt;size is used for memory quota checks.</span>
<span class="cm">	 * Don&#39;t go beyond strlen(entry-&gt;log).</span>
<span class="cm">	 */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">tomoyo_round2</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">));</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">]</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span>
	    <span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">quota_exceeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">]</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_log</span><span class="p">);</span>
		<span class="n">tomoyo_log_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quota_exceeded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log_wait</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_log - Write an audit log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:   Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @fmt: The printf()&#39;s format string, followed by parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_write_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">tomoyo_write_log2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_log - Read an audit log.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_read_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_log</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tomoyo_log</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">tomoyo_log_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_log_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_poll_log - Wait for an audit log.</span>
<span class="cm"> *</span>
<span class="cm"> * @file: Pointer to &quot;struct file&quot;.</span>
<span class="cm"> * @wait: Pointer to &quot;poll_table&quot;. Maybe NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns POLLIN | POLLRDNORM when ready to read an audit log.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tomoyo_poll_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_log_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_log_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_log_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
