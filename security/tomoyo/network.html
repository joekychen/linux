<!DOCTYPE html>
<html><head><title>joekychen/linux » security › tomoyo › network.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>network.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * security/tomoyo/network.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2011  NTT DATA CORPORATION</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/* Structure for holding inet domain socket&#39;s address. */</span>
<span class="k">struct</span> <span class="n">tomoyo_inet_addr_info</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>           <span class="cm">/* In network byte order. */</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">address</span><span class="p">;</span> <span class="cm">/* In network byte order. */</span>
	<span class="n">bool</span> <span class="n">is_ipv6</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Structure for holding unix domain socket&#39;s address. */</span>
<span class="k">struct</span> <span class="n">tomoyo_unix_addr_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span> <span class="cm">/* This may not be &#39;\0&#39; terminated string. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Structure for holding socket address. */</span>
<span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">operation</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_inet_addr_info</span> <span class="n">inet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_unix_addr_info</span> <span class="n">unix0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* String table for socket&#39;s protocols. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_proto_keyword</span><span class="p">[</span><span class="n">TOMOYO_SOCK_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SOCK_STREAM</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;stream&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SOCK_DGRAM</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;dgram&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SOCK_RAW</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SOCK_SEQPACKET</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;seqpacket&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="cm">/* Dummy for avoiding NULL pointer dereference. */</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="cm">/* Dummy for avoiding NULL pointer dereference. */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_ipaddr_union - Parse an IP address.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> * @ptr:   Pointer to &quot;struct tomoyo_ipaddr_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_parse_ipaddr_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tomoyo_ipaddr_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="k">const</span> <span class="n">min</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="k">const</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">in4_pton</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_ipv6</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">end</span><span class="p">)</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span>
			 <span class="n">in4_pton</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in6_pton</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_ipv6</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">end</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span>
			 <span class="n">in6_pton</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_ipv4 - Print an IPv4 address.</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer:     Buffer to write to.</span>
<span class="cm"> * @buffer_len: Size of @buffer.</span>
<span class="cm"> * @min_ip:     Pointer to __be32.</span>
<span class="cm"> * @max_ip:     Pointer to __be32.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_ipv4</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">min_ip</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">max_ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;%pI4%c%pI4&quot;</span><span class="p">,</span> <span class="n">min_ip</span><span class="p">,</span>
		 <span class="o">*</span><span class="n">min_ip</span> <span class="o">==</span> <span class="o">*</span><span class="n">max_ip</span> <span class="o">?</span> <span class="sc">&#39;\0&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="n">max_ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_ipv6 - Print an IPv6 address.</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer:     Buffer to write to.</span>
<span class="cm"> * @buffer_len: Size of @buffer.</span>
<span class="cm"> * @min_ip:     Pointer to &quot;struct in6_addr&quot;.</span>
<span class="cm"> * @max_ip:     Pointer to &quot;struct in6_addr&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_ipv6</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">min_ip</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">max_ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;%pI6c%c%pI6c&quot;</span><span class="p">,</span> <span class="n">min_ip</span><span class="p">,</span>
		 <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">min_ip</span><span class="p">,</span> <span class="n">max_ip</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;\0&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="n">max_ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_ip - Print an IP address.</span>
<span class="cm"> *</span>
<span class="cm"> * @buf:  Buffer to write to.</span>
<span class="cm"> * @size: Size of @buf.</span>
<span class="cm"> * @ptr:  Pointer to &quot;struct ipaddr_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_print_ip</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_ipaddr_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_ipv6</span><span class="p">)</span>
		<span class="n">tomoyo_print_ipv6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">tomoyo_print_ipv4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mapping table from &quot;enum tomoyo_network_acl_index&quot; to</span>
<span class="cm"> * &quot;enum tomoyo_mac_index&quot; for inet domain socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tomoyo_inet2mac</span>
<span class="p">[</span><span class="n">TOMOYO_SOCK_MAX</span><span class="p">][</span><span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SOCK_STREAM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_LISTEN</span><span class="p">]</span>  <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_LISTEN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_CONNECT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_CONNECT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SOCK_DGRAM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_SEND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_SEND</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SOCK_RAW</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_INET_RAW_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_SEND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_INET_RAW_SEND</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Mapping table from &quot;enum tomoyo_network_acl_index&quot; to</span>
<span class="cm"> * &quot;enum tomoyo_mac_index&quot; for unix domain socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tomoyo_unix2mac</span>
<span class="p">[</span><span class="n">TOMOYO_SOCK_MAX</span><span class="p">][</span><span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SOCK_STREAM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_LISTEN</span><span class="p">]</span>  <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_LISTEN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_CONNECT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_CONNECT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SOCK_DGRAM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_SEND</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_SEND</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SOCK_SEQPACKET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_BIND</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_LISTEN</span><span class="p">]</span>  <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_LISTEN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">TOMOYO_NETWORK_CONNECT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_CONNECT</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_same_inet_acl - Check for duplicated &quot;struct tomoyo_inet_acl&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @b: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a == @b except permission bits, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_same_inet_acl</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">p2</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		<span class="n">tomoyo_same_ipaddr_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">tomoyo_same_number_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_same_unix_acl - Check for duplicated &quot;struct tomoyo_unix_acl&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @b: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a == @b except permission bits, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_same_unix_acl</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">p2</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		<span class="n">tomoyo_same_name_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_merge_inet_acl - Merge duplicated &quot;struct tomoyo_inet_acl&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a:         Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @b:         Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @is_delete: True for @a &amp;= ~@b, false for @a |= @b.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a is empty, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_merge_inet_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="k">const</span> <span class="n">a_perm</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="o">*</span><span class="n">a_perm</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">b_perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_delete</span><span class="p">)</span>
		<span class="n">perm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">b_perm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">perm</span> <span class="o">|=</span> <span class="n">b_perm</span><span class="p">;</span>
	<span class="o">*</span><span class="n">a_perm</span> <span class="o">=</span> <span class="n">perm</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">perm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_merge_unix_acl - Merge duplicated &quot;struct tomoyo_unix_acl&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a:         Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @b:         Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @is_delete: True for @a &amp;= ~@b, false for @a |= @b.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a is empty, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_merge_unix_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="k">const</span> <span class="n">a_perm</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="o">*</span><span class="n">a_perm</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">b_perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_delete</span><span class="p">)</span>
		<span class="n">perm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">b_perm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">perm</span> <span class="o">|=</span> <span class="n">b_perm</span><span class="p">;</span>
	<span class="o">*</span><span class="n">a_perm</span> <span class="o">=</span> <span class="n">perm</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">perm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_inet_network - Write &quot;struct tomoyo_inet_acl&quot; list.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_write_inet_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_inet_acl</span> <span class="n">e</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_TYPE_INET_ACL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">&lt;</span> <span class="n">TOMOYO_SOCK_MAX</span><span class="p">;</span> <span class="n">e</span><span class="p">.</span><span class="n">protocol</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">tomoyo_proto_keyword</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_permstr</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">type</span><span class="p">]))</span>
			<span class="n">e</span><span class="p">.</span><span class="n">perm</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">TOMOYO_SOCK_MAX</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="p">.</span><span class="n">perm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">group</span> <span class="o">=</span>
			<span class="n">tomoyo_get_group</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">TOMOYO_ADDRESS_GROUP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_ipaddr_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_number_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">e</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_update_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">param</span><span class="p">,</span>
				     <span class="n">tomoyo_same_inet_acl</span><span class="p">,</span>
				     <span class="n">tomoyo_merge_inet_acl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">tomoyo_put_group</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="p">);</span>
	<span class="n">tomoyo_put_number_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_unix_network - Write &quot;struct tomoyo_unix_acl&quot; list.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_write_unix_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_unix_acl</span> <span class="n">e</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_TYPE_UNIX_ACL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">&lt;</span> <span class="n">TOMOYO_SOCK_MAX</span><span class="p">;</span> <span class="n">e</span><span class="p">.</span><span class="n">protocol</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">tomoyo_proto_keyword</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_permstr</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">type</span><span class="p">]))</span>
			<span class="n">e</span><span class="p">.</span><span class="n">perm</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">TOMOYO_SOCK_MAX</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="p">.</span><span class="n">perm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_parse_name_union</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_update_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">param</span><span class="p">,</span>
				     <span class="n">tomoyo_same_unix_acl</span><span class="p">,</span>
				     <span class="n">tomoyo_merge_unix_acl</span><span class="p">);</span>
	<span class="n">tomoyo_put_name_union</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_audit_net_log - Audit network log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:         Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @family:    Name of socket family (&quot;inet&quot; or &quot;unix&quot;).</span>
<span class="cm"> * @protocol:  Name of protocol in @family.</span>
<span class="cm"> * @operation: Name of socket operation.</span>
<span class="cm"> * @address:   Name of address.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_audit_net_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">family</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">protocol</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">operation</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tomoyo_supervisor</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;network %s %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span>
				 <span class="n">tomoyo_proto_keyword</span><span class="p">[</span><span class="n">protocol</span><span class="p">],</span>
				 <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">operation</span><span class="p">],</span> <span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_audit_inet_log - Audit INET network log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r: Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_audit_inet_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">is_ipv6</span><span class="p">)</span>
		<span class="n">tomoyo_print_ipv6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span>
				  <span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tomoyo_print_ipv4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">address</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %u&quot;</span><span class="p">,</span>
		 <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_audit_net_log</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;inet&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
				    <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_audit_unix_log - Audit UNIX network log.</span>
<span class="cm"> *</span>
<span class="cm"> * @r: Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_audit_unix_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tomoyo_audit_net_log</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;unix&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
				    <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">operation</span><span class="p">,</span>
				    <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_check_inet_acl - Check permission for inet domain socket operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:   Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @ptr: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if granted, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_check_inet_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">is_ipv6</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">operation</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tomoyo_compare_number_union</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_address_matches_group</span>
			<span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">is_ipv6</span><span class="p">,</span>
			 <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">is_ipv6</span> <span class="o">==</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">is_ipv6</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_check_unix_acl - Check permission for unix domain socket operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:   Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @ptr: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if granted, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_check_unix_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">operation</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">tomoyo_compare_name_union</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_inet_entry - Check permission for INET network operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @address: Pointer to &quot;struct tomoyo_addr_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_inet_entry</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">tomoyo_inet2mac</span><span class="p">[</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">][</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_init_request_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">TOMOYO_CONFIG_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param_type</span> <span class="o">=</span> <span class="n">TOMOYO_TYPE_INET_ACL</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">is_ipv6</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">inet</span><span class="p">.</span><span class="n">is_ipv6</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">inet</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">inet_network</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">inet</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">tomoyo_check_acl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">tomoyo_check_inet_acl</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_audit_inet_log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">TOMOYO_RETRY_REQUEST</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_check_inet_address - Check permission for inet domain socket&#39;s operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @addr:     Pointer to &quot;struct sockaddr&quot;.</span>
<span class="cm"> * @addr_len: Size of @addr.</span>
<span class="cm"> * @port:     Port number.</span>
<span class="cm"> * @address:  Pointer to &quot;struct tomoyo_addr_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_check_inet_address</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u16</span> <span class="n">port</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_inet_addr_info</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">inet</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&lt;</span> <span class="n">SIN6_LEN_RFC2133</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">is_ipv6</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">is_ipv6</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">SOCK_RAW</span><span class="p">)</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_inet_entry</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="nl">skip:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_unix_entry - Check permission for UNIX network operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @address: Pointer to &quot;struct tomoyo_addr_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_unix_entry</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">tomoyo_unix2mac</span><span class="p">[</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">][</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_init_request_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">TOMOYO_CONFIG_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">unix0</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">unix0</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa_family_t</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;anonymous&quot;</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">tomoyo_encode2</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">addr</span><span class="p">;</span>

			<span class="n">addr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">r</span><span class="p">.</span><span class="n">param_type</span> <span class="o">=</span> <span class="n">TOMOYO_TYPE_UNIX_ACL</span><span class="p">;</span>
			<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>
			<span class="n">r</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">unix_network</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">tomoyo_check_acl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">tomoyo_check_unix_acl</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_audit_unix_log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">TOMOYO_RETRY_REQUEST</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_check_unix_address - Check permission for unix domain socket&#39;s operation.</span>
<span class="cm"> *</span>
<span class="cm"> * @addr:     Pointer to &quot;struct sockaddr&quot;.</span>
<span class="cm"> * @addr_len: Size of @addr.</span>
<span class="cm"> * @address:  Pointer to &quot;struct tomoyo_addr_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_check_unix_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_unix_addr_info</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">unix0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">AF_UNIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">addr_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tomoyo_unix_entry</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_kernel_service - Check whether I&#39;m kernel service or not.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if I&#39;m kernel service, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_kernel_service</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do if I am a kernel service. */</span>
	<span class="k">return</span> <span class="n">segment_eq</span><span class="p">(</span><span class="n">get_fs</span><span class="p">(),</span> <span class="n">KERNEL_DS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_sock_family - Get socket&#39;s family.</span>
<span class="cm"> *</span>
<span class="cm"> * @sk: Pointer to &quot;struct sock&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns one of PF_INET, PF_INET6, PF_UNIX or 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">tomoyo_sock_family</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">family</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_kernel_service</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">family</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PF_INET</span>:
	<span class="k">case</span> <span class="n">PF_INET6</span>:
	<span class="k">case</span> <span class="n">PF_UNIX</span>:
		<span class="k">return</span> <span class="n">family</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_socket_listen_permission - Check permission for listening a socket.</span>
<span class="cm"> *</span>
<span class="cm"> * @sock: Pointer to &quot;struct socket&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_socket_listen_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">family</span> <span class="o">=</span> <span class="n">tomoyo_sock_family</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span> <span class="o">||</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">getname</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
						     <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">address</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">address</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">TOMOYO_NETWORK_LISTEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_UNIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_check_unix_address</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
						 <span class="n">addr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_check_inet_address</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_socket_connect_permission - Check permission for setting the remote address of a socket.</span>
<span class="cm"> *</span>
<span class="cm"> * @sock:     Pointer to &quot;struct socket&quot;.</span>
<span class="cm"> * @addr:     Pointer to &quot;struct sockaddr&quot;.</span>
<span class="cm"> * @addr_len: Size of @addr.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_socket_connect_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">family</span> <span class="o">=</span> <span class="n">tomoyo_sock_family</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">address</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOCK_DGRAM</span>:
	<span class="k">case</span> <span class="n">SOCK_RAW</span>:
		<span class="n">address</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">TOMOYO_NETWORK_SEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOCK_STREAM</span>:
	<span class="k">case</span> <span class="n">SOCK_SEQPACKET</span>:
		<span class="n">address</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">TOMOYO_NETWORK_CONNECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_UNIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_check_unix_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_check_inet_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_socket_bind_permission - Check permission for setting the local address of a socket.</span>
<span class="cm"> *</span>
<span class="cm"> * @sock:     Pointer to &quot;struct socket&quot;.</span>
<span class="cm"> * @addr:     Pointer to &quot;struct sockaddr&quot;.</span>
<span class="cm"> * @addr_len: Size of @addr.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_socket_bind_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">family</span> <span class="o">=</span> <span class="n">tomoyo_sock_family</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOCK_STREAM</span>:
	<span class="k">case</span> <span class="n">SOCK_DGRAM</span>:
	<span class="k">case</span> <span class="n">SOCK_RAW</span>:
	<span class="k">case</span> <span class="n">SOCK_SEQPACKET</span>:
		<span class="n">address</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">address</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">TOMOYO_NETWORK_BIND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_UNIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_check_unix_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_check_inet_address</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_socket_sendmsg_permission - Check permission for sending a datagram.</span>
<span class="cm"> *</span>
<span class="cm"> * @sock: Pointer to &quot;struct socket&quot;.</span>
<span class="cm"> * @msg:  Pointer to &quot;struct msghdr&quot;.</span>
<span class="cm"> * @size: Unused.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_socket_sendmsg_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_addr_info</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">family</span> <span class="o">=</span> <span class="n">tomoyo_sock_family</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span> <span class="o">||</span> <span class="o">!</span><span class="n">family</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_DGRAM</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_RAW</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">address</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">address</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">TOMOYO_NETWORK_SEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_UNIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tomoyo_check_unix_address</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
						 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span>
						 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tomoyo_check_inet_address</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span>
					 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">,</span>
					 <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
