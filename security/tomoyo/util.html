<!DOCTYPE html>
<html><head><title>joekychen/linux » security › tomoyo › util.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>util.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * security/tomoyo/util.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2011  NTT DATA CORPORATION</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;common.h&quot;</span>

<span class="cm">/* Lock for protecting policy. */</span>
<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">tomoyo_policy_lock</span><span class="p">);</span>

<span class="cm">/* Has /sbin/init started? */</span>
<span class="n">bool</span> <span class="n">tomoyo_policy_loaded</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Mapping table from &quot;enum tomoyo_mac_index&quot; to</span>
<span class="cm"> * &quot;enum tomoyo_mac_category_index&quot;.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="n">u8</span> <span class="n">tomoyo_index2category</span><span class="p">[</span><span class="n">TOMOYO_MAX_MAC_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* CONFIG::file group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_EXECUTE</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_OPEN</span><span class="p">]</span>       <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CREATE</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_UNLINK</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_GETATTR</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKDIR</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_RMDIR</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKFIFO</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKSOCK</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_TRUNCATE</span><span class="p">]</span>   <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_SYMLINK</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKBLOCK</span><span class="p">]</span>    <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKCHAR</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_LINK</span><span class="p">]</span>       <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_RENAME</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHMOD</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHOWN</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHGRP</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_IOCTL</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHROOT</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MOUNT</span><span class="p">]</span>      <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_UMOUNT</span><span class="p">]</span>     <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_PIVOT_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">,</span>
	<span class="cm">/* CONFIG::network group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_BIND</span><span class="p">]</span>       <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_LISTEN</span><span class="p">]</span>     <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_CONNECT</span><span class="p">]</span>    <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_BIND</span><span class="p">]</span>        <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_SEND</span><span class="p">]</span>        <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_RAW_BIND</span><span class="p">]</span>          <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_RAW_SEND</span><span class="p">]</span>          <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_BIND</span><span class="p">]</span>       <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_LISTEN</span><span class="p">]</span>     <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_CONNECT</span><span class="p">]</span>    <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_BIND</span><span class="p">]</span>        <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_SEND</span><span class="p">]</span>        <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_BIND</span><span class="p">]</span>    <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_LISTEN</span><span class="p">]</span>  <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_CONNECT</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">,</span>
	<span class="cm">/* CONFIG::misc group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_ENVIRON</span><span class="p">]</span>         <span class="o">=</span> <span class="n">TOMOYO_MAC_CATEGORY_MISC</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_convert_time - Convert time_t to YYYY/MM/DD hh/mm/ss.</span>
<span class="cm"> *</span>
<span class="cm"> * @time:  Seconds since 1970/01/01 00:00:00.</span>
<span class="cm"> * @stamp: Pointer to &quot;struct tomoyo_time&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> *</span>
<span class="cm"> * This function does not handle Y2038 problem.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_convert_time</span><span class="p">(</span><span class="kt">time_t</span> <span class="n">time</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_time</span> <span class="o">*</span><span class="n">stamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">tomoyo_eom</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">334</span><span class="p">,</span> <span class="mi">365</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">366</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u16</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">sec</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">time</span> <span class="o">/=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">time</span> <span class="o">/=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">hour</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">time</span> <span class="o">/=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1970</span><span class="p">;</span> <span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">365</span> <span class="o">:</span> <span class="mi">366</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">days</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">time</span> <span class="o">-=</span> <span class="n">days</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">tomoyo_eom</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">m</span><span class="p">];</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>
		<span class="n">time</span> <span class="o">-=</span> <span class="n">tomoyo_eom</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">year</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">month</span> <span class="o">=</span> <span class="o">++</span><span class="n">m</span><span class="p">;</span>
	<span class="n">stamp</span><span class="o">-&gt;</span><span class="n">day</span> <span class="o">=</span> <span class="o">++</span><span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_permstr - Find permission keywords.</span>
<span class="cm"> *</span>
<span class="cm"> * @string: String representation for permissions in foo/bar/buz format.</span>
<span class="cm"> * @keyword: Keyword to find from @string/</span>
<span class="cm"> *</span>
<span class="cm"> * Returns ture if @keyword was found in @string, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * This function assumes that strncmp(w1, w2, strlen(w1)) != 0 if w1 != w2.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_permstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">keyword</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cp</span> <span class="o">==</span> <span class="n">string</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_token - Read a word from a line.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a word on success, &quot;&quot; otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * To allow the caller to skip NULL check, this function returns &quot;&quot; rather than</span>
<span class="cm"> * NULL if there is no more words to read.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_read_token</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">del</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">)</span>
		<span class="o">*</span><span class="n">del</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">del</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">del</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_domainname - Read a domainname from a line.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a domainname on success, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="nf">tomoyo_get_domainname</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_correct_domain</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_ulong - Parse an &quot;unsigned long&quot; value.</span>
<span class="cm"> *</span>
<span class="cm"> * @result: Pointer to &quot;unsigned long&quot;.</span>
<span class="cm"> * @str:    Pointer to string to parse.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns one of values in &quot;enum tomoyo_value_type&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * The @src is updated to point the first character after the value</span>
<span class="cm"> * on success.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">tomoyo_parse_ulong</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;7&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TOMOYO_VALUE_TYPE_INVALID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">return</span> <span class="n">TOMOYO_VALUE_TYPE_HEXADECIMAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">TOMOYO_VALUE_TYPE_OCTAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">TOMOYO_VALUE_TYPE_DECIMAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_ulong - Print an &quot;unsigned long&quot; value.</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer:     Pointer to buffer.</span>
<span class="cm"> * @buffer_len: Size of @buffer.</span>
<span class="cm"> * @value:      An &quot;unsigned long&quot; value.</span>
<span class="cm"> * @type:       Type of @value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_print_ulong</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_VALUE_TYPE_DECIMAL</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_VALUE_TYPE_OCTAL</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;0%lo&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_VALUE_TYPE_HEXADECIMAL</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;0x%lX&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="s">&quot;type(%u)&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_name_union - Parse a tomoyo_name_union.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> * @ptr:   Pointer to &quot;struct tomoyo_name_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_parse_name_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">tomoyo_get_group</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">TOMOYO_PATH_GROUP</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">filename</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_correct_word</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_number_union - Parse a tomoyo_number_union.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> * @ptr:   Pointer to &quot;struct tomoyo_number_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_parse_number_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">tomoyo_get_group</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">TOMOYO_NUMBER_GROUP</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">tomoyo_read_token</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">tomoyo_parse_ulong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_VALUE_TYPE_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">value_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">value_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">tomoyo_parse_ulong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_VALUE_TYPE_INVALID</span> <span class="o">||</span> <span class="o">*</span><span class="n">data</span> <span class="o">||</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">value_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_byte_range - Check whether the string is a \ooo style octal value.</span>
<span class="cm"> *</span>
<span class="cm"> * @str: Pointer to the string.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @str is a \ooo style octal value, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * TOMOYO uses \ooo style representation for 0x01 - 0x20 and 0x7F - 0xFF.</span>
<span class="cm"> * This function verifies that \ooo is in valid range.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_byte_range</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">str</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="sc">&#39;3&#39;</span> <span class="o">&amp;&amp;</span>
		<span class="o">*</span><span class="n">str</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="sc">&#39;7&#39;</span> <span class="o">&amp;&amp;</span>
		<span class="o">*</span><span class="n">str</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span> <span class="o">&lt;=</span> <span class="sc">&#39;7&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_alphabet_char - Check whether the character is an alphabet.</span>
<span class="cm"> *</span>
<span class="cm"> * @c: The character to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @c is an alphabet character, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_alphabet_char</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_make_byte - Make byte value from three octal characters.</span>
<span class="cm"> *</span>
<span class="cm"> * @c1: The first character.</span>
<span class="cm"> * @c2: The second character.</span>
<span class="cm"> * @c3: The third character.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns byte value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">tomoyo_make_byte</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">c1</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">c2</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">c3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">c1</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">c2</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c3</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_valid - Check whether the character is a valid char.</span>
<span class="cm"> *</span>
<span class="cm"> * @c: The character to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @c is a valid character, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_valid</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_invalid - Check whether the character is an invalid char.</span>
<span class="cm"> *</span>
<span class="cm"> * @c: The character to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @c is an invalid character, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_invalid</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">127</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_str_starts - Check whether the given string starts with the given keyword.</span>
<span class="cm"> *</span>
<span class="cm"> * @src:  Pointer to pointer to the string.</span>
<span class="cm"> * @find: Pointer to the keyword.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @src starts with @find, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * The @src is updated to point the first character after the @find</span>
<span class="cm"> * if @src starts with @find.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_str_starts</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">find</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">find</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_normalize_line - Format string.</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer: The line to normalize.</span>
<span class="cm"> *</span>
<span class="cm"> * Leading and trailing whitespaces are removed.</span>
<span class="cm"> * Multiple whitespaces are packed into single space.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_normalize_line</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tomoyo_invalid</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">))</span>
		<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tomoyo_valid</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">))</span>
			<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">sp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tomoyo_invalid</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">))</span>
			<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_correct_word2 - Validate a string.</span>
<span class="cm"> *</span>
<span class="cm"> * @string: The string to check. Maybe non-&#39;\0&#39;-terminated.</span>
<span class="cm"> * @len:    Length of @string.</span>
<span class="cm"> *</span>
<span class="cm"> * Check whether the given string follows the naming rules.</span>
<span class="cm"> * Returns true if @string follows the naming rules, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_correct_word2</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">start</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_repetition</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;\\&#39;</span>:  <span class="cm">/* &quot;\\&quot; */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;$&#39;</span>:   <span class="cm">/* &quot;\$&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:   <span class="cm">/* &quot;\+&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:   <span class="cm">/* &quot;\?&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;*&#39;</span>:   <span class="cm">/* &quot;\*&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:   <span class="cm">/* &quot;\@&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:   <span class="cm">/* &quot;\x&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:   <span class="cm">/* &quot;\X&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:   <span class="cm">/* &quot;\a&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;A&#39;</span>:   <span class="cm">/* &quot;\A&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:   <span class="cm">/* &quot;\-&quot; */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;{&#39;</span>:   <span class="cm">/* &quot;/\{&quot; */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">string</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">in_repetition</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;}&#39;</span>:   <span class="cm">/* &quot;\}/&quot; */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">string</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_repetition</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">in_repetition</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:   <span class="cm">/* &quot;\ooo&quot; */</span>
			<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="o">--</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="o">++</span><span class="p">;</span>
				<span class="n">e</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="sc">&#39;7&#39;</span> <span class="o">||</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="sc">&#39;7&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">tomoyo_make_byte</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">127</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in_repetition</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_repetition</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_correct_word - Validate a string.</span>
<span class="cm"> *</span>
<span class="cm"> * @string: The string to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Check whether the given string follows the naming rules.</span>
<span class="cm"> * Returns true if @string follows the naming rules, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_correct_word</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tomoyo_correct_word2</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_correct_path - Validate a pathname.</span>
<span class="cm"> *</span>
<span class="cm"> * @filename: The pathname to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Check whether the given pathname follows the naming rules.</span>
<span class="cm"> * Returns true if @filename follows the naming rules, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_correct_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">filename</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_correct_word</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_correct_domain - Check whether the given domainname follows the naming rules.</span>
<span class="cm"> *</span>
<span class="cm"> * @domainname: The domainname to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @domainname follows the naming rules, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_correct_domain</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">domainname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domainname</span> <span class="o">||</span> <span class="o">!</span><span class="n">tomoyo_domain_def</span><span class="p">(</span><span class="n">domainname</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">domainname</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">domainname</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domainname</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">domainname</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">domainname</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">tomoyo_correct_word2</span><span class="p">(</span><span class="n">domainname</span><span class="p">,</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">domainname</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">domainname</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tomoyo_correct_path</span><span class="p">(</span><span class="n">domainname</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_domain_def - Check whether the given token can be a domainname.</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer: The token to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @buffer possibly be a domainname, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_domain_def</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">!=</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tomoyo_correct_word2</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_find_domain - Find a domain by the given name.</span>
<span class="cm"> *</span>
<span class="cm"> * @domainname: The domainname to find.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_domain_info&quot; if found, NULL otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="nf">tomoyo_find_domain</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">domainname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">name</span><span class="p">;</span>

	<span class="n">name</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">domainname</span><span class="p">;</span>
	<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_domain_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">is_deleted</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tomoyo_pathcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">domain</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_const_part_length - Evaluate the initial length without a pattern in a token.</span>
<span class="cm"> *</span>
<span class="cm"> * @filename: The string to evaluate.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the initial length without a pattern in @filename.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_const_part_length</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">filename</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">filename</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\\&#39;</span>:  <span class="cm">/* &quot;\\&quot; */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:   <span class="cm">/* &quot;\ooo&quot; */</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">filename</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39;7&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">filename</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="sc">&#39;7&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_fill_path_info - Fill in &quot;struct tomoyo_path_info&quot; members.</span>
<span class="cm"> *</span>
<span class="cm"> * @ptr: Pointer to &quot;struct tomoyo_path_info&quot; to fill in.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller sets &quot;struct tomoyo_path_info&quot;-&gt;name.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_fill_path_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">const_len</span> <span class="o">=</span> <span class="n">tomoyo_const_part_length</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_dir</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_patterned</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">const_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">full_name_hash</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_file_matches_pattern2 - Pattern matching without &#39;/&#39; character and &quot;\-&quot; pattern.</span>
<span class="cm"> *</span>
<span class="cm"> * @filename:     The start of string to check.</span>
<span class="cm"> * @filename_end: The end of string to check.</span>
<span class="cm"> * @pattern:      The start of pattern to compare.</span>
<span class="cm"> * @pattern_end:  The end of pattern to compare.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @filename matches @pattern, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_file_matches_pattern2</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename_end</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">filename</span> <span class="o">&lt;</span> <span class="n">filename_end</span> <span class="o">&amp;&amp;</span> <span class="n">pattern</span> <span class="o">&lt;</span> <span class="n">pattern_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pattern</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">filename</span><span class="o">++</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pattern</span><span class="o">++</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
		<span class="n">pattern</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pattern</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
					<span class="n">filename</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_byte_range</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">filename</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\\&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*++</span><span class="n">filename</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_alphabet_char</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_byte_range</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">filename</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">pattern</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Not matched. */</span>
		<span class="k">case</span> <span class="sc">&#39;*&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">filename_end</span> <span class="o">-</span> <span class="n">filename</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_file_matches_pattern2</span><span class="p">(</span>
						    <span class="n">filename</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename_end</span><span class="p">,</span>
						    <span class="n">pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pattern_end</span><span class="p">))</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pattern</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_byte_range</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span> <span class="cm">/* Bad pattern. */</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Not matched. */</span>
		<span class="nl">default:</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">pattern</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">tomoyo_alphabet_char</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_file_matches_pattern2</span><span class="p">(</span>
						    <span class="n">filename</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename_end</span><span class="p">,</span>
						    <span class="n">pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pattern_end</span><span class="p">))</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Not matched or bad pattern. */</span>
		<span class="p">}</span>
		<span class="n">filename</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pattern</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">pattern</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">))</span>
		<span class="n">pattern</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">filename</span> <span class="o">==</span> <span class="n">filename_end</span> <span class="o">&amp;&amp;</span> <span class="n">pattern</span> <span class="o">==</span> <span class="n">pattern_end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_file_matches_pattern - Pattern matching without &#39;/&#39; character.</span>
<span class="cm"> *</span>
<span class="cm"> * @filename:     The start of string to check.</span>
<span class="cm"> * @filename_end: The end of string to check.</span>
<span class="cm"> * @pattern:      The start of pattern to compare.</span>
<span class="cm"> * @pattern_end:  The end of pattern to compare.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @filename matches @pattern, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_file_matches_pattern</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename_end</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern_start</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pattern</span> <span class="o">&lt;</span> <span class="n">pattern_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Split at &quot;\-&quot; pattern. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pattern</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">pattern</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">tomoyo_file_matches_pattern2</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
						      <span class="n">filename_end</span><span class="p">,</span>
						      <span class="n">pattern_start</span><span class="p">,</span>
						      <span class="n">pattern</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pattern_start</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">tomoyo_file_matches_pattern2</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename_end</span><span class="p">,</span>
					      <span class="n">pattern_start</span><span class="p">,</span> <span class="n">pattern_end</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">first</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_path_matches_pattern2 - Do pathname pattern matching.</span>
<span class="cm"> *</span>
<span class="cm"> * @f: The start of string to check.</span>
<span class="cm"> * @p: The start of pattern to compare.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @f matches @p, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_path_matches_pattern2</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f_delimiter</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p_delimiter</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f_delimiter</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f_delimiter</span><span class="p">)</span>
			<span class="n">f_delimiter</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="n">p_delimiter</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_delimiter</span><span class="p">)</span>
			<span class="n">p_delimiter</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">recursive</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_file_matches_pattern</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_delimiter</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
						 <span class="n">p_delimiter</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">f_delimiter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)</span>
			<span class="n">f</span><span class="o">++</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p_delimiter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Ignore trailing &quot;\*&quot; and &quot;\@&quot; in @pattern. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!*</span><span class="n">f</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">p</span><span class="p">;</span>
 <span class="nl">recursive:</span>
	<span class="cm">/*</span>
<span class="cm">	 * The &quot;\{&quot; pattern is permitted only after &#39;/&#39; character.</span>
<span class="cm">	 * This guarantees that below &quot;*(p - 1)&quot; is safe.</span>
<span class="cm">	 * Also, the &quot;\}&quot; pattern is permitted only before &#39;/&#39; character</span>
<span class="cm">	 * so that &quot;\{&quot; + &quot;\}&quot; pair will not break the &quot;\-&quot; operator.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="n">p_delimiter</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">||</span> <span class="o">*</span><span class="n">p_delimiter</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">p_delimiter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">p_delimiter</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Bad pattern. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Compare current component with pattern. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_file_matches_pattern</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_delimiter</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
						 <span class="n">p_delimiter</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Proceed to next component. */</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">f_delimiter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">f</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Continue comparison. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_path_matches_pattern2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p_delimiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">f_delimiter</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">f_delimiter</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Not matched. */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_path_matches_pattern - Check whether the given filename matches the given pattern.</span>
<span class="cm"> *</span>
<span class="cm"> * @filename: The filename to check.</span>
<span class="cm"> * @pattern:  The pattern to compare.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if matches, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * The following patterns are available.</span>
<span class="cm"> *   \\     \ itself.</span>
<span class="cm"> *   \ooo   Octal representation of a byte.</span>
<span class="cm"> *   \*     Zero or more repetitions of characters other than &#39;/&#39;.</span>
<span class="cm"> *   \@     Zero or more repetitions of characters other than &#39;/&#39; or &#39;.&#39;.</span>
<span class="cm"> *   \?     1 byte character other than &#39;/&#39;.</span>
<span class="cm"> *   \$     One or more repetitions of decimal digits.</span>
<span class="cm"> *   \+     1 decimal digit.</span>
<span class="cm"> *   \X     One or more repetitions of hexadecimal digits.</span>
<span class="cm"> *   \x     1 hexadecimal digit.</span>
<span class="cm"> *   \A     One or more repetitions of alphabet characters.</span>
<span class="cm"> *   \a     1 alphabet character.</span>
<span class="cm"> *</span>
<span class="cm"> *   \-     Subtraction operator.</span>
<span class="cm"> *</span>
<span class="cm"> *   /\{dir\}/   &#39;/&#39; + &#39;One or more repetitions of dir/&#39; (e.g. /dir/ /dir/dir/</span>
<span class="cm"> *               /dir/dir/dir/ ).</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_path_matches_pattern</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">filename</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">-&gt;</span><span class="n">const_len</span><span class="p">;</span>

	<span class="cm">/* If @pattern doesn&#39;t contain pattern, I can use strcmp(). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pattern</span><span class="o">-&gt;</span><span class="n">is_patterned</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">tomoyo_pathcmp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t compare directory and non-directory. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="o">-&gt;</span><span class="n">is_dir</span> <span class="o">!=</span> <span class="n">pattern</span><span class="o">-&gt;</span><span class="n">is_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Compare the initial length without patterns. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">f</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tomoyo_path_matches_pattern2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_exe - Get tomoyo_realpath() of current process.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the tomoyo_realpath() of current process on success, NULL otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses kzalloc(), so the caller must call kfree()</span>
<span class="cm"> * if this function didn&#39;t return NULL.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_get_exe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vma</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span> <span class="n">vma</span><span class="p">;</span> <span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_EXECUTABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">tomoyo_realpath_from_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_get_mode - Get MAC mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns:      Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> * @profile: Profile number.</span>
<span class="cm"> * @index:   Index number of functionality.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns mode.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_get_mode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">profile</span><span class="p">,</span>
		    <span class="k">const</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_policy_loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TOMOYO_CONFIG_DISABLED</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">tomoyo_profile</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">profile</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">tomoyo_index2category</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
				 <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">default_config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_init_request_info - Initialize &quot;struct tomoyo_request_info&quot; members.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:      Pointer to &quot;struct tomoyo_request_info&quot; to initialize.</span>
<span class="cm"> * @domain: Pointer to &quot;struct tomoyo_domain_info&quot;. NULL for tomoyo_domain().</span>
<span class="cm"> * @index:  Index number of functionality.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns mode.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_init_request_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">profile</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="p">)</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_domain</span><span class="p">();</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">profile</span> <span class="o">=</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">tomoyo_get_mode</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_domain_quota_is_ok - Check for domain&#39;s quota.</span>
<span class="cm"> *</span>
<span class="cm"> * @r: Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the domain is not exceeded quota, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tomoyo_domain_quota_is_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">TOMOYO_CONFIG_LEARNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">acl_info_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">perm</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_PATH_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_path_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
				<span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_PATH2_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_path2_acl</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
				<span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_PATH_NUMBER_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_path_number_acl</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_MKDEV_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_mkdev_acl</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_INET_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_inet_acl</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_UNIX_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_unix_acl</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_TYPE_MANUAL_TASK_ACL</span>:
			<span class="n">perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">perm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">tomoyo_profile</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">)</span><span class="o">-&gt;</span>
	    <span class="n">pref</span><span class="p">[</span><span class="n">TOMOYO_PREF_MAX_LEARNING_ENTRY</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">TOMOYO_DIF_QUOTA_WARNED</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">domain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">TOMOYO_DIF_QUOTA_WARNED</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* r-&gt;granted = false; */</span>
		<span class="n">tomoyo_write_log</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">tomoyo_dif</span><span class="p">[</span><span class="n">TOMOYO_DIF_QUOTA_WARNED</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;WARNING: &quot;</span>
		       <span class="s">&quot;Domain &#39;%s&#39; has too many ACLs to hold. &quot;</span>
		       <span class="s">&quot;Stopped learning mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
