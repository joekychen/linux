<!DOCTYPE html>
<html><head><title>joekychen/linux » security › tomoyo › common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * security/tomoyo/common.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2011  NTT DATA CORPORATION</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &quot;common.h&quot;</span>

<span class="cm">/* String table for operation mode. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_mode</span><span class="p">[</span><span class="n">TOMOYO_CONFIG_MAX_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_CONFIG_DISABLED</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_CONFIG_LEARNING</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;learning&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_CONFIG_PERMISSIVE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;permissive&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_CONFIG_ENFORCING</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;enforcing&quot;</span>
<span class="p">};</span>

<span class="cm">/* String table for /sys/kernel/security/tomoyo/profile */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_mac_keywords</span><span class="p">[</span><span class="n">TOMOYO_MAX_MAC_INDEX</span>
				       <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* CONFIG::file group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_EXECUTE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;execute&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_OPEN</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;open&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CREATE</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_UNLINK</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;unlink&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_GETATTR</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;getattr&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKDIR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;mkdir&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_RMDIR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;rmdir&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKFIFO</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;mkfifo&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKSOCK</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;mksock&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_TRUNCATE</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;truncate&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_SYMLINK</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;symlink&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKBLOCK</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;mkblock&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MKCHAR</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;mkchar&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_LINK</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;link&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_RENAME</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;rename&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHMOD</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;chmod&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHOWN</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;chown&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHGRP</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;chgrp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_IOCTL</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;ioctl&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_CHROOT</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;chroot&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_MOUNT</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;mount&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_UMOUNT</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;unmount&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_FILE_PIVOT_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;pivot_root&quot;</span><span class="p">,</span>
	<span class="cm">/* CONFIG::network group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_BIND</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;inet_stream_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_LISTEN</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;inet_stream_listen&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_STREAM_CONNECT</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;inet_stream_connect&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_BIND</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;inet_dgram_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_DGRAM_SEND</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;inet_dgram_send&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_RAW_BIND</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;inet_raw_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_INET_RAW_SEND</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;inet_raw_send&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_BIND</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;unix_stream_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_LISTEN</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;unix_stream_listen&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_STREAM_CONNECT</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;unix_stream_connect&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_BIND</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;unix_dgram_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_DGRAM_SEND</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;unix_dgram_send&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;unix_seqpacket_bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_LISTEN</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;unix_seqpacket_listen&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_NETWORK_UNIX_SEQPACKET_CONNECT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;unix_seqpacket_connect&quot;</span><span class="p">,</span>
	<span class="cm">/* CONFIG::misc group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_ENVIRON</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;env&quot;</span><span class="p">,</span>
	<span class="cm">/* CONFIG group */</span>
	<span class="p">[</span><span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;file&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAC_CATEGORY_MISC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;misc&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for conditions. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">TOMOYO_MAX_CONDITION_KEYWORD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_UID</span><span class="p">]</span>             <span class="o">=</span> <span class="s">&quot;task.uid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_EUID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;task.euid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_SUID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;task.suid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_FSUID</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;task.fsuid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_GID</span><span class="p">]</span>             <span class="o">=</span> <span class="s">&quot;task.gid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_EGID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;task.egid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_SGID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;task.sgid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_FSGID</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;task.fsgid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_PID</span><span class="p">]</span>             <span class="o">=</span> <span class="s">&quot;task.pid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TASK_PPID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;task.ppid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_EXEC_ARGC</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;exec.argc&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_EXEC_ENVC</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;exec.envc&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_SOCKET</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;socket&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_SYMLINK</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;symlink&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_FILE</span><span class="p">]</span>         <span class="o">=</span> <span class="s">&quot;file&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_BLOCK_DEV</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;block&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_DIRECTORY</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;directory&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_CHAR_DEV</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;char&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_IS_FIFO</span><span class="p">]</span>         <span class="o">=</span> <span class="s">&quot;fifo&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_SETUID</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;setuid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_SETGID</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;setgid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_STICKY</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;sticky&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OWNER_READ</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;owner_read&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OWNER_WRITE</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;owner_write&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OWNER_EXECUTE</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;owner_execute&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_GROUP_READ</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;group_read&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_GROUP_WRITE</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;group_write&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_GROUP_EXECUTE</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;group_execute&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OTHERS_READ</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;others_read&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OTHERS_WRITE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;others_write&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MODE_OTHERS_EXECUTE</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;others_execute&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_EXEC_REALPATH</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;exec.realpath&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_SYMLINK_TARGET</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;symlink.target&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_UID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path1.uid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_GID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path1.gid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_INO</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path1.ino&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_MAJOR</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;path1.major&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_MINOR</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;path1.minor&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_PERM</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;path1.perm&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_TYPE</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;path1.type&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_DEV_MAJOR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;path1.dev_major&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_DEV_MINOR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;path1.dev_minor&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_UID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path2.uid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_GID</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path2.gid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_INO</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&quot;path2.ino&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_MAJOR</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;path2.major&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_MINOR</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;path2.minor&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_PERM</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;path2.perm&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_TYPE</span><span class="p">]</span>           <span class="o">=</span> <span class="s">&quot;path2.type&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_DEV_MAJOR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;path2.dev_major&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_DEV_MINOR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;path2.dev_minor&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_PARENT_UID</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path1.parent.uid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_PARENT_GID</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path1.parent.gid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_PARENT_INO</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path1.parent.ino&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH1_PARENT_PERM</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;path1.parent.perm&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_PARENT_UID</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path2.parent.uid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_PARENT_GID</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path2.parent.gid&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_PARENT_INO</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;path2.parent.ino&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH2_PARENT_PERM</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;path2.parent.perm&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for PREFERENCE keyword. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_pref_keywords</span><span class="p">[</span><span class="n">TOMOYO_MAX_PREF</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_PREF_MAX_AUDIT_LOG</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;max_audit_log&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_PREF_MAX_LEARNING_ENTRY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;max_learning_entry&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for path operation. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_path_keyword</span><span class="p">[</span><span class="n">TOMOYO_MAX_PATH_OPERATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_EXECUTE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;execute&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_READ</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_WRITE</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_APPEND</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;append&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_UNLINK</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;unlink&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_GETATTR</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;getattr&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_RMDIR</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;rmdir&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_TRUNCATE</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;truncate&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_SYMLINK</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;symlink&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_CHROOT</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;chroot&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TYPE_UMOUNT</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;unmount&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for socket&#39;s operation. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_NETWORK_BIND</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;bind&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_NETWORK_LISTEN</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;listen&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_NETWORK_CONNECT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;connect&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_NETWORK_SEND</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;send&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for categories. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_category_keywords</span>
<span class="p">[</span><span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_CATEGORY_FILE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;file&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_CATEGORY_NETWORK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MAC_CATEGORY_MISC</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;misc&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Permit policy management by non-root user? */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tomoyo_manage_by_non_root</span><span class="p">;</span>

<span class="cm">/* Utility functions. */</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_yesno - Return &quot;yes&quot; or &quot;no&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * @value: Bool value.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tomoyo_yesno</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">value</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_addprintf - strncat()-like-snprintf().</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer: Buffer to write to. Must be &#39;\0&#39;-terminated.</span>
<span class="cm"> * @len:    Size of @buffer.</span>
<span class="cm"> * @fmt:    The printf()&#39;s format string, followed by parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_addprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_flush - Flush queued string to userspace&#39;s buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:   Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if all data was flushed, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* Add &#39;\0&#39; for audit logs and query. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span> <span class="o">||</span>
			    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span><span class="o">--</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="p">;</span> <span class="n">len</span><span class="o">++</span><span class="p">)</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_string - Queue string to &quot;struct tomoyo_io_buffer&quot; structure.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:   Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @string: String to print.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that @string has to be kept valid until @head is kfree()d.</span>
<span class="cm"> * This means that char[] allocated on stack memory cannot be passed to</span>
<span class="cm"> * this function. Use tomoyo_io_printf() for char[] allocated on stack memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_set_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_IO_READ_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
		<span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			     <span class="p">...)</span> <span class="n">__printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_io_printf - printf() to &quot;struct tomoyo_io_buffer&quot; structure.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @fmt:  The printf()&#39;s format string, followed by parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_io_printf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			     <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">avail</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_space - Put a space to &quot;struct tomoyo_io_buffer&quot; structure.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_set_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_lf - Put a line feed to &quot;struct tomoyo_io_buffer&quot; structure.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_set_lf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_slash - Put a shash to &quot;struct tomoyo_io_buffer&quot; structure.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_set_slash</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* List of namespaces. */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tomoyo_namespace_list</span><span class="p">);</span>
<span class="cm">/* True if namespace other than tomoyo_kernel_namespace is defined. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tomoyo_namespace_enabled</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_init_policy_namespace - Initialize namespace.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns: Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_init_policy_namespace</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_ACL_GROUPS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">acl_group</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_GROUP</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">policy_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_version</span> <span class="o">=</span> <span class="mi">20110903</span><span class="p">;</span>
	<span class="n">tomoyo_namespace_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_namespace_list</span><span class="p">);</span>
	<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">namespace_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_namespace_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_namespace - Print namespace header.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_namespace</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_namespace_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
			  <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span><span class="p">,</span>
				       <span class="n">namespace_list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_name_union - Print a tomoyo_name_union.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @ptr:  Pointer to &quot;struct tomoyo_name_union&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_name_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_name_union_quoted - Print a tomoyo_name_union with a quote.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @ptr:  Pointer to &quot;struct tomoyo_name_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_name_union_quoted</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">filename</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_number_union_nospace - Print a tomoyo_number_union without a space.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @ptr:  Pointer to &quot;struct tomoyo_number_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_number_union_nospace</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">min_type</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">value_type</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">max_type</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">value_type</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">min_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_VALUE_TYPE_HEXADECIMAL</span>:
				<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
						 <span class="s">&quot;0x%lX&quot;</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TOMOYO_VALUE_TYPE_OCTAL</span>:
				<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
						 <span class="s">&quot;0%lo&quot;</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span>
						 <span class="n">min</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">==</span> <span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="n">min_type</span> <span class="o">==</span> <span class="n">max_type</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&quot;-&quot;</span><span class="p">);</span>
			<span class="n">min_type</span> <span class="o">=</span> <span class="n">max_type</span><span class="p">;</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_number_union - Print a tomoyo_number_union.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @ptr:  Pointer to &quot;struct tomoyo_number_union&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_number_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="n">tomoyo_print_number_union_nospace</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_assign_profile - Create a new profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns:      Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> * @profile: Profile number to create.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_profile&quot; on success, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="nf">tomoyo_assign_profile</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">profile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">profile</span> <span class="o">&gt;=</span> <span class="n">TOMOYO_MAX_PROFILES</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_memory_ok</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">TOMOYO_CONFIG_DISABLED</span> <span class="o">|</span>
			<span class="n">TOMOYO_CONFIG_WANT_GRANT_LOG</span> <span class="o">|</span>
			<span class="n">TOMOYO_CONFIG_WANT_REJECT_LOG</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">));</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pref</span><span class="p">[</span><span class="n">TOMOYO_PREF_MAX_AUDIT_LOG</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">CONFIG_SECURITY_TOMOYO_MAX_AUDIT_LOG</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pref</span><span class="p">[</span><span class="n">TOMOYO_PREF_MAX_LEARNING_ENTRY</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">CONFIG_SECURITY_TOMOYO_MAX_ACCEPT_ENTRY</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span> <span class="cm">/* Avoid out-of-order execution. */</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_profile - Find a profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns:      Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> * @profile: Profile number to find.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_profile&quot;.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="nf">tomoyo_profile</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">u8</span> <span class="n">profile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="n">tomoyo_null_profile</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tomoyo_null_profile</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_find_yesno - Find values for specified keyword.</span>
<span class="cm"> *</span>
<span class="cm"> * @string: String to check.</span>
<span class="cm"> * @find:   Name of keyword.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if &quot;@find=yes&quot; was found, 0 if &quot;@find=no&quot; was found, -1 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s8</span> <span class="nf">tomoyo_find_yesno</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">find</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">find</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">find</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;=yes&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;=no&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_uint - Set value for specified preference.</span>
<span class="cm"> *</span>
<span class="cm"> * @i:      Pointer to &quot;unsigned int&quot;.</span>
<span class="cm"> * @string: String to check.</span>
<span class="cm"> * @find:   Name of keyword.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_set_uint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">find</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">find</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
		<span class="n">sscanf</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">find</span><span class="p">),</span> <span class="s">&quot;=%u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_mode - Set mode for specified profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @name:    Name of functionality.</span>
<span class="cm"> * @value:   Mode for @name.</span>
<span class="cm"> * @profile: Pointer to &quot;struct tomoyo_profile&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_set_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CONFIG&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">default_config</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CONFIG::&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span>
			     <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">c</span> <span class="o">=</span> <span class="n">tomoyo_index2category</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">category</span> <span class="o">=</span>
					<span class="n">tomoyo_category_keywords</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">category</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">tomoyo_mac_keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;use_default&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tomoyo_mode</span><span class="p">[</span><span class="n">mode</span><span class="p">]))</span>
				<span class="cm">/*</span>
<span class="cm">				 * Update lower 3 bits in order to distinguish</span>
<span class="cm">				 * &#39;config&#39; from &#39;TOMOYO_CONFIG_USE_DEAFULT&#39;.</span>
<span class="cm">				 */</span>
				<span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">!=</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tomoyo_find_yesno</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;grant_log&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">config</span> <span class="o">|=</span> <span class="n">TOMOYO_CONFIG_WANT_GRANT_LOG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TOMOYO_CONFIG_WANT_GRANT_LOG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tomoyo_find_yesno</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;reject_log&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">config</span> <span class="o">|=</span> <span class="n">TOMOYO_CONFIG_WANT_REJECT_LOG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TOMOYO_CONFIG_WANT_REJECT_LOG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">)</span>
		<span class="n">profile</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">!=</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
		<span class="n">profile</span><span class="o">-&gt;</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_profile - Write profile table.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;PROFILE_VERSION=%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_version</span><span class="p">)</span>
	    <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">profile</span> <span class="o">=</span> <span class="n">tomoyo_assign_profile</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">profile</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;COMMENT&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">new_comment</span>
			<span class="o">=</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">old_comment</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_comment</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">old_comment</span> <span class="o">=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">comment</span><span class="p">;</span>
		<span class="n">profile</span><span class="o">-&gt;</span><span class="n">comment</span> <span class="o">=</span> <span class="n">new_comment</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tomoyo_put_name</span><span class="p">(</span><span class="n">old_comment</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;PREFERENCE&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PREF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tomoyo_set_uint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">pref</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cp</span><span class="p">,</span>
					<span class="n">tomoyo_pref_keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tomoyo_set_mode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">profile</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_config - Print mode for specified functionality.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:   Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @config: Mode for that functionality.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller prints functionality&#39;s name.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_print_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;={ mode=%s grant_log=%s reject_log=%s }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tomoyo_mode</span><span class="p">[</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">],</span>
			 <span class="n">tomoyo_yesno</span><span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TOMOYO_CONFIG_WANT_GRANT_LOG</span><span class="p">),</span>
			 <span class="n">tomoyo_yesno</span><span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TOMOYO_CONFIG_WANT_REJECT_LOG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_profile - Read profile table.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ns</span><span class="p">),</span> <span class="n">namespace_list</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
 <span class="nl">next:</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">profile</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;PROFILE_VERSION=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_version</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PROFILES</span><span class="p">;</span>
		      <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">TOMOYO_MAX_PROFILES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="p">{</span>
			<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">comment</span> <span class="o">=</span>
				<span class="n">profile</span><span class="o">-&gt;</span><span class="n">comment</span><span class="p">;</span>
			<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u-COMMENT=&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">comment</span> <span class="o">?</span> <span class="n">comment</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u-PREFERENCE={ &quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PREF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%s=%u &quot;</span><span class="p">,</span>
						 <span class="n">tomoyo_pref_keywords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">profile</span><span class="o">-&gt;</span><span class="n">pref</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="p">{</span>
			<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u-%s&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="s">&quot;CONFIG&quot;</span><span class="p">);</span>
			<span class="n">tomoyo_print_config</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">default_config</span><span class="p">);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span>
			      <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span><span class="p">;</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">config</span> <span class="o">=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">==</span> <span class="n">TOMOYO_CONFIG_USE_DEFAULT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span><span class="p">)</span>
				<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u-CONFIG::%s::%s&quot;</span><span class="p">,</span>
						 <span class="n">index</span><span class="p">,</span>
						 <span class="n">tomoyo_category_keywords</span>
						 <span class="p">[</span><span class="n">tomoyo_index2category</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
						 <span class="n">tomoyo_mac_keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u-CONFIG::%s&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
						 <span class="n">tomoyo_mac_keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">tomoyo_print_config</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">bit</span> <span class="o">==</span> <span class="n">TOMOYO_MAX_MAC_INDEX</span>
		    <span class="o">+</span> <span class="n">TOMOYO_MAX_MAC_CATEGORY_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_same_manager - Check for duplicated &quot;struct tomoyo_manager&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a: Pointer to &quot;struct tomoyo_acl_head&quot;.</span>
<span class="cm"> * @b: Pointer to &quot;struct tomoyo_acl_head&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a == @b, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_same_manager</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_head</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_head</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_manager</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">==</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_manager</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_update_manager_entry - Add a manager entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @manager:   The path to manager or the domainnamme.</span>
<span class="cm"> * @is_delete: True if it is a delete request.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_update_manager_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">manager</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_manager</span> <span class="n">e</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* .ns = &amp;tomoyo_kernel_namespace, */</span>
		<span class="p">.</span><span class="n">is_delete</span> <span class="o">=</span> <span class="n">is_delete</span><span class="p">,</span>
		<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_namespace</span><span class="p">.</span>
		<span class="n">policy_list</span><span class="p">[</span><span class="n">TOMOYO_ID_MANAGER</span><span class="p">],</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">is_delete</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_correct_domain</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tomoyo_correct_word</span><span class="p">(</span><span class="n">manager</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">e</span><span class="p">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">tomoyo_get_name</span><span class="p">(</span><span class="n">manager</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">manager</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_update_policy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span>
					     <span class="n">tomoyo_same_manager</span><span class="p">);</span>
		<span class="n">tomoyo_put_name</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">manager</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_manager - Write manager policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;manage_by_non_root&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tomoyo_manage_by_non_root</span> <span class="o">=</span> <span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tomoyo_update_manager_entry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_manager - Read manager policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_namespace</span><span class="p">.</span>
			     <span class="n">policy_list</span><span class="p">[</span><span class="n">TOMOYO_ID_MANAGER</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_manager</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">is_deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_manager - Check whether the current process is a policy manager.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the current process is permitted to modify policy</span>
<span class="cm"> * via /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_manager</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_manager</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">exe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="o">*</span><span class="n">domainname</span> <span class="o">=</span> <span class="n">tomoyo_domain</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_policy_loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_manage_by_non_root</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">||</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">exe</span> <span class="o">=</span> <span class="n">tomoyo_get_exe</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exe</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_namespace</span><span class="p">.</span>
				<span class="n">policy_list</span><span class="p">[</span><span class="n">TOMOYO_ID_MANAGER</span><span class="p">],</span> <span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">is_deleted</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_pathcmp</span><span class="p">(</span><span class="n">domainname</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Reduce error messages. */</span>
		<span class="k">static</span> <span class="n">pid_t</span> <span class="n">last_pid</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_pid</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s ( %s ) is not permitted to &quot;</span>
			       <span class="s">&quot;update policies.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">exe</span><span class="p">);</span>
			<span class="n">last_pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exe</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">tomoyo_find_domain_by_qid</span>
<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_select_domain - Parse select command.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @data: String to parse.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_select_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">global_pid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;select &quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;pid=%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">global_pid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;global-pid=%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">global_pid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_pid_ns</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_pid_ns</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_vpid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
			<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_real_domain</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;domain=&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_domain_def</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_find_domain</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;Q=%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_find_domain_by_qid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="cm">/* Accessing read_buf is safe because head-&gt;io_sem is held. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* Do nothing if open(O_WRONLY). */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">));</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_this_domain_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">domain</span><span class="p">)</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;# select %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">domain</span> <span class="o">&amp;&amp;</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">is_deleted</span><span class="p">)</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;# This is a deleted domain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_same_task_acl - Check for duplicated &quot;struct tomoyo_task_acl&quot; entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @a: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> * @b: Pointer to &quot;struct tomoyo_acl_info&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if @a == @b, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_same_task_acl</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_task_acl</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_task_acl</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">domainname</span> <span class="o">==</span> <span class="n">p2</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_task - Update task related list.</span>
<span class="cm"> *</span>
<span class="cm"> * @param: Pointer to &quot;struct tomoyo_acl_param&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;manual_domain_transition &quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_task_acl</span> <span class="n">e</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_TYPE_MANUAL_TASK_ACL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">domainname</span> <span class="o">=</span> <span class="n">tomoyo_get_domainname</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">domainname</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">tomoyo_update_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">param</span><span class="p">,</span>
						     <span class="n">tomoyo_same_task_acl</span><span class="p">,</span>
						     <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">tomoyo_put_name</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">domainname</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_delete_domain - Delete a domain.</span>
<span class="cm"> *</span>
<span class="cm"> * @domainname: The name of domain.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_delete_domain</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">domainname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_path_info</span> <span class="n">name</span><span class="p">;</span>

	<span class="n">name</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">domainname</span><span class="p">;</span>
	<span class="n">tomoyo_fill_path_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="cm">/* Is there an active domain? */</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_domain_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Never delete tomoyo_kernel_domain */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">domain</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_domain</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">is_deleted</span> <span class="o">||</span>
		    <span class="n">tomoyo_pathcmp</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">domain</span><span class="o">-&gt;</span><span class="n">is_deleted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_policy_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_domain2 - Write domain policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @ns:        Pointer to &quot;struct tomoyo_policy_namespace&quot;.</span>
<span class="cm"> * @list:      Pointer to &quot;struct list_head&quot;.</span>
<span class="cm"> * @data:      Policy to be interpreted.</span>
<span class="cm"> * @is_delete: True if it is a delete request.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_domain2</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="p">,</span>
		<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_delete</span> <span class="o">=</span> <span class="n">is_delete</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyword</span><span class="p">;</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">tomoyo_callback</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="s">&quot;file &quot;</span><span class="p">,</span> <span class="n">tomoyo_write_file</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;network inet &quot;</span><span class="p">,</span> <span class="n">tomoyo_write_inet_network</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;network unix &quot;</span><span class="p">,</span> <span class="n">tomoyo_write_unix_network</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;misc &quot;</span><span class="p">,</span> <span class="n">tomoyo_write_misc</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;task &quot;</span><span class="p">,</span> <span class="n">tomoyo_write_task</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tomoyo_callback</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">tomoyo_callback</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keyword</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">tomoyo_callback</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* String table for domain flags. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_dif</span><span class="p">[</span><span class="n">TOMOYO_MAX_DOMAIN_INFO_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_DIF_QUOTA_WARNED</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;quota_exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_DIF_TRANSITION_FAILED</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;transition_failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_domain - Write domain policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_select</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;select &quot;</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">profile</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_delete</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tomoyo_delete_domain</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_select</span><span class="p">)</span>
			<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_find_domain</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_assign_domain</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;use_profile %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
	    <span class="o">&amp;&amp;</span> <span class="n">profile</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PROFILES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_policy_loaded</span> <span class="o">||</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">])</span>
			<span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">profile</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;use_group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
	    <span class="o">&amp;&amp;</span> <span class="n">profile</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_ACL_GROUPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_delete</span><span class="p">)</span>
			<span class="n">domain</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">profile</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">profile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">profile</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_DOMAIN_INFO_FLAGS</span><span class="p">;</span> <span class="n">profile</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">tomoyo_dif</span><span class="p">[</span><span class="n">profile</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">domain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">profile</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_delete</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tomoyo_write_domain2</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">acl_info_list</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				    <span class="n">is_delete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_condition - Print condition part.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @cond: Pointer to &quot;struct tomoyo_condition&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_print_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_step</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">transit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">transit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="p">{</span>
			<span class="k">const</span> <span class="n">u16</span> <span class="n">condc</span> <span class="o">=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">condc</span><span class="p">;</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_condition_element</span> <span class="o">*</span><span class="n">condp</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">condp</span><span class="p">))</span> <span class="p">(</span><span class="n">cond</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_number_union</span> <span class="o">*</span><span class="n">numbers_p</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">numbers_p</span><span class="p">))</span> <span class="p">(</span><span class="n">condp</span> <span class="o">+</span> <span class="n">condc</span><span class="p">);</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_name_union</span> <span class="o">*</span><span class="n">names_p</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">names_p</span><span class="p">))</span>
				<span class="p">(</span><span class="n">numbers_p</span> <span class="o">+</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">numbers_count</span><span class="p">);</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_argv</span> <span class="o">*</span><span class="n">argv</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">argv</span><span class="p">))</span> <span class="p">(</span><span class="n">names_p</span> <span class="o">+</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">names_count</span><span class="p">);</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_envp</span> <span class="o">*</span><span class="n">envp</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">envp</span><span class="p">))</span> <span class="p">(</span><span class="n">argv</span> <span class="o">+</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">);</span>
			<span class="n">u16</span> <span class="n">skip</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">skip</span> <span class="o">&lt;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_index</span><span class="p">;</span> <span class="n">skip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">left</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">right</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
				<span class="n">condp</span><span class="o">++</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TOMOYO_ARGV_ENTRY</span>:
					<span class="n">argv</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_ENVP_ENTRY</span>:
					<span class="n">envp</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_NUMBER_UNION</span>:
					<span class="n">numbers_p</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TOMOYO_NAME_UNION</span>:
					<span class="n">names_p</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_NUMBER_UNION</span>:
					<span class="n">numbers_p</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_index</span> <span class="o">&lt;</span> <span class="n">condc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">match</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">equals</span><span class="p">;</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">left</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">right</span> <span class="o">=</span> <span class="n">condp</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">condp</span><span class="o">++</span><span class="p">;</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_index</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TOMOYO_ARGV_ENTRY</span>:
					<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
							 <span class="s">&quot;exec.argv[%lu]%s=</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">argv</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">argv</span><span class="o">-&gt;</span>
							 <span class="n">is_not</span> <span class="o">?</span> <span class="s">&quot;!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
							  <span class="n">argv</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">argv</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_ENVP_ENTRY</span>:
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
							  <span class="s">&quot;exec.envp[</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
							  <span class="n">envp</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">]%s=&quot;</span><span class="p">,</span> <span class="n">envp</span><span class="o">-&gt;</span>
							 <span class="n">is_not</span> <span class="o">?</span> <span class="s">&quot;!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">envp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">envp</span><span class="o">-&gt;</span>
								  <span class="n">value</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
						<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
								  <span class="s">&quot;NULL&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">envp</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_NUMBER_UNION</span>:
					<span class="n">tomoyo_print_number_union_nospace</span>
						<span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">numbers_p</span><span class="o">++</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
					       <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">left</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">match</span> <span class="o">?</span> <span class="s">&quot;=&quot;</span> <span class="o">:</span> <span class="s">&quot;!=&quot;</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TOMOYO_NAME_UNION</span>:
					<span class="n">tomoyo_print_name_union_quoted</span>
						<span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">names_p</span><span class="o">++</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TOMOYO_NUMBER_UNION</span>:
					<span class="n">tomoyo_print_number_union_nospace</span>
						<span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">numbers_p</span><span class="o">++</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
					  <span class="n">tomoyo_condition_keyword</span><span class="p">[</span><span class="n">right</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_step</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_step</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">!=</span> <span class="n">TOMOYO_GRANTLOG_AUTO</span><span class="p">)</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; grant_log=%s&quot;</span><span class="p">,</span>
					 <span class="n">tomoyo_yesno</span><span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">grant_log</span> <span class="o">==</span>
						      <span class="n">TOMOYO_GRANTLOG_YES</span><span class="p">));</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_group - Print &quot;acl_group &quot; header keyword and category name.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:     Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @category: Category name.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_set_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">category</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;acl_group %u &quot;</span><span class="p">,</span>
				 <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl_group_index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">category</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_print_entry - Print an ACL entry.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @acl:  Pointer to an ACL entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_print_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">acl_type</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_cond_part</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">print_cond_part</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">is_deleted</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_PATH_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_path_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PATH_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_transition_related_only</span> <span class="o">&amp;&amp;</span>
			    <span class="n">bit</span> <span class="o">!=</span> <span class="n">TOMOYO_TYPE_EXECUTE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;file &quot;</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_path_keyword</span><span class="p">[</span><span class="n">bit</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_MANUAL_TASK_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_task_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;task &quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;manual_domain_transition &quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_transition_related_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_PATH2_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_path2_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PATH2_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;file &quot;</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_mac_keywords</span>
					  <span class="p">[</span><span class="n">tomoyo_pp2mac</span><span class="p">[</span><span class="n">bit</span><span class="p">]]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name1</span><span class="p">);</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_PATH_NUMBER_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_path_number_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_PATH_NUMBER_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;file &quot;</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_mac_keywords</span>
					  <span class="p">[</span><span class="n">tomoyo_pn2mac</span><span class="p">[</span><span class="n">bit</span><span class="p">]]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_MKDEV_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_mkdev_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MKDEV_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;file &quot;</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_mac_keywords</span>
					  <span class="p">[</span><span class="n">tomoyo_pnnn2mac</span><span class="p">[</span><span class="n">bit</span><span class="p">]]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_INET_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_inet_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;network inet &quot;</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_proto_keyword</span>
						  <span class="p">[</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">]);</span>
				<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">bit</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group_name</span>
					  <span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
			<span class="n">tomoyo_print_ip</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_UNIX_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_unix_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_NETWORK_OPERATION</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;network unix &quot;</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_proto_keyword</span>
						  <span class="p">[</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">]);</span>
				<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tomoyo_set_slash</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_socket_keyword</span><span class="p">[</span><span class="n">bit</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_MOUNT_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_mount_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
		<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;file mount&quot;</span><span class="p">);</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dir_name</span><span class="p">);</span>
		<span class="n">tomoyo_print_name_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">fs_type</span><span class="p">);</span>
		<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">TOMOYO_TYPE_ENV_ACL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_env_acl</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>

		<span class="n">tomoyo_set_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;misc env &quot;</span><span class="p">);</span>
		<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_cond_part</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">cond_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">print_cond_part:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_print_condition</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_cond_part</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_domain2 - Read domain policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @list: Pointer to &quot;struct list_head&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_read_domain2</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_acl_info</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_print_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_domain - Read domain policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_domain_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">domain</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">is_deleted</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_this_domain_only</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Print domainname and flags. */</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;use_profile %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;use_group %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">domain</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_DOMAIN_INFO_FLAGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_dif</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_read_domain2</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">acl_info_list</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_this_domain_only</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_pid: Specify PID to obtain domainname.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_pid - Get domainname of the specified PID.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the domainname which the specified PID is in on success,</span>
<span class="cm"> * empty string otherwise.</span>
<span class="cm"> * The PID is specified by tomoyo_write_pid() so that the user can obtain</span>
<span class="cm"> * using read()/write() interface rather than sysctl() interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">global_pid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Accessing write_buf is safe because head-&gt;io_sem is held. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Do nothing if open(O_RDONLY). */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span> <span class="o">||</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;global-pid &quot;</span><span class="p">))</span>
		<span class="n">global_pid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global_pid</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_pid_ns</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_pid_ns</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_vpid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="n">tomoyo_real_domain</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">domain</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;%u %u &quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
	<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* String table for domain transition control keywords. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tomoyo_transition_type</span><span class="p">[</span><span class="n">TOMOYO_MAX_TRANSITION_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_NO_RESET</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;no_reset_domain &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_RESET</span><span class="p">]</span>         <span class="o">=</span> <span class="s">&quot;reset_domain &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_NO_INITIALIZE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;no_initialize_domain &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_INITIALIZE</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;initialize_domain &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_NO_KEEP</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;no_keep_domain &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_TRANSITION_CONTROL_KEEP</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;keep_domain &quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for grouping keywords. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tomoyo_group_name</span><span class="p">[</span><span class="n">TOMOYO_MAX_GROUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_PATH_GROUP</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;path_group &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_NUMBER_GROUP</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;number_group &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_ADDRESS_GROUP</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;address_group &quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_exception - Write exception policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">is_delete</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_acl_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_delete</span> <span class="o">=</span> <span class="n">is_delete</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;aggregator &quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tomoyo_write_aggregator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_TRANSITION_TYPE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">tomoyo_transition_type</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">tomoyo_write_transition_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_GROUP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">tomoyo_group_name</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">tomoyo_write_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;acl_group &quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">group</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_ACL_GROUPS</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tomoyo_write_domain2</span>
				<span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">acl_group</span><span class="p">[</span><span class="n">group</span><span class="p">],</span>
				 <span class="n">data</span><span class="p">,</span> <span class="n">is_delete</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_group - Read &quot;struct tomoyo_path_group&quot;/&quot;struct tomoyo_number_group&quot;/&quot;struct tomoyo_address_group&quot; list.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @idx:  Index number.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_read_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ns</span><span class="p">),</span> <span class="n">namespace_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">group</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_group</span> <span class="o">*</span><span class="n">group</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">group</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">group</span><span class="p">),</span> <span class="n">head</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">member_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tomoyo_acl_head</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
				<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">is_deleted</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_group_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">group</span><span class="o">-&gt;</span><span class="n">group_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">TOMOYO_PATH_GROUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">container_of</span>
					       <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tomoyo_path_group</span><span class="p">,</span>
						<span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">member_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">TOMOYO_NUMBER_GROUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tomoyo_print_number_union</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container_of</span>
							  <span class="p">(</span><span class="n">ptr</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">tomoyo_number_group</span><span class="p">,</span>
							   <span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">TOMOYO_ADDRESS_GROUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

				<span class="k">struct</span> <span class="n">tomoyo_address_group</span> <span class="o">*</span><span class="n">member</span> <span class="o">=</span>
					<span class="n">container_of</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">member</span><span class="p">),</span>
						     <span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_print_ip</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
				<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">group</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_policy - Read &quot;struct tomoyo_..._entry&quot; list.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @idx:  Index number.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true on success, false otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tomoyo_read_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ns</span><span class="p">),</span> <span class="n">namespace_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">policy_list</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">list_for_each_cookie</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_acl_head</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">is_deleted</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TOMOYO_ID_TRANSITION_CONTROL</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">tomoyo_transition_control</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
					<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tomoyo_transition_type</span>
						  <span class="p">[</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">program</span> <span class="o">?</span>
						  <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;any&quot;</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; from &quot;</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">domainname</span> <span class="o">?</span>
						  <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span>
						  <span class="s">&quot;any&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_ID_AGGREGATOR</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">tomoyo_aggregator</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span>
					<span class="n">container_of</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_print_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;aggregator &quot;</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
						  <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">original_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">tomoyo_set_space</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
				<span class="n">tomoyo_set_string</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
					       <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">aggregated_name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_exception - Read exception policy.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ns</span><span class="p">),</span> <span class="n">namespace_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span> <span class="o">&amp;&amp;</span>
	       <span class="n">tomoyo_read_policy</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="p">))</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_GROUP</span> <span class="o">&amp;&amp;</span>
	       <span class="n">tomoyo_read_group</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">-</span> <span class="n">TOMOYO_MAX_POLICY</span><span class="p">))</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_GROUP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY</span> <span class="o">+</span> <span class="n">TOMOYO_MAX_GROUP</span>
	       <span class="o">+</span> <span class="n">TOMOYO_MAX_ACL_GROUPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl_group_index</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span> <span class="o">-</span> <span class="n">TOMOYO_MAX_POLICY</span>
			<span class="o">-</span> <span class="n">TOMOYO_MAX_GROUP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_read_domain2</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">acl_group</span>
					 <span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">acl_group_index</span><span class="p">]))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait queue for kernel -&gt; userspace notification. */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">tomoyo_query_wait</span><span class="p">);</span>
<span class="cm">/* Wait queue for userspace -&gt; kernel notification. */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">tomoyo_answer_wait</span><span class="p">);</span>

<span class="cm">/* Structure for query. */</span>
<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">query_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">answer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The list for &quot;struct tomoyo_query&quot;. */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tomoyo_query_list</span><span class="p">);</span>

<span class="cm">/* Lock for manipulating tomoyo_query_list. */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Number of &quot;struct file&quot; referring /sys/kernel/security/tomoyo/query</span>
<span class="cm"> * interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">tomoyo_query_observers</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_truncate - Truncate a line.</span>
<span class="cm"> *</span>
<span class="cm"> * @str: String to truncate.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns length of truncated @str.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_truncate</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">str</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">str</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_add_entry - Add an ACL to current thread&#39;s domain. Used by learning mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @domain: Pointer to &quot;struct tomoyo_domain_info&quot;.</span>
<span class="cm"> * @header: Lines containing ACL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_add_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">realpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">argv0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">symlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* strstr() will return NULL if ordering is wrong. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">argv0</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s">&quot; argv[]={ </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argv0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argv0</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">tomoyo_truncate</span><span class="p">(</span><span class="n">argv0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">realpath</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s">&quot; exec={ realpath=</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">realpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">realpath</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">tomoyo_truncate</span><span class="p">(</span><span class="n">realpath</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">symlink</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s">&quot; symlink.target=</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">tomoyo_truncate</span><span class="p">(</span><span class="n">symlink</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realpath</span><span class="p">)</span>
		<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; exec.%s&quot;</span><span class="p">,</span> <span class="n">realpath</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argv0</span><span class="p">)</span>
		<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; exec.argv[0]=%s&quot;</span><span class="p">,</span> <span class="n">argv0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
		<span class="n">tomoyo_addprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">symlink</span><span class="p">);</span>
	<span class="n">tomoyo_normalize_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_write_domain2</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">acl_info_list</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
				  <span class="nb">false</span><span class="p">))</span>
		<span class="n">tomoyo_update_stat</span><span class="p">(</span><span class="n">TOMOYO_STAT_POLICY_UPDATES</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_supervisor - Ask for the supervisor&#39;s decision.</span>
<span class="cm"> *</span>
<span class="cm"> * @r:   Pointer to &quot;struct tomoyo_request_info&quot;.</span>
<span class="cm"> * @fmt: The printf()&#39;s format string, followed by parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the supervisor decided to permit the access request which</span>
<span class="cm"> * violated the policy in enforcing mode, TOMOYO_RETRY_REQUEST if the</span>
<span class="cm"> * supervisor decided to retry the access request which violated the policy in</span>
<span class="cm"> * enforcing mode, 0 if it is not in enforcing mode, -EPERM otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_supervisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_request_info</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tomoyo_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">quota_exceeded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="cm">/* Write /sys/kernel/security/tomoyo/audit. */</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">tomoyo_write_log2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="cm">/* Nothing more to do if granted. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">tomoyo_update_stat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TOMOYO_CONFIG_ENFORCING</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_observers</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_CONFIG_LEARNING</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Check max_learning_entry parameter. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_domain_quota_is_ok</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get message. */</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">tomoyo_init_log</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">query_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">query</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_add_entry</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">query</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">tomoyo_round2</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">query_len</span><span class="p">);</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">]</span> <span class="o">+</span> <span class="n">len</span>
	    <span class="o">&gt;=</span> <span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">quota_exceeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">tomoyo_serial</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
		<span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">]</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quota_exceeded</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Give 10 seconds for supervisor&#39;s opinion. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible_timeout</span>
		    <span class="p">(</span><span class="n">tomoyo_answer_wait</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">answer</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_observers</span><span class="p">),</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">entry</span><span class="p">.</span><span class="n">timer</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">]</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">answer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* Asked to retry by administrator. */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">TOMOYO_RETRY_REQUEST</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">retry</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Granted by administrator. */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Timed out or rejected by administrator. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">query</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_find_domain_by_qid - Get domain by query id.</span>
<span class="cm"> *</span>
<span class="cm"> * @serial: Query ID assigned by tomoyo_supervisor().</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to &quot;struct tomoyo_domain_info&quot; if found, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="nf">tomoyo_find_domain_by_qid</span>
<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">serial</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">domain</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_poll_query - poll() for /sys/kernel/security/tomoyo/query.</span>
<span class="cm"> *</span>
<span class="cm"> * @file: Pointer to &quot;struct file&quot;.</span>
<span class="cm"> * @wait: Pointer to &quot;poll_table&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns POLLIN | POLLRDNORM when ready to read, 0 otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Waits for access requests which violated policy in enforcing mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tomoyo_poll_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_query - Read access requests which violated policy in enforcing mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">++</span> <span class="o">!=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">query_index</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">query_len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">query_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">++</span> <span class="o">!=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">query_index</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some query can be skipped because tomoyo_query_list</span>
<span class="cm">		 * can change, but I don&#39;t care.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">query_len</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">31</span><span class="p">,</span> <span class="s">&quot;Q%u-%hu</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
				 <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">w_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">query_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_answer - Write the supervisor&#39;s decision.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EINVAL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_answer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">answer</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;A%u=%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">answer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_query_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_query</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">serial</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span><span class="p">;</span>
		<span class="cm">/* Remove from tomoyo_query_list. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">answer</span><span class="p">)</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_version: Get version.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns version information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;2.5.0&quot;</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* String table for /sys/kernel/security/tomoyo/stat interface. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_policy_headers</span><span class="p">[</span><span class="n">TOMOYO_MAX_POLICY_STAT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_STAT_POLICY_UPDATES</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;update:&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_STAT_POLICY_LEARNING</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;violation in learning mode:&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_STAT_POLICY_PERMISSIVE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;violation in permissive mode:&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_STAT_POLICY_ENFORCING</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;violation in enforcing mode:&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* String table for /sys/kernel/security/tomoyo/stat interface. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tomoyo_memory_headers</span><span class="p">[</span><span class="n">TOMOYO_MAX_MEMORY_STAT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TOMOYO_MEMORY_POLICY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;policy:&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MEMORY_AUDIT</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;audit log:&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TOMOYO_MEMORY_QUERY</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;query message:&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Timestamp counter for last updated. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tomoyo_stat_updated</span><span class="p">[</span><span class="n">TOMOYO_MAX_POLICY_STAT</span><span class="p">];</span>
<span class="cm">/* Counter for number of updates. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tomoyo_stat_modified</span><span class="p">[</span><span class="n">TOMOYO_MAX_POLICY_STAT</span><span class="p">];</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_update_stat - Update statistic counters.</span>
<span class="cm"> *</span>
<span class="cm"> * @index: Index for policy type.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_update_stat</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * I don&#39;t use atomic operations because race condition is not fatal.</span>
<span class="cm">	 */</span>
	<span class="n">tomoyo_stat_updated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tomoyo_stat_modified</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_stat - Read statistic data.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomoyo_read_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_POLICY_STAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;Policy %-30s %10u&quot;</span><span class="p">,</span>
				 <span class="n">tomoyo_policy_headers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="n">tomoyo_stat_updated</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_stat_modified</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tomoyo_time</span> <span class="n">stamp</span><span class="p">;</span>
			<span class="n">tomoyo_convert_time</span><span class="p">(</span><span class="n">tomoyo_stat_modified</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">stamp</span><span class="p">);</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; (Last: %04u/%02u/%02u &quot;</span>
					 <span class="s">&quot;%02u:%02u:%02u)&quot;</span><span class="p">,</span>
					 <span class="n">stamp</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">day</span><span class="p">,</span>
					 <span class="n">stamp</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">stamp</span><span class="p">.</span><span class="n">sec</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MEMORY_STAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="n">tomoyo_memory_used</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
		<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;Memory used by %-22s %10u&quot;</span><span class="p">,</span>
				 <span class="n">tomoyo_memory_headers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">used</span><span class="p">);</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">used</span><span class="p">)</span>
			<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot; (Quota: %10u)&quot;</span><span class="p">,</span> <span class="n">used</span><span class="p">);</span>
		<span class="n">tomoyo_set_lf</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tomoyo_io_printf</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&quot;Total memory used:                    %10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">total</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_stat - Set memory quota.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_write_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;Memory used by &quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOMOYO_MAX_MEMORY_STAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_str_starts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">tomoyo_memory_headers</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_memory_quota</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_open_control - open() for /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @type: Type of interface.</span>
<span class="cm"> * @file: Pointer to &quot;struct file&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_open_control</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">io_sem</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TOMOYO_DOMAINPOLICY</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/domain_policy */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_domain</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_domain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/exception_policy */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_exception</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_exception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_AUDIT</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/audit */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">tomoyo_poll_log</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_log</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_PROCESS_STATUS</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/.process_status */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_pid</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_pid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_VERSION</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/version */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_version</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_STAT</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/stat */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_stat</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_stat</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_PROFILE</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/profile */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_profile</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_profile</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_QUERY</span>: <span class="cm">/* /sys/kernel/security/tomoyo/query */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">tomoyo_poll_query</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_answer</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_query</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TOMOYO_MANAGER</span>:
		<span class="cm">/* /sys/kernel/security/tomoyo/manager */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_manager</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tomoyo_read_manager</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No need to allocate read_buf since it is not opened</span>
<span class="cm">		 * for reading.</span>
<span class="cm">		 */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t allocate read_buf for poll() access. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span><span class="p">)</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">readbuf_size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No need to allocate write_buf since it is not opened</span>
<span class="cm">		 * for writing.</span>
<span class="cm">		 */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">writebuf_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">writebuf_size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the file is /sys/kernel/security/tomoyo/query , increment the</span>
<span class="cm">	 * observer counter.</span>
<span class="cm">	 * The obserber counter is used by tomoyo_supervisor() to see if</span>
<span class="cm">	 * there is some process monitoring /sys/kernel/security/tomoyo/query.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_QUERY</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_observers</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">tomoyo_notify_gc</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_poll_control - poll() for /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @file: Pointer to &quot;struct file&quot;.</span>
<span class="cm"> * @wait: Pointer to &quot;poll_table&quot;. Maybe NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns POLLIN | POLLRDNORM | POLLOUT | POLLWRNORM if ready to read/write,</span>
<span class="cm"> * POLLOUT | POLLWRNORM otherwise.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tomoyo_poll_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span> <span class="o">|</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span> <span class="o">|</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_set_namespace_cursor - Set namespace to read.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tomoyo_set_namespace_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TOMOYO_PROFILE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this is the first read, or reading previous namespace finished</span>
<span class="cm">	 * and has more namespaces to read, update the namespace cursor.</span>
<span class="cm">	 */</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span> <span class="o">||</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tomoyo_namespace_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clearing is OK because tomoyo_flush() returned true. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">));</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">?</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="n">tomoyo_namespace_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_has_more_namespace - Check for unread namespaces.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if we have more entries to print, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tomoyo_has_more_namespace</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span> <span class="o">||</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_PROFILE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">eof</span> <span class="o">&amp;&amp;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tomoyo_namespace_list</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_read_control - read() for /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:       Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @buffer:     Poiner to buffer to write to.</span>
<span class="cm"> * @buffer_len: Size of @buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns bytes read on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">tomoyo_read_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">io_sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span> <span class="o">=</span> <span class="n">buffer_len</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="cm">/* Call the policy handler. */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">tomoyo_set_namespace_cursor</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tomoyo_flush</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">tomoyo_has_more_namespace</span><span class="p">(</span><span class="n">head</span><span class="p">));</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">io_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_parse_policy - Parse a policy line.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Poiter to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @line: Line to parse.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds tomoyo_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tomoyo_parse_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Delete request? */</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span> <span class="o">=</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;delete &quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">is_delete</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Selecting namespace to update. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span> <span class="o">||</span>
	    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_PROFILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">tomoyo_assign_namespace</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
				<span class="n">memmove</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_namespace</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t allow updating if namespace is invalid. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Do the update. */</span>
	<span class="k">return</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_write_control - write() for /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @head:       Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> * @buffer:     Pointer to buffer to read from.</span>
<span class="cm"> * @buffer_len: Size of @buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns @buffer_len on success, negative value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span> <span class="nf">tomoyo_write_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">buffer_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">avail_len</span> <span class="o">=</span> <span class="n">buffer_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp0</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">io_sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">read_user_buf_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="cm">/* Read a line and dispatch it to the policy handler. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">avail_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">avail</span> <span class="o">&gt;=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">writebuf_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">writebuf_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cp0</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">avail</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cp0</span><span class="p">);</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">cp0</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">writebuf_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">avail_len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">cp0</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">avail</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">cp0</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">avail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tomoyo_normalize_line</span><span class="p">(</span><span class="n">cp0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cp0</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tomoyo_kernel_namespace</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Don&#39;t allow updating policies by non manager programs. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TOMOYO_PROCESS_STATUS</span>:
			<span class="cm">/* This does not write anything. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOMOYO_DOMAINPOLICY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tomoyo_select_domain</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">cp0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cp0</span><span class="p">,</span> <span class="s">&quot;select transition_only&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">print_transition_related_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall through */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tomoyo_manager</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tomoyo_parse_policy</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">cp0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPERM</span>:
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TOMOYO_DOMAINPOLICY</span>:
			<span class="k">case</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span>:
			<span class="k">case</span> <span class="n">TOMOYO_STAT</span>:
			<span class="k">case</span> <span class="n">TOMOYO_PROFILE</span>:
			<span class="k">case</span> <span class="n">TOMOYO_MANAGER</span>:
				<span class="n">tomoyo_update_stat</span><span class="p">(</span><span class="n">TOMOYO_STAT_POLICY_UPDATES</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">io_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_close_control - close() for /sys/kernel/security/tomoyo/ interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @head: Pointer to &quot;struct tomoyo_io_buffer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tomoyo_close_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the file is /sys/kernel/security/tomoyo/query , decrement the</span>
<span class="cm">	 * observer counter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TOMOYO_QUERY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_query_observers</span><span class="p">))</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tomoyo_answer_wait</span><span class="p">);</span>
	<span class="n">tomoyo_notify_gc</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_check_profile - Check all profiles currently assigned to domains are defined.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tomoyo_check_profile</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tomoyo_domain_info</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="n">tomoyo_policy_loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;TOMOYO: 2.5.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tomoyo_domain_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">tomoyo_policy_namespace</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_version</span> <span class="o">!=</span> <span class="mi">20110903</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Profile version %u is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_version</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">profile_ptr</span><span class="p">[</span><span class="n">profile</span><span class="p">])</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Profile %u (used by &#39;%s&#39;) is not defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">profile</span><span class="p">,</span> <span class="n">domain</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;Userland tools for TOMOYO 2.5 must be installed and &quot;</span>
		       <span class="s">&quot;policy must be initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Please see http://tomoyo.sourceforge.jp/2.5/ &quot;</span>
		       <span class="s">&quot;for more information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;STOP!&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Mandatory Access Control activated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tomoyo_load_builtin_policy - Load built-in policy.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">tomoyo_load_builtin_policy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This include file is manually created and contains built-in policy</span>
<span class="cm">	 * named &quot;tomoyo_builtin_profile&quot;, &quot;tomoyo_builtin_exception_policy&quot;,</span>
<span class="cm">	 * &quot;tomoyo_builtin_domain_policy&quot;, &quot;tomoyo_builtin_manager&quot;,</span>
<span class="cm">	 * &quot;tomoyo_builtin_stat&quot; in the form of &quot;static char [] __initdata&quot;.</span>
<span class="cm">	 */</span>
<span class="cp">#include &quot;builtin-policy.h&quot;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tomoyo_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tomoyo_io_buffer</span> <span class="n">head</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">start</span> <span class="o">=</span> <span class="n">tomoyo_builtin_profile</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_PROFILE</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_profile</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">start</span> <span class="o">=</span> <span class="n">tomoyo_builtin_exception_policy</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_EXCEPTIONPOLICY</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_exception</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">start</span> <span class="o">=</span> <span class="n">tomoyo_builtin_domain_policy</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_DOMAINPOLICY</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_domain</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">start</span> <span class="o">=</span> <span class="n">tomoyo_builtin_manager</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_MANAGER</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_manager</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">start</span> <span class="o">=</span> <span class="n">tomoyo_builtin_stat</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TOMOYO_STAT</span><span class="p">;</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tomoyo_write_stat</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">tomoyo_normalize_line</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
			<span class="n">head</span><span class="p">.</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">tomoyo_parse_policy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tomoyo_read_unlock</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SECURITY_TOMOYO_OMIT_USERSPACE_LOADER</span>
	<span class="n">tomoyo_check_profile</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
